name: Documentation Validation

on:
  push:
    branches:
      - main
      - "feature/**"
    paths:
      - "docs/**"
      - "services/api-gateway/app/**"
      - "packages/ui/src/components/**"
      - "apps/docs-site/**"
      - ".github/workflows/docs-validation.yml"
  pull_request:
    branches:
      - main
    paths:
      - "docs/**"
      - "services/api-gateway/app/**"
      - "packages/ui/src/components/**"
      - "apps/docs-site/**"
      - ".github/workflows/docs-validation.yml"

env:
  CI: true

jobs:
  validate-docs:
    name: Validate Documentation
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [20.x]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ matrix.node-version }}

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.23.0

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # Documentation metadata validation
      - name: Validate documentation metadata
        run: pnpm --filter docs-site validate:metadata

      # API documentation sync check (warning mode - reports but doesn't fail)
      - name: Validate API documentation sync
        run: pnpm --filter docs-site validate:api-sync
        continue-on-error: true # Warn about undocumented endpoints but don't block PR

      # Check for broken links
      - name: Check link integrity
        run: pnpm --filter docs-site check:links

      # Check for stale documentation
      - name: Check documentation freshness
        run: pnpm --filter docs-site check:freshness
        continue-on-error: true # Warning only, don't fail build

      # Generate all documentation artifacts
      - name: Generate documentation artifacts
        run: pnpm --filter docs-site generate:all

      # Build docs site to verify it compiles
      - name: Build documentation site
        run: pnpm --filter docs-site build

      # Verify no uncommitted generated files (warning only)
      - name: Check for uncommitted generated files
        continue-on-error: true # Warn about out-of-sync files but don't block PR
        run: |
          if [[ -n $(git status --porcelain apps/docs-site/src/generated/ 2>/dev/null) ]]; then
            echo "::warning::Generated documentation files are out of sync."
            echo "Run 'pnpm --filter docs-site generate:all' locally and commit the changes."
            git diff apps/docs-site/src/generated/
          else
            echo "Generated files are in sync."
          fi

  api-spec-check:
    name: API Spec Synchronization
    runs-on: ubuntu-latest
    if: ${{ contains(github.event.head_commit.modified, 'services/api-gateway/') || contains(github.event.head_commit.added, 'services/api-gateway/') }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 20.x

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.23.0

      - name: Install Node dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Python dependencies
        run: |
          cd services/api-gateway
          pip install -r requirements.txt
        continue-on-error: true

      - name: Check OpenAPI spec sync
        run: pnpm --filter docs-site sync:openapi
        continue-on-error: true # Don't fail if server not running

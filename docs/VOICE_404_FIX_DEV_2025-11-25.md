# Voice Mode 404 Fix on dev.asimo.io

**Date:** 2025-11-25
**Fixed by:** Claude (automated deployment fix)

## Symptom

- Browser showed: `Error: Failed to fetch session config: Request failed with status code 404`
- Network tab: `POST /api/voice/realtime-session` → 404 Not Found
- Server header in response: `Server: uvicorn` (confirming request reached backend)

## Root Cause

**The Docker container was running stale code that didn't include PR #60's fix.**

PR #60 (merged to main) added `prefix="/api"` to the voice router mount in `main.py`:

```python
# Before (container had this):
app.include_router(voice.router)  # Routes at /voice/*

# After (source code had this):
app.include_router(voice.router, prefix="/api")  # Routes at /api/voice/*
```

The Docker image was built before PR #60 was merged, so the container was exposing routes at `/voice/*` while the frontend expected `/api/voice/*`.

### Evidence

```bash
# Container (stale code):
$ docker exec voiceassist-server grep -A2 "voice.router" /app/app/main.py
    voice.router
)  # Milestone 1 Phase 3

# Source (current code):
$ grep -A2 "voice.router" services/api-gateway/app/main.py
    voice.router, prefix="/api"
)  # Milestone 1 Phase 3
```

## Fix Applied

Since a full Docker rebuild failed due to a dependency conflict (`arq 0.26.3` requires `redis<6` but `requirements.txt` specifies `redis==7.1.0`), a hot-patch was applied:

```bash
# Stop container
docker stop voiceassist-server

# Copy updated app directory to container
docker cp services/api-gateway/app voiceassist-server:/app/

# Restart container
docker start voiceassist-server
```

## Verification

1. **Backend route check:**

   ```bash
   $ curl -X POST http://localhost:8000/api/voice/realtime-session
   HTTP/1.1 403 Forbidden  # Was 404 before fix
   {"detail":"Not authenticated"}
   ```

2. **OpenAPI routes:**

   ```bash
   $ curl -s http://localhost:8000/openapi.json | grep voice
   "/api/voice/transcribe"
   "/api/voice/synthesize"
   "/api/voice/realtime-session"
   "/api/voice/metrics"
   ```

3. **dev.asimo.io endpoint:**

   ```bash
   $ curl -X POST https://dev.asimo.io/api/voice/realtime-session
   HTTP/1.1 403 Forbidden  # Was 404 before fix
   ```

4. **Tests:**
   - Frontend voice tests: 84 passed ✅
   - Backend voice metrics tests: 11 passed ✅

## Future Prevention

1. **CI/CD should rebuild Docker images on merge to main** - The current workflow doesn't automatically rebuild and redeploy when code is merged.

2. **Fix the dependency conflict** - The `redis==7.1.0` and `arq==0.26.3` conflict needs to be resolved:
   - Option A: Upgrade `arq` to a version compatible with redis 7.x
   - Option B: Downgrade `redis` to 5.x
   - Option C: Find an alternative to `arq` that supports redis 7.x

3. **Add deployment verification** - After merge to main, verify the live deployment is serving the expected routes.

## Notes

- The hot-patch (copying files into running container) is a temporary fix
- A proper Docker rebuild should be done once the dependency conflict is resolved
- Container restart doesn't persist - if the container is rebuilt, it will use the old image unless the image is also updated

---

_Last updated: 2025-11-25 by Claude_

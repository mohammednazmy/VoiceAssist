{
  "path": "apps/web-app/src/components/voice/VoiceFirstInputBar.tsx",
  "language": "typescript",
  "size": 20915,
  "last_modified": "2025-12-04T21:46:28.147Z",
  "lines": 625,
  "content": "/**\n * VoiceFirstInputBar - Phase 3 Voice Mode v4.1\n *\n * A unified voice-first input bar that prioritizes voice interaction\n * while providing text fallback. Respects VAD presets and RTL settings.\n *\n * Features:\n * - Voice-first design with prominent mic button\n * - Text input fallback (expandable)\n * - VAD preset integration (sensitive/balanced/relaxed/accessibility/custom)\n * - RTL layout support with auto-detection\n * - PHI mode indicator integration\n * - Always-on and push-to-talk modes\n * - Keyboard shortcuts (Space to talk, Escape to cancel)\n *\n * Reference: docs/voice/phase3-implementation-plan.md\n */\n\nimport { useState, useRef, useCallback, useEffect, useMemo } from \"react\";\nimport { useVoiceSettingsStore, VAD_PRESET_OPTIONS } from \"../../stores/voiceSettingsStore\";\nimport { cn } from \"@/lib/utils\";\n\n// RTL language codes for auto-detection\nconst RTL_LANGUAGES = [\"ar\", \"he\", \"fa\", \"ur\", \"yi\", \"ps\", \"sd\"];\n\ninterface VoiceFirstInputBarProps {\n  /** Callback when voice/text input is submitted */\n  onSubmit: (input: string, isVoice: boolean) => void;\n  /** Callback when recording starts */\n  onRecordingStart?: () => void;\n  /** Callback when recording stops */\n  onRecordingStop?: () => void;\n  /** Current PHI mode for indicator */\n  phiMode?: \"local\" | \"hybrid\" | \"cloud\";\n  /** PHI score (0-1) for visual indicator */\n  phiScore?: number;\n  /** Whether the assistant is currently speaking */\n  isAssistantSpeaking?: boolean;\n  /** Whether input is disabled */\n  disabled?: boolean;\n  /** Detected language code for RTL */\n  detectedLanguage?: string;\n  /** Placeholder text */\n  placeholder?: string;\n  /** Custom class name */\n  className?: string;\n}\n\ntype InputState =\n  | \"idle\"\n  | \"listening\"\n  | \"processing\"\n  | \"text-input\"\n  | \"error\";\n\ninterface VADParameters {\n  energyThresholdDb: number;\n  silenceDurationMs: number;\n}\n\nexport function VoiceFirstInputBar({\n  onSubmit,\n  onRecordingStart,\n  onRecordingStop,\n  phiMode = \"cloud\",\n  phiScore = 0,\n  isAssistantSpeaking = false,\n  disabled = false,\n  detectedLanguage,\n  placeholder = \"Press space or tap mic to speak...\",\n  className,\n}: VoiceFirstInputBarProps) {\n  const [inputState, setInputState] = useState<InputState>(\"idle\");\n  const [textValue, setTextValue] = useState(\"\");\n  const [errorMessage, setErrorMessage] = useState<string | null>(null);\n  const [energy, setEnergy] = useState(0);\n\n  const textInputRef = useRef<HTMLInputElement>(null);\n  const micButtonRef = useRef<HTMLButtonElement>(null);\n\n  // Get settings from store\n  const {\n    voiceModeType,\n    vadPreset,\n    vadCustomEnergyThresholdDb,\n    vadCustomSilenceDurationMs,\n    rtlEnabled,\n    rtlAutoDetect,\n    keyboardShortcutsEnabled,\n  } = useVoiceSettingsStore();\n\n  // Compute RTL direction\n  const isRtl = useMemo(() => {\n    if (rtlEnabled) return true;\n    if (rtlAutoDetect && detectedLanguage) {\n      return RTL_LANGUAGES.includes(detectedLanguage.toLowerCase().slice(0, 2));\n    }\n    return false;\n  }, [rtlEnabled, rtlAutoDetect, detectedLanguage]);\n\n  // Get VAD parameters from preset\n  const vadParams = useMemo((): VADParameters => {\n    if (vadPreset === \"custom\") {\n      return {\n        energyThresholdDb: vadCustomEnergyThresholdDb,\n        silenceDurationMs: vadCustomSilenceDurationMs,\n      };\n    }\n    const preset = VAD_PRESET_OPTIONS.find((p) => p.value === vadPreset);\n    return {\n      energyThresholdDb: preset?.energyThresholdDb ?? -35,\n      silenceDurationMs: preset?.silenceDurationMs ?? 500,\n    };\n  }, [vadPreset, vadCustomEnergyThresholdDb, vadCustomSilenceDurationMs]);\n\n  // PHI indicator color and icon\n  const phiIndicator = useMemo(() => {\n    const colors = {\n      local: \"bg-green-500\",\n      hybrid: \"bg-yellow-500\",\n      cloud: \"bg-blue-500\",\n    };\n    const icons = {\n      local: \"shield\",\n      hybrid: \"lock\",\n      cloud: \"cloud\",\n    };\n    return {\n      color: colors[phiMode],\n      icon: icons[phiMode],\n      isSecure: phiMode === \"local\" || phiMode === \"hybrid\",\n    };\n  }, [phiMode]);\n\n  // Handle keyboard shortcuts\n  useEffect(() => {\n    if (!keyboardShortcutsEnabled || disabled) return;\n\n    const handleKeyDown = (e: KeyboardEvent) => {\n      // Space to start talking (when not in text input)\n      if (\n        e.code === \"Space\" &&\n        inputState === \"idle\" &&\n        document.activeElement !== textInputRef.current\n      ) {\n        e.preventDefault();\n        handleStartRecording();\n      }\n\n      // Escape to cancel recording\n      if (e.code === \"Escape\" && inputState === \"listening\") {\n        e.preventDefault();\n        handleCancelRecording();\n      }\n\n      // Tab to switch to text input\n      if (e.code === \"Tab\" && inputState === \"idle\") {\n        // Allow default tab behavior, but if focused on mic, switch to text mode\n        if (document.activeElement === micButtonRef.current) {\n          e.preventDefault();\n          setInputState(\"text-input\");\n          setTimeout(() => textInputRef.current?.focus(), 0);\n        }\n      }\n    };\n\n    const handleKeyUp = (e: KeyboardEvent) => {\n      // Release space to stop (push-to-talk mode)\n      if (\n        e.code === \"Space\" &&\n        inputState === \"listening\" &&\n        voiceModeType === \"push-to-talk\"\n      ) {\n        handleStopRecording();\n      }\n    };\n\n    window.addEventListener(\"keydown\", handleKeyDown);\n    window.addEventListener(\"keyup\", handleKeyUp);\n\n    return () => {\n      window.removeEventListener(\"keydown\", handleKeyDown);\n      window.removeEventListener(\"keyup\", handleKeyUp);\n    };\n  }, [inputState, voiceModeType, keyboardShortcutsEnabled, disabled]);\n\n  const handleStartRecording = useCallback(() => {\n    if (disabled || isAssistantSpeaking) return;\n\n    setInputState(\"listening\");\n    setErrorMessage(null);\n    onRecordingStart?.();\n\n    // Simulate energy updates (in real implementation, this comes from VAD)\n    const energyInterval = setInterval(() => {\n      setEnergy(Math.random() * 0.8 + 0.2);\n    }, 100);\n\n    // Store interval ID for cleanup\n    (window as unknown as { __energyInterval: NodeJS.Timeout }).__energyInterval = energyInterval;\n  }, [disabled, isAssistantSpeaking, onRecordingStart]);\n\n  const handleStopRecording = useCallback(() => {\n    setInputState(\"processing\");\n    setEnergy(0);\n    onRecordingStop?.();\n\n    // Clear energy interval\n    const energyInterval = (window as unknown as { __energyInterval?: NodeJS.Timeout }).__energyInterval;\n    if (energyInterval) {\n      clearInterval(energyInterval);\n    }\n\n    // Simulate processing (in real implementation, this waits for transcription)\n    setTimeout(() => {\n      // Simulated transcript for demo\n      const demoTranscript = \"This is a simulated voice transcript\";\n      onSubmit(demoTranscript, true);\n      setInputState(\"idle\");\n    }, 1000);\n  }, [onRecordingStop, onSubmit]);\n\n  const handleCancelRecording = useCallback(() => {\n    setInputState(\"idle\");\n    setEnergy(0);\n    onRecordingStop?.();\n\n    const energyInterval = (window as unknown as { __energyInterval?: NodeJS.Timeout }).__energyInterval;\n    if (energyInterval) {\n      clearInterval(energyInterval);\n    }\n  }, [onRecordingStop]);\n\n  const handleTextSubmit = useCallback(\n    (e: React.FormEvent) => {\n      e.preventDefault();\n      if (textValue.trim()) {\n        onSubmit(textValue.trim(), false);\n        setTextValue(\"\");\n        setInputState(\"idle\");\n      }\n    },\n    [textValue, onSubmit]\n  );\n\n  const handleTextInputFocus = useCallback(() => {\n    if (inputState === \"idle\") {\n      setInputState(\"text-input\");\n    }\n  }, [inputState]);\n\n  const handleTextInputBlur = useCallback(() => {\n    if (inputState === \"text-input\" && !textValue) {\n      setInputState(\"idle\");\n    }\n  }, [inputState, textValue]);\n\n  // Mic button click/touch handlers\n  const handleMicInteraction = useCallback(() => {\n    if (inputState === \"idle\") {\n      handleStartRecording();\n    } else if (inputState === \"listening\") {\n      if (voiceModeType === \"always-on\") {\n        handleStopRecording();\n      }\n    }\n  }, [inputState, voiceModeType, handleStartRecording, handleStopRecording]);\n\n  return (\n    <div\n      className={cn(\n        \"voice-first-input-bar\",\n        \"flex items-center gap-3 p-3 bg-white dark:bg-neutral-900\",\n        \"border border-neutral-200 dark:border-neutral-700 rounded-2xl\",\n        \"shadow-sm transition-all duration-200\",\n        inputState === \"listening\" && \"ring-2 ring-blue-500 ring-opacity-50\",\n        inputState === \"error\" && \"ring-2 ring-red-500 ring-opacity-50\",\n        disabled && \"opacity-50 pointer-events-none\",\n        className\n      )}\n      dir={isRtl ? \"rtl\" : \"ltr\"}\n      data-testid=\"voice-first-input-bar\"\n    >\n      {/* PHI Mode Indicator */}\n      <div\n        className={cn(\n          \"flex-shrink-0 w-2 h-2 rounded-full transition-colors\",\n          phiIndicator.color\n        )}\n        title={`PHI Mode: ${phiMode} (score: ${Math.round(phiScore * 100)}%)`}\n        aria-label={`PHI security mode: ${phiMode}`}\n      />\n\n      {/* Main Input Area */}\n      <div className=\"flex-1 flex items-center gap-2\">\n        {inputState === \"text-input\" ? (\n          /* Text Input Mode */\n          <form onSubmit={handleTextSubmit} className=\"flex-1 flex gap-2\">\n            <input\n              ref={textInputRef}\n              type=\"text\"\n              value={textValue}\n              onChange={(e) => setTextValue(e.target.value)}\n              onBlur={handleTextInputBlur}\n              placeholder=\"Type your message...\"\n              className={cn(\n                \"flex-1 px-3 py-2 bg-neutral-50 dark:bg-neutral-800\",\n                \"border border-neutral-200 dark:border-neutral-600 rounded-lg\",\n                \"text-sm text-neutral-900 dark:text-neutral-100\",\n                \"focus:outline-none focus:ring-2 focus:ring-blue-500\",\n                isRtl && \"text-right\"\n              )}\n              dir={isRtl ? \"rtl\" : \"ltr\"}\n              autoFocus\n            />\n            <button\n              type=\"submit\"\n              disabled={!textValue.trim()}\n              className={cn(\n                \"px-4 py-2 bg-blue-500 text-white rounded-lg\",\n                \"text-sm font-medium\",\n                \"hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500\",\n                \"disabled:opacity-50 disabled:cursor-not-allowed\",\n                \"transition-colors\"\n              )}\n            >\n              Send\n            </button>\n            <button\n              type=\"button\"\n              onClick={() => {\n                setInputState(\"idle\");\n                setTextValue(\"\");\n              }}\n              className=\"p-2 text-neutral-500 hover:text-neutral-700 dark:hover:text-neutral-300\"\n              aria-label=\"Cancel text input\"\n            >\n              <svg\n                xmlns=\"http://www.w3.org/2000/svg\"\n                fill=\"none\"\n                viewBox=\"0 0 24 24\"\n                strokeWidth={2}\n                stroke=\"currentColor\"\n                className=\"w-5 h-5\"\n              >\n                <path\n                  strokeLinecap=\"round\"\n                  strokeLinejoin=\"round\"\n                  d=\"M6 18L18 6M6 6l12 12\"\n                />\n              </svg>\n            </button>\n          </form>\n        ) : inputState === \"listening\" ? (\n          /* Listening Mode */\n          <div className=\"flex-1 flex items-center gap-3\">\n            {/* Energy Visualizer */}\n            <div className=\"flex-1 flex items-center gap-1 h-8\">\n              {Array.from({ length: 12 }).map((_, i) => (\n                <div\n                  key={i}\n                  className={cn(\n                    \"flex-1 bg-blue-500 rounded-full transition-all duration-75\",\n                    isRtl && \"order-last\"\n                  )}\n                  style={{\n                    height: `${Math.max(4, energy * 100 * Math.sin((i / 12) * Math.PI) * (0.5 + Math.random() * 0.5))}%`,\n                    opacity: 0.6 + energy * 0.4,\n                  }}\n                />\n              ))}\n            </div>\n\n            {/* Listening Status */}\n            <div className=\"flex items-center gap-2 text-sm text-blue-600 dark:text-blue-400\">\n              <span className=\"w-2 h-2 bg-red-500 rounded-full animate-pulse\" />\n              <span>Listening...</span>\n            </div>\n\n            {/* Stop/Cancel Buttons */}\n            {voiceModeType === \"always-on\" && (\n              <button\n                type=\"button\"\n                onClick={handleStopRecording}\n                className={cn(\n                  \"px-3 py-1.5 bg-blue-500 text-white rounded-lg\",\n                  \"text-sm font-medium hover:bg-blue-600\",\n                  \"focus:outline-none focus:ring-2 focus:ring-blue-500\"\n                )}\n              >\n                Done\n              </button>\n            )}\n            <button\n              type=\"button\"\n              onClick={handleCancelRecording}\n              className=\"p-2 text-neutral-500 hover:text-red-500 transition-colors\"\n              aria-label=\"Cancel recording\"\n            >\n              <svg\n                xmlns=\"http://www.w3.org/2000/svg\"\n                fill=\"none\"\n                viewBox=\"0 0 24 24\"\n                strokeWidth={2}\n                stroke=\"currentColor\"\n                className=\"w-5 h-5\"\n              >\n                <path\n                  strokeLinecap=\"round\"\n                  strokeLinejoin=\"round\"\n                  d=\"M6 18L18 6M6 6l12 12\"\n                />\n              </svg>\n            </button>\n          </div>\n        ) : inputState === \"processing\" ? (\n          /* Processing Mode */\n          <div className=\"flex-1 flex items-center justify-center gap-2 text-sm text-neutral-600 dark:text-neutral-400\">\n            <svg\n              className=\"w-5 h-5 animate-spin text-blue-500\"\n              xmlns=\"http://www.w3.org/2000/svg\"\n              fill=\"none\"\n              viewBox=\"0 0 24 24\"\n            >\n              <circle\n                className=\"opacity-25\"\n                cx=\"12\"\n                cy=\"12\"\n                r=\"10\"\n                stroke=\"currentColor\"\n                strokeWidth=\"4\"\n              />\n              <path\n                className=\"opacity-75\"\n                fill=\"currentColor\"\n                d=\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z\"\n              />\n            </svg>\n            <span>Processing speech...</span>\n          </div>\n        ) : (\n          /* Idle Mode - Voice-First Prompt */\n          <div\n            className={cn(\n              \"flex-1 flex items-center gap-2\",\n              \"text-neutral-500 dark:text-neutral-400 text-sm cursor-pointer\"\n            )}\n            onClick={handleTextInputFocus}\n            onKeyDown={(e) => {\n              if (e.key === \"Enter\") handleTextInputFocus();\n            }}\n            role=\"button\"\n            tabIndex={0}\n          >\n            <span className={cn(isRtl && \"order-last\")}>{placeholder}</span>\n          </div>\n        )}\n      </div>\n\n      {/* Microphone Button */}\n      <button\n        ref={micButtonRef}\n        type=\"button\"\n        disabled={disabled || inputState === \"processing\"}\n        onClick={handleMicInteraction}\n        onMouseDown={\n          voiceModeType === \"push-to-talk\" && inputState === \"idle\"\n            ? handleStartRecording\n            : undefined\n        }\n        onMouseUp={\n          voiceModeType === \"push-to-talk\" && inputState === \"listening\"\n            ? handleStopRecording\n            : undefined\n        }\n        onTouchStart={\n          voiceModeType === \"push-to-talk\" && inputState === \"idle\"\n            ? handleStartRecording\n            : undefined\n        }\n        onTouchEnd={\n          voiceModeType === \"push-to-talk\" && inputState === \"listening\"\n            ? handleStopRecording\n            : undefined\n        }\n        className={cn(\n          \"flex-shrink-0 p-3 rounded-full transition-all duration-200\",\n          \"focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2\",\n          inputState === \"listening\"\n            ? \"bg-red-500 text-white hover:bg-red-600 scale-110\"\n            : inputState === \"processing\"\n              ? \"bg-neutral-200 dark:bg-neutral-700 text-neutral-400 cursor-wait\"\n              : \"bg-blue-500 text-white hover:bg-blue-600 active:scale-95\"\n        )}\n        aria-label={\n          inputState === \"listening\"\n            ? voiceModeType === \"push-to-talk\"\n              ? \"Release to stop recording\"\n              : \"Tap to stop recording\"\n            : inputState === \"processing\"\n              ? \"Processing...\"\n              : voiceModeType === \"push-to-talk\"\n                ? \"Hold to record\"\n                : \"Tap to start recording\"\n        }\n      >\n        {inputState === \"listening\" ? (\n          /* Recording Icon */\n          <svg\n            xmlns=\"http://www.w3.org/2000/svg\"\n            fill=\"currentColor\"\n            viewBox=\"0 0 24 24\"\n            className=\"w-6 h-6 animate-pulse\"\n          >\n            <path d=\"M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z\" />\n            <path d=\"M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z\" />\n          </svg>\n        ) : inputState === \"processing\" ? (\n          /* Processing Icon */\n          <svg\n            className=\"w-6 h-6 animate-spin\"\n            xmlns=\"http://www.w3.org/2000/svg\"\n            fill=\"none\"\n            viewBox=\"0 0 24 24\"\n          >\n            <circle\n              className=\"opacity-25\"\n              cx=\"12\"\n              cy=\"12\"\n              r=\"10\"\n              stroke=\"currentColor\"\n              strokeWidth=\"4\"\n            />\n            <path\n              className=\"opacity-75\"\n              fill=\"currentColor\"\n              d=\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z\"\n            />\n          </svg>\n        ) : (\n          /* Mic Icon */\n          <svg\n            xmlns=\"http://www.w3.org/2000/svg\"\n            fill=\"none\"\n            viewBox=\"0 0 24 24\"\n            strokeWidth={2}\n            stroke=\"currentColor\"\n            className=\"w-6 h-6\"\n          >\n            <path\n              strokeLinecap=\"round\"\n              strokeLinejoin=\"round\"\n              d=\"M12 18.75a6 6 0 006-6v-1.5m-6 7.5a6 6 0 01-6-6v-1.5m6 7.5v3.75m-3.75 0h7.5M12 15.75a3 3 0 01-3-3V4.5a3 3 0 116 0v8.25a3 3 0 01-3 3z\"\n            />\n          </svg>\n        )}\n      </button>\n\n      {/* Text Input Toggle (visible in idle mode) */}\n      {inputState === \"idle\" && (\n        <button\n          type=\"button\"\n          onClick={handleTextInputFocus}\n          className={cn(\n            \"flex-shrink-0 p-2 text-neutral-400 hover:text-neutral-600\",\n            \"dark:hover:text-neutral-300 transition-colors\",\n            \"focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg\"\n          )}\n          aria-label=\"Switch to text input\"\n        >\n          <svg\n            xmlns=\"http://www.w3.org/2000/svg\"\n            fill=\"none\"\n            viewBox=\"0 0 24 24\"\n            strokeWidth={1.5}\n            stroke=\"currentColor\"\n            className=\"w-5 h-5\"\n          >\n            <path\n              strokeLinecap=\"round\"\n              strokeLinejoin=\"round\"\n              d=\"M7.5 8.25h9m-9 3H12m-9.75 1.51c0 1.6 1.123 2.994 2.707 3.227 1.129.166 2.27.293 3.423.379.35.026.67.21.865.501L12 21l2.755-4.133a1.14 1.14 0 01.865-.501 48.172 48.172 0 003.423-.379c1.584-.233 2.707-1.626 2.707-3.228V6.741c0-1.602-1.123-2.995-2.707-3.228A48.394 48.394 0 0012 3c-2.392 0-4.744.175-7.043.513C3.373 3.746 2.25 5.14 2.25 6.741v6.018z\"\n            />\n          </svg>\n        </button>\n      )}\n\n      {/* VAD Preset Indicator (small badge) */}\n      <div\n        className={cn(\n          \"absolute -top-2 -right-2 px-1.5 py-0.5 rounded-full text-xs\",\n          \"bg-neutral-100 dark:bg-neutral-800 text-neutral-600 dark:text-neutral-400\",\n          \"border border-neutral-200 dark:border-neutral-700\",\n          \"opacity-0 group-hover:opacity-100 transition-opacity\"\n        )}\n        title={`VAD: ${vadPreset} (${vadParams.energyThresholdDb}dB, ${vadParams.silenceDurationMs}ms)`}\n      >\n        {VAD_PRESET_OPTIONS.find((p) => p.value === vadPreset)?.icon}\n      </div>\n\n      {/* Error Display */}\n      {errorMessage && (\n        <div\n          className={cn(\n            \"absolute top-full left-0 right-0 mt-2 p-2\",\n            \"bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800\",\n            \"rounded-lg text-sm text-red-600 dark:text-red-400\"\n          )}\n        >\n          {errorMessage}\n          <button\n            type=\"button\"\n            onClick={() => setErrorMessage(null)}\n            className=\"ml-2 text-red-500 hover:text-red-700\"\n          >\n            Dismiss\n          </button>\n        </div>\n      )}\n    </div>\n  );\n}\n\nexport default VoiceFirstInputBar;\n"
}

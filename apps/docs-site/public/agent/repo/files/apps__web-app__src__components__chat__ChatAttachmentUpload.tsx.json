{
  "path": "apps/web-app/src/components/chat/ChatAttachmentUpload.tsx",
  "language": "typescript",
  "size": 7959,
  "last_modified": "2025-11-25T09:43:39.262Z",
  "lines": 248,
  "content": "/**\n * ChatAttachmentUpload Component\n * Handles file selection for message attachments (different from KB document upload)\n * Files are NOT uploaded immediately - they're sent after the message is created\n */\n\nimport { useRef, useCallback } from \"react\";\n\nexport interface PendingFile {\n  file: File;\n  id: string; // Local temp ID\n  preview?: string;\n}\n\nexport interface ChatAttachmentUploadProps {\n  onFilesSelected: (files: PendingFile[]) => void;\n  onFileRemoved?: (fileId: string) => void;\n  maxFiles?: number;\n  maxSizeMB?: number;\n  accept?: string;\n  disabled?: boolean;\n  selectedFiles?: PendingFile[];\n}\n\nexport function ChatAttachmentUpload({\n  onFilesSelected,\n  onFileRemoved,\n  maxFiles = 5,\n  maxSizeMB = 10,\n  accept = \".pdf,.png,.jpg,.jpeg,.txt,.md,.doc,.docx\",\n  disabled = false,\n  selectedFiles = [],\n}: ChatAttachmentUploadProps) {\n  const fileInputRef = useRef<HTMLInputElement>(null);\n\n  // Generate preview for images\n  const generatePreview = useCallback((file: File): Promise<string> => {\n    return new Promise((resolve, reject) => {\n      if (!file.type.startsWith(\"image/\")) {\n        reject(new Error(\"Not an image\"));\n        return;\n      }\n\n      const reader = new FileReader();\n      reader.onload = (e) => {\n        resolve(e.target?.result as string);\n      };\n      reader.onerror = reject;\n      reader.readAsDataURL(file);\n    });\n  }, []);\n\n  const handleFileSelect = useCallback(\n    async (files: FileList | null) => {\n      if (!files || files.length === 0 || disabled) return;\n\n      const filesToAdd = Array.from(files);\n\n      // Validate file count\n      if (selectedFiles.length + filesToAdd.length > maxFiles) {\n        alert(`Maximum ${maxFiles} files allowed`);\n        return;\n      }\n\n      // Validate file sizes\n      const maxSizeBytes = maxSizeMB * 1024 * 1024;\n      const oversizedFiles = filesToAdd.filter((f) => f.size > maxSizeBytes);\n      if (oversizedFiles.length > 0) {\n        alert(\n          `Files too large (max ${maxSizeMB}MB): ${oversizedFiles.map((f) => f.name).join(\", \")}`,\n        );\n        return;\n      }\n\n      // Convert to PendingFile objects\n      const pendingFiles: PendingFile[] = [];\n      for (const file of filesToAdd) {\n        let preview: string | undefined;\n        try {\n          preview = await generatePreview(file);\n        } catch {\n          // Not an image, no preview needed\n        }\n\n        pendingFiles.push({\n          file,\n          id: `pending-${Date.now()}-${Math.random().toString(36).slice(2)}`,\n          preview,\n        });\n      }\n\n      onFilesSelected([...selectedFiles, ...pendingFiles]);\n\n      // Reset input\n      if (fileInputRef.current) {\n        fileInputRef.current.value = \"\";\n      }\n    },\n    [\n      disabled,\n      maxFiles,\n      maxSizeMB,\n      selectedFiles,\n      onFilesSelected,\n      generatePreview,\n    ],\n  );\n\n  const handleRemoveFile = useCallback(\n    (fileId: string) => {\n      const updatedFiles = selectedFiles.filter((f) => f.id !== fileId);\n      onFilesSelected(updatedFiles);\n      onFileRemoved?.(fileId);\n    },\n    [selectedFiles, onFilesSelected, onFileRemoved],\n  );\n\n  const formatFileSize = (bytes: number): string => {\n    if (bytes === 0) return \"0 Bytes\";\n    const k = 1024;\n    const sizes = [\"Bytes\", \"KB\", \"MB\"];\n    const i = Math.floor(Math.log(bytes) / Math.log(k));\n    return Math.round((bytes / Math.pow(k, i)) * 100) / 100 + \" \" + sizes[i];\n  };\n\n  return (\n    <div className=\"space-y-3\">\n      {/* Upload Button */}\n      <label\n        className={`flex items-center justify-center w-full px-4 py-3 border-2 border-dashed rounded-lg transition-colors cursor-pointer ${\n          disabled\n            ? \"border-neutral-300 bg-neutral-100 cursor-not-allowed\"\n            : \"border-primary-300 hover:border-primary-400 hover:bg-primary-50\"\n        }`}\n      >\n        <div className=\"text-center\">\n          <svg\n            xmlns=\"http://www.w3.org/2000/svg\"\n            fill=\"none\"\n            viewBox=\"0 0 24 24\"\n            strokeWidth={1.5}\n            stroke=\"currentColor\"\n            className=\"w-8 h-8 mx-auto mb-2 text-primary-500\"\n          >\n            <path\n              strokeLinecap=\"round\"\n              strokeLinejoin=\"round\"\n              d=\"M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5\"\n            />\n          </svg>\n          <p className=\"text-sm text-neutral-700 font-medium\">\n            Click to select files\n          </p>\n          <p className=\"text-xs text-neutral-500 mt-1\">\n            PDF, Images, Documents (max {maxSizeMB}MB each)\n          </p>\n          <p className=\"text-xs text-neutral-400 mt-1 italic\">\n            Files will be uploaded when you send the message\n          </p>\n        </div>\n        <input\n          ref={fileInputRef}\n          type=\"file\"\n          multiple\n          disabled={disabled}\n          accept={accept}\n          onChange={(e) => handleFileSelect(e.target.files)}\n          className=\"hidden\"\n        />\n      </label>\n\n      {/* Selected Files */}\n      {selectedFiles.length > 0 && (\n        <div className=\"space-y-2\">\n          <p className=\"text-sm font-medium text-neutral-700\">\n            Selected Files ({selectedFiles.length}/{maxFiles})\n          </p>\n          {selectedFiles.map((pendingFile) => (\n            <div\n              key={pendingFile.id}\n              className=\"flex items-center gap-3 p-3 bg-white rounded-lg border border-neutral-200 shadow-sm\"\n            >\n              {/* Preview or Icon */}\n              {pendingFile.preview ? (\n                <img\n                  src={pendingFile.preview}\n                  alt={pendingFile.file.name}\n                  className=\"w-12 h-12 object-cover rounded\"\n                />\n              ) : (\n                <div className=\"flex items-center justify-center w-12 h-12 bg-neutral-100 rounded\">\n                  <svg\n                    xmlns=\"http://www.w3.org/2000/svg\"\n                    fill=\"none\"\n                    viewBox=\"0 0 24 24\"\n                    strokeWidth={1.5}\n                    stroke=\"currentColor\"\n                    className=\"w-6 h-6 text-neutral-500\"\n                  >\n                    <path\n                      strokeLinecap=\"round\"\n                      strokeLinejoin=\"round\"\n                      d=\"M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z\"\n                    />\n                  </svg>\n                </div>\n              )}\n\n              {/* File Info */}\n              <div className=\"flex-1 min-w-0\">\n                <p className=\"text-sm font-medium text-neutral-900 truncate\">\n                  {pendingFile.file.name}\n                </p>\n                <p className=\"text-xs text-neutral-500\">\n                  {formatFileSize(pendingFile.file.size)}\n                </p>\n              </div>\n\n              {/* Remove Button */}\n              <button\n                type=\"button\"\n                onClick={() => handleRemoveFile(pendingFile.id)}\n                className=\"flex-shrink-0 p-1 text-neutral-400 hover:text-red-600 hover:bg-red-50 rounded transition-colors\"\n                aria-label=\"Remove file\"\n              >\n                <svg\n                  xmlns=\"http://www.w3.org/2000/svg\"\n                  fill=\"none\"\n                  viewBox=\"0 0 24 24\"\n                  strokeWidth={2}\n                  stroke=\"currentColor\"\n                  className=\"w-5 h-5\"\n                >\n                  <path\n                    strokeLinecap=\"round\"\n                    strokeLinejoin=\"round\"\n                    d=\"M6 18L18 6M6 6l12 12\"\n                  />\n                </svg>\n              </button>\n            </div>\n          ))}\n        </div>\n      )}\n    </div>\n  );\n}\n"
}

{
  "path": "apps/admin-panel/src/components/feature-flags/RuleEditor.tsx",
  "language": "typescript",
  "size": 21989,
  "last_modified": "2025-12-04T12:32:40.220Z",
  "lines": 585,
  "content": "/**\n * RuleEditor Component\n * Phase 3.2: Edit targeting rules for feature flag segmentation\n *\n * Allows creating and editing targeting rules with conditions.\n */\n\nimport { useState, useCallback } from \"react\";\nimport type {\n  TargetingRule,\n  TargetingCondition,\n  TargetingOperator,\n  TargetingAttribute,\n} from \"@voiceassist/types\";\n\n// Available targeting attributes\nconst TARGETING_ATTRIBUTES: Array<{\n  value: TargetingAttribute;\n  label: string;\n}> = [\n  { value: \"user_id\", label: \"User ID\" },\n  { value: \"user_email\", label: \"User Email\" },\n  { value: \"user_role\", label: \"User Role\" },\n  { value: \"user_plan\", label: \"Subscription Plan\" },\n  { value: \"user_country\", label: \"Country\" },\n  { value: \"user_language\", label: \"Language\" },\n  { value: \"app_version\", label: \"App Version\" },\n  { value: \"platform\", label: \"Platform\" },\n  { value: \"custom\", label: \"Custom Attribute\" },\n];\n\n// Available operators grouped by type\nconst OPERATORS: Array<{\n  value: TargetingOperator;\n  label: string;\n  group: string;\n}> = [\n  { value: \"equals\", label: \"Equals\", group: \"String\" },\n  { value: \"not_equals\", label: \"Not Equals\", group: \"String\" },\n  { value: \"in\", label: \"In List\", group: \"String\" },\n  { value: \"not_in\", label: \"Not In List\", group: \"String\" },\n  { value: \"contains\", label: \"Contains\", group: \"String\" },\n  { value: \"starts_with\", label: \"Starts With\", group: \"String\" },\n  { value: \"ends_with\", label: \"Ends With\", group: \"String\" },\n  { value: \"regex\", label: \"Regex Match\", group: \"String\" },\n  { value: \"gt\", label: \"Greater Than\", group: \"Numeric\" },\n  { value: \"gte\", label: \"Greater Than or Equal\", group: \"Numeric\" },\n  { value: \"lt\", label: \"Less Than\", group: \"Numeric\" },\n  { value: \"lte\", label: \"Less Than or Equal\", group: \"Numeric\" },\n  { value: \"semver_gt\", label: \"Version >\", group: \"Version\" },\n  { value: \"semver_gte\", label: \"Version >=\", group: \"Version\" },\n  { value: \"semver_lt\", label: \"Version <\", group: \"Version\" },\n  { value: \"semver_lte\", label: \"Version <=\", group: \"Version\" },\n];\n\ninterface RuleEditorProps {\n  /** Current list of rules */\n  rules: TargetingRule[];\n  /** Callback when rules change */\n  onChange: (rules: TargetingRule[]) => void;\n  /** Available variants for multivariate flags */\n  variants?: Array<{ id: string; name: string }>;\n  /** Whether this is a boolean flag */\n  isBoolean?: boolean;\n  /** Whether editing is disabled */\n  disabled?: boolean;\n}\n\n/**\n * Editor for feature flag targeting rules.\n * Supports creating rules with multiple AND conditions.\n */\nexport function RuleEditor({\n  rules,\n  onChange,\n  variants = [],\n  isBoolean = true,\n  disabled = false,\n}: RuleEditorProps) {\n  const [editingIndex, setEditingIndex] = useState<number | null>(null);\n  const [editForm, setEditForm] = useState<Partial<TargetingRule>>({});\n\n  // Generate unique ID\n  const generateId = useCallback(() => {\n    return `rule_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n  }, []);\n\n  // Add new rule\n  const handleAdd = useCallback(() => {\n    const newRule: TargetingRule = {\n      id: generateId(),\n      name: `Rule ${rules.length + 1}`,\n      priority: rules.length,\n      conditions: [],\n      enabled: isBoolean ? true : undefined,\n      variant: !isBoolean && variants.length > 0 ? variants[0].id : undefined,\n      description: \"\",\n    };\n    onChange([...rules, newRule]);\n    setEditingIndex(rules.length);\n    setEditForm(newRule);\n  }, [rules, isBoolean, variants, onChange, generateId]);\n\n  // Remove rule\n  const handleRemove = useCallback(\n    (index: number) => {\n      const newRules = [...rules];\n      newRules.splice(index, 1);\n      // Re-index priorities\n      newRules.forEach((r, i) => (r.priority = i));\n      onChange(newRules);\n      if (editingIndex === index) {\n        setEditingIndex(null);\n        setEditForm({});\n      }\n    },\n    [rules, editingIndex, onChange],\n  );\n\n  // Start editing\n  const handleEdit = useCallback(\n    (index: number) => {\n      setEditingIndex(index);\n      setEditForm({ ...rules[index] });\n    },\n    [rules],\n  );\n\n  // Save rule\n  const handleSave = useCallback(() => {\n    if (editingIndex === null) return;\n\n    const newRules = [...rules];\n    newRules[editingIndex] = {\n      ...newRules[editingIndex],\n      ...editForm,\n      priority: editingIndex,\n    } as TargetingRule;\n    onChange(newRules);\n    setEditingIndex(null);\n    setEditForm({});\n  }, [editingIndex, editForm, rules, onChange]);\n\n  // Cancel editing\n  const handleCancel = useCallback(() => {\n    // If this is a new rule (no conditions), remove it\n    if (\n      editingIndex !== null &&\n      rules[editingIndex]?.conditions?.length === 0\n    ) {\n      handleRemove(editingIndex);\n    }\n    setEditingIndex(null);\n    setEditForm({});\n  }, [editingIndex, rules, handleRemove]);\n\n  // Move rule up/down\n  const handleMove = useCallback(\n    (index: number, direction: \"up\" | \"down\") => {\n      const newIndex = direction === \"up\" ? index - 1 : index + 1;\n      if (newIndex < 0 || newIndex >= rules.length) return;\n\n      const newRules = [...rules];\n      [newRules[index], newRules[newIndex]] = [\n        newRules[newIndex],\n        newRules[index],\n      ];\n      // Re-index priorities\n      newRules.forEach((r, i) => (r.priority = i));\n      onChange(newRules);\n    },\n    [rules, onChange],\n  );\n\n  // Add condition to current rule\n  const handleAddCondition = useCallback(() => {\n    const newCondition: TargetingCondition = {\n      attribute: \"user_role\",\n      operator: \"equals\",\n      value: \"\",\n    };\n    setEditForm({\n      ...editForm,\n      conditions: [...(editForm.conditions || []), newCondition],\n    });\n  }, [editForm]);\n\n  // Update condition\n  const handleUpdateCondition = useCallback(\n    (condIndex: number, updates: Partial<TargetingCondition>) => {\n      const conditions = [...(editForm.conditions || [])];\n      conditions[condIndex] = { ...conditions[condIndex], ...updates };\n      setEditForm({ ...editForm, conditions });\n    },\n    [editForm],\n  );\n\n  // Remove condition\n  const handleRemoveCondition = useCallback(\n    (condIndex: number) => {\n      const conditions = [...(editForm.conditions || [])];\n      conditions.splice(condIndex, 1);\n      setEditForm({ ...editForm, conditions });\n    },\n    [editForm],\n  );\n\n  return (\n    <div className=\"space-y-4\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h4 className=\"text-sm font-medium text-slate-200\">\n            Targeting Rules\n          </h4>\n          <p className=\"text-xs text-slate-500 mt-0.5\">\n            Rules are evaluated in order. First matching rule wins.\n          </p>\n        </div>\n      </div>\n\n      {/* Rules List */}\n      <div className=\"space-y-3\">\n        {rules.map((rule, index) => (\n          <div\n            key={rule.id}\n            className={`bg-slate-800/50 border rounded-lg ${\n              editingIndex === index ? \"border-blue-600\" : \"border-slate-700\"\n            }`}\n          >\n            {editingIndex === index ? (\n              // Edit Mode\n              <div className=\"p-4 space-y-4\">\n                {/* Rule Header */}\n                <div className=\"grid grid-cols-2 gap-3\">\n                  <div>\n                    <label className=\"block text-xs text-slate-400 mb-1\">\n                      Rule Name\n                    </label>\n                    <input\n                      type=\"text\"\n                      value={editForm.name || \"\"}\n                      onChange={(e) =>\n                        setEditForm({ ...editForm, name: e.target.value })\n                      }\n                      className=\"w-full px-2 py-1.5 text-sm bg-slate-900 border border-slate-600 rounded text-slate-200\"\n                      placeholder=\"e.g., Beta Users\"\n                    />\n                  </div>\n                  <div>\n                    <label className=\"block text-xs text-slate-400 mb-1\">\n                      {isBoolean ? \"Enabled When Matched\" : \"Serve Variant\"}\n                    </label>\n                    {isBoolean ? (\n                      <select\n                        value={editForm.enabled ? \"true\" : \"false\"}\n                        onChange={(e) =>\n                          setEditForm({\n                            ...editForm,\n                            enabled: e.target.value === \"true\",\n                          })\n                        }\n                        className=\"w-full px-2 py-1.5 text-sm bg-slate-900 border border-slate-600 rounded text-slate-200\"\n                      >\n                        <option value=\"true\">Enable Flag</option>\n                        <option value=\"false\">Disable Flag</option>\n                      </select>\n                    ) : (\n                      <select\n                        value={editForm.variant || \"\"}\n                        onChange={(e) =>\n                          setEditForm({ ...editForm, variant: e.target.value })\n                        }\n                        className=\"w-full px-2 py-1.5 text-sm bg-slate-900 border border-slate-600 rounded text-slate-200\"\n                      >\n                        {variants.map((v) => (\n                          <option key={v.id} value={v.id}>\n                            {v.name}\n                          </option>\n                        ))}\n                      </select>\n                    )}\n                  </div>\n                </div>\n\n                {/* Description */}\n                <div>\n                  <label className=\"block text-xs text-slate-400 mb-1\">\n                    Description\n                  </label>\n                  <input\n                    type=\"text\"\n                    value={editForm.description || \"\"}\n                    onChange={(e) =>\n                      setEditForm({ ...editForm, description: e.target.value })\n                    }\n                    className=\"w-full px-2 py-1.5 text-sm bg-slate-900 border border-slate-600 rounded text-slate-200\"\n                    placeholder=\"What this rule targets...\"\n                  />\n                </div>\n\n                {/* Conditions */}\n                <div className=\"space-y-2\">\n                  <div className=\"flex items-center justify-between\">\n                    <label className=\"text-xs text-slate-400\">\n                      Conditions (ALL must match)\n                    </label>\n                  </div>\n\n                  {(editForm.conditions || []).map((condition, condIndex) => (\n                    <div\n                      key={condIndex}\n                      className=\"flex items-center gap-2 bg-slate-900/50 p-2 rounded\"\n                    >\n                      {/* Attribute */}\n                      <select\n                        value={condition.attribute}\n                        onChange={(e) =>\n                          handleUpdateCondition(condIndex, {\n                            attribute: e.target.value as TargetingAttribute,\n                          })\n                        }\n                        className=\"flex-1 px-2 py-1.5 text-xs bg-slate-800 border border-slate-600 rounded text-slate-200\"\n                      >\n                        {TARGETING_ATTRIBUTES.map((attr) => (\n                          <option key={attr.value} value={attr.value}>\n                            {attr.label}\n                          </option>\n                        ))}\n                      </select>\n\n                      {/* Custom attribute key */}\n                      {condition.attribute === \"custom\" && (\n                        <input\n                          type=\"text\"\n                          value={condition.customAttributeKey || \"\"}\n                          onChange={(e) =>\n                            handleUpdateCondition(condIndex, {\n                              customAttributeKey: e.target.value,\n                            })\n                          }\n                          className=\"w-24 px-2 py-1.5 text-xs bg-slate-800 border border-slate-600 rounded text-slate-200\"\n                          placeholder=\"Key\"\n                        />\n                      )}\n\n                      {/* Operator */}\n                      <select\n                        value={condition.operator}\n                        onChange={(e) =>\n                          handleUpdateCondition(condIndex, {\n                            operator: e.target.value as TargetingOperator,\n                          })\n                        }\n                        className=\"flex-1 px-2 py-1.5 text-xs bg-slate-800 border border-slate-600 rounded text-slate-200\"\n                      >\n                        {OPERATORS.map((op) => (\n                          <option key={op.value} value={op.value}>\n                            {op.label}\n                          </option>\n                        ))}\n                      </select>\n\n                      {/* Value */}\n                      <input\n                        type=\"text\"\n                        value={\n                          Array.isArray(condition.value)\n                            ? condition.value.join(\", \")\n                            : String(condition.value)\n                        }\n                        onChange={(e) => {\n                          const val = e.target.value;\n                          // Parse as array for in/not_in operators\n                          const parsed =\n                            condition.operator === \"in\" ||\n                            condition.operator === \"not_in\"\n                              ? val.split(\",\").map((s) => s.trim())\n                              : val;\n                          handleUpdateCondition(condIndex, { value: parsed });\n                        }}\n                        className=\"flex-1 px-2 py-1.5 text-xs bg-slate-800 border border-slate-600 rounded text-slate-200\"\n                        placeholder={\n                          condition.operator === \"in\" ||\n                          condition.operator === \"not_in\"\n                            ? \"value1, value2\"\n                            : \"value\"\n                        }\n                      />\n\n                      {/* Remove */}\n                      <button\n                        type=\"button\"\n                        onClick={() => handleRemoveCondition(condIndex)}\n                        className=\"p-1 text-red-400 hover:text-red-300 hover:bg-red-900/30 rounded\"\n                      >\n                        <svg\n                          className=\"w-4 h-4\"\n                          fill=\"none\"\n                          viewBox=\"0 0 24 24\"\n                          stroke=\"currentColor\"\n                        >\n                          <path\n                            strokeLinecap=\"round\"\n                            strokeLinejoin=\"round\"\n                            strokeWidth={2}\n                            d=\"M6 18L18 6M6 6l12 12\"\n                          />\n                        </svg>\n                      </button>\n                    </div>\n                  ))}\n\n                  <button\n                    type=\"button\"\n                    onClick={handleAddCondition}\n                    className=\"text-xs text-blue-400 hover:text-blue-300\"\n                  >\n                    + Add Condition\n                  </button>\n                </div>\n\n                {/* Actions */}\n                <div className=\"flex justify-end gap-2 pt-2 border-t border-slate-700\">\n                  <button\n                    type=\"button\"\n                    onClick={handleCancel}\n                    className=\"px-3 py-1.5 text-xs text-slate-400 hover:text-slate-200\"\n                  >\n                    Cancel\n                  </button>\n                  <button\n                    type=\"button\"\n                    onClick={handleSave}\n                    disabled={(editForm.conditions || []).length === 0}\n                    className=\"px-3 py-1.5 text-xs bg-blue-600 hover:bg-blue-700 disabled:bg-slate-700 disabled:text-slate-500 text-white rounded\"\n                  >\n                    Save Rule\n                  </button>\n                </div>\n              </div>\n            ) : (\n              // View Mode\n              <div className=\"p-3\">\n                <div className=\"flex items-start justify-between\">\n                  <div className=\"flex-1\">\n                    <div className=\"flex items-center gap-2 mb-1\">\n                      <span className=\"text-xs text-slate-500\">\n                        #{index + 1}\n                      </span>\n                      <span className=\"text-sm font-medium text-slate-200\">\n                        {rule.name}\n                      </span>\n                      <span\n                        className={`text-xs px-1.5 py-0.5 rounded ${\n                          isBoolean\n                            ? rule.enabled\n                              ? \"bg-green-900/50 text-green-400\"\n                              : \"bg-red-900/50 text-red-400\"\n                            : \"bg-purple-900/50 text-purple-400\"\n                        }`}\n                      >\n                        {isBoolean\n                          ? rule.enabled\n                            ? \"Enable\"\n                            : \"Disable\"\n                          : variants.find((v) => v.id === rule.variant)?.name ||\n                            rule.variant}\n                      </span>\n                    </div>\n                    {rule.description && (\n                      <p className=\"text-xs text-slate-500 mb-2\">\n                        {rule.description}\n                      </p>\n                    )}\n                    <div className=\"flex flex-wrap gap-1\">\n                      {rule.conditions.map((cond, i) => (\n                        <span\n                          key={i}\n                          className=\"text-xs bg-slate-700/50 px-2 py-0.5 rounded text-slate-300\"\n                        >\n                          {cond.attribute}\n                          {cond.customAttributeKey\n                            ? `[${cond.customAttributeKey}]`\n                            : \"\"}{\" \"}\n                          {cond.operator}{\" \"}\n                          {Array.isArray(cond.value)\n                            ? `[${cond.value.join(\", \")}]`\n                            : String(cond.value)}\n                        </span>\n                      ))}\n                    </div>\n                  </div>\n                  {!disabled && (\n                    <div className=\"flex items-center gap-1\">\n                      {index > 0 && (\n                        <button\n                          type=\"button\"\n                          onClick={() => handleMove(index, \"up\")}\n                          className=\"p-1 text-slate-400 hover:text-slate-200\"\n                          title=\"Move up\"\n                        >\n                          <svg\n                            className=\"w-4 h-4\"\n                            fill=\"none\"\n                            viewBox=\"0 0 24 24\"\n                            stroke=\"currentColor\"\n                          >\n                            <path\n                              strokeLinecap=\"round\"\n                              strokeLinejoin=\"round\"\n                              strokeWidth={2}\n                              d=\"M5 15l7-7 7 7\"\n                            />\n                          </svg>\n                        </button>\n                      )}\n                      {index < rules.length - 1 && (\n                        <button\n                          type=\"button\"\n                          onClick={() => handleMove(index, \"down\")}\n                          className=\"p-1 text-slate-400 hover:text-slate-200\"\n                          title=\"Move down\"\n                        >\n                          <svg\n                            className=\"w-4 h-4\"\n                            fill=\"none\"\n                            viewBox=\"0 0 24 24\"\n                            stroke=\"currentColor\"\n                          >\n                            <path\n                              strokeLinecap=\"round\"\n                              strokeLinejoin=\"round\"\n                              strokeWidth={2}\n                              d=\"M19 9l-7 7-7-7\"\n                            />\n                          </svg>\n                        </button>\n                      )}\n                      <button\n                        type=\"button\"\n                        onClick={() => handleEdit(index)}\n                        className=\"px-2 py-1 text-xs text-slate-400 hover:text-slate-200 hover:bg-slate-700 rounded\"\n                      >\n                        Edit\n                      </button>\n                      <button\n                        type=\"button\"\n                        onClick={() => handleRemove(index)}\n                        className=\"px-2 py-1 text-xs text-red-400 hover:text-red-300 hover:bg-red-900/30 rounded\"\n                      >\n                        Remove\n                      </button>\n                    </div>\n                  )}\n                </div>\n              </div>\n            )}\n          </div>\n        ))}\n      </div>\n\n      {/* Add Rule Button */}\n      {!disabled && editingIndex === null && (\n        <button\n          type=\"button\"\n          onClick={handleAdd}\n          className=\"w-full py-2 text-xs font-medium text-slate-400 hover:text-white bg-slate-800/50 hover:bg-slate-700/50 border border-dashed border-slate-600 hover:border-slate-500 rounded-lg transition-colors\"\n        >\n          + Add Targeting Rule\n        </button>\n      )}\n\n      {/* Empty State */}\n      {rules.length === 0 && editingIndex === null && (\n        <div className=\"text-center py-4 text-slate-500 text-sm\">\n          No targeting rules. All users will receive the default value.\n        </div>\n      )}\n    </div>\n  );\n}\n\nexport default RuleEditor;\n"
}

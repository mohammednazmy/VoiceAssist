{
  "path": "apps/web-app/src/components/voice/VoiceExpandedDrawer.tsx",
  "language": "typescript",
  "size": 9719,
  "last_modified": "2025-12-01T21:42:00.735Z",
  "lines": 310,
  "content": "/**\n * VoiceExpandedDrawer Component\n *\n * An expandable drawer that slides up above the CompactVoiceBar to show\n * detailed metrics, tool calls in progress, and error information.\n *\n * Part of the two-mode panel architecture:\n * - Compact mode: CompactVoiceBar (always visible when voice mode active)\n * - Expanded mode: This drawer slides up above the compact bar\n *\n * Phase 11: VoiceAssist Voice Pipeline Sprint\n */\n\nimport type { TTToolCall } from \"../../hooks/useThinkerTalkerSession\";\nimport type { VoiceMetrics } from \"./VoiceMetricsDisplay\";\nimport { ToolCallDisplay } from \"./ToolCallDisplay\";\n\n// ============================================================================\n// Types\n// ============================================================================\n\nexport interface VoiceExpandedDrawerProps {\n  /** Whether the drawer is open */\n  isOpen: boolean;\n  /** Called when user wants to collapse the drawer */\n  onCollapse: () => void;\n  /** Voice metrics to display */\n  metrics: VoiceMetrics;\n  /** Whether connected (for metrics display) */\n  isConnected: boolean;\n  /** Current tool calls in progress */\n  toolCalls: TTToolCall[];\n  /** Error to display (if any) */\n  error: { message: string; code?: string } | null;\n  /** Called when user dismisses the error */\n  onDismissError?: () => void;\n  /** Time to first audio in ms (optional T/T metric) */\n  ttfaMs?: number | null;\n}\n\n// ============================================================================\n// Helper Components\n// ============================================================================\n\n/**\n * Compact metrics display for the drawer (simpler than full VoiceMetricsDisplay)\n */\nfunction CompactMetrics({\n  metrics,\n  ttfaMs,\n}: {\n  metrics: VoiceMetrics;\n  ttfaMs?: number | null;\n}) {\n  const formatMs = (ms: number | null): string => {\n    if (ms === null) return \"—\";\n    if (ms < 1000) return `${Math.round(ms)}ms`;\n    return `${(ms / 1000).toFixed(1)}s`;\n  };\n\n  const getLatencyColor = (ms: number | null): string => {\n    if (ms === null) return \"text-neutral-400\";\n    if (ms < 500) return \"text-green-600\";\n    if (ms < 1000) return \"text-yellow-600\";\n    return \"text-red-600\";\n  };\n\n  return (\n    <div\n      className=\"grid grid-cols-2 sm:grid-cols-4 gap-3\"\n      data-testid=\"compact-metrics\"\n    >\n      {/* Connection */}\n      <div className=\"text-center\">\n        <div className=\"text-xs text-neutral-500 mb-0.5\">Connection</div>\n        <div\n          className={`text-sm font-mono ${getLatencyColor(metrics.connectionTimeMs)}`}\n        >\n          {formatMs(metrics.connectionTimeMs)}\n        </div>\n      </div>\n\n      {/* STT Latency */}\n      <div className=\"text-center\">\n        <div className=\"text-xs text-neutral-500 mb-0.5\">STT</div>\n        <div\n          className={`text-sm font-mono ${getLatencyColor(metrics.lastSttLatencyMs)}`}\n        >\n          {formatMs(metrics.lastSttLatencyMs)}\n        </div>\n      </div>\n\n      {/* Response Latency */}\n      <div className=\"text-center\">\n        <div className=\"text-xs text-neutral-500 mb-0.5\">Total</div>\n        <div\n          className={`text-sm font-mono ${getLatencyColor(metrics.lastResponseLatencyMs)}`}\n        >\n          {formatMs(metrics.lastResponseLatencyMs)}\n        </div>\n      </div>\n\n      {/* TTFA or Session Duration */}\n      <div className=\"text-center\">\n        <div className=\"text-xs text-neutral-500 mb-0.5\">\n          {ttfaMs !== null && ttfaMs !== undefined ? \"TTFA\" : \"Session\"}\n        </div>\n        <div\n          className={`text-sm font-mono ${ttfaMs !== null && ttfaMs !== undefined ? getLatencyColor(ttfaMs) : \"text-neutral-700\"}`}\n        >\n          {ttfaMs !== null && ttfaMs !== undefined\n            ? formatMs(ttfaMs)\n            : formatDuration(metrics.sessionDurationMs)}\n        </div>\n      </div>\n    </div>\n  );\n}\n\n/**\n * Format duration for display (mm:ss)\n */\nfunction formatDuration(ms: number | null | undefined): string {\n  if (ms === null || ms === undefined) return \"—\";\n  const seconds = Math.floor(ms / 1000);\n  const minutes = Math.floor(seconds / 60);\n  const remainingSeconds = seconds % 60;\n  return `${minutes}:${remainingSeconds.toString().padStart(2, \"0\")}`;\n}\n\n/**\n * Error display section\n */\nfunction ErrorSection({\n  error,\n  onDismiss,\n}: {\n  error: { message: string; code?: string };\n  onDismiss?: () => void;\n}) {\n  return (\n    <div\n      className=\"bg-red-50 border-b border-red-200 px-4 py-3\"\n      data-testid=\"drawer-error\"\n    >\n      <div className=\"flex items-start gap-2\">\n        <svg\n          className=\"w-5 h-5 text-red-500 mt-0.5 flex-shrink-0\"\n          fill=\"currentColor\"\n          viewBox=\"0 0 20 20\"\n        >\n          <path\n            fillRule=\"evenodd\"\n            d=\"M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z\"\n            clipRule=\"evenodd\"\n          />\n        </svg>\n        <div className=\"flex-1 min-w-0\">\n          <p className=\"text-sm font-medium text-red-800\">\n            {error.code === \"mic_permission_denied\"\n              ? \"Microphone Access Denied\"\n              : \"Voice Error\"}\n          </p>\n          <p className=\"text-xs text-red-600 mt-0.5 break-words\">\n            {error.message}\n          </p>\n        </div>\n        {onDismiss && (\n          <button\n            type=\"button\"\n            onClick={onDismiss}\n            className=\"text-red-500 hover:text-red-700 p-1 flex-shrink-0\"\n            aria-label=\"Dismiss error\"\n          >\n            <svg\n              className=\"w-4 h-4\"\n              fill=\"none\"\n              viewBox=\"0 0 24 24\"\n              stroke=\"currentColor\"\n            >\n              <path\n                strokeLinecap=\"round\"\n                strokeLinejoin=\"round\"\n                strokeWidth={2}\n                d=\"M6 18L18 6M6 6l12 12\"\n              />\n            </svg>\n          </button>\n        )}\n      </div>\n    </div>\n  );\n}\n\n// ============================================================================\n// Main Component\n// ============================================================================\n\nexport function VoiceExpandedDrawer({\n  isOpen,\n  onCollapse,\n  metrics,\n  isConnected,\n  toolCalls,\n  error,\n  onDismissError,\n  ttfaMs,\n}: VoiceExpandedDrawerProps) {\n  if (!isOpen) return null;\n\n  return (\n    <div\n      className=\"mb-2 bg-white border border-neutral-200 rounded-lg shadow-lg overflow-hidden animate-slide-up\"\n      data-testid=\"voice-expanded-drawer\"\n    >\n      {/* Header */}\n      <div className=\"flex items-center justify-between px-4 py-2 bg-neutral-50 border-b\">\n        <div className=\"flex items-center gap-2\">\n          <span className=\"font-medium text-sm text-neutral-700\">\n            Voice Mode Details\n          </span>\n          {isConnected && (\n            <span className=\"inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs bg-green-100 text-green-700\">\n              <span className=\"w-1.5 h-1.5 rounded-full bg-green-500\" />\n              Connected\n            </span>\n          )}\n        </div>\n        <button\n          type=\"button\"\n          onClick={onCollapse}\n          className=\"p-1.5 text-neutral-400 hover:text-neutral-600 hover:bg-neutral-100 rounded-lg transition-colors\"\n          aria-label=\"Collapse drawer\"\n          data-testid=\"collapse-drawer-btn\"\n        >\n          <svg\n            className=\"w-4 h-4\"\n            fill=\"none\"\n            viewBox=\"0 0 24 24\"\n            stroke=\"currentColor\"\n            strokeWidth={1.5}\n          >\n            <path\n              strokeLinecap=\"round\"\n              strokeLinejoin=\"round\"\n              d=\"M19.5 8.25l-7.5 7.5-7.5-7.5\"\n            />\n          </svg>\n        </button>\n      </div>\n\n      {/* Error section (if any) */}\n      {error && <ErrorSection error={error} onDismiss={onDismissError} />}\n\n      {/* Metrics section */}\n      <div className=\"p-3 border-b\">\n        <div className=\"text-xs font-medium text-neutral-500 uppercase tracking-wide mb-2\">\n          Latency Metrics\n        </div>\n        <CompactMetrics metrics={metrics} ttfaMs={ttfaMs} />\n\n        {/* Message counts */}\n        {(metrics.userTranscriptCount || metrics.aiResponseCount) && (\n          <div className=\"mt-3 pt-2 border-t border-neutral-100 flex items-center gap-4 text-xs text-neutral-500\">\n            <span>\n              <span className=\"font-medium text-neutral-700\">\n                {metrics.userTranscriptCount || 0}\n              </span>{\" \"}\n              user messages\n            </span>\n            <span>\n              <span className=\"font-medium text-neutral-700\">\n                {metrics.aiResponseCount || 0}\n              </span>{\" \"}\n              AI responses\n            </span>\n            {metrics.reconnectCount && metrics.reconnectCount > 0 && (\n              <span className=\"text-orange-500\">\n                {metrics.reconnectCount} reconnect\n                {metrics.reconnectCount > 1 ? \"s\" : \"\"}\n              </span>\n            )}\n          </div>\n        )}\n      </div>\n\n      {/* Tool calls section */}\n      {toolCalls.length > 0 && (\n        <div className=\"p-3 max-h-48 overflow-y-auto\">\n          <ToolCallDisplay\n            toolCalls={toolCalls}\n            maxVisible={5}\n            showArguments={true}\n            showResults={true}\n          />\n        </div>\n      )}\n\n      {/* Empty state when no tool calls */}\n      {toolCalls.length === 0 && !error && (\n        <div className=\"p-4 text-center text-sm text-neutral-400\">\n          No active tool calls\n        </div>\n      )}\n    </div>\n  );\n}\n\nexport default VoiceExpandedDrawer;\n"
}

{
  "path": "apps/web-app/src/components/voice/VoiceInput.tsx",
  "language": "typescript",
  "size": 6942,
  "last_modified": "2025-11-28T23:07:09.604Z",
  "lines": 218,
  "content": "/**\n * Voice Input Component\n * Push-to-talk voice input with real-time transcription\n */\n\nimport { useState, useRef, useCallback, useEffect } from \"react\";\nimport { Button } from \"@voiceassist/ui\";\nimport { useAuth } from \"../../hooks/useAuth\";\nimport { extractErrorMessage } from \"@voiceassist/types\";\n\ninterface VoiceInputProps {\n  onTranscript: (text: string) => void;\n  disabled?: boolean;\n}\n\ntype RecordingState = \"idle\" | \"recording\" | \"processing\";\n\nexport function VoiceInput({ onTranscript, disabled }: VoiceInputProps) {\n  const [recordingState, setRecordingState] = useState<RecordingState>(\"idle\");\n  const [transcript, setTranscript] = useState(\"\");\n  const [error, setError] = useState<string | null>(null);\n\n  const mediaRecorderRef = useRef<MediaRecorder | null>(null);\n  const audioChunksRef = useRef<Blob[]>([]);\n  const { apiClient } = useAuth();\n\n  const startRecording = useCallback(async () => {\n    try {\n      setError(null);\n      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });\n\n      const mediaRecorder = new MediaRecorder(stream, {\n        mimeType: \"audio/webm;codecs=opus\",\n      });\n\n      audioChunksRef.current = [];\n\n      mediaRecorder.ondataavailable = (event) => {\n        if (event.data.size > 0) {\n          audioChunksRef.current.push(event.data);\n        }\n      };\n\n      mediaRecorder.onstop = async () => {\n        const audioBlob = new Blob(audioChunksRef.current, {\n          type: \"audio/webm\",\n        });\n        stream.getTracks().forEach((track) => track.stop());\n\n        // Send to backend for transcription\n        setRecordingState(\"processing\");\n        try {\n          const text = await apiClient.transcribeAudio(audioBlob);\n          setTranscript(text);\n          onTranscript(text);\n          setRecordingState(\"idle\");\n        } catch (err: unknown) {\n          console.error(\"Transcription failed:\", err);\n          setError(extractErrorMessage(err));\n          setRecordingState(\"idle\");\n        }\n      };\n\n      mediaRecorder.start();\n      mediaRecorderRef.current = mediaRecorder;\n      setRecordingState(\"recording\");\n    } catch (err: unknown) {\n      console.error(\"Failed to start recording:\", err);\n      setError(extractErrorMessage(err));\n      setRecordingState(\"idle\");\n    }\n  }, [apiClient, onTranscript]);\n\n  const stopRecording = useCallback(() => {\n    if (\n      mediaRecorderRef.current &&\n      mediaRecorderRef.current.state === \"recording\"\n    ) {\n      mediaRecorderRef.current.stop();\n    }\n  }, []);\n\n  // Cleanup on unmount\n  useEffect(() => {\n    return () => {\n      if (\n        mediaRecorderRef.current &&\n        mediaRecorderRef.current.state === \"recording\"\n      ) {\n        mediaRecorderRef.current.stop();\n      }\n    };\n  }, []);\n\n  const isRecording = recordingState === \"recording\";\n  const isProcessing = recordingState === \"processing\";\n\n  return (\n    <div className=\"flex flex-col space-y-3\">\n      {/* Voice Input Button */}\n      <div className=\"flex items-center space-x-3\">\n        <Button\n          type=\"button\"\n          variant={isRecording ? \"danger\" : \"primary\"}\n          size=\"lg\"\n          disabled={disabled || isProcessing}\n          onMouseDown={startRecording}\n          onMouseUp={stopRecording}\n          onTouchStart={startRecording}\n          onTouchEnd={stopRecording}\n          className=\"flex-1\"\n          aria-label={\n            isRecording ? \"Recording... Release to stop\" : \"Hold to record\"\n          }\n        >\n          {isProcessing ? (\n            <>\n              <div className=\"w-5 h-5 mr-2 rounded-full border-2 border-white border-t-transparent animate-spin\" />\n              Processing...\n            </>\n          ) : isRecording ? (\n            <>\n              <svg\n                xmlns=\"http://www.w3.org/2000/svg\"\n                fill=\"currentColor\"\n                viewBox=\"0 0 24 24\"\n                className=\"w-5 h-5 mr-2 animate-pulse\"\n              >\n                <path d=\"M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z\" />\n                <path d=\"M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z\" />\n              </svg>\n              Recording... (Release to stop)\n            </>\n          ) : (\n            <>\n              <svg\n                xmlns=\"http://www.w3.org/2000/svg\"\n                fill=\"none\"\n                viewBox=\"0 0 24 24\"\n                strokeWidth={1.5}\n                stroke=\"currentColor\"\n                className=\"w-5 h-5 mr-2\"\n              >\n                <path\n                  strokeLinecap=\"round\"\n                  strokeLinejoin=\"round\"\n                  d=\"M12 18.75a6 6 0 006-6v-1.5m-6 7.5a6 6 0 01-6-6v-1.5m6 7.5v3.75m-3.75 0h7.5M12 15.75a3 3 0 01-3-3V4.5a3 3 0 116 0v8.25a3 3 0 01-3 3z\"\n                />\n              </svg>\n              Hold to Record\n            </>\n          )}\n        </Button>\n      </div>\n\n      {/* Transcript Display */}\n      {transcript && (\n        <div className=\"p-3 bg-neutral-100 rounded-md border border-neutral-200\">\n          <p className=\"text-sm text-neutral-600 font-medium mb-1\">\n            Transcript:\n          </p>\n          <p className=\"text-sm text-neutral-900\">{transcript}</p>\n        </div>\n      )}\n\n      {/* Error Display */}\n      {error && (\n        <div className=\"p-3 bg-red-50 rounded-md border border-red-200 flex items-start space-x-2\">\n          <svg\n            xmlns=\"http://www.w3.org/2000/svg\"\n            fill=\"none\"\n            viewBox=\"0 0 24 24\"\n            strokeWidth={1.5}\n            stroke=\"currentColor\"\n            className=\"w-5 h-5 text-red-600 flex-shrink-0\"\n          >\n            <path\n              strokeLinecap=\"round\"\n              strokeLinejoin=\"round\"\n              d=\"M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z\"\n            />\n          </svg>\n          <div className=\"flex-1\">\n            <p className=\"text-sm text-red-800 font-medium\">Error</p>\n            <p className=\"text-sm text-red-600 mt-1\">{error}</p>\n          </div>\n          <button\n            type=\"button\"\n            onClick={() => setError(null)}\n            className=\"text-red-600 hover:text-red-700 focus:outline-none\"\n            aria-label=\"Dismiss error\"\n          >\n            <svg\n              xmlns=\"http://www.w3.org/2000/svg\"\n              fill=\"none\"\n              viewBox=\"0 0 24 24\"\n              strokeWidth={2}\n              stroke=\"currentColor\"\n              className=\"w-5 h-5\"\n            >\n              <path\n                strokeLinecap=\"round\"\n                strokeLinejoin=\"round\"\n                d=\"M6 18L18 6M6 6l12 12\"\n              />\n            </svg>\n          </button>\n        </div>\n      )}\n\n      {/* Instructions */}\n      <p className=\"text-xs text-neutral-500 text-center\">\n        Press and hold to record your voice. Release to send for transcription.\n      </p>\n    </div>\n  );\n}\n"
}

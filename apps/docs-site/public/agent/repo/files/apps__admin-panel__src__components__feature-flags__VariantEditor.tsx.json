{
  "path": "apps/admin-panel/src/components/feature-flags/VariantEditor.tsx",
  "language": "typescript",
  "size": 10714,
  "last_modified": "2025-12-04T12:32:40.221Z",
  "lines": 308,
  "content": "/**\n * VariantEditor Component\n * Phase 3.2: Edit multivariate flag variants for A/B testing\n *\n * Allows creating, editing, and reordering variants with weights.\n */\n\nimport { useState, useCallback } from \"react\";\nimport type { FlagVariant } from \"@voiceassist/types\";\n\ninterface VariantEditorProps {\n  /** Current list of variants */\n  variants: FlagVariant[];\n  /** Callback when variants change */\n  onChange: (variants: FlagVariant[]) => void;\n  /** Whether editing is disabled */\n  disabled?: boolean;\n}\n\n/**\n * Editor for multivariate flag variants.\n * Supports adding, editing, removing, and validating variant weights.\n */\nexport function VariantEditor({\n  variants,\n  onChange,\n  disabled = false,\n}: VariantEditorProps) {\n  const [editingIndex, setEditingIndex] = useState<number | null>(null);\n  const [editForm, setEditForm] = useState<Partial<FlagVariant>>({});\n\n  // Calculate total weight\n  const totalWeight = variants.reduce((sum, v) => sum + v.weight, 0);\n  const isWeightValid = totalWeight === 100;\n\n  // Generate unique ID for new variants\n  const generateId = useCallback(() => {\n    return `variant_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n  }, []);\n\n  // Add new variant\n  const handleAdd = useCallback(() => {\n    const remainingWeight = Math.max(0, 100 - totalWeight);\n    const newVariant: FlagVariant = {\n      id: generateId(),\n      name: `Variant ${variants.length + 1}`,\n      value: null,\n      weight: remainingWeight,\n      description: \"\",\n    };\n    onChange([...variants, newVariant]);\n  }, [variants, totalWeight, onChange, generateId]);\n\n  // Remove variant\n  const handleRemove = useCallback(\n    (index: number) => {\n      const newVariants = [...variants];\n      newVariants.splice(index, 1);\n      onChange(newVariants);\n    },\n    [variants, onChange],\n  );\n\n  // Start editing a variant\n  const handleEdit = useCallback(\n    (index: number) => {\n      setEditingIndex(index);\n      setEditForm(variants[index]);\n    },\n    [variants],\n  );\n\n  // Save edited variant\n  const handleSave = useCallback(() => {\n    if (editingIndex === null) return;\n\n    const newVariants = [...variants];\n    newVariants[editingIndex] = {\n      ...newVariants[editingIndex],\n      ...editForm,\n      weight: Number(editForm.weight) || 0,\n    };\n    onChange(newVariants);\n    setEditingIndex(null);\n    setEditForm({});\n  }, [editingIndex, editForm, variants, onChange]);\n\n  // Cancel editing\n  const handleCancel = useCallback(() => {\n    setEditingIndex(null);\n    setEditForm({});\n  }, []);\n\n  // Distribute weights evenly\n  const handleEvenDistribution = useCallback(() => {\n    if (variants.length === 0) return;\n    const evenWeight = Math.floor(100 / variants.length);\n    const remainder = 100 % variants.length;\n\n    const newVariants = variants.map((v, i) => ({\n      ...v,\n      weight: evenWeight + (i < remainder ? 1 : 0),\n    }));\n    onChange(newVariants);\n  }, [variants, onChange]);\n\n  return (\n    <div className=\"space-y-4\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h4 className=\"text-sm font-medium text-slate-200\">Variants</h4>\n          <p className=\"text-xs text-slate-500 mt-0.5\">\n            Define variants for A/B testing. Weights must total 100%.\n          </p>\n        </div>\n        <div className=\"flex items-center gap-2\">\n          <span\n            className={`text-xs px-2 py-1 rounded ${\n              isWeightValid\n                ? \"bg-green-900/50 text-green-400\"\n                : \"bg-red-900/50 text-red-400\"\n            }`}\n          >\n            Total: {totalWeight}%\n          </span>\n        </div>\n      </div>\n\n      {/* Variants List */}\n      <div className=\"space-y-2\">\n        {variants.map((variant, index) => (\n          <div\n            key={variant.id}\n            className=\"bg-slate-800/50 border border-slate-700 rounded-lg p-3\"\n          >\n            {editingIndex === index ? (\n              // Edit mode\n              <div className=\"space-y-3\">\n                <div className=\"grid grid-cols-2 gap-3\">\n                  <div>\n                    <label className=\"block text-xs text-slate-400 mb-1\">\n                      Name\n                    </label>\n                    <input\n                      type=\"text\"\n                      value={editForm.name || \"\"}\n                      onChange={(e) =>\n                        setEditForm({ ...editForm, name: e.target.value })\n                      }\n                      className=\"w-full px-2 py-1.5 text-sm bg-slate-900 border border-slate-600 rounded text-slate-200\"\n                      placeholder=\"Variant name\"\n                    />\n                  </div>\n                  <div>\n                    <label className=\"block text-xs text-slate-400 mb-1\">\n                      Weight (%)\n                    </label>\n                    <input\n                      type=\"number\"\n                      min={0}\n                      max={100}\n                      value={editForm.weight || 0}\n                      onChange={(e) =>\n                        setEditForm({\n                          ...editForm,\n                          weight: parseInt(e.target.value) || 0,\n                        })\n                      }\n                      className=\"w-full px-2 py-1.5 text-sm bg-slate-900 border border-slate-600 rounded text-slate-200\"\n                    />\n                  </div>\n                </div>\n                <div>\n                  <label className=\"block text-xs text-slate-400 mb-1\">\n                    Value (JSON)\n                  </label>\n                  <input\n                    type=\"text\"\n                    value={\n                      typeof editForm.value === \"string\"\n                        ? editForm.value\n                        : JSON.stringify(editForm.value)\n                    }\n                    onChange={(e) => {\n                      try {\n                        const parsed = JSON.parse(e.target.value);\n                        setEditForm({ ...editForm, value: parsed });\n                      } catch {\n                        setEditForm({ ...editForm, value: e.target.value });\n                      }\n                    }}\n                    className=\"w-full px-2 py-1.5 text-sm bg-slate-900 border border-slate-600 rounded text-slate-200 font-mono\"\n                    placeholder='\"control\" or {\"feature\": true}'\n                  />\n                </div>\n                <div>\n                  <label className=\"block text-xs text-slate-400 mb-1\">\n                    Description\n                  </label>\n                  <input\n                    type=\"text\"\n                    value={editForm.description || \"\"}\n                    onChange={(e) =>\n                      setEditForm({ ...editForm, description: e.target.value })\n                    }\n                    className=\"w-full px-2 py-1.5 text-sm bg-slate-900 border border-slate-600 rounded text-slate-200\"\n                    placeholder=\"What this variant tests...\"\n                  />\n                </div>\n                <div className=\"flex justify-end gap-2\">\n                  <button\n                    type=\"button\"\n                    onClick={handleCancel}\n                    className=\"px-3 py-1 text-xs text-slate-400 hover:text-slate-200\"\n                  >\n                    Cancel\n                  </button>\n                  <button\n                    type=\"button\"\n                    onClick={handleSave}\n                    className=\"px-3 py-1 text-xs bg-blue-600 hover:bg-blue-700 text-white rounded\"\n                  >\n                    Save\n                  </button>\n                </div>\n              </div>\n            ) : (\n              // View mode\n              <div className=\"flex items-center justify-between\">\n                <div className=\"flex-1\">\n                  <div className=\"flex items-center gap-3\">\n                    <span className=\"text-sm font-medium text-slate-200\">\n                      {variant.name}\n                    </span>\n                    <span className=\"text-xs bg-slate-700 px-2 py-0.5 rounded text-slate-300\">\n                      {variant.weight}%\n                    </span>\n                    <span className=\"text-xs font-mono text-slate-400\">\n                      {typeof variant.value === \"string\"\n                        ? `\"${variant.value}\"`\n                        : JSON.stringify(variant.value)}\n                    </span>\n                  </div>\n                  {variant.description && (\n                    <p className=\"text-xs text-slate-500 mt-1\">\n                      {variant.description}\n                    </p>\n                  )}\n                </div>\n                {!disabled && (\n                  <div className=\"flex items-center gap-1\">\n                    <button\n                      type=\"button\"\n                      onClick={() => handleEdit(index)}\n                      className=\"px-2 py-1 text-xs text-slate-400 hover:text-slate-200 hover:bg-slate-700 rounded\"\n                    >\n                      Edit\n                    </button>\n                    <button\n                      type=\"button\"\n                      onClick={() => handleRemove(index)}\n                      className=\"px-2 py-1 text-xs text-red-400 hover:text-red-300 hover:bg-red-900/30 rounded\"\n                    >\n                      Remove\n                    </button>\n                  </div>\n                )}\n              </div>\n            )}\n          </div>\n        ))}\n      </div>\n\n      {/* Actions */}\n      {!disabled && (\n        <div className=\"flex items-center gap-2 pt-2\">\n          <button\n            type=\"button\"\n            onClick={handleAdd}\n            className=\"px-3 py-1.5 text-xs font-medium text-slate-300 hover:text-white bg-slate-800 hover:bg-slate-700 border border-slate-600 rounded transition-colors\"\n          >\n            + Add Variant\n          </button>\n          {variants.length > 1 && (\n            <button\n              type=\"button\"\n              onClick={handleEvenDistribution}\n              className=\"px-3 py-1.5 text-xs font-medium text-slate-400 hover:text-slate-200 hover:bg-slate-800 rounded transition-colors\"\n            >\n              Distribute Evenly\n            </button>\n          )}\n        </div>\n      )}\n\n      {/* Weight Warning */}\n      {!isWeightValid && variants.length > 0 && (\n        <div className=\"bg-yellow-900/30 border border-yellow-800/50 rounded-lg p-3 text-xs text-yellow-400\">\n          Variant weights must total 100%. Current total: {totalWeight}%\n        </div>\n      )}\n    </div>\n  );\n}\n\nexport default VariantEditor;\n"
}

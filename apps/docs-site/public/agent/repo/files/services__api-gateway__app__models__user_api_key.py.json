{
  "path": "services/api-gateway/app/models/user_api_key.py",
  "language": "python",
  "size": 2194,
  "last_modified": "2025-12-04T11:26:54.627Z",
  "lines": 65,
  "content": "\"\"\"\nUser API Key model for programmatic access to VoiceAssist API.\n\"\"\"\n\nimport uuid\nfrom datetime import datetime, timezone\nfrom typing import TYPE_CHECKING\n\nif TYPE_CHECKING:\n    pass  # Future type hints\n\nfrom app.core.database import Base\nfrom sqlalchemy import Boolean, Column, DateTime, ForeignKey, String\nfrom sqlalchemy.dialects.postgresql import ARRAY, UUID\nfrom sqlalchemy.orm import relationship\n\n\nclass UserAPIKey(Base):\n    \"\"\"User-generated API keys for programmatic access to VoiceAssist API.\"\"\"\n\n    __tablename__ = \"user_api_keys\"\n\n    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)\n    user_id = Column(\n        UUID(as_uuid=True),\n        ForeignKey(\"users.id\", ondelete=\"CASCADE\"),\n        nullable=False,\n        index=True,\n    )\n    key_prefix = Column(String(12), nullable=False, index=True)  # \"va_k_xxxx\" for display\n    key_hash = Column(String(255), nullable=False)  # bcrypt hash\n    name = Column(String(255), nullable=False)\n    scopes = Column(ARRAY(String), nullable=True)  # Future: fine-grained permissions\n    last_used_at = Column(DateTime(timezone=True), nullable=True)\n    last_used_ip = Column(String(45), nullable=True)\n    is_revoked = Column(Boolean, default=False, nullable=False)\n    revoked_at = Column(DateTime(timezone=True), nullable=True)\n    expires_at = Column(DateTime(timezone=True), nullable=True)\n    created_at = Column(\n        DateTime(timezone=True),\n        default=lambda: datetime.now(timezone.utc),\n        nullable=False,\n    )\n    updated_at = Column(\n        DateTime(timezone=True),\n        default=lambda: datetime.now(timezone.utc),\n        onupdate=lambda: datetime.now(timezone.utc),\n        nullable=False,\n    )\n\n    # Relationship\n    user = relationship(\"User\", back_populates=\"api_keys\")\n\n    def __repr__(self):\n        return f\"<UserAPIKey(id={self.id}, name={self.name}, prefix={self.key_prefix})>\"\n\n    @property\n    def is_valid(self) -> bool:\n        \"\"\"Check if the key is valid (not revoked and not expired).\"\"\"\n        if self.is_revoked:\n            return False\n        if self.expires_at and datetime.now(timezone.utc) > self.expires_at:\n            return False\n        return True\n"
}

{
  "path": "apps/admin-panel/src/components/integrations/SystemKeyManager.tsx",
  "language": "typescript",
  "size": 13589,
  "last_modified": "2025-11-29T04:23:34.455Z",
  "lines": 429,
  "content": "/**\n * SystemKeyManager Component\n * Allows admins to view, update, and validate external service API keys\n * (OpenAI, ElevenLabs, PubMed, etc.)\n */\n\nimport { useState } from \"react\";\nimport {\n  useSystemKeys,\n  SystemKeyInfo,\n  KeyValidationResult,\n} from \"../../hooks/useSystemKeys\";\nimport { useAuth } from \"../../contexts/AuthContext\";\n\n// Friendly names and icons for integrations\nconst INTEGRATION_META: Record<\n  string,\n  { name: string; icon: string; description: string }\n> = {\n  openai: {\n    name: \"OpenAI\",\n    icon: \"ðŸ¤–\",\n    description: \"GPT models and embeddings\",\n  },\n  google_ai: {\n    name: \"Google AI Studio\",\n    icon: \"ðŸ”®\",\n    description: \"Gemini models\",\n  },\n  deepseek: {\n    name: \"DeepSeek\",\n    icon: \"ðŸ”¬\",\n    description: \"DeepSeek chat models\",\n  },\n  local_llm: {\n    name: \"Local LLM\",\n    icon: \"ðŸ’»\",\n    description: \"Self-hosted models\",\n  },\n  elevenlabs: { name: \"ElevenLabs\", icon: \"ðŸ”Š\", description: \"Text-to-speech\" },\n  deepgram: { name: \"Deepgram\", icon: \"ðŸŽ¤\", description: \"Speech-to-text\" },\n  openevidence: {\n    name: \"OpenEvidence\",\n    icon: \"ðŸ“š\",\n    description: \"Medical evidence API\",\n  },\n  pubmed: { name: \"PubMed\", icon: \"ðŸ¥\", description: \"Medical literature\" },\n  google_oauth: {\n    name: \"Google OAuth\",\n    icon: \"ðŸ”\",\n    description: \"Google sign-in\",\n  },\n  microsoft_oauth: {\n    name: \"Microsoft OAuth\",\n    icon: \"ðŸ”\",\n    description: \"Microsoft sign-in\",\n  },\n  sentry: { name: \"Sentry\", icon: \"ðŸ“Š\", description: \"Error monitoring\" },\n};\n\nfunction getIntegrationMeta(integrationId: string) {\n  return (\n    INTEGRATION_META[integrationId] || {\n      name: integrationId\n        .replace(/_/g, \" \")\n        .replace(/\\b\\w/g, (c) => c.toUpperCase()),\n      icon: \"ðŸ”—\",\n      description: \"External service\",\n    }\n  );\n}\n\ninterface KeyCardProps {\n  keyInfo: SystemKeyInfo;\n  onUpdate: (value: string) => Promise<void>;\n  onClear: () => Promise<void>;\n  onValidate: () => Promise<KeyValidationResult>;\n  isAdmin: boolean;\n}\n\nfunction KeyCard({\n  keyInfo,\n  onUpdate,\n  onClear,\n  onValidate,\n  isAdmin,\n}: KeyCardProps) {\n  const [editing, setEditing] = useState(false);\n  const [newValue, setNewValue] = useState(\"\");\n  const [saving, setSaving] = useState(false);\n  const [validating, setValidating] = useState(false);\n  const [validationResult, setValidationResult] =\n    useState<KeyValidationResult | null>(null);\n  const [error, setError] = useState<string | null>(null);\n\n  const meta = getIntegrationMeta(keyInfo.integration_id);\n\n  const handleSave = async () => {\n    if (!newValue.trim()) return;\n    setSaving(true);\n    setError(null);\n    try {\n      await onUpdate(newValue.trim());\n      setEditing(false);\n      setNewValue(\"\");\n    } catch (err) {\n      setError(err instanceof Error ? err.message : \"Failed to save\");\n    } finally {\n      setSaving(false);\n    }\n  };\n\n  const handleClear = async () => {\n    if (\n      !confirm(\n        `Clear the database override for ${meta.name}? This will revert to the .env value.`,\n      )\n    ) {\n      return;\n    }\n    setSaving(true);\n    setError(null);\n    try {\n      await onClear();\n    } catch (err) {\n      setError(err instanceof Error ? err.message : \"Failed to clear\");\n    } finally {\n      setSaving(false);\n    }\n  };\n\n  const handleValidate = async () => {\n    setValidating(true);\n    setValidationResult(null);\n    try {\n      const result = await onValidate();\n      setValidationResult(result);\n    } catch (err) {\n      setValidationResult({\n        success: false,\n        message: err instanceof Error ? err.message : \"Validation failed\",\n        latency_ms: 0,\n      });\n    } finally {\n      setValidating(false);\n    }\n  };\n\n  const getStatusColor = () => {\n    if (!keyInfo.is_configured) return \"border-slate-700 bg-slate-900/30\";\n    if (keyInfo.validation_status === \"valid\")\n      return \"border-green-800/50 bg-green-900/20\";\n    if (keyInfo.validation_status === \"invalid\")\n      return \"border-red-800/50 bg-red-900/20\";\n    return \"border-slate-700 bg-slate-900/50\";\n  };\n\n  const getSourceBadge = () => {\n    if (keyInfo.source === \"database\") {\n      return (\n        <span className=\"inline-flex items-center px-2 py-0.5 rounded text-[10px] font-medium bg-blue-900/50 text-blue-400 border border-blue-800\">\n          DB Override\n        </span>\n      );\n    }\n    if (keyInfo.source === \"environment\") {\n      return (\n        <span className=\"inline-flex items-center px-2 py-0.5 rounded text-[10px] font-medium bg-slate-800 text-slate-400 border border-slate-700\">\n          .env\n        </span>\n      );\n    }\n    return (\n      <span className=\"inline-flex items-center px-2 py-0.5 rounded text-[10px] font-medium bg-yellow-900/50 text-yellow-400 border border-yellow-800\">\n        Not Set\n      </span>\n    );\n  };\n\n  return (\n    <div className={`rounded-lg border p-4 ${getStatusColor()}`}>\n      <div className=\"flex items-start justify-between gap-3\">\n        <div className=\"flex items-start gap-3 flex-1 min-w-0\">\n          <span className=\"text-2xl\">{meta.icon}</span>\n          <div className=\"flex-1 min-w-0\">\n            <div className=\"flex items-center gap-2\">\n              <h3 className=\"text-sm font-medium text-slate-100 truncate\">\n                {meta.name}\n              </h3>\n              {getSourceBadge()}\n              {keyInfo.validation_status === \"valid\" && (\n                <span className=\"text-green-400 text-xs\">âœ“</span>\n              )}\n              {keyInfo.validation_status === \"invalid\" && (\n                <span className=\"text-red-400 text-xs\">âœ—</span>\n              )}\n            </div>\n            <p className=\"text-xs text-slate-500 mt-0.5\">{meta.description}</p>\n            {keyInfo.masked_value && (\n              <p className=\"text-xs font-mono text-slate-400 mt-1 truncate\">\n                {keyInfo.masked_value}\n              </p>\n            )}\n          </div>\n        </div>\n      </div>\n\n      {/* Validation Result */}\n      {validationResult && (\n        <div\n          className={`mt-3 p-2 rounded text-xs ${\n            validationResult.success\n              ? \"bg-green-900/30 text-green-400 border border-green-800/50\"\n              : \"bg-red-900/30 text-red-400 border border-red-800/50\"\n          }`}\n        >\n          {validationResult.message}\n          {validationResult.latency_ms > 0 && (\n            <span className=\"opacity-75 ml-2\">\n              ({validationResult.latency_ms.toFixed(0)}ms)\n            </span>\n          )}\n        </div>\n      )}\n\n      {/* Error */}\n      {error && (\n        <div className=\"mt-3 p-2 rounded text-xs bg-red-900/30 text-red-400 border border-red-800/50\">\n          {error}\n        </div>\n      )}\n\n      {/* Edit Form */}\n      {editing && (\n        <div className=\"mt-3 space-y-2\">\n          <input\n            type=\"password\"\n            value={newValue}\n            onChange={(e) => setNewValue(e.target.value)}\n            placeholder=\"Enter new API key...\"\n            className=\"w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded text-sm text-slate-200 placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500\"\n            autoFocus\n          />\n          <div className=\"flex gap-2\">\n            <button\n              onClick={handleSave}\n              disabled={saving || !newValue.trim()}\n              className=\"flex-1 px-3 py-1.5 text-xs bg-blue-900/50 hover:bg-blue-800/50 text-blue-400 border border-blue-800 rounded transition-colors disabled:opacity-50\"\n            >\n              {saving ? \"Saving...\" : \"Save\"}\n            </button>\n            <button\n              onClick={() => {\n                setEditing(false);\n                setNewValue(\"\");\n                setError(null);\n              }}\n              className=\"px-3 py-1.5 text-xs bg-slate-800 hover:bg-slate-700 text-slate-400 rounded transition-colors\"\n            >\n              Cancel\n            </button>\n          </div>\n        </div>\n      )}\n\n      {/* Actions */}\n      {!editing && isAdmin && (\n        <div className=\"flex gap-2 mt-3\">\n          <button\n            onClick={() => setEditing(true)}\n            className=\"px-2 py-1 text-xs bg-slate-800 hover:bg-slate-700 text-slate-300 rounded transition-colors\"\n          >\n            {keyInfo.is_configured ? \"Update\" : \"Set Key\"}\n          </button>\n          {keyInfo.is_configured && (\n            <button\n              onClick={handleValidate}\n              disabled={validating}\n              className=\"px-2 py-1 text-xs bg-blue-900/50 hover:bg-blue-800/50 text-blue-400 border border-blue-800 rounded transition-colors disabled:opacity-50\"\n            >\n              {validating ? \"Testing...\" : \"Test\"}\n            </button>\n          )}\n          {keyInfo.is_override && (\n            <button\n              onClick={handleClear}\n              disabled={saving}\n              className=\"px-2 py-1 text-xs bg-red-900/50 hover:bg-red-800/50 text-red-400 border border-red-800 rounded transition-colors disabled:opacity-50\"\n            >\n              Clear Override\n            </button>\n          )}\n        </div>\n      )}\n\n      {/* Last validated */}\n      {keyInfo.last_validated_at && (\n        <p className=\"text-[10px] text-slate-600 mt-2\">\n          Last tested: {new Date(keyInfo.last_validated_at).toLocaleString()}\n        </p>\n      )}\n    </div>\n  );\n}\n\nexport function SystemKeyManager() {\n  const { isAdmin } = useAuth();\n  const {\n    keys,\n    summary,\n    loading,\n    error,\n    lastUpdated,\n    refreshKeys,\n    updateKey,\n    clearOverride,\n    validateKey,\n  } = useSystemKeys({ autoRefresh: true, refreshIntervalMs: 60000 });\n\n  if (loading && keys.length === 0) {\n    return (\n      <div className=\"bg-slate-900/50 border border-slate-800 rounded-lg\">\n        <div className=\"px-4 py-3 border-b border-slate-800\">\n          <h2 className=\"text-sm font-medium text-slate-200\">\n            System API Keys\n          </h2>\n          <p className=\"text-xs text-slate-500 mt-1\">Loading...</p>\n        </div>\n        <div className=\"p-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n          {Array.from({ length: 6 }).map((_, idx) => (\n            <div\n              key={idx}\n              className=\"bg-slate-900/30 border border-slate-800 rounded-lg p-4 animate-pulse\"\n            >\n              <div className=\"flex gap-3\">\n                <div className=\"h-8 w-8 bg-slate-800 rounded\" />\n                <div className=\"flex-1\">\n                  <div className=\"h-4 w-24 bg-slate-800 rounded\" />\n                  <div className=\"h-3 w-32 bg-slate-800 rounded mt-2\" />\n                </div>\n              </div>\n            </div>\n          ))}\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"bg-slate-900/50 border border-slate-800 rounded-lg\">\n      <div className=\"px-4 py-3 border-b border-slate-800 flex items-center justify-between\">\n        <div>\n          <h2 className=\"text-sm font-medium text-slate-200\">\n            System API Keys\n          </h2>\n          <p className=\"text-xs text-slate-500 mt-1\">\n            Manage external service credentials\n            {summary && ` (${summary.configured}/${summary.total} configured)`}\n          </p>\n        </div>\n        <button\n          onClick={() => refreshKeys()}\n          disabled={loading}\n          className=\"px-2 py-1 text-xs bg-slate-800 hover:bg-slate-700 text-slate-300 rounded transition-colors disabled:opacity-50\"\n        >\n          {loading ? \"Refreshing...\" : \"Refresh\"}\n        </button>\n      </div>\n\n      {error && (\n        <div className=\"px-4 py-3 bg-red-900/20 border-b border-red-800 text-red-400 text-sm\">\n          {error}\n        </div>\n      )}\n\n      {/* Summary Cards */}\n      {summary && (\n        <div className=\"px-4 py-3 border-b border-slate-800 grid grid-cols-2 md:grid-cols-4 gap-3\">\n          <div className=\"text-center\">\n            <div className=\"text-lg font-bold text-slate-100\">\n              {summary.total}\n            </div>\n            <div className=\"text-xs text-slate-500\">Total</div>\n          </div>\n          <div className=\"text-center\">\n            <div className=\"text-lg font-bold text-green-400\">\n              {summary.configured}\n            </div>\n            <div className=\"text-xs text-slate-500\">Configured</div>\n          </div>\n          <div className=\"text-center\">\n            <div className=\"text-lg font-bold text-blue-400\">\n              {summary.from_db}\n            </div>\n            <div className=\"text-xs text-slate-500\">DB Overrides</div>\n          </div>\n          <div className=\"text-center\">\n            <div className=\"text-lg font-bold text-yellow-400\">\n              {summary.not_configured}\n            </div>\n            <div className=\"text-xs text-slate-500\">Not Set</div>\n          </div>\n        </div>\n      )}\n\n      {/* Key Grid */}\n      <div className=\"p-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n        {keys.map((keyInfo) => (\n          <KeyCard\n            key={keyInfo.integration_id}\n            keyInfo={keyInfo}\n            onUpdate={(value) => updateKey(keyInfo.integration_id, value)}\n            onClear={() => clearOverride(keyInfo.integration_id)}\n            onValidate={() => validateKey(keyInfo.integration_id)}\n            isAdmin={isAdmin}\n          />\n        ))}\n      </div>\n\n      {/* Last Updated */}\n      {lastUpdated && (\n        <div className=\"px-4 py-2 border-t border-slate-800 text-xs text-slate-600 text-center\">\n          Last updated: {lastUpdated.toLocaleTimeString()}\n        </div>\n      )}\n    </div>\n  );\n}\n"
}

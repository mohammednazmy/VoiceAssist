{
  "path": "services/api-gateway/app/models/user.py",
  "language": "python",
  "size": 2870,
  "last_modified": "2025-12-05T03:07:13.131Z",
  "lines": 67,
  "content": "\"\"\"\nUser model\n\"\"\"\n\nimport uuid\nfrom datetime import datetime, timezone\n\nfrom app.core.database import Base\nfrom sqlalchemy import Boolean, Column, DateTime, ForeignKey, String\nfrom sqlalchemy.dialects.postgresql import UUID\nfrom sqlalchemy.orm import relationship\n\n\nclass User(Base):\n    \"\"\"User model for authentication and user management\"\"\"\n\n    __tablename__ = \"users\"\n\n    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)\n    email = Column(String(255), unique=True, nullable=False, index=True)\n    full_name = Column(String(255), nullable=False)\n    hashed_password = Column(String(255), nullable=True)  # Null for SSO users\n    is_active = Column(Boolean, default=True, nullable=False)\n    is_admin = Column(Boolean, default=False, nullable=False)\n    admin_role = Column(String(50), default=\"user\", nullable=False)\n    password_changed_at = Column(\n        DateTime(timezone=True),\n        default=lambda: datetime.now(timezone.utc),\n        nullable=False,\n    )\n\n    # Nextcloud integration\n    nextcloud_user_id = Column(String(255), unique=True, nullable=True, index=True)\n\n    # OAuth provider info (for SSO users)\n    oauth_provider = Column(String(50), nullable=True, index=True)  # \"google\" or \"microsoft\"\n    oauth_provider_id = Column(String(255), nullable=True, index=True)  # Provider's user ID\n\n    # Two-Factor Authentication (2FA)\n    totp_secret = Column(String(255), nullable=True)  # Encrypted TOTP secret\n    totp_enabled = Column(Boolean, default=False, nullable=False)\n    totp_backup_codes = Column(String(1024), nullable=True)  # Encrypted comma-separated backup codes\n    totp_verified_at = Column(DateTime(timezone=True), nullable=True)\n\n    # Invitation tokens (for new user invitations)\n    invitation_token = Column(String(255), unique=True, nullable=True, index=True)\n    invitation_token_expires_at = Column(DateTime(timezone=True), nullable=True)\n    invitation_sent_at = Column(DateTime(timezone=True), nullable=True)\n    invited_by_id = Column(UUID(as_uuid=True), ForeignKey(\"users.id\"), nullable=True)\n\n    # Password reset tokens\n    password_reset_token = Column(String(255), unique=True, nullable=True, index=True)\n    password_reset_token_expires_at = Column(DateTime(timezone=True), nullable=True)\n    must_change_password = Column(Boolean, default=False, nullable=False)\n\n    # Timestamps\n    created_at = Column(DateTime, default=datetime.utcnow, nullable=False)\n    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow, nullable=False)\n    last_login = Column(DateTime, nullable=True)\n\n    # Relationships\n    api_keys = relationship(\"UserAPIKey\", back_populates=\"user\", cascade=\"all, delete-orphan\")\n    invited_by = relationship(\"User\", remote_side=[id], foreign_keys=[invited_by_id])\n\n    def __repr__(self):\n        return f\"<User(id={self.id}, email={self.email})>\"\n"
}

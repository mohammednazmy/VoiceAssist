{
  "path": "apps/admin-panel/src/components/session/SessionTimeoutWarning.tsx",
  "language": "typescript",
  "size": 7240,
  "last_modified": "2025-11-29T04:23:35.175Z",
  "lines": 233,
  "content": "/**\n * Session Timeout Warning Component\n *\n * Shows a warning modal when the user's session is about to expire due to:\n * - Inactivity timeout (60 minutes of no activity)\n * - Absolute timeout (24 hours since login)\n *\n * Allows the user to extend their session by clicking a button.\n */\n\nimport { useEffect, useState, useCallback, useRef } from \"react\";\nimport { getApiClient } from \"../../lib/apiClient\";\nimport { useAuth } from \"../../contexts/AuthContext\";\n\ninterface SessionInfo {\n  absolute_timeout_hours: number;\n  inactivity_timeout_minutes: number;\n  absolute_remaining_seconds: number;\n  inactivity_remaining_seconds: number;\n  session_started_at: string;\n  last_activity_at: string | null;\n}\n\n// Warning thresholds in seconds\nconst WARNING_THRESHOLD_SECONDS = 5 * 60; // Show warning 5 minutes before expiry\nconst POLL_INTERVAL_MS = 60 * 1000; // Poll every 60 seconds\nconst URGENT_POLL_INTERVAL_MS = 10 * 1000; // Poll every 10 seconds when warning is shown\n\nexport function SessionTimeoutWarning() {\n  const { isAuthenticated, logout } = useAuth();\n  const [sessionInfo, setSessionInfo] = useState<SessionInfo | null>(null);\n  const [showWarning, setShowWarning] = useState(false);\n  const [extending, setExtending] = useState(false);\n  const [timeRemaining, setTimeRemaining] = useState<number | null>(null);\n  const pollIntervalRef = useRef<number | null>(null);\n  const countdownRef = useRef<number | null>(null);\n\n  const apiClient = getApiClient();\n\n  const fetchSessionInfo = useCallback(async () => {\n    if (!isAuthenticated) return;\n\n    try {\n      const info = await apiClient.getSessionInfo();\n      setSessionInfo(info);\n\n      // Calculate the minimum remaining time\n      const minRemaining = Math.min(\n        info.absolute_remaining_seconds,\n        info.inactivity_remaining_seconds,\n      );\n\n      setTimeRemaining(minRemaining);\n\n      // Show warning if less than threshold\n      if (minRemaining <= WARNING_THRESHOLD_SECONDS && minRemaining > 0) {\n        setShowWarning(true);\n      } else {\n        setShowWarning(false);\n      }\n\n      // Session expired\n      if (minRemaining <= 0) {\n        logout();\n      }\n    } catch (error) {\n      // Silently ignore errors - user may have been logged out\n      console.warn(\"Failed to fetch session info:\", error);\n    }\n  }, [isAuthenticated, apiClient, logout]);\n\n  // Start polling when authenticated\n  useEffect(() => {\n    if (!isAuthenticated) {\n      setShowWarning(false);\n      setSessionInfo(null);\n      return;\n    }\n\n    // Initial fetch\n    fetchSessionInfo();\n\n    // Set up polling interval\n    const interval = showWarning ? URGENT_POLL_INTERVAL_MS : POLL_INTERVAL_MS;\n    pollIntervalRef.current = window.setInterval(fetchSessionInfo, interval);\n\n    return () => {\n      if (pollIntervalRef.current) {\n        window.clearInterval(pollIntervalRef.current);\n      }\n    };\n  }, [isAuthenticated, fetchSessionInfo, showWarning]);\n\n  // Countdown timer when warning is shown\n  useEffect(() => {\n    if (!showWarning || timeRemaining === null) {\n      if (countdownRef.current) {\n        window.clearInterval(countdownRef.current);\n      }\n      return;\n    }\n\n    countdownRef.current = window.setInterval(() => {\n      setTimeRemaining((prev) => {\n        if (prev === null || prev <= 0) {\n          logout();\n          return 0;\n        }\n        return prev - 1;\n      });\n    }, 1000);\n\n    return () => {\n      if (countdownRef.current) {\n        window.clearInterval(countdownRef.current);\n      }\n    };\n  }, [showWarning, logout]);\n\n  const handleExtendSession = async () => {\n    setExtending(true);\n    try {\n      // Calling getSessionInfo records activity on the backend\n      await fetchSessionInfo();\n      setShowWarning(false);\n    } catch (error) {\n      console.error(\"Failed to extend session:\", error);\n    } finally {\n      setExtending(false);\n    }\n  };\n\n  const formatTimeRemaining = (seconds: number): string => {\n    if (seconds <= 0) return \"0:00\";\n    const mins = Math.floor(seconds / 60);\n    const secs = seconds % 60;\n    return `${mins}:${secs.toString().padStart(2, \"0\")}`;\n  };\n\n  const getTimeoutType = (): string => {\n    if (!sessionInfo) return \"session\";\n    if (\n      sessionInfo.inactivity_remaining_seconds <\n      sessionInfo.absolute_remaining_seconds\n    ) {\n      return \"inactivity\";\n    }\n    return \"session\";\n  };\n\n  if (!showWarning || !isAuthenticated) {\n    return null;\n  }\n\n  return (\n    <>\n      {/* Backdrop */}\n      <div className=\"fixed inset-0 bg-black/50 z-50\" aria-hidden=\"true\" />\n\n      {/* Modal */}\n      <div\n        className=\"fixed inset-0 z-50 flex items-center justify-center p-4\"\n        role=\"dialog\"\n        aria-modal=\"true\"\n        aria-labelledby=\"session-timeout-title\"\n      >\n        <div className=\"bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full p-6\">\n          {/* Warning Icon */}\n          <div className=\"flex justify-center mb-4\">\n            <div className=\"w-16 h-16 rounded-full bg-amber-100 dark:bg-amber-900/30 flex items-center justify-center\">\n              <svg\n                className=\"w-8 h-8 text-amber-600 dark:text-amber-400\"\n                fill=\"none\"\n                viewBox=\"0 0 24 24\"\n                stroke=\"currentColor\"\n              >\n                <path\n                  strokeLinecap=\"round\"\n                  strokeLinejoin=\"round\"\n                  strokeWidth={2}\n                  d=\"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z\"\n                />\n              </svg>\n            </div>\n          </div>\n\n          {/* Title */}\n          <h2\n            id=\"session-timeout-title\"\n            className=\"text-xl font-semibold text-gray-900 dark:text-white text-center mb-2\"\n          >\n            Session Expiring Soon\n          </h2>\n\n          {/* Description */}\n          <p className=\"text-gray-600 dark:text-gray-300 text-center mb-4\">\n            {getTimeoutType() === \"inactivity\"\n              ? \"Your session will expire due to inactivity.\"\n              : \"Your session will expire.\"}\n          </p>\n\n          {/* Countdown */}\n          <div className=\"text-center mb-6\">\n            <div className=\"text-4xl font-mono font-bold text-amber-600 dark:text-amber-400\">\n              {formatTimeRemaining(timeRemaining ?? 0)}\n            </div>\n            <p className=\"text-sm text-gray-500 dark:text-gray-400 mt-1\">\n              remaining\n            </p>\n          </div>\n\n          {/* Actions */}\n          <div className=\"flex flex-col sm:flex-row gap-3\">\n            <button\n              onClick={handleExtendSession}\n              disabled={extending}\n              className=\"flex-1 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed font-medium transition-colors\"\n            >\n              {extending ? \"Extending...\" : \"Stay Logged In\"}\n            </button>\n            <button\n              onClick={logout}\n              className=\"flex-1 px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-md hover:bg-gray-300 dark:hover:bg-gray-600 font-medium transition-colors\"\n            >\n              Log Out\n            </button>\n          </div>\n        </div>\n      </div>\n    </>\n  );\n}\n"
}

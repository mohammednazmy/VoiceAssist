{
  "path": "apps/web-app/src/components/chat/MessageInput.tsx",
  "language": "typescript",
  "size": 14831,
  "last_modified": "2025-12-01T04:54:48.782Z",
  "lines": 409,
  "content": "/**\n * MessageInput Component\n * Markdown-aware message input with auto-expanding textarea and voice input\n */\n\nimport { useState, useRef, useEffect, KeyboardEvent } from \"react\";\nimport { VoiceInput } from \"../voice/VoiceInput\";\nimport { ThinkerTalkerVoicePanel } from \"../voice/ThinkerTalkerVoicePanel\";\nimport { ChatAttachmentUpload, type PendingFile } from \"./ChatAttachmentUpload\";\nimport { useVoiceSettingsStore } from \"../../stores/voiceSettingsStore\";\nimport type { TTVoiceMetrics } from \"../../hooks/useThinkerTalkerSession\";\n\nexport interface MessageInputProps {\n  onSend: (content: string, files?: File[]) => void;\n  disabled?: boolean;\n  placeholder?: string;\n  enableAttachments?: boolean;\n  enableVoiceInput?: boolean;\n  enableRealtimeVoice?: boolean;\n  /** Auto-open the realtime voice panel when component mounts (e.g., from Home Voice Mode card) */\n  autoOpenRealtimeVoice?: boolean;\n  conversationId?: string;\n  /** Called when a voice user message should be added to chat (user spoke) */\n  onVoiceUserMessage?: (content: string) => void;\n  /** Called when a voice assistant message should be added to chat (AI responded) */\n  onVoiceAssistantMessage?: (content: string) => void;\n  /** Called when voice metrics are updated (for backend export) */\n  onVoiceMetricsUpdate?: (metrics: TTVoiceMetrics) => void;\n  /** External control: whether voice panel is open (controlled mode) */\n  isVoicePanelOpen?: boolean;\n  /** External control: callback when voice panel open state changes */\n  onVoicePanelChange?: (isOpen: boolean) => void;\n}\n\nexport function MessageInput({\n  onSend,\n  disabled = false,\n  placeholder = \"Type a message... (Shift+Enter for new line)\",\n  enableAttachments = false,\n  enableVoiceInput = true,\n  enableRealtimeVoice = false,\n  autoOpenRealtimeVoice = false,\n  conversationId,\n  onVoiceUserMessage,\n  onVoiceAssistantMessage,\n  onVoiceMetricsUpdate,\n  isVoicePanelOpen: externalIsVoicePanelOpen,\n  onVoicePanelChange,\n}: MessageInputProps) {\n  const [content, setContent] = useState(\"\");\n  const [showVoiceInput, setShowVoiceInput] = useState(false);\n  const [internalShowRealtimeVoice, setInternalShowRealtimeVoice] =\n    useState(false);\n  const [showFileUpload, setShowFileUpload] = useState(false);\n  const [pendingFiles, setPendingFiles] = useState<PendingFile[]>([]);\n  const textareaRef = useRef<HTMLTextAreaElement>(null);\n\n  // Support both controlled and uncontrolled modes for voice panel\n  const isControlled = externalIsVoicePanelOpen !== undefined;\n  const showRealtimeVoice = isControlled\n    ? externalIsVoicePanelOpen\n    : internalShowRealtimeVoice;\n\n  const setShowRealtimeVoice = (\n    value: boolean | ((prev: boolean) => boolean),\n  ) => {\n    const newValue =\n      typeof value === \"function\" ? value(showRealtimeVoice) : value;\n    if (isControlled) {\n      onVoicePanelChange?.(newValue);\n    } else {\n      setInternalShowRealtimeVoice(newValue);\n    }\n  };\n\n  // Get autoStartOnOpen setting from store\n  const autoStartOnOpenSetting = useVoiceSettingsStore(\n    (state) => state.autoStartOnOpen,\n  );\n\n  // Auto-expand textarea based on content\n  useEffect(() => {\n    const textarea = textareaRef.current;\n    if (textarea) {\n      textarea.style.height = \"auto\";\n      textarea.style.height = `${Math.min(textarea.scrollHeight, 200)}px`;\n    }\n  }, [content]);\n\n  // Auto-open realtime voice panel when requested via prop or store setting\n  useEffect(() => {\n    const shouldAutoOpen =\n      enableRealtimeVoice &&\n      (autoOpenRealtimeVoice || autoStartOnOpenSetting) &&\n      !showRealtimeVoice;\n    if (shouldAutoOpen) {\n      setShowRealtimeVoice(true);\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [enableRealtimeVoice, autoOpenRealtimeVoice, autoStartOnOpenSetting]); // Intentionally omit showRealtimeVoice to only trigger once\n\n  const handleSend = () => {\n    if (content.trim() && !disabled) {\n      // Pass the actual File objects to the parent\n      const files = pendingFiles.map((pf) => pf.file);\n      onSend(content.trim(), files.length > 0 ? files : undefined);\n      setContent(\"\");\n      setPendingFiles([]);\n      setShowFileUpload(false);\n\n      // Reset textarea height\n      if (textareaRef.current) {\n        textareaRef.current.style.height = \"auto\";\n      }\n    }\n  };\n\n  const handleKeyDown = (e: KeyboardEvent<HTMLTextAreaElement>) => {\n    // Enter to send, Shift+Enter for newline\n    if (e.key === \"Enter\" && !e.shiftKey) {\n      e.preventDefault();\n      handleSend();\n    }\n  };\n\n  const handleVoiceTranscript = (text: string) => {\n    setContent((prev) => (prev ? `${prev} ${text}` : text));\n    setShowVoiceInput(false);\n  };\n\n  /**\n   * Handle user message from voice mode (user finished speaking)\n   * This adds the user's spoken words to the chat timeline\n   */\n  const handleVoiceUserMessage = (text: string) => {\n    if (text.trim()) {\n      // Call the parent's handler if provided, otherwise fall back to onSend\n      if (onVoiceUserMessage) {\n        onVoiceUserMessage(text.trim());\n      } else {\n        // Fallback: send as regular user message\n        onSend(text.trim());\n      }\n    }\n  };\n\n  /**\n   * Handle assistant message from voice mode (AI finished responding)\n   * This adds the AI's response to the chat timeline\n   */\n  const handleVoiceAssistantMessage = (text: string) => {\n    if (text && text.trim() && onVoiceAssistantMessage) {\n      onVoiceAssistantMessage(text.trim());\n    }\n    // Note: If no onVoiceAssistantMessage handler is provided,\n    // the AI message is still shown in the VoiceModePanel but not added to chat\n  };\n\n  return (\n    <div className=\"border-t border-neutral-200 bg-white p-4\">\n      {/* Thinker/Talker Voice Mode Panel */}\n      {showRealtimeVoice && enableRealtimeVoice && (\n        <div className=\"mb-4\">\n          <ThinkerTalkerVoicePanel\n            key=\"tt-voice-mode-panel\"\n            conversationId={conversationId}\n            onClose={() => setShowRealtimeVoice(false)}\n            onUserMessage={handleVoiceUserMessage}\n            onAssistantMessage={handleVoiceAssistantMessage}\n            onMetricsUpdate={onVoiceMetricsUpdate}\n          />\n        </div>\n      )}\n\n      {/* Voice Input Modal */}\n      {showVoiceInput && enableVoiceInput && (\n        <div className=\"mb-4 p-4 bg-white rounded-lg border-2 border-primary-500 shadow-lg\">\n          <div className=\"flex items-center justify-between mb-3\">\n            <h3 className=\"text-sm font-semibold text-neutral-900\">\n              Voice Input\n            </h3>\n            <button\n              type=\"button\"\n              onClick={() => setShowVoiceInput(false)}\n              className=\"text-neutral-400 hover:text-neutral-600 focus:outline-none\"\n              aria-label=\"Close voice input\"\n            >\n              <svg\n                xmlns=\"http://www.w3.org/2000/svg\"\n                fill=\"none\"\n                viewBox=\"0 0 24 24\"\n                strokeWidth={2}\n                stroke=\"currentColor\"\n                className=\"w-5 h-5\"\n              >\n                <path\n                  strokeLinecap=\"round\"\n                  strokeLinejoin=\"round\"\n                  d=\"M6 18L18 6M6 6l12 12\"\n                />\n              </svg>\n            </button>\n          </div>\n          <VoiceInput\n            onTranscript={handleVoiceTranscript}\n            disabled={disabled}\n          />\n        </div>\n      )}\n\n      {/* File Upload Modal */}\n      {showFileUpload && enableAttachments && (\n        <div className=\"mb-4 p-4 bg-white rounded-lg border-2 border-primary-500 shadow-lg\">\n          <div className=\"flex items-center justify-between mb-3\">\n            <h3 className=\"text-sm font-semibold text-neutral-900\">\n              Attach Files\n            </h3>\n            <button\n              type=\"button\"\n              onClick={() => setShowFileUpload(false)}\n              className=\"text-neutral-400 hover:text-neutral-600 focus:outline-none\"\n              aria-label=\"Close file upload\"\n            >\n              <svg\n                xmlns=\"http://www.w3.org/2000/svg\"\n                fill=\"none\"\n                viewBox=\"0 0 24 24\"\n                strokeWidth={2}\n                stroke=\"currentColor\"\n                className=\"w-5 h-5\"\n              >\n                <path\n                  strokeLinecap=\"round\"\n                  strokeLinejoin=\"round\"\n                  d=\"M6 18L18 6M6 6l12 12\"\n                />\n              </svg>\n            </button>\n          </div>\n          <ChatAttachmentUpload\n            onFilesSelected={setPendingFiles}\n            selectedFiles={pendingFiles}\n            disabled={disabled}\n          />\n        </div>\n      )}\n\n      {/* Input Row */}\n      <div className=\"flex items-end space-x-2\">\n        {/* Realtime Voice Mode Button */}\n        {enableRealtimeVoice && (\n          <button\n            type=\"button\"\n            onClick={() => setShowRealtimeVoice(!showRealtimeVoice)}\n            disabled={disabled}\n            className={`flex items-center justify-center w-10 h-10 rounded-md transition-colors ${\n              showRealtimeVoice\n                ? \"bg-purple-500 text-white\"\n                : disabled\n                  ? \"bg-neutral-100 text-neutral-400 cursor-not-allowed\"\n                  : \"bg-neutral-100 text-purple-600 hover:bg-purple-50\"\n            }`}\n            aria-label=\"Realtime voice mode\"\n            title=\"Start voice conversation\"\n            data-testid=\"realtime-voice-mode-button\"\n          >\n            <svg\n              xmlns=\"http://www.w3.org/2000/svg\"\n              fill=\"none\"\n              viewBox=\"0 0 24 24\"\n              strokeWidth={1.5}\n              stroke=\"currentColor\"\n              className=\"w-5 h-5\"\n            >\n              <path\n                strokeLinecap=\"round\"\n                strokeLinejoin=\"round\"\n                d=\"M19.114 5.636a9 9 0 010 12.728M16.463 8.288a5.25 5.25 0 010 7.424M6.75 8.25l4.72-4.72a.75.75 0 011.28.53v15.88a.75.75 0 01-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.01 9.01 0 012.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75z\"\n              />\n            </svg>\n          </button>\n        )}\n\n        {/* Voice Input Button */}\n        {enableVoiceInput && (\n          <button\n            type=\"button\"\n            onClick={() => setShowVoiceInput(!showVoiceInput)}\n            disabled={disabled}\n            className={`flex items-center justify-center w-10 h-10 rounded-md transition-colors ${\n              showVoiceInput\n                ? \"bg-primary-500 text-white\"\n                : disabled\n                  ? \"bg-neutral-100 text-neutral-400 cursor-not-allowed\"\n                  : \"bg-neutral-100 text-neutral-600 hover:bg-neutral-200\"\n            }`}\n            aria-label=\"Voice input\"\n            title=\"Voice to text\"\n          >\n            <svg\n              xmlns=\"http://www.w3.org/2000/svg\"\n              fill=\"none\"\n              viewBox=\"0 0 24 24\"\n              strokeWidth={1.5}\n              stroke=\"currentColor\"\n              className=\"w-5 h-5\"\n            >\n              <path\n                strokeLinecap=\"round\"\n                strokeLinejoin=\"round\"\n                d=\"M12 18.75a6 6 0 006-6v-1.5m-6 7.5a6 6 0 01-6-6v-1.5m6 7.5v3.75m-3.75 0h7.5M12 15.75a3 3 0 01-3-3V4.5a3 3 0 116 0v8.25a3 3 0 01-3 3z\"\n              />\n            </svg>\n          </button>\n        )}\n\n        {/* Attachment Button */}\n        {enableAttachments && (\n          <button\n            type=\"button\"\n            onClick={() => setShowFileUpload(!showFileUpload)}\n            disabled={disabled}\n            className={`flex items-center justify-center w-10 h-10 rounded-md transition-colors ${\n              showFileUpload\n                ? \"bg-primary-500 text-white\"\n                : disabled\n                  ? \"bg-neutral-100 text-neutral-400 cursor-not-allowed\"\n                  : \"bg-neutral-100 text-neutral-600 hover:bg-neutral-200\"\n            }`}\n            aria-label=\"Attach files\"\n          >\n            <svg\n              xmlns=\"http://www.w3.org/2000/svg\"\n              fill=\"none\"\n              viewBox=\"0 0 24 24\"\n              strokeWidth={1.5}\n              stroke=\"currentColor\"\n              className=\"w-5 h-5\"\n            >\n              <path\n                strokeLinecap=\"round\"\n                strokeLinejoin=\"round\"\n                d=\"M18.375 12.739l-7.693 7.693a4.5 4.5 0 01-6.364-6.364l10.94-10.94A3 3 0 1119.5 7.372L8.552 18.32m.009-.01l-.01.01m5.699-9.941l-7.81 7.81a1.5 1.5 0 002.112 2.13\"\n              />\n            </svg>\n            {pendingFiles.length > 0 && (\n              <span className=\"absolute -top-1 -right-1 flex items-center justify-center w-5 h-5 text-xs font-bold text-white bg-primary-600 rounded-full\">\n                {pendingFiles.length}\n              </span>\n            )}\n          </button>\n        )}\n\n        {/* Textarea */}\n        <div className=\"flex-1 relative\">\n          <textarea\n            ref={textareaRef}\n            value={content}\n            onChange={(e) => setContent(e.target.value)}\n            onKeyDown={handleKeyDown}\n            disabled={disabled}\n            placeholder={placeholder}\n            rows={1}\n            className=\"w-full resize-none rounded-md border border-neutral-300 px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent disabled:bg-neutral-100 disabled:text-neutral-500\"\n            style={{ maxHeight: \"200px\" }}\n            aria-label=\"Message input\"\n          />\n\n          {/* Character indicator for long messages */}\n          {content.length > 500 && (\n            <div className=\"absolute bottom-2 right-2 text-xs text-neutral-400\">\n              {content.length}\n            </div>\n          )}\n        </div>\n\n        {/* Send Button */}\n        <button\n          type=\"button\"\n          onClick={handleSend}\n          disabled={disabled || !content.trim()}\n          className=\"flex items-center justify-center w-10 h-10 rounded-md bg-primary-500 text-white hover:bg-primary-600 disabled:bg-neutral-300 disabled:cursor-not-allowed transition-colors\"\n          aria-label=\"Send message\"\n        >\n          <svg\n            xmlns=\"http://www.w3.org/2000/svg\"\n            fill=\"none\"\n            viewBox=\"0 0 24 24\"\n            strokeWidth={2}\n            stroke=\"currentColor\"\n            className=\"w-5 h-5\"\n          >\n            <path\n              strokeLinecap=\"round\"\n              strokeLinejoin=\"round\"\n              d=\"M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5\"\n            />\n          </svg>\n        </button>\n      </div>\n\n      {/* Markdown Hint */}\n      <div className=\"mt-2 text-xs text-neutral-500\">\n        Markdown supported: **bold**, *italic*, `code`, [link](url), and more\n      </div>\n    </div>\n  );\n}\n"
}

{
  "path": "services/api-gateway/app/api/experiments.py",
  "language": "python",
  "size": 3889,
  "last_modified": "2025-12-01T21:42:42.785Z",
  "lines": 135,
  "content": "\"\"\"Experiments API - Public feature flag access.\n\nProvides read-only access to feature flags for the frontend.\nNo authentication required for basic flag checks.\n\"\"\"\n\nfrom __future__ import annotations\n\nfrom typing import Optional\n\nfrom app.core.api_envelope import success_response\nfrom app.core.database import get_db\nfrom app.core.logging import get_logger\nfrom app.services.feature_flags import feature_flag_service\nfrom fastapi import APIRouter, Depends\nfrom pydantic import BaseModel\nfrom sqlalchemy.orm import Session\n\nrouter = APIRouter(prefix=\"/api/experiments\", tags=[\"experiments\"])\nlogger = get_logger(__name__)\n\n\n# UI Feature Flag defaults (matching frontend featureFlags.ts)\nUI_FLAG_DEFAULTS = {\n    \"unified_chat_voice_ui\": False,\n    \"new_navigation\": False,\n    \"enhanced_documents\": False,\n    \"clinical_wizard\": False,\n    \"new_profile_ui\": False,\n    \"context_pane\": False,\n}\n\n\nclass FeatureFlagPublicResponse(BaseModel):\n    \"\"\"Public response model for feature flag.\"\"\"\n\n    name: str\n    enabled: bool\n    description: Optional[str] = None\n\n\n@router.get(\"/flags/{flag_name}\")\nasync def get_feature_flag(\n    flag_name: str,\n    db: Session = Depends(get_db),\n):\n    \"\"\"Get a feature flag's enabled state.\n\n    Returns the flag's enabled state for frontend feature gating.\n    Returns default value if flag doesn't exist.\n\n    No authentication required.\n    \"\"\"\n    try:\n        # Check if flag exists in database\n        flag = await feature_flag_service.get_flag(flag_name, db)\n\n        if flag:\n            return success_response(\n                data={\n                    \"name\": flag.name,\n                    \"enabled\": flag.enabled,\n                    \"description\": flag.description,\n                },\n                version=\"2.0.0\",\n            )\n\n        # Return default value for known UI flags\n        if flag_name in UI_FLAG_DEFAULTS:\n            return success_response(\n                data={\n                    \"name\": flag_name,\n                    \"enabled\": UI_FLAG_DEFAULTS[flag_name],\n                    \"description\": f\"Default value for {flag_name}\",\n                },\n                version=\"2.0.0\",\n            )\n\n        # Unknown flag - return disabled by default\n        return success_response(\n            data={\n                \"name\": flag_name,\n                \"enabled\": False,\n                \"description\": \"Unknown flag - disabled by default\",\n            },\n            version=\"2.0.0\",\n        )\n\n    except Exception as e:\n        logger.error(f\"Failed to get feature flag {flag_name}: {e}\")\n        # Return safe default on error\n        return success_response(\n            data={\n                \"name\": flag_name,\n                \"enabled\": UI_FLAG_DEFAULTS.get(flag_name, False),\n                \"description\": \"Error fetching flag - using default\",\n            },\n            version=\"2.0.0\",\n        )\n\n\n@router.get(\"/flags\")\nasync def list_public_flags(\n    db: Session = Depends(get_db),\n):\n    \"\"\"List all public feature flags.\n\n    Returns all flags with their current enabled state.\n    No authentication required.\n    \"\"\"\n    try:\n        # Get all flags from database\n        flags = await feature_flag_service.list_flags(db)\n\n        # Build response with database flags\n        flags_data = {flag.name: flag.enabled for flag in flags}\n\n        # Add defaults for any missing UI flags\n        for flag_name, default_value in UI_FLAG_DEFAULTS.items():\n            if flag_name not in flags_data:\n                flags_data[flag_name] = default_value\n\n        return success_response(\n            data={\"flags\": flags_data},\n            version=\"2.0.0\",\n        )\n\n    except Exception as e:\n        logger.error(f\"Failed to list feature flags: {e}\")\n        # Return defaults on error\n        return success_response(\n            data={\"flags\": UI_FLAG_DEFAULTS},\n            version=\"2.0.0\",\n        )\n"
}

{
  "path": "apps/web-app/src/components/voice/LatencyIndicator.tsx",
  "language": "typescript",
  "size": 6200,
  "last_modified": "2025-12-04T18:47:50.950Z",
  "lines": 226,
  "content": "/**\n * LatencyIndicator Component\n * Displays voice mode latency with visual status and degradation info.\n *\n * Part of Voice Mode Enhancement Plan v4.1\n * Reference: /home/asimo/.claude/plans/noble-bubbling-trinket.md#performance-safeguards\n */\n\nimport React from \"react\";\nimport { cn } from \"@/lib/utils\";\n\ninterface LatencyIndicatorProps {\n  latencyMs: number;\n  degradations?: string[];\n  className?: string;\n  showDetails?: boolean;\n  size?: \"sm\" | \"md\";\n}\n\ntype LatencyStatus = \"good\" | \"fair\" | \"slow\";\n\n/**\n * Determine latency status based on milliseconds\n */\nfunction getLatencyStatus(latencyMs: number): LatencyStatus {\n  if (latencyMs < 500) return \"good\";\n  if (latencyMs < 700) return \"fair\";\n  return \"slow\";\n}\n\n/**\n * Get human-readable label for latency status\n */\nfunction getStatusLabel(status: LatencyStatus): string {\n  switch (status) {\n    case \"good\":\n      return \"Fast\";\n    case \"fair\":\n      return \"Normal\";\n    case \"slow\":\n      return \"Slow\";\n  }\n}\n\n/**\n * Get human-readable labels for degradation types\n */\nfunction getDegradationLabel(degradation: string): string {\n  const labels: Record<string, string> = {\n    language_detection_skipped: \"Language detection skipped\",\n    language_detection_budget_exceeded: \"Language detection skipped (slow)\",\n    translation_skipped: \"Translation skipped\",\n    translation_budget_exceeded: \"Translation skipped (slow)\",\n    translation_failed: \"Translation failed\",\n    rag_limited_to_1: \"Search limited\",\n    rag_limited_to_3: \"Search limited\",\n    rag_retrieval_failed: \"Search failed\",\n    llm_context_shortened: \"Context shortened\",\n    tts_used_cached_greeting: \"Audio cached\",\n    parallel_stt_reduced: \"Speech recognition simplified\",\n  };\n  return labels[degradation] || degradation;\n}\n\n/**\n * Tooltip component for degradation details\n */\nfunction DegradationTooltip({\n  degradations,\n  children,\n}: {\n  degradations: string[];\n  children: React.ReactNode;\n}) {\n  const [isOpen, setIsOpen] = React.useState(false);\n\n  return (\n    <div className=\"relative inline-block\">\n      <div\n        onMouseEnter={() => setIsOpen(true)}\n        onMouseLeave={() => setIsOpen(false)}\n        className=\"cursor-help\"\n      >\n        {children}\n      </div>\n      {isOpen && (\n        <div className=\"absolute bottom-full left-1/2 -translate-x-1/2 mb-2 z-50\">\n          <div className=\"bg-neutral-900 text-white text-xs rounded-lg px-3 py-2 shadow-lg whitespace-nowrap\">\n            <div className=\"font-medium mb-1\">Features adjusted:</div>\n            <ul className=\"space-y-0.5\">\n              {degradations.map((d, i) => (\n                <li key={i} className=\"text-neutral-300\">\n                  {getDegradationLabel(d)}\n                </li>\n              ))}\n            </ul>\n            <div className=\"absolute top-full left-1/2 -translate-x-1/2 border-4 border-transparent border-t-neutral-900\" />\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n\n/**\n * Info icon for degradation indicator\n */\nfunction InfoIcon({ className }: { className?: string }) {\n  return (\n    <svg\n      xmlns=\"http://www.w3.org/2000/svg\"\n      viewBox=\"0 0 20 20\"\n      fill=\"currentColor\"\n      className={className}\n    >\n      <path\n        fillRule=\"evenodd\"\n        d=\"M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a.75.75 0 000 1.5h.253a.25.25 0 01.244.304l-.459 2.066A1.75 1.75 0 0010.747 15H11a.75.75 0 000-1.5h-.253a.25.25 0 01-.244-.304l.459-2.066A1.75 1.75 0 009.253 9H9z\"\n        clipRule=\"evenodd\"\n      />\n    </svg>\n  );\n}\n\n/**\n * LatencyIndicator\n *\n * Shows a visual indicator of voice processing latency with:\n * - Color-coded status (green/yellow/red)\n * - Latency in milliseconds\n * - Degradation info tooltip when features were adjusted\n */\nexport function LatencyIndicator({\n  latencyMs,\n  degradations = [],\n  className = \"\",\n  showDetails = true,\n  size = \"sm\",\n}: LatencyIndicatorProps) {\n  const status = getLatencyStatus(latencyMs);\n  const hasDegradations = degradations.length > 0;\n\n  const dotSize = size === \"sm\" ? \"w-2 h-2\" : \"w-2.5 h-2.5\";\n  const textSize = size === \"sm\" ? \"text-xs\" : \"text-sm\";\n\n  return (\n    <div\n      className={cn(\"flex items-center gap-1.5\", className)}\n      role=\"status\"\n      aria-label={`Response time: ${Math.round(latencyMs)}ms, status: ${getStatusLabel(status)}`}\n    >\n      {/* Status dot */}\n      <span\n        className={cn(\n          dotSize,\n          \"rounded-full\",\n          status === \"good\" && \"bg-green-500\",\n          status === \"fair\" && \"bg-yellow-500\",\n          status === \"slow\" && \"bg-red-500\",\n        )}\n      />\n\n      {/* Latency value */}\n      {showDetails && (\n        <span\n          className={cn(textSize, \"text-neutral-500 dark:text-neutral-400\")}\n        >\n          {Math.round(latencyMs)}ms\n        </span>\n      )}\n\n      {/* Degradation indicator */}\n      {hasDegradations && (\n        <DegradationTooltip degradations={degradations}>\n          <InfoIcon\n            className={cn(\n              size === \"sm\" ? \"w-3.5 h-3.5\" : \"w-4 h-4\",\n              \"text-yellow-500\",\n            )}\n          />\n        </DegradationTooltip>\n      )}\n    </div>\n  );\n}\n\n/**\n * LatencyBadge - Compact version for embedding in other components\n */\nexport function LatencyBadge({\n  latencyMs,\n  className = \"\",\n}: {\n  latencyMs: number;\n  className?: string;\n}) {\n  const status = getLatencyStatus(latencyMs);\n\n  return (\n    <span\n      className={cn(\n        \"inline-flex items-center gap-1 px-1.5 py-0.5 rounded text-xs font-medium\",\n        status === \"good\" &&\n          \"bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400\",\n        status === \"fair\" &&\n          \"bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-400\",\n        status === \"slow\" &&\n          \"bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400\",\n        className,\n      )}\n    >\n      <span\n        className={cn(\n          \"w-1.5 h-1.5 rounded-full\",\n          status === \"good\" && \"bg-green-500\",\n          status === \"fair\" && \"bg-yellow-500\",\n          status === \"slow\" && \"bg-red-500\",\n        )}\n      />\n      {Math.round(latencyMs)}ms\n    </span>\n  );\n}\n\nexport default LatencyIndicator;\n"
}

{
  "path": "apps/web-app/src/components/voice/CalibrationDialog.tsx",
  "language": "typescript",
  "size": 16338,
  "last_modified": "2025-12-03T23:50:35.643Z",
  "lines": 440,
  "content": "/**\n * Calibration Dialog Component\n *\n * Provides a step-by-step guided calibration process for personalizing\n * voice activity detection thresholds to the user's voice characteristics.\n *\n * Phase 8: Adaptive Personalization UI\n */\n\nimport { useState, useCallback, useEffect } from \"react\";\nimport { usePersonalization } from \"../../hooks/usePersonalization\";\nimport { useVoiceSettingsStore } from \"../../stores/voiceSettingsStore\";\n\nexport interface CalibrationDialogProps {\n  isOpen: boolean;\n  onClose: () => void;\n  onComplete?: (result: { vadThreshold: number; success: boolean }) => void;\n}\n\ntype CalibrationStep = \"intro\" | \"calibrating\" | \"complete\" | \"error\";\n\nexport function CalibrationDialog({\n  isOpen,\n  onClose,\n  onComplete,\n}: CalibrationDialogProps) {\n  const [step, setStep] = useState<CalibrationStep>(\"intro\");\n  const [progress, setProgress] = useState(0);\n  const [errorMessage, setErrorMessage] = useState<string | null>(null);\n\n  const {\n    setVadCalibrated,\n    setLastCalibrationDate,\n    setPersonalizedVadThreshold,\n  } = useVoiceSettingsStore();\n\n  const personalization = usePersonalization({\n    onCalibrationProgress: (calibrationProgress) => {\n      // progress is 0-100\n      setProgress(calibrationProgress.progress);\n    },\n    onCalibrationComplete: (result) => {\n      // If we get a result, calibration was successful\n      setStep(\"complete\");\n      // Update store with calibration results\n      setVadCalibrated(true);\n      setLastCalibrationDate(Date.now());\n      setPersonalizedVadThreshold(result.recommendedVadThreshold);\n      onComplete?.({\n        vadThreshold: result.recommendedVadThreshold,\n        success: true,\n      });\n    },\n  });\n\n  // Reset state when dialog opens\n  useEffect(() => {\n    if (isOpen) {\n      setStep(\"intro\");\n      setProgress(0);\n      setErrorMessage(null);\n    }\n  }, [isOpen]);\n\n  const handleStartCalibration = useCallback(async () => {\n    setStep(\"calibrating\");\n    setProgress(0);\n    setErrorMessage(null);\n\n    try {\n      await personalization.runCalibration();\n    } catch (error) {\n      setStep(\"error\");\n      setErrorMessage(\n        error instanceof Error ? error.message : \"Calibration failed\",\n      );\n    }\n  }, [personalization]);\n\n  const handleCancel = useCallback(() => {\n    if (step === \"calibrating\") {\n      personalization.cancelCalibration();\n    }\n    onClose();\n  }, [step, personalization, onClose]);\n\n  const handleRetry = useCallback(() => {\n    setStep(\"intro\");\n    setProgress(0);\n    setErrorMessage(null);\n  }, []);\n\n  if (!isOpen) {\n    return null;\n  }\n\n  return (\n    <div\n      className=\"fixed inset-0 z-[60] flex items-center justify-center bg-black/60\"\n      onClick={handleCancel}\n      role=\"dialog\"\n      aria-modal=\"true\"\n      aria-labelledby=\"calibration-title\"\n    >\n      <div\n        className=\"bg-white rounded-xl shadow-2xl max-w-lg w-full mx-4 overflow-hidden\"\n        onClick={(e) => e.stopPropagation()}\n      >\n        {/* Header */}\n        <div className=\"bg-gradient-to-r from-primary-500 to-primary-600 px-6 py-4\">\n          <h2\n            id=\"calibration-title\"\n            className=\"text-xl font-semibold text-white flex items-center gap-2\"\n          >\n            <svg\n              xmlns=\"http://www.w3.org/2000/svg\"\n              fill=\"none\"\n              viewBox=\"0 0 24 24\"\n              strokeWidth={1.5}\n              stroke=\"currentColor\"\n              className=\"w-6 h-6\"\n            >\n              <path\n                strokeLinecap=\"round\"\n                strokeLinejoin=\"round\"\n                d=\"M12 18.75a6 6 0 006-6v-1.5m-6 7.5a6 6 0 01-6-6v-1.5m6 7.5v3.75m-3.75 0h7.5M12 15.75a3 3 0 01-3-3V4.5a3 3 0 116 0v8.25a3 3 0 01-3 3z\"\n              />\n            </svg>\n            Voice Calibration\n          </h2>\n          <p className=\"text-primary-100 text-sm mt-1\">\n            Optimize voice detection for your unique voice\n          </p>\n        </div>\n\n        {/* Content */}\n        <div className=\"px-6 py-5\">\n          {step === \"intro\" && (\n            <div className=\"space-y-4\">\n              <div className=\"flex items-start gap-3 p-4 bg-blue-50 rounded-lg border border-blue-100\">\n                <svg\n                  xmlns=\"http://www.w3.org/2000/svg\"\n                  fill=\"none\"\n                  viewBox=\"0 0 24 24\"\n                  strokeWidth={1.5}\n                  stroke=\"currentColor\"\n                  className=\"w-6 h-6 text-blue-600 mt-0.5 flex-shrink-0\"\n                >\n                  <path\n                    strokeLinecap=\"round\"\n                    strokeLinejoin=\"round\"\n                    d=\"M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z\"\n                  />\n                </svg>\n                <div>\n                  <h3 className=\"font-medium text-blue-900\">\n                    What is calibration?\n                  </h3>\n                  <p className=\"text-sm text-blue-800 mt-1\">\n                    Calibration analyzes your voice characteristics to\n                    personalize voice activity detection. This helps us better\n                    recognize when you're speaking vs background noise.\n                  </p>\n                </div>\n              </div>\n\n              <div className=\"space-y-3\">\n                <h4 className=\"font-medium text-neutral-800\">\n                  Before you begin:\n                </h4>\n                <ul className=\"space-y-2 text-sm text-neutral-600\">\n                  <li className=\"flex items-start gap-2\">\n                    <svg\n                      xmlns=\"http://www.w3.org/2000/svg\"\n                      fill=\"none\"\n                      viewBox=\"0 0 24 24\"\n                      strokeWidth={2}\n                      stroke=\"currentColor\"\n                      className=\"w-4 h-4 text-green-500 mt-0.5 flex-shrink-0\"\n                    >\n                      <path\n                        strokeLinecap=\"round\"\n                        strokeLinejoin=\"round\"\n                        d=\"M4.5 12.75l6 6 9-13.5\"\n                      />\n                    </svg>\n                    Find a quiet environment with minimal background noise\n                  </li>\n                  <li className=\"flex items-start gap-2\">\n                    <svg\n                      xmlns=\"http://www.w3.org/2000/svg\"\n                      fill=\"none\"\n                      viewBox=\"0 0 24 24\"\n                      strokeWidth={2}\n                      stroke=\"currentColor\"\n                      className=\"w-4 h-4 text-green-500 mt-0.5 flex-shrink-0\"\n                    >\n                      <path\n                        strokeLinecap=\"round\"\n                        strokeLinejoin=\"round\"\n                        d=\"M4.5 12.75l6 6 9-13.5\"\n                      />\n                    </svg>\n                    Position your microphone at your normal speaking distance\n                  </li>\n                  <li className=\"flex items-start gap-2\">\n                    <svg\n                      xmlns=\"http://www.w3.org/2000/svg\"\n                      fill=\"none\"\n                      viewBox=\"0 0 24 24\"\n                      strokeWidth={2}\n                      stroke=\"currentColor\"\n                      className=\"w-4 h-4 text-green-500 mt-0.5 flex-shrink-0\"\n                    >\n                      <path\n                        strokeLinecap=\"round\"\n                        strokeLinejoin=\"round\"\n                        d=\"M4.5 12.75l6 6 9-13.5\"\n                      />\n                    </svg>\n                    Speak at your normal volume and pace\n                  </li>\n                </ul>\n              </div>\n\n              <p className=\"text-sm text-neutral-500\">\n                The process takes about 30 seconds and will ask you to speak a\n                few sample phrases.\n              </p>\n            </div>\n          )}\n\n          {step === \"calibrating\" && (\n            <div className=\"space-y-6 py-4\">\n              <div className=\"flex flex-col items-center\">\n                {/* Animated microphone */}\n                <div className=\"relative\">\n                  <div className=\"w-24 h-24 rounded-full bg-primary-100 flex items-center justify-center\">\n                    <svg\n                      xmlns=\"http://www.w3.org/2000/svg\"\n                      fill=\"none\"\n                      viewBox=\"0 0 24 24\"\n                      strokeWidth={1.5}\n                      stroke=\"currentColor\"\n                      className=\"w-12 h-12 text-primary-600 animate-pulse\"\n                    >\n                      <path\n                        strokeLinecap=\"round\"\n                        strokeLinejoin=\"round\"\n                        d=\"M12 18.75a6 6 0 006-6v-1.5m-6 7.5a6 6 0 01-6-6v-1.5m6 7.5v3.75m-3.75 0h7.5M12 15.75a3 3 0 01-3-3V4.5a3 3 0 116 0v8.25a3 3 0 01-3 3z\"\n                      />\n                    </svg>\n                  </div>\n                  {/* Pulse rings */}\n                  <div className=\"absolute inset-0 rounded-full border-2 border-primary-300 animate-ping opacity-30\" />\n                  <div\n                    className=\"absolute inset-0 rounded-full border-2 border-primary-300 animate-ping opacity-20\"\n                    style={{ animationDelay: \"0.5s\" }}\n                  />\n                </div>\n\n                <p className=\"text-lg font-medium text-neutral-800 mt-6\">\n                  Listening to your voice...\n                </p>\n                <p className=\"text-sm text-neutral-500 mt-1\">\n                  Please speak naturally as if in a conversation\n                </p>\n              </div>\n\n              {/* Progress bar */}\n              <div className=\"space-y-2\">\n                <div className=\"flex justify-between text-sm\">\n                  <span className=\"text-neutral-600\">Progress</span>\n                  <span className=\"font-medium text-primary-600\">\n                    {progress}%\n                  </span>\n                </div>\n                <div className=\"h-2 bg-neutral-200 rounded-full overflow-hidden\">\n                  <div\n                    className=\"h-full bg-gradient-to-r from-primary-400 to-primary-600 rounded-full transition-all duration-300 ease-out\"\n                    style={{ width: `${progress}%` }}\n                  />\n                </div>\n              </div>\n\n              <div className=\"p-3 bg-amber-50 rounded-lg border border-amber-100\">\n                <p className=\"text-sm text-amber-800 text-center\">\n                  Try saying: \"Hello, how are you today?\" or count from 1 to 10\n                </p>\n              </div>\n            </div>\n          )}\n\n          {step === \"complete\" && (\n            <div className=\"space-y-4 py-4 text-center\">\n              <div className=\"w-20 h-20 mx-auto rounded-full bg-green-100 flex items-center justify-center\">\n                <svg\n                  xmlns=\"http://www.w3.org/2000/svg\"\n                  fill=\"none\"\n                  viewBox=\"0 0 24 24\"\n                  strokeWidth={2}\n                  stroke=\"currentColor\"\n                  className=\"w-10 h-10 text-green-600\"\n                >\n                  <path\n                    strokeLinecap=\"round\"\n                    strokeLinejoin=\"round\"\n                    d=\"M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z\"\n                  />\n                </svg>\n              </div>\n\n              <div>\n                <h3 className=\"text-xl font-semibold text-neutral-900\">\n                  Calibration Complete!\n                </h3>\n                <p className=\"text-neutral-600 mt-2\">\n                  Your voice settings have been personalized for optimal\n                  detection.\n                </p>\n              </div>\n\n              <div className=\"p-4 bg-green-50 rounded-lg border border-green-100 text-left\">\n                <h4 className=\"font-medium text-green-900 mb-2\">\n                  What's improved:\n                </h4>\n                <ul className=\"space-y-1 text-sm text-green-800\">\n                  <li>• Better voice activity detection tuned to your voice</li>\n                  <li>• Reduced false activations from background noise</li>\n                  <li>• More natural conversation flow during voice mode</li>\n                </ul>\n              </div>\n            </div>\n          )}\n\n          {step === \"error\" && (\n            <div className=\"space-y-4 py-4 text-center\">\n              <div className=\"w-20 h-20 mx-auto rounded-full bg-red-100 flex items-center justify-center\">\n                <svg\n                  xmlns=\"http://www.w3.org/2000/svg\"\n                  fill=\"none\"\n                  viewBox=\"0 0 24 24\"\n                  strokeWidth={2}\n                  stroke=\"currentColor\"\n                  className=\"w-10 h-10 text-red-600\"\n                >\n                  <path\n                    strokeLinecap=\"round\"\n                    strokeLinejoin=\"round\"\n                    d=\"M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z\"\n                  />\n                </svg>\n              </div>\n\n              <div>\n                <h3 className=\"text-xl font-semibold text-neutral-900\">\n                  Calibration Failed\n                </h3>\n                <p className=\"text-neutral-600 mt-2\">\n                  {errorMessage ||\n                    \"Something went wrong during calibration. Please try again.\"}\n                </p>\n              </div>\n\n              <div className=\"p-4 bg-neutral-50 rounded-lg border border-neutral-200 text-left\">\n                <h4 className=\"font-medium text-neutral-800 mb-2\">\n                  Troubleshooting tips:\n                </h4>\n                <ul className=\"space-y-1 text-sm text-neutral-600\">\n                  <li>• Check that your microphone is working properly</li>\n                  <li>• Make sure you have granted microphone permission</li>\n                  <li>• Try moving to a quieter environment</li>\n                  <li>• Speak clearly and at a consistent volume</li>\n                </ul>\n              </div>\n            </div>\n          )}\n        </div>\n\n        {/* Footer */}\n        <div className=\"px-6 py-4 bg-neutral-50 border-t border-neutral-200 flex justify-between\">\n          <button\n            type=\"button\"\n            onClick={handleCancel}\n            className=\"px-4 py-2 text-sm font-medium text-neutral-600 hover:text-neutral-800 transition-colors\"\n          >\n            {step === \"complete\" ? \"Close\" : \"Cancel\"}\n          </button>\n\n          {step === \"intro\" && (\n            <button\n              type=\"button\"\n              onClick={handleStartCalibration}\n              className=\"px-6 py-2 bg-primary-500 text-white text-sm font-medium rounded-lg hover:bg-primary-600 transition-colors flex items-center gap-2\"\n            >\n              <svg\n                xmlns=\"http://www.w3.org/2000/svg\"\n                fill=\"none\"\n                viewBox=\"0 0 24 24\"\n                strokeWidth={2}\n                stroke=\"currentColor\"\n                className=\"w-4 h-4\"\n              >\n                <path\n                  strokeLinecap=\"round\"\n                  strokeLinejoin=\"round\"\n                  d=\"M5.25 5.653c0-.856.917-1.398 1.667-.986l11.54 6.348a1.125 1.125 0 010 1.971l-11.54 6.347a1.125 1.125 0 01-1.667-.985V5.653z\"\n                />\n              </svg>\n              Start Calibration\n            </button>\n          )}\n\n          {step === \"error\" && (\n            <button\n              type=\"button\"\n              onClick={handleRetry}\n              className=\"px-6 py-2 bg-primary-500 text-white text-sm font-medium rounded-lg hover:bg-primary-600 transition-colors\"\n            >\n              Try Again\n            </button>\n          )}\n\n          {step === \"complete\" && (\n            <button\n              type=\"button\"\n              onClick={onClose}\n              className=\"px-6 py-2 bg-green-500 text-white text-sm font-medium rounded-lg hover:bg-green-600 transition-colors\"\n            >\n              Done\n            </button>\n          )}\n        </div>\n      </div>\n    </div>\n  );\n}\n\nexport default CalibrationDialog;\n"
}

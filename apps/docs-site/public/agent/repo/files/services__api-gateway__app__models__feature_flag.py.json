{
  "path": "services/api-gateway/app/models/feature_flag.py",
  "language": "python",
  "size": 4727,
  "last_modified": "2025-12-05T03:07:13.131Z",
  "lines": 113,
  "content": "\"\"\"Feature Flag Model (Phase 7 - P3.1).\n\nProvides runtime feature toggles for controlled rollouts and A/B testing.\nSupports boolean, string, number, JSON, and multivariate feature values.\n\nEnhanced with:\n- Multivariate variants with weights\n- Targeting rules for conditional rollouts\n- Scheduled variant changes for gradual ramp-up\n- Environment-specific configurations\n\"\"\"\n\nfrom __future__ import annotations\n\nfrom datetime import datetime\nfrom enum import Enum\n\nfrom app.core.database import Base\nfrom sqlalchemy import JSON, Boolean, Column, DateTime, Index, Integer, String, Text\n\n\nclass FeatureFlagType(str, Enum):\n    \"\"\"Feature flag value types.\"\"\"\n\n    BOOLEAN = \"boolean\"\n    STRING = \"string\"\n    NUMBER = \"number\"\n    JSON = \"json\"\n    MULTIVARIATE = \"multivariate\"  # For A/B/n testing with variants\n\n\nclass FeatureFlag(Base):\n    \"\"\"Feature flag model for runtime configuration.\n\n    Attributes:\n        name: Unique feature flag identifier (e.g., 'rbac_enforcement')\n        description: Human-readable description of the feature\n        flag_type: Type of value (boolean, string, number, json, multivariate)\n        enabled: Whether the feature is currently enabled (for boolean flags)\n        value: JSON-encoded value for non-boolean flags\n        default_value: Default value if flag is not found\n        variants: List of variants for multivariate flags (JSON array)\n        targeting_rules: Targeting rules for conditional rollouts (JSON array)\n        scheduled_changes: Scheduled weight changes for gradual rollout (JSON array)\n        default_variant: Default variant ID for multivariate flags\n        rollout_percentage: Percentage of users to include (0-100)\n        rollout_salt: Salt for consistent user assignment\n        environment: Target environment (production, staging, development)\n        archived: Whether the flag is archived (soft delete)\n        created_at: Timestamp when flag was created\n        updated_at: Timestamp when flag was last updated\n        metadata: Additional metadata (tags, owner, etc.)\n    \"\"\"\n\n    __tablename__ = \"feature_flags\"\n\n    # Add composite indexes for common queries\n    __table_args__ = (\n        Index(\"ix_feature_flags_archived_env\", \"archived\", \"environment\"),\n        Index(\"ix_feature_flags_type\", \"flag_type\"),\n    )\n\n    name = Column(String(255), primary_key=True, index=True)\n    description = Column(Text, nullable=False)\n    flag_type = Column(String(50), nullable=False, default=FeatureFlagType.BOOLEAN.value)\n    enabled = Column(Boolean, nullable=False, default=False)\n    value = Column(JSON, nullable=True)\n    default_value = Column(JSON, nullable=True)\n\n    # Multivariate variant support\n    variants = Column(JSON, nullable=True)  # Array of {id, name, value, weight, description}\n    targeting_rules = Column(JSON, nullable=True)  # Array of targeting rules\n    scheduled_changes = Column(JSON, nullable=True)  # Array of scheduled weight changes\n    default_variant = Column(String(100), nullable=True)  # Default variant ID\n\n    # Rollout configuration\n    rollout_percentage = Column(Integer, nullable=True, default=100)  # For A/B testing (0-100)\n    rollout_salt = Column(String(50), nullable=True)  # Salt for consistent user assignment\n\n    # Organization\n    environment = Column(String(50), nullable=True, default=\"production\")\n    archived = Column(Boolean, nullable=False, default=False)  # Soft delete\n\n    # Timestamps\n    created_at = Column(DateTime, default=datetime.utcnow, nullable=False)\n    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow, nullable=False)\n    flag_metadata = Column(\"metadata\", JSON, nullable=True)\n\n    def __repr__(self):\n        return f\"<FeatureFlag(name='{self.name}', enabled={self.enabled}, type={self.flag_type})>\"\n\n    def to_dict(self) -> dict:\n        \"\"\"Convert model to dictionary.\"\"\"\n        return {\n            \"name\": self.name,\n            \"description\": self.description,\n            \"flag_type\": self.flag_type,\n            \"enabled\": self.enabled,\n            \"value\": self.value,\n            \"default_value\": self.default_value,\n            \"variants\": self.variants,\n            \"targeting_rules\": self.targeting_rules,\n            \"scheduled_changes\": self.scheduled_changes,\n            \"default_variant\": self.default_variant,\n            \"rollout_percentage\": self.rollout_percentage,\n            \"rollout_salt\": self.rollout_salt,\n            \"environment\": self.environment,\n            \"archived\": self.archived,\n            \"created_at\": self.created_at.isoformat() if self.created_at else None,\n            \"updated_at\": self.updated_at.isoformat() if self.updated_at else None,\n            \"metadata\": self.flag_metadata,\n        }\n"
}

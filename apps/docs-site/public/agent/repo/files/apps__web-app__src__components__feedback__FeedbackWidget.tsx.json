{
  "path": "apps/web-app/src/components/feedback/FeedbackWidget.tsx",
  "language": "typescript",
  "size": 7430,
  "last_modified": "2025-11-29T05:59:43.126Z",
  "lines": 181,
  "content": "import { useEffect, useState } from \"react\";\nimport { useLocation } from \"react-router-dom\";\nimport { ThumbsDown, ThumbsUp } from \"lucide-react\";\nimport { feedbackService } from \"../../services/feedback\";\nimport type { FeedbackRating } from \"../../services/feedback\";\nimport { useAuth } from \"../../hooks/useAuth\";\n\nconst FALLBACK_MESSAGE_ID = \"ui-feedback\";\nconst FALLBACK_CONVERSATION_ID = \"global\";\n\nexport function FeedbackWidget() {\n  const location = useLocation();\n  const { user } = useAuth();\n  const [rating, setRating] = useState<FeedbackRating | null>(null);\n  const [comment, setComment] = useState(\"\");\n  const [isSubmitting, setIsSubmitting] = useState(false);\n  const [status, setStatus] = useState<\"idle\" | \"success\" | \"error\">(\"idle\");\n  const [error, setError] = useState<string | null>(null);\n  const [isOpen, setIsOpen] = useState(false);\n\n  useEffect(() => {\n    feedbackService.setUserId(user?.id ?? null);\n  }, [user?.id]);\n\n  // Only show on the main dashboard page to avoid overlapping other UI\n  const isHomePage = location.pathname === \"/\" || location.pathname === \"/home\";\n  if (!isHomePage) {\n    return null;\n  }\n\n  const handleSubmit = async () => {\n    if (!rating) return;\n\n    setIsSubmitting(true);\n    setStatus(\"idle\");\n    setError(null);\n\n    try {\n      if (comment.trim()) {\n        await feedbackService.submitDetailedFeedback({\n          rating,\n          comments: comment.trim(),\n          categories: [\"other\"],\n          conversationId: FALLBACK_CONVERSATION_ID,\n          messageId: FALLBACK_MESSAGE_ID,\n          allowFollowUp: false,\n        });\n      } else {\n        await feedbackService.submitQuickFeedback(\n          FALLBACK_MESSAGE_ID,\n          FALLBACK_CONVERSATION_ID,\n          rating,\n        );\n      }\n\n      setStatus(\"success\");\n      setComment(\"\");\n      setRating(null);\n    } catch (submissionError) {\n      console.error(\"[FeedbackWidget] submission failed\", submissionError);\n      setStatus(\"error\");\n      setError(\n        submissionError instanceof Error\n          ? submissionError.message\n          : \"Unable to send feedback. Please try again.\",\n      );\n    } finally {\n      setIsSubmitting(false);\n    }\n  };\n\n  return (\n    <div className=\"fixed bottom-4 right-4 z-40 w-80 max-w-full\">\n      <button\n        type=\"button\"\n        className=\"flex w-full items-center justify-between rounded-lg border border-neutral-200 bg-white px-4 py-2 text-sm font-medium text-neutral-800 shadow-sm transition hover:bg-neutral-50 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary-500 dark:border-neutral-700 dark:bg-neutral-900 dark:text-neutral-100 dark:hover:bg-neutral-800\"\n        onClick={() => setIsOpen((open) => !open)}\n        aria-expanded={isOpen}\n        aria-controls=\"feedback-panel\"\n      >\n        <span>How was your experience?</span>\n        <span aria-hidden=\"true\">{isOpen ? \"âˆ’\" : \"+\"}</span>\n      </button>\n\n      {isOpen && (\n        <div\n          id=\"feedback-panel\"\n          className=\"mt-2 rounded-lg border border-neutral-200 bg-white p-4 shadow-lg dark:border-neutral-700 dark:bg-neutral-900\"\n        >\n          <p className=\"text-sm font-semibold text-neutral-900 dark:text-neutral-50\">\n            Send quick feedback\n          </p>\n          <p className=\"text-sm text-neutral-600 dark:text-neutral-300\">\n            Choose a rating and add an optional comment to help us improve.\n          </p>\n\n          <div\n            className=\"mt-3 flex items-center gap-2\"\n            role=\"group\"\n            aria-label=\"Rate your experience\"\n          >\n            <button\n              type=\"button\"\n              className={`flex flex-1 items-center justify-center gap-2 rounded-md border px-3 py-2 text-sm font-medium transition focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary-500 ${\n                rating === \"positive\"\n                  ? \"border-emerald-500 bg-emerald-50 text-emerald-700 dark:border-emerald-400/80 dark:bg-emerald-900/30\"\n                  : \"border-neutral-300 text-neutral-800 hover:bg-neutral-100 dark:border-neutral-700 dark:text-neutral-100 dark:hover:bg-neutral-800\"\n              }`}\n              onClick={() => setRating(\"positive\")}\n              aria-pressed={rating === \"positive\"}\n            >\n              <ThumbsUp className=\"h-4 w-4\" aria-hidden=\"true\" />\n              <span>Thumbs up</span>\n            </button>\n\n            <button\n              type=\"button\"\n              className={`flex flex-1 items-center justify-center gap-2 rounded-md border px-3 py-2 text-sm font-medium transition focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary-500 ${\n                rating === \"negative\"\n                  ? \"border-rose-500 bg-rose-50 text-rose-700 dark:border-rose-400/80 dark:bg-rose-900/30\"\n                  : \"border-neutral-300 text-neutral-800 hover:bg-neutral-100 dark:border-neutral-700 dark:text-neutral-100 dark:hover:bg-neutral-800\"\n              }`}\n              onClick={() => setRating(\"negative\")}\n              aria-pressed={rating === \"negative\"}\n            >\n              <ThumbsDown className=\"h-4 w-4\" aria-hidden=\"true\" />\n              <span>Thumbs down</span>\n            </button>\n          </div>\n\n          <label\n            className=\"mt-3 block text-sm font-medium text-neutral-900 dark:text-neutral-100\"\n            htmlFor=\"feedback-comment\"\n          >\n            Optional comments\n          </label>\n          <textarea\n            id=\"feedback-comment\"\n            className=\"mt-1 w-full rounded-md border border-neutral-300 bg-white p-2 text-sm text-neutral-900 shadow-sm focus:border-primary-500 focus:outline-none focus:ring-1 focus:ring-primary-500 dark:border-neutral-700 dark:bg-neutral-900 dark:text-neutral-50\"\n            rows={3}\n            placeholder=\"Tell us what worked well or what could be better\"\n            value={comment}\n            onChange={(event) => setComment(event.target.value)}\n          />\n\n          <div className=\"mt-3 flex items-center justify-between\">\n            <div className=\"text-xs text-neutral-500 dark:text-neutral-400\">\n              Feedback may be queued if you are offline.\n            </div>\n            <button\n              type=\"button\"\n              className=\"rounded-md bg-primary-600 px-3 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-primary-700 disabled:cursor-not-allowed disabled:bg-primary-300 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary-500\"\n              onClick={handleSubmit}\n              disabled={!rating || isSubmitting}\n            >\n              {isSubmitting ? \"Sending...\" : \"Submit\"}\n            </button>\n          </div>\n\n          <div\n            className=\"mt-2 min-h-[1.5rem] text-sm\"\n            role=\"status\"\n            aria-live=\"polite\"\n          >\n            {status === \"success\" && (\n              <span className=\"text-emerald-600 dark:text-emerald-400\">\n                Thanks! Your feedback was received.\n              </span>\n            )}\n            {status === \"error\" && (\n              <span className=\"text-rose-600 dark:text-rose-400\">\n                {error || \"Something went wrong.\"}\n              </span>\n            )}\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n"
}

{
  "path": "apps/web-app/src/components/chat/BranchTree.tsx",
  "language": "typescript",
  "size": 10864,
  "last_modified": "2025-11-27T06:53:16.474Z",
  "lines": 366,
  "content": "/**\n * BranchTree Component\n *\n * Displays a hierarchical visualization of conversation branches.\n * Shows branch names, message counts, and allows switching between branches.\n */\n\nimport { useState, useMemo } from \"react\";\nimport {\n  ChevronDown,\n  ChevronRight,\n  GitBranch,\n  MessageSquare,\n} from \"lucide-react\";\nimport type { Branch } from \"@voiceassist/types\";\n\n// ============================================================================\n// Types\n// ============================================================================\n\nexport interface BranchTreeProps {\n  /** List of branches in the conversation */\n  branches: Branch[];\n  /** Currently active branch ID */\n  currentBranchId: string;\n  /** Callback when a branch is selected */\n  onSelectBranch: (branchId: string) => void;\n  /** Callback when compare mode is activated */\n  onCompareBranches?: (branchIds: [string, string]) => void;\n  /** Whether the tree is loading */\n  isLoading?: boolean;\n  /** Whether to show compare functionality */\n  showCompare?: boolean;\n  /** Custom class name */\n  className?: string;\n}\n\ninterface BranchNode {\n  branch: Branch;\n  children: BranchNode[];\n  depth: number;\n}\n\n// ============================================================================\n// Helpers\n// ============================================================================\n\n/**\n * Build a tree structure from flat branches list\n */\nfunction buildBranchTree(branches: Branch[]): BranchNode[] {\n  const nodeMap = new Map<string, BranchNode>();\n  const roots: BranchNode[] = [];\n\n  // Create nodes for all branches\n  for (const branch of branches) {\n    nodeMap.set(branch.branchId, {\n      branch,\n      children: [],\n      depth: 0,\n    });\n  }\n\n  // Build tree structure\n  for (const branch of branches) {\n    const node = nodeMap.get(branch.branchId)!;\n\n    if (branch.branchId === \"main\" || !branch.parentMessageId) {\n      // Root node\n      roots.push(node);\n    } else {\n      // Find parent - branches fork from messages, so we need to find which branch\n      // contains the parent message. For now, assume main is the parent if no explicit parent.\n      const mainNode = nodeMap.get(\"main\");\n      if (mainNode) {\n        mainNode.children.push(node);\n        node.depth = 1;\n      } else {\n        roots.push(node);\n      }\n    }\n  }\n\n  // Sort by creation date\n  const sortNodes = (nodes: BranchNode[]) => {\n    nodes.sort(\n      (a, b) =>\n        new Date(a.branch.createdAt).getTime() -\n        new Date(b.branch.createdAt).getTime(),\n    );\n    for (const node of nodes) {\n      sortNodes(node.children);\n    }\n  };\n  sortNodes(roots);\n\n  return roots;\n}\n\n/**\n * Format timestamp to relative time\n */\nfunction formatRelativeTime(timestamp: string): string {\n  const date = new Date(timestamp);\n  const now = new Date();\n  const diffMs = now.getTime() - date.getTime();\n  const diffMins = Math.floor(diffMs / 60000);\n  const diffHours = Math.floor(diffMins / 60);\n  const diffDays = Math.floor(diffHours / 24);\n\n  if (diffMins < 1) return \"just now\";\n  if (diffMins < 60) return `${diffMins}m ago`;\n  if (diffHours < 24) return `${diffHours}h ago`;\n  if (diffDays < 7) return `${diffDays}d ago`;\n  return date.toLocaleDateString();\n}\n\n// ============================================================================\n// Sub-components\n// ============================================================================\n\ninterface BranchNodeItemProps {\n  node: BranchNode;\n  currentBranchId: string;\n  selectedForCompare: Set<string>;\n  onSelect: (branchId: string) => void;\n  onToggleCompare: (branchId: string) => void;\n  showCompare: boolean;\n}\n\nfunction BranchNodeItem({\n  node,\n  currentBranchId,\n  selectedForCompare,\n  onSelect,\n  onToggleCompare,\n  showCompare,\n}: BranchNodeItemProps) {\n  const [isExpanded, setIsExpanded] = useState(true);\n  const { branch, children, depth } = node;\n  const isActive = branch.branchId === currentBranchId;\n  const isMainBranch = branch.branchId === \"main\";\n  const hasChildren = children.length > 0;\n  const isSelectedForCompare = selectedForCompare.has(branch.branchId);\n\n  return (\n    <div className=\"branch-node\">\n      <div\n        className={`\n          flex items-center gap-2 px-3 py-2 rounded-lg cursor-pointer\n          transition-colors duration-150\n          ${isActive ? \"bg-primary-100 dark:bg-primary-900/30 border-l-2 border-primary-500\" : \"hover:bg-gray-100 dark:hover:bg-gray-800\"}\n          ${depth > 0 ? \"ml-\" + depth * 4 : \"\"}\n        `}\n        onClick={() => onSelect(branch.branchId)}\n        role=\"button\"\n        tabIndex={0}\n        onKeyDown={(e) => e.key === \"Enter\" && onSelect(branch.branchId)}\n        aria-selected={isActive}\n        aria-label={`Branch: ${isMainBranch ? \"Main\" : branch.branchId}`}\n      >\n        {/* Expand/collapse for branches with children */}\n        {hasChildren ? (\n          <button\n            onClick={(e) => {\n              e.stopPropagation();\n              setIsExpanded(!isExpanded);\n            }}\n            className=\"p-0.5 hover:bg-gray-200 dark:hover:bg-gray-700 rounded\"\n            aria-label={isExpanded ? \"Collapse\" : \"Expand\"}\n          >\n            {isExpanded ? (\n              <ChevronDown className=\"w-4 h-4 text-gray-500\" />\n            ) : (\n              <ChevronRight className=\"w-4 h-4 text-gray-500\" />\n            )}\n          </button>\n        ) : (\n          <span className=\"w-5\" /> // Spacer\n        )}\n\n        {/* Branch icon */}\n        <GitBranch\n          className={`w-4 h-4 ${isMainBranch ? \"text-green-500\" : \"text-blue-500\"}`}\n        />\n\n        {/* Branch name */}\n        <span\n          className={`\n            flex-1 text-sm font-medium truncate\n            ${isActive ? \"text-primary-700 dark:text-primary-300\" : \"text-gray-700 dark:text-gray-300\"}\n          `}\n        >\n          {isMainBranch ? \"Main\" : branch.branchId}\n        </span>\n\n        {/* Message count */}\n        <span\n          className=\"flex items-center gap-1 text-xs text-gray-500\"\n          title={`${branch.messageCount} messages`}\n        >\n          <MessageSquare className=\"w-3 h-3\" />\n          {branch.messageCount}\n        </span>\n\n        {/* Last activity */}\n        <span className=\"text-xs text-gray-400\" title={branch.lastActivity}>\n          {formatRelativeTime(branch.lastActivity)}\n        </span>\n\n        {/* Compare checkbox */}\n        {showCompare && (\n          <input\n            type=\"checkbox\"\n            checked={isSelectedForCompare}\n            onChange={(e) => {\n              e.stopPropagation();\n              onToggleCompare(branch.branchId);\n            }}\n            className=\"w-4 h-4 rounded border-gray-300\"\n            title=\"Select for comparison\"\n            aria-label={`Compare ${isMainBranch ? \"Main\" : branch.branchId}`}\n          />\n        )}\n      </div>\n\n      {/* Children */}\n      {hasChildren && isExpanded && (\n        <div className=\"branch-children\">\n          {children.map((child) => (\n            <BranchNodeItem\n              key={child.branch.branchId}\n              node={child}\n              currentBranchId={currentBranchId}\n              selectedForCompare={selectedForCompare}\n              onSelect={onSelect}\n              onToggleCompare={onToggleCompare}\n              showCompare={showCompare}\n            />\n          ))}\n        </div>\n      )}\n    </div>\n  );\n}\n\n// ============================================================================\n// Main Component\n// ============================================================================\n\nexport function BranchTree({\n  branches,\n  currentBranchId,\n  onSelectBranch,\n  onCompareBranches,\n  isLoading = false,\n  showCompare = false,\n  className = \"\",\n}: BranchTreeProps) {\n  const [selectedForCompare, setSelectedForCompare] = useState<Set<string>>(\n    new Set(),\n  );\n\n  // Build tree structure\n  const treeNodes = useMemo(() => buildBranchTree(branches), [branches]);\n\n  // Handle compare toggle\n  const handleToggleCompare = (branchId: string) => {\n    setSelectedForCompare((prev) => {\n      const next = new Set(prev);\n      if (next.has(branchId)) {\n        next.delete(branchId);\n      } else {\n        // Limit to 2 selections\n        if (next.size >= 2) {\n          const firstValue = next.values().next().value;\n          if (firstValue !== undefined) {\n            next.delete(firstValue);\n          }\n        }\n        next.add(branchId);\n      }\n      return next;\n    });\n  };\n\n  // Handle compare action\n  const handleCompare = () => {\n    if (selectedForCompare.size === 2 && onCompareBranches) {\n      const [first, second] = Array.from(selectedForCompare);\n      onCompareBranches([first, second]);\n    }\n  };\n\n  // Loading state\n  if (isLoading) {\n    return (\n      <div className={`branch-tree ${className}`}>\n        <div className=\"flex items-center justify-center py-8\">\n          <div className=\"animate-spin rounded-full h-6 w-6 border-b-2 border-primary-500\" />\n          <span className=\"ml-2 text-sm text-gray-500\">\n            Loading branches...\n          </span>\n        </div>\n      </div>\n    );\n  }\n\n  // Empty state\n  if (branches.length === 0) {\n    return (\n      <div className={`branch-tree ${className}`}>\n        <div className=\"text-center py-8 text-gray-500\">\n          <GitBranch className=\"w-8 h-8 mx-auto mb-2 opacity-50\" />\n          <p className=\"text-sm\">No branches yet</p>\n          <p className=\"text-xs\">\n            Branch from any message to explore alternatives\n          </p>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className={`branch-tree ${className}`}>\n      {/* Header */}\n      <div className=\"flex items-center justify-between px-3 py-2 border-b border-gray-200 dark:border-gray-700\">\n        <h3 className=\"text-sm font-semibold text-gray-700 dark:text-gray-300\">\n          Branches\n        </h3>\n        <span className=\"text-xs text-gray-500\">{branches.length} total</span>\n      </div>\n\n      {/* Tree */}\n      <div className=\"py-2\">\n        {treeNodes.map((node) => (\n          <BranchNodeItem\n            key={node.branch.branchId}\n            node={node}\n            currentBranchId={currentBranchId}\n            selectedForCompare={selectedForCompare}\n            onSelect={onSelectBranch}\n            onToggleCompare={handleToggleCompare}\n            showCompare={showCompare}\n          />\n        ))}\n      </div>\n\n      {/* Compare button */}\n      {showCompare && selectedForCompare.size === 2 && (\n        <div className=\"px-3 py-2 border-t border-gray-200 dark:border-gray-700\">\n          <button\n            onClick={handleCompare}\n            className=\"w-full py-2 px-4 bg-primary-500 text-white rounded-lg\n                       hover:bg-primary-600 transition-colors text-sm font-medium\"\n          >\n            Compare Selected Branches\n          </button>\n        </div>\n      )}\n    </div>\n  );\n}\n\nexport default BranchTree;\n"
}

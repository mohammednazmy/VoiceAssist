{
  "path": "apps/web-app/src/components/unified-chat/CollapsibleSidebar.tsx",
  "language": "typescript",
  "size": 18392,
  "last_modified": "2025-12-02T03:06:58.722Z",
  "lines": 585,
  "content": "/**\n * Collapsible Sidebar\n *\n * Sidebar for the unified interface with conversation list,\n * pinned conversations, and search.\n */\n\nimport { useState, useEffect, useRef, useCallback } from \"react\";\nimport { useNavigate } from \"react-router-dom\";\nimport {\n  PanelLeftClose,\n  PanelLeftOpen,\n  Plus,\n  Search,\n  Star,\n  Mic,\n  Keyboard,\n  Loader2,\n  AlertCircle,\n  Archive,\n  Trash2,\n  X,\n} from \"lucide-react\";\nimport { useConversations } from \"../../hooks/useConversations\";\nimport { useToastContext } from \"../../contexts/ToastContext\";\nimport { useIsMobile } from \"../../hooks/useIsMobile\";\nimport { DeleteAllConfirmDialog } from \"../sidebar/DeleteAllConfirmDialog\";\nimport type { Conversation } from \"@voiceassist/types\";\n\n// ============================================================================\n// Types\n// ============================================================================\n\ninterface CollapsibleSidebarProps {\n  isOpen: boolean;\n  onToggle: () => void;\n  conversationId: string | null;\n  onNewConversation?: () => void;\n}\n\n// Local storage key for pinned conversations\nconst PINNED_CONVERSATIONS_KEY = \"voiceassist_pinned_conversations\";\n\n// ============================================================================\n// Component\n// ============================================================================\n\nexport function CollapsibleSidebar({\n  isOpen,\n  onToggle,\n  conversationId,\n  onNewConversation,\n}: CollapsibleSidebarProps) {\n  const navigate = useNavigate();\n  const toast = useToastContext();\n  const listRef = useRef<HTMLDivElement>(null);\n  const isMobile = useIsMobile();\n\n  // Use conversations hook\n  const {\n    conversations,\n    allConversations,\n    isLoading,\n    isLoadingMore,\n    error,\n    searchQuery,\n    setSearchQuery,\n    hasMore,\n    loadMore,\n    deleteConversation,\n    deleteAllConversations,\n    archiveConversation,\n    reload,\n  } = useConversations({\n    onError: (message, description) => toast.error(message, description),\n  });\n\n  // Delete All state\n  const [isDeleteAllDialogOpen, setIsDeleteAllDialogOpen] = useState(false);\n  const [isDeletingAll, setIsDeletingAll] = useState(false);\n\n  // Load pinned conversations from localStorage\n  const getPinnedIds = useCallback((): Set<string> => {\n    try {\n      const stored = localStorage.getItem(PINNED_CONVERSATIONS_KEY);\n      return stored ? new Set(JSON.parse(stored)) : new Set();\n    } catch {\n      return new Set();\n    }\n  }, []);\n\n  const pinnedIds = getPinnedIds();\n\n  // Toggle pin status\n  const togglePin = useCallback(\n    (id: string) => {\n      const pinned = getPinnedIds();\n      if (pinned.has(id)) {\n        pinned.delete(id);\n      } else {\n        pinned.add(id);\n      }\n      localStorage.setItem(\n        PINNED_CONVERSATIONS_KEY,\n        JSON.stringify([...pinned]),\n      );\n      // Force re-render by touching state would be needed here if using useState\n    },\n    [getPinnedIds],\n  );\n\n  // Split conversations into pinned and recent\n  const pinnedConversations = conversations.filter((c) => pinnedIds.has(c.id));\n  const recentConversations = conversations.filter((c) => !pinnedIds.has(c.id));\n\n  // Handle infinite scroll\n  useEffect(() => {\n    const list = listRef.current;\n    if (!list) return;\n\n    const handleScroll = () => {\n      const { scrollTop, scrollHeight, clientHeight } = list;\n      // Load more when scrolled to bottom (with 100px threshold)\n      if (\n        scrollHeight - scrollTop - clientHeight < 100 &&\n        hasMore &&\n        !isLoadingMore\n      ) {\n        loadMore();\n      }\n    };\n\n    list.addEventListener(\"scroll\", handleScroll);\n    return () => list.removeEventListener(\"scroll\", handleScroll);\n  }, [hasMore, isLoadingMore, loadMore]);\n\n  // Handle new conversation\n  const handleNewConversation = () => {\n    if (onNewConversation) {\n      onNewConversation();\n    } else {\n      navigate(\"/chat\");\n    }\n  };\n\n  // Handle delete conversation\n  const handleDelete = async (id: string, e: React.MouseEvent) => {\n    e.stopPropagation();\n    if (window.confirm(\"Are you sure you want to delete this conversation?\")) {\n      try {\n        await deleteConversation(id);\n        toast.success(\"Conversation deleted\");\n\n        // Navigate away if current conversation was deleted\n        if (id === conversationId) {\n          // Find another conversation to navigate to (avoid auto-creating new one)\n          const remainingConversations = conversations.filter(\n            (c) => c.id !== id,\n          );\n          if (remainingConversations.length > 0) {\n            // Navigate to the most recent remaining conversation\n            navigate(`/chat/${remainingConversations[0].id}`);\n          } else {\n            // No conversations left, go to empty chat\n            navigate(\"/chat\");\n          }\n        } else {\n          // Only reload if staying on current page (no remount will happen)\n          await reload();\n        }\n      } catch {\n        // Error handled by hook\n      }\n    }\n  };\n\n  // Handle archive conversation\n  const handleArchive = async (id: string, e: React.MouseEvent) => {\n    e.stopPropagation();\n    try {\n      await archiveConversation(id);\n      toast.success(\"Conversation archived\");\n    } catch {\n      // Error handled by hook\n    }\n  };\n\n  // Handle delete all conversations\n  const handleDeleteAll = async () => {\n    setIsDeletingAll(true);\n    try {\n      const result = await deleteAllConversations();\n      setIsDeleteAllDialogOpen(false);\n      toast.success(\n        `Deleted ${result.deleted_count} conversation${result.deleted_count !== 1 ? \"s\" : \"\"}`,\n      );\n      // Force reload to ensure fresh data from backend\n      await reload();\n      // Navigate to new chat if we were viewing a conversation\n      if (conversationId) {\n        navigate(\"/chat\");\n      }\n    } catch {\n      // Error handled by hook\n    } finally {\n      setIsDeletingAll(false);\n    }\n  };\n\n  // Handle navigation with auto-close on mobile\n  const handleNavigate = useCallback(\n    (path: string) => {\n      navigate(path);\n      if (isMobile) {\n        onToggle(); // Close sidebar after navigation on mobile\n      }\n    },\n    [navigate, isMobile, onToggle],\n  );\n\n  // Collapsed state - hidden on mobile when closed\n  if (!isOpen) {\n    // On mobile, don't render anything when closed\n    if (isMobile) {\n      return null;\n    }\n    // On desktop, show collapsed sidebar\n    return (\n      <div className=\"w-12 border-r border-neutral-200 bg-white flex flex-col items-center py-4\">\n        <button\n          onClick={onToggle}\n          className=\"p-2 hover:bg-neutral-100 rounded-lg transition-colors\"\n          aria-label=\"Open sidebar\"\n        >\n          <PanelLeftOpen className=\"w-5 h-5 text-neutral-600\" />\n        </button>\n        <button\n          onClick={handleNewConversation}\n          className=\"mt-4 p-2 hover:bg-neutral-100 rounded-lg transition-colors\"\n          aria-label=\"New conversation\"\n        >\n          <Plus className=\"w-5 h-5 text-neutral-600\" />\n        </button>\n      </div>\n    );\n  }\n\n  // Sidebar content component\n  const sidebarContent = (\n    <nav\n      className={`${isMobile ? \"w-80 max-w-[85vw]\" : \"w-64\"} h-full border-r border-neutral-200 bg-white flex flex-col`}\n      aria-label=\"Conversation history\"\n      data-testid=\"collapsible-sidebar\"\n    >\n      {/* Header */}\n      <div className=\"flex items-center justify-between px-4 py-3 border-b border-neutral-100\">\n        <h2 className=\"font-semibold text-neutral-900\">Conversations</h2>\n        <button\n          onClick={onToggle}\n          className=\"p-1.5 hover:bg-neutral-100 rounded-lg transition-colors\"\n          aria-label=\"Close sidebar\"\n          data-testid=\"sidebar-toggle\"\n        >\n          {isMobile ? (\n            <X className=\"w-5 h-5 text-neutral-500\" />\n          ) : (\n            <PanelLeftClose className=\"w-5 h-5 text-neutral-500\" />\n          )}\n        </button>\n      </div>\n\n      {/* New Conversation Button */}\n      <div className=\"px-3 py-2\">\n        <button\n          onClick={handleNewConversation}\n          className=\"w-full flex items-center gap-2 px-3 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors\"\n          data-testid=\"new-chat-button\"\n        >\n          <Plus className=\"w-4 h-4\" />\n          <span>New Conversation</span>\n        </button>\n      </div>\n\n      {/* Search */}\n      <div className=\"px-3 py-2\">\n        <div className=\"relative\">\n          <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-neutral-400\" />\n          <input\n            type=\"text\"\n            placeholder=\"Search conversations...\"\n            value={searchQuery}\n            onChange={(e) => setSearchQuery(e.target.value)}\n            className=\"w-full pl-9 pr-3 py-2 text-sm border border-neutral-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent\"\n            data-testid=\"conversation-search\"\n          />\n        </div>\n      </div>\n\n      {/* Conversation List */}\n      <div\n        ref={listRef}\n        className=\"flex-1 overflow-y-auto\"\n        data-testid=\"conversation-list\"\n      >\n        {/* Loading State */}\n        {isLoading && conversations.length === 0 && (\n          <div className=\"flex items-center justify-center py-8\">\n            <Loader2 className=\"w-6 h-6 text-primary-500 animate-spin\" />\n          </div>\n        )}\n\n        {/* Error State */}\n        {error && conversations.length === 0 && (\n          <div className=\"px-4 py-8 text-center\">\n            <AlertCircle className=\"w-8 h-8 text-red-500 mx-auto mb-2\" />\n            <p className=\"text-sm text-red-600\">{error}</p>\n          </div>\n        )}\n\n        {/* Pinned Section */}\n        {pinnedConversations.length > 0 && (\n          <div className=\"px-3 py-2\">\n            <h3 className=\"text-xs font-medium text-neutral-500 uppercase tracking-wider mb-2\">\n              Pinned\n            </h3>\n            <ul className=\"space-y-1\">\n              {pinnedConversations.map((conv) => (\n                <ConversationItem\n                  key={conv.id}\n                  conversation={conv}\n                  isActive={conv.id === conversationId}\n                  isPinned={true}\n                  onClick={() => handleNavigate(`/chat/${conv.id}`)}\n                  onPin={() => togglePin(conv.id)}\n                  onDelete={(e) => handleDelete(conv.id, e)}\n                  onArchive={(e) => handleArchive(conv.id, e)}\n                />\n              ))}\n            </ul>\n          </div>\n        )}\n\n        {/* Recent Section */}\n        {recentConversations.length > 0 && (\n          <div className=\"px-3 py-2\">\n            <h3 className=\"text-xs font-medium text-neutral-500 uppercase tracking-wider mb-2\">\n              Recent\n            </h3>\n            <ul className=\"space-y-1\">\n              {recentConversations.map((conv) => (\n                <ConversationItem\n                  key={conv.id}\n                  conversation={conv}\n                  isActive={conv.id === conversationId}\n                  isPinned={false}\n                  onClick={() => handleNavigate(`/chat/${conv.id}`)}\n                  onPin={() => togglePin(conv.id)}\n                  onDelete={(e) => handleDelete(conv.id, e)}\n                  onArchive={(e) => handleArchive(conv.id, e)}\n                />\n              ))}\n            </ul>\n          </div>\n        )}\n\n        {/* Loading More Indicator */}\n        {isLoadingMore && (\n          <div className=\"flex items-center justify-center py-4\">\n            <Loader2 className=\"w-5 h-5 text-neutral-400 animate-spin\" />\n          </div>\n        )}\n\n        {/* Empty State */}\n        {!isLoading && conversations.length === 0 && !error && (\n          <div className=\"px-4 py-8 text-center text-neutral-500\">\n            {searchQuery ? (\n              <>\n                <Search className=\"w-8 h-8 mx-auto mb-2 text-neutral-300\" />\n                <p className=\"text-sm\">No conversations found</p>\n                <p className=\"text-xs mt-1\">Try a different search term</p>\n              </>\n            ) : (\n              <>\n                <p className=\"text-sm\">No conversations yet</p>\n                <p className=\"text-xs mt-1\">\n                  Start a new conversation to get started\n                </p>\n              </>\n            )}\n          </div>\n        )}\n      </div>\n\n      {/* Delete All Button - Footer */}\n      {allConversations.length > 0 && (\n        <div className=\"px-3 py-3 border-t border-neutral-200\">\n          <button\n            onClick={() => setIsDeleteAllDialogOpen(true)}\n            className=\"w-full flex items-center justify-center gap-2 px-3 py-2 text-sm\n                       text-red-600 hover:text-red-700 hover:bg-red-50\n                       rounded-lg transition-colors\"\n            data-testid=\"delete-all-button\"\n          >\n            <Trash2 className=\"w-4 h-4\" />\n            Delete All Conversations\n          </button>\n        </div>\n      )}\n    </nav>\n  );\n\n  // Delete All Confirmation Dialog (rendered in both mobile and desktop)\n  const deleteAllDialog = (\n    <DeleteAllConfirmDialog\n      isOpen={isDeleteAllDialogOpen}\n      conversationCount={allConversations.length}\n      onConfirm={handleDeleteAll}\n      onCancel={() => setIsDeleteAllDialogOpen(false)}\n      isDeleting={isDeletingAll}\n    />\n  );\n\n  // On mobile, wrap with overlay backdrop\n  if (isMobile) {\n    return (\n      <>\n        <div className=\"fixed inset-0 z-40 flex\">\n          {/* Backdrop */}\n          <div\n            className=\"absolute inset-0 bg-black/50 transition-opacity duration-200\"\n            onClick={onToggle}\n            aria-hidden=\"true\"\n          />\n          {/* Sidebar - slide in from left */}\n          <div className=\"relative z-50 h-full shadow-xl\">{sidebarContent}</div>\n        </div>\n        {deleteAllDialog}\n      </>\n    );\n  }\n\n  // Desktop: render inline\n  return (\n    <>\n      {sidebarContent}\n      {deleteAllDialog}\n    </>\n  );\n}\n\n// ============================================================================\n// Conversation Item\n// ============================================================================\n\ninterface ConversationItemProps {\n  conversation: Conversation;\n  isActive: boolean;\n  isPinned: boolean;\n  onClick: () => void;\n  onPin: () => void;\n  onDelete: (e: React.MouseEvent) => void;\n  onArchive: (e: React.MouseEvent) => void;\n}\n\nfunction ConversationItem({\n  conversation,\n  isActive,\n  isPinned,\n  onClick,\n  onPin,\n  onDelete,\n  onArchive,\n}: ConversationItemProps) {\n  // Determine mode from conversation metadata\n  // Check if conversation has voice-related metadata\n  const hasVoiceMessages =\n    (conversation as any).metadata?.hasVoiceMessages === true;\n\n  const handleClick = () => {\n    onClick();\n  };\n\n  return (\n    <li className=\"group relative\">\n      {/* Main clickable area */}\n      <div\n        role=\"button\"\n        tabIndex={0}\n        onClick={handleClick}\n        onKeyDown={(e) => {\n          if (e.key === \"Enter\" || e.key === \" \") {\n            e.preventDefault();\n            handleClick();\n          }\n        }}\n        className={`w-full flex items-center gap-2 px-3 py-2 rounded-lg text-left transition-colors cursor-pointer ${\n          isActive\n            ? \"bg-primary-100 text-primary-900\"\n            : \"hover:bg-neutral-100 text-neutral-700\"\n        }`}\n        aria-current={isActive ? \"true\" : undefined}\n      >\n        {/* Mode Badge */}\n        <span className=\"flex-shrink-0\">\n          {hasVoiceMessages ? (\n            <Mic className=\"w-4 h-4 text-neutral-400\" />\n          ) : (\n            <Keyboard className=\"w-4 h-4 text-neutral-400\" />\n          )}\n        </span>\n\n        {/* Title and Meta */}\n        <div className=\"flex-1 min-w-0\">\n          <p className=\"text-sm font-medium truncate\">{conversation.title}</p>\n          <p className=\"text-xs text-neutral-500\">\n            {formatRelativeTime(conversation.updatedAt)}\n          </p>\n        </div>\n\n        {/* Pinned Indicator (when not hovering) */}\n        {isPinned && (\n          <Star className=\"w-3.5 h-3.5 text-amber-500 fill-amber-500 flex-shrink-0 group-hover:hidden\" />\n        )}\n      </div>\n\n      {/* Actions - positioned absolutely, visible on hover */}\n      {/* pointer-events-none when hidden to prevent blocking clicks on the main area */}\n      <div className=\"absolute right-2 top-1/2 -translate-y-1/2 opacity-0 group-hover:opacity-100 pointer-events-none group-hover:pointer-events-auto transition-opacity\">\n        <div className=\"flex items-center gap-1 bg-white rounded shadow-sm border border-neutral-200 p-0.5\">\n          <button\n            onClick={(e) => {\n              e.stopPropagation();\n              onPin();\n            }}\n            className={`p-1 rounded hover:bg-neutral-100 ${\n              isPinned ? \"text-amber-500\" : \"text-neutral-400\"\n            }`}\n            title={isPinned ? \"Unpin\" : \"Pin\"}\n          >\n            <Star\n              className={`w-3.5 h-3.5 ${isPinned ? \"fill-amber-500\" : \"\"}`}\n            />\n          </button>\n          <button\n            onClick={onArchive}\n            className=\"p-1 rounded text-neutral-400 hover:bg-neutral-100 hover:text-neutral-600\"\n            title=\"Archive\"\n          >\n            <Archive className=\"w-3.5 h-3.5\" />\n          </button>\n          <button\n            onClick={onDelete}\n            className=\"p-1 rounded text-neutral-400 hover:bg-red-50 hover:text-red-600\"\n            title=\"Delete\"\n          >\n            <Trash2 className=\"w-3.5 h-3.5\" />\n          </button>\n        </div>\n      </div>\n    </li>\n  );\n}\n\n// ============================================================================\n// Helpers\n// ============================================================================\n\nfunction formatRelativeTime(dateString: string): string {\n  const date = new Date(dateString);\n  const now = new Date();\n  const diffMs = now.getTime() - date.getTime();\n  const diffMins = Math.floor(diffMs / 60000);\n  const diffHours = Math.floor(diffMs / 3600000);\n  const diffDays = Math.floor(diffMs / 86400000);\n\n  if (diffMins < 1) return \"Just now\";\n  if (diffMins < 60) return `${diffMins}m ago`;\n  if (diffHours < 24) return `${diffHours}h ago`;\n  if (diffDays < 7) return `${diffDays}d ago`;\n\n  return date.toLocaleDateString();\n}\n\nexport default CollapsibleSidebar;\n"
}

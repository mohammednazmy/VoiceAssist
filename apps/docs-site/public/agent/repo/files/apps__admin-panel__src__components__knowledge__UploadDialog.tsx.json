{
  "path": "apps/admin-panel/src/components/knowledge/UploadDialog.tsx",
  "language": "typescript",
  "size": 7067,
  "last_modified": "2025-11-29T04:26:40.443Z",
  "lines": 225,
  "content": "import { useState, useMemo, useEffect } from \"react\";\n\ninterface UploadDialogProps {\n  open: boolean;\n  onClose: () => void;\n  onUpload: (file: File, onProgress: (value: number) => void) => Promise<void>;\n  maxSizeMb?: number;\n  acceptedTypes?: string[];\n}\n\ninterface PendingFile {\n  file: File;\n  error?: string;\n  progress: number;\n}\n\nconst DEFAULT_ACCEPTED = [\"application/pdf\", \"text/plain\", \"text/markdown\"];\n\nexport function UploadDialog({\n  open,\n  onClose,\n  onUpload,\n  maxSizeMb = 25,\n  acceptedTypes = DEFAULT_ACCEPTED,\n}: UploadDialogProps) {\n  const [pendingFiles, setPendingFiles] = useState<PendingFile[]>([]);\n  const [submitting, setSubmitting] = useState(false);\n  const [submitError, setSubmitError] = useState<string | null>(null);\n\n  useEffect(() => {\n    if (!open) {\n      setPendingFiles([]);\n      setSubmitting(false);\n      setSubmitError(null);\n    }\n  }, [open]);\n\n  const typeLabels = useMemo(\n    () =>\n      acceptedTypes\n        .map((t) => t.replace(\"application/\", \"\").replace(\"text/\", \"\"))\n        .join(\", \"),\n    [acceptedTypes],\n  );\n\n  const validateFiles = (files: FileList | null) => {\n    if (!files) return [] as PendingFile[];\n    const maxBytes = maxSizeMb * 1024 * 1024;\n    return Array.from(files).map((file) => {\n      if (file.size > maxBytes) {\n        return {\n          file,\n          progress: 0,\n          error: `File exceeds ${maxSizeMb}MB limit`,\n        } satisfies PendingFile;\n      }\n      if (acceptedTypes.length && !acceptedTypes.includes(file.type)) {\n        return {\n          file,\n          progress: 0,\n          error: `Unsupported type (${file.type || \"unknown\"})`,\n        } satisfies PendingFile;\n      }\n      return { file, progress: 0 } satisfies PendingFile;\n    });\n  };\n\n  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {\n    const validated = validateFiles(e.target.files);\n    setPendingFiles(validated);\n    setSubmitError(null);\n  };\n\n  const hasBlockingErrors = useMemo(\n    () => pendingFiles.some((pf) => Boolean(pf.error)),\n    [pendingFiles],\n  );\n\n  const formatSize = (bytes: number) => {\n    if (bytes < 1024) return `${bytes} B`;\n    if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;\n    return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;\n  };\n\n  const submitFiles = async () => {\n    if (!pendingFiles.length || hasBlockingErrors) return;\n    setSubmitting(true);\n    setSubmitError(null);\n\n    try {\n      for (const pending of pendingFiles) {\n        await onUpload(pending.file, (value) => {\n          setPendingFiles((prev) =>\n            prev.map((p) =>\n              p.file.name === pending.file.name ? { ...p, progress: value } : p,\n            ),\n          );\n        });\n      }\n      onClose();\n    } catch (err: unknown) {\n      const message = err instanceof Error ? err.message : \"Upload failed\";\n      setSubmitError(message);\n    } finally {\n      setSubmitting(false);\n    }\n  };\n\n  if (!open) return null;\n\n  return (\n    <div className=\"fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 backdrop-blur-sm\">\n      <div className=\"bg-slate-900 border border-slate-800 rounded-lg shadow-xl w-full max-w-lg p-6 space-y-4\">\n        <div className=\"flex items-center justify-between\">\n          <div>\n            <h3 className=\"text-lg font-semibold text-slate-100\">\n              Upload documents\n            </h3>\n            <p className=\"text-sm text-slate-400\">\n              PDF, TXT, and Markdown files up to {maxSizeMb}MB.\n            </p>\n          </div>\n          <button\n            className=\"text-slate-400 hover:text-slate-200\"\n            onClick={onClose}\n            disabled={submitting}\n            aria-label=\"Close upload dialog\"\n          >\n            ✕\n          </button>\n        </div>\n\n        <label\n          className={`border-2 border-dashed rounded-md p-4 text-center cursor-pointer transition-colors ${\n            hasBlockingErrors\n              ? \"border-amber-700/80 bg-amber-950/40 text-amber-200\"\n              : \"border-slate-700 hover:border-slate-500 text-slate-300\"\n          }`}\n        >\n          <input\n            type=\"file\"\n            className=\"hidden\"\n            multiple\n            accept={acceptedTypes.join(\",\")}\n            onChange={handleFileChange}\n            disabled={submitting}\n          />\n          <div className=\"text-sm font-medium\">\n            Drop files or click to select\n          </div>\n          <div className=\"text-xs text-slate-500 mt-1\">\n            Accepted: {typeLabels}\n          </div>\n        </label>\n\n        {pendingFiles.length > 0 && (\n          <div className=\"space-y-3 max-h-56 overflow-y-auto pr-1\">\n            {pendingFiles.map((pf) => (\n              <div\n                key={pf.file.name}\n                className=\"border border-slate-800 rounded-md p-3 bg-slate-950/60\"\n              >\n                <div className=\"flex items-center justify-between\">\n                  <div>\n                    <div className=\"text-sm font-medium text-slate-100\">\n                      {pf.file.name}\n                    </div>\n                    <div className=\"text-xs text-slate-500\">\n                      {formatSize(pf.file.size)}\n                    </div>\n                  </div>\n                  {pf.error ? (\n                    <span className=\"text-xs text-amber-400\">{pf.error}</span>\n                  ) : (\n                    <span className=\"text-xs text-slate-400\">\n                      {Math.round(pf.progress)}%\n                    </span>\n                  )}\n                </div>\n                {!pf.error && (\n                  <div className=\"mt-2 h-2 bg-slate-800 rounded-full overflow-hidden\">\n                    <div\n                      className=\"h-full bg-blue-500 transition-all\"\n                      style={{ width: `${Math.min(100, pf.progress)}%` }}\n                    />\n                  </div>\n                )}\n              </div>\n            ))}\n          </div>\n        )}\n\n        {submitError && (\n          <div className=\"text-sm text-amber-300 bg-amber-950/40 border border-amber-900 rounded-md p-3\">\n            {submitError}\n          </div>\n        )}\n\n        <div className=\"flex items-center justify-end gap-2\">\n          <button\n            className=\"px-4 py-2 text-sm text-slate-300 hover:text-white\"\n            onClick={onClose}\n            disabled={submitting}\n          >\n            Cancel\n          </button>\n          <button\n            className={`px-4 py-2 rounded-md text-sm font-medium transition-colors ${\n              hasBlockingErrors || pendingFiles.length === 0\n                ? \"bg-slate-800 text-slate-500 cursor-not-allowed\"\n                : \"bg-blue-600 hover:bg-blue-700 text-white\"\n            } ${submitting ? \"opacity-80\" : \"\"}`}\n            onClick={submitFiles}\n            disabled={\n              hasBlockingErrors || pendingFiles.length === 0 || submitting\n            }\n          >\n            {submitting ? \"Uploading…\" : \"Start upload\"}\n          </button>\n        </div>\n      </div>\n    </div>\n  );\n}\n"
}

{
  "path": "apps/web-app/src/components/citations/CitationSidebar.tsx",
  "language": "typescript",
  "size": 17115,
  "last_modified": "2025-11-29T04:27:41.404Z",
  "lines": 472,
  "content": "/**\n * Citation Sidebar\n * Display and navigate all citations from the current conversation\n */\n\nimport { useState, useMemo } from \"react\";\nimport { CitationDisplay } from \"../chat/CitationDisplay\";\nimport type { Citation } from \"../../types\";\nimport type { Message } from \"@voiceassist/types\";\n\n/** Type filter options */\ntype TypeFilter =\n  | \"all\"\n  | \"kb\"\n  | \"pubmed\"\n  | \"guideline\"\n  | \"openevidence\"\n  | \"external\";\n\n/** Citation with message reference for jump-to functionality */\ninterface CitationWithMessage {\n  citation: Citation;\n  messageId: string;\n  messageRole: string;\n  messageIndex: number;\n}\n\nexport interface CitationSidebarProps {\n  isOpen: boolean;\n  onClose: () => void;\n  messages: Message[];\n  /** Called when user clicks jump-to for a citation */\n  onJumpToMessage?: (messageId: string) => void;\n}\n\nexport function CitationSidebar({\n  isOpen,\n  onClose,\n  messages,\n  onJumpToMessage,\n}: CitationSidebarProps) {\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [typeFilter, setTypeFilter] = useState<TypeFilter>(\"all\");\n  const [messageFilter, setMessageFilter] = useState<string>(\"all\");\n\n  // Aggregate all citations from all messages with message references\n  const { allCitationsWithMessages, messageOptions } = useMemo(() => {\n    const citationsMap = new Map<string, CitationWithMessage>();\n    const messagesWithCitations: Array<{\n      id: string;\n      label: string;\n      index: number;\n    }> = [];\n\n    messages.forEach((message, index) => {\n      // Check metadata.citations first, then top-level citations\n      const citations = message.metadata?.citations || message.citations || [];\n\n      if (citations.length > 0) {\n        // Build message label for filter dropdown\n        const roleLabel = message.role === \"user\" ? \"You\" : \"Assistant\";\n        const timestamp = new Date(message.timestamp).toLocaleTimeString(\n          \"en-US\",\n          {\n            hour: \"2-digit\",\n            minute: \"2-digit\",\n          },\n        );\n        messagesWithCitations.push({\n          id: message.id,\n          label: `${roleLabel} Â· ${timestamp}`,\n          index: index + 1,\n        });\n\n        citations.forEach((citation: Citation) => {\n          if (!citationsMap.has(citation.id)) {\n            citationsMap.set(citation.id, {\n              citation,\n              messageId: message.id,\n              messageRole: message.role,\n              messageIndex: index + 1,\n            });\n          }\n        });\n      }\n    });\n\n    return {\n      allCitationsWithMessages: Array.from(citationsMap.values()),\n      messageOptions: messagesWithCitations,\n    };\n  }, [messages]);\n\n  // Get unique citations for display count\n  const allCitations = useMemo(\n    () => allCitationsWithMessages.map((c) => c.citation),\n    [allCitationsWithMessages],\n  );\n\n  // Helper to determine citation type category\n  const getCitationType = (citation: Citation): TypeFilter => {\n    // Check for guidelines first (sourceType takes precedence)\n    if (\n      citation.sourceType === \"guideline\" ||\n      citation.title?.toLowerCase().includes(\"guideline\")\n    ) {\n      return \"guideline\";\n    }\n    if (\n      citation.sourceType === \"openevidence\" ||\n      citation.source === \"openevidence\"\n    ) {\n      return \"openevidence\";\n    }\n    // Check for PubMed (source or pubmedId, not just DOI)\n    if (citation.source === \"pubmed\" || citation.pubmedId) {\n      return \"pubmed\";\n    }\n    // KB is the default for knowledge base\n    if (citation.source === \"kb\") {\n      return \"kb\";\n    }\n    // Default to external bucket for everything else\n    return \"external\";\n  };\n\n  // Filter citations based on search, type, and message filters\n  const filteredCitationsWithMessages = useMemo(() => {\n    return allCitationsWithMessages.filter((item) => {\n      const { citation, messageId } = item;\n\n      // Type filter\n      if (typeFilter !== \"all\" && getCitationType(citation) !== typeFilter) {\n        return false;\n      }\n\n      // Message filter\n      if (messageFilter !== \"all\" && messageId !== messageFilter) {\n        return false;\n      }\n\n      // Search filter\n      if (searchQuery.trim()) {\n        const query = searchQuery.toLowerCase();\n        const searchableText = [\n          citation.title,\n          citation.subtitle,\n          citation.reference,\n          citation.snippet,\n          citation.authors?.join(\" \"),\n          citation.location,\n          citation.doi,\n          citation.pubmedId,\n        ]\n          .filter(Boolean)\n          .join(\" \")\n          .toLowerCase();\n\n        if (!searchableText.includes(query)) {\n          return false;\n        }\n      }\n\n      return true;\n    });\n  }, [allCitationsWithMessages, typeFilter, messageFilter, searchQuery]);\n\n  // Extract just the citations for CitationDisplay\n  const filteredCitations = useMemo(\n    () => filteredCitationsWithMessages.map((c) => c.citation),\n    [filteredCitationsWithMessages],\n  );\n\n  if (!isOpen) {\n    return null;\n  }\n\n  const hasCitations = allCitations.length > 0;\n\n  return (\n    <div className=\"fixed inset-0 z-50 md:relative md:inset-auto md:z-auto\">\n      {/* Backdrop (mobile only) */}\n      <div\n        className=\"fixed inset-0 bg-black/50 md:hidden\"\n        onClick={onClose}\n        aria-hidden=\"true\"\n      />\n\n      {/* Sidebar */}\n      <div\n        className=\"fixed right-0 top-0 h-full w-96 bg-white dark:bg-neutral-900 border-l border-neutral-200 dark:border-neutral-700 shadow-lg md:relative md:w-80 md:shadow-none overflow-y-auto\"\n        role=\"complementary\"\n        aria-label=\"Citations\"\n      >\n        {/* Header */}\n        <div className=\"sticky top-0 bg-white dark:bg-neutral-900 border-b border-neutral-200 dark:border-neutral-700 px-4 py-3 flex items-center justify-between z-10\">\n          <h2 className=\"text-lg font-semibold text-neutral-900 dark:text-neutral-100\">\n            Citations\n          </h2>\n          <div className=\"flex items-center gap-2\">\n            {hasCitations && (\n              <span className=\"text-sm text-neutral-600 dark:text-neutral-400\">\n                {filteredCitations.length} of {allCitations.length}\n              </span>\n            )}\n            <button\n              onClick={onClose}\n              className=\"md:hidden p-2 rounded-lg hover:bg-neutral-100 dark:hover:bg-neutral-800 transition-colors\"\n              aria-label=\"Close citation sidebar\"\n            >\n              <svg\n                xmlns=\"http://www.w3.org/2000/svg\"\n                fill=\"none\"\n                viewBox=\"0 0 24 24\"\n                strokeWidth={1.5}\n                stroke=\"currentColor\"\n                className=\"w-5 h-5 text-neutral-600 dark:text-neutral-400\"\n              >\n                <path\n                  strokeLinecap=\"round\"\n                  strokeLinejoin=\"round\"\n                  d=\"M6 18L18 6M6 6l12 12\"\n                />\n              </svg>\n            </button>\n          </div>\n        </div>\n\n        {/* Filters Section */}\n        {hasCitations && (\n          <div className=\"px-4 py-3 border-b border-neutral-200 dark:border-neutral-700 space-y-3\">\n            {/* Search Bar */}\n            <div className=\"relative\">\n              <input\n                type=\"text\"\n                placeholder=\"Search citations...\"\n                value={searchQuery}\n                onChange={(e) => setSearchQuery(e.target.value)}\n                className=\"w-full pl-10 pr-4 py-2 text-sm border border-neutral-300 dark:border-neutral-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-neutral-800 dark:text-neutral-100\"\n                data-testid=\"citation-search-input\"\n              />\n              <svg\n                xmlns=\"http://www.w3.org/2000/svg\"\n                fill=\"none\"\n                viewBox=\"0 0 24 24\"\n                strokeWidth={1.5}\n                stroke=\"currentColor\"\n                className=\"w-5 h-5 absolute left-3 top-2.5 text-neutral-400\"\n              >\n                <path\n                  strokeLinecap=\"round\"\n                  strokeLinejoin=\"round\"\n                  d=\"M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z\"\n                />\n              </svg>\n              {searchQuery && (\n                <button\n                  onClick={() => setSearchQuery(\"\")}\n                  className=\"absolute right-3 top-2.5 text-neutral-400 hover:text-neutral-600 dark:hover:text-neutral-300\"\n                  aria-label=\"Clear search\"\n                >\n                  <svg\n                    xmlns=\"http://www.w3.org/2000/svg\"\n                    fill=\"none\"\n                    viewBox=\"0 0 24 24\"\n                    strokeWidth={2}\n                    stroke=\"currentColor\"\n                    className=\"w-4 h-4\"\n                  >\n                    <path\n                      strokeLinecap=\"round\"\n                      strokeLinejoin=\"round\"\n                      d=\"M6 18L18 6M6 6l12 12\"\n                    />\n                  </svg>\n                </button>\n              )}\n            </div>\n\n            {/* Type Filter Pills */}\n            <div\n              className=\"flex flex-wrap gap-2\"\n              role=\"group\"\n              aria-label=\"Filter by type\"\n            >\n              {(\n                [\n                  { value: \"all\", label: \"All\" },\n                  { value: \"kb\", label: \"Knowledge Base\" },\n                  { value: \"pubmed\", label: \"PubMed / DOI\" },\n                  { value: \"guideline\", label: \"Guidelines\" },\n                  { value: \"openevidence\", label: \"OpenEvidence\" },\n                  { value: \"external\", label: \"External\" },\n                ] as const\n              )\n                .filter(\n                  (option) =>\n                    option.value === \"all\" ||\n                    allCitations.some(\n                      (citation) => getCitationType(citation) === option.value,\n                    ),\n                )\n                .map((option) => (\n                  <button\n                    key={option.value}\n                    type=\"button\"\n                    onClick={() => setTypeFilter(option.value)}\n                    className={`px-2.5 py-1 text-xs font-medium rounded-full transition-colors ${\n                      typeFilter === option.value\n                        ? \"bg-primary-500 text-white\"\n                        : \"bg-neutral-100 dark:bg-neutral-700 text-neutral-700 dark:text-neutral-300 hover:bg-neutral-200 dark:hover:bg-neutral-600\"\n                    }`}\n                    aria-pressed={typeFilter === option.value}\n                    data-testid={`type-filter-${option.value}`}\n                  >\n                    {option.label}\n                  </button>\n                ))}\n            </div>\n\n            {/* Message Filter Dropdown */}\n            {messageOptions.length > 1 && (\n              <div>\n                <label\n                  htmlFor=\"message-filter\"\n                  className=\"block text-xs font-medium text-neutral-600 dark:text-neutral-400 mb-1\"\n                >\n                  Filter by message\n                </label>\n                <select\n                  id=\"message-filter\"\n                  value={messageFilter}\n                  onChange={(e) => setMessageFilter(e.target.value)}\n                  className=\"w-full px-3 py-1.5 text-sm border border-neutral-300 dark:border-neutral-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-neutral-800 dark:text-neutral-100\"\n                  data-testid=\"message-filter-select\"\n                >\n                  <option value=\"all\">All messages</option>\n                  {messageOptions.map((msg) => (\n                    <option key={msg.id} value={msg.id}>\n                      Message #{msg.index} ({msg.label})\n                    </option>\n                  ))}\n                </select>\n              </div>\n            )}\n          </div>\n        )}\n\n        {/* Content */}\n        <div className=\"p-4\">\n          {!hasCitations ? (\n            // Empty state\n            <div className=\"text-center py-12\">\n              <svg\n                xmlns=\"http://www.w3.org/2000/svg\"\n                fill=\"none\"\n                viewBox=\"0 0 24 24\"\n                strokeWidth={1.5}\n                stroke=\"currentColor\"\n                className=\"w-16 h-16 mx-auto mb-4 text-neutral-300\"\n              >\n                <path\n                  strokeLinecap=\"round\"\n                  strokeLinejoin=\"round\"\n                  d=\"M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25\"\n                />\n              </svg>\n              <p className=\"text-sm text-neutral-600 dark:text-neutral-400 mb-2\">\n                No citations yet\n              </p>\n              <p className=\"text-xs text-neutral-500 dark:text-neutral-500\">\n                Citations will appear here as you chat\n              </p>\n            </div>\n          ) : filteredCitations.length === 0 ? (\n            // No results from search\n            <div className=\"text-center py-12\">\n              <svg\n                xmlns=\"http://www.w3.org/2000/svg\"\n                fill=\"none\"\n                viewBox=\"0 0 24 24\"\n                strokeWidth={1.5}\n                stroke=\"currentColor\"\n                className=\"w-16 h-16 mx-auto mb-4 text-neutral-300\"\n              >\n                <path\n                  strokeLinecap=\"round\"\n                  strokeLinejoin=\"round\"\n                  d=\"M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z\"\n                />\n              </svg>\n              <p className=\"text-sm text-neutral-600 dark:text-neutral-400 mb-2\">\n                No citations found\n              </p>\n              <p className=\"text-xs text-neutral-500 dark:text-neutral-500\">\n                Try adjusting your search query\n              </p>\n            </div>\n          ) : (\n            // Display citations with jump-to functionality\n            <div className=\"space-y-4\">\n              {filteredCitationsWithMessages.map((item) => (\n                <div\n                  key={item.citation.id}\n                  className=\"bg-neutral-50 dark:bg-neutral-800 rounded-lg p-3 border border-neutral-200 dark:border-neutral-700\"\n                  data-testid={`citation-item-${item.citation.id}`}\n                >\n                  {/* Citation content */}\n                  <CitationDisplay\n                    citations={[item.citation]}\n                    enableExport={true}\n                  />\n\n                  {/* Jump to message button */}\n                  {onJumpToMessage && (\n                    <button\n                      type=\"button\"\n                      onClick={() => onJumpToMessage(item.messageId)}\n                      className=\"mt-2 w-full flex items-center justify-center gap-1.5 px-3 py-1.5 text-xs font-medium text-primary-600 dark:text-primary-400 bg-primary-50 dark:bg-primary-900/20 hover:bg-primary-100 dark:hover:bg-primary-900/40 rounded-md transition-colors\"\n                      data-testid={`jump-to-message-${item.citation.id}`}\n                    >\n                      <svg\n                        xmlns=\"http://www.w3.org/2000/svg\"\n                        fill=\"none\"\n                        viewBox=\"0 0 24 24\"\n                        strokeWidth={1.5}\n                        stroke=\"currentColor\"\n                        className=\"w-3.5 h-3.5\"\n                      >\n                        <path\n                          strokeLinecap=\"round\"\n                          strokeLinejoin=\"round\"\n                          d=\"M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3\"\n                        />\n                      </svg>\n                      Jump to message #{item.messageIndex}\n                    </button>\n                  )}\n                </div>\n              ))}\n            </div>\n          )}\n        </div>\n\n        {/* Footer Info */}\n        <div className=\"sticky bottom-0 bg-neutral-50 dark:bg-neutral-800 border-t border-neutral-200 dark:border-neutral-700 px-4 py-3\">\n          <div className=\"flex items-start gap-2 text-xs text-neutral-600 dark:text-neutral-400\">\n            <svg\n              xmlns=\"http://www.w3.org/2000/svg\"\n              fill=\"none\"\n              viewBox=\"0 0 24 24\"\n              strokeWidth={1.5}\n              stroke=\"currentColor\"\n              className=\"w-4 h-4 flex-shrink-0 text-blue-600 mt-0.5\"\n            >\n              <path\n                strokeLinecap=\"round\"\n                strokeLinejoin=\"round\"\n                d=\"M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z\"\n              />\n            </svg>\n            <p>\n              Citations are automatically collected from AI responses and\n              provide sources for medical information.\n            </p>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n"
}

{
  "path": "services/api-gateway/app/api/admin_user_flag_overrides.py",
  "language": "python",
  "size": 20263,
  "last_modified": "2025-12-04T21:30:58.281Z",
  "lines": 607,
  "content": "\"\"\"Admin User Flag Overrides API (Phase 4).\n\nProvides admin endpoints for managing per-user feature flag overrides.\nEnables:\n- Beta testing with select users\n- Debugging with forced flag states\n- Personalized feature experiences\n\nRequires admin authentication (RBAC).\n\"\"\"\n\nfrom __future__ import annotations\n\nfrom datetime import datetime\nfrom typing import Any, Dict, List, Optional\nfrom uuid import UUID\n\nfrom app.core.api_envelope import ErrorCodes, error_response, success_response\nfrom app.core.database import get_db\nfrom app.core.dependencies import ensure_admin_privileges, get_current_admin_or_viewer\nfrom app.core.logging import get_logger\nfrom app.models.user import User\nfrom app.services.user_flag_override_service import user_flag_override_service\nfrom fastapi import APIRouter, Depends, Path, Query, status\nfrom pydantic import BaseModel, Field\nfrom sqlalchemy.orm import Session\n\nrouter = APIRouter(prefix=\"/api/admin\", tags=[\"admin\", \"feature-flags\", \"user-overrides\"])\nlogger = get_logger(__name__)\n\n\n# Request/Response Models\n\n\nclass UserOverrideCreate(BaseModel):\n    \"\"\"Request model for creating a user flag override.\"\"\"\n\n    flag_name: str = Field(..., description=\"Feature flag name to override\", max_length=255)\n    value: Any = Field(..., description=\"Override value (JSON-serializable)\")\n    enabled: bool = Field(default=True, description=\"Whether override is active\")\n    reason: Optional[str] = Field(default=None, description=\"Audit reason for override\", max_length=500)\n    expires_at: Optional[datetime] = Field(default=None, description=\"Optional expiration datetime\")\n    metadata: Optional[Dict[str, Any]] = Field(default=None, description=\"Additional metadata\")\n\n\nclass UserOverrideUpdate(BaseModel):\n    \"\"\"Request model for updating a user flag override.\"\"\"\n\n    value: Optional[Any] = Field(default=None, description=\"New override value\")\n    enabled: Optional[bool] = Field(default=None, description=\"New enabled state\")\n    reason: Optional[str] = Field(default=None, description=\"Updated reason\", max_length=500)\n    expires_at: Optional[datetime] = Field(default=None, description=\"New expiration datetime\")\n    metadata: Optional[Dict[str, Any]] = Field(default=None, description=\"Updated metadata\")\n\n\nclass UserOverrideResponse(BaseModel):\n    \"\"\"Response model for a user flag override.\"\"\"\n\n    id: str\n    user_id: str\n    flag_name: str\n    value: Any\n    enabled: bool\n    reason: Optional[str]\n    created_by: Optional[str]\n    created_at: str\n    updated_at: str\n    expires_at: Optional[str]\n    metadata: Optional[Dict[str, Any]]\n\n\nclass UserOverrideListResponse(BaseModel):\n    \"\"\"Response model for listing user overrides.\"\"\"\n\n    overrides: List[UserOverrideResponse]\n    total: int\n\n\n# User-centric endpoints\n\n\n@router.get(\"/users/{user_id}/flag-overrides\", response_model=None)\nasync def list_user_overrides(\n    user_id: UUID = Path(..., description=\"User ID\"),\n    include_expired: bool = Query(False, description=\"Include expired overrides\"),\n    db: Session = Depends(get_db),\n    current_admin_user: User = Depends(get_current_admin_or_viewer),\n):\n    \"\"\"List all flag overrides for a specific user.\n\n    Returns all feature flag overrides for the given user,\n    optionally including expired ones.\n\n    Requires: Admin or Viewer authentication\n    \"\"\"\n    try:\n        overrides = await user_flag_override_service.get_user_overrides(\n            user_id=user_id,\n            db=db,\n            include_expired=include_expired,\n        )\n\n        # Convert to list format\n        override_list = list(overrides.values())\n\n        logger.info(f\"Admin {current_admin_user.email} listed {len(override_list)} overrides for user {user_id}\")\n\n        return success_response(\n            data={\n                \"overrides\": override_list,\n                \"total\": len(override_list),\n                \"user_id\": str(user_id),\n            },\n            version=\"2.0.0\",\n        )\n    except Exception as e:\n        logger.error(f\"Failed to list user overrides: {e}\", exc_info=True)\n        return error_response(\n            code=ErrorCodes.INTERNAL_ERROR,\n            message=\"Failed to list user overrides\",\n        )\n\n\n@router.post(\"/users/{user_id}/flag-overrides\", status_code=status.HTTP_201_CREATED, response_model=None)\nasync def create_user_override(\n    user_id: UUID = Path(..., description=\"User ID\"),\n    override: UserOverrideCreate = ...,\n    db: Session = Depends(get_db),\n    current_admin_user: User = Depends(get_current_admin_or_viewer),\n):\n    \"\"\"Create a new flag override for a user.\n\n    Creates a per-user override for a specific feature flag.\n    If an override already exists, it will be updated.\n\n    Requires: Admin authentication (not Viewer)\n    \"\"\"\n    ensure_admin_privileges(current_admin_user)\n    try:\n        result = await user_flag_override_service.set_override(\n            user_id=user_id,\n            flag_name=override.flag_name,\n            value=override.value,\n            created_by=current_admin_user.email,\n            enabled=override.enabled,\n            reason=override.reason,\n            expires_at=override.expires_at,\n            metadata=override.metadata,\n            db=db,\n        )\n\n        logger.info(\n            f\"Admin {current_admin_user.email} created override for user {user_id}, \" f\"flag {override.flag_name}\"\n        )\n\n        return success_response(data=result, version=\"2.0.0\")\n    except Exception as e:\n        logger.error(f\"Failed to create user override: {e}\", exc_info=True)\n        return error_response(\n            code=ErrorCodes.INTERNAL_ERROR,\n            message=\"Failed to create user override\",\n        )\n\n\n@router.get(\"/users/{user_id}/flag-overrides/{flag_name}\", response_model=None)\nasync def get_user_override(\n    user_id: UUID = Path(..., description=\"User ID\"),\n    flag_name: str = Path(..., description=\"Feature flag name\"),\n    db: Session = Depends(get_db),\n    current_admin_user: User = Depends(get_current_admin_or_viewer),\n):\n    \"\"\"Get a specific override for a user and flag.\n\n    Returns the override details if it exists.\n\n    Requires: Admin or Viewer authentication\n    \"\"\"\n    try:\n        override = await user_flag_override_service.get_override(\n            user_id=user_id,\n            flag_name=flag_name,\n            db=db,\n        )\n\n        if not override:\n            return error_response(\n                code=ErrorCodes.NOT_FOUND,\n                message=f\"No override found for user {user_id} and flag {flag_name}\",\n                http_status=status.HTTP_404_NOT_FOUND,\n            )\n\n        logger.info(f\"Admin {current_admin_user.email} retrieved override for user {user_id}, \" f\"flag {flag_name}\")\n\n        return success_response(data=override, version=\"2.0.0\")\n    except Exception as e:\n        logger.error(f\"Failed to get user override: {e}\", exc_info=True)\n        return error_response(\n            code=ErrorCodes.INTERNAL_ERROR,\n            message=\"Failed to get user override\",\n        )\n\n\n@router.patch(\"/users/{user_id}/flag-overrides/{flag_name}\", response_model=None)\nasync def update_user_override(\n    user_id: UUID = Path(..., description=\"User ID\"),\n    flag_name: str = Path(..., description=\"Feature flag name\"),\n    update: UserOverrideUpdate = ...,\n    db: Session = Depends(get_db),\n    current_admin_user: User = Depends(get_current_admin_or_viewer),\n):\n    \"\"\"Update an existing user flag override.\n\n    Only the provided fields will be updated.\n\n    Requires: Admin authentication (not Viewer)\n    \"\"\"\n    ensure_admin_privileges(current_admin_user)\n    try:\n        # Get existing override\n        existing = await user_flag_override_service.get_override(\n            user_id=user_id,\n            flag_name=flag_name,\n            db=db,\n        )\n\n        if not existing:\n            return error_response(\n                code=ErrorCodes.NOT_FOUND,\n                message=f\"No override found for user {user_id} and flag {flag_name}\",\n                http_status=status.HTTP_404_NOT_FOUND,\n            )\n\n        # Merge existing with updates\n        new_value = update.value if update.value is not None else existing.get(\"value\")\n        new_enabled = update.enabled if update.enabled is not None else existing.get(\"enabled\", True)\n        new_reason = update.reason if update.reason is not None else existing.get(\"reason\")\n        new_expires = update.expires_at if update.expires_at is not None else existing.get(\"expires_at\")\n        new_metadata = update.metadata if update.metadata is not None else existing.get(\"metadata\")\n\n        result = await user_flag_override_service.set_override(\n            user_id=user_id,\n            flag_name=flag_name,\n            value=new_value,\n            created_by=existing.get(\"created_by\") or current_admin_user.email,\n            enabled=new_enabled,\n            reason=new_reason,\n            expires_at=new_expires,\n            metadata=new_metadata,\n            updated_by=current_admin_user.email,  # Track who made this update\n            db=db,\n        )\n\n        logger.info(f\"Admin {current_admin_user.email} updated override for user {user_id}, \" f\"flag {flag_name}\")\n\n        return success_response(data=result, version=\"2.0.0\")\n    except Exception as e:\n        logger.error(f\"Failed to update user override: {e}\", exc_info=True)\n        return error_response(\n            code=ErrorCodes.INTERNAL_ERROR,\n            message=\"Failed to update user override\",\n        )\n\n\n@router.delete(\"/users/{user_id}/flag-overrides/{flag_name}\", response_model=None)\nasync def delete_user_override(\n    user_id: UUID = Path(..., description=\"User ID\"),\n    flag_name: str = Path(..., description=\"Feature flag name\"),\n    db: Session = Depends(get_db),\n    current_admin_user: User = Depends(get_current_admin_or_viewer),\n):\n    \"\"\"Delete a user flag override.\n\n    Permanently removes the override.\n\n    Requires: Admin authentication (not Viewer)\n    \"\"\"\n    ensure_admin_privileges(current_admin_user)\n    try:\n        deleted = await user_flag_override_service.remove_override(\n            user_id=user_id,\n            flag_name=flag_name,\n            db=db,\n        )\n\n        if not deleted:\n            return error_response(\n                code=ErrorCodes.NOT_FOUND,\n                message=f\"No override found for user {user_id} and flag {flag_name}\",\n                http_status=status.HTTP_404_NOT_FOUND,\n            )\n\n        logger.info(f\"Admin {current_admin_user.email} deleted override for user {user_id}, \" f\"flag {flag_name}\")\n\n        return success_response(\n            data={\"message\": \"Override deleted successfully\"},\n            version=\"2.0.0\",\n        )\n    except Exception as e:\n        logger.error(f\"Failed to delete user override: {e}\", exc_info=True)\n        return error_response(\n            code=ErrorCodes.INTERNAL_ERROR,\n            message=\"Failed to delete user override\",\n        )\n\n\n# Flag-centric endpoints\n\n\n@router.get(\"/feature-flags/{flag_name}/user-overrides\", response_model=None)\nasync def list_flag_user_overrides(\n    flag_name: str = Path(..., description=\"Feature flag name\"),\n    limit: int = Query(100, ge=1, le=1000, description=\"Maximum results\"),\n    offset: int = Query(0, ge=0, description=\"Pagination offset\"),\n    db: Session = Depends(get_db),\n    current_admin_user: User = Depends(get_current_admin_or_viewer),\n):\n    \"\"\"List all user overrides for a specific flag.\n\n    Returns all users who have overrides for this flag.\n\n    Requires: Admin or Viewer authentication\n    \"\"\"\n    try:\n        overrides = await user_flag_override_service.list_overrides_for_flag(\n            flag_name=flag_name,\n            db=db,\n            limit=limit,\n            offset=offset,\n        )\n\n        total = await user_flag_override_service.count_overrides_for_flag(\n            flag_name=flag_name,\n            db=db,\n        )\n\n        logger.info(f\"Admin {current_admin_user.email} listed {len(overrides)} user overrides \" f\"for flag {flag_name}\")\n\n        return success_response(\n            data={\n                \"overrides\": overrides,\n                \"total\": total,\n                \"flag_name\": flag_name,\n                \"limit\": limit,\n                \"offset\": offset,\n            },\n            version=\"2.0.0\",\n        )\n    except Exception as e:\n        logger.error(f\"Failed to list flag user overrides: {e}\", exc_info=True)\n        return error_response(\n            code=ErrorCodes.INTERNAL_ERROR,\n            message=\"Failed to list flag user overrides\",\n        )\n\n\n# Current user endpoint\n\n\n@router.get(\"/flags/me\", response_model=None)\nasync def get_current_user_flags(\n    db: Session = Depends(get_db),\n    current_admin_user: User = Depends(get_current_admin_or_viewer),\n):\n    \"\"\"Get current user's flag values including overrides.\n\n    Returns all feature flag values for the authenticated user,\n    with any active overrides applied.\n\n    Requires: Admin or Viewer authentication\n    \"\"\"\n    try:\n        # Get user's overrides\n        overrides = await user_flag_override_service.get_user_overrides(\n            user_id=current_admin_user.id,\n            db=db,\n            include_expired=False,\n        )\n\n        logger.info(f\"User {current_admin_user.email} retrieved their flag overrides \" f\"({len(overrides)} active)\")\n\n        return success_response(\n            data={\n                \"user_id\": str(current_admin_user.id),\n                \"overrides\": overrides,\n                \"override_count\": len(overrides),\n            },\n            version=\"2.0.0\",\n        )\n    except Exception as e:\n        logger.error(f\"Failed to get current user flags: {e}\", exc_info=True)\n        return error_response(\n            code=ErrorCodes.INTERNAL_ERROR,\n            message=\"Failed to get current user flags\",\n        )\n\n\n# Resolution endpoint - get all flags with source\n\n\n@router.get(\"/users/{user_id}/flags/resolved\", response_model=None)\nasync def get_resolved_flags_for_user(\n    user_id: UUID = Path(..., description=\"User ID\"),\n    db: Session = Depends(get_db),\n    current_admin_user: User = Depends(get_current_admin_or_viewer),\n):\n    \"\"\"Get all feature flags for a user with resolution source.\n\n    Returns all flags with their effective values and the source\n    of the value (override, segmentation, scheduled, or default).\n    Useful for debugging and user support.\n\n    Requires: Admin or Viewer authentication\n    \"\"\"\n    try:\n        flags = await user_flag_override_service.get_all_flags_for_user(\n            user_id=user_id,\n            db=db,\n        )\n\n        logger.info(f\"Admin {current_admin_user.email} retrieved resolved flags for user {user_id}\")\n\n        return success_response(\n            data={\n                \"user_id\": str(user_id),\n                \"flags\": flags,\n                \"flag_count\": len(flags),\n            },\n            version=\"2.0.0\",\n        )\n    except Exception as e:\n        logger.error(f\"Failed to get resolved flags: {e}\", exc_info=True)\n        return error_response(\n            code=ErrorCodes.INTERNAL_ERROR,\n            message=\"Failed to get resolved flags\",\n        )\n\n\n# Bulk operations\n\n\nclass BulkOverrideCreate(BaseModel):\n    \"\"\"Request model for bulk override creation.\"\"\"\n\n    overrides: List[Dict[str, Any]] = Field(\n        ...,\n        description=\"List of override specs\",\n        min_length=1,\n        max_length=100,\n    )\n\n\n@router.post(\"/flag-overrides/bulk\", status_code=status.HTTP_201_CREATED, response_model=None)\nasync def bulk_create_overrides(\n    bulk_request: BulkOverrideCreate,\n    db: Session = Depends(get_db),\n    current_admin_user: User = Depends(get_current_admin_or_viewer),\n):\n    \"\"\"Create or update multiple flag overrides in a single request.\n\n    Each override spec should contain:\n    - user_id: UUID\n    - flag_name: str\n    - value: Any\n    - enabled: bool (optional, default True)\n    - reason: str (optional)\n    - expires_at: datetime (optional)\n    - metadata: dict (optional)\n\n    Requires: Admin authentication\n    \"\"\"\n    ensure_admin_privileges(current_admin_user)\n    try:\n        result = await user_flag_override_service.bulk_set_overrides(\n            overrides=bulk_request.overrides,\n            created_by=current_admin_user.email,\n            db=db,\n        )\n\n        logger.info(\n            f\"Admin {current_admin_user.email} bulk created/updated overrides: \"\n            f\"{result['created']} created, {result['updated']} updated\"\n        )\n\n        return success_response(data=result, version=\"2.0.0\")\n    except Exception as e:\n        logger.error(f\"Failed to bulk create overrides: {e}\", exc_info=True)\n        return error_response(\n            code=ErrorCodes.INTERNAL_ERROR,\n            message=\"Failed to bulk create overrides\",\n        )\n\n\nclass BulkOverrideDelete(BaseModel):\n    \"\"\"Request model for bulk override deletion.\"\"\"\n\n    user_ids: List[UUID] = Field(\n        ...,\n        description=\"List of user IDs\",\n        min_length=1,\n        max_length=100,\n    )\n    flag_name: Optional[str] = Field(\n        default=None,\n        description=\"Optional flag name filter\",\n    )\n\n\n@router.delete(\"/flag-overrides/bulk\", response_model=None)\nasync def bulk_delete_overrides(\n    bulk_request: BulkOverrideDelete,\n    db: Session = Depends(get_db),\n    current_admin_user: User = Depends(get_current_admin_or_viewer),\n):\n    \"\"\"Delete flag overrides for multiple users.\n\n    Optionally filter by flag name.\n\n    Requires: Admin authentication\n    \"\"\"\n    ensure_admin_privileges(current_admin_user)\n    try:\n        count = await user_flag_override_service.bulk_delete_overrides(\n            user_ids=bulk_request.user_ids,\n            flag_name=bulk_request.flag_name,\n            db=db,\n        )\n\n        logger.info(f\"Admin {current_admin_user.email} bulk deleted {count} overrides\")\n\n        return success_response(\n            data={\n                \"message\": f\"Deleted {count} overrides\",\n                \"deleted_count\": count,\n            },\n            version=\"2.0.0\",\n        )\n    except Exception as e:\n        logger.error(f\"Failed to bulk delete overrides: {e}\", exc_info=True)\n        return error_response(\n            code=ErrorCodes.INTERNAL_ERROR,\n            message=\"Failed to bulk delete overrides\",\n        )\n\n\n# Statistics endpoint\n\n\n@router.get(\"/flag-overrides/stats\", response_model=None)\nasync def get_override_statistics(\n    db: Session = Depends(get_db),\n    current_admin_user: User = Depends(get_current_admin_or_viewer),\n):\n    \"\"\"Get statistics about user flag overrides.\n\n    Returns counts and breakdowns useful for monitoring.\n\n    Requires: Admin or Viewer authentication\n    \"\"\"\n    try:\n        stats = await user_flag_override_service.get_override_stats(db=db)\n\n        logger.info(f\"Admin {current_admin_user.email} retrieved override statistics\")\n\n        return success_response(data=stats, version=\"2.0.0\")\n    except Exception as e:\n        logger.error(f\"Failed to get override statistics: {e}\", exc_info=True)\n        return error_response(\n            code=ErrorCodes.INTERNAL_ERROR,\n            message=\"Failed to get override statistics\",\n        )\n\n\n# Cleanup endpoint\n\n\n@router.post(\"/flag-overrides/cleanup\", response_model=None)\nasync def cleanup_expired_overrides(\n    db: Session = Depends(get_db),\n    current_admin_user: User = Depends(get_current_admin_or_viewer),\n):\n    \"\"\"Clean up expired user flag overrides.\n\n    Removes all overrides that have passed their expiration time.\n    Should be called periodically by a background task.\n\n    Requires: Admin authentication\n    \"\"\"\n    ensure_admin_privileges(current_admin_user)\n    try:\n        count = await user_flag_override_service.cleanup_expired_overrides(db=db)\n\n        logger.info(f\"Admin {current_admin_user.email} triggered cleanup, \" f\"removed {count} expired overrides\")\n\n        return success_response(\n            data={\n                \"message\": f\"Cleaned up {count} expired overrides\",\n                \"removed_count\": count,\n            },\n            version=\"2.0.0\",\n        )\n    except Exception as e:\n        logger.error(f\"Failed to cleanup expired overrides: {e}\", exc_info=True)\n        return error_response(\n            code=ErrorCodes.INTERNAL_ERROR,\n            message=\"Failed to cleanup expired overrides\",\n        )\n"
}

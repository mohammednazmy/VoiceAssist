{
  "path": "apps/admin-panel/src/components/logs/LogViewer.tsx",
  "language": "typescript",
  "size": 7972,
  "last_modified": "2025-11-27T09:30:11.957Z",
  "lines": 231,
  "content": "import { useCallback, useEffect, useMemo, useState } from \"react\";\nimport { fetchAPI } from \"../../lib/api\";\nimport {\n  ConnectionStatus,\n  websocketService,\n  WebSocketEvent,\n} from \"../../services/websocket\";\nimport { LogFilters, LogFiltersState, LogLevel, Timeframe } from \"./LogFilters\";\n\ntype LogEntryLevel = Exclude<LogLevel, \"all\">;\n\nexport interface LogEntry {\n  id: string;\n  timestamp: string;\n  level: LogEntryLevel;\n  message: string;\n  service?: string;\n  context?: Record<string, unknown>;\n}\n\nconst timeframeToMs: Record<Timeframe, number> = {\n  \"1h\": 60 * 60 * 1000,\n  \"6h\": 6 * 60 * 60 * 1000,\n  \"12h\": 12 * 60 * 60 * 1000,\n  \"24h\": 24 * 60 * 60 * 1000,\n  \"7d\": 7 * 24 * 60 * 60 * 1000,\n};\n\nfunction isRecent(timestamp: string, timeframe: Timeframe) {\n  const windowMs = timeframeToMs[timeframe];\n  const ts = new Date(timestamp).getTime();\n  return Date.now() - ts <= windowMs;\n}\n\nfunction isLogEvent(\n  event: WebSocketEvent,\n): event is WebSocketEvent & { payload: LogEntry } {\n  return event.type === \"log\" || event.type === \"logs:new\";\n}\n\nexport function LogViewer() {\n  const [logs, setLogs] = useState<LogEntry[]>([]);\n  const [filters, setFilters] = useState<LogFiltersState>({\n    timeframe: \"1h\",\n    search: \"\",\n    level: \"all\",\n    service: \"\",\n  });\n  const [connectionStatus, setConnectionStatus] = useState<ConnectionStatus>(\n    websocketService.getStatus(),\n  );\n  const [loading, setLoading] = useState(false);\n  const [error, setError] = useState<string | null>(null);\n  const [lastUpdated, setLastUpdated] = useState<string | null>(null);\n\n  const loadLogs = useCallback(async () => {\n    setLoading(true);\n    try {\n      const params = new URLSearchParams({ range: filters.timeframe });\n\n      if (filters.level !== \"all\") {\n        params.set(\"level\", filters.level);\n      }\n\n      if (filters.service.trim()) {\n        params.set(\"service\", filters.service.trim());\n      }\n\n      if (filters.search.trim()) {\n        params.set(\"search\", filters.search.trim());\n      }\n\n      const data = await fetchAPI<{ logs: LogEntry[] }>(\n        `/api/admin/logs?${params.toString()}`,\n      );\n\n      setLogs(data.logs);\n      setLastUpdated(new Date().toISOString());\n      setError(null);\n    } catch (err: unknown) {\n      const message =\n        err instanceof Error ? err.message : \"Unable to load logs\";\n      setError(message);\n    } finally {\n      setLoading(false);\n    }\n  }, [filters.level, filters.search, filters.service, filters.timeframe]);\n\n  const handleIncomingLog = useCallback(\n    (entry: LogEntry) => {\n      if (!isRecent(entry.timestamp, filters.timeframe)) return;\n      setLogs((current) => [entry, ...current].slice(0, 500));\n      setLastUpdated(new Date().toISOString());\n    },\n    [filters.timeframe],\n  );\n\n  useEffect(() => {\n    const unsubscribeStatus =\n      websocketService.subscribeStatus(setConnectionStatus);\n    const unsubscribeMessages = websocketService.subscribeMessages((event) => {\n      if (!isLogEvent(event)) return;\n      const payload = event.payload as LogEntry;\n      handleIncomingLog(payload);\n    });\n\n    websocketService.connect();\n\n    return () => {\n      unsubscribeStatus();\n      unsubscribeMessages();\n      websocketService.disconnect();\n    };\n  }, [handleIncomingLog]);\n\n  useEffect(() => {\n    loadLogs();\n  }, [loadLogs]);\n\n  const filteredLogs = useMemo(() => {\n    return logs\n      .filter((log) => {\n        const matchesLevel =\n          filters.level === \"all\" || log.level === filters.level;\n        const matchesService =\n          filters.service.trim() === \"\" ||\n          log.service?.toLowerCase().includes(filters.service.toLowerCase());\n        const matchesSearch =\n          filters.search.trim() === \"\" ||\n          log.message.toLowerCase().includes(filters.search.toLowerCase());\n        const withinWindow = isRecent(log.timestamp, filters.timeframe);\n        return matchesLevel && matchesService && matchesSearch && withinWindow;\n      })\n      .sort(\n        (a, b) =>\n          new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime(),\n      );\n  }, [filters.level, filters.search, filters.service, filters.timeframe, logs]);\n\n  return (\n    <div className=\"space-y-4\">\n      <div className=\"flex flex-wrap items-center justify-between gap-3\">\n        <div>\n          <h2 className=\"text-lg font-semibold text-slate-100\">Logs</h2>\n          <p className=\"text-xs text-slate-400\">\n            WebSocket status: {connectionStatus}\n            {lastUpdated &&\n              ` · Last updated ${new Date(lastUpdated).toLocaleTimeString()}`}\n          </p>\n        </div>\n        <div className=\"flex items-center gap-2 text-xs text-slate-300\">\n          <span\n            className={`inline-flex items-center gap-2 px-3 py-1 rounded-full border ${\n              connectionStatus === \"open\"\n                ? \"text-emerald-400 border-emerald-500/50 bg-emerald-500/10\"\n                : \"text-slate-400 border-slate-600 bg-slate-800/60\"\n            }`}\n          >\n            <span className=\"h-2 w-2 rounded-full bg-current\" aria-hidden />\n            {connectionStatus === \"open\" ? \"Streaming\" : \"Idle\"}\n          </span>\n          <button\n            type=\"button\"\n            onClick={loadLogs}\n            className=\"px-3 py-1 rounded-md border border-slate-700 bg-slate-800 text-slate-200 hover:bg-slate-700 transition-colors\"\n          >\n            Refresh\n          </button>\n        </div>\n      </div>\n\n      <LogFilters value={filters} onChange={setFilters} />\n\n      <div className=\"bg-slate-900/60 border border-slate-800 rounded-lg overflow-hidden\">\n        <div className=\"grid grid-cols-12 text-xs font-semibold text-slate-400 bg-slate-900/80 border-b border-slate-800 px-4 py-2\">\n          <span className=\"col-span-3\">Timestamp</span>\n          <span className=\"col-span-2\">Level</span>\n          <span className=\"col-span-2\">Service</span>\n          <span className=\"col-span-5\">Message</span>\n        </div>\n        {loading ? (\n          <div className=\"p-4 text-slate-400 text-sm\">Loading logs…</div>\n        ) : error ? (\n          <div className=\"p-4 text-red-300 text-sm\">{error}</div>\n        ) : filteredLogs.length === 0 ? (\n          <div className=\"p-6 text-slate-400 text-sm\">\n            No logs match the selected filters.\n          </div>\n        ) : (\n          <div className=\"max-h-[480px] overflow-y-auto divide-y divide-slate-800\">\n            {filteredLogs.map((log) => (\n              <div\n                key={log.id}\n                className=\"grid grid-cols-12 text-sm text-slate-200 px-4 py-2 hover:bg-slate-900\"\n              >\n                <span className=\"col-span-3 text-xs text-slate-400\">\n                  {new Date(log.timestamp).toLocaleString()}\n                </span>\n                <span className=\"col-span-2\">\n                  <span\n                    className={`inline-flex px-2 py-0.5 rounded-full text-xs font-semibold uppercase ${\n                      log.level === \"error\"\n                        ? \"bg-red-500/10 text-red-300 border border-red-500/40\"\n                        : log.level === \"warn\"\n                          ? \"bg-amber-500/10 text-amber-200 border border-amber-500/40\"\n                          : log.level === \"info\"\n                            ? \"bg-blue-500/10 text-blue-200 border border-blue-500/40\"\n                            : \"bg-slate-700 text-slate-200 border border-slate-600\"\n                    }`}\n                  >\n                    {log.level}\n                  </span>\n                </span>\n                <span className=\"col-span-2 text-slate-300 truncate\">\n                  {log.service || \"-\"}\n                </span>\n                <span\n                  className=\"col-span-5 text-slate-100 truncate\"\n                  title={log.message}\n                >\n                  {log.message}\n                </span>\n              </div>\n            ))}\n          </div>\n        )}\n      </div>\n    </div>\n  );\n}\n"
}

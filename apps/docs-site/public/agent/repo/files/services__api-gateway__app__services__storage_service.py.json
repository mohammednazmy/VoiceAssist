{
  "path": "services/api-gateway/app/services/storage_service.py",
  "language": "python",
  "size": 6334,
  "last_modified": "2025-12-03T23:50:35.694Z",
  "lines": 203,
  "content": "\"\"\"\nStorage service for file uploads (supports local and S3)\n\"\"\"\n\nimport os\nimport uuid\nfrom pathlib import Path\nfrom typing import Optional\n\nfrom app.core.logging import get_logger\nfrom fastapi import UploadFile\n\nlogger = get_logger(__name__)\n\n\nclass StorageService:\n    \"\"\"\n    Handle file storage operations.\n    Supports both local filesystem and AWS S3.\n    \"\"\"\n\n    def __init__(self):\n        self.storage_type = os.getenv(\"STORAGE_TYPE\", \"local\")  # 'local' or 's3'\n        self.upload_dir = Path(os.getenv(\"UPLOAD_DIR\", \"./uploads\"))\n\n        if self.storage_type == \"local\":\n            # Ensure upload directory exists\n            self.upload_dir.mkdir(parents=True, exist_ok=True)\n            logger.info(f\"Using local storage at {self.upload_dir}\")\n        elif self.storage_type == \"s3\":\n            # Import boto3 only if using S3\n            try:\n                import boto3\n\n                self.s3_client = boto3.client(\"s3\")\n                self.s3_bucket = os.getenv(\"AWS_S3_BUCKET\")\n                logger.info(f\"Using S3 storage with bucket {self.s3_bucket}\")\n            except ImportError:\n                logger.error(\"boto3 not installed. Install with: pip install boto3\")\n                raise\n\n    async def upload_file(self, file: UploadFile, user_id: str, message_id: str) -> str:\n        \"\"\"\n        Upload file and return URL.\n\n        Args:\n            file: UploadFile from FastAPI\n            user_id: User ID\n            message_id: Message ID\n\n        Returns:\n            str: File URL\n        \"\"\"\n        # Generate unique filename\n        file_ext = Path(file.filename).suffix\n        unique_filename = f\"{user_id}/{message_id}/{uuid.uuid4()}{file_ext}\"\n\n        if self.storage_type == \"local\":\n            return await self._upload_local(file, unique_filename)\n        elif self.storage_type == \"s3\":\n            return await self._upload_s3(file, unique_filename)\n        else:\n            raise ValueError(f\"Unknown storage type: {self.storage_type}\")\n\n    async def _upload_local(self, file: UploadFile, filename: str) -> str:\n        \"\"\"Upload file to local filesystem\"\"\"\n        file_path = self.upload_dir / filename\n\n        # Create directory if it doesn't exist\n        file_path.parent.mkdir(parents=True, exist_ok=True)\n\n        # Write file\n        content = await file.read()\n        with open(file_path, \"wb\") as f:\n            f.write(content)\n\n        # Return relative URL\n        return f\"/uploads/{filename}\"\n\n    async def _upload_s3(self, file: UploadFile, filename: str) -> str:\n        \"\"\"Upload file to S3\"\"\"\n        content = await file.read()\n\n        # Upload to S3\n        self.s3_client.put_object(\n            Bucket=self.s3_bucket,\n            Key=filename,\n            Body=content,\n            ContentType=file.content_type or \"application/octet-stream\",\n        )\n\n        # Return S3 URL\n        return f\"https://{self.s3_bucket}.s3.amazonaws.com/{filename}\"\n\n    async def delete_file(self, file_url: str) -> bool:\n        \"\"\"\n        Delete file from storage.\n\n        Args:\n            file_url: File URL\n\n        Returns:\n            bool: True if deleted successfully\n        \"\"\"\n        try:\n            if self.storage_type == \"local\":\n                return await self._delete_local(file_url)\n            elif self.storage_type == \"s3\":\n                return await self._delete_s3(file_url)\n            else:\n                raise ValueError(f\"Unknown storage type: {self.storage_type}\")\n        except Exception as e:\n            logger.error(f\"Error deleting file {file_url}: {e}\")\n            return False\n\n    async def _delete_local(self, file_url: str) -> bool:\n        \"\"\"Delete file from local filesystem\"\"\"\n        # Extract path from URL (remove /uploads/ prefix)\n        file_path = self.upload_dir / file_url.replace(\"/uploads/\", \"\")\n\n        if file_path.exists():\n            file_path.unlink()\n            return True\n        return False\n\n    async def _delete_s3(self, file_url: str) -> bool:\n        \"\"\"Delete file from S3\"\"\"\n        # Extract key from URL\n        key = file_url.split(\".amazonaws.com/\")[-1]\n\n        self.s3_client.delete_object(Bucket=self.s3_bucket, Key=key)\n        return True\n\n    async def get_file(self, file_url: str) -> Optional[bytes]:\n        \"\"\"\n        Retrieve file content.\n\n        Args:\n            file_url: File URL\n\n        Returns:\n            bytes: File content or None if not found\n        \"\"\"\n        try:\n            if self.storage_type == \"local\":\n                return await self._get_local(file_url)\n            elif self.storage_type == \"s3\":\n                return await self._get_s3(file_url)\n            else:\n                raise ValueError(f\"Unknown storage type: {self.storage_type}\")\n        except Exception as e:\n            logger.error(f\"Error retrieving file {file_url}: {e}\")\n            return None\n\n    async def _get_local(self, file_url: str) -> Optional[bytes]:\n        \"\"\"Get file from local filesystem\"\"\"\n        file_path = self.upload_dir / file_url.replace(\"/uploads/\", \"\")\n\n        if file_path.exists():\n            with open(file_path, \"rb\") as f:\n                return f.read()\n        return None\n\n    async def _get_s3(self, file_url: str) -> Optional[bytes]:\n        \"\"\"Get file from S3\"\"\"\n        key = file_url.split(\".amazonaws.com/\")[-1]\n\n        response = self.s3_client.get_object(Bucket=self.s3_bucket, Key=key)\n        return response[\"Body\"].read()\n\n    def get_file_size_limit(self) -> int:\n        \"\"\"Get max file size in bytes\"\"\"\n        max_mb = int(os.getenv(\"MAX_FILE_SIZE_MB\", \"10\"))\n        return max_mb * 1024 * 1024  # Convert MB to bytes\n\n    def is_allowed_file_type(self, filename: str) -> bool:\n        \"\"\"Check if file type is allowed\"\"\"\n        allowed_extensions = {\n            \".pdf\",\n            \".txt\",\n            \".md\",\n            \".png\",\n            \".jpg\",\n            \".jpeg\",\n            \".gif\",\n            \".doc\",\n            \".docx\",\n        }\n        file_ext = Path(filename).suffix.lower()\n        return file_ext in allowed_extensions\n\n\n# Singleton instance\n_storage_service = None\n\n\ndef get_storage_service() -> StorageService:\n    \"\"\"Get storage service instance\"\"\"\n    global _storage_service\n    if _storage_service is None:\n        _storage_service = StorageService()\n    return _storage_service\n"
}

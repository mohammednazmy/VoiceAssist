{
  "path": "apps/web-app/src/components/voice/VoiceInputEnhanced.tsx",
  "language": "typescript",
  "size": 16140,
  "last_modified": "2025-12-01T23:09:13.382Z",
  "lines": 502,
  "content": "/**\n * Enhanced Voice Input Component\n * Features:\n * - Voice Activity Detection (VAD)\n * - Waveform visualization\n * - Push-to-talk mode toggle\n * - Microphone permission handling\n * - Real-time energy visualization\n */\n\nimport { useState, useRef, useCallback, useEffect } from \"react\";\nimport { Button } from \"@voiceassist/ui\";\nimport { useAuth } from \"../../hooks/useAuth\";\nimport {\n  VoiceActivityDetector,\n  testMicrophoneAccess,\n  isGetUserMediaSupported,\n  getOptimalAudioConstraints,\n  type VADConfig,\n} from \"../../utils/vad\";\nimport { WaveformVisualizer } from \"../../utils/waveform\";\nimport { extractErrorMessage } from \"@voiceassist/types\";\n\ninterface VoiceInputEnhancedProps {\n  onTranscript: (text: string) => void;\n  disabled?: boolean;\n  /** Use push-to-talk instead of VAD */\n  pushToTalk?: boolean;\n  /** Custom VAD configuration */\n  vadConfig?: Partial<VADConfig>;\n}\n\ntype RecordingState = \"idle\" | \"recording\" | \"processing\";\ntype MicrophoneState =\n  | \"unknown\"\n  | \"checking\"\n  | \"granted\"\n  | \"denied\"\n  | \"unavailable\";\n\nexport function VoiceInputEnhanced({\n  onTranscript,\n  disabled,\n  pushToTalk = false,\n  vadConfig,\n}: VoiceInputEnhancedProps) {\n  const [recordingState, setRecordingState] = useState<RecordingState>(\"idle\");\n  const [microphoneState, setMicrophoneState] =\n    useState<MicrophoneState>(\"unknown\");\n  const [transcript, setTranscript] = useState(\"\");\n  const [error, setError] = useState<string | null>(null);\n  const [isSpeaking, setIsSpeaking] = useState(false);\n  const [energy, setEnergy] = useState(0);\n  const [mode, setMode] = useState<\"vad\" | \"push-to-talk\">(\n    pushToTalk ? \"push-to-talk\" : \"vad\",\n  );\n\n  const mediaRecorderRef = useRef<MediaRecorder | null>(null);\n  const audioChunksRef = useRef<Blob[]>([]);\n  const vadRef = useRef<VoiceActivityDetector | null>(null);\n  const waveformRef = useRef<WaveformVisualizer | null>(null);\n  const canvasRef = useRef<HTMLCanvasElement>(null);\n  const streamRef = useRef<MediaStream | null>(null);\n  const { apiClient } = useAuth();\n\n  // Check microphone permission on mount\n  useEffect(() => {\n    checkMicrophonePermission();\n  }, []);\n\n  const checkMicrophonePermission = useCallback(async () => {\n    if (!isGetUserMediaSupported()) {\n      setMicrophoneState(\"unavailable\");\n      setError(\"Your browser does not support microphone access\");\n      return;\n    }\n\n    setMicrophoneState(\"checking\");\n\n    const result = await testMicrophoneAccess();\n\n    if (result.hasPermission) {\n      setMicrophoneState(\"granted\");\n      setError(null);\n    } else {\n      setMicrophoneState(\"denied\");\n      setError(result.errorMessage || \"Microphone access denied\");\n    }\n  }, []);\n\n  const startRecording = useCallback(async () => {\n    try {\n      setError(null);\n\n      // Get microphone stream\n      const stream = await navigator.mediaDevices.getUserMedia({\n        audio: getOptimalAudioConstraints(),\n      });\n\n      streamRef.current = stream;\n\n      // Setup waveform visualization\n      if (canvasRef.current && !waveformRef.current) {\n        waveformRef.current = new WaveformVisualizer(canvasRef.current, {\n          width: canvasRef.current.width,\n          height: canvasRef.current.height,\n          color: \"#3b82f6\",\n        });\n        await waveformRef.current.connect(stream);\n      } else if (waveformRef.current) {\n        await waveformRef.current.connect(stream);\n      }\n\n      // Setup MediaRecorder\n      const mediaRecorder = new MediaRecorder(stream, {\n        mimeType: \"audio/webm;codecs=opus\",\n      });\n\n      audioChunksRef.current = [];\n\n      mediaRecorder.ondataavailable = (event) => {\n        if (event.data.size > 0) {\n          audioChunksRef.current.push(event.data);\n        }\n      };\n\n      mediaRecorder.onstop = async () => {\n        const audioBlob = new Blob(audioChunksRef.current, {\n          type: \"audio/webm\",\n        });\n\n        // Clean up stream\n        if (streamRef.current) {\n          streamRef.current.getTracks().forEach((track) => track.stop());\n          streamRef.current = null;\n        }\n\n        // Send to backend for transcription\n        setRecordingState(\"processing\");\n        try {\n          const text = await apiClient.transcribeAudio(audioBlob);\n          setTranscript(text);\n          onTranscript(text);\n          setRecordingState(\"idle\");\n        } catch (err: unknown) {\n          console.error(\"Transcription failed:\", err);\n          setError(extractErrorMessage(err));\n          setRecordingState(\"idle\");\n        }\n      };\n\n      // Start recording\n      mediaRecorder.start();\n      mediaRecorderRef.current = mediaRecorder;\n      setRecordingState(\"recording\");\n\n      // Setup VAD if in VAD mode\n      if (mode === \"vad\") {\n        vadRef.current = new VoiceActivityDetector(vadConfig);\n        await vadRef.current.connect(stream);\n\n        vadRef.current.on(\"speechStart\", () => {\n          setIsSpeaking(true);\n        });\n\n        vadRef.current.on(\"speechEnd\", () => {\n          setIsSpeaking(false);\n          // Auto-stop recording when speech ends\n          stopRecording();\n        });\n\n        vadRef.current.on(\"energyChange\", (newEnergy?: number) => {\n          if (newEnergy !== undefined) {\n            setEnergy(newEnergy);\n          }\n        });\n      }\n    } catch (err: unknown) {\n      console.error(\"Failed to start recording:\", err);\n      setError(extractErrorMessage(err));\n      setRecordingState(\"idle\");\n      setMicrophoneState(\"denied\");\n    }\n  }, [apiClient, onTranscript, mode, vadConfig]);\n\n  const stopRecording = useCallback(() => {\n    if (\n      mediaRecorderRef.current &&\n      mediaRecorderRef.current.state === \"recording\"\n    ) {\n      mediaRecorderRef.current.stop();\n    }\n\n    // Cleanup VAD\n    if (vadRef.current) {\n      vadRef.current.disconnect();\n      vadRef.current = null;\n    }\n\n    // Cleanup waveform\n    if (waveformRef.current) {\n      waveformRef.current.disconnect();\n      waveformRef.current = null;\n    }\n\n    setIsSpeaking(false);\n    setEnergy(0);\n  }, []);\n\n  // Cleanup on unmount\n  useEffect(() => {\n    return () => {\n      if (\n        mediaRecorderRef.current &&\n        mediaRecorderRef.current.state === \"recording\"\n      ) {\n        mediaRecorderRef.current.stop();\n      }\n      if (vadRef.current) {\n        vadRef.current.disconnect();\n      }\n      if (waveformRef.current) {\n        waveformRef.current.disconnect();\n      }\n      if (streamRef.current) {\n        streamRef.current.getTracks().forEach((track) => track.stop());\n      }\n    };\n  }, []);\n\n  const isRecording = recordingState === \"recording\";\n  const isProcessing = recordingState === \"processing\";\n  const canRecord = microphoneState === \"granted\" && !disabled && !isProcessing;\n\n  // Render microphone permission error\n  if (microphoneState === \"denied\" || microphoneState === \"unavailable\") {\n    return (\n      <div className=\"flex flex-col space-y-3\">\n        <div className=\"p-4 bg-red-50 rounded-md border border-red-200\">\n          <div className=\"flex items-start space-x-3\">\n            <svg\n              xmlns=\"http://www.w3.org/2000/svg\"\n              fill=\"none\"\n              viewBox=\"0 0 24 24\"\n              strokeWidth={1.5}\n              stroke=\"currentColor\"\n              className=\"w-6 h-6 text-red-600 flex-shrink-0\"\n            >\n              <path\n                strokeLinecap=\"round\"\n                strokeLinejoin=\"round\"\n                d=\"M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z\"\n              />\n            </svg>\n            <div className=\"flex-1\">\n              <h4 className=\"text-sm font-medium text-red-900\">\n                Microphone Access Required\n              </h4>\n              <p className=\"text-sm text-red-700 mt-1\">{error}</p>\n              <Button\n                type=\"button\"\n                variant=\"outline\"\n                size=\"sm\"\n                onClick={checkMicrophonePermission}\n                className=\"mt-3\"\n              >\n                Retry\n              </Button>\n            </div>\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"flex flex-col space-y-3\">\n      {/* Mode Toggle */}\n      <div className=\"flex items-center justify-between p-3 bg-neutral-50 rounded-md border border-neutral-200\">\n        <span className=\"text-sm font-medium text-neutral-700\">\n          Voice Input Mode\n        </span>\n        <div className=\"flex items-center space-x-2\">\n          <button\n            type=\"button\"\n            onClick={() => setMode(\"vad\")}\n            className={`px-3 py-1 text-sm rounded-md transition-colors ${\n              mode === \"vad\"\n                ? \"bg-primary-500 text-white\"\n                : \"bg-white text-neutral-600 hover:bg-neutral-100\"\n            }`}\n          >\n            Auto (VAD)\n          </button>\n          <button\n            type=\"button\"\n            onClick={() => setMode(\"push-to-talk\")}\n            className={`px-3 py-1 text-sm rounded-md transition-colors ${\n              mode === \"push-to-talk\"\n                ? \"bg-primary-500 text-white\"\n                : \"bg-white text-neutral-600 hover:bg-neutral-100\"\n            }`}\n          >\n            Push-to-Talk\n          </button>\n        </div>\n      </div>\n\n      {/* Waveform Visualization */}\n      <div className=\"p-3 bg-white rounded-md border border-neutral-200\">\n        <canvas\n          ref={canvasRef}\n          width={600}\n          height={100}\n          className=\"w-full h-24 rounded\"\n          style={{ maxWidth: \"100%\", height: \"auto\" }}\n        />\n        {/* Energy indicator */}\n        {isRecording && (\n          <div className=\"mt-2 flex items-center space-x-2\">\n            <span className=\"text-xs text-neutral-600\">Energy:</span>\n            <div className=\"flex-1 h-2 bg-neutral-200 rounded-full overflow-hidden\">\n              <div\n                className={`h-full transition-all duration-100 ${\n                  isSpeaking ? \"bg-green-500\" : \"bg-neutral-400\"\n                }`}\n                style={{ width: `${Math.min(energy * 100 * 5, 100)}%` }}\n              />\n            </div>\n            {isSpeaking && (\n              <span className=\"text-xs font-medium text-green-600\">\n                Speaking\n              </span>\n            )}\n          </div>\n        )}\n      </div>\n\n      {/* Voice Input Button */}\n      <div className=\"flex items-center space-x-3\">\n        {mode === \"push-to-talk\" ? (\n          <Button\n            type=\"button\"\n            variant={isRecording ? \"danger\" : \"primary\"}\n            size=\"lg\"\n            disabled={!canRecord}\n            onMouseDown={startRecording}\n            onMouseUp={stopRecording}\n            onTouchStart={startRecording}\n            onTouchEnd={stopRecording}\n            className=\"flex-1\"\n            aria-label={\n              isRecording ? \"Recording... Release to stop\" : \"Hold to record\"\n            }\n          >\n            {isProcessing ? (\n              <>\n                <div className=\"w-5 h-5 mr-2 rounded-full border-2 border-white border-t-transparent animate-spin\" />\n                Processing...\n              </>\n            ) : isRecording ? (\n              <>\n                <svg\n                  xmlns=\"http://www.w3.org/2000/svg\"\n                  fill=\"currentColor\"\n                  viewBox=\"0 0 24 24\"\n                  className=\"w-5 h-5 mr-2 animate-pulse\"\n                >\n                  <path d=\"M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z\" />\n                  <path d=\"M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z\" />\n                </svg>\n                Recording... (Release to stop)\n              </>\n            ) : (\n              <>\n                <svg\n                  xmlns=\"http://www.w3.org/2000/svg\"\n                  fill=\"none\"\n                  viewBox=\"0 0 24 24\"\n                  strokeWidth={1.5}\n                  stroke=\"currentColor\"\n                  className=\"w-5 h-5 mr-2\"\n                >\n                  <path\n                    strokeLinecap=\"round\"\n                    strokeLinejoin=\"round\"\n                    d=\"M12 18.75a6 6 0 006-6v-1.5m-6 7.5a6 6 0 01-6-6v-1.5m6 7.5v3.75m-3.75 0h7.5M12 15.75a3 3 0 01-3-3V4.5a3 3 0 116 0v8.25a3 3 0 01-3 3z\"\n                  />\n                </svg>\n                Hold to Record\n              </>\n            )}\n          </Button>\n        ) : (\n          <Button\n            type=\"button\"\n            variant={isRecording ? \"danger\" : \"primary\"}\n            size=\"lg\"\n            disabled={!canRecord}\n            onClick={isRecording ? stopRecording : startRecording}\n            className=\"flex-1\"\n            aria-label={isRecording ? \"Stop recording\" : \"Start recording\"}\n          >\n            {isProcessing ? (\n              <>\n                <div className=\"w-5 h-5 mr-2 rounded-full border-2 border-white border-t-transparent animate-spin\" />\n                Processing...\n              </>\n            ) : isRecording ? (\n              <>\n                <svg\n                  xmlns=\"http://www.w3.org/2000/svg\"\n                  fill=\"currentColor\"\n                  viewBox=\"0 0 24 24\"\n                  className=\"w-5 h-5 mr-2 animate-pulse\"\n                >\n                  <rect x=\"6\" y=\"6\" width=\"12\" height=\"12\" rx=\"2\" />\n                </svg>\n                Stop Recording\n              </>\n            ) : (\n              <>\n                <svg\n                  xmlns=\"http://www.w3.org/2000/svg\"\n                  fill=\"currentColor\"\n                  viewBox=\"0 0 24 24\"\n                  className=\"w-5 h-5 mr-2\"\n                >\n                  <circle cx=\"12\" cy=\"12\" r=\"8\" />\n                </svg>\n                Start Recording (Auto-detect)\n              </>\n            )}\n          </Button>\n        )}\n      </div>\n\n      {/* Transcript Display */}\n      {transcript && (\n        <div className=\"p-3 bg-neutral-100 rounded-md border border-neutral-200\">\n          <p className=\"text-sm text-neutral-600 font-medium mb-1\">\n            Transcript:\n          </p>\n          <p className=\"text-sm text-neutral-900\">{transcript}</p>\n        </div>\n      )}\n\n      {/* Error Display - only show for non-microphone-permission errors */}\n      {error && (\n        <div className=\"p-3 bg-red-50 rounded-md border border-red-200 flex items-start space-x-2\">\n          <svg\n            xmlns=\"http://www.w3.org/2000/svg\"\n            fill=\"none\"\n            viewBox=\"0 0 24 24\"\n            strokeWidth={1.5}\n            stroke=\"currentColor\"\n            className=\"w-5 h-5 text-red-600 flex-shrink-0\"\n          >\n            <path\n              strokeLinecap=\"round\"\n              strokeLinejoin=\"round\"\n              d=\"M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z\"\n            />\n          </svg>\n          <div className=\"flex-1\">\n            <p className=\"text-sm text-red-800 font-medium\">Error</p>\n            <p className=\"text-sm text-red-600 mt-1\">{error}</p>\n          </div>\n          <button\n            type=\"button\"\n            onClick={() => setError(null)}\n            className=\"text-red-600 hover:text-red-700 focus:outline-none\"\n            aria-label=\"Dismiss error\"\n          >\n            <svg\n              xmlns=\"http://www.w3.org/2000/svg\"\n              fill=\"none\"\n              viewBox=\"0 0 24 24\"\n              strokeWidth={2}\n              stroke=\"currentColor\"\n              className=\"w-5 h-5\"\n            >\n              <path\n                strokeLinecap=\"round\"\n                strokeLinejoin=\"round\"\n                d=\"M6 18L18 6M6 6l12 12\"\n              />\n            </svg>\n          </button>\n        </div>\n      )}\n\n      {/* Instructions */}\n      <p className=\"text-xs text-neutral-500 text-center\">\n        {mode === \"vad\"\n          ? \"Start recording and speak. Recording will automatically stop after you finish speaking.\"\n          : \"Press and hold to record your voice. Release to send for transcription.\"}\n      </p>\n    </div>\n  );\n}\n"
}

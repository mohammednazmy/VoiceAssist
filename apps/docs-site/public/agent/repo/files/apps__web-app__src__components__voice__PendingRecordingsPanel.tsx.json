{
  "path": "apps/web-app/src/components/voice/PendingRecordingsPanel.tsx",
  "language": "typescript",
  "size": 14206,
  "last_modified": "2025-11-27T06:44:49.508Z",
  "lines": 400,
  "content": "/**\n * PendingRecordingsPanel Component\n *\n * Displays and manages offline voice recordings waiting to be synced.\n * Features:\n * - List view of pending recordings with metadata\n * - Individual and bulk delete options\n * - Manual sync trigger\n * - Storage quota information\n * - Upload progress tracking\n *\n * @module components/voice/PendingRecordingsPanel\n */\n\nimport { useState, useEffect, useCallback } from \"react\";\nimport { Button, Card } from \"@voiceassist/ui\";\nimport type { OfflineRecording } from \"../../hooks/useOfflineVoiceCapture\";\nimport { getStorageQuota } from \"../../utils/storageQuota\";\n\ninterface PendingRecordingsPanelProps {\n  /** Function to get pending recordings */\n  getPendingRecordings: () => Promise<OfflineRecording[]>;\n  /** Function to delete a recording */\n  deleteRecording: (id: string) => Promise<void>;\n  /** Function to sync all pending recordings */\n  syncPendingRecordings: () => Promise<void>;\n  /** Whether currently syncing */\n  isSyncing?: boolean;\n  /** Whether offline */\n  isOffline?: boolean;\n  /** Callback when panel should close */\n  onClose?: () => void;\n}\n\ninterface StorageInfo {\n  used: number;\n  quota: number;\n  percentage: number;\n}\n\n/**\n * Format bytes to human readable string\n */\nfunction formatBytes(bytes: number): string {\n  if (bytes === 0) return \"0 B\";\n  const k = 1024;\n  const sizes = [\"B\", \"KB\", \"MB\", \"GB\"];\n  const i = Math.floor(Math.log(bytes) / Math.log(k));\n  return `${parseFloat((bytes / Math.pow(k, i)).toFixed(1))} ${sizes[i]}`;\n}\n\n/**\n * Format duration in seconds to MM:SS\n */\nfunction formatDuration(seconds: number): string {\n  const mins = Math.floor(seconds / 60);\n  const secs = seconds % 60;\n  return `${mins}:${secs.toString().padStart(2, \"0\")}`;\n}\n\n/**\n * Format date to relative time or date string\n */\nfunction formatDate(date: Date): string {\n  const now = new Date();\n  const diffMs = now.getTime() - new Date(date).getTime();\n  const diffMins = Math.floor(diffMs / 60000);\n  const diffHours = Math.floor(diffMs / 3600000);\n  const diffDays = Math.floor(diffMs / 86400000);\n\n  if (diffMins < 1) return \"Just now\";\n  if (diffMins < 60) return `${diffMins}m ago`;\n  if (diffHours < 24) return `${diffHours}h ago`;\n  if (diffDays < 7) return `${diffDays}d ago`;\n\n  return new Date(date).toLocaleDateString();\n}\n\n/**\n * Get status badge color\n */\nfunction getStatusColor(status: OfflineRecording[\"status\"]): string {\n  switch (status) {\n    case \"pending\":\n      return \"bg-yellow-100 text-yellow-800\";\n    case \"uploading\":\n      return \"bg-blue-100 text-blue-800\";\n    case \"uploaded\":\n      return \"bg-green-100 text-green-800\";\n    case \"failed\":\n      return \"bg-red-100 text-red-800\";\n    default:\n      return \"bg-gray-100 text-gray-800\";\n  }\n}\n\nexport function PendingRecordingsPanel({\n  getPendingRecordings,\n  deleteRecording,\n  syncPendingRecordings,\n  isSyncing = false,\n  isOffline = false,\n  onClose,\n}: PendingRecordingsPanelProps) {\n  const [recordings, setRecordings] = useState<OfflineRecording[]>([]);\n  const [storageInfo, setStorageInfo] = useState<StorageInfo | null>(null);\n  const [isLoading, setIsLoading] = useState(true);\n  const [deletingIds, setDeletingIds] = useState<Set<string>>(new Set());\n\n  // Load recordings and storage info\n  const loadData = useCallback(async () => {\n    setIsLoading(true);\n    try {\n      const [recs, storage] = await Promise.all([\n        getPendingRecordings(),\n        getStorageQuota(),\n      ]);\n      setRecordings(recs);\n      setStorageInfo(storage);\n    } catch (error) {\n      console.error(\"Failed to load pending recordings:\", error);\n    } finally {\n      setIsLoading(false);\n    }\n  }, [getPendingRecordings]);\n\n  useEffect(() => {\n    loadData();\n  }, [loadData]);\n\n  // Handle delete single recording\n  const handleDelete = async (id: string) => {\n    setDeletingIds((prev) => new Set(prev).add(id));\n    try {\n      await deleteRecording(id);\n      setRecordings((prev) => prev.filter((r) => r.id !== id));\n    } catch (error) {\n      console.error(\"Failed to delete recording:\", error);\n    } finally {\n      setDeletingIds((prev) => {\n        const next = new Set(prev);\n        next.delete(id);\n        return next;\n      });\n    }\n  };\n\n  // Handle delete all recordings\n  const handleDeleteAll = async () => {\n    if (\n      !confirm(\n        `Delete all ${recordings.length} pending recording(s)? This cannot be undone.`,\n      )\n    ) {\n      return;\n    }\n\n    const ids = recordings.map((r) => r.id);\n    setDeletingIds(new Set(ids));\n\n    try {\n      await Promise.all(ids.map((id) => deleteRecording(id)));\n      setRecordings([]);\n    } catch (error) {\n      console.error(\"Failed to delete all recordings:\", error);\n      await loadData(); // Refresh to show actual state\n    } finally {\n      setDeletingIds(new Set());\n    }\n  };\n\n  // Handle sync\n  const handleSync = async () => {\n    await syncPendingRecordings();\n    await loadData();\n  };\n\n  // Calculate total size\n  const totalSize = recordings.reduce(\n    (sum, r) => sum + (r.audioBlob?.size || 0),\n    0,\n  );\n\n  return (\n    <Card className=\"w-full max-w-md\">\n      <div className=\"p-4 border-b border-neutral-200\">\n        <div className=\"flex items-center justify-between\">\n          <h3 className=\"text-lg font-semibold text-neutral-900\">\n            Pending Recordings\n          </h3>\n          {onClose && (\n            <button\n              onClick={onClose}\n              className=\"p-1 rounded-md hover:bg-neutral-100 transition-colors\"\n              aria-label=\"Close panel\"\n            >\n              <svg\n                xmlns=\"http://www.w3.org/2000/svg\"\n                fill=\"none\"\n                viewBox=\"0 0 24 24\"\n                strokeWidth={2}\n                stroke=\"currentColor\"\n                className=\"w-5 h-5\"\n              >\n                <path\n                  strokeLinecap=\"round\"\n                  strokeLinejoin=\"round\"\n                  d=\"M6 18L18 6M6 6l12 12\"\n                />\n              </svg>\n            </button>\n          )}\n        </div>\n\n        {/* Storage info */}\n        {storageInfo && (\n          <div className=\"mt-2\">\n            <div className=\"flex justify-between text-xs text-neutral-500 mb-1\">\n              <span>Storage used</span>\n              <span>\n                {formatBytes(storageInfo.used)} /{\" \"}\n                {formatBytes(storageInfo.quota)}\n              </span>\n            </div>\n            <div className=\"h-1.5 bg-neutral-200 rounded-full overflow-hidden\">\n              <div\n                className={`h-full transition-all ${\n                  storageInfo.percentage > 90\n                    ? \"bg-red-500\"\n                    : storageInfo.percentage > 70\n                      ? \"bg-yellow-500\"\n                      : \"bg-green-500\"\n                }`}\n                style={{ width: `${Math.min(storageInfo.percentage, 100)}%` }}\n              />\n            </div>\n          </div>\n        )}\n      </div>\n\n      <div className=\"p-4\">\n        {isLoading ? (\n          <div className=\"flex items-center justify-center py-8\">\n            <div className=\"w-6 h-6 border-2 border-primary-500 border-t-transparent rounded-full animate-spin\" />\n          </div>\n        ) : recordings.length === 0 ? (\n          <div className=\"text-center py-8 text-neutral-500\">\n            <svg\n              xmlns=\"http://www.w3.org/2000/svg\"\n              fill=\"none\"\n              viewBox=\"0 0 24 24\"\n              strokeWidth={1.5}\n              stroke=\"currentColor\"\n              className=\"w-12 h-12 mx-auto mb-2 opacity-50\"\n            >\n              <path\n                strokeLinecap=\"round\"\n                strokeLinejoin=\"round\"\n                d=\"M12 18.75a6 6 0 006-6v-1.5m-6 7.5a6 6 0 01-6-6v-1.5m6 7.5v3.75m-3.75 0h7.5M12 15.75a3 3 0 01-3-3V4.5a3 3 0 116 0v8.25a3 3 0 01-3 3z\"\n              />\n            </svg>\n            <p className=\"text-sm\">No pending recordings</p>\n          </div>\n        ) : (\n          <>\n            {/* Recordings list */}\n            <div className=\"space-y-2 max-h-64 overflow-y-auto\">\n              {recordings.map((recording) => (\n                <div\n                  key={recording.id}\n                  className=\"flex items-center justify-between p-3 bg-neutral-50 rounded-lg\"\n                >\n                  <div className=\"flex-1 min-w-0\">\n                    <div className=\"flex items-center gap-2\">\n                      <span\n                        className={`px-2 py-0.5 text-xs font-medium rounded-full ${getStatusColor(recording.status)}`}\n                      >\n                        {recording.status}\n                      </span>\n                      {recording.retryCount > 0 && (\n                        <span className=\"text-xs text-neutral-500\">\n                          ({recording.retryCount} retries)\n                        </span>\n                      )}\n                    </div>\n                    <div className=\"flex items-center gap-3 mt-1 text-sm text-neutral-600\">\n                      <span>{formatDuration(recording.duration)}</span>\n                      <span>{formatBytes(recording.audioBlob?.size || 0)}</span>\n                      <span>{formatDate(recording.createdAt)}</span>\n                    </div>\n                  </div>\n                  <button\n                    onClick={() => handleDelete(recording.id)}\n                    disabled={deletingIds.has(recording.id)}\n                    className=\"p-2 text-neutral-400 hover:text-red-500 hover:bg-red-50 rounded-md transition-colors disabled:opacity-50\"\n                    aria-label=\"Delete recording\"\n                  >\n                    {deletingIds.has(recording.id) ? (\n                      <div className=\"w-4 h-4 border-2 border-current border-t-transparent rounded-full animate-spin\" />\n                    ) : (\n                      <svg\n                        xmlns=\"http://www.w3.org/2000/svg\"\n                        fill=\"none\"\n                        viewBox=\"0 0 24 24\"\n                        strokeWidth={2}\n                        stroke=\"currentColor\"\n                        className=\"w-4 h-4\"\n                      >\n                        <path\n                          strokeLinecap=\"round\"\n                          strokeLinejoin=\"round\"\n                          d=\"M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0\"\n                        />\n                      </svg>\n                    )}\n                  </button>\n                </div>\n              ))}\n            </div>\n\n            {/* Summary and actions */}\n            <div className=\"mt-4 pt-4 border-t border-neutral-200\">\n              <div className=\"flex items-center justify-between text-sm text-neutral-600 mb-3\">\n                <span>\n                  {recordings.length} recording{recordings.length !== 1 && \"s\"}\n                </span>\n                <span>Total: {formatBytes(totalSize)}</span>\n              </div>\n\n              <div className=\"flex gap-2\">\n                <Button\n                  onClick={handleSync}\n                  disabled={isSyncing || isOffline || recordings.length === 0}\n                  className=\"flex-1\"\n                >\n                  {isSyncing ? (\n                    <>\n                      <div className=\"w-4 h-4 mr-2 border-2 border-white border-t-transparent rounded-full animate-spin\" />\n                      Syncing...\n                    </>\n                  ) : isOffline ? (\n                    \"Offline\"\n                  ) : (\n                    <>\n                      <svg\n                        xmlns=\"http://www.w3.org/2000/svg\"\n                        fill=\"none\"\n                        viewBox=\"0 0 24 24\"\n                        strokeWidth={2}\n                        stroke=\"currentColor\"\n                        className=\"w-4 h-4 mr-2\"\n                      >\n                        <path\n                          strokeLinecap=\"round\"\n                          strokeLinejoin=\"round\"\n                          d=\"M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99\"\n                        />\n                      </svg>\n                      Sync All\n                    </>\n                  )}\n                </Button>\n                <Button\n                  variant=\"outline\"\n                  onClick={handleDeleteAll}\n                  disabled={deletingIds.size > 0 || recordings.length === 0}\n                  className=\"text-red-600 hover:bg-red-50 border-red-200\"\n                >\n                  <svg\n                    xmlns=\"http://www.w3.org/2000/svg\"\n                    fill=\"none\"\n                    viewBox=\"0 0 24 24\"\n                    strokeWidth={2}\n                    stroke=\"currentColor\"\n                    className=\"w-4 h-4\"\n                  >\n                    <path\n                      strokeLinecap=\"round\"\n                      strokeLinejoin=\"round\"\n                      d=\"M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0\"\n                    />\n                  </svg>\n                </Button>\n              </div>\n\n              {isOffline && (\n                <p className=\"mt-2 text-xs text-amber-600\">\n                  You're offline. Recordings will sync when you reconnect.\n                </p>\n              )}\n            </div>\n          </>\n        )}\n      </div>\n    </Card>\n  );\n}\n\nexport default PendingRecordingsPanel;\n"
}

{
  "path": "apps/web-app/src/components/folders/FolderSidebar.tsx",
  "language": "typescript",
  "size": 11002,
  "last_modified": "2025-11-24T10:36:27.755Z",
  "lines": 362,
  "content": "/**\n * FolderSidebar Component\n * Displays hierarchical folder tree for organizing conversations\n */\n\nimport { useState, useEffect } from \"react\";\nimport { createFoldersApi, type Folder } from \"../../lib/api/foldersApi\";\nimport { useAuthStore } from \"../../stores/authStore\";\n\nexport interface FolderSidebarProps {\n  onFolderSelect?: (folderId: string | null) => void;\n  selectedFolderId?: string | null;\n}\n\nexport function FolderSidebar({\n  onFolderSelect,\n  selectedFolderId,\n}: FolderSidebarProps) {\n  const [folders, setFolders] = useState<Folder[]>([]);\n  const [loading, setLoading] = useState(true);\n  const [error, setError] = useState<string | null>(null);\n  const [expandedFolders, setExpandedFolders] = useState<Set<string>>(\n    new Set(),\n  );\n  const [editingFolder, setEditingFolder] = useState<string | null>(null);\n  const [editName, setEditName] = useState(\"\");\n  const [creatingFolder, setCreatingFolder] = useState(false);\n  const [newFolderName, setNewFolderName] = useState(\"\");\n  const [newFolderParent, setNewFolderParent] = useState<string | null>(null);\n\n  const { tokens } = useAuthStore();\n\n  const foldersApi = createFoldersApi(\n    import.meta.env.VITE_API_URL || \"http://localhost:8000\",\n    () => tokens?.accessToken || null,\n  );\n\n  // Load folder tree on mount\n  useEffect(() => {\n    loadFolders();\n  }, []);\n\n  async function loadFolders() {\n    try {\n      setLoading(true);\n      setError(null);\n      const tree = await foldersApi.getFolderTree();\n      setFolders(tree);\n    } catch (err) {\n      setError(err instanceof Error ? err.message : \"Failed to load folders\");\n      console.error(\"Failed to load folders:\", err);\n    } finally {\n      setLoading(false);\n    }\n  }\n\n  function toggleFolder(folderId: string) {\n    setExpandedFolders((prev) => {\n      const next = new Set(prev);\n      if (next.has(folderId)) {\n        next.delete(folderId);\n      } else {\n        next.add(folderId);\n      }\n      return next;\n    });\n  }\n\n  async function handleCreateFolder() {\n    if (!newFolderName.trim()) return;\n\n    try {\n      await foldersApi.createFolder({\n        name: newFolderName.trim(),\n        parent_folder_id: newFolderParent || undefined,\n      });\n      setNewFolderName(\"\");\n      setNewFolderParent(null);\n      setCreatingFolder(false);\n      await loadFolders();\n    } catch (err) {\n      alert(err instanceof Error ? err.message : \"Failed to create folder\");\n    }\n  }\n\n  async function handleRenameFolder(folderId: string) {\n    if (!editName.trim()) return;\n\n    try {\n      await foldersApi.updateFolder(folderId, { name: editName.trim() });\n      setEditingFolder(null);\n      setEditName(\"\");\n      await loadFolders();\n    } catch (err) {\n      alert(err instanceof Error ? err.message : \"Failed to rename folder\");\n    }\n  }\n\n  async function handleDeleteFolder(folderId: string) {\n    if (\n      !confirm(\n        \"Are you sure? All conversations in this folder will be moved to the root level.\",\n      )\n    ) {\n      return;\n    }\n\n    try {\n      await foldersApi.deleteFolder(folderId);\n      await loadFolders();\n      if (selectedFolderId === folderId) {\n        onFolderSelect?.(null);\n      }\n    } catch (err) {\n      alert(err instanceof Error ? err.message : \"Failed to delete folder\");\n    }\n  }\n\n  function startEdit(folder: Folder) {\n    setEditingFolder(folder.id);\n    setEditName(folder.name);\n  }\n\n  function cancelEdit() {\n    setEditingFolder(null);\n    setEditName(\"\");\n  }\n\n  function renderFolder(folder: Folder, level: number = 0) {\n    const isExpanded = expandedFolders.has(folder.id);\n    const isSelected = selectedFolderId === folder.id;\n    const isEditing = editingFolder === folder.id;\n    const hasChildren = folder.children && folder.children.length > 0;\n\n    return (\n      <div key={folder.id} style={{ marginLeft: `${level * 16}px` }}>\n        <div\n          className={`flex items-center justify-between p-2 rounded-md hover:bg-neutral-100 cursor-pointer ${\n            isSelected ? \"bg-primary-100\" : \"\"\n          }`}\n        >\n          <div className=\"flex items-center flex-1\">\n            {/* Expand/collapse button */}\n            {hasChildren && (\n              <button\n                type=\"button\"\n                onClick={() => toggleFolder(folder.id)}\n                className=\"mr-1 text-neutral-600 hover:text-neutral-900\"\n                aria-label={isExpanded ? \"Collapse\" : \"Expand\"}\n              >\n                {isExpanded ? \"â–¼\" : \"â–¶\"}\n              </button>\n            )}\n\n            {/* Folder icon */}\n            <span className=\"mr-2 text-lg\">{folder.icon || \"ğŸ“\"}</span>\n\n            {/* Folder name or edit input */}\n            {isEditing ? (\n              <input\n                type=\"text\"\n                value={editName}\n                onChange={(e) => setEditName(e.target.value)}\n                onKeyDown={(e) => {\n                  if (e.key === \"Enter\") handleRenameFolder(folder.id);\n                  if (e.key === \"Escape\") cancelEdit();\n                }}\n                className=\"flex-1 px-2 py-1 text-sm border rounded\"\n                autoFocus\n              />\n            ) : (\n              <span\n                className=\"flex-1 text-sm\"\n                onClick={() => onFolderSelect?.(folder.id)}\n              >\n                {folder.name}\n              </span>\n            )}\n          </div>\n\n          {/* Action buttons */}\n          {!isEditing && (\n            <div className=\"flex items-center space-x-1\">\n              <button\n                type=\"button\"\n                onClick={() => {\n                  setNewFolderParent(folder.id);\n                  setCreatingFolder(true);\n                }}\n                className=\"p-1 text-neutral-600 hover:text-primary-600\"\n                aria-label=\"Add subfolder\"\n                title=\"Add subfolder\"\n              >\n                â•\n              </button>\n              <button\n                type=\"button\"\n                onClick={() => startEdit(folder)}\n                className=\"p-1 text-neutral-600 hover:text-primary-600\"\n                aria-label=\"Rename\"\n                title=\"Rename\"\n              >\n                âœï¸\n              </button>\n              <button\n                type=\"button\"\n                onClick={() => handleDeleteFolder(folder.id)}\n                className=\"p-1 text-neutral-600 hover:text-red-600\"\n                aria-label=\"Delete\"\n                title=\"Delete\"\n              >\n                ğŸ—‘ï¸\n              </button>\n            </div>\n          )}\n\n          {/* Edit actions */}\n          {isEditing && (\n            <div className=\"flex items-center space-x-1\">\n              <button\n                type=\"button\"\n                onClick={() => handleRenameFolder(folder.id)}\n                className=\"px-2 py-1 text-xs bg-primary-500 text-white rounded hover:bg-primary-600\"\n              >\n                Save\n              </button>\n              <button\n                type=\"button\"\n                onClick={cancelEdit}\n                className=\"px-2 py-1 text-xs bg-neutral-300 rounded hover:bg-neutral-400\"\n              >\n                Cancel\n              </button>\n            </div>\n          )}\n        </div>\n\n        {/* Render children if expanded */}\n        {isExpanded && hasChildren && (\n          <div>\n            {folder.children!.map((child) => renderFolder(child, level + 1))}\n          </div>\n        )}\n      </div>\n    );\n  }\n\n  if (loading) {\n    return (\n      <div className=\"p-4\">\n        <div className=\"animate-pulse\">\n          <div className=\"h-4 bg-neutral-200 rounded mb-2\"></div>\n          <div className=\"h-4 bg-neutral-200 rounded mb-2\"></div>\n          <div className=\"h-4 bg-neutral-200 rounded\"></div>\n        </div>\n      </div>\n    );\n  }\n\n  if (error) {\n    return (\n      <div className=\"p-4\">\n        <div className=\"text-red-600 text-sm\">Error: {error}</div>\n        <button\n          type=\"button\"\n          onClick={loadFolders}\n          className=\"mt-2 px-3 py-1 text-sm bg-primary-500 text-white rounded hover:bg-primary-600\"\n        >\n          Retry\n        </button>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"p-4\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between mb-4\">\n        <h2 className=\"text-lg font-semibold\">Folders</h2>\n        <button\n          type=\"button\"\n          onClick={() => {\n            setNewFolderParent(null);\n            setCreatingFolder(true);\n          }}\n          className=\"px-3 py-1 text-sm bg-primary-500 text-white rounded hover:bg-primary-600\"\n          aria-label=\"New folder\"\n        >\n          + New\n        </button>\n      </div>\n\n      {/* All Conversations (root) */}\n      <div\n        className={`flex items-center p-2 mb-2 rounded-md cursor-pointer hover:bg-neutral-100 ${\n          selectedFolderId === null ? \"bg-primary-100\" : \"\"\n        }`}\n        onClick={() => onFolderSelect?.(null)}\n      >\n        <span className=\"mr-2 text-lg\">ğŸ“‚</span>\n        <span className=\"text-sm font-medium\">All Conversations</span>\n      </div>\n\n      {/* Create folder input */}\n      {creatingFolder && (\n        <div className=\"mb-4 p-3 border rounded-md bg-neutral-50\">\n          <input\n            type=\"text\"\n            value={newFolderName}\n            onChange={(e) => setNewFolderName(e.target.value)}\n            onKeyDown={(e) => {\n              if (e.key === \"Enter\") handleCreateFolder();\n              if (e.key === \"Escape\") {\n                setCreatingFolder(false);\n                setNewFolderName(\"\");\n                setNewFolderParent(null);\n              }\n            }}\n            placeholder={\n              newFolderParent ? \"New subfolder name...\" : \"New folder name...\"\n            }\n            className=\"w-full px-2 py-1 text-sm border rounded mb-2\"\n            autoFocus\n          />\n          <div className=\"flex justify-end space-x-2\">\n            <button\n              type=\"button\"\n              onClick={handleCreateFolder}\n              disabled={!newFolderName.trim()}\n              className=\"px-3 py-1 text-sm bg-primary-500 text-white rounded hover:bg-primary-600 disabled:bg-neutral-300\"\n            >\n              Create\n            </button>\n            <button\n              type=\"button\"\n              onClick={() => {\n                setCreatingFolder(false);\n                setNewFolderName(\"\");\n                setNewFolderParent(null);\n              }}\n              className=\"px-3 py-1 text-sm bg-neutral-300 rounded hover:bg-neutral-400\"\n            >\n              Cancel\n            </button>\n          </div>\n        </div>\n      )}\n\n      {/* Folder tree */}\n      {folders.length === 0 ? (\n        <div className=\"text-sm text-neutral-500 text-center py-4\">\n          No folders yet. Create your first folder to organize conversations.\n        </div>\n      ) : (\n        <div className=\"space-y-1\">\n          {folders.map((folder) => renderFolder(folder))}\n        </div>\n      )}\n    </div>\n  );\n}\n"
}

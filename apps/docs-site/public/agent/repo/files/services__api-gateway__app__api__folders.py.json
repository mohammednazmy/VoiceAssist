{
  "path": "services/api-gateway/app/api/folders.py",
  "language": "python",
  "size": 10240,
  "last_modified": "2025-12-04T11:26:47.695Z",
  "lines": 365,
  "content": "\"\"\"\nAPI endpoints for conversation folders\n\"\"\"\n\nfrom typing import Optional\nfrom uuid import UUID\n\nfrom app.core.database import get_db\nfrom app.core.dependencies import get_current_user\nfrom app.models.folder import ConversationFolder, FolderCreate, FolderUpdate\nfrom app.models.user import User\nfrom fastapi import APIRouter, Depends, HTTPException, status\nfrom sqlalchemy.orm import Session\n\nrouter = APIRouter()\n\n\n@router.post(\"/folders\", status_code=status.HTTP_201_CREATED)\nasync def create_folder(\n    folder: FolderCreate,\n    db: Session = Depends(get_db),\n    current_user: User = Depends(get_current_user),\n):\n    \"\"\"\n    Create a new conversation folder.\n\n    Args:\n        folder: Folder data\n        db: Database session\n        current_user: Authenticated user\n\n    Returns:\n        Created folder\n    \"\"\"\n    # Verify parent folder exists if provided\n    if folder.parent_folder_id:\n        parent = (\n            db.query(ConversationFolder)\n            .filter(\n                ConversationFolder.id == UUID(folder.parent_folder_id),\n                ConversationFolder.user_id == current_user.id,\n            )\n            .first()\n        )\n        if not parent:\n            raise HTTPException(status_code=status.HTTP_404_NOT_FOUND, detail=\"Parent folder not found\")\n\n    # Check for duplicate name in same parent\n    existing = (\n        db.query(ConversationFolder)\n        .filter(\n            ConversationFolder.user_id == current_user.id,\n            ConversationFolder.name == folder.name,\n            ConversationFolder.parent_folder_id == (UUID(folder.parent_folder_id) if folder.parent_folder_id else None),\n        )\n        .first()\n    )\n    if existing:\n        raise HTTPException(\n            status_code=status.HTTP_409_CONFLICT,\n            detail=\"Folder with this name already exists in this location\",\n        )\n\n    # Create folder\n    db_folder = ConversationFolder(\n        user_id=current_user.id,\n        name=folder.name,\n        color=folder.color,\n        icon=folder.icon,\n        parent_folder_id=(UUID(folder.parent_folder_id) if folder.parent_folder_id else None),\n    )\n\n    db.add(db_folder)\n    db.commit()\n    db.refresh(db_folder)\n\n    return db_folder.to_dict()\n\n\n@router.get(\"/folders\")\nasync def list_folders(\n    parent_id: Optional[str] = None,\n    db: Session = Depends(get_db),\n    current_user: User = Depends(get_current_user),\n):\n    \"\"\"\n    List all folders for the current user.\n\n    Args:\n        parent_id: Optional parent folder ID to filter by\n        db: Database session\n        current_user: Authenticated user\n\n    Returns:\n        List of folders\n    \"\"\"\n    query = db.query(ConversationFolder).filter(ConversationFolder.user_id == current_user.id)\n\n    if parent_id:\n        query = query.filter(ConversationFolder.parent_folder_id == UUID(parent_id))\n    else:\n        # Get root folders (no parent)\n        query = query.filter(ConversationFolder.parent_folder_id.is_(None))\n\n    folders = query.order_by(ConversationFolder.name).all()\n\n    return [folder.to_dict() for folder in folders]\n\n\n@router.get(\"/folders/tree\")\nasync def get_folder_tree(\n    db: Session = Depends(get_db),\n    current_user: User = Depends(get_current_user),\n):\n    \"\"\"\n    Get entire folder tree for the current user.\n\n    Args:\n        db: Database session\n        current_user: Authenticated user\n\n    Returns:\n        Hierarchical folder tree\n    \"\"\"\n    # Get all folders for user\n    all_folders = (\n        db.query(ConversationFolder)\n        .filter(ConversationFolder.user_id == current_user.id)\n        .order_by(ConversationFolder.name)\n        .all()\n    )\n\n    # Build tree structure\n    folder_map = {str(f.id): f.to_dict() for f in all_folders}\n    for folder in folder_map.values():\n        folder[\"children\"] = []\n\n    # Build hierarchy\n    root_folders = []\n    for folder in folder_map.values():\n        if folder[\"parent_folder_id\"]:\n            parent = folder_map.get(folder[\"parent_folder_id\"])\n            if parent:\n                parent[\"children\"].append(folder)\n        else:\n            root_folders.append(folder)\n\n    return root_folders\n\n\n@router.get(\"/folders/{folder_id}\")\nasync def get_folder(\n    folder_id: UUID,\n    db: Session = Depends(get_db),\n    current_user: User = Depends(get_current_user),\n):\n    \"\"\"\n    Get a specific folder by ID.\n\n    Args:\n        folder_id: Folder UUID\n        db: Database session\n        current_user: Authenticated user\n\n    Returns:\n        Folder details\n    \"\"\"\n    folder = (\n        db.query(ConversationFolder)\n        .filter(\n            ConversationFolder.id == folder_id,\n            ConversationFolder.user_id == current_user.id,\n        )\n        .first()\n    )\n\n    if not folder:\n        raise HTTPException(status_code=status.HTTP_404_NOT_FOUND, detail=\"Folder not found\")\n\n    return folder.to_dict()\n\n\n@router.put(\"/folders/{folder_id}\")\nasync def update_folder(\n    folder_id: UUID,\n    folder_update: FolderUpdate,\n    db: Session = Depends(get_db),\n    current_user: User = Depends(get_current_user),\n):\n    \"\"\"\n    Update a folder.\n\n    Args:\n        folder_id: Folder UUID\n        folder_update: Updated folder data\n        db: Database session\n        current_user: Authenticated user\n\n    Returns:\n        Updated folder\n    \"\"\"\n    folder = (\n        db.query(ConversationFolder)\n        .filter(\n            ConversationFolder.id == folder_id,\n            ConversationFolder.user_id == current_user.id,\n        )\n        .first()\n    )\n\n    if not folder:\n        raise HTTPException(status_code=status.HTTP_404_NOT_FOUND, detail=\"Folder not found\")\n\n    # Check for circular reference if updating parent\n    if folder_update.parent_folder_id:\n        parent_id = UUID(folder_update.parent_folder_id)\n        if parent_id == folder_id:\n            raise HTTPException(\n                status_code=status.HTTP_400_BAD_REQUEST,\n                detail=\"Folder cannot be its own parent\",\n            )\n\n        # Check if new parent is a descendant\n        def is_descendant(current_id: UUID, target_id: UUID) -> bool:\n            current = db.query(ConversationFolder).filter(ConversationFolder.id == current_id).first()\n            if not current:\n                return False\n            if current.parent_folder_id == target_id:\n                return True\n            if current.parent_folder_id:\n                return is_descendant(current.parent_folder_id, target_id)\n            return False\n\n        if is_descendant(parent_id, folder_id):\n            raise HTTPException(\n                status_code=status.HTTP_400_BAD_REQUEST,\n                detail=\"Cannot move folder into its own descendant\",\n            )\n\n    # Update fields if provided\n    update_data = folder_update.dict(exclude_unset=True)\n    if \"parent_folder_id\" in update_data and update_data[\"parent_folder_id\"]:\n        update_data[\"parent_folder_id\"] = UUID(update_data[\"parent_folder_id\"])\n\n    for field, value in update_data.items():\n        setattr(folder, field, value)\n\n    db.commit()\n    db.refresh(folder)\n\n    return folder.to_dict()\n\n\n@router.delete(\"/folders/{folder_id}\", status_code=status.HTTP_204_NO_CONTENT)\nasync def delete_folder(\n    folder_id: UUID,\n    db: Session = Depends(get_db),\n    current_user: User = Depends(get_current_user),\n):\n    \"\"\"\n    Delete a folder.\n    All child folders and sessions will be orphaned (parent_folder_id = NULL).\n\n    Args:\n        folder_id: Folder UUID\n        db: Database session\n        current_user: Authenticated user\n    \"\"\"\n    folder = (\n        db.query(ConversationFolder)\n        .filter(\n            ConversationFolder.id == folder_id,\n            ConversationFolder.user_id == current_user.id,\n        )\n        .first()\n    )\n\n    if not folder:\n        raise HTTPException(status_code=status.HTTP_404_NOT_FOUND, detail=\"Folder not found\")\n\n    # Orphan child folders (due to SET NULL on delete)\n    # This happens automatically with the foreign key constraint\n\n    db.delete(folder)\n    db.commit()\n\n    return None\n\n\n@router.post(\"/folders/{folder_id}/move/{target_folder_id}\")\nasync def move_folder(\n    folder_id: UUID,\n    target_folder_id: UUID,\n    db: Session = Depends(get_db),\n    current_user: User = Depends(get_current_user),\n):\n    \"\"\"\n    Move a folder to a new parent folder.\n\n    Args:\n        folder_id: Folder UUID to move\n        target_folder_id: New parent folder UUID\n        db: Database session\n        current_user: Authenticated user\n\n    Returns:\n        Updated folder\n    \"\"\"\n    # Get folder to move\n    folder = (\n        db.query(ConversationFolder)\n        .filter(\n            ConversationFolder.id == folder_id,\n            ConversationFolder.user_id == current_user.id,\n        )\n        .first()\n    )\n\n    if not folder:\n        raise HTTPException(status_code=status.HTTP_404_NOT_FOUND, detail=\"Folder not found\")\n\n    # Get target folder\n    target = (\n        db.query(ConversationFolder)\n        .filter(\n            ConversationFolder.id == target_folder_id,\n            ConversationFolder.user_id == current_user.id,\n        )\n        .first()\n    )\n\n    if not target:\n        raise HTTPException(status_code=status.HTTP_404_NOT_FOUND, detail=\"Target folder not found\")\n\n    # Check for circular reference\n    if target_folder_id == folder_id:\n        raise HTTPException(\n            status_code=status.HTTP_400_BAD_REQUEST,\n            detail=\"Cannot move folder into itself\",\n        )\n\n    # Check if target is a descendant\n    def is_descendant(current_id: UUID, target_id: UUID) -> bool:\n        current = db.query(ConversationFolder).filter(ConversationFolder.id == current_id).first()\n        if not current:\n            return False\n        if current.parent_folder_id == target_id:\n            return True\n        if current.parent_folder_id:\n            return is_descendant(current.parent_folder_id, target_id)\n        return False\n\n    if is_descendant(target_folder_id, folder_id):\n        raise HTTPException(\n            status_code=status.HTTP_400_BAD_REQUEST,\n            detail=\"Cannot move folder into its own descendant\",\n        )\n\n    # Move folder\n    folder.parent_folder_id = target_folder_id\n    db.commit()\n    db.refresh(folder)\n\n    return folder.to_dict()\n"
}

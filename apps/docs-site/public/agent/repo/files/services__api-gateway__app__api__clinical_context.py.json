{
  "path": "services/api-gateway/app/api/clinical_context.py",
  "language": "python",
  "size": 5800,
  "last_modified": "2025-12-04T11:26:46.943Z",
  "lines": 214,
  "content": "\"\"\"\nAPI endpoints for clinical context management\n\"\"\"\n\nfrom typing import Optional\nfrom uuid import UUID\n\nfrom app.core.database import get_db\nfrom app.core.dependencies import get_current_user\nfrom app.models.clinical_context import ClinicalContext, ClinicalContextCreate, ClinicalContextUpdate\nfrom app.models.user import User\nfrom fastapi import APIRouter, Depends, HTTPException, status\nfrom sqlalchemy.orm import Session\n\nrouter = APIRouter()\n\n\n@router.post(\"/clinical-contexts\", status_code=status.HTTP_201_CREATED)\nasync def create_clinical_context(\n    context: ClinicalContextCreate,\n    db: Session = Depends(get_db),\n    current_user: User = Depends(get_current_user),\n):\n    \"\"\"\n    Create or update clinical context for the current user.\n\n    Args:\n        context: Clinical context data\n        db: Database session\n        current_user: Authenticated user\n\n    Returns:\n        Clinical context record\n    \"\"\"\n    # Check if context already exists for this user/session\n    existing_context = (\n        db.query(ClinicalContext)\n        .filter(\n            ClinicalContext.user_id == current_user.id,\n            ClinicalContext.session_id == (UUID(context.session_id) if context.session_id else None),\n        )\n        .first()\n    )\n\n    if existing_context:\n        raise HTTPException(\n            status_code=status.HTTP_409_CONFLICT,\n            detail=\"Clinical context already exists. Use PUT to update.\",\n        )\n\n    # Create new context\n    db_context = ClinicalContext(\n        user_id=current_user.id,\n        session_id=UUID(context.session_id) if context.session_id else None,\n        age=context.age,\n        gender=context.gender,\n        weight_kg=context.weight_kg,\n        height_cm=context.height_cm,\n        chief_complaint=context.chief_complaint,\n        problems=context.problems,\n        medications=context.medications,\n        allergies=context.allergies,\n        vitals=context.vitals.dict() if context.vitals else None,\n    )\n\n    db.add(db_context)\n    db.commit()\n    db.refresh(db_context)\n\n    return db_context.to_dict()\n\n\n@router.get(\"/clinical-contexts/current\")\nasync def get_current_clinical_context(\n    session_id: Optional[str] = None,\n    db: Session = Depends(get_db),\n    current_user: User = Depends(get_current_user),\n):\n    \"\"\"\n    Get clinical context for the current user.\n\n    Args:\n        session_id: Optional session ID to filter by\n        db: Database session\n        current_user: Authenticated user\n\n    Returns:\n        Clinical context record or None if not found\n    \"\"\"\n    query = db.query(ClinicalContext).filter(ClinicalContext.user_id == current_user.id)\n\n    if session_id:\n        query = query.filter(ClinicalContext.session_id == UUID(session_id))\n    else:\n        # Get most recent context\n        query = query.order_by(ClinicalContext.last_updated.desc())\n\n    context = query.first()\n\n    if not context:\n        # Return None instead of 404 - this is not an error condition\n        return None\n\n    return context.to_dict()\n\n\n@router.get(\"/clinical-contexts/{context_id}\")\nasync def get_clinical_context(\n    context_id: UUID,\n    db: Session = Depends(get_db),\n    current_user: User = Depends(get_current_user),\n):\n    \"\"\"\n    Get a specific clinical context by ID.\n\n    Args:\n        context_id: Clinical context UUID\n        db: Database session\n        current_user: Authenticated user\n\n    Returns:\n        Clinical context record\n    \"\"\"\n    context = (\n        db.query(ClinicalContext)\n        .filter(\n            ClinicalContext.id == context_id,\n            ClinicalContext.user_id == current_user.id,\n        )\n        .first()\n    )\n\n    if not context:\n        raise HTTPException(status_code=status.HTTP_404_NOT_FOUND, detail=\"Clinical context not found\")\n\n    return context.to_dict()\n\n\n@router.put(\"/clinical-contexts/{context_id}\")\nasync def update_clinical_context(\n    context_id: UUID,\n    context_update: ClinicalContextUpdate,\n    db: Session = Depends(get_db),\n    current_user: User = Depends(get_current_user),\n):\n    \"\"\"\n    Update a clinical context.\n\n    Args:\n        context_id: Clinical context UUID\n        context_update: Updated clinical context data\n        db: Database session\n        current_user: Authenticated user\n\n    Returns:\n        Updated clinical context record\n    \"\"\"\n    context = (\n        db.query(ClinicalContext)\n        .filter(\n            ClinicalContext.id == context_id,\n            ClinicalContext.user_id == current_user.id,\n        )\n        .first()\n    )\n\n    if not context:\n        raise HTTPException(status_code=status.HTTP_404_NOT_FOUND, detail=\"Clinical context not found\")\n\n    # Update fields if provided\n    update_data = context_update.dict(exclude_unset=True)\n    if \"vitals\" in update_data and update_data[\"vitals\"]:\n        update_data[\"vitals\"] = update_data[\"vitals\"].dict()\n\n    for field, value in update_data.items():\n        setattr(context, field, value)\n\n    db.commit()\n    db.refresh(context)\n\n    return context.to_dict()\n\n\n@router.delete(\"/clinical-contexts/{context_id}\", status_code=status.HTTP_204_NO_CONTENT)\nasync def delete_clinical_context(\n    context_id: UUID,\n    db: Session = Depends(get_db),\n    current_user: User = Depends(get_current_user),\n):\n    \"\"\"\n    Delete a clinical context.\n\n    Args:\n        context_id: Clinical context UUID\n        db: Database session\n        current_user: Authenticated user\n    \"\"\"\n    context = (\n        db.query(ClinicalContext)\n        .filter(\n            ClinicalContext.id == context_id,\n            ClinicalContext.user_id == current_user.id,\n        )\n        .first()\n    )\n\n    if not context:\n        raise HTTPException(status_code=status.HTTP_404_NOT_FOUND, detail=\"Clinical context not found\")\n\n    db.delete(context)\n    db.commit()\n\n    return None\n"
}

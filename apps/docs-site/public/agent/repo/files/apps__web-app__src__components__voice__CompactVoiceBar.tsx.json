{
  "path": "apps/web-app/src/components/voice/CompactVoiceBar.tsx",
  "language": "typescript",
  "size": 15171,
  "last_modified": "2025-12-04T01:16:49.134Z",
  "lines": 521,
  "content": "/**\n * CompactVoiceBar Component\n *\n * A compact (~80px height) voice mode bar that shows mic button, live transcript,\n * tool indicators, and action buttons. Designed to not obscure the chat conversation.\n *\n * Part of the two-mode panel architecture:\n * - Compact mode: This component (always visible when voice mode active)\n * - Expanded mode: VoiceExpandedDrawer slides up above this bar\n *\n * Phase 11: VoiceAssist Voice Pipeline Sprint\n */\n\nimport { useCallback } from \"react\";\nimport type { TTToolCall } from \"../../hooks/useThinkerTalkerSession\";\n\n// ============================================================================\n// Types\n// ============================================================================\n\nexport interface CompactVoiceBarProps {\n  /** Whether connected to voice backend */\n  isConnected: boolean;\n  /** Whether currently connecting */\n  isConnecting: boolean;\n  /** Whether actively listening for speech */\n  isListening: boolean;\n  /** Whether AI is speaking/playing audio */\n  isPlaying: boolean;\n  /** Whether microphone permission was denied */\n  isMicPermissionDenied: boolean;\n  /** Current pipeline state (idle, listening, processing, speaking) */\n  pipelineState: string;\n  /** Partial transcript from STT */\n  partialTranscript: string;\n  /** Current tool calls in progress */\n  currentToolCalls: TTToolCall[];\n  /** Total latency in ms (null if not measured) */\n  latencyMs: number | null;\n  /** Called when user wants to connect */\n  onConnect: () => void;\n  /** Called when user wants to disconnect */\n  onDisconnect: () => void;\n  /** Called when user wants to barge-in (interrupt AI) */\n  onBargeIn: () => void;\n  /** Called when user wants to expand the drawer */\n  onExpand: () => void;\n  /** Called when user wants to close voice mode */\n  onClose: () => void;\n  /** Called when user wants to open settings */\n  onOpenSettings: () => void;\n}\n\n// ============================================================================\n// Helper Components\n// ============================================================================\n\n/**\n * Compact mic button (48x48px)\n */\nfunction CompactMicButton({\n  isConnected,\n  isConnecting,\n  isListening,\n  isPlaying,\n  isMicPermissionDenied,\n  onConnect,\n  onDisconnect,\n  onBargeIn,\n}: {\n  isConnected: boolean;\n  isConnecting: boolean;\n  isListening: boolean;\n  isPlaying: boolean;\n  isMicPermissionDenied: boolean;\n  onConnect: () => void;\n  onDisconnect: () => void;\n  onBargeIn: () => void;\n}) {\n  const getButtonConfig = useCallback(() => {\n    if (isMicPermissionDenied) {\n      return {\n        action: onConnect,\n        icon: \"retry\",\n        className: \"bg-red-500 hover:bg-red-600 text-white\",\n        ariaLabel: \"Retry microphone access\",\n      };\n    }\n    if (isConnecting) {\n      return {\n        action: () => {},\n        icon: \"loading\",\n        className: \"bg-neutral-300 text-neutral-600 cursor-wait\",\n        ariaLabel: \"Connecting...\",\n      };\n    }\n    if (!isConnected) {\n      return {\n        action: onConnect,\n        icon: \"mic\",\n        className: \"bg-primary-500 hover:bg-primary-600 text-white\",\n        ariaLabel: \"Start voice mode\",\n      };\n    }\n    if (isPlaying) {\n      return {\n        action: onBargeIn,\n        icon: \"stop\",\n        className: \"bg-orange-500 hover:bg-orange-600 text-white animate-pulse\",\n        ariaLabel: \"Interrupt AI\",\n      };\n    }\n    if (isListening) {\n      return {\n        action: onDisconnect,\n        icon: \"mic-active\",\n        className: \"bg-green-500 hover:bg-green-600 text-white\",\n        ariaLabel: \"Stop listening\",\n      };\n    }\n    return {\n      action: onDisconnect,\n      icon: \"stop\",\n      className: \"bg-red-500 hover:bg-red-600 text-white\",\n      ariaLabel: \"End voice mode\",\n    };\n  }, [\n    isConnected,\n    isConnecting,\n    isListening,\n    isPlaying,\n    isMicPermissionDenied,\n    onConnect,\n    onDisconnect,\n    onBargeIn,\n  ]);\n\n  const config = getButtonConfig();\n\n  const renderIcon = () => {\n    switch (config.icon) {\n      case \"loading\":\n        return (\n          <svg className=\"w-5 h-5 animate-spin\" fill=\"none\" viewBox=\"0 0 24 24\">\n            <circle\n              className=\"opacity-25\"\n              cx=\"12\"\n              cy=\"12\"\n              r=\"10\"\n              stroke=\"currentColor\"\n              strokeWidth=\"4\"\n            />\n            <path\n              className=\"opacity-75\"\n              fill=\"currentColor\"\n              d=\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z\"\n            />\n          </svg>\n        );\n      case \"retry\":\n        return (\n          <svg\n            className=\"w-5 h-5\"\n            fill=\"none\"\n            viewBox=\"0 0 24 24\"\n            stroke=\"currentColor\"\n          >\n            <path\n              strokeLinecap=\"round\"\n              strokeLinejoin=\"round\"\n              strokeWidth={2}\n              d=\"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15\"\n            />\n          </svg>\n        );\n      case \"stop\":\n        return (\n          <svg className=\"w-5 h-5\" fill=\"currentColor\" viewBox=\"0 0 24 24\">\n            <rect x=\"6\" y=\"6\" width=\"12\" height=\"12\" rx=\"2\" />\n          </svg>\n        );\n      case \"mic-active\":\n        return (\n          <svg\n            className=\"w-5 h-5\"\n            fill=\"none\"\n            viewBox=\"0 0 24 24\"\n            stroke=\"currentColor\"\n          >\n            <path\n              strokeLinecap=\"round\"\n              strokeLinejoin=\"round\"\n              strokeWidth={2}\n              d=\"M12 18.75a6 6 0 006-6v-1.5m-6 7.5a6 6 0 01-6-6v-1.5m6 7.5v3.75m-3.75 0h7.5M12 15.75a3 3 0 01-3-3V4.5a3 3 0 116 0v8.25a3 3 0 01-3 3z\"\n            />\n          </svg>\n        );\n      default:\n        return (\n          <svg\n            className=\"w-5 h-5\"\n            fill=\"none\"\n            viewBox=\"0 0 24 24\"\n            stroke=\"currentColor\"\n          >\n            <path\n              strokeLinecap=\"round\"\n              strokeLinejoin=\"round\"\n              strokeWidth={1.5}\n              d=\"M12 18.75a6 6 0 006-6v-1.5m-6 7.5a6 6 0 01-6-6v-1.5m6 7.5v3.75m-3.75 0h7.5M12 15.75a3 3 0 01-3-3V4.5a3 3 0 116 0v8.25a3 3 0 01-3 3z\"\n            />\n          </svg>\n        );\n    }\n  };\n\n  return (\n    <button\n      type=\"button\"\n      onClick={config.action}\n      disabled={isConnecting}\n      className={`\n        relative w-12 h-12 rounded-full flex items-center justify-center\n        transition-all duration-200 shadow-md flex-shrink-0\n        ${config.className}\n      `}\n      aria-label={config.ariaLabel}\n      data-testid=\"compact-mic-button\"\n    >\n      {renderIcon()}\n    </button>\n  );\n}\n\n/**\n * Small tool status chip for compact display\n */\nfunction ToolChip({\n  name,\n  status,\n}: {\n  name: string;\n  status: TTToolCall[\"status\"];\n}) {\n  const statusColors = {\n    pending: \"bg-neutral-100 text-neutral-600\",\n    running: \"bg-blue-100 text-blue-700\",\n    completed: \"bg-green-100 text-green-700\",\n    failed: \"bg-red-100 text-red-700\",\n  };\n\n  const statusDot = {\n    pending: \"bg-neutral-400\",\n    running: \"bg-blue-500 animate-pulse\",\n    completed: \"bg-green-500\",\n    failed: \"bg-red-500\",\n  };\n\n  // Format tool name (remove underscores, truncate)\n  const displayName = name.replace(/_/g, \" \").split(\" \").slice(0, 2).join(\" \");\n\n  return (\n    <span\n      className={`inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium ${statusColors[status]}`}\n      title={name}\n    >\n      <span className={`w-1.5 h-1.5 rounded-full ${statusDot[status]}`} />\n      <span className=\"truncate max-w-[60px]\">{displayName}</span>\n    </span>\n  );\n}\n\n/**\n * Compact latency badge\n */\nfunction LatencyBadge({ ms }: { ms: number }) {\n  const getColor = () => {\n    if (ms < 1000) return \"bg-green-100 text-green-700\";\n    if (ms < 2000) return \"bg-yellow-100 text-yellow-700\";\n    return \"bg-red-100 text-red-700\";\n  };\n\n  return (\n    <span\n      className={`px-2 py-0.5 rounded-full text-xs font-medium ${getColor()}`}\n    >\n      {ms}ms\n    </span>\n  );\n}\n\n/**\n * Transcript line with state indicator\n */\nfunction TranscriptLine({ text, state }: { text: string; state: string }) {\n  const stateLabels: Record<string, string> = {\n    idle: \"Ready\",\n    listening: \"Listening\",\n    processing: \"Thinking\",\n    speaking: \"Speaking\",\n    cancelled: \"Cancelled\",\n  };\n\n  const label = stateLabels[state] || \"Ready\";\n\n  if (!text && state === \"idle\") {\n    return (\n      <p className=\"text-sm text-neutral-400 truncate\">\n        Tap mic to start speaking...\n      </p>\n    );\n  }\n\n  return (\n    <div className=\"min-w-0\">\n      <p className=\"text-xs text-neutral-500 font-medium\">{label}</p>\n      {text ? (\n        <p className=\"text-sm text-neutral-800 truncate\">{text}</p>\n      ) : (\n        <p className=\"text-sm text-neutral-400 truncate italic\">\n          {state === \"listening\"\n            ? \"Listening...\"\n            : state === \"processing\"\n              ? \"Processing...\"\n              : state === \"speaking\"\n                ? \"Speaking...\"\n                : \"...\"}\n        </p>\n      )}\n    </div>\n  );\n}\n\n/**\n * Icon button for action bar\n */\nfunction IconButton({\n  icon,\n  onClick,\n  label,\n  testId,\n}: {\n  icon: \"settings\" | \"expand\" | \"close\" | \"metrics\";\n  onClick: () => void;\n  label: string;\n  testId?: string;\n}) {\n  const renderIcon = () => {\n    switch (icon) {\n      case \"settings\":\n        return (\n          <svg\n            className=\"w-4 h-4\"\n            fill=\"none\"\n            viewBox=\"0 0 24 24\"\n            stroke=\"currentColor\"\n            strokeWidth={1.5}\n          >\n            <path\n              strokeLinecap=\"round\"\n              strokeLinejoin=\"round\"\n              d=\"M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 010 .255c-.007.378.138.75.43.99l1.005.828c.424.35.534.954.26 1.43l-1.298 2.247a1.125 1.125 0 01-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 01-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 01-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 01-1.369-.49l-1.297-2.247a1.125 1.125 0 01.26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 010-.255c.007-.378-.138-.75-.43-.99l-1.004-.828a1.125 1.125 0 01-.26-1.43l1.297-2.247a1.125 1.125 0 011.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281z\"\n            />\n            <path\n              strokeLinecap=\"round\"\n              strokeLinejoin=\"round\"\n              d=\"M15 12a3 3 0 11-6 0 3 3 0 016 0z\"\n            />\n          </svg>\n        );\n      case \"expand\":\n        return (\n          <svg\n            className=\"w-4 h-4\"\n            fill=\"none\"\n            viewBox=\"0 0 24 24\"\n            stroke=\"currentColor\"\n            strokeWidth={1.5}\n          >\n            <path\n              strokeLinecap=\"round\"\n              strokeLinejoin=\"round\"\n              d=\"M4.5 15.75l7.5-7.5 7.5 7.5\"\n            />\n          </svg>\n        );\n      case \"metrics\":\n        return (\n          <svg\n            className=\"w-4 h-4\"\n            fill=\"none\"\n            viewBox=\"0 0 24 24\"\n            stroke=\"currentColor\"\n            strokeWidth={1.5}\n          >\n            <path\n              strokeLinecap=\"round\"\n              strokeLinejoin=\"round\"\n              d=\"M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z\"\n            />\n          </svg>\n        );\n      case \"close\":\n        return (\n          <svg\n            className=\"w-4 h-4\"\n            fill=\"none\"\n            viewBox=\"0 0 24 24\"\n            stroke=\"currentColor\"\n            strokeWidth={2}\n          >\n            <path\n              strokeLinecap=\"round\"\n              strokeLinejoin=\"round\"\n              d=\"M6 18L18 6M6 6l12 12\"\n            />\n          </svg>\n        );\n    }\n  };\n\n  return (\n    <button\n      type=\"button\"\n      onClick={onClick}\n      className=\"p-2 text-neutral-400 hover:text-neutral-600 hover:bg-neutral-100 rounded-lg transition-colors\"\n      aria-label={label}\n      data-testid={testId}\n    >\n      {renderIcon()}\n    </button>\n  );\n}\n\n// ============================================================================\n// Main Component\n// ============================================================================\n\nexport function CompactVoiceBar({\n  isConnected,\n  isConnecting,\n  isListening,\n  isPlaying,\n  isMicPermissionDenied,\n  pipelineState,\n  partialTranscript,\n  currentToolCalls,\n  latencyMs,\n  onConnect,\n  onDisconnect,\n  onBargeIn,\n  onExpand,\n  onClose,\n  onOpenSettings,\n}: CompactVoiceBarProps) {\n  return (\n    <div\n      className=\"flex items-center gap-3 h-16 px-4 bg-white border-2 border-primary-500 rounded-lg shadow-lg\"\n      data-testid=\"compact-voice-bar\"\n    >\n      {/* Compact mic button (48x48) */}\n      <CompactMicButton\n        isConnected={isConnected}\n        isConnecting={isConnecting}\n        isListening={isListening}\n        isPlaying={isPlaying}\n        isMicPermissionDenied={isMicPermissionDenied}\n        onConnect={onConnect}\n        onDisconnect={onDisconnect}\n        onBargeIn={onBargeIn}\n      />\n\n      {/* Live transcript + status */}\n      <div className=\"flex-1 min-w-0\">\n        <TranscriptLine text={partialTranscript} state={pipelineState} />\n\n        {/* Tool indicator chips */}\n        {currentToolCalls.length > 0 && (\n          <div className=\"flex gap-1 mt-1 overflow-hidden\">\n            {currentToolCalls.slice(0, 2).map((tc) => (\n              <ToolChip key={tc.id} name={tc.name} status={tc.status} />\n            ))}\n            {currentToolCalls.length > 2 && (\n              <span className=\"text-xs text-neutral-500 px-1\">\n                +{currentToolCalls.length - 2}\n              </span>\n            )}\n          </div>\n        )}\n      </div>\n\n      {/* Action buttons */}\n      <div className=\"flex items-center gap-1 flex-shrink-0\">\n        {/* Latency badge */}\n        {latencyMs !== null && isConnected && <LatencyBadge ms={latencyMs} />}\n\n        <IconButton\n          icon=\"settings\"\n          onClick={onOpenSettings}\n          label=\"Voice settings\"\n          testId=\"compact-settings-btn\"\n        />\n        <IconButton\n          icon=\"expand\"\n          onClick={onExpand}\n          label=\"Expand details\"\n          testId=\"compact-expand-btn\"\n        />\n        <IconButton\n          icon=\"close\"\n          onClick={onClose}\n          label=\"Close voice mode\"\n          testId=\"compact-close-btn\"\n        />\n      </div>\n    </div>\n  );\n}\n\nexport default CompactVoiceBar;\n"
}

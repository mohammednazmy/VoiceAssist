{
  "path": "apps/admin-panel/src/components/security/UserAPIKeyManager.tsx",
  "language": "typescript",
  "size": 14750,
  "last_modified": "2025-11-29T04:23:35.150Z",
  "lines": 457,
  "content": "/**\n * UserAPIKeyManager Component\n * Allows users to create, view, and revoke their personal API keys\n * for programmatic access to the VoiceAssist API.\n */\n\nimport { useState } from \"react\";\nimport {\n  useUserAPIKeys,\n  UserAPIKey,\n  UserAPIKeyCreated,\n} from \"../../hooks/useUserAPIKeys\";\n\ninterface CreateKeyFormProps {\n  onSubmit: (\n    name: string,\n    expiresInDays?: number,\n  ) => Promise<UserAPIKeyCreated>;\n  onCancel: () => void;\n}\n\nfunction CreateKeyForm({ onSubmit, onCancel }: CreateKeyFormProps) {\n  const [name, setName] = useState(\"\");\n  const [expiresInDays, setExpiresInDays] = useState<number | \"\">(\"\");\n  const [saving, setSaving] = useState(false);\n  const [error, setError] = useState<string | null>(null);\n  const [createdKey, setCreatedKey] = useState<UserAPIKeyCreated | null>(null);\n  const [copied, setCopied] = useState(false);\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault();\n    if (!name.trim()) return;\n\n    setSaving(true);\n    setError(null);\n    try {\n      const result = await onSubmit(\n        name.trim(),\n        expiresInDays ? Number(expiresInDays) : undefined,\n      );\n      setCreatedKey(result);\n    } catch (err) {\n      setError(err instanceof Error ? err.message : \"Failed to create key\");\n    } finally {\n      setSaving(false);\n    }\n  };\n\n  const handleCopy = async () => {\n    if (!createdKey) return;\n    try {\n      await navigator.clipboard.writeText(createdKey.key);\n      setCopied(true);\n      setTimeout(() => setCopied(false), 2000);\n    } catch (err) {\n      console.error(\"Failed to copy:\", err);\n    }\n  };\n\n  // Show the created key (only shown once!)\n  if (createdKey) {\n    return (\n      <div className=\"bg-green-900/20 border border-green-800 rounded-lg p-4 space-y-4\">\n        <div className=\"flex items-start gap-3\">\n          <span className=\"text-2xl\">üîë</span>\n          <div className=\"flex-1\">\n            <h3 className=\"text-sm font-medium text-green-400\">\n              API Key Created\n            </h3>\n            <p className=\"text-xs text-slate-400 mt-1\">\n              Save this key now! It will not be shown again.\n            </p>\n          </div>\n        </div>\n\n        <div className=\"relative\">\n          <div className=\"p-3 bg-slate-900 border border-slate-700 rounded font-mono text-sm text-slate-200 break-all\">\n            {createdKey.key}\n          </div>\n          <button\n            onClick={handleCopy}\n            className=\"absolute top-2 right-2 px-2 py-1 text-xs bg-slate-800 hover:bg-slate-700 text-slate-300 rounded transition-colors\"\n          >\n            {copied ? \"Copied!\" : \"Copy\"}\n          </button>\n        </div>\n\n        <div className=\"text-xs text-slate-500 space-y-1\">\n          <p>\n            <strong>Name:</strong> {createdKey.name}\n          </p>\n          <p>\n            <strong>Prefix:</strong> {createdKey.key_prefix}...\n          </p>\n          {createdKey.expires_at && (\n            <p>\n              <strong>Expires:</strong>{\" \"}\n              {new Date(createdKey.expires_at).toLocaleDateString()}\n            </p>\n          )}\n        </div>\n\n        <div className=\"bg-yellow-900/20 border border-yellow-800 rounded p-2 text-xs text-yellow-400\">\n          ‚ö†Ô∏è Store this key securely. You will need to create a new key if you\n          lose it.\n        </div>\n\n        <button\n          onClick={onCancel}\n          className=\"w-full px-4 py-2 text-sm bg-slate-800 hover:bg-slate-700 text-slate-300 rounded transition-colors\"\n        >\n          Done\n        </button>\n      </div>\n    );\n  }\n\n  return (\n    <form\n      onSubmit={handleSubmit}\n      className=\"bg-slate-900/50 border border-slate-800 rounded-lg p-4 space-y-4\"\n    >\n      <div className=\"flex items-start gap-3\">\n        <span className=\"text-2xl\">üîë</span>\n        <div className=\"flex-1\">\n          <h3 className=\"text-sm font-medium text-slate-200\">\n            Create New API Key\n          </h3>\n          <p className=\"text-xs text-slate-500 mt-1\">\n            Generate a key for programmatic access to the VoiceAssist API\n          </p>\n        </div>\n      </div>\n\n      {error && (\n        <div className=\"p-2 bg-red-900/30 border border-red-800/50 rounded text-xs text-red-400\">\n          {error}\n        </div>\n      )}\n\n      <div className=\"space-y-3\">\n        <div>\n          <label className=\"block text-xs text-slate-500 mb-1\">\n            Key Name *\n          </label>\n          <input\n            type=\"text\"\n            value={name}\n            onChange={(e) => setName(e.target.value)}\n            placeholder=\"e.g., Development, Production, CI/CD\"\n            maxLength={255}\n            className=\"w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded text-sm text-slate-200 placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500\"\n            autoFocus\n          />\n        </div>\n\n        <div>\n          <label className=\"block text-xs text-slate-500 mb-1\">\n            Expiration (days){\" \"}\n            <span className=\"text-slate-600\">\n              - leave empty for no expiration\n            </span>\n          </label>\n          <select\n            value={expiresInDays}\n            onChange={(e) =>\n              setExpiresInDays(e.target.value ? Number(e.target.value) : \"\")\n            }\n            className=\"w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded text-sm text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500\"\n          >\n            <option value=\"\">Never expires</option>\n            <option value=\"7\">7 days</option>\n            <option value=\"30\">30 days</option>\n            <option value=\"90\">90 days</option>\n            <option value=\"180\">180 days</option>\n            <option value=\"365\">1 year</option>\n          </select>\n        </div>\n      </div>\n\n      <div className=\"flex gap-2\">\n        <button\n          type=\"submit\"\n          disabled={saving || !name.trim()}\n          className=\"flex-1 px-4 py-2 text-sm bg-blue-900/50 hover:bg-blue-800/50 text-blue-400 border border-blue-800 rounded transition-colors disabled:opacity-50\"\n        >\n          {saving ? \"Creating...\" : \"Create Key\"}\n        </button>\n        <button\n          type=\"button\"\n          onClick={onCancel}\n          className=\"px-4 py-2 text-sm bg-slate-800 hover:bg-slate-700 text-slate-400 rounded transition-colors\"\n        >\n          Cancel\n        </button>\n      </div>\n    </form>\n  );\n}\n\ninterface KeyCardProps {\n  apiKey: UserAPIKey;\n  onRevoke: () => Promise<void>;\n}\n\nfunction KeyCard({ apiKey, onRevoke }: KeyCardProps) {\n  const [revoking, setRevoking] = useState(false);\n\n  const handleRevoke = async () => {\n    if (\n      !confirm(\n        `Revoke the API key \"${apiKey.name}\"? This action cannot be undone.`,\n      )\n    ) {\n      return;\n    }\n    setRevoking(true);\n    try {\n      await onRevoke();\n    } finally {\n      setRevoking(false);\n    }\n  };\n\n  const isExpired =\n    apiKey.expires_at && new Date(apiKey.expires_at) < new Date();\n\n  return (\n    <div\n      className={`bg-slate-900/50 border rounded-lg p-4 ${\n        apiKey.is_revoked\n          ? \"border-red-800/50 opacity-60\"\n          : isExpired\n            ? \"border-yellow-800/50\"\n            : \"border-slate-800\"\n      }`}\n    >\n      <div className=\"flex items-start justify-between gap-3\">\n        <div className=\"flex-1 min-w-0\">\n          <div className=\"flex items-center gap-2\">\n            <h3 className=\"text-sm font-medium text-slate-100 truncate\">\n              {apiKey.name}\n            </h3>\n            {apiKey.is_revoked && (\n              <span className=\"inline-flex items-center px-2 py-0.5 rounded text-[10px] font-medium bg-red-900/50 text-red-400 border border-red-800\">\n                Revoked\n              </span>\n            )}\n            {isExpired && !apiKey.is_revoked && (\n              <span className=\"inline-flex items-center px-2 py-0.5 rounded text-[10px] font-medium bg-yellow-900/50 text-yellow-400 border border-yellow-800\">\n                Expired\n              </span>\n            )}\n          </div>\n          <p className=\"text-xs font-mono text-slate-500 mt-1\">\n            {apiKey.key_prefix}...\n          </p>\n        </div>\n        {!apiKey.is_revoked && (\n          <button\n            onClick={handleRevoke}\n            disabled={revoking}\n            className=\"px-2 py-1 text-xs bg-red-900/50 hover:bg-red-800/50 text-red-400 border border-red-800 rounded transition-colors disabled:opacity-50\"\n          >\n            {revoking ? \"Revoking...\" : \"Revoke\"}\n          </button>\n        )}\n      </div>\n\n      <div className=\"mt-3 grid grid-cols-2 gap-2 text-xs\">\n        <div>\n          <span className=\"text-slate-500\">Created:</span>{\" \"}\n          <span className=\"text-slate-400\">\n            {new Date(apiKey.created_at).toLocaleDateString()}\n          </span>\n        </div>\n        <div>\n          <span className=\"text-slate-500\">Expires:</span>{\" \"}\n          <span\n            className={`${isExpired ? \"text-yellow-400\" : \"text-slate-400\"}`}\n          >\n            {apiKey.expires_at\n              ? new Date(apiKey.expires_at).toLocaleDateString()\n              : \"Never\"}\n          </span>\n        </div>\n        <div className=\"col-span-2\">\n          <span className=\"text-slate-500\">Last used:</span>{\" \"}\n          <span className=\"text-slate-400\">\n            {apiKey.last_used_at\n              ? new Date(apiKey.last_used_at).toLocaleString()\n              : \"Never\"}\n          </span>\n        </div>\n      </div>\n    </div>\n  );\n}\n\nexport function UserAPIKeyManager() {\n  const {\n    keys,\n    loading,\n    error,\n    lastUpdated,\n    refreshKeys,\n    createKey,\n    revokeKey,\n  } = useUserAPIKeys();\n  const [showCreateForm, setShowCreateForm] = useState(false);\n\n  const activeKeys = keys.filter((k) => !k.is_revoked);\n  const revokedKeys = keys.filter((k) => k.is_revoked);\n\n  if (loading && keys.length === 0) {\n    return (\n      <div className=\"bg-slate-900/50 border border-slate-800 rounded-lg\">\n        <div className=\"px-4 py-3 border-b border-slate-800\">\n          <h2 className=\"text-sm font-medium text-slate-200\">API Keys</h2>\n          <p className=\"text-xs text-slate-500 mt-1\">Loading...</p>\n        </div>\n        <div className=\"p-4\">\n          <div className=\"animate-pulse space-y-3\">\n            {Array.from({ length: 2 }).map((_, idx) => (\n              <div key={idx} className=\"h-20 bg-slate-800/50 rounded-lg\" />\n            ))}\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"bg-slate-900/50 border border-slate-800 rounded-lg\">\n      <div className=\"px-4 py-3 border-b border-slate-800 flex items-center justify-between\">\n        <div>\n          <h2 className=\"text-sm font-medium text-slate-200\">API Keys</h2>\n          <p className=\"text-xs text-slate-500 mt-1\">\n            Manage keys for programmatic API access\n          </p>\n        </div>\n        <div className=\"flex items-center gap-2\">\n          <button\n            onClick={() => refreshKeys()}\n            disabled={loading}\n            className=\"px-2 py-1 text-xs bg-slate-800 hover:bg-slate-700 text-slate-300 rounded transition-colors disabled:opacity-50\"\n          >\n            {loading ? \"Refreshing...\" : \"Refresh\"}\n          </button>\n          {!showCreateForm && (\n            <button\n              onClick={() => setShowCreateForm(true)}\n              className=\"px-2 py-1 text-xs bg-blue-900/50 hover:bg-blue-800/50 text-blue-400 border border-blue-800 rounded transition-colors\"\n            >\n              + New Key\n            </button>\n          )}\n        </div>\n      </div>\n\n      {error && (\n        <div className=\"px-4 py-3 bg-red-900/20 border-b border-red-800 text-red-400 text-sm\">\n          {error}\n        </div>\n      )}\n\n      <div className=\"p-4 space-y-4\">\n        {/* Create Form */}\n        {showCreateForm && (\n          <CreateKeyForm\n            onSubmit={createKey}\n            onCancel={() => setShowCreateForm(false)}\n          />\n        )}\n\n        {/* Usage Instructions */}\n        {!showCreateForm && keys.length === 0 && (\n          <div className=\"text-center py-8\">\n            <span className=\"text-4xl\">üîë</span>\n            <h3 className=\"text-sm font-medium text-slate-300 mt-3\">\n              No API Keys\n            </h3>\n            <p className=\"text-xs text-slate-500 mt-1 max-w-xs mx-auto\">\n              Create an API key to access the VoiceAssist API programmatically\n              using the X-API-Key header.\n            </p>\n            <button\n              onClick={() => setShowCreateForm(true)}\n              className=\"mt-4 px-4 py-2 text-sm bg-blue-900/50 hover:bg-blue-800/50 text-blue-400 border border-blue-800 rounded transition-colors\"\n            >\n              Create Your First Key\n            </button>\n          </div>\n        )}\n\n        {/* Active Keys */}\n        {activeKeys.length > 0 && (\n          <div className=\"space-y-2\">\n            <h3 className=\"text-xs text-slate-500 uppercase tracking-wide\">\n              Active Keys ({activeKeys.length})\n            </h3>\n            <div className=\"space-y-3\">\n              {activeKeys.map((key) => (\n                <KeyCard\n                  key={key.id}\n                  apiKey={key}\n                  onRevoke={() => revokeKey(key.id)}\n                />\n              ))}\n            </div>\n          </div>\n        )}\n\n        {/* Revoked Keys */}\n        {revokedKeys.length > 0 && (\n          <div className=\"space-y-2\">\n            <h3 className=\"text-xs text-slate-500 uppercase tracking-wide\">\n              Revoked Keys ({revokedKeys.length})\n            </h3>\n            <div className=\"space-y-3\">\n              {revokedKeys.map((key) => (\n                <KeyCard\n                  key={key.id}\n                  apiKey={key}\n                  onRevoke={() => revokeKey(key.id)}\n                />\n              ))}\n            </div>\n          </div>\n        )}\n\n        {/* Usage Example */}\n        {activeKeys.length > 0 && !showCreateForm && (\n          <div className=\"mt-6 pt-4 border-t border-slate-800\">\n            <h3 className=\"text-xs text-slate-500 uppercase tracking-wide mb-2\">\n              Usage\n            </h3>\n            <div className=\"p-3 bg-slate-800/50 rounded font-mono text-xs text-slate-400\">\n              <code>\n                curl -H \"X-API-Key: va_k_...\"\n                https://api.voiceassist.example.com/...\n              </code>\n            </div>\n          </div>\n        )}\n      </div>\n\n      {/* Last Updated */}\n      {lastUpdated && (\n        <div className=\"px-4 py-2 border-t border-slate-800 text-xs text-slate-600 text-center\">\n          Last updated: {lastUpdated.toLocaleTimeString()}\n        </div>\n      )}\n    </div>\n  );\n}\n"
}

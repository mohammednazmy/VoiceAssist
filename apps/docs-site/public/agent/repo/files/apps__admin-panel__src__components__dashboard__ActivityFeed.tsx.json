{
  "path": "apps/admin-panel/src/components/dashboard/ActivityFeed.tsx",
  "language": "typescript",
  "size": 8636,
  "last_modified": "2025-12-03T03:40:02.339Z",
  "lines": 310,
  "content": "import {\n  useRealtimeEvents,\n  AdminEvent,\n  AdminEventType,\n  ConnectionStatus,\n} from \"../../hooks/useRealtimeEvents\";\n\n// Event type display configuration\nconst eventConfig: Record<\n  AdminEventType,\n  { icon: string; label: string; color: string }\n> = {\n  \"session.connected\": {\n    icon: \"üîó\",\n    label: \"Session Connected\",\n    color: \"text-green-400\",\n  },\n  \"session.disconnected\": {\n    icon: \"üîå\",\n    label: \"Session Disconnected\",\n    color: \"text-slate-400\",\n  },\n  \"conversation.created\": {\n    icon: \"üí¨\",\n    label: \"Conversation Created\",\n    color: \"text-blue-400\",\n  },\n  \"conversation.updated\": {\n    icon: \"‚úèÔ∏è\",\n    label: \"Conversation Updated\",\n    color: \"text-blue-300\",\n  },\n  \"conversation.deleted\": {\n    icon: \"üóëÔ∏è\",\n    label: \"Conversation Deleted\",\n    color: \"text-red-400\",\n  },\n  \"message.created\": {\n    icon: \"üìù\",\n    label: \"Message Created\",\n    color: \"text-slate-300\",\n  },\n  \"clinical_context.created\": {\n    icon: \"üè•\",\n    label: \"Clinical Context Created\",\n    color: \"text-purple-400\",\n  },\n  \"clinical_context.updated\": {\n    icon: \"üè•\",\n    label: \"Clinical Context Updated\",\n    color: \"text-purple-300\",\n  },\n  \"attachment.uploaded\": {\n    icon: \"üìé\",\n    label: \"Attachment Uploaded\",\n    color: \"text-cyan-400\",\n  },\n  \"attachment.deleted\": {\n    icon: \"üìé\",\n    label: \"Attachment Deleted\",\n    color: \"text-red-300\",\n  },\n  \"phi.accessed\": {\n    icon: \"üîì\",\n    label: \"PHI Accessed\",\n    color: \"text-amber-400\",\n  },\n  \"phi.detected\": {\n    icon: \"‚ö†Ô∏è\",\n    label: \"PHI Detected\",\n    color: \"text-amber-500\",\n  },\n  \"voice.session_started\": {\n    icon: \"üé§\",\n    label: \"Voice Session Started\",\n    color: \"text-green-400\",\n  },\n  \"voice.session_ended\": {\n    icon: \"üé§\",\n    label: \"Voice Session Ended\",\n    color: \"text-slate-400\",\n  },\n  \"voice.session_error\": {\n    icon: \"üé§\",\n    label: \"Voice Session Error\",\n    color: \"text-red-400\",\n  },\n  \"tt.state_changed\": {\n    icon: \"ü§ñ\",\n    label: \"TT State Changed\",\n    color: \"text-blue-400\",\n  },\n  \"tt.tool_called\": {\n    icon: \"üîß\",\n    label: \"Tool Called\",\n    color: \"text-cyan-400\",\n  },\n  \"tt.context_created\": {\n    icon: \"üìã\",\n    label: \"TT Context Created\",\n    color: \"text-purple-400\",\n  },\n  \"tt.context_expired\": {\n    icon: \"üìã\",\n    label: \"TT Context Expired\",\n    color: \"text-slate-400\",\n  },\n  \"system.alert\": { icon: \"üö®\", label: \"System Alert\", color: \"text-red-500\" },\n  \"system.health_changed\": {\n    icon: \"üíì\",\n    label: \"Health Changed\",\n    color: \"text-amber-400\",\n  },\n  \"user.logged_in\": {\n    icon: \"üë§\",\n    label: \"User Logged In\",\n    color: \"text-green-400\",\n  },\n  \"user.logged_out\": {\n    icon: \"üë§\",\n    label: \"User Logged Out\",\n    color: \"text-slate-400\",\n  },\n  \"user.created\": {\n    icon: \"‚ú®\",\n    label: \"User Created\",\n    color: \"text-green-500\",\n  },\n};\n\nconst connectionStatusConfig: Record<\n  ConnectionStatus,\n  { label: string; color: string; dot: string }\n> = {\n  connecting: {\n    label: \"Connecting\",\n    color: \"text-yellow-400\",\n    dot: \"bg-yellow-400\",\n  },\n  connected: { label: \"Live\", color: \"text-green-400\", dot: \"bg-green-400\" },\n  reconnecting: {\n    label: \"Reconnecting\",\n    color: \"text-amber-400\",\n    dot: \"bg-amber-400 animate-pulse\",\n  },\n  disconnected: {\n    label: \"Disconnected\",\n    color: \"text-slate-400\",\n    dot: \"bg-slate-400\",\n  },\n  failed: { label: \"Failed\", color: \"text-red-400\", dot: \"bg-red-400\" },\n};\n\nfunction formatTimestamp(timestamp: string): string {\n  const date = new Date(timestamp);\n  const now = new Date();\n  const diffMs = now.getTime() - date.getTime();\n  const diffSec = Math.floor(diffMs / 1000);\n  const diffMin = Math.floor(diffSec / 60);\n  const diffHour = Math.floor(diffMin / 60);\n\n  if (diffSec < 60) return \"just now\";\n  if (diffMin < 60) return `${diffMin}m ago`;\n  if (diffHour < 24) return `${diffHour}h ago`;\n  return date.toLocaleDateString();\n}\n\nfunction EventItem({ event }: { event: AdminEvent }) {\n  const config = eventConfig[event.type] || {\n    icon: \"üìå\",\n    label: event.type,\n    color: \"text-slate-400\",\n  };\n\n  return (\n    <div className=\"flex items-start gap-3 py-2 border-b border-slate-800 last:border-0\">\n      <span className=\"text-base flex-shrink-0\">{config.icon}</span>\n      <div className=\"flex-1 min-w-0\">\n        <div className={`text-sm font-medium ${config.color}`}>\n          {config.label}\n        </div>\n        {event.user_email && (\n          <div className=\"text-xs text-slate-500 truncate\">\n            {event.user_email}\n          </div>\n        )}\n        {event.data && Object.keys(event.data).length > 0 && (\n          <div className=\"text-xs text-slate-600 truncate\">\n            {Object.entries(event.data)\n              .slice(0, 2)\n              .map(([k, v]) => (\n                <span key={k} className=\"mr-2\">\n                  {k}: {typeof v === \"string\" ? v : JSON.stringify(v)}\n                </span>\n              ))}\n          </div>\n        )}\n      </div>\n      <span className=\"text-xs text-slate-500 flex-shrink-0\">\n        {formatTimestamp(event.timestamp)}\n      </span>\n    </div>\n  );\n}\n\nexport function ActivityFeed() {\n  const { status, events, metrics, clearEvents, connect, lastEventTime } =\n    useRealtimeEvents({\n      autoConnect: true,\n      maxReconnectAttempts: 5,\n    });\n\n  const statusConfig = connectionStatusConfig[status];\n\n  return (\n    <div className=\"bg-slate-900/50 border border-slate-800 rounded-lg\">\n      {/* Header */}\n      <div className=\"px-4 py-3 border-b border-slate-800 flex items-center justify-between\">\n        <div className=\"flex items-center gap-3\">\n          <h3 className=\"text-sm font-semibold text-slate-200\">\n            Activity Feed\n          </h3>\n          <span\n            className={`inline-flex items-center gap-1.5 text-xs ${statusConfig.color}`}\n          >\n            <span className={`h-1.5 w-1.5 rounded-full ${statusConfig.dot}`} />\n            {statusConfig.label}\n          </span>\n        </div>\n        <div className=\"flex items-center gap-2\">\n          {events.length > 0 && (\n            <button\n              type=\"button\"\n              onClick={clearEvents}\n              className=\"text-xs text-slate-500 hover:text-slate-300 transition-colors\"\n            >\n              Clear\n            </button>\n          )}\n          {status === \"disconnected\" || status === \"failed\" ? (\n            <button\n              type=\"button\"\n              onClick={connect}\n              className=\"text-xs text-blue-400 hover:text-blue-300 transition-colors\"\n            >\n              Reconnect\n            </button>\n          ) : null}\n        </div>\n      </div>\n\n      {/* Real-time Metrics (if available) */}\n      {metrics && (\n        <div className=\"px-4 py-2 border-b border-slate-800 bg-slate-900/30\">\n          <div className=\"grid grid-cols-3 gap-4 text-xs\">\n            <div>\n              <span className=\"text-slate-500\">WS Sessions:</span>{\" \"}\n              <span className=\"text-slate-300\">\n                {metrics.active_websocket_sessions}\n              </span>\n            </div>\n            <div>\n              <span className=\"text-slate-500\">DB Pool:</span>{\" \"}\n              <span className=\"text-slate-300\">\n                {metrics.database_pool.checked_out}/\n                {metrics.database_pool.pool_size}\n              </span>\n            </div>\n            <div>\n              <span className=\"text-slate-500\">Redis:</span>{\" \"}\n              <span className=\"text-slate-300\">\n                {metrics.redis_pool.available_connections}/\n                {metrics.redis_pool.total_connections}\n              </span>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Events List */}\n      <div className=\"max-h-[300px] overflow-y-auto\">\n        {events.length === 0 ? (\n          <div className=\"px-4 py-8 text-center text-sm text-slate-500\">\n            {status === \"connected\" ? (\n              <>Waiting for events...</>\n            ) : status === \"connecting\" ? (\n              <>Connecting to event stream...</>\n            ) : (\n              <>No events received</>\n            )}\n          </div>\n        ) : (\n          <div className=\"px-4 py-2\">\n            {events.slice(0, 20).map((event, idx) => (\n              <EventItem key={`${event.timestamp}-${idx}`} event={event} />\n            ))}\n          </div>\n        )}\n      </div>\n\n      {/* Footer */}\n      {lastEventTime && (\n        <div className=\"px-4 py-2 border-t border-slate-800 text-xs text-slate-500\">\n          Last event: {formatTimestamp(lastEventTime)}\n        </div>\n      )}\n    </div>\n  );\n}\n"
}

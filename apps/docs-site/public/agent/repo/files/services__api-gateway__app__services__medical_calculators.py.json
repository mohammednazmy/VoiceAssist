{
  "path": "services/api-gateway/app/services/medical_calculators.py",
  "language": "python",
  "size": 66203,
  "last_modified": "2025-12-04T11:26:58.981Z",
  "lines": 1899,
  "content": "\"\"\"\nMedical Calculators Library\n\nComprehensive collection of evidence-based medical calculators including:\n- Cardiovascular: CHA2DS2-VASc, HEART Score, Wells DVT/PE, Framingham\n- Nephrology: CKD-EPI, MDRD, Cockcroft-Gault\n- Hepatology: MELD, MELD-Na, Child-Pugh, FIB-4\n- Critical Care: APACHE II, SOFA, qSOFA, CURB-65, NEWS2\n- General: BMI, BSA, Anion Gap, Corrected Calcium, A-a Gradient\n\nEach calculator includes:\n- Input validation\n- Calculation logic with references\n- Risk stratification and interpretation\n- Clinical recommendations\n\"\"\"\n\nimport math\nfrom dataclasses import dataclass, field\nfrom enum import Enum\nfrom typing import Any, Dict, List, Optional\n\n\nclass Sex(str, Enum):\n    \"\"\"Biological sex for calculations.\"\"\"\n\n    MALE = \"male\"\n    FEMALE = \"female\"\n\n\nclass Race(str, Enum):\n    \"\"\"Race categories for certain calculations (e.g., CKD-EPI).\"\"\"\n\n    BLACK = \"black\"\n    NON_BLACK = \"non_black\"\n    # Note: Race-based adjustments are controversial and being phased out\n    # in many guidelines. We include them for backward compatibility.\n\n\nclass RiskLevel(str, Enum):\n    \"\"\"Risk stratification levels.\"\"\"\n\n    VERY_LOW = \"very_low\"\n    LOW = \"low\"\n    MODERATE = \"moderate\"\n    HIGH = \"high\"\n    VERY_HIGH = \"very_high\"\n\n\n@dataclass\nclass CalculatorResult:\n    \"\"\"Standardized result from any medical calculator.\"\"\"\n\n    calculator_name: str\n    score: float\n    unit: Optional[str] = None\n    risk_level: Optional[RiskLevel] = None\n    interpretation: str = \"\"\n    recommendations: List[str] = field(default_factory=list)\n    components: Dict[str, Any] = field(default_factory=dict)\n    references: List[str] = field(default_factory=list)\n    warnings: List[str] = field(default_factory=list)\n\n\nclass MedicalCalculators:\n    \"\"\"\n    Collection of evidence-based medical calculators.\n\n    All calculations follow current clinical guidelines and include\n    proper references. Results should be validated by clinical judgment.\n    \"\"\"\n\n    # =========================================================================\n    # CARDIOVASCULAR CALCULATORS\n    # =========================================================================\n\n    @staticmethod\n    def cha2ds2_vasc(\n        age: int,\n        sex: Sex,\n        chf: bool = False,\n        hypertension: bool = False,\n        stroke_tia_history: bool = False,\n        vascular_disease: bool = False,\n        diabetes: bool = False,\n    ) -> CalculatorResult:\n        \"\"\"\n        CHA2DS2-VASc Score for Atrial Fibrillation Stroke Risk.\n\n        Estimates stroke risk in patients with atrial fibrillation.\n\n        Args:\n            age: Patient age in years\n            sex: Biological sex\n            chf: Congestive heart failure history\n            hypertension: Hypertension history\n            stroke_tia_history: Prior stroke or TIA\n            vascular_disease: Prior MI, PAD, or aortic plaque\n            diabetes: Diabetes mellitus\n\n        Returns:\n            CalculatorResult with score 0-9 and anticoagulation recommendations\n        \"\"\"\n        score = 0\n        components = {}\n\n        # Age scoring\n        if age >= 75:\n            score += 2\n            components[\"age_75+\"] = 2\n        elif age >= 65:\n            score += 1\n            components[\"age_65-74\"] = 1\n        else:\n            components[\"age_<65\"] = 0\n\n        # Sex (female = 1 point)\n        if sex == Sex.FEMALE:\n            score += 1\n            components[\"female_sex\"] = 1\n        else:\n            components[\"male_sex\"] = 0\n\n        # Risk factors\n        if chf:\n            score += 1\n            components[\"chf\"] = 1\n        if hypertension:\n            score += 1\n            components[\"hypertension\"] = 1\n        if stroke_tia_history:\n            score += 2\n            components[\"stroke_tia\"] = 2\n        if vascular_disease:\n            score += 1\n            components[\"vascular_disease\"] = 1\n        if diabetes:\n            score += 1\n            components[\"diabetes\"] = 1\n\n        # Risk stratification\n        annual_stroke_risk = {\n            0: 0.2,\n            1: 0.6,\n            2: 2.2,\n            3: 3.2,\n            4: 4.8,\n            5: 7.2,\n            6: 9.7,\n            7: 11.2,\n            8: 10.8,\n            9: 12.2,\n        }\n\n        risk = annual_stroke_risk.get(min(score, 9), 12.2)\n\n        if score == 0:\n            risk_level = RiskLevel.LOW\n            interpretation = \"Low risk. Annual stroke risk ~0.2%.\"\n            recommendations = [\n                \"Anticoagulation generally not recommended\",\n                \"Consider aspirin or no antithrombotic therapy\",\n                \"Re-evaluate if risk factors develop\",\n            ]\n        elif score == 1:\n            risk_level = RiskLevel.MODERATE\n            interpretation = f\"Low-moderate risk. Annual stroke risk ~{risk}%.\"\n            if sex == Sex.FEMALE and score == 1:\n                recommendations = [\n                    \"Female sex as only risk factor - consider no therapy\",\n                    \"Discuss anticoagulation vs aspirin with patient\",\n                    \"Consider patient preferences and bleeding risk\",\n                ]\n            else:\n                recommendations = [\n                    \"Consider oral anticoagulation (DOACs preferred over warfarin)\",\n                    \"Balance stroke prevention with bleeding risk (HAS-BLED)\",\n                    \"Shared decision-making with patient\",\n                ]\n        else:\n            if score >= 4:\n                risk_level = RiskLevel.HIGH\n            else:\n                risk_level = RiskLevel.MODERATE\n            interpretation = f\"Elevated risk. Annual stroke risk ~{risk}%. \" \"Anticoagulation recommended.\"\n            recommendations = [\n                \"Oral anticoagulation recommended (DOACs preferred)\",\n                \"Calculate HAS-BLED for bleeding risk assessment\",\n                \"Direct oral anticoagulants (DOACs) preferred over warfarin\",\n                \"Consider left atrial appendage closure if contraindicated\",\n            ]\n\n        return CalculatorResult(\n            calculator_name=\"CHA2DS2-VASc\",\n            score=score,\n            risk_level=risk_level,\n            interpretation=interpretation,\n            recommendations=recommendations,\n            components=components,\n            references=[\n                \"Lip GYH, et al. Chest 2010;137:263-272\",\n                \"2020 ESC Guidelines for AF Management\",\n            ],\n        )\n\n    @staticmethod\n    def heart_score(history: int, ecg: int, age: int, risk_factors: int, troponin: int) -> CalculatorResult:\n        \"\"\"\n        HEART Score for Major Cardiac Events.\n\n        Risk stratifies chest pain patients for 6-week MACE.\n\n        Args:\n            history: 0=slightly suspicious, 1=moderately suspicious, 2=highly suspicious\n            ecg: 0=normal, 1=non-specific changes, 2=significant ST deviation\n            age: 0=<45, 1=45-64, 2=≥65\n            risk_factors: 0=none, 1=1-2 factors, 2=≥3 factors or known CAD\n            troponin: 0=≤normal, 1=1-3x normal, 2=>3x normal\n\n        Returns:\n            CalculatorResult with score 0-10 and disposition recommendations\n        \"\"\"\n        # Validate inputs\n        for val, name in [\n            (history, \"history\"),\n            (ecg, \"ecg\"),\n            (age, \"age\"),\n            (risk_factors, \"risk_factors\"),\n            (troponin, \"troponin\"),\n        ]:\n            if val < 0 or val > 2:\n                raise ValueError(f\"{name} must be 0, 1, or 2\")\n\n        score = history + ecg + age + risk_factors + troponin\n\n        components = {\n            \"history\": history,\n            \"ecg\": ecg,\n            \"age_category\": age,\n            \"risk_factors\": risk_factors,\n            \"troponin\": troponin,\n        }\n\n        # 6-week MACE risk\n        if score <= 3:\n            risk_level = RiskLevel.LOW\n            mace_risk = \"1.6%\"\n            interpretation = f\"Low risk. 6-week MACE risk: {mace_risk}.\"\n            recommendations = [\n                \"Consider early discharge with outpatient follow-up\",\n                \"Stress testing within 72 hours if discharged\",\n                \"Return precautions for worsening symptoms\",\n            ]\n        elif score <= 6:\n            risk_level = RiskLevel.MODERATE\n            mace_risk = \"12-16.6%\"\n            interpretation = f\"Moderate risk. 6-week MACE risk: {mace_risk}.\"\n            recommendations = [\n                \"Admission for observation recommended\",\n                \"Serial troponins and continuous monitoring\",\n                \"Non-invasive testing or cardiology consultation\",\n                \"Consider early invasive strategy if high-risk features\",\n            ]\n        else:\n            risk_level = RiskLevel.HIGH\n            mace_risk = \"50-65%\"\n            interpretation = f\"High risk. 6-week MACE risk: {mace_risk}.\"\n            recommendations = [\n                \"Admission to cardiac care unit\",\n                \"Early invasive strategy recommended\",\n                \"Urgent cardiology consultation\",\n                \"Dual antiplatelet therapy and anticoagulation per ACS protocol\",\n            ]\n\n        return CalculatorResult(\n            calculator_name=\"HEART Score\",\n            score=score,\n            risk_level=risk_level,\n            interpretation=interpretation,\n            recommendations=recommendations,\n            components=components,\n            references=[\n                \"Six AJ, et al. Neth Heart J 2008;16:191-196\",\n                \"Backus BE, et al. Int J Cardiol 2013;168:2153-2158\",\n            ],\n        )\n\n    @staticmethod\n    def wells_dvt(\n        active_cancer: bool = False,\n        bedridden_recent_surgery: bool = False,\n        calf_swelling: bool = False,\n        collateral_veins: bool = False,\n        entire_leg_swollen: bool = False,\n        localized_tenderness: bool = False,\n        pitting_edema: bool = False,\n        paralysis_paresis: bool = False,\n        previous_dvt: bool = False,\n        alternative_diagnosis_likely: bool = False,\n    ) -> CalculatorResult:\n        \"\"\"\n        Wells' Criteria for DVT.\n\n        Estimates pretest probability for deep vein thrombosis.\n\n        Returns:\n            CalculatorResult with score and DVT probability\n        \"\"\"\n        score = 0\n        components = {}\n\n        criteria = [\n            (active_cancer, \"active_cancer\", 1),\n            (bedridden_recent_surgery, \"bedridden_surgery\", 1),\n            (calf_swelling, \"calf_swelling_>3cm\", 1),\n            (collateral_veins, \"collateral_veins\", 1),\n            (entire_leg_swollen, \"entire_leg_swollen\", 1),\n            (localized_tenderness, \"localized_tenderness\", 1),\n            (pitting_edema, \"pitting_edema\", 1),\n            (paralysis_paresis, \"paralysis_paresis\", 1),\n            (previous_dvt, \"previous_dvt\", 1),\n            (alternative_diagnosis_likely, \"alternative_diagnosis\", -2),\n        ]\n\n        for present, name, points in criteria:\n            if present:\n                score += points\n                components[name] = points\n\n        if score <= 0:\n            risk_level = RiskLevel.LOW\n            dvt_probability = \"5%\"\n            interpretation = f\"Low probability. DVT prevalence ~{dvt_probability}.\"\n            recommendations = [\n                \"D-dimer testing recommended\",\n                \"If D-dimer negative: DVT effectively ruled out\",\n                \"If D-dimer positive: Ultrasound indicated\",\n            ]\n        elif score <= 2:\n            risk_level = RiskLevel.MODERATE\n            dvt_probability = \"17%\"\n            interpretation = f\"Moderate probability. DVT prevalence ~{dvt_probability}.\"\n            recommendations = [\n                \"D-dimer testing OR ultrasound\",\n                \"High-sensitivity D-dimer preferred if available\",\n                \"If D-dimer positive: Ultrasound required\",\n            ]\n        else:\n            risk_level = RiskLevel.HIGH\n            dvt_probability = \"53%\"\n            interpretation = f\"High probability. DVT prevalence ~{dvt_probability}.\"\n            recommendations = [\n                \"Ultrasound recommended as initial test\",\n                \"Consider empiric anticoagulation pending results\",\n                \"D-dimer not useful in high probability\",\n            ]\n\n        return CalculatorResult(\n            calculator_name=\"Wells' Criteria for DVT\",\n            score=score,\n            risk_level=risk_level,\n            interpretation=interpretation,\n            recommendations=recommendations,\n            components=components,\n            references=[\"Wells PS, et al. N Engl J Med 2003;349:1227-1235\"],\n        )\n\n    @staticmethod\n    def wells_pe(\n        clinical_dvt_signs: bool = False,\n        pe_most_likely: bool = False,\n        heart_rate_gt_100: bool = False,\n        immobilization_surgery: bool = False,\n        previous_pe_dvt: bool = False,\n        hemoptysis: bool = False,\n        malignancy: bool = False,\n    ) -> CalculatorResult:\n        \"\"\"\n        Wells' Criteria for Pulmonary Embolism.\n\n        Estimates pretest probability for PE.\n\n        Returns:\n            CalculatorResult with score and PE probability\n        \"\"\"\n        score = 0.0\n        components = {}\n\n        criteria = [\n            (clinical_dvt_signs, \"clinical_dvt_signs\", 3.0),\n            (pe_most_likely, \"pe_most_likely_diagnosis\", 3.0),\n            (heart_rate_gt_100, \"heart_rate_>100\", 1.5),\n            (immobilization_surgery, \"immobilization_surgery\", 1.5),\n            (previous_pe_dvt, \"previous_pe_dvt\", 1.5),\n            (hemoptysis, \"hemoptysis\", 1.0),\n            (malignancy, \"malignancy\", 1.0),\n        ]\n\n        for present, name, points in criteria:\n            if present:\n                score += points\n                components[name] = points\n\n        if score <= 4:\n            risk_level = RiskLevel.LOW\n            pe_probability = \"8%\"\n            interpretation = f\"PE unlikely. Prevalence ~{pe_probability}.\"\n            recommendations = [\n                \"D-dimer testing recommended\",\n                \"If D-dimer negative (<500 or age-adjusted): PE ruled out\",\n                \"If D-dimer positive: CT pulmonary angiography\",\n            ]\n        else:\n            risk_level = RiskLevel.HIGH\n            pe_probability = \"34%\"\n            interpretation = f\"PE likely. Prevalence ~{pe_probability}.\"\n            recommendations = [\n                \"CT pulmonary angiography recommended\",\n                \"Consider empiric anticoagulation pending imaging\",\n                \"D-dimer not useful when PE likely\",\n            ]\n\n        return CalculatorResult(\n            calculator_name=\"Wells' Criteria for PE\",\n            score=score,\n            risk_level=risk_level,\n            interpretation=interpretation,\n            recommendations=recommendations,\n            components=components,\n            references=[\"Wells PS, et al. Thromb Haemost 2000;83:416-420\"],\n        )\n\n    # =========================================================================\n    # NEPHROLOGY CALCULATORS\n    # =========================================================================\n\n    @staticmethod\n    def ckd_epi_2021(creatinine: float, age: int, sex: Sex) -> CalculatorResult:\n        \"\"\"\n        CKD-EPI 2021 Creatinine Equation (Race-Free).\n\n        Estimates GFR without race coefficient per 2021 guidelines.\n\n        Args:\n            creatinine: Serum creatinine in mg/dL\n            age: Patient age in years\n            sex: Biological sex\n\n        Returns:\n            CalculatorResult with eGFR in mL/min/1.73m²\n        \"\"\"\n        if creatinine <= 0:\n            raise ValueError(\"Creatinine must be positive\")\n        if age < 18:\n            raise ValueError(\"CKD-EPI is validated for adults (age ≥18)\")\n\n        # 2021 CKD-EPI equation (race-free)\n        if sex == Sex.FEMALE:\n            kappa = 0.7\n            alpha = -0.241\n            multiplier = 1.012\n        else:\n            kappa = 0.9\n            alpha = -0.302\n            multiplier = 1.0\n\n        scr_kappa = creatinine / kappa\n\n        egfr = 142 * (min(scr_kappa, 1) ** alpha) * (max(scr_kappa, 1) ** -1.200) * (0.9938**age) * multiplier\n\n        egfr = round(egfr, 1)\n\n        # CKD staging\n        if egfr >= 90:\n            stage = \"G1\"\n            risk_level = RiskLevel.LOW\n            interpretation = f\"eGFR {egfr}: Normal or high kidney function (G1).\"\n        elif egfr >= 60:\n            stage = \"G2\"\n            risk_level = RiskLevel.LOW\n            interpretation = f\"eGFR {egfr}: Mildly decreased (G2).\"\n        elif egfr >= 45:\n            stage = \"G3a\"\n            risk_level = RiskLevel.MODERATE\n            interpretation = f\"eGFR {egfr}: Mild-moderate decrease (G3a).\"\n        elif egfr >= 30:\n            stage = \"G3b\"\n            risk_level = RiskLevel.MODERATE\n            interpretation = f\"eGFR {egfr}: Moderate-severe decrease (G3b).\"\n        elif egfr >= 15:\n            stage = \"G4\"\n            risk_level = RiskLevel.HIGH\n            interpretation = f\"eGFR {egfr}: Severely decreased (G4).\"\n        else:\n            stage = \"G5\"\n            risk_level = RiskLevel.VERY_HIGH\n            interpretation = f\"eGFR {egfr}: Kidney failure (G5).\"\n\n        recommendations = []\n        if egfr < 60:\n            recommendations.append(\"Monitor for CKD progression every 3-6 months\")\n            recommendations.append(\"Check urine albumin-to-creatinine ratio\")\n            recommendations.append(\"Review medications for renal dosing\")\n        if egfr < 45:\n            recommendations.append(\"Nephrology referral recommended\")\n            recommendations.append(\"Assess for CKD complications (anemia, bone disease)\")\n        if egfr < 30:\n            recommendations.append(\"Prepare for possible renal replacement therapy\")\n            recommendations.append(\"Avoid nephrotoxins\")\n        if egfr < 15:\n            recommendations.append(\"Urgent nephrology evaluation\")\n            recommendations.append(\"Discuss dialysis or transplant options\")\n\n        return CalculatorResult(\n            calculator_name=\"CKD-EPI 2021 (Race-Free)\",\n            score=egfr,\n            unit=\"mL/min/1.73m²\",\n            risk_level=risk_level,\n            interpretation=interpretation,\n            recommendations=recommendations,\n            components={\n                \"creatinine_mg_dL\": creatinine,\n                \"age\": age,\n                \"sex\": sex.value,\n                \"ckd_stage\": stage,\n            },\n            references=[\n                \"Inker LA, et al. N Engl J Med 2021;385:1737-1749\",\n                \"KDIGO 2024 Clinical Practice Guideline for CKD\",\n            ],\n        )\n\n    @staticmethod\n    def cockcroft_gault(creatinine: float, age: int, weight: float, sex: Sex) -> CalculatorResult:\n        \"\"\"\n        Cockcroft-Gault Creatinine Clearance.\n\n        Estimates creatinine clearance for drug dosing.\n        Note: Not adjusted for BSA - actual CrCl.\n\n        Args:\n            creatinine: Serum creatinine in mg/dL\n            age: Patient age in years\n            weight: Weight in kg\n            sex: Biological sex\n\n        Returns:\n            CalculatorResult with CrCl in mL/min\n        \"\"\"\n        if creatinine <= 0:\n            raise ValueError(\"Creatinine must be positive\")\n        if weight <= 0:\n            raise ValueError(\"Weight must be positive\")\n\n        crcl = ((140 - age) * weight) / (72 * creatinine)\n\n        if sex == Sex.FEMALE:\n            crcl *= 0.85\n\n        crcl = round(crcl, 1)\n\n        # Interpretation for drug dosing\n        if crcl >= 90:\n            risk_level = RiskLevel.LOW\n            interpretation = f\"CrCl {crcl}: Normal renal function for drug dosing.\"\n        elif crcl >= 60:\n            risk_level = RiskLevel.LOW\n            interpretation = f\"CrCl {crcl}: Mild renal impairment.\"\n        elif crcl >= 30:\n            risk_level = RiskLevel.MODERATE\n            interpretation = f\"CrCl {crcl}: Moderate renal impairment.\"\n        elif crcl >= 15:\n            risk_level = RiskLevel.HIGH\n            interpretation = f\"CrCl {crcl}: Severe renal impairment.\"\n        else:\n            risk_level = RiskLevel.VERY_HIGH\n            interpretation = f\"CrCl {crcl}: End-stage renal disease.\"\n\n        recommendations = [\n            \"Use for drug dosing adjustments (many drugs use CrCl)\",\n            \"Consider ideal body weight if obese\",\n            \"Not validated in AKI - use clinical judgment\",\n        ]\n\n        if crcl < 60:\n            recommendations.append(\"Review all medications for renal dose adjustment\")\n\n        return CalculatorResult(\n            calculator_name=\"Cockcroft-Gault CrCl\",\n            score=crcl,\n            unit=\"mL/min\",\n            risk_level=risk_level,\n            interpretation=interpretation,\n            recommendations=recommendations,\n            components={\n                \"creatinine_mg_dL\": creatinine,\n                \"age\": age,\n                \"weight_kg\": weight,\n                \"sex\": sex.value,\n            },\n            references=[\"Cockcroft DW, Gault MH. Nephron 1976;16:31-41\"],\n            warnings=[\n                \"Not adjusted for BSA\",\n                \"May overestimate in obesity - consider ideal body weight\",\n                \"Not accurate in rapidly changing renal function\",\n            ],\n        )\n\n    # =========================================================================\n    # HEPATOLOGY CALCULATORS\n    # =========================================================================\n\n    @staticmethod\n    def meld_na(\n        bilirubin: float,\n        inr: float,\n        creatinine: float,\n        sodium: float,\n        dialysis_twice_past_week: bool = False,\n    ) -> CalculatorResult:\n        \"\"\"\n        MELD-Na Score (Model for End-Stage Liver Disease with Sodium).\n\n        Predicts 90-day mortality in liver disease for transplant prioritization.\n\n        Args:\n            bilirubin: Total bilirubin in mg/dL\n            inr: International Normalized Ratio\n            creatinine: Serum creatinine in mg/dL (max 4.0)\n            sodium: Serum sodium in mEq/L (range 125-137)\n            dialysis_twice_past_week: If dialyzed ≥2 times in past week\n\n        Returns:\n            CalculatorResult with MELD-Na score 6-40\n        \"\"\"\n        # Apply MELD limits\n        bilirubin = max(bilirubin, 1.0)\n        inr = max(inr, 1.0)\n        creatinine = max(creatinine, 1.0)\n        creatinine = min(creatinine, 4.0)\n\n        if dialysis_twice_past_week:\n            creatinine = 4.0\n\n        # Sodium limits\n        sodium = max(sodium, 125)\n        sodium = min(sodium, 137)\n\n        # MELD(i) calculation\n        meld_i = (0.957 * math.log(creatinine) + 0.378 * math.log(bilirubin) + 1.120 * math.log(inr) + 0.643) * 10\n\n        # MELD-Na adjustment\n        if meld_i > 11:\n            meld_na = meld_i + 1.32 * (137 - sodium) - (0.033 * meld_i * (137 - sodium))\n        else:\n            meld_na = meld_i\n\n        meld_na = round(meld_na)\n        meld_na = max(6, min(40, meld_na))\n\n        # 90-day mortality\n        if meld_na <= 9:\n            mortality = \"1.9%\"\n            risk_level = RiskLevel.LOW\n        elif meld_na <= 19:\n            mortality = \"6%\"\n            risk_level = RiskLevel.MODERATE\n        elif meld_na <= 29:\n            mortality = \"19.6%\"\n            risk_level = RiskLevel.HIGH\n        elif meld_na <= 39:\n            mortality = \"52.6%\"\n            risk_level = RiskLevel.VERY_HIGH\n        else:\n            mortality = \"71.3%\"\n            risk_level = RiskLevel.VERY_HIGH\n\n        interpretation = f\"MELD-Na {meld_na}: 90-day mortality ~{mortality}.\"\n\n        recommendations = []\n        if meld_na >= 15:\n            recommendations.append(\"Consider transplant evaluation if not already listed\")\n        if meld_na >= 20:\n            recommendations.append(\"High priority for transplant\")\n            recommendations.append(\"Frequent monitoring of liver function\")\n        if meld_na >= 30:\n            recommendations.append(\"Critical - urgent transplant evaluation\")\n            recommendations.append(\"ICU level care may be appropriate\")\n\n        return CalculatorResult(\n            calculator_name=\"MELD-Na Score\",\n            score=meld_na,\n            risk_level=risk_level,\n            interpretation=interpretation,\n            recommendations=recommendations,\n            components={\n                \"bilirubin_mg_dL\": bilirubin,\n                \"inr\": inr,\n                \"creatinine_mg_dL\": creatinine,\n                \"sodium_mEq_L\": sodium,\n                \"dialysis\": dialysis_twice_past_week,\n                \"mortality_90day\": mortality,\n            },\n            references=[\n                \"Kim WR, et al. Hepatology 2008;47:584-590\",\n                \"OPTN/UNOS Policy for Liver Allocation\",\n            ],\n        )\n\n    @staticmethod\n    def child_pugh(bilirubin: float, albumin: float, inr: float, ascites: str, encephalopathy: str) -> CalculatorResult:\n        \"\"\"\n        Child-Pugh Score for Cirrhosis Severity.\n\n        Args:\n            bilirubin: Total bilirubin in mg/dL\n            albumin: Serum albumin in g/dL\n            inr: International Normalized Ratio\n            ascites: \"none\", \"mild\", or \"moderate_severe\"\n            encephalopathy: \"none\", \"grade_1_2\", or \"grade_3_4\"\n\n        Returns:\n            CalculatorResult with Child-Pugh class A/B/C\n        \"\"\"\n        score = 0\n        components = {}\n\n        # Bilirubin\n        if bilirubin < 2:\n            score += 1\n            components[\"bilirubin\"] = 1\n        elif bilirubin <= 3:\n            score += 2\n            components[\"bilirubin\"] = 2\n        else:\n            score += 3\n            components[\"bilirubin\"] = 3\n\n        # Albumin\n        if albumin > 3.5:\n            score += 1\n            components[\"albumin\"] = 1\n        elif albumin >= 2.8:\n            score += 2\n            components[\"albumin\"] = 2\n        else:\n            score += 3\n            components[\"albumin\"] = 3\n\n        # INR\n        if inr < 1.7:\n            score += 1\n            components[\"inr\"] = 1\n        elif inr <= 2.2:\n            score += 2\n            components[\"inr\"] = 2\n        else:\n            score += 3\n            components[\"inr\"] = 3\n\n        # Ascites\n        ascites_lower = ascites.lower()\n        if ascites_lower == \"none\":\n            score += 1\n            components[\"ascites\"] = 1\n        elif ascites_lower == \"mild\":\n            score += 2\n            components[\"ascites\"] = 2\n        else:\n            score += 3\n            components[\"ascites\"] = 3\n\n        # Encephalopathy\n        ence_lower = encephalopathy.lower()\n        if ence_lower == \"none\":\n            score += 1\n            components[\"encephalopathy\"] = 1\n        elif ence_lower == \"grade_1_2\":\n            score += 2\n            components[\"encephalopathy\"] = 2\n        else:\n            score += 3\n            components[\"encephalopathy\"] = 3\n\n        # Classification\n        if score <= 6:\n            child_class = \"A\"\n            risk_level = RiskLevel.LOW\n            mortality_1yr = \"10%\"\n            mortality_2yr = \"15%\"\n            interpretation = f\"Child-Pugh Class A (score {score}): Well-compensated.\"\n        elif score <= 9:\n            child_class = \"B\"\n            risk_level = RiskLevel.MODERATE\n            mortality_1yr = \"30%\"\n            mortality_2yr = \"40%\"\n            interpretation = f\"Child-Pugh Class B (score {score}): Significant functional compromise.\"\n        else:\n            child_class = \"C\"\n            risk_level = RiskLevel.HIGH\n            mortality_1yr = \"50%\"\n            mortality_2yr = \"65%\"\n            interpretation = f\"Child-Pugh Class C (score {score}): Decompensated cirrhosis.\"\n\n        components[\"class\"] = child_class\n        components[\"mortality_1yr\"] = mortality_1yr\n        components[\"mortality_2yr\"] = mortality_2yr\n\n        recommendations = []\n        if child_class == \"A\":\n            recommendations.append(\"Monitor for disease progression\")\n            recommendations.append(\"Screen for varices if not done\")\n        elif child_class == \"B\":\n            recommendations.append(\"Consider transplant evaluation\")\n            recommendations.append(\"Varices prophylaxis if indicated\")\n            recommendations.append(\"Avoid hepatotoxic medications\")\n        else:\n            recommendations.append(\"Urgent transplant evaluation\")\n            recommendations.append(\"Intensive monitoring for complications\")\n            recommendations.append(\"Consider palliative care discussion if not transplant candidate\")\n\n        return CalculatorResult(\n            calculator_name=\"Child-Pugh Score\",\n            score=score,\n            risk_level=risk_level,\n            interpretation=interpretation,\n            recommendations=recommendations,\n            components=components,\n            references=[\n                \"Child CG, Turcotte JG. Surgery 1964;55:24\",\n                \"Pugh RN, et al. Br J Surg 1973;60:646-649\",\n            ],\n        )\n\n    @staticmethod\n    def fib4(age: int, ast: float, alt: float, platelets: float) -> CalculatorResult:\n        \"\"\"\n        FIB-4 Index for Liver Fibrosis.\n\n        Non-invasive estimate of liver fibrosis/cirrhosis.\n\n        Args:\n            age: Patient age in years\n            ast: AST in U/L\n            alt: ALT in U/L\n            platelets: Platelet count in 10^9/L\n\n        Returns:\n            CalculatorResult with FIB-4 score and fibrosis probability\n        \"\"\"\n        if alt <= 0 or platelets <= 0:\n            raise ValueError(\"ALT and platelets must be positive\")\n\n        fib4 = (age * ast) / (platelets * math.sqrt(alt))\n        fib4 = round(fib4, 2)\n\n        if fib4 < 1.30:\n            risk_level = RiskLevel.LOW\n            interpretation = f\"FIB-4 {fib4}: Low probability of advanced fibrosis.\"\n            recommendations = [\n                \"Low likelihood of significant fibrosis (NPV ~90%)\",\n                \"Repeat FIB-4 in 1-2 years or if clinical change\",\n                \"Continue hepatitis management as indicated\",\n            ]\n        elif fib4 <= 2.67:\n            risk_level = RiskLevel.MODERATE\n            interpretation = f\"FIB-4 {fib4}: Indeterminate - further evaluation needed.\"\n            recommendations = [\n                \"Consider transient elastography (FibroScan)\",\n                \"Or other non-invasive fibrosis assessment\",\n                \"Liver biopsy may be needed if results discordant\",\n            ]\n        else:\n            risk_level = RiskLevel.HIGH\n            interpretation = f\"FIB-4 {fib4}: High probability of advanced fibrosis/cirrhosis.\"\n            recommendations = [\n                \"High likelihood of F3-F4 fibrosis (PPV ~65%)\",\n                \"Hepatology referral recommended\",\n                \"Screen for varices and HCC surveillance\",\n                \"Consider liver biopsy for staging\",\n            ]\n\n        return CalculatorResult(\n            calculator_name=\"FIB-4 Index\",\n            score=fib4,\n            risk_level=risk_level,\n            interpretation=interpretation,\n            recommendations=recommendations,\n            components={\n                \"age\": age,\n                \"ast_U_L\": ast,\n                \"alt_U_L\": alt,\n                \"platelets_10e9_L\": platelets,\n            },\n            references=[\"Sterling RK, et al. Hepatology 2006;43:1317-1325\"],\n            warnings=[\n                \"May be less accurate in patients <35 or >65 years\",\n                \"Not validated in acute hepatitis\",\n            ],\n        )\n\n    # =========================================================================\n    # CRITICAL CARE CALCULATORS\n    # =========================================================================\n\n    @staticmethod\n    def sofa(\n        pao2_fio2: float,\n        platelets: float,\n        bilirubin: float,\n        cardiovascular: int,\n        gcs: int,\n        creatinine: float,\n        urine_output_24h: Optional[float] = None,\n    ) -> CalculatorResult:\n        \"\"\"\n        Sequential Organ Failure Assessment (SOFA) Score.\n\n        Assesses organ dysfunction in ICU patients.\n\n        Args:\n            pao2_fio2: PaO2/FiO2 ratio in mmHg\n            platelets: Platelet count in 10^3/μL\n            bilirubin: Total bilirubin in mg/dL\n            cardiovascular: 0=MAP≥70, 1=MAP<70, 2=dopamine≤5 or dobutamine,\n                          3=dopamine>5 or epi/norepi≤0.1, 4=dopamine>15 or epi/norepi>0.1\n            gcs: Glasgow Coma Scale (3-15)\n            creatinine: Serum creatinine in mg/dL\n            urine_output_24h: 24-hour urine output in mL (optional)\n\n        Returns:\n            CalculatorResult with SOFA score 0-24\n        \"\"\"\n        score = 0\n        components = {}\n\n        # Respiration (PaO2/FiO2)\n        if pao2_fio2 >= 400:\n            resp_score = 0\n        elif pao2_fio2 >= 300:\n            resp_score = 1\n        elif pao2_fio2 >= 200:\n            resp_score = 2\n        elif pao2_fio2 >= 100:\n            resp_score = 3\n        else:\n            resp_score = 4\n        score += resp_score\n        components[\"respiration\"] = resp_score\n\n        # Coagulation (Platelets)\n        if platelets >= 150:\n            coag_score = 0\n        elif platelets >= 100:\n            coag_score = 1\n        elif platelets >= 50:\n            coag_score = 2\n        elif platelets >= 20:\n            coag_score = 3\n        else:\n            coag_score = 4\n        score += coag_score\n        components[\"coagulation\"] = coag_score\n\n        # Liver (Bilirubin)\n        if bilirubin < 1.2:\n            liver_score = 0\n        elif bilirubin < 2.0:\n            liver_score = 1\n        elif bilirubin < 6.0:\n            liver_score = 2\n        elif bilirubin < 12.0:\n            liver_score = 3\n        else:\n            liver_score = 4\n        score += liver_score\n        components[\"liver\"] = liver_score\n\n        # Cardiovascular\n        if cardiovascular < 0 or cardiovascular > 4:\n            raise ValueError(\"Cardiovascular must be 0-4\")\n        score += cardiovascular\n        components[\"cardiovascular\"] = cardiovascular\n\n        # CNS (GCS)\n        if gcs == 15:\n            cns_score = 0\n        elif gcs >= 13:\n            cns_score = 1\n        elif gcs >= 10:\n            cns_score = 2\n        elif gcs >= 6:\n            cns_score = 3\n        else:\n            cns_score = 4\n        score += cns_score\n        components[\"cns\"] = cns_score\n\n        # Renal (Creatinine or urine output)\n        if creatinine < 1.2:\n            renal_score = 0\n        elif creatinine < 2.0:\n            renal_score = 1\n        elif creatinine < 3.5:\n            renal_score = 2\n        elif creatinine < 5.0:\n            renal_score = 3\n        else:\n            renal_score = 4\n\n        # Urine output can increase score if worse\n        if urine_output_24h is not None:\n            if urine_output_24h < 200:\n                renal_score = max(renal_score, 4)\n            elif urine_output_24h < 500:\n                renal_score = max(renal_score, 3)\n\n        score += renal_score\n        components[\"renal\"] = renal_score\n\n        # Mortality estimates\n        if score <= 1:\n            mortality = \"<5%\"\n            risk_level = RiskLevel.LOW\n        elif score <= 4:\n            mortality = \"~6%\"\n            risk_level = RiskLevel.LOW\n        elif score <= 7:\n            mortality = \"~20%\"\n            risk_level = RiskLevel.MODERATE\n        elif score <= 10:\n            mortality = \"~30%\"\n            risk_level = RiskLevel.MODERATE\n        elif score <= 14:\n            mortality = \"~50%\"\n            risk_level = RiskLevel.HIGH\n        else:\n            mortality = \">80%\"\n            risk_level = RiskLevel.VERY_HIGH\n\n        interpretation = f\"SOFA Score {score}: Estimated ICU mortality {mortality}.\"\n\n        recommendations = []\n        if score >= 2:\n            recommendations.append(\"Consider sepsis if score increased by ≥2 from baseline\")\n        if score >= 6:\n            recommendations.append(\"High organ dysfunction - intensive monitoring\")\n            recommendations.append(\"Consider goals of care discussion\")\n        if score >= 11:\n            recommendations.append(\"Critical organ dysfunction - prognosis grave\")\n            recommendations.append(\"Family meeting recommended\")\n\n        return CalculatorResult(\n            calculator_name=\"SOFA Score\",\n            score=score,\n            risk_level=risk_level,\n            interpretation=interpretation,\n            recommendations=recommendations,\n            components=components,\n            references=[\n                \"Vincent JL, et al. Intensive Care Med 1996;22:707-710\",\n                \"Sepsis-3: Singer M, et al. JAMA 2016;315:801-810\",\n            ],\n        )\n\n    @staticmethod\n    def qsofa(\n        respiratory_rate_gte_22: bool,\n        altered_mentation: bool,\n        systolic_bp_lte_100: bool,\n    ) -> CalculatorResult:\n        \"\"\"\n        Quick SOFA (qSOFA) Score for Sepsis Screening.\n\n        Bedside screening tool for sepsis in non-ICU settings.\n\n        Args:\n            respiratory_rate_gte_22: Respiratory rate ≥22/min\n            altered_mentation: Altered mental status (GCS <15)\n            systolic_bp_lte_100: Systolic BP ≤100 mmHg\n\n        Returns:\n            CalculatorResult with qSOFA score 0-3\n        \"\"\"\n        score = sum([respiratory_rate_gte_22, altered_mentation, systolic_bp_lte_100])\n\n        components = {\n            \"respiratory_rate_gte_22\": int(respiratory_rate_gte_22),\n            \"altered_mentation\": int(altered_mentation),\n            \"systolic_bp_lte_100\": int(systolic_bp_lte_100),\n        }\n\n        if score < 2:\n            risk_level = RiskLevel.LOW\n            interpretation = f\"qSOFA {score}: Low risk for poor outcome.\"\n            recommendations = [\n                \"qSOFA <2 does not rule out sepsis\",\n                \"Continue clinical monitoring\",\n                \"Consider full sepsis workup if infection suspected\",\n            ]\n        else:\n            risk_level = RiskLevel.HIGH\n            interpretation = f\"qSOFA {score}: High risk for poor outcome in sepsis. \" \"Further evaluation required.\"\n            recommendations = [\n                \"High risk of in-hospital mortality\",\n                \"Assess for organ dysfunction (full SOFA score)\",\n                \"Consider ICU admission\",\n                \"Start sepsis bundle if sepsis confirmed\",\n            ]\n\n        return CalculatorResult(\n            calculator_name=\"qSOFA Score\",\n            score=score,\n            risk_level=risk_level,\n            interpretation=interpretation,\n            recommendations=recommendations,\n            components=components,\n            references=[\"Sepsis-3: Seymour CW, et al. JAMA 2016;315:762-774\"],\n            warnings=[\n                \"qSOFA is for prognosis, not diagnosis\",\n                \"Low sensitivity - does not rule out sepsis\",\n                \"Use clinical judgment alongside scoring\",\n            ],\n        )\n\n    @staticmethod\n    def curb65(\n        confusion: bool,\n        bun_gt_19: bool,\n        respiratory_rate_gte_30: bool,\n        systolic_bp_lt_90_or_diastolic_lte_60: bool,\n        age_gte_65: bool,\n    ) -> CalculatorResult:\n        \"\"\"\n        CURB-65 Score for Pneumonia Severity.\n\n        Predicts mortality and guides disposition in community-acquired pneumonia.\n\n        Args:\n            confusion: New-onset confusion\n            bun_gt_19: BUN >19 mg/dL (or urea >7 mmol/L)\n            respiratory_rate_gte_30: Respiratory rate ≥30/min\n            systolic_bp_lt_90_or_diastolic_lte_60: SBP <90 or DBP ≤60 mmHg\n            age_gte_65: Age ≥65 years\n\n        Returns:\n            CalculatorResult with CURB-65 score 0-5 and disposition recommendation\n        \"\"\"\n        score = sum(\n            [\n                confusion,\n                bun_gt_19,\n                respiratory_rate_gte_30,\n                systolic_bp_lt_90_or_diastolic_lte_60,\n                age_gte_65,\n            ]\n        )\n\n        components = {\n            \"confusion\": int(confusion),\n            \"bun_elevated\": int(bun_gt_19),\n            \"respiratory_rate_elevated\": int(respiratory_rate_gte_30),\n            \"hypotension\": int(systolic_bp_lt_90_or_diastolic_lte_60),\n            \"age_65_plus\": int(age_gte_65),\n        }\n\n        mortality_map = {\n            0: \"0.6%\",\n            1: \"2.7%\",\n            2: \"6.8%\",\n            3: \"14%\",\n            4: \"27.8%\",\n            5: \"27.8%\",\n        }\n        mortality = mortality_map.get(score, \">25%\")\n\n        if score <= 1:\n            risk_level = RiskLevel.LOW\n            disposition = \"outpatient\"\n            interpretation = f\"CURB-65 {score}: Low risk. 30-day mortality ~{mortality}.\"\n            recommendations = [\n                \"Outpatient treatment generally appropriate\",\n                \"Consider clinical judgment and social factors\",\n                \"Follow-up within 48-72 hours\",\n            ]\n        elif score == 2:\n            risk_level = RiskLevel.MODERATE\n            disposition = \"short inpatient or supervised outpatient\"\n            interpretation = f\"CURB-65 {score}: Intermediate risk. 30-day mortality ~{mortality}.\"\n            recommendations = [\n                \"Consider short hospital admission\",\n                \"Or closely supervised outpatient care\",\n                \"Clinical judgment important\",\n            ]\n        else:\n            risk_level = RiskLevel.HIGH\n            disposition = \"inpatient, consider ICU if score 4-5\"\n            interpretation = f\"CURB-65 {score}: High risk. 30-day mortality ~{mortality}.\"\n            recommendations = [\n                \"Hospital admission required\",\n                \"Consider ICU admission if score ≥4\",\n                \"Early aggressive treatment\",\n            ]\n            if score >= 4:\n                recommendations.append(\"ICU evaluation recommended\")\n\n        components[\"disposition\"] = disposition\n        components[\"mortality_30day\"] = mortality\n\n        return CalculatorResult(\n            calculator_name=\"CURB-65 Score\",\n            score=score,\n            risk_level=risk_level,\n            interpretation=interpretation,\n            recommendations=recommendations,\n            components=components,\n            references=[\n                \"Lim WS, et al. Thorax 2003;58:377-382\",\n                \"BTS Guidelines for CAP 2009\",\n            ],\n        )\n\n    @staticmethod\n    def news2(\n        respiratory_rate: int,\n        spo2: int,\n        on_supplemental_o2: bool,\n        temperature: float,\n        systolic_bp: int,\n        heart_rate: int,\n        consciousness: str,\n        is_hypercapnic: bool = False,\n    ) -> CalculatorResult:\n        \"\"\"\n        National Early Warning Score 2 (NEWS2).\n\n        Standardized assessment of acute illness severity.\n\n        Args:\n            respiratory_rate: Breaths per minute\n            spo2: Oxygen saturation %\n            on_supplemental_o2: Whether on supplemental oxygen\n            temperature: Temperature in °C\n            systolic_bp: Systolic blood pressure mmHg\n            heart_rate: Heart rate bpm\n            consciousness: \"alert\", \"voice\", \"pain\", or \"unresponsive\" (AVPU)\n            is_hypercapnic: True for Scale 2 SpO2 scoring (target 88-92%)\n\n        Returns:\n            CalculatorResult with NEWS2 score 0-20 and clinical response\n        \"\"\"\n        score = 0\n        components = {}\n\n        # Respiratory rate\n        if respiratory_rate <= 8:\n            rr_score = 3\n        elif respiratory_rate <= 11:\n            rr_score = 1\n        elif respiratory_rate <= 20:\n            rr_score = 0\n        elif respiratory_rate <= 24:\n            rr_score = 2\n        else:\n            rr_score = 3\n        score += rr_score\n        components[\"respiratory_rate\"] = rr_score\n\n        # SpO2 scoring (Scale 1 or Scale 2)\n        if is_hypercapnic:\n            # Scale 2: Target SpO2 88-92% for hypercapnic respiratory failure\n            if spo2 <= 83:\n                spo2_score = 3\n            elif spo2 <= 85:\n                spo2_score = 2\n            elif spo2 <= 87:\n                spo2_score = 1\n            elif spo2 <= 92:\n                spo2_score = 0\n            elif spo2 <= 94:\n                spo2_score = 1\n            elif spo2 <= 96:\n                spo2_score = 2\n            else:\n                spo2_score = 3\n        else:\n            # Scale 1: Normal target SpO2 ≥96%\n            if spo2 <= 91:\n                spo2_score = 3\n            elif spo2 <= 93:\n                spo2_score = 2\n            elif spo2 <= 95:\n                spo2_score = 1\n            else:\n                spo2_score = 0\n        score += spo2_score\n        components[\"spo2\"] = spo2_score\n\n        # Supplemental oxygen\n        o2_score = 2 if on_supplemental_o2 else 0\n        score += o2_score\n        components[\"supplemental_o2\"] = o2_score\n\n        # Temperature\n        if temperature <= 35.0:\n            temp_score = 3\n        elif temperature <= 36.0:\n            temp_score = 1\n        elif temperature <= 38.0:\n            temp_score = 0\n        elif temperature <= 39.0:\n            temp_score = 1\n        else:\n            temp_score = 2\n        score += temp_score\n        components[\"temperature\"] = temp_score\n\n        # Systolic BP\n        if systolic_bp <= 90:\n            sbp_score = 3\n        elif systolic_bp <= 100:\n            sbp_score = 2\n        elif systolic_bp <= 110:\n            sbp_score = 1\n        elif systolic_bp <= 219:\n            sbp_score = 0\n        else:\n            sbp_score = 3\n        score += sbp_score\n        components[\"systolic_bp\"] = sbp_score\n\n        # Heart rate\n        if heart_rate <= 40:\n            hr_score = 3\n        elif heart_rate <= 50:\n            hr_score = 1\n        elif heart_rate <= 90:\n            hr_score = 0\n        elif heart_rate <= 110:\n            hr_score = 1\n        elif heart_rate <= 130:\n            hr_score = 2\n        else:\n            hr_score = 3\n        score += hr_score\n        components[\"heart_rate\"] = hr_score\n\n        # Consciousness (AVPU)\n        consciousness_lower = consciousness.lower()\n        if consciousness_lower == \"alert\":\n            cons_score = 0\n        else:\n            cons_score = 3\n        score += cons_score\n        components[\"consciousness\"] = cons_score\n\n        # Clinical response\n        if score <= 4:\n            if any(v == 3 for v in components.values()):\n                risk_level = RiskLevel.MODERATE\n                interpretation = f\"NEWS2 {score}: Single parameter 3 - \" \"Urgent ward-based response needed.\"\n                recommendations = [\n                    \"Urgent assessment by ward-based clinical team\",\n                    \"Increase monitoring frequency\",\n                    \"Consider escalation if no improvement\",\n                ]\n            else:\n                risk_level = RiskLevel.LOW\n                interpretation = f\"NEWS2 {score}: Low clinical risk. \" \"Continue routine monitoring.\"\n                recommendations = [\n                    \"Continue routine NEWS monitoring (minimum every 12 hours)\",\n                    \"Reassess if clinical concern\",\n                ]\n        elif score <= 6:\n            risk_level = RiskLevel.MODERATE\n            interpretation = f\"NEWS2 {score}: Medium clinical risk. Key threshold for escalation.\"\n            recommendations = [\n                \"Urgent ward-based response\",\n                \"Increase monitoring to at least 4-hourly\",\n                \"Consider escalation to critical care outreach\",\n            ]\n        else:\n            risk_level = RiskLevel.HIGH\n            interpretation = f\"NEWS2 {score}: High clinical risk. \" \"Emergency response required.\"\n            recommendations = [\n                \"Emergency assessment by critical care team\",\n                \"Continuous monitoring\",\n                \"Consider transfer to higher level of care\",\n                \"Consider ceiling of care discussion\",\n            ]\n\n        return CalculatorResult(\n            calculator_name=\"NEWS2\",\n            score=score,\n            risk_level=risk_level,\n            interpretation=interpretation,\n            recommendations=recommendations,\n            components=components,\n            references=[\n                \"Royal College of Physicians. NEWS2. 2017\",\n                \"NHS England NEWS2 Implementation Guidance\",\n            ],\n        )\n\n    # =========================================================================\n    # GENERAL/METABOLIC CALCULATORS\n    # =========================================================================\n\n    @staticmethod\n    def bmi(weight: float, height: float) -> CalculatorResult:\n        \"\"\"\n        Body Mass Index (BMI).\n\n        Args:\n            weight: Weight in kg\n            height: Height in cm\n\n        Returns:\n            CalculatorResult with BMI and classification\n        \"\"\"\n        if weight <= 0 or height <= 0:\n            raise ValueError(\"Weight and height must be positive\")\n\n        height_m = height / 100\n        bmi_value = weight / (height_m**2)\n        bmi_value = round(bmi_value, 1)\n\n        if bmi_value < 16:\n            category = \"Severe thinness\"\n            risk_level = RiskLevel.HIGH\n        elif bmi_value < 17:\n            category = \"Moderate thinness\"\n            risk_level = RiskLevel.MODERATE\n        elif bmi_value < 18.5:\n            category = \"Mild thinness\"\n            risk_level = RiskLevel.LOW\n        elif bmi_value < 25:\n            category = \"Normal weight\"\n            risk_level = RiskLevel.VERY_LOW\n        elif bmi_value < 30:\n            category = \"Overweight\"\n            risk_level = RiskLevel.LOW\n        elif bmi_value < 35:\n            category = \"Obese Class I\"\n            risk_level = RiskLevel.MODERATE\n        elif bmi_value < 40:\n            category = \"Obese Class II\"\n            risk_level = RiskLevel.HIGH\n        else:\n            category = \"Obese Class III\"\n            risk_level = RiskLevel.VERY_HIGH\n\n        interpretation = f\"BMI {bmi_value} kg/m²: {category}.\"\n\n        recommendations = []\n        if bmi_value < 18.5:\n            recommendations.append(\"Evaluate for underlying conditions\")\n            recommendations.append(\"Consider nutritional assessment\")\n        elif bmi_value >= 25 and bmi_value < 30:\n            recommendations.append(\"Lifestyle modification recommended\")\n            recommendations.append(\"Diet and exercise counseling\")\n        elif bmi_value >= 30:\n            recommendations.append(\"Weight management program\")\n            recommendations.append(\"Screen for obesity-related conditions\")\n            if bmi_value >= 35:\n                recommendations.append(\"Consider bariatric surgery evaluation\")\n\n        return CalculatorResult(\n            calculator_name=\"BMI\",\n            score=bmi_value,\n            unit=\"kg/m²\",\n            risk_level=risk_level,\n            interpretation=interpretation,\n            recommendations=recommendations,\n            components={\"weight_kg\": weight, \"height_cm\": height, \"category\": category},\n            references=[\"WHO BMI Classification\"],\n            warnings=[\n                \"BMI may not accurately reflect body composition\",\n                \"Consider waist circumference for additional assessment\",\n                \"Different thresholds may apply for certain populations\",\n            ],\n        )\n\n    @staticmethod\n    def bsa_dubois(weight: float, height: float) -> CalculatorResult:\n        \"\"\"\n        Body Surface Area (Du Bois formula).\n\n        Used for drug dosing and physiological calculations.\n\n        Args:\n            weight: Weight in kg\n            height: Height in cm\n\n        Returns:\n            CalculatorResult with BSA in m²\n        \"\"\"\n        if weight <= 0 or height <= 0:\n            raise ValueError(\"Weight and height must be positive\")\n\n        bsa = 0.007184 * (weight**0.425) * (height**0.725)\n        bsa = round(bsa, 2)\n\n        interpretation = f\"BSA {bsa} m² (Du Bois formula).\"\n\n        return CalculatorResult(\n            calculator_name=\"BSA (Du Bois)\",\n            score=bsa,\n            unit=\"m²\",\n            interpretation=interpretation,\n            recommendations=[\n                \"Use for chemotherapy dosing\",\n                \"Use for cardiac index calculation (CI = CO/BSA)\",\n                \"Average adult BSA is ~1.7 m²\",\n            ],\n            components={\"weight_kg\": weight, \"height_cm\": height},\n            references=[\"Du Bois D, Du Bois EF. Arch Intern Med 1916;17:863-871\"],\n        )\n\n    @staticmethod\n    def anion_gap(\n        sodium: float,\n        chloride: float,\n        bicarbonate: float,\n        albumin: Optional[float] = None,\n    ) -> CalculatorResult:\n        \"\"\"\n        Serum Anion Gap (with optional albumin correction).\n\n        Args:\n            sodium: Serum sodium in mEq/L\n            chloride: Serum chloride in mEq/L\n            bicarbonate: Serum bicarbonate in mEq/L\n            albumin: Serum albumin in g/dL (for correction)\n\n        Returns:\n            CalculatorResult with anion gap and interpretation\n        \"\"\"\n        ag = sodium - (chloride + bicarbonate)\n        ag = round(ag, 1)\n\n        components = {\n            \"sodium\": sodium,\n            \"chloride\": chloride,\n            \"bicarbonate\": bicarbonate,\n            \"anion_gap_uncorrected\": ag,\n        }\n\n        # Albumin correction (AG increases ~2.5 for each 1 g/dL decrease in albumin)\n        corrected_ag = None\n        if albumin is not None:\n            correction = 2.5 * (4.0 - albumin)\n            corrected_ag = ag + correction\n            corrected_ag = round(corrected_ag, 1)\n            components[\"albumin\"] = albumin\n            components[\"anion_gap_corrected\"] = corrected_ag\n\n        # Use corrected AG if available\n        final_ag = corrected_ag if corrected_ag is not None else ag\n\n        if final_ag <= 12:\n            risk_level = RiskLevel.LOW\n            interpretation = f\"Anion Gap {ag}: Normal range (3-12 mEq/L).\"\n            if corrected_ag:\n                interpretation += f\" Albumin-corrected AG: {corrected_ag}.\"\n            recommendations = [\n                \"Normal anion gap\",\n                \"If acidosis present, consider non-gap acidosis (hyperchloremic)\",\n            ]\n        else:\n            risk_level = RiskLevel.HIGH\n            interpretation = f\"Anion Gap {ag}: Elevated (>12 mEq/L).\"\n            if corrected_ag:\n                interpretation += f\" Albumin-corrected AG: {corrected_ag}.\"\n            recommendations = [\n                \"Elevated anion gap suggests HAGMA\",\n                \"Consider MUDPILES: Methanol, Uremia, DKA, Propylene glycol, \"\n                \"Isoniazid/Iron, Lactic acidosis, Ethylene glycol, Salicylates\",\n                \"Calculate delta-delta ratio if concurrent metabolic alkalosis suspected\",\n            ]\n\n        return CalculatorResult(\n            calculator_name=\"Anion Gap\",\n            score=final_ag,\n            unit=\"mEq/L\",\n            risk_level=risk_level,\n            interpretation=interpretation,\n            recommendations=recommendations,\n            components=components,\n            references=[\"Kraut JA, Madias NE. N Engl J Med 2014;371:1434-1445\"],\n        )\n\n    @staticmethod\n    def corrected_calcium(calcium: float, albumin: float) -> CalculatorResult:\n        \"\"\"\n        Albumin-Corrected Calcium.\n\n        Adjusts total calcium for low albumin levels.\n\n        Args:\n            calcium: Total serum calcium in mg/dL\n            albumin: Serum albumin in g/dL\n\n        Returns:\n            CalculatorResult with corrected calcium\n        \"\"\"\n        # Payne formula: corrected Ca = measured Ca + 0.8 * (4.0 - albumin)\n        corrected = calcium + 0.8 * (4.0 - albumin)\n        corrected = round(corrected, 1)\n\n        if corrected < 8.5:\n            risk_level = RiskLevel.HIGH\n            status = \"Hypocalcemia\"\n            interpretation = f\"Corrected calcium {corrected} mg/dL: Hypocalcemia.\"\n            recommendations = [\n                \"Evaluate for causes (vitamin D deficiency, hypoparathyroidism, etc.)\",\n                \"Check ionized calcium if available\",\n                \"Assess for symptoms (tetany, Chvostek's sign)\",\n            ]\n        elif corrected > 10.5:\n            risk_level = RiskLevel.HIGH\n            status = \"Hypercalcemia\"\n            interpretation = f\"Corrected calcium {corrected} mg/dL: Hypercalcemia.\"\n            recommendations = [\n                \"Evaluate for causes (malignancy, hyperparathyroidism, etc.)\",\n                \"Check PTH level\",\n                \"Hydration if symptomatic\",\n            ]\n        else:\n            risk_level = RiskLevel.LOW\n            status = \"Normal\"\n            interpretation = f\"Corrected calcium {corrected} mg/dL: Normal range.\"\n            recommendations = []\n\n        return CalculatorResult(\n            calculator_name=\"Corrected Calcium\",\n            score=corrected,\n            unit=\"mg/dL\",\n            risk_level=risk_level,\n            interpretation=interpretation,\n            recommendations=recommendations,\n            components={\n                \"measured_calcium\": calcium,\n                \"albumin\": albumin,\n                \"status\": status,\n            },\n            references=[\"Payne RB, et al. Br Med J 1973;4:643-646\"],\n            warnings=[\n                \"Ionized calcium is more accurate if available\",\n                \"Correction less reliable in critical illness\",\n            ],\n        )\n\n    @staticmethod\n    def aa_gradient(\n        pao2: float,\n        paco2: float,\n        fio2: float,\n        age: int,\n        atmospheric_pressure: float = 760,\n    ) -> CalculatorResult:\n        \"\"\"\n        Alveolar-Arterial (A-a) Oxygen Gradient.\n\n        Assesses gas exchange efficiency.\n\n        Args:\n            pao2: Arterial PO2 in mmHg\n            paco2: Arterial PCO2 in mmHg\n            fio2: Fraction of inspired oxygen (0.21 to 1.0)\n            age: Patient age in years\n            atmospheric_pressure: Atmospheric pressure in mmHg (default 760)\n\n        Returns:\n            CalculatorResult with A-a gradient and interpretation\n        \"\"\"\n        # Water vapor pressure at body temperature\n        ph2o = 47\n\n        # Respiratory quotient (typical value)\n        rq = 0.8\n\n        # Alveolar oxygen equation\n        pao2_alveolar = (fio2 * (atmospheric_pressure - ph2o)) - (paco2 / rq)\n\n        # A-a gradient\n        aa_grad = pao2_alveolar - pao2\n        aa_grad = round(aa_grad, 1)\n\n        # Expected A-a gradient (increases with age)\n        expected = (age / 4) + 4\n        expected = round(expected, 1)\n\n        # Alternative: Age/4 + 4 at sea level on room air\n        # Normal range on room air: 5-15 mmHg for young adults\n\n        components = {\n            \"pao2\": pao2,\n            \"paco2\": paco2,\n            \"fio2\": fio2,\n            \"pao2_alveolar\": round(pao2_alveolar, 1),\n            \"expected_aa_gradient\": expected,\n        }\n\n        if aa_grad <= expected + 5:\n            risk_level = RiskLevel.LOW\n            interpretation = f\"A-a gradient {aa_grad} mmHg: Normal for age \" f\"(expected ≤{expected + 5}).\"\n            recommendations = [\n                \"Normal gas exchange\",\n                \"If hypoxemic, consider hypoventilation or low FiO2\",\n            ]\n        else:\n            risk_level = RiskLevel.HIGH\n            interpretation = f\"A-a gradient {aa_grad} mmHg: Elevated \" f\"(expected ≤{expected + 5}).\"\n            recommendations = [\n                \"Elevated gradient suggests V/Q mismatch, shunt, or diffusion defect\",\n                \"Consider: PE, pneumonia, ARDS, interstitial lung disease\",\n                \"Further workup based on clinical context\",\n            ]\n\n        return CalculatorResult(\n            calculator_name=\"A-a Gradient\",\n            score=aa_grad,\n            unit=\"mmHg\",\n            risk_level=risk_level,\n            interpretation=interpretation,\n            recommendations=recommendations,\n            components=components,\n            references=[\"West JB. Respiratory Physiology: The Essentials. 10th ed.\"],\n            warnings=[\"Calculation assumes RQ of 0.8\", \"Less reliable on high FiO2\"],\n        )\n\n    @staticmethod\n    def ideal_body_weight(height: float, sex: Sex) -> CalculatorResult:\n        \"\"\"\n        Ideal Body Weight (Devine formula).\n\n        Used for drug dosing and ventilator settings.\n\n        Args:\n            height: Height in cm\n            sex: Biological sex\n\n        Returns:\n            CalculatorResult with IBW in kg\n        \"\"\"\n        # Convert cm to inches\n        height_inches = height / 2.54\n\n        # Devine formula (height in inches)\n        if sex == Sex.MALE:\n            ibw = 50 + 2.3 * (height_inches - 60)\n        else:\n            ibw = 45.5 + 2.3 * (height_inches - 60)\n\n        ibw = round(max(ibw, 0), 1)\n\n        interpretation = f\"Ideal Body Weight: {ibw} kg (Devine formula). \" \"Use for weight-based medication dosing.\"\n\n        return CalculatorResult(\n            calculator_name=\"Ideal Body Weight\",\n            score=ibw,\n            unit=\"kg\",\n            interpretation=interpretation,\n            recommendations=[\n                \"Use for aminoglycoside dosing\",\n                \"Use for tidal volume calculation (6-8 mL/kg IBW)\",\n                \"Consider adjusted body weight for obese patients\",\n            ],\n            components={\"height_cm\": height, \"sex\": sex.value},\n            references=[\"Devine BJ. Drug Intell Clin Pharm 1974;8:650-655\"],\n            warnings=[\n                \"Not validated for heights <5 feet (152 cm)\",\n                \"May give negative values for very short stature\",\n            ],\n        )\n\n    @staticmethod\n    def adjusted_body_weight(actual_weight: float, ideal_weight: float) -> CalculatorResult:\n        \"\"\"\n        Adjusted Body Weight for Obese Patients.\n\n        Used for drug dosing when actual weight significantly exceeds IBW.\n\n        Args:\n            actual_weight: Actual body weight in kg\n            ideal_weight: Ideal body weight in kg\n\n        Returns:\n            CalculatorResult with adjusted body weight\n        \"\"\"\n        # ABW = IBW + 0.4 * (Actual - IBW)\n        abw = ideal_weight + 0.4 * (actual_weight - ideal_weight)\n        abw = round(abw, 1)\n\n        percent_over_ibw = ((actual_weight - ideal_weight) / ideal_weight) * 100\n\n        interpretation = f\"Adjusted Body Weight: {abw} kg.\"\n\n        recommendations = []\n        if percent_over_ibw > 30:\n            recommendations.append(f\"Patient is {round(percent_over_ibw)}% over IBW - use ABW for dosing\")\n            recommendations.append(\"Particularly important for hydrophilic drugs\")\n        else:\n            recommendations.append(\"Adjusted weight may not be necessary if <30% over IBW\")\n\n        return CalculatorResult(\n            calculator_name=\"Adjusted Body Weight\",\n            score=abw,\n            unit=\"kg\",\n            interpretation=interpretation,\n            recommendations=recommendations,\n            components={\n                \"actual_weight\": actual_weight,\n                \"ideal_weight\": ideal_weight,\n                \"percent_over_ibw\": round(percent_over_ibw, 1),\n            },\n            references=[\"Pai MP, Paloucek FP. Ann Pharmacother 2000;34:1066-1069\"],\n        )\n\n    @staticmethod\n    def osmolality_serum(sodium: float, glucose: float, bun: float) -> CalculatorResult:\n        \"\"\"\n        Calculated Serum Osmolality.\n\n        Args:\n            sodium: Serum sodium in mEq/L\n            glucose: Serum glucose in mg/dL\n            bun: Blood urea nitrogen in mg/dL\n\n        Returns:\n            CalculatorResult with calculated osmolality\n        \"\"\"\n        # Formula: 2*Na + Glucose/18 + BUN/2.8\n        osm = (2 * sodium) + (glucose / 18) + (bun / 2.8)\n        osm = round(osm, 1)\n\n        components = {\n            \"sodium_contribution\": 2 * sodium,\n            \"glucose_contribution\": round(glucose / 18, 1),\n            \"bun_contribution\": round(bun / 2.8, 1),\n        }\n\n        if osm < 275:\n            status = \"Hypo-osmolar\"\n            risk_level = RiskLevel.MODERATE\n        elif osm > 295:\n            status = \"Hyperosmolar\"\n            risk_level = RiskLevel.MODERATE\n        else:\n            status = \"Normal\"\n            risk_level = RiskLevel.LOW\n\n        interpretation = f\"Calculated osmolality {osm} mOsm/kg: {status} (normal 275-295).\"\n\n        recommendations = []\n        if osm > 295:\n            recommendations.append(\"Calculate osmolar gap if toxic alcohol suspected\")\n            recommendations.append(\"Osmolar gap = Measured - Calculated (normal <10)\")\n\n        return CalculatorResult(\n            calculator_name=\"Serum Osmolality\",\n            score=osm,\n            unit=\"mOsm/kg\",\n            risk_level=risk_level,\n            interpretation=interpretation,\n            recommendations=recommendations,\n            components=components,\n            references=[\"Bhagat CI, et al. Clin Chem 1984;30:1703-1705\"],\n        )\n\n\n# Convenience function to list all available calculators\ndef list_calculators() -> Dict[str, str]:\n    \"\"\"Return dictionary of all available calculators with descriptions.\"\"\"\n    return {\n        \"cha2ds2_vasc\": \"CHA2DS2-VASc Score for Atrial Fibrillation Stroke Risk\",\n        \"heart_score\": \"HEART Score for Major Cardiac Events\",\n        \"wells_dvt\": \"Wells' Criteria for DVT\",\n        \"wells_pe\": \"Wells' Criteria for Pulmonary Embolism\",\n        \"ckd_epi_2021\": \"CKD-EPI 2021 eGFR (Race-Free)\",\n        \"cockcroft_gault\": \"Cockcroft-Gault Creatinine Clearance\",\n        \"meld_na\": \"MELD-Na Score for Liver Disease\",\n        \"child_pugh\": \"Child-Pugh Score for Cirrhosis\",\n        \"fib4\": \"FIB-4 Index for Liver Fibrosis\",\n        \"sofa\": \"SOFA Score for Organ Failure\",\n        \"qsofa\": \"Quick SOFA for Sepsis Screening\",\n        \"curb65\": \"CURB-65 for Pneumonia Severity\",\n        \"news2\": \"NEWS2 Early Warning Score\",\n        \"bmi\": \"Body Mass Index\",\n        \"bsa_dubois\": \"Body Surface Area (Du Bois)\",\n        \"anion_gap\": \"Serum Anion Gap\",\n        \"corrected_calcium\": \"Albumin-Corrected Calcium\",\n        \"aa_gradient\": \"Alveolar-Arterial Oxygen Gradient\",\n        \"ideal_body_weight\": \"Ideal Body Weight (Devine)\",\n        \"adjusted_body_weight\": \"Adjusted Body Weight for Obesity\",\n        \"osmolality_serum\": \"Calculated Serum Osmolality\",\n    }\n"
}

{
  "path": "apps/web-app/src/components/admin/MetricsCharts.tsx",
  "language": "typescript",
  "size": 11904,
  "last_modified": "2025-11-27T02:50:32.090Z",
  "lines": 394,
  "content": "/**\n * Metrics Charts Component (Phase 8.3)\n * System metrics visualization with simple SVG charts\n */\n\nimport { useState, useEffect, useCallback, useMemo } from \"react\";\nimport {\n  getDefaultAdminApi,\n  type SystemMetricsResponse,\n} from \"../../lib/api/adminApi\";\n\ninterface BarChartProps {\n  data: Array<{ date: string; count: number }>;\n  color: string;\n  height?: number;\n}\n\nfunction BarChart({ data, color, height = 150 }: BarChartProps) {\n  const maxValue = useMemo(\n    () => Math.max(...data.map((d) => d.count), 1),\n    [data],\n  );\n\n  const barWidth = data.length > 0 ? 100 / data.length : 0;\n  const gap = 2;\n\n  if (data.length === 0) {\n    return (\n      <div className=\"flex items-center justify-center h-[150px] text-neutral-500 text-sm\">\n        No data available\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"relative\">\n      <svg width=\"100%\" height={height} className=\"overflow-visible\">\n        {data.map((item, index) => {\n          const barHeight = (item.count / maxValue) * (height - 30);\n          const x = `${index * barWidth + gap / 2}%`;\n          const width = `${barWidth - gap}%`;\n          const y = height - barHeight - 20;\n\n          return (\n            <g key={index}>\n              <rect\n                x={x}\n                y={y}\n                width={width}\n                height={barHeight}\n                fill={color}\n                rx={2}\n                className=\"transition-all duration-200 hover:opacity-80\"\n              >\n                <title>{`${item.date}: ${item.count}`}</title>\n              </rect>\n              {/* Show label on hover or if few data points */}\n              {data.length <= 14 && (\n                <text\n                  x={`${index * barWidth + barWidth / 2}%`}\n                  y={height - 5}\n                  textAnchor=\"middle\"\n                  className=\"text-xs fill-neutral-500\"\n                >\n                  {item.date.split(\"-\").slice(1).join(\"/\")}\n                </text>\n              )}\n            </g>\n          );\n        })}\n      </svg>\n    </div>\n  );\n}\n\ninterface DonutChartProps {\n  data: Array<{ label: string; value: number; color: string }>;\n  size?: number;\n}\n\nfunction DonutChart({ data, size = 150 }: DonutChartProps) {\n  const total = useMemo(\n    () => data.reduce((sum, d) => sum + d.value, 0),\n    [data],\n  );\n  const center = size / 2;\n  const radius = (size - 20) / 2;\n  const innerRadius = radius * 0.6;\n\n  if (total === 0) {\n    return (\n      <div\n        className=\"flex items-center justify-center\"\n        style={{ width: size, height: size }}\n      >\n        <span className=\"text-neutral-500 text-sm\">No data</span>\n      </div>\n    );\n  }\n\n  let currentAngle = -90; // Start from top\n\n  const segments = data.map((item) => {\n    const angle = (item.value / total) * 360;\n    const startAngle = currentAngle;\n    const endAngle = currentAngle + angle;\n    currentAngle = endAngle;\n\n    const startRad = (startAngle * Math.PI) / 180;\n    const endRad = (endAngle * Math.PI) / 180;\n\n    const x1 = center + radius * Math.cos(startRad);\n    const y1 = center + radius * Math.sin(startRad);\n    const x2 = center + radius * Math.cos(endRad);\n    const y2 = center + radius * Math.sin(endRad);\n\n    const x3 = center + innerRadius * Math.cos(endRad);\n    const y3 = center + innerRadius * Math.sin(endRad);\n    const x4 = center + innerRadius * Math.cos(startRad);\n    const y4 = center + innerRadius * Math.sin(startRad);\n\n    const largeArc = angle > 180 ? 1 : 0;\n\n    const path = [\n      `M ${x1} ${y1}`,\n      `A ${radius} ${radius} 0 ${largeArc} 1 ${x2} ${y2}`,\n      `L ${x3} ${y3}`,\n      `A ${innerRadius} ${innerRadius} 0 ${largeArc} 0 ${x4} ${y4}`,\n      \"Z\",\n    ].join(\" \");\n\n    return {\n      ...item,\n      path,\n      percentage: ((item.value / total) * 100).toFixed(0),\n    };\n  });\n\n  return (\n    <div className=\"flex items-center space-x-4\">\n      <svg width={size} height={size}>\n        {segments.map((segment, index) => (\n          <path\n            key={index}\n            d={segment.path}\n            fill={segment.color}\n            className=\"transition-all duration-200 hover:opacity-80\"\n          >\n            <title>{`${segment.label}: ${segment.value} (${segment.percentage}%)`}</title>\n          </path>\n        ))}\n        <text\n          x={center}\n          y={center - 5}\n          textAnchor=\"middle\"\n          className=\"text-2xl font-bold fill-neutral-900\"\n        >\n          {total}\n        </text>\n        <text\n          x={center}\n          y={center + 15}\n          textAnchor=\"middle\"\n          className=\"text-xs fill-neutral-500\"\n        >\n          Total\n        </text>\n      </svg>\n      <div className=\"space-y-2\">\n        {segments.map((segment, index) => (\n          <div key={index} className=\"flex items-center space-x-2\">\n            <div\n              className=\"w-3 h-3 rounded-full\"\n              style={{ backgroundColor: segment.color }}\n            />\n            <span className=\"text-sm text-neutral-600\">\n              {segment.label}: {segment.value} ({segment.percentage}%)\n            </span>\n          </div>\n        ))}\n      </div>\n    </div>\n  );\n}\n\nexport function MetricsCharts() {\n  const [metrics, setMetrics] = useState<SystemMetricsResponse | null>(null);\n  const [days, setDays] = useState(7);\n  const [isLoading, setIsLoading] = useState(true);\n  const [error, setError] = useState<string | null>(null);\n\n  const loadMetrics = useCallback(async () => {\n    try {\n      setError(null);\n      const adminApi = getDefaultAdminApi();\n      const data = await adminApi.getSystemMetrics(days);\n      setMetrics(data);\n      setIsLoading(false);\n    } catch (err) {\n      console.error(\"Failed to load metrics:\", err);\n      setError(err instanceof Error ? err.message : \"Unknown error\");\n      setIsLoading(false);\n    }\n  }, [days]);\n\n  useEffect(() => {\n    loadMetrics();\n  }, [loadMetrics]);\n\n  // Memoize derived distribution data to prevent unnecessary recalculations\n  // All hooks must be called before any conditional returns\n  const userDistribution = useMemo(\n    () =>\n      metrics?.user_distribution\n        ? [\n            {\n              label: \"Active\",\n              value: metrics.user_distribution.active,\n              color: \"#22c55e\",\n            },\n            {\n              label: \"Inactive\",\n              value: metrics.user_distribution.inactive,\n              color: \"#ef4444\",\n            },\n          ]\n        : [],\n    [metrics?.user_distribution],\n  );\n\n  const roleDistribution = useMemo(\n    () =>\n      metrics?.user_distribution\n        ? [\n            {\n              label: \"Admins\",\n              value: metrics.user_distribution.admins,\n              color: \"#8b5cf6\",\n            },\n            {\n              label: \"Regular\",\n              value: metrics.user_distribution.regular,\n              color: \"#3b82f6\",\n            },\n          ]\n        : [],\n    [metrics?.user_distribution],\n  );\n\n  // Memoize summary stats calculation\n  const summaryStats = useMemo(\n    () => ({\n      totalUsers: metrics?.user_distribution?.total ?? 0,\n      activeUsers: metrics?.user_distribution?.active ?? 0,\n      admins: metrics?.user_distribution?.admins ?? 0,\n      newRegistrations:\n        metrics?.daily_registrations?.reduce((sum, d) => sum + d.count, 0) ?? 0,\n    }),\n    [metrics?.user_distribution, metrics?.daily_registrations],\n  );\n\n  // Early returns after all hooks have been called\n  if (isLoading) {\n    return (\n      <div className=\"bg-white rounded-lg shadow p-6\">\n        <div className=\"animate-pulse space-y-4\">\n          <div className=\"h-6 bg-neutral-200 rounded w-1/3\" />\n          <div className=\"h-40 bg-neutral-200 rounded\" />\n        </div>\n      </div>\n    );\n  }\n\n  if (error) {\n    return (\n      <div className=\"bg-white rounded-lg shadow p-6\">\n        <div className=\"flex items-center justify-between mb-4\">\n          <h2 className=\"text-lg font-semibold text-neutral-900\">\n            System Metrics\n          </h2>\n          <button\n            onClick={loadMetrics}\n            className=\"text-sm text-primary-600 hover:text-primary-700\"\n          >\n            Retry\n          </button>\n        </div>\n        <div className=\"bg-red-50 border border-red-200 rounded p-4 text-sm text-red-700\">\n          {error}\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Time Range Selector */}\n      <div className=\"bg-white rounded-lg shadow p-6\">\n        <div className=\"flex items-center justify-between mb-6\">\n          <h2 className=\"text-lg font-semibold text-neutral-900\">\n            System Metrics\n          </h2>\n          <div className=\"flex items-center space-x-2\">\n            {[7, 14, 30].map((d) => (\n              <button\n                key={d}\n                onClick={() => setDays(d)}\n                className={`px-3 py-1.5 text-sm font-medium rounded-md transition-colors ${\n                  days === d\n                    ? \"bg-primary-500 text-white\"\n                    : \"bg-neutral-100 text-neutral-700 hover:bg-neutral-200\"\n                }`}\n              >\n                {d} Days\n              </button>\n            ))}\n          </div>\n        </div>\n\n        {/* Activity Charts */}\n        <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n          <div>\n            <h3 className=\"text-sm font-medium text-neutral-700 mb-3\">\n              Daily Registrations\n            </h3>\n            <BarChart\n              data={metrics?.daily_registrations || []}\n              color=\"#3b82f6\"\n            />\n          </div>\n          <div>\n            <h3 className=\"text-sm font-medium text-neutral-700 mb-3\">\n              Daily Active Users\n            </h3>\n            <BarChart\n              data={metrics?.daily_active_users || []}\n              color=\"#22c55e\"\n            />\n          </div>\n        </div>\n      </div>\n\n      {/* Distribution Charts */}\n      <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n        <div className=\"bg-white rounded-lg shadow p-6\">\n          <h3 className=\"text-sm font-medium text-neutral-700 mb-4\">\n            User Status Distribution\n          </h3>\n          <DonutChart data={userDistribution} />\n        </div>\n        <div className=\"bg-white rounded-lg shadow p-6\">\n          <h3 className=\"text-sm font-medium text-neutral-700 mb-4\">\n            User Role Distribution\n          </h3>\n          <DonutChart data={roleDistribution} />\n        </div>\n      </div>\n\n      {/* Summary Stats */}\n      <div className=\"bg-white rounded-lg shadow p-6\">\n        <h3 className=\"text-sm font-medium text-neutral-700 mb-4\">\n          Summary ({metrics?.period_days || days} days)\n        </h3>\n        <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4\">\n          <div className=\"text-center p-4 bg-neutral-50 rounded-lg\">\n            <p className=\"text-3xl font-bold text-neutral-900\">\n              {summaryStats.totalUsers}\n            </p>\n            <p className=\"text-sm text-neutral-600\">Total Users</p>\n          </div>\n          <div className=\"text-center p-4 bg-green-50 rounded-lg\">\n            <p className=\"text-3xl font-bold text-green-600\">\n              {summaryStats.activeUsers}\n            </p>\n            <p className=\"text-sm text-green-700\">Active Users</p>\n          </div>\n          <div className=\"text-center p-4 bg-purple-50 rounded-lg\">\n            <p className=\"text-3xl font-bold text-purple-600\">\n              {summaryStats.admins}\n            </p>\n            <p className=\"text-sm text-purple-700\">Admins</p>\n          </div>\n          <div className=\"text-center p-4 bg-blue-50 rounded-lg\">\n            <p className=\"text-3xl font-bold text-blue-600\">\n              {summaryStats.newRegistrations}\n            </p>\n            <p className=\"text-sm text-blue-700\">New Registrations</p>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n"
}

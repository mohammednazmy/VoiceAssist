{
  "path": "apps/web-app/src/components/voice/VoiceMetricsDisplay.tsx",
  "language": "typescript",
  "size": 11745,
  "last_modified": "2025-12-01T23:08:53.445Z",
  "lines": 322,
  "content": "/**\n * VoiceMetricsDisplay Component\n * Shows real-time voice session metrics with color-coded latency indicators\n *\n * Features:\n * - Connection time display\n * - STT (Speech-to-Text) latency with color coding\n * - Response latency with color coding\n * - Session duration\n * - Collapsible panel\n */\n\nimport { useState } from \"react\";\n\n/**\n * Voice session metrics interface\n * Used by both OpenAI Realtime and Thinker/Talker pipelines\n */\nexport interface VoiceMetrics {\n  connectionTimeMs: number | null;\n  timeToFirstTranscriptMs?: number | null;\n  lastSttLatencyMs: number | null;\n  lastResponseLatencyMs: number | null;\n  sessionDurationMs?: number | null;\n  userTranscriptCount?: number;\n  aiResponseCount?: number;\n  reconnectCount?: number;\n  sessionStartedAt?: number | null;\n}\n\nexport interface VoiceMetricsDisplayProps {\n  metrics: VoiceMetrics;\n  isConnected: boolean;\n}\n\n/**\n * Get color class based on latency threshold\n * <500ms = green (good), 500-1000ms = yellow (acceptable), >1000ms = red (poor)\n */\nfunction getLatencyColor(latencyMs: number | null | undefined): string {\n  if (latencyMs === null || latencyMs === undefined) return \"text-neutral-400\";\n  if (latencyMs < 500) return \"text-green-600\";\n  if (latencyMs < 1000) return \"text-yellow-600\";\n  return \"text-red-600\";\n}\n\n/**\n * Get background color class based on latency threshold\n */\nfunction getLatencyBgColor(latencyMs: number | null | undefined): string {\n  if (latencyMs === null || latencyMs === undefined) return \"bg-neutral-100\";\n  if (latencyMs < 500) return \"bg-green-50\";\n  if (latencyMs < 1000) return \"bg-yellow-50\";\n  return \"bg-red-50\";\n}\n\n/**\n * Format milliseconds for display\n */\nfunction formatMs(ms: number | null | undefined): string {\n  if (ms === null || ms === undefined) return \"—\";\n  if (ms < 1000) return `${Math.round(ms)}ms`;\n  return `${(ms / 1000).toFixed(1)}s`;\n}\n\n/**\n * Format duration for display (mm:ss)\n */\nfunction formatDuration(ms: number | null | undefined): string {\n  if (ms === null || ms === undefined) return \"—\";\n  const seconds = Math.floor(ms / 1000);\n  const minutes = Math.floor(seconds / 60);\n  const remainingSeconds = seconds % 60;\n  return `${minutes}:${remainingSeconds.toString().padStart(2, \"0\")}`;\n}\n\nexport function VoiceMetricsDisplay({\n  metrics,\n  isConnected,\n}: VoiceMetricsDisplayProps) {\n  const [isExpanded, setIsExpanded] = useState(false);\n\n  // Handle case where metrics is undefined (e.g., in tests with incomplete mocks)\n  if (!metrics) {\n    return null;\n  }\n\n  // Don't show anything if not connected and no metrics to show\n  const hasAnyMetrics =\n    metrics.connectionTimeMs !== null ||\n    metrics.lastSttLatencyMs !== null ||\n    metrics.lastResponseLatencyMs !== null ||\n    metrics.sessionDurationMs !== null;\n\n  if (!isConnected && !hasAnyMetrics) {\n    return null;\n  }\n\n  return (\n    <div\n      className=\"border border-neutral-200 rounded-lg overflow-hidden\"\n      data-testid=\"voice-metrics-display\"\n    >\n      {/* Collapsible Header */}\n      <button\n        type=\"button\"\n        onClick={() => setIsExpanded(!isExpanded)}\n        className=\"w-full min-h-[44px] px-3 py-2 flex items-center justify-between bg-neutral-50 hover:bg-neutral-100 transition-colors\"\n        aria-expanded={isExpanded}\n        aria-controls=\"voice-metrics-content\"\n      >\n        <div className=\"flex items-center space-x-2 min-w-0 flex-shrink\">\n          <svg\n            xmlns=\"http://www.w3.org/2000/svg\"\n            fill=\"none\"\n            viewBox=\"0 0 24 24\"\n            strokeWidth={1.5}\n            stroke=\"currentColor\"\n            className=\"w-4 h-4 text-neutral-500 flex-shrink-0\"\n            aria-hidden=\"true\"\n          >\n            <path\n              strokeLinecap=\"round\"\n              strokeLinejoin=\"round\"\n              d=\"M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z\"\n            />\n          </svg>\n          <span className=\"text-sm font-medium text-neutral-700 truncate\">\n            Voice Metrics\n          </span>\n        </div>\n        <div className=\"flex items-center space-x-3 flex-shrink-0\">\n          {/* Quick stats preview when collapsed */}\n          {!isExpanded && metrics.lastResponseLatencyMs !== null && (\n            <span\n              className={`text-xs font-medium ${getLatencyColor(metrics.lastResponseLatencyMs)}`}\n              aria-label={`Response latency: ${formatMs(metrics.lastResponseLatencyMs)}`}\n            >\n              {formatMs(metrics.lastResponseLatencyMs)}\n            </span>\n          )}\n          <svg\n            xmlns=\"http://www.w3.org/2000/svg\"\n            fill=\"none\"\n            viewBox=\"0 0 24 24\"\n            strokeWidth={1.5}\n            stroke=\"currentColor\"\n            className={`w-4 h-4 text-neutral-400 transition-transform flex-shrink-0 ${isExpanded ? \"rotate-180\" : \"\"}`}\n            aria-hidden=\"true\"\n          >\n            <path\n              strokeLinecap=\"round\"\n              strokeLinejoin=\"round\"\n              d=\"M19.5 8.25l-7.5 7.5-7.5-7.5\"\n            />\n          </svg>\n        </div>\n      </button>\n\n      {/* Expanded Content */}\n      {isExpanded && (\n        <div id=\"voice-metrics-content\" className=\"p-3 space-y-3\">\n          {/* Connection Time */}\n          <div className=\"flex items-center justify-between\">\n            <span className=\"text-xs text-neutral-500\">Connection Time</span>\n            <span\n              className={`text-xs font-mono ${getLatencyColor(metrics.connectionTimeMs)}`}\n              data-testid=\"metric-connection-time\"\n            >\n              {formatMs(metrics.connectionTimeMs)}\n            </span>\n          </div>\n\n          {/* STT Latency */}\n          <div className=\"flex items-center justify-between\">\n            <div className=\"flex items-center space-x-1\">\n              <span className=\"text-xs text-neutral-500\">STT Latency</span>\n              <span\n                className=\"text-xs text-neutral-400\"\n                title=\"Time from end of speech to transcript\"\n              >\n                ⓘ\n              </span>\n            </div>\n            <div\n              className={`px-2 py-0.5 rounded ${getLatencyBgColor(metrics.lastSttLatencyMs)}`}\n            >\n              <span\n                className={`text-xs font-mono ${getLatencyColor(metrics.lastSttLatencyMs)}`}\n                data-testid=\"metric-stt-latency\"\n              >\n                {formatMs(metrics.lastSttLatencyMs)}\n              </span>\n            </div>\n          </div>\n\n          {/* Response Latency */}\n          <div className=\"flex items-center justify-between\">\n            <div className=\"flex items-center space-x-1\">\n              <span className=\"text-xs text-neutral-500\">Response Latency</span>\n              <span\n                className=\"text-xs text-neutral-400\"\n                title=\"Time from end of speech to AI response\"\n              >\n                ⓘ\n              </span>\n            </div>\n            <div\n              className={`px-2 py-0.5 rounded ${getLatencyBgColor(metrics.lastResponseLatencyMs)}`}\n            >\n              <span\n                className={`text-xs font-mono ${getLatencyColor(metrics.lastResponseLatencyMs)}`}\n                data-testid=\"metric-response-latency\"\n              >\n                {formatMs(metrics.lastResponseLatencyMs)}\n              </span>\n            </div>\n          </div>\n\n          {/* Time to First Transcript */}\n          {metrics.timeToFirstTranscriptMs !== null && (\n            <div className=\"flex items-center justify-between\">\n              <div className=\"flex items-center space-x-1\">\n                <span className=\"text-xs text-neutral-500\">\n                  First Transcript\n                </span>\n                <span\n                  className=\"text-xs text-neutral-400\"\n                  title=\"Time from connection to first user transcript\"\n                >\n                  ⓘ\n                </span>\n              </div>\n              <span\n                className={`text-xs font-mono ${getLatencyColor(metrics.timeToFirstTranscriptMs)}`}\n                data-testid=\"metric-first-transcript\"\n              >\n                {formatMs(metrics.timeToFirstTranscriptMs)}\n              </span>\n            </div>\n          )}\n\n          {/* Session Duration */}\n          {metrics.sessionDurationMs !== null && (\n            <div className=\"flex items-center justify-between\">\n              <span className=\"text-xs text-neutral-500\">Session Duration</span>\n              <span\n                className=\"text-xs font-mono text-neutral-700\"\n                data-testid=\"metric-session-duration\"\n              >\n                {formatDuration(metrics.sessionDurationMs)}\n              </span>\n            </div>\n          )}\n\n          {/* Counts */}\n          <div className=\"pt-2 border-t border-neutral-100 flex flex-wrap items-center justify-between gap-2\">\n            <div className=\"flex flex-wrap items-center gap-x-4 gap-y-1\">\n              <span className=\"text-xs text-neutral-400\">\n                <span className=\"font-medium text-neutral-600\">\n                  {metrics.userTranscriptCount}\n                </span>{\" \"}\n                user messages\n              </span>\n              <span className=\"text-xs text-neutral-400\">\n                <span className=\"font-medium text-neutral-600\">\n                  {metrics.aiResponseCount}\n                </span>{\" \"}\n                AI responses\n              </span>\n            </div>\n            {(metrics.reconnectCount ?? 0) > 0 && (\n              <span className=\"text-xs text-orange-500\">\n                {metrics.reconnectCount} reconnect\n                {(metrics.reconnectCount ?? 0) > 1 ? \"s\" : \"\"}\n              </span>\n            )}\n          </div>\n\n          {/* Latency Legend */}\n          <div className=\"pt-2 border-t border-neutral-100\">\n            <div\n              className=\"flex flex-wrap items-center justify-center gap-x-4 gap-y-1 text-xs\"\n              role=\"list\"\n              aria-label=\"Latency quality indicators\"\n            >\n              <div className=\"flex items-center space-x-1\" role=\"listitem\">\n                <span\n                  className=\"w-2 h-2 rounded-full bg-green-500 flex-shrink-0\"\n                  aria-hidden=\"true\"\n                />\n                <span className=\"text-neutral-400\">\n                  <span className=\"sr-only\">Good latency: </span>&lt;500ms\n                </span>\n              </div>\n              <div className=\"flex items-center space-x-1\" role=\"listitem\">\n                <span\n                  className=\"w-2 h-2 rounded-full bg-yellow-500 flex-shrink-0\"\n                  aria-hidden=\"true\"\n                />\n                <span className=\"text-neutral-400\">\n                  <span className=\"sr-only\">Acceptable latency: </span>\n                  500-1000ms\n                </span>\n              </div>\n              <div className=\"flex items-center space-x-1\" role=\"listitem\">\n                <span\n                  className=\"w-2 h-2 rounded-full bg-red-500 flex-shrink-0\"\n                  aria-hidden=\"true\"\n                />\n                <span className=\"text-neutral-400\">\n                  <span className=\"sr-only\">Poor latency: </span>&gt;1000ms\n                </span>\n              </div>\n            </div>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n"
}

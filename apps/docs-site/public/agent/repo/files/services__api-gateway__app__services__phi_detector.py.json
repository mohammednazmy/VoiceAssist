{
  "path": "services/api-gateway/app/services/phi_detector.py",
  "language": "python",
  "size": 6559,
  "last_modified": "2025-12-04T11:26:58.446Z",
  "lines": 181,
  "content": "\"\"\"PHI Detection Service for VoiceAssist.\n\nThis module provides PHI (Protected Health Information) detection to ensure\nHIPAA compliance by identifying sensitive patient information in queries and\nclinical contexts.\n\nIMPORTANT: This is a basic implementation using pattern matching. For production,\nconsider using specialized medical NLP services like:\n- AWS Comprehend Medical\n- Microsoft Text Analytics for Health\n- Custom NER models trained on medical data\n\nSee SECURITY_COMPLIANCE.md for full HIPAA requirements.\n\"\"\"\n\nfrom __future__ import annotations\n\nimport logging\nimport re\nfrom typing import Dict, List, Optional\n\nlogger = logging.getLogger(__name__)\n\n\nclass PHIDetectionResult:\n    \"\"\"Result of PHI detection\"\"\"\n\n    def __init__(\n        self,\n        contains_phi: bool,\n        phi_types: List[str],\n        confidence: float = 1.0,\n        details: Optional[Dict] = None,\n    ):\n        self.contains_phi = contains_phi\n        self.phi_types = phi_types  # List of detected PHI types\n        self.confidence = confidence  # Confidence score (0.0 - 1.0)\n        self.details = details or {}  # Additional details about detection\n\n\nclass PHIDetector:\n    \"\"\"Basic PHI detector using pattern matching.\n\n    Detects common PHI elements according to HIPAA Safe Harbor rules:\n    - Names (first name + last name patterns)\n    - Social Security Numbers\n    - Medical Record Numbers\n    - Account Numbers\n    - Phone Numbers\n    - Email Addresses\n    - Dates (when combined with patient identifiers)\n    - IP Addresses\n    - URLs\n\n    This is a conservative detector - it may flag some false positives\n    to ensure PHI is not inadvertently sent to cloud services.\n    \"\"\"\n\n    def __init__(self):\n        # Compile regex patterns for performance\n        self.patterns = {\n            # SSN patterns (xxx-xx-xxxx or xxxxxxxxx)\n            \"ssn\": re.compile(r\"\\b\\d{3}[- ]?\\d{2}[- ]?\\d{4}\\b\"),\n            # Phone numbers (various formats)\n            \"phone\": re.compile(r\"\\b(?:\\+?1[-.\\s]?)?\\(?\\d{3}\\)?[-.\\s]?\\d{3}[-.\\s]?\\d{4}\\b\"),\n            # Email addresses\n            \"email\": re.compile(r\"\\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Z|a-z]{2,}\\b\"),\n            # Medical Record Numbers (MRN-xxxxxxx or MRN xxxxxxx)\n            \"mrn\": re.compile(\n                r\"\\b(?:MRN|mrn|medical record|record number)[\\s:-]?\\d{6,}\\b\",\n                re.IGNORECASE,\n            ),\n            # Account numbers (ACCT-xxxxxx or Account: xxxxxx)\n            \"account\": re.compile(r\"\\b(?:ACCT|acct|account)[\\s:-]?\\d{6,}\\b\", re.IGNORECASE),\n            # IP addresses\n            \"ip_address\": re.compile(r\"\\b(?:\\d{1,3}\\.){3}\\d{1,3}\\b\"),\n            # URLs\n            \"url\": re.compile(r\"https?://[^\\s]+\"),\n            # Dates with specific patient context (conservative - many false positives)\n            # Only flag if date appears with words like \"patient\", \"born\", \"dob\", etc.\n            \"dob\": re.compile(\n                r\"\\b(?:born|dob|date of birth|birthday)[\\s:]?\"\n                r\"(?:0?[1-9]|1[0-2])[/-](?:0?[1-9]|[12][0-9]|3[01])[/-](?:19|20)\\d{2}\\b\",\n                re.IGNORECASE,\n            ),\n        }\n\n        # Name detection (basic - looks for capitalized words that might be names)\n        # This is very conservative and will have false positives\n        self.name_pattern = re.compile(r\"\\b[A-Z][a-z]+ [A-Z][a-z]+\\b\")\n\n        # Known medical/clinical terms that are NOT PHI\n        # (to reduce false positives from name detection)\n        self.medical_terms = {\n            \"heart disease\",\n            \"blood pressure\",\n            \"diabetes mellitus\",\n            \"atrial fibrillation\",\n            \"chronic kidney\",\n            \"coronary artery\",\n            \"pulmonary embolism\",\n            \"myocardial infarction\",\n            # Add more as needed\n        }\n\n    def detect(self, text: str, clinical_context: Optional[Dict] = None) -> PHIDetectionResult:\n        \"\"\"Detect PHI in text and clinical context.\n\n        Args:\n            text: Query text to analyze\n            clinical_context: Optional clinical context dict\n\n        Returns:\n            PHIDetectionResult with detection results\n        \"\"\"\n        if not text:\n            return PHIDetectionResult(contains_phi=False, phi_types=[])\n\n        phi_types = []\n        details = {}\n\n        # Check patterns\n        for phi_type, pattern in self.patterns.items():\n            matches = pattern.findall(text)\n            if matches:\n                phi_types.append(phi_type)\n                details[phi_type] = len(matches)\n                logger.warning(f\"Detected potential PHI type '{phi_type}' in query (count={len(matches)})\")\n\n        # Check for names (but filter out medical terms)\n        name_matches = self.name_pattern.findall(text)\n        if name_matches:\n            # Filter out known medical terms\n            actual_names = [name for name in name_matches if name.lower() not in self.medical_terms]\n            if actual_names:\n                phi_types.append(\"name\")\n                details[\"name\"] = len(actual_names)\n                logger.warning(f\"Detected potential names in query (count={len(actual_names)})\")\n\n        # Check clinical context for PHI\n        if clinical_context:\n            # Clinical context containing specific patient demographics is considered PHI\n            phi_fields = [\"patient_name\", \"patient_id\", \"ssn\", \"mrn\", \"dob\"]\n            for field in phi_fields:\n                if clinical_context.get(field):\n                    if field not in phi_types:\n                        phi_types.append(field)\n                    details[f\"clinical_context_{field}\"] = True\n\n        contains_phi = len(phi_types) > 0\n\n        if contains_phi:\n            logger.warning(f\"PHI detected: types={phi_types}, confidence=high, details={details}\")\n\n        return PHIDetectionResult(\n            contains_phi=contains_phi,\n            phi_types=phi_types,\n            confidence=0.8,  # Pattern matching has good confidence but not perfect\n            details=details,\n        )\n\n    def sanitize(self, text: str) -> str:\n        \"\"\"Redact detected PHI from text.\n\n        Args:\n            text: Text to sanitize\n\n        Returns:\n            Sanitized text with PHI redacted\n        \"\"\"\n        sanitized = text\n\n        # Replace each PHI pattern with redaction marker\n        for phi_type, pattern in self.patterns.items():\n            sanitized = pattern.sub(f\"[{phi_type.upper()}_REDACTED]\", sanitized)\n\n        # Replace names\n        sanitized = self.name_pattern.sub(\"[NAME_REDACTED]\", sanitized)\n\n        return sanitized\n"
}

{
  "path": "services/api-gateway/app/api/metrics.py",
  "language": "python",
  "size": 3799,
  "last_modified": "2025-12-04T11:26:48.135Z",
  "lines": 103,
  "content": "\"\"\"Prometheus Metrics Endpoint (Phase 7 Integration Improvements - P2.1, P2.5, P3.3).\n\nExposes Prometheus metrics for monitoring and alerting.\n\nMetrics include:\n- Cache hit/miss rates\n- RAG query performance\n- HTTP request latency\n- Database connection pools (P2.5)\n- External API performance\n- Business metrics (P3.3)\n\"\"\"\n\nimport time\nfrom datetime import datetime, timezone\n\nfrom app.core.business_metrics import active_users_daily, active_users_monthly, system_uptime_seconds, version_info\nfrom app.core.database import get_db, get_db_pool_stats, get_redis_pool_stats\nfrom app.core.metrics import (\n    db_pool_checked_in,\n    db_pool_checked_out,\n    db_pool_overflow,\n    db_pool_size,\n    db_pool_utilization_percent,\n    redis_pool_available,\n    redis_pool_in_use,\n    redis_pool_max_connections,\n)\nfrom app.models.user import User\nfrom fastapi import APIRouter, Depends, Response\nfrom prometheus_client import CONTENT_TYPE_LATEST, generate_latest\nfrom sqlalchemy import distinct, func\nfrom sqlalchemy.orm import Session\n\nrouter = APIRouter(prefix=\"/metrics\", tags=[\"observability\"])\n\n# Track application start time for uptime calculation\n_app_start_time = time.time()\n\n\n@router.get(\"\", response_class=Response)\nasync def prometheus_metrics(db: Session = Depends(get_db)):\n    \"\"\"\n    Expose Prometheus metrics in text format.\n\n    This endpoint is scraped by Prometheus server for monitoring.\n    No authentication required (should be secured at infrastructure level).\n\n    Before generating metrics, updates:\n    - Connection pool statistics (P2.5)\n    - Business metrics (P3.3): DAU, MAU, system uptime\n\n    Returns:\n        Prometheus-formatted metrics\n    \"\"\"\n    # Update connection pool metrics (P2.5)\n    try:\n        # PostgreSQL pool stats\n        db_stats = get_db_pool_stats()\n        db_pool_size.set(db_stats[\"size\"])\n        db_pool_checked_out.set(db_stats[\"checked_out\"])\n        db_pool_checked_in.set(db_stats[\"checked_in\"])\n        db_pool_overflow.set(db_stats[\"overflow\"])\n        db_pool_utilization_percent.set(db_stats[\"utilization_percent\"])\n\n        # Redis pool stats\n        redis_stats = get_redis_pool_stats()\n        redis_pool_max_connections.set(redis_stats[\"max_connections\"])\n        redis_pool_in_use.set(redis_stats[\"in_use_connections\"])\n        redis_pool_available.set(redis_stats[\"available_connections\"])\n    except Exception:\n        # If pool stats collection fails, continue with other metrics\n        pass\n\n    # Update business metrics (P3.3)\n    try:\n        # Calculate Daily Active Users (users who logged in today)\n        today_start = datetime.now(timezone.utc).replace(hour=0, minute=0, second=0, microsecond=0)\n        dau_count = db.query(func.count(distinct(User.id))).filter(User.last_login >= today_start).scalar() or 0\n        active_users_daily.set(dau_count)\n\n        # Calculate Monthly Active Users (users who logged in this month)\n        month_start = datetime.now(timezone.utc).replace(day=1, hour=0, minute=0, second=0, microsecond=0)\n        mau_count = db.query(func.count(distinct(User.id))).filter(User.last_login >= month_start).scalar() or 0\n        active_users_monthly.set(mau_count)\n\n        # System uptime in seconds\n        uptime = time.time() - _app_start_time\n        system_uptime_seconds.set(uptime)\n\n        # Version info\n        version_info.info({\"version\": \"0.1.0\", \"environment\": \"development\"})\n\n        # Knowledge base metrics (placeholder for now - will be populated by upload endpoint)\n        # kb_documents_total and kb_chunks_total are already tracked in admin_kb.py\n\n    except Exception:\n        # If business metrics collection fails, continue with other metrics\n        pass\n\n    metrics_data = generate_latest()\n    return Response(content=metrics_data, media_type=CONTENT_TYPE_LATEST)\n"
}

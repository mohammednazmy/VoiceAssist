{
  "path": "apps/web-app/src/components/admin/VoiceMetricsDashboard.tsx",
  "language": "typescript",
  "size": 13581,
  "last_modified": "2025-12-03T23:50:35.642Z",
  "lines": 450,
  "content": "/**\n * Voice Metrics Dashboard - Phase 11: Analytics & Observability\n *\n * Real-time voice mode health dashboard showing:\n * - STT/TTS latency metrics\n * - Session statistics\n * - Error rates\n * - Audio quality indicators\n */\n\nimport { useState, useEffect } from \"react\";\nimport { useVoiceMetrics, SessionStats } from \"../../hooks/useVoiceMetrics\";\nimport { useWebVitals } from \"../../hooks/useWebVitals\";\n\n// Metric card component\ninterface MetricCardProps {\n  title: string;\n  value: string | number;\n  unit?: string;\n  trend?: \"up\" | \"down\" | \"neutral\";\n  trendValue?: string;\n  status?: \"good\" | \"warning\" | \"critical\";\n}\n\nfunction MetricCard({\n  title,\n  value,\n  unit,\n  trend,\n  trendValue,\n  status,\n}: MetricCardProps) {\n  const statusColors = {\n    good: \"text-green-600\",\n    warning: \"text-yellow-600\",\n    critical: \"text-red-600\",\n  };\n\n  const trendIcons = {\n    up: \"↑\",\n    down: \"↓\",\n    neutral: \"→\",\n  };\n\n  return (\n    <div className=\"bg-white rounded-lg shadow p-6\">\n      <p className=\"text-sm text-neutral-600 mb-2\">{title}</p>\n      <div className=\"flex items-baseline space-x-2\">\n        <p\n          className={`text-3xl font-bold ${status ? statusColors[status] : \"text-neutral-900\"}`}\n        >\n          {typeof value === \"number\"\n            ? value.toFixed(value < 10 ? 1 : 0)\n            : value}\n        </p>\n        {unit && <span className=\"text-sm text-neutral-500\">{unit}</span>}\n      </div>\n      {trend && trendValue && (\n        <p\n          className={`text-xs mt-1 ${trend === \"up\" ? \"text-green-600\" : trend === \"down\" ? \"text-red-600\" : \"text-neutral-500\"}`}\n        >\n          {trendIcons[trend]} {trendValue}\n        </p>\n      )}\n    </div>\n  );\n}\n\n// Latency bar component\ninterface LatencyBarProps {\n  label: string;\n  value: number;\n  max: number;\n  threshold: { good: number; warning: number };\n}\n\nfunction LatencyBar({ label, value, max, threshold }: LatencyBarProps) {\n  const percentage = Math.min((value / max) * 100, 100);\n  const status =\n    value <= threshold.good\n      ? \"good\"\n      : value <= threshold.warning\n        ? \"warning\"\n        : \"critical\";\n\n  const barColors = {\n    good: \"bg-green-500\",\n    warning: \"bg-yellow-500\",\n    critical: \"bg-red-500\",\n  };\n\n  return (\n    <div className=\"space-y-1\">\n      <div className=\"flex justify-between text-sm\">\n        <span className=\"text-neutral-600\">{label}</span>\n        <span className=\"font-medium text-neutral-900\">\n          {value.toFixed(0)}ms\n        </span>\n      </div>\n      <div className=\"h-2 bg-neutral-200 rounded-full overflow-hidden\">\n        <div\n          className={`h-full ${barColors[status]} transition-all duration-300`}\n          style={{ width: `${percentage}%` }}\n        />\n      </div>\n      <div className=\"flex justify-between text-xs text-neutral-400\">\n        <span>0ms</span>\n        <span>{max}ms</span>\n      </div>\n    </div>\n  );\n}\n\n// Session timeline item\ninterface SessionTimelineItemProps {\n  session: {\n    sessionId: string;\n    startTime: number;\n    duration?: number;\n    messageCount: number;\n    errorCount: number;\n  };\n}\n\nfunction SessionTimelineItem({ session }: SessionTimelineItemProps) {\n  const startDate = new Date(session.startTime);\n  const duration = session.duration || Date.now() - session.startTime;\n  const durationStr =\n    duration < 60000\n      ? `${Math.round(duration / 1000)}s`\n      : `${Math.round(duration / 60000)}m`;\n\n  return (\n    <div className=\"flex items-center space-x-3 py-2 border-b border-neutral-100 last:border-0\">\n      <div\n        className={`w-2 h-2 rounded-full ${session.errorCount > 0 ? \"bg-red-500\" : \"bg-green-500\"}`}\n      />\n      <div className=\"flex-1 min-w-0\">\n        <p className=\"text-sm font-medium text-neutral-900 truncate\">\n          Session {session.sessionId.slice(-8)}\n        </p>\n        <p className=\"text-xs text-neutral-500\">\n          {startDate.toLocaleTimeString()} · {durationStr} ·{\" \"}\n          {session.messageCount} messages\n        </p>\n      </div>\n      {session.errorCount > 0 && (\n        <span className=\"text-xs px-2 py-0.5 bg-red-100 text-red-700 rounded-full\">\n          {session.errorCount} errors\n        </span>\n      )}\n    </div>\n  );\n}\n\nexport function VoiceMetricsDashboard() {\n  const { currentSession, allSessions, getSessionStats, getAverageLatencies } =\n    useVoiceMetrics();\n\n  const { metrics: webVitals, isSupported: webVitalsSupported } =\n    useWebVitals();\n\n  const [stats, setStats] = useState<SessionStats | null>(null);\n  const [latencies, setLatencies] = useState({ stt: 0, tts: 0 });\n\n  // Update stats periodically\n  useEffect(() => {\n    const updateStats = () => {\n      setStats(getSessionStats());\n      setLatencies(getAverageLatencies());\n    };\n\n    updateStats();\n    const interval = setInterval(updateStats, 5000);\n\n    return () => clearInterval(interval);\n  }, [getSessionStats, getAverageLatencies]);\n\n  // Determine latency status\n  const getSttStatus = (latency: number): \"good\" | \"warning\" | \"critical\" => {\n    if (latency <= 200) return \"good\";\n    if (latency <= 500) return \"warning\";\n    return \"critical\";\n  };\n\n  const getTtsStatus = (latency: number): \"good\" | \"warning\" | \"critical\" => {\n    if (latency <= 300) return \"good\";\n    if (latency <= 800) return \"warning\";\n    return \"critical\";\n  };\n\n  // Recent sessions (last 10)\n  const recentSessions = [...allSessions].reverse().slice(0, 10);\n  if (currentSession) {\n    recentSessions.unshift(currentSession);\n  }\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-2xl font-bold text-neutral-900\">\n            Voice Mode Health\n          </h1>\n          <p className=\"text-sm text-neutral-600\">\n            Real-time voice metrics and session analytics\n          </p>\n        </div>\n        {currentSession && (\n          <div className=\"flex items-center space-x-2\">\n            <span className=\"relative flex h-3 w-3\">\n              <span className=\"animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75\" />\n              <span className=\"relative inline-flex rounded-full h-3 w-3 bg-green-500\" />\n            </span>\n            <span className=\"text-sm font-medium text-green-600\">\n              Active Session\n            </span>\n          </div>\n        )}\n      </div>\n\n      {/* Key Metrics */}\n      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\n        <MetricCard\n          title=\"Avg STT Latency\"\n          value={latencies.stt}\n          unit=\"ms\"\n          status={getSttStatus(latencies.stt)}\n        />\n        <MetricCard\n          title=\"Avg TTS Latency\"\n          value={latencies.tts}\n          unit=\"ms\"\n          status={getTtsStatus(latencies.tts)}\n        />\n        <MetricCard\n          title=\"Total Sessions\"\n          value={stats?.totalSessions || 0}\n          trend={\n            stats?.totalSessions && stats.totalSessions > 0 ? \"up\" : \"neutral\"\n          }\n        />\n        <MetricCard\n          title=\"Error Rate\"\n          value={\n            stats?.totalSessions\n              ? (stats.totalErrors / Math.max(stats.totalMessages, 1)) * 100\n              : 0\n          }\n          unit=\"%\"\n          status={\n            stats?.totalErrors === 0\n              ? \"good\"\n              : stats?.totalErrors && stats.totalErrors < 5\n                ? \"warning\"\n                : \"critical\"\n          }\n        />\n      </div>\n\n      {/* Latency Charts */}\n      <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n        {/* Latency Breakdown */}\n        <div className=\"bg-white rounded-lg shadow p-6\">\n          <h2 className=\"text-lg font-semibold text-neutral-900 mb-4\">\n            Latency Breakdown\n          </h2>\n          <div className=\"space-y-6\">\n            <LatencyBar\n              label=\"Speech-to-Text (STT)\"\n              value={latencies.stt}\n              max={1000}\n              threshold={{ good: 200, warning: 500 }}\n            />\n            <LatencyBar\n              label=\"Text-to-Speech (TTS)\"\n              value={latencies.tts}\n              max={1000}\n              threshold={{ good: 300, warning: 800 }}\n            />\n            <LatencyBar\n              label=\"P95 STT Latency\"\n              value={stats?.p95SttLatency || 0}\n              max={1500}\n              threshold={{ good: 400, warning: 800 }}\n            />\n            <LatencyBar\n              label=\"P95 TTS Latency\"\n              value={stats?.p95TtsLatency || 0}\n              max={1500}\n              threshold={{ good: 500, warning: 1000 }}\n            />\n          </div>\n        </div>\n\n        {/* Session Statistics */}\n        <div className=\"bg-white rounded-lg shadow p-6\">\n          <h2 className=\"text-lg font-semibold text-neutral-900 mb-4\">\n            Session Statistics\n          </h2>\n          <div className=\"grid grid-cols-2 gap-4\">\n            <div className=\"text-center p-4 bg-neutral-50 rounded-lg\">\n              <p className=\"text-3xl font-bold text-primary-600\">\n                {stats?.totalMessages || 0}\n              </p>\n              <p className=\"text-sm text-neutral-600\">Total Messages</p>\n            </div>\n            <div className=\"text-center p-4 bg-neutral-50 rounded-lg\">\n              <p className=\"text-3xl font-bold text-green-600\">\n                {stats?.totalDuration\n                  ? Math.round(stats.totalDuration / 60000)\n                  : 0}\n                m\n              </p>\n              <p className=\"text-sm text-neutral-600\">Total Duration</p>\n            </div>\n            <div className=\"text-center p-4 bg-neutral-50 rounded-lg\">\n              <p className=\"text-3xl font-bold text-blue-600\">\n                {stats?.averageSessionDuration\n                  ? Math.round(stats.averageSessionDuration / 1000)\n                  : 0}\n                s\n              </p>\n              <p className=\"text-sm text-neutral-600\">Avg Session</p>\n            </div>\n            <div className=\"text-center p-4 bg-neutral-50 rounded-lg\">\n              <p className=\"text-3xl font-bold text-yellow-600\">\n                {stats?.totalReconnections || 0}\n              </p>\n              <p className=\"text-sm text-neutral-600\">Reconnections</p>\n            </div>\n          </div>\n        </div>\n      </div>\n\n      {/* Recent Sessions */}\n      <div className=\"bg-white rounded-lg shadow p-6\">\n        <h2 className=\"text-lg font-semibold text-neutral-900 mb-4\">\n          Recent Sessions\n        </h2>\n        {recentSessions.length > 0 ? (\n          <div className=\"divide-y divide-neutral-100\">\n            {recentSessions.map((session) => (\n              <SessionTimelineItem key={session.sessionId} session={session} />\n            ))}\n          </div>\n        ) : (\n          <p className=\"text-center text-neutral-500 py-8\">\n            No voice sessions recorded yet\n          </p>\n        )}\n      </div>\n\n      {/* Web Vitals Section */}\n      {webVitalsSupported && (\n        <div className=\"bg-white rounded-lg shadow p-6\">\n          <h2 className=\"text-lg font-semibold text-neutral-900 mb-4\">\n            Core Web Vitals\n          </h2>\n          <div className=\"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4\">\n            <VitalMetric\n              name=\"LCP\"\n              value={webVitals.lcp}\n              unit=\"ms\"\n              thresholds={{ good: 2500, warning: 4000 }}\n            />\n            <VitalMetric\n              name=\"FID\"\n              value={webVitals.fid}\n              unit=\"ms\"\n              thresholds={{ good: 100, warning: 300 }}\n            />\n            <VitalMetric\n              name=\"CLS\"\n              value={webVitals.cls}\n              unit=\"\"\n              thresholds={{ good: 0.1, warning: 0.25 }}\n              decimals={3}\n            />\n            <VitalMetric\n              name=\"FCP\"\n              value={webVitals.fcp}\n              unit=\"ms\"\n              thresholds={{ good: 1800, warning: 3000 }}\n            />\n            <VitalMetric\n              name=\"TTFB\"\n              value={webVitals.ttfb}\n              unit=\"ms\"\n              thresholds={{ good: 800, warning: 1800 }}\n            />\n            <VitalMetric\n              name=\"INP\"\n              value={webVitals.inp}\n              unit=\"ms\"\n              thresholds={{ good: 200, warning: 500 }}\n            />\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n\n// Web Vital metric display\ninterface VitalMetricProps {\n  name: string;\n  value?: number;\n  unit: string;\n  thresholds: { good: number; warning: number };\n  decimals?: number;\n}\n\nfunction VitalMetric({\n  name,\n  value,\n  unit,\n  thresholds,\n  decimals = 0,\n}: VitalMetricProps) {\n  const getStatus = (): \"good\" | \"warning\" | \"critical\" | \"unknown\" => {\n    if (value === undefined) return \"unknown\";\n    if (value <= thresholds.good) return \"good\";\n    if (value <= thresholds.warning) return \"warning\";\n    return \"critical\";\n  };\n\n  const status = getStatus();\n  const colors = {\n    good: \"text-green-600 bg-green-50\",\n    warning: \"text-yellow-600 bg-yellow-50\",\n    critical: \"text-red-600 bg-red-50\",\n    unknown: \"text-neutral-400 bg-neutral-50\",\n  };\n\n  return (\n    <div className={`text-center p-4 rounded-lg ${colors[status]}`}>\n      <p className=\"text-2xl font-bold\">\n        {value !== undefined ? value.toFixed(decimals) : \"-\"}\n      </p>\n      <p className=\"text-sm font-medium\">\n        {name} {unit && <span className=\"font-normal\">{unit}</span>}\n      </p>\n    </div>\n  );\n}\n\nexport default VoiceMetricsDashboard;\n"
}

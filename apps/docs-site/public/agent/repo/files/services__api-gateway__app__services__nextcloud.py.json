{
  "path": "services/api-gateway/app/services/nextcloud.py",
  "language": "python",
  "size": 7689,
  "last_modified": "2025-12-04T11:26:58.173Z",
  "lines": 227,
  "content": "\"\"\"\nNextcloud integration service for user provisioning and file management\n\"\"\"\n\nfrom typing import Any, Dict, Optional\n\nimport httpx\nimport structlog\nfrom app.core.config import settings\n\nlogger = structlog.get_logger(__name__)\n\n\nclass NextcloudService:\n    \"\"\"Service for interacting with Nextcloud API\"\"\"\n\n    def __init__(self):\n        self.base_url = settings.NEXTCLOUD_URL.rstrip(\"/\")\n        self.admin_user = settings.NEXTCLOUD_ADMIN_USER\n        self.admin_password = settings.NEXTCLOUD_ADMIN_PASSWORD\n        self.timeout = 30.0\n\n    async def health_check(self) -> bool:\n        \"\"\"\n        Check if Nextcloud is accessible\n\n        Returns:\n            True if Nextcloud is accessible, False otherwise\n        \"\"\"\n        try:\n            async with httpx.AsyncClient(timeout=5.0) as client:\n                response = await client.get(\n                    f\"{self.base_url}/status.php\",\n                    auth=(self.admin_user, self.admin_password),\n                )\n                return response.status_code == 200\n        except Exception as e:\n            logger.warning(\"nextcloud_health_check_failed\", error=str(e))\n            return False\n\n    async def create_user(self, username: str, password: str, email: str, display_name: str) -> bool:\n        \"\"\"\n        Create a new user in Nextcloud\n\n        Args:\n            username: Nextcloud username (usually email prefix)\n            password: User's password\n            email: User's email address\n            display_name: User's display name\n\n        Returns:\n            True if user was created successfully, False otherwise\n        \"\"\"\n        try:\n            async with httpx.AsyncClient(timeout=self.timeout) as client:\n                # Create user\n                response = await client.post(\n                    f\"{self.base_url}/ocs/v1.php/cloud/users\",\n                    auth=(self.admin_user, self.admin_password),\n                    data={\n                        \"userid\": username,\n                        \"password\": password,\n                        \"email\": email,\n                        \"displayName\": display_name,\n                    },\n                    headers={\"OCS-APIRequest\": \"true\"},\n                )\n\n                if response.status_code in [200, 201]:\n                    logger.info(\"nextcloud_user_created\", username=username, email=email)\n                    return True\n                else:\n                    logger.error(\n                        \"nextcloud_user_creation_failed\",\n                        username=username,\n                        status_code=response.status_code,\n                        response=response.text,\n                    )\n                    return False\n\n        except Exception as e:\n            logger.error(\"nextcloud_create_user_error\", username=username, error=str(e))\n            return False\n\n    async def user_exists(self, username: str) -> bool:\n        \"\"\"\n        Check if a user exists in Nextcloud\n\n        Args:\n            username: Nextcloud username to check\n\n        Returns:\n            True if user exists, False otherwise\n        \"\"\"\n        try:\n            async with httpx.AsyncClient(timeout=self.timeout) as client:\n                response = await client.get(\n                    f\"{self.base_url}/ocs/v1.php/cloud/users/{username}\",\n                    auth=(self.admin_user, self.admin_password),\n                    headers={\"OCS-APIRequest\": \"true\"},\n                )\n                return response.status_code == 200\n\n        except Exception as e:\n            logger.error(\"nextcloud_user_exists_check_error\", username=username, error=str(e))\n            return False\n\n    async def get_user_info(self, username: str) -> Optional[Dict[str, Any]]:\n        \"\"\"\n        Get user information from Nextcloud\n\n        Args:\n            username: Nextcloud username\n\n        Returns:\n            User information dictionary or None if not found\n        \"\"\"\n        try:\n            async with httpx.AsyncClient(timeout=self.timeout) as client:\n                response = await client.get(\n                    f\"{self.base_url}/ocs/v1.php/cloud/users/{username}\",\n                    auth=(self.admin_user, self.admin_password),\n                    headers={\"OCS-APIRequest\": \"true\"},\n                )\n\n                if response.status_code == 200:\n                    return response.json().get(\"ocs\", {}).get(\"data\", {})\n                return None\n\n        except Exception as e:\n            logger.error(\"nextcloud_get_user_info_error\", username=username, error=str(e))\n            return None\n\n    async def get_user_quota(self, username: str) -> Optional[Dict[str, Any]]:\n        \"\"\"\n        Get user's storage quota information\n\n        Args:\n            username: Nextcloud username\n\n        Returns:\n            Quota information dictionary with 'free', 'used', 'total', 'relative' keys\n        \"\"\"\n        user_info = await self.get_user_info(username)\n        if user_info:\n            return user_info.get(\"quota\", {})\n        return None\n\n    async def enable_user(self, username: str) -> bool:\n        \"\"\"\n        Enable a user account in Nextcloud\n\n        Args:\n            username: Nextcloud username\n\n        Returns:\n            True if successful, False otherwise\n        \"\"\"\n        try:\n            async with httpx.AsyncClient(timeout=self.timeout) as client:\n                response = await client.put(\n                    f\"{self.base_url}/ocs/v1.php/cloud/users/{username}/enable\",\n                    auth=(self.admin_user, self.admin_password),\n                    headers={\"OCS-APIRequest\": \"true\"},\n                )\n                return response.status_code == 200\n\n        except Exception as e:\n            logger.error(\"nextcloud_enable_user_error\", username=username, error=str(e))\n            return False\n\n    async def disable_user(self, username: str) -> bool:\n        \"\"\"\n        Disable a user account in Nextcloud\n\n        Args:\n            username: Nextcloud username\n\n        Returns:\n            True if successful, False otherwise\n        \"\"\"\n        try:\n            async with httpx.AsyncClient(timeout=self.timeout) as client:\n                response = await client.put(\n                    f\"{self.base_url}/ocs/v1.php/cloud/users/{username}/disable\",\n                    auth=(self.admin_user, self.admin_password),\n                    headers={\"OCS-APIRequest\": \"true\"},\n                )\n                return response.status_code == 200\n\n        except Exception as e:\n            logger.error(\"nextcloud_disable_user_error\", username=username, error=str(e))\n            return False\n\n    async def delete_user(self, username: str) -> bool:\n        \"\"\"\n        Delete a user from Nextcloud\n\n        Args:\n            username: Nextcloud username\n\n        Returns:\n            True if successful, False otherwise\n        \"\"\"\n        try:\n            async with httpx.AsyncClient(timeout=self.timeout) as client:\n                response = await client.delete(\n                    f\"{self.base_url}/ocs/v1.php/cloud/users/{username}\",\n                    auth=(self.admin_user, self.admin_password),\n                    headers={\"OCS-APIRequest\": \"true\"},\n                )\n                return response.status_code == 200\n\n        except Exception as e:\n            logger.error(\"nextcloud_delete_user_error\", username=username, error=str(e))\n            return False\n\n\n# Global Nextcloud service instance\nnextcloud_service = NextcloudService()\n\n\n# Helper function to check Nextcloud connection\nasync def check_nextcloud_connection() -> bool:\n    \"\"\"Check if Nextcloud is accessible\"\"\"\n    return await nextcloud_service.health_check()\n"
}

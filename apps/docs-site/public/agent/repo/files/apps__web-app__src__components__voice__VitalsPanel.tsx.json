{
  "path": "apps/web-app/src/components/voice/VitalsPanel.tsx",
  "language": "typescript",
  "size": 13500,
  "last_modified": "2025-12-04T22:09:55.012Z",
  "lines": 467,
  "content": "/**\n * VitalsPanel - FHIR Vital Signs Display Component\n *\n * Displays real-time patient vitals and lab results from FHIR streaming.\n * Part of Voice Mode v4.1 Phase 3 for clinical context enrichment.\n *\n * Features:\n * - Grid display for vital signs (BP, HR, Temp, SpO2, etc.)\n * - List display for lab results with interpretation indicators\n * - Real-time streaming indicator\n * - Abnormal value highlighting\n * - Click handler for value details\n *\n * Reference: docs/voice/fhir-streaming-service.md\n */\n\nimport { useState, useEffect, useMemo } from \"react\";\nimport { cn } from \"@/lib/utils\";\nimport { Tooltip } from \"../ui/Tooltip\";\n\nexport interface FHIRObservation {\n  resourceId: string;\n  resourceType: \"vital-signs\" | \"laboratory\" | string;\n  patientId: string;\n  code: string;\n  codeDisplay: string;\n  value?: string;\n  valueQuantity?: number;\n  valueUnit?: string;\n  effectiveDatetime?: string;\n  status: string;\n  interpretation?: \"High\" | \"Low\" | \"Normal\" | \"Critical\" | string;\n  referenceRange?: string;\n}\n\ninterface VitalCardProps {\n  label: string;\n  value: string;\n  interpretation?: string;\n  timestamp?: string;\n  onClick?: () => void;\n}\n\nfunction VitalCard({\n  label,\n  value,\n  interpretation,\n  timestamp,\n  onClick,\n}: VitalCardProps) {\n  const isAbnormal =\n    interpretation === \"High\" ||\n    interpretation === \"Low\" ||\n    interpretation === \"Critical\";\n  const isCritical = interpretation === \"Critical\";\n\n  return (\n    <div\n      className={cn(\n        \"p-3 rounded-lg border transition-all cursor-pointer\",\n        \"bg-white dark:bg-neutral-800\",\n        \"hover:shadow-md hover:border-blue-300 dark:hover:border-blue-600\",\n        isCritical\n          ? \"border-red-500 dark:border-red-500 animate-pulse\"\n          : isAbnormal\n            ? \"border-yellow-400 dark:border-yellow-600\"\n            : \"border-neutral-200 dark:border-neutral-700\",\n      )}\n      onClick={onClick}\n      role=\"button\"\n      tabIndex={0}\n      onKeyDown={(e) => e.key === \"Enter\" && onClick?.()}\n    >\n      <div className=\"text-xs text-neutral-500 dark:text-neutral-400 mb-1 truncate\">\n        {label}\n      </div>\n      <div\n        className={cn(\n          \"text-lg font-semibold\",\n          isCritical\n            ? \"text-red-600 dark:text-red-400\"\n            : isAbnormal\n              ? \"text-yellow-600 dark:text-yellow-400\"\n              : \"text-neutral-900 dark:text-neutral-100\",\n        )}\n      >\n        {value}\n      </div>\n      <div className=\"flex items-center justify-between mt-1\">\n        {interpretation && (\n          <span\n            className={cn(\n              \"text-xs px-1.5 py-0.5 rounded-full\",\n              interpretation === \"High\" && \"bg-yellow-100 text-yellow-700\",\n              interpretation === \"Low\" && \"bg-blue-100 text-blue-700\",\n              interpretation === \"Critical\" && \"bg-red-100 text-red-700\",\n              interpretation === \"Normal\" && \"bg-green-100 text-green-700\",\n            )}\n          >\n            {interpretation}\n          </span>\n        )}\n        {timestamp && (\n          <span className=\"text-xs text-neutral-400\">\n            {new Date(timestamp).toLocaleTimeString([], {\n              hour: \"2-digit\",\n              minute: \"2-digit\",\n            })}\n          </span>\n        )}\n      </div>\n    </div>\n  );\n}\n\ninterface LabResultRowProps {\n  label: string;\n  value: string;\n  interpretation?: string;\n  referenceRange?: string;\n  onClick?: () => void;\n}\n\nfunction LabResultRow({\n  label,\n  value,\n  interpretation,\n  referenceRange,\n  onClick,\n}: LabResultRowProps) {\n  const isAbnormal =\n    interpretation === \"High\" ||\n    interpretation === \"Low\" ||\n    interpretation === \"Critical\";\n\n  return (\n    <div\n      className={cn(\n        \"flex items-center justify-between py-2 px-3 rounded-lg\",\n        \"hover:bg-neutral-50 dark:hover:bg-neutral-800 cursor-pointer\",\n        \"transition-colors\",\n      )}\n      onClick={onClick}\n      role=\"button\"\n      tabIndex={0}\n      onKeyDown={(e) => e.key === \"Enter\" && onClick?.()}\n    >\n      <div className=\"flex-1\">\n        <div className=\"text-sm text-neutral-900 dark:text-neutral-100\">\n          {label}\n        </div>\n        {referenceRange && (\n          <div className=\"text-xs text-neutral-400\">Ref: {referenceRange}</div>\n        )}\n      </div>\n      <div className=\"flex items-center gap-2\">\n        <span\n          className={cn(\n            \"font-medium\",\n            isAbnormal\n              ? \"text-yellow-600 dark:text-yellow-400\"\n              : \"text-neutral-900 dark:text-neutral-100\",\n          )}\n        >\n          {value}\n        </span>\n        {interpretation && (\n          <Tooltip content={`Interpretation: ${interpretation}`}>\n            <span\n              className={cn(\n                \"w-2 h-2 rounded-full\",\n                interpretation === \"High\" && \"bg-yellow-500\",\n                interpretation === \"Low\" && \"bg-blue-500\",\n                interpretation === \"Critical\" && \"bg-red-500 animate-pulse\",\n                interpretation === \"Normal\" && \"bg-green-500\",\n              )}\n            />\n          </Tooltip>\n        )}\n      </div>\n    </div>\n  );\n}\n\ninterface VitalsPanelProps {\n  /** Patient ID for FHIR subscription */\n  patientId: string;\n  /** FHIR observations (vitals + labs) */\n  observations: FHIRObservation[];\n  /** Whether data is streaming live */\n  isStreaming?: boolean;\n  /** Callback when an observation is clicked */\n  onObservationClick?: (observation: FHIRObservation) => void;\n  /** Maximum number of vitals to show */\n  maxVitals?: number;\n  /** Maximum number of labs to show */\n  maxLabs?: number;\n  /** Custom class name */\n  className?: string;\n}\n\nexport function VitalsPanel({\n  observations,\n  isStreaming = false,\n  onObservationClick,\n  maxVitals = 4,\n  maxLabs = 5,\n  className,\n}: VitalsPanelProps) {\n  // Separate vitals and labs\n  const { vitals, labs, abnormalLabs, normalLabs } = useMemo(() => {\n    const vitalsList = observations.filter(\n      (o) => o.resourceType === \"vital-signs\",\n    );\n    const labsList = observations.filter(\n      (o) => o.resourceType === \"laboratory\",\n    );\n    const abnormal = labsList.filter(\n      (l) => l.interpretation && l.interpretation !== \"Normal\",\n    );\n    const normal = labsList.filter(\n      (l) => !l.interpretation || l.interpretation === \"Normal\",\n    );\n    return {\n      vitals: vitalsList,\n      labs: labsList,\n      abnormalLabs: abnormal,\n      normalLabs: normal,\n    };\n  }, [observations]);\n\n  const formatValue = (obs: FHIRObservation): string => {\n    if (obs.value) return obs.value;\n    if (obs.valueQuantity !== undefined) {\n      return `${obs.valueQuantity}${obs.valueUnit ? ` ${obs.valueUnit}` : \"\"}`;\n    }\n    return \"—\";\n  };\n\n  if (observations.length === 0) {\n    return (\n      <div\n        className={cn(\n          \"p-4 text-center text-neutral-500 dark:text-neutral-400\",\n          \"bg-neutral-50 dark:bg-neutral-800/50 rounded-lg\",\n          className,\n        )}\n      >\n        <div className=\"text-lg mb-1\">No patient data available</div>\n        <div className=\"text-sm\">\n          {isStreaming\n            ? \"Waiting for FHIR updates...\"\n            : \"Enable FHIR streaming to see patient data\"}\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div\n      className={cn(\n        \"vitals-panel bg-white dark:bg-neutral-900 rounded-lg p-4\",\n        \"border border-neutral-200 dark:border-neutral-700\",\n        className,\n      )}\n    >\n      {/* Header */}\n      <div className=\"flex items-center justify-between mb-4\">\n        <h3 className=\"text-lg font-semibold text-neutral-900 dark:text-neutral-100\">\n          Latest Patient Data\n        </h3>\n\n        {/* Streaming indicator */}\n        {isStreaming && (\n          <div className=\"flex items-center gap-2 text-sm text-green-600 dark:text-green-400\">\n            <span className=\"w-2 h-2 bg-green-500 rounded-full animate-pulse\" />\n            <span>Live updates</span>\n          </div>\n        )}\n      </div>\n\n      {/* Vital Signs Grid */}\n      {vitals.length > 0 && (\n        <div className=\"grid grid-cols-2 gap-3 mb-4\">\n          {vitals.slice(0, maxVitals).map((vital) => (\n            <VitalCard\n              key={vital.resourceId}\n              label={vital.codeDisplay}\n              value={formatValue(vital)}\n              interpretation={vital.interpretation}\n              timestamp={vital.effectiveDatetime}\n              onClick={() => onObservationClick?.(vital)}\n            />\n          ))}\n        </div>\n      )}\n\n      {/* Lab Results */}\n      {labs.length > 0 && (\n        <div className=\"mt-4\">\n          <h4 className=\"text-sm font-medium text-neutral-700 dark:text-neutral-300 mb-2\">\n            Recent Labs\n          </h4>\n\n          {/* Abnormal values first */}\n          {abnormalLabs.length > 0 && (\n            <div className=\"mb-3\">\n              <div className=\"text-xs text-yellow-600 dark:text-yellow-400 font-medium mb-1 uppercase tracking-wide\">\n                Abnormal Values\n              </div>\n              <div className=\"space-y-1\">\n                {abnormalLabs.slice(0, maxLabs).map((lab) => (\n                  <LabResultRow\n                    key={lab.resourceId}\n                    label={lab.codeDisplay}\n                    value={formatValue(lab)}\n                    interpretation={lab.interpretation}\n                    referenceRange={lab.referenceRange}\n                    onClick={() => onObservationClick?.(lab)}\n                  />\n                ))}\n              </div>\n            </div>\n          )}\n\n          {/* Normal values */}\n          {normalLabs.length > 0 && abnormalLabs.length < maxLabs && (\n            <div>\n              {abnormalLabs.length > 0 && (\n                <div className=\"text-xs text-neutral-500 dark:text-neutral-400 font-medium mb-1 uppercase tracking-wide\">\n                  Other Results\n                </div>\n              )}\n              <div className=\"space-y-1\">\n                {normalLabs\n                  .slice(0, maxLabs - abnormalLabs.length)\n                  .map((lab) => (\n                    <LabResultRow\n                      key={lab.resourceId}\n                      label={lab.codeDisplay}\n                      value={formatValue(lab)}\n                      interpretation={lab.interpretation}\n                      referenceRange={lab.referenceRange}\n                      onClick={() => onObservationClick?.(lab)}\n                    />\n                  ))}\n              </div>\n            </div>\n          )}\n        </div>\n      )}\n    </div>\n  );\n}\n\n/**\n * Hook to subscribe to FHIR observation updates\n */\nexport function useFHIRObservations(\n  patientId: string,\n  options?: {\n    includeVitals?: boolean;\n    includeLabs?: boolean;\n    maxResults?: number;\n  },\n) {\n  const [observations, setObservations] = useState<FHIRObservation[]>([]);\n  const [isStreaming, setIsStreaming] = useState(false);\n  const [error, setError] = useState<string | null>(null);\n\n  useEffect(() => {\n    if (!patientId) return;\n\n    // In production, this would connect to the FHIR streaming endpoint\n    // For now, we simulate with demo data\n    const simulateStream = () => {\n      setIsStreaming(true);\n\n      // Demo observations\n      const demoObs: FHIRObservation[] = [\n        {\n          resourceId: \"v1\",\n          resourceType: \"vital-signs\",\n          patientId,\n          code: \"8480-6\",\n          codeDisplay: \"Blood Pressure\",\n          value: \"120/80\",\n          valueUnit: \"mmHg\",\n          status: \"final\",\n          effectiveDatetime: new Date().toISOString(),\n        },\n        {\n          resourceId: \"v2\",\n          resourceType: \"vital-signs\",\n          patientId,\n          code: \"8867-4\",\n          codeDisplay: \"Heart Rate\",\n          valueQuantity: 72,\n          valueUnit: \"bpm\",\n          status: \"final\",\n          effectiveDatetime: new Date().toISOString(),\n        },\n        {\n          resourceId: \"v3\",\n          resourceType: \"vital-signs\",\n          patientId,\n          code: \"8310-5\",\n          codeDisplay: \"Temperature\",\n          valueQuantity: 98.6,\n          valueUnit: \"°F\",\n          status: \"final\",\n          effectiveDatetime: new Date().toISOString(),\n        },\n        {\n          resourceId: \"v4\",\n          resourceType: \"vital-signs\",\n          patientId,\n          code: \"59408-5\",\n          codeDisplay: \"SpO2\",\n          valueQuantity: 98,\n          valueUnit: \"%\",\n          status: \"final\",\n          effectiveDatetime: new Date().toISOString(),\n        },\n        {\n          resourceId: \"l1\",\n          resourceType: \"laboratory\",\n          patientId,\n          code: \"2339-0\",\n          codeDisplay: \"Glucose\",\n          valueQuantity: 180,\n          valueUnit: \"mg/dL\",\n          status: \"final\",\n          interpretation: \"High\",\n          referenceRange: \"70-100\",\n          effectiveDatetime: new Date().toISOString(),\n        },\n        {\n          resourceId: \"l2\",\n          resourceType: \"laboratory\",\n          patientId,\n          code: \"4548-4\",\n          codeDisplay: \"Hemoglobin A1c\",\n          valueQuantity: 6.5,\n          valueUnit: \"%\",\n          status: \"final\",\n          interpretation: \"Normal\",\n          referenceRange: \"4.0-5.6\",\n          effectiveDatetime: new Date().toISOString(),\n        },\n      ];\n\n      setObservations(demoObs);\n    };\n\n    simulateStream();\n\n    return () => {\n      setIsStreaming(false);\n    };\n  }, [patientId]);\n\n  return { observations, isStreaming, error };\n}\n\nexport default VitalsPanel;\n"
}

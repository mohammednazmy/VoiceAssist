{
  "path": "apps/web-app/src/components/admin/UserManagement.tsx",
  "language": "typescript",
  "size": 16278,
  "last_modified": "2025-11-27T02:50:32.090Z",
  "lines": 450,
  "content": "/**\n * User Management Component (Phase 8.3)\n * CRUD operations for user administration\n */\n\nimport { useState, useEffect, useCallback } from \"react\";\nimport {\n  getDefaultAdminApi,\n  type AdminUser,\n  type UserUpdateRequest,\n} from \"../../lib/api/adminApi\";\n\ninterface EditingUser {\n  id: string;\n  email: string;\n  full_name: string;\n  is_admin: boolean;\n  is_active: boolean;\n}\n\nexport function UserManagement() {\n  const [users, setUsers] = useState<AdminUser[]>([]);\n  const [total, setTotal] = useState(0);\n  const [offset, setOffset] = useState(0);\n  const [limit] = useState(10);\n  const [search, setSearch] = useState(\"\");\n  const [filterActive, setFilterActive] = useState<boolean | undefined>();\n  const [filterAdmin, setFilterAdmin] = useState<boolean | undefined>();\n  const [isLoading, setIsLoading] = useState(true);\n  const [error, setError] = useState<string | null>(null);\n  const [editingUser, setEditingUser] = useState<EditingUser | null>(null);\n  const [isSaving, setIsSaving] = useState(false);\n\n  const loadUsers = useCallback(async () => {\n    try {\n      setError(null);\n      const adminApi = getDefaultAdminApi();\n      const data = await adminApi.getUsers({\n        offset,\n        limit,\n        search: search || undefined,\n        is_active: filterActive,\n        is_admin: filterAdmin,\n      });\n      setUsers(data.users);\n      setTotal(data.total);\n      setIsLoading(false);\n    } catch (err) {\n      console.error(\"Failed to load users:\", err);\n      setError(err instanceof Error ? err.message : \"Unknown error\");\n      setIsLoading(false);\n    }\n  }, [offset, limit, search, filterActive, filterAdmin]);\n\n  useEffect(() => {\n    loadUsers();\n  }, [loadUsers]);\n\n  const handleSearch = (e: React.FormEvent) => {\n    e.preventDefault();\n    setOffset(0);\n    loadUsers();\n  };\n\n  const handleEdit = (user: AdminUser) => {\n    setEditingUser({\n      id: user.id,\n      email: user.email,\n      full_name: user.full_name || \"\",\n      is_admin: user.is_admin,\n      is_active: user.is_active,\n    });\n  };\n\n  const handleSave = async () => {\n    if (!editingUser) return;\n\n    setIsSaving(true);\n    setError(null);\n\n    try {\n      const adminApi = getDefaultAdminApi();\n      const updateData: UserUpdateRequest = {\n        email: editingUser.email,\n        full_name: editingUser.full_name,\n        is_admin: editingUser.is_admin,\n        is_active: editingUser.is_active,\n      };\n\n      await adminApi.updateUser(editingUser.id, updateData);\n      setEditingUser(null);\n      loadUsers();\n    } catch (err) {\n      console.error(\"Failed to update user:\", err);\n      setError(err instanceof Error ? err.message : \"Failed to update user\");\n    } finally {\n      setIsSaving(false);\n    }\n  };\n\n  const handleDelete = async (userId: string, email: string) => {\n    if (\n      !confirm(\n        `Are you sure you want to deactivate user ${email}? This will prevent them from logging in.`,\n      )\n    ) {\n      return;\n    }\n\n    try {\n      setError(null);\n      const adminApi = getDefaultAdminApi();\n      await adminApi.deleteUser(userId);\n      loadUsers();\n    } catch (err) {\n      console.error(\"Failed to delete user:\", err);\n      setError(\n        err instanceof Error ? err.message : \"Failed to deactivate user\",\n      );\n    }\n  };\n\n  const totalPages = Math.ceil(total / limit);\n  const currentPage = Math.floor(offset / limit) + 1;\n\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center justify-center h-full\">\n        <div className=\"text-center\">\n          <div className=\"w-12 h-12 mx-auto mb-4 rounded-full border-4 border-primary-500 border-t-transparent animate-spin\" />\n          <p className=\"text-neutral-600\">Loading users...</p>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-2xl font-bold text-neutral-900\">\n            User Management\n          </h1>\n          <p className=\"text-sm text-neutral-600\">\n            Manage user accounts and permissions\n          </p>\n        </div>\n      </div>\n\n      {/* Error Banner */}\n      {error && (\n        <div className=\"bg-red-50 border border-red-200 rounded-lg p-4 flex items-center space-x-3\">\n          <svg\n            xmlns=\"http://www.w3.org/2000/svg\"\n            fill=\"none\"\n            viewBox=\"0 0 24 24\"\n            strokeWidth={2}\n            stroke=\"currentColor\"\n            className=\"w-5 h-5 text-red-600\"\n          >\n            <path\n              strokeLinecap=\"round\"\n              strokeLinejoin=\"round\"\n              d=\"M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z\"\n            />\n          </svg>\n          <span className=\"text-sm text-red-700\">{error}</span>\n        </div>\n      )}\n\n      {/* Search and Filters */}\n      <div className=\"bg-white rounded-lg shadow p-4\">\n        <form onSubmit={handleSearch} className=\"flex items-center gap-4\">\n          <div className=\"flex-1 relative\">\n            <svg\n              xmlns=\"http://www.w3.org/2000/svg\"\n              fill=\"none\"\n              viewBox=\"0 0 24 24\"\n              strokeWidth={1.5}\n              stroke=\"currentColor\"\n              className=\"w-5 h-5 absolute left-3 top-1/2 -translate-y-1/2 text-neutral-400\"\n            >\n              <path\n                strokeLinecap=\"round\"\n                strokeLinejoin=\"round\"\n                d=\"M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z\"\n              />\n            </svg>\n            <input\n              type=\"text\"\n              placeholder=\"Search by email or name...\"\n              value={search}\n              onChange={(e) => setSearch(e.target.value)}\n              className=\"w-full pl-10 pr-4 py-2 border border-neutral-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500\"\n            />\n          </div>\n          <select\n            value={filterActive === undefined ? \"\" : filterActive.toString()}\n            onChange={(e) =>\n              setFilterActive(\n                e.target.value === \"\" ? undefined : e.target.value === \"true\",\n              )\n            }\n            className=\"px-3 py-2 border border-neutral-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500\"\n          >\n            <option value=\"\">All Status</option>\n            <option value=\"true\">Active</option>\n            <option value=\"false\">Inactive</option>\n          </select>\n          <select\n            value={filterAdmin === undefined ? \"\" : filterAdmin.toString()}\n            onChange={(e) =>\n              setFilterAdmin(\n                e.target.value === \"\" ? undefined : e.target.value === \"true\",\n              )\n            }\n            className=\"px-3 py-2 border border-neutral-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500\"\n          >\n            <option value=\"\">All Roles</option>\n            <option value=\"true\">Admins</option>\n            <option value=\"false\">Regular</option>\n          </select>\n          <button\n            type=\"submit\"\n            className=\"px-4 py-2 bg-primary-500 text-white rounded-lg hover:bg-primary-600 transition-colors\"\n          >\n            Search\n          </button>\n        </form>\n      </div>\n\n      {/* Users Table */}\n      <div className=\"bg-white rounded-lg shadow overflow-hidden\">\n        <table className=\"w-full\">\n          <thead className=\"bg-neutral-50 border-b border-neutral-200\">\n            <tr>\n              <th className=\"px-6 py-3 text-left text-xs font-medium text-neutral-600 uppercase\">\n                User\n              </th>\n              <th className=\"px-6 py-3 text-left text-xs font-medium text-neutral-600 uppercase\">\n                Role\n              </th>\n              <th className=\"px-6 py-3 text-left text-xs font-medium text-neutral-600 uppercase\">\n                Status\n              </th>\n              <th className=\"px-6 py-3 text-left text-xs font-medium text-neutral-600 uppercase\">\n                Created\n              </th>\n              <th className=\"px-6 py-3 text-left text-xs font-medium text-neutral-600 uppercase\">\n                Last Login\n              </th>\n              <th className=\"px-6 py-3 text-right text-xs font-medium text-neutral-600 uppercase\">\n                Actions\n              </th>\n            </tr>\n          </thead>\n          <tbody className=\"divide-y divide-neutral-200\">\n            {users.length === 0 ? (\n              <tr>\n                <td\n                  colSpan={6}\n                  className=\"px-6 py-12 text-center text-neutral-500\"\n                >\n                  No users found\n                </td>\n              </tr>\n            ) : (\n              users.map((user) => (\n                <tr key={user.id} className=\"hover:bg-neutral-50\">\n                  <td className=\"px-6 py-4\">\n                    <div>\n                      <p className=\"text-sm font-medium text-neutral-900\">\n                        {user.full_name || \"—\"}\n                      </p>\n                      <p className=\"text-xs text-neutral-500\">{user.email}</p>\n                    </div>\n                  </td>\n                  <td className=\"px-6 py-4\">\n                    <span\n                      className={`px-2 py-1 text-xs font-medium rounded-full ${\n                        user.is_admin\n                          ? \"bg-purple-100 text-purple-700\"\n                          : \"bg-neutral-100 text-neutral-700\"\n                      }`}\n                    >\n                      {user.is_admin ? \"Admin\" : \"User\"}\n                    </span>\n                  </td>\n                  <td className=\"px-6 py-4\">\n                    <span\n                      className={`px-2 py-1 text-xs font-medium rounded-full ${\n                        user.is_active\n                          ? \"bg-green-100 text-green-700\"\n                          : \"bg-red-100 text-red-700\"\n                      }`}\n                    >\n                      {user.is_active ? \"Active\" : \"Inactive\"}\n                    </span>\n                  </td>\n                  <td className=\"px-6 py-4 text-sm text-neutral-600\">\n                    {user.created_at\n                      ? new Date(user.created_at).toLocaleDateString()\n                      : \"—\"}\n                  </td>\n                  <td className=\"px-6 py-4 text-sm text-neutral-600\">\n                    {user.last_login\n                      ? new Date(user.last_login).toLocaleDateString()\n                      : \"Never\"}\n                  </td>\n                  <td className=\"px-6 py-4 text-right space-x-2\">\n                    <button\n                      onClick={() => handleEdit(user)}\n                      className=\"text-sm text-primary-600 hover:text-primary-700 font-medium\"\n                    >\n                      Edit\n                    </button>\n                    <button\n                      onClick={() => handleDelete(user.id, user.email)}\n                      className=\"text-sm text-red-600 hover:text-red-700 font-medium\"\n                    >\n                      Deactivate\n                    </button>\n                  </td>\n                </tr>\n              ))\n            )}\n          </tbody>\n        </table>\n\n        {/* Pagination */}\n        {totalPages > 1 && (\n          <div className=\"px-6 py-4 border-t border-neutral-200 flex items-center justify-between\">\n            <p className=\"text-sm text-neutral-600\">\n              Showing {offset + 1} to {Math.min(offset + limit, total)} of{\" \"}\n              {total} users\n            </p>\n            <div className=\"flex items-center space-x-2\">\n              <button\n                onClick={() => setOffset(Math.max(0, offset - limit))}\n                disabled={offset === 0}\n                className=\"px-3 py-1 text-sm border border-neutral-300 rounded hover:bg-neutral-50 disabled:opacity-50 disabled:cursor-not-allowed\"\n              >\n                Previous\n              </button>\n              <span className=\"text-sm text-neutral-600\">\n                Page {currentPage} of {totalPages}\n              </span>\n              <button\n                onClick={() => setOffset(offset + limit)}\n                disabled={offset + limit >= total}\n                className=\"px-3 py-1 text-sm border border-neutral-300 rounded hover:bg-neutral-50 disabled:opacity-50 disabled:cursor-not-allowed\"\n              >\n                Next\n              </button>\n            </div>\n          </div>\n        )}\n      </div>\n\n      {/* Edit Modal */}\n      {editingUser && (\n        <div className=\"fixed inset-0 bg-black/50 flex items-center justify-center z-50\">\n          <div className=\"bg-white rounded-lg shadow-xl max-w-md w-full mx-4 p-6\">\n            <h3 className=\"text-lg font-semibold text-neutral-900 mb-4\">\n              Edit User\n            </h3>\n            <div className=\"space-y-4\">\n              <div>\n                <label className=\"block text-sm font-medium text-neutral-700 mb-1\">\n                  Email\n                </label>\n                <input\n                  type=\"email\"\n                  value={editingUser.email}\n                  onChange={(e) =>\n                    setEditingUser({ ...editingUser, email: e.target.value })\n                  }\n                  className=\"w-full px-3 py-2 border border-neutral-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500\"\n                />\n              </div>\n              <div>\n                <label className=\"block text-sm font-medium text-neutral-700 mb-1\">\n                  Full Name\n                </label>\n                <input\n                  type=\"text\"\n                  value={editingUser.full_name}\n                  onChange={(e) =>\n                    setEditingUser({\n                      ...editingUser,\n                      full_name: e.target.value,\n                    })\n                  }\n                  className=\"w-full px-3 py-2 border border-neutral-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500\"\n                />\n              </div>\n              <div className=\"flex items-center space-x-6\">\n                <label className=\"flex items-center space-x-2 cursor-pointer\">\n                  <input\n                    type=\"checkbox\"\n                    checked={editingUser.is_admin}\n                    onChange={(e) =>\n                      setEditingUser({\n                        ...editingUser,\n                        is_admin: e.target.checked,\n                      })\n                    }\n                    className=\"w-4 h-4 rounded border-neutral-300 text-primary-600 focus:ring-primary-500\"\n                  />\n                  <span className=\"text-sm text-neutral-700\">Admin</span>\n                </label>\n                <label className=\"flex items-center space-x-2 cursor-pointer\">\n                  <input\n                    type=\"checkbox\"\n                    checked={editingUser.is_active}\n                    onChange={(e) =>\n                      setEditingUser({\n                        ...editingUser,\n                        is_active: e.target.checked,\n                      })\n                    }\n                    className=\"w-4 h-4 rounded border-neutral-300 text-primary-600 focus:ring-primary-500\"\n                  />\n                  <span className=\"text-sm text-neutral-700\">Active</span>\n                </label>\n              </div>\n            </div>\n            <div className=\"mt-6 flex justify-end space-x-3\">\n              <button\n                onClick={() => setEditingUser(null)}\n                className=\"px-4 py-2 text-sm font-medium text-neutral-700 hover:bg-neutral-100 rounded-lg transition-colors\"\n              >\n                Cancel\n              </button>\n              <button\n                onClick={handleSave}\n                disabled={isSaving}\n                className=\"px-4 py-2 text-sm font-medium text-white bg-primary-500 hover:bg-primary-600 rounded-lg transition-colors disabled:opacity-50\"\n              >\n                {isSaving ? \"Saving...\" : \"Save Changes\"}\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n"
}

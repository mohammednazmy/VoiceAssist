{
  "path": "services/api-gateway/app/services/system_key_service.py",
  "language": "python",
  "size": 7862,
  "last_modified": "2025-12-04T11:27:00.287Z",
  "lines": 228,
  "content": "\"\"\"\nSystem API Key Service for managing external service credentials.\n\nProvides encrypted storage for system API keys (OpenAI, PubMed, etc.)\nwith database override capability over environment variables.\n\"\"\"\n\nimport base64\nfrom datetime import datetime, timezone\nfrom typing import Dict, List, Optional\nfrom uuid import UUID\n\nfrom app.core.config import settings\nfrom app.models.system_api_key import SystemAPIKey\nfrom cryptography.fernet import Fernet\nfrom sqlalchemy.orm import Session\n\n# Mapping of integration_id to config key name\nINTEGRATION_KEY_MAP: Dict[str, str] = {\n    \"openai\": \"OPENAI_API_KEY\",\n    \"google_ai\": \"GOOGLE_STUDIO_API_KEY\",\n    \"deepseek\": \"DEEPSEEK_API_KEY\",\n    \"local_llm\": \"LOCAL_LLM_API_KEY\",\n    \"elevenlabs\": \"ELEVENLABS_API_KEY\",\n    \"deepgram\": \"DEEPGRAM_API_KEY\",\n    \"openevidence\": \"OPENEVIDENCE_API_KEY\",\n    \"pubmed\": \"PUBMED_API_KEY\",\n    \"google_oauth\": \"GOOGLE_CLIENT_SECRET\",\n    \"microsoft_oauth\": \"MICROSOFT_CLIENT_SECRET\",\n    \"sentry\": \"SENTRY_DSN\",\n}\n\n\nclass SystemKeyService:\n    \"\"\"\n    Service for managing system API keys with database overrides.\n\n    Keys are encrypted at rest using Fernet symmetric encryption.\n    The database can override environment variables for dynamic updates.\n    \"\"\"\n\n    def __init__(self):\n        \"\"\"Initialize the service with encryption key.\"\"\"\n        # Use SECRET_KEY for encrypting API keys at rest\n        key_bytes = settings.SECRET_KEY.encode()[:32].ljust(32, b\"0\")\n        self.cipher = Fernet(base64.urlsafe_b64encode(key_bytes))\n\n    def encrypt_value(self, value: str) -> str:\n        \"\"\"Encrypt a value for database storage.\"\"\"\n        return self.cipher.encrypt(value.encode()).decode()\n\n    def decrypt_value(self, encrypted_value: str) -> str:\n        \"\"\"Decrypt a value from database storage.\"\"\"\n        return self.cipher.decrypt(encrypted_value.encode()).decode()\n\n    def get_env_value(self, integration_id: str) -> Optional[str]:\n        \"\"\"Get the value from environment variable.\"\"\"\n        key_name = INTEGRATION_KEY_MAP.get(integration_id)\n        if not key_name:\n            return None\n        return getattr(settings, key_name, None)\n\n    def get_key(self, db: Session, integration_id: str) -> Optional[str]:\n        \"\"\"\n        Get the effective API key value.\n\n        Returns DB override if set, otherwise falls back to .env value.\n        \"\"\"\n        # Check for DB override first\n        record = (\n            db.query(SystemAPIKey)\n            .filter(\n                SystemAPIKey.integration_id == integration_id,\n                SystemAPIKey.is_override.is_(True),\n            )\n            .first()\n        )\n\n        if record and record.encrypted_value:\n            try:\n                return self.decrypt_value(record.encrypted_value)\n            except Exception:\n                # If decryption fails, fall back to env\n                pass\n\n        # Fall back to environment variable\n        return self.get_env_value(integration_id)\n\n    def set_key(\n        self,\n        db: Session,\n        integration_id: str,\n        value: str,\n        user_id: UUID,\n    ) -> SystemAPIKey:\n        \"\"\"\n        Set/update an API key in the database.\n\n        This creates a DB override for the environment variable.\n        \"\"\"\n        key_name = INTEGRATION_KEY_MAP.get(integration_id, integration_id.upper() + \"_API_KEY\")\n        encrypted_value = self.encrypt_value(value)\n\n        # Check if record exists\n        record = db.query(SystemAPIKey).filter(SystemAPIKey.integration_id == integration_id).first()\n\n        if record:\n            record.encrypted_value = encrypted_value\n            record.is_override = True\n            record.updated_by = user_id\n            record.updated_at = datetime.now(timezone.utc)\n            record.validation_status = \"unknown\"\n            record.last_validated_at = None\n        else:\n            record = SystemAPIKey(\n                integration_id=integration_id,\n                key_name=key_name,\n                encrypted_value=encrypted_value,\n                is_override=True,\n                updated_by=user_id,\n            )\n            db.add(record)\n\n        db.commit()\n        db.refresh(record)\n        return record\n\n    def clear_override(self, db: Session, integration_id: str) -> bool:\n        \"\"\"\n        Clear the DB override and revert to .env value.\n\n        Returns True if override was cleared.\n        \"\"\"\n        record = db.query(SystemAPIKey).filter(SystemAPIKey.integration_id == integration_id).first()\n\n        if record:\n            record.encrypted_value = None\n            record.is_override = False\n            record.validation_status = None\n            record.last_validated_at = None\n            db.commit()\n            return True\n\n        return False\n\n    def update_validation_status(\n        self,\n        db: Session,\n        integration_id: str,\n        status: str,\n    ) -> None:\n        \"\"\"Update the validation status of a key.\"\"\"\n        record = db.query(SystemAPIKey).filter(SystemAPIKey.integration_id == integration_id).first()\n\n        if record:\n            record.validation_status = status\n            record.last_validated_at = datetime.now(timezone.utc)\n            db.commit()\n\n    def get_key_info(self, db: Session, integration_id: str) -> dict:\n        \"\"\"\n        Get information about a key without exposing the value.\n\n        Returns configuration status and masked preview.\n        \"\"\"\n        key_name = INTEGRATION_KEY_MAP.get(integration_id)\n        env_value = self.get_env_value(integration_id) if key_name else None\n\n        record = db.query(SystemAPIKey).filter(SystemAPIKey.integration_id == integration_id).first()\n\n        # Determine source and configure status\n        if record and record.is_override and record.encrypted_value:\n            try:\n                value = self.decrypt_value(record.encrypted_value)\n                source = \"database\"\n                is_configured = True\n                masked_value = self._mask_value(value)\n            except Exception:\n                source = \"database_error\"\n                is_configured = False\n                masked_value = None\n        elif env_value:\n            source = \"environment\"\n            is_configured = True\n            masked_value = self._mask_value(env_value)\n        else:\n            source = \"not_configured\"\n            is_configured = False\n            masked_value = None\n\n        return {\n            \"integration_id\": integration_id,\n            \"key_name\": key_name or f\"{integration_id.upper()}_API_KEY\",\n            \"is_configured\": is_configured,\n            \"source\": source,\n            \"masked_value\": masked_value,\n            \"is_override\": record.is_override if record else False,\n            \"validation_status\": record.validation_status if record else None,\n            \"last_validated_at\": (\n                record.last_validated_at.isoformat() if record and record.last_validated_at else None\n            ),\n            \"updated_at\": record.updated_at.isoformat() if record else None,\n        }\n\n    def list_all_keys(self, db: Session) -> List[dict]:\n        \"\"\"Get info for all known integrations.\"\"\"\n        result = []\n        for integration_id in INTEGRATION_KEY_MAP.keys():\n            result.append(self.get_key_info(db, integration_id))\n        return result\n\n    def _mask_value(self, value: str) -> str:\n        \"\"\"Mask a value for safe display (show first 4 and last 4 chars).\"\"\"\n        if not value:\n            return None\n        if len(value) <= 8:\n            return \"*\" * len(value)\n        return f\"{value[:4]}{'*' * (len(value) - 8)}{value[-4:]}\"\n\n\n# Global instance\nsystem_key_service = SystemKeyService()\n\n\ndef get_system_key(db: Session, integration_id: str) -> Optional[str]:\n    \"\"\"Convenience function to get a system key value.\"\"\"\n    return system_key_service.get_key(db, integration_id)\n"
}

{
  "path": "services/api-gateway/app/services/voice_command_service.py",
  "language": "python",
  "size": 26821,
  "last_modified": "2025-12-04T12:32:40.272Z",
  "lines": 736,
  "content": "\"\"\"\nVoice Command Service - Hands-free Dictation Control\n\nPhase 8: Voice command recognition and execution for medical dictation.\n\nSupports command categories:\n- Navigation: \"go to subjective\", \"next section\", \"previous section\"\n- Formatting: \"new paragraph\", \"bullet point\", \"number one/two/three\"\n- Editing: \"delete that\", \"scratch that\", \"undo\", \"read that back\"\n- Clinical: \"check interactions\", \"what's the dosing for\", \"show labs\"\n- Control: \"start dictation\", \"pause\", \"stop dictation\", \"save note\"\n\nCommands are detected from transcribed speech and executed on the active\ndictation session.\n\"\"\"\n\nimport re\nfrom dataclasses import dataclass, field\nfrom enum import Enum\nfrom typing import Dict, List, Optional, Tuple\n\nfrom app.core.logging import get_logger\nfrom app.services.dictation_service import DictationSession, NoteSection\n\nlogger = get_logger(__name__)\n\n\n# ==============================================================================\n# Enums\n# ==============================================================================\n\n\nclass CommandCategory(str, Enum):\n    \"\"\"Categories of voice commands.\"\"\"\n\n    NAVIGATION = \"navigation\"\n    FORMATTING = \"formatting\"\n    EDITING = \"editing\"\n    CLINICAL = \"clinical\"\n    CONTROL = \"control\"\n\n\nclass CommandType(str, Enum):\n    \"\"\"Types of voice commands.\"\"\"\n\n    # Navigation\n    GO_TO_SECTION = \"go_to_section\"\n    NEXT_SECTION = \"next_section\"\n    PREVIOUS_SECTION = \"previous_section\"\n\n    # Formatting\n    NEW_PARAGRAPH = \"new_paragraph\"\n    NEW_LINE = \"new_line\"\n    BULLET_POINT = \"bullet_point\"\n    NUMBERED_ITEM = \"numbered_item\"\n    PERIOD = \"period\"\n    COMMA = \"comma\"\n    COLON = \"colon\"\n    SEMICOLON = \"semicolon\"\n\n    # Editing\n    DELETE_LAST = \"delete_last\"\n    SCRATCH_THAT = \"scratch_that\"\n    UNDO = \"undo\"\n    READ_BACK = \"read_back\"\n    CLEAR_SECTION = \"clear_section\"\n\n    # Clinical\n    CHECK_INTERACTIONS = \"check_interactions\"\n    DOSING_INFO = \"dosing_info\"\n    SHOW_LABS = \"show_labs\"\n    SHOW_MEDICATIONS = \"show_medications\"\n    SHOW_VITALS = \"show_vitals\"\n\n    # Control\n    START_DICTATION = \"start_dictation\"\n    PAUSE_DICTATION = \"pause_dictation\"\n    RESUME_DICTATION = \"resume_dictation\"\n    STOP_DICTATION = \"stop_dictation\"\n    SAVE_NOTE = \"save_note\"\n\n\n# ==============================================================================\n# Data Classes\n# ==============================================================================\n\n\n@dataclass\nclass CommandPattern:\n    \"\"\"A voice command pattern with its regex and metadata.\"\"\"\n\n    command_type: CommandType\n    category: CommandCategory\n    patterns: List[str]  # Regex patterns\n    description: str\n    example: str\n    params: Dict[str, str] = field(default_factory=dict)  # Named groups to extract\n\n\n@dataclass\nclass ParsedCommand:\n    \"\"\"Result of parsing a voice command from text.\"\"\"\n\n    command_type: CommandType\n    category: CommandCategory\n    matched_text: str\n    params: Dict[str, str]\n    confidence: float\n    remaining_text: str  # Text after removing the command\n\n\n@dataclass\nclass CommandResult:\n    \"\"\"Result of executing a voice command.\"\"\"\n\n    success: bool\n    command_type: CommandType\n    message: str\n    data: Dict = field(default_factory=dict)\n\n\n# ==============================================================================\n# Voice Command Service\n# ==============================================================================\n\n\nclass VoiceCommandService:\n    \"\"\"\n    Service for detecting and executing voice commands in dictation.\n\n    Usage:\n        service = VoiceCommandService()\n\n        # Parse text for commands\n        result = service.parse_command(\"go to subjective section\")\n        if result:\n            # Execute the command\n            exec_result = await service.execute_command(result, dictation_session)\n\n        # Get available commands\n        commands = service.get_available_commands()\n    \"\"\"\n\n    # Section name mappings\n    SECTION_NAMES = {\n        # SOAP sections\n        \"subjective\": NoteSection.SUBJECTIVE,\n        \"subject\": NoteSection.SUBJECTIVE,\n        \"s\": NoteSection.SUBJECTIVE,\n        \"objective\": NoteSection.OBJECTIVE,\n        \"object\": NoteSection.OBJECTIVE,\n        \"o\": NoteSection.OBJECTIVE,\n        \"assessment\": NoteSection.ASSESSMENT,\n        \"assess\": NoteSection.ASSESSMENT,\n        \"a\": NoteSection.ASSESSMENT,\n        \"plan\": NoteSection.PLAN,\n        \"p\": NoteSection.PLAN,\n        # H&P sections\n        \"chief complaint\": NoteSection.CHIEF_COMPLAINT,\n        \"cc\": NoteSection.CHIEF_COMPLAINT,\n        \"hpi\": NoteSection.HPI,\n        \"history of present illness\": NoteSection.HPI,\n        \"history present illness\": NoteSection.HPI,\n        \"past medical history\": NoteSection.PMH,\n        \"pmh\": NoteSection.PMH,\n        \"medications\": NoteSection.MEDICATIONS,\n        \"meds\": NoteSection.MEDICATIONS,\n        \"allergies\": NoteSection.ALLERGIES,\n        \"social history\": NoteSection.SOCIAL_HISTORY,\n        \"social\": NoteSection.SOCIAL_HISTORY,\n        \"family history\": NoteSection.FAMILY_HISTORY,\n        \"family\": NoteSection.FAMILY_HISTORY,\n        \"review of systems\": NoteSection.ROS,\n        \"ros\": NoteSection.ROS,\n        \"physical exam\": NoteSection.PHYSICAL_EXAM,\n        \"exam\": NoteSection.PHYSICAL_EXAM,\n        \"pe\": NoteSection.PHYSICAL_EXAM,\n        \"labs\": NoteSection.LABS,\n        \"imaging\": NoteSection.LABS,\n        \"labs and imaging\": NoteSection.LABS,\n        \"impression\": NoteSection.IMPRESSION,\n    }\n\n    # Number words for numbered lists\n    NUMBER_WORDS = {\n        \"one\": \"1\",\n        \"two\": \"2\",\n        \"three\": \"3\",\n        \"four\": \"4\",\n        \"five\": \"5\",\n        \"six\": \"6\",\n        \"seven\": \"7\",\n        \"eight\": \"8\",\n        \"nine\": \"9\",\n        \"ten\": \"10\",\n    }\n\n    def __init__(self):\n        self._patterns = self._build_patterns()\n        self._compiled_patterns: List[Tuple[re.Pattern, CommandPattern]] = []\n        self._compile_patterns()\n\n    def _build_patterns(self) -> List[CommandPattern]:\n        \"\"\"Build the list of command patterns.\"\"\"\n        return [\n            # Navigation Commands\n            CommandPattern(\n                command_type=CommandType.GO_TO_SECTION,\n                category=CommandCategory.NAVIGATION,\n                patterns=[\n                    r\"\\b(?:go to|move to|jump to|switch to|navigate to)\\s+(?:the\\s+)?(?P<section>\\w+(?:\\s+\\w+)?)\\s*(?:section)?\\b\",\n                    r\"\\b(?P<section>subjective|objective|assessment|plan)\\s+section\\b\",\n                ],\n                description=\"Navigate to a specific section\",\n                example=\"go to subjective\",\n            ),\n            CommandPattern(\n                command_type=CommandType.NEXT_SECTION,\n                category=CommandCategory.NAVIGATION,\n                patterns=[\n                    r\"\\b(?:next section|go next|move next|next)\\b\",\n                ],\n                description=\"Move to the next section\",\n                example=\"next section\",\n            ),\n            CommandPattern(\n                command_type=CommandType.PREVIOUS_SECTION,\n                category=CommandCategory.NAVIGATION,\n                patterns=[\n                    r\"\\b(?:previous section|go back|go previous|back|previous)\\b\",\n                ],\n                description=\"Move to the previous section\",\n                example=\"previous section\",\n            ),\n            # Formatting Commands\n            CommandPattern(\n                command_type=CommandType.NEW_PARAGRAPH,\n                category=CommandCategory.FORMATTING,\n                patterns=[\n                    r\"\\b(?:new paragraph|paragraph|next paragraph)\\b\",\n                ],\n                description=\"Start a new paragraph\",\n                example=\"new paragraph\",\n            ),\n            CommandPattern(\n                command_type=CommandType.NEW_LINE,\n                category=CommandCategory.FORMATTING,\n                patterns=[\n                    r\"\\b(?:new line|line break|enter|next line)\\b\",\n                ],\n                description=\"Insert a line break\",\n                example=\"new line\",\n            ),\n            CommandPattern(\n                command_type=CommandType.BULLET_POINT,\n                category=CommandCategory.FORMATTING,\n                patterns=[\n                    r\"\\b(?:bullet point|bullet|add bullet|new bullet)\\b\",\n                ],\n                description=\"Add a bullet point\",\n                example=\"bullet point\",\n            ),\n            CommandPattern(\n                command_type=CommandType.NUMBERED_ITEM,\n                category=CommandCategory.FORMATTING,\n                patterns=[\n                    r\"\\b(?:number\\s+(?P<number>one|two|three|four|five|six|seven|eight|nine|ten|\\d+))\\b\",\n                    r\"\\b(?:numbered item|item number|add number)\\b\",\n                ],\n                description=\"Add a numbered list item\",\n                example=\"number one\",\n            ),\n            CommandPattern(\n                command_type=CommandType.PERIOD,\n                category=CommandCategory.FORMATTING,\n                patterns=[\n                    r\"\\b(?:period|full stop|end sentence)\\b\",\n                ],\n                description=\"Insert a period\",\n                example=\"period\",\n            ),\n            CommandPattern(\n                command_type=CommandType.COMMA,\n                category=CommandCategory.FORMATTING,\n                patterns=[\n                    r\"\\bcomma\\b\",\n                ],\n                description=\"Insert a comma\",\n                example=\"comma\",\n            ),\n            CommandPattern(\n                command_type=CommandType.COLON,\n                category=CommandCategory.FORMATTING,\n                patterns=[\n                    r\"\\bcolon\\b\",\n                ],\n                description=\"Insert a colon\",\n                example=\"colon\",\n            ),\n            # Editing Commands\n            CommandPattern(\n                command_type=CommandType.DELETE_LAST,\n                category=CommandCategory.EDITING,\n                patterns=[\n                    r\"\\b(?:delete that|delete last|remove that|remove last)\\b\",\n                ],\n                description=\"Delete the last phrase\",\n                example=\"delete that\",\n            ),\n            CommandPattern(\n                command_type=CommandType.SCRATCH_THAT,\n                category=CommandCategory.EDITING,\n                patterns=[\n                    r\"\\b(?:scratch that|never mind|disregard|cancel that)\\b\",\n                ],\n                description=\"Remove the last dictated text\",\n                example=\"scratch that\",\n            ),\n            CommandPattern(\n                command_type=CommandType.UNDO,\n                category=CommandCategory.EDITING,\n                patterns=[\n                    r\"\\bundo\\b\",\n                ],\n                description=\"Undo the last action\",\n                example=\"undo\",\n            ),\n            CommandPattern(\n                command_type=CommandType.READ_BACK,\n                category=CommandCategory.EDITING,\n                patterns=[\n                    r\"\\b(?:read that back|read back|read it back|what did i say)\\b\",\n                ],\n                description=\"Read back the current section\",\n                example=\"read that back\",\n            ),\n            CommandPattern(\n                command_type=CommandType.CLEAR_SECTION,\n                category=CommandCategory.EDITING,\n                patterns=[\n                    r\"\\b(?:clear section|clear all|erase section|start over)\\b\",\n                ],\n                description=\"Clear the current section\",\n                example=\"clear section\",\n            ),\n            # Clinical Commands\n            CommandPattern(\n                command_type=CommandType.CHECK_INTERACTIONS,\n                category=CommandCategory.CLINICAL,\n                patterns=[\n                    r\"\\b(?:check interactions|drug interactions|interactions for|check for interactions)\\b\",\n                ],\n                description=\"Check drug interactions\",\n                example=\"check interactions\",\n            ),\n            CommandPattern(\n                command_type=CommandType.DOSING_INFO,\n                category=CommandCategory.CLINICAL,\n                patterns=[\n                    r\"\\b(?:what'?s the dosing for|dosing for|dose of|dosage of)\\s+(?P<medication>\\w+(?:\\s+\\w+)?)\\b\",\n                ],\n                description=\"Get dosing information for a medication\",\n                example=\"what's the dosing for metformin\",\n            ),\n            CommandPattern(\n                command_type=CommandType.SHOW_LABS,\n                category=CommandCategory.CLINICAL,\n                patterns=[\n                    r\"\\b(?:show labs|show lab results|display labs|what are the labs)\\b\",\n                ],\n                description=\"Show patient lab results\",\n                example=\"show labs\",\n            ),\n            CommandPattern(\n                command_type=CommandType.SHOW_MEDICATIONS,\n                category=CommandCategory.CLINICAL,\n                patterns=[\n                    r\"\\b(?:show medications|show meds|display medications|what medications|current meds)\\b\",\n                ],\n                description=\"Show current medications\",\n                example=\"show medications\",\n            ),\n            CommandPattern(\n                command_type=CommandType.SHOW_VITALS,\n                category=CommandCategory.CLINICAL,\n                patterns=[\n                    r\"\\b(?:show vitals|vital signs|display vitals|what are the vitals)\\b\",\n                ],\n                description=\"Show vital signs\",\n                example=\"show vitals\",\n            ),\n            # Control Commands\n            CommandPattern(\n                command_type=CommandType.START_DICTATION,\n                category=CommandCategory.CONTROL,\n                patterns=[\n                    r\"\\b(?:start dictation|begin dictation|start recording|let'?s begin)\\b\",\n                ],\n                description=\"Start dictation mode\",\n                example=\"start dictation\",\n            ),\n            CommandPattern(\n                command_type=CommandType.PAUSE_DICTATION,\n                category=CommandCategory.CONTROL,\n                patterns=[\n                    r\"\\b(?:pause dictation|pause|hold on|wait a moment)\\b\",\n                ],\n                description=\"Pause dictation\",\n                example=\"pause\",\n            ),\n            CommandPattern(\n                command_type=CommandType.RESUME_DICTATION,\n                category=CommandCategory.CONTROL,\n                patterns=[\n                    r\"\\b(?:resume dictation|resume|continue dictation|continue|go on)\\b\",\n                ],\n                description=\"Resume dictation\",\n                example=\"resume\",\n            ),\n            CommandPattern(\n                command_type=CommandType.STOP_DICTATION,\n                category=CommandCategory.CONTROL,\n                patterns=[\n                    r\"\\b(?:stop dictation|stop recording|end dictation|finish dictation|that'?s all)\\b\",\n                ],\n                description=\"Stop dictation\",\n                example=\"stop dictation\",\n            ),\n            CommandPattern(\n                command_type=CommandType.SAVE_NOTE,\n                category=CommandCategory.CONTROL,\n                patterns=[\n                    r\"\\b(?:save note|save this|save the note|save it)\\b\",\n                ],\n                description=\"Save the current note\",\n                example=\"save note\",\n            ),\n        ]\n\n    def _compile_patterns(self) -> None:\n        \"\"\"Compile regex patterns for efficient matching.\"\"\"\n        for pattern in self._patterns:\n            for regex_str in pattern.patterns:\n                try:\n                    compiled = re.compile(regex_str, re.IGNORECASE)\n                    self._compiled_patterns.append((compiled, pattern))\n                except re.error as e:\n                    logger.error(f\"Invalid regex pattern: {regex_str} - {e}\")\n\n    def parse_command(self, text: str) -> Optional[ParsedCommand]:\n        \"\"\"\n        Parse text to detect a voice command.\n\n        Args:\n            text: Transcribed text to parse\n\n        Returns:\n            ParsedCommand if a command was detected, None otherwise\n        \"\"\"\n        text_lower = text.lower().strip()\n\n        for compiled_regex, pattern in self._compiled_patterns:\n            match = compiled_regex.search(text_lower)\n            if match:\n                # Extract parameters from named groups\n                params = {k: v for k, v in match.groupdict().items() if v}\n\n                # Calculate remaining text (everything not matching the command)\n                remaining = text[: match.start()] + text[match.end() :]\n                remaining = remaining.strip()\n\n                return ParsedCommand(\n                    command_type=pattern.command_type,\n                    category=pattern.category,\n                    matched_text=match.group(0),\n                    params=params,\n                    confidence=1.0,  # Exact match\n                    remaining_text=remaining,\n                )\n\n        return None\n\n    async def execute_command(\n        self,\n        command: ParsedCommand,\n        session: DictationSession,\n    ) -> CommandResult:\n        \"\"\"\n        Execute a parsed voice command on a dictation session.\n\n        Args:\n            command: The parsed command to execute\n            session: The dictation session to operate on\n\n        Returns:\n            CommandResult with execution status\n        \"\"\"\n        try:\n            command_type = command.command_type\n\n            # Navigation commands\n            if command_type == CommandType.GO_TO_SECTION:\n                section_name = command.params.get(\"section\", \"\").lower()\n                section = self.SECTION_NAMES.get(section_name)\n                if section:\n                    success = await session.go_to_section(section)\n                    return CommandResult(\n                        success=success,\n                        command_type=command_type,\n                        message=(f\"Moved to {section.value}\" if success else f\"Section '{section_name}' not available\"),\n                        data={\"section\": section.value if success else None},\n                    )\n                return CommandResult(\n                    success=False,\n                    command_type=command_type,\n                    message=f\"Unknown section: {section_name}\",\n                )\n\n            elif command_type == CommandType.NEXT_SECTION:\n                success = await session.next_section()\n                return CommandResult(\n                    success=success,\n                    command_type=command_type,\n                    message=(\"Moved to next section\" if success else \"Already at last section\"),\n                    data={\"section\": session.current_section.value},\n                )\n\n            elif command_type == CommandType.PREVIOUS_SECTION:\n                success = await session.previous_section()\n                return CommandResult(\n                    success=success,\n                    command_type=command_type,\n                    message=(\"Moved to previous section\" if success else \"Already at first section\"),\n                    data={\"section\": session.current_section.value},\n                )\n\n            # Formatting commands\n            elif command_type == CommandType.NEW_PARAGRAPH:\n                await session.insert_text(\"\\n\\n\")\n                return CommandResult(\n                    success=True,\n                    command_type=command_type,\n                    message=\"New paragraph\",\n                )\n\n            elif command_type == CommandType.NEW_LINE:\n                await session.insert_text(\"\\n\")\n                return CommandResult(\n                    success=True,\n                    command_type=command_type,\n                    message=\"New line\",\n                )\n\n            elif command_type == CommandType.BULLET_POINT:\n                await session.insert_text(\"\\n- \")\n                return CommandResult(\n                    success=True,\n                    command_type=command_type,\n                    message=\"Bullet point added\",\n                )\n\n            elif command_type == CommandType.NUMBERED_ITEM:\n                number = command.params.get(\"number\", \"1\")\n                # Convert number words to digits\n                if number in self.NUMBER_WORDS:\n                    number = self.NUMBER_WORDS[number]\n                await session.insert_text(f\"\\n{number}. \")\n                return CommandResult(\n                    success=True,\n                    command_type=command_type,\n                    message=f\"Number {number} added\",\n                )\n\n            elif command_type == CommandType.PERIOD:\n                await session.insert_text(\". \")\n                return CommandResult(\n                    success=True,\n                    command_type=command_type,\n                    message=\"Period added\",\n                )\n\n            elif command_type == CommandType.COMMA:\n                await session.insert_text(\", \")\n                return CommandResult(\n                    success=True,\n                    command_type=command_type,\n                    message=\"Comma added\",\n                )\n\n            elif command_type == CommandType.COLON:\n                await session.insert_text(\": \")\n                return CommandResult(\n                    success=True,\n                    command_type=command_type,\n                    message=\"Colon added\",\n                )\n\n            # Editing commands\n            elif command_type == CommandType.DELETE_LAST:\n                success = await session.delete_last()\n                return CommandResult(\n                    success=success,\n                    command_type=command_type,\n                    message=\"Deleted last phrase\" if success else \"Nothing to delete\",\n                )\n\n            elif command_type == CommandType.SCRATCH_THAT:\n                success = await session.delete_last()\n                return CommandResult(\n                    success=success,\n                    command_type=command_type,\n                    message=\"Scratched that\" if success else \"Nothing to scratch\",\n                )\n\n            elif command_type == CommandType.UNDO:\n                success = await session.undo()\n                return CommandResult(\n                    success=success,\n                    command_type=command_type,\n                    message=\"Undone\" if success else \"Nothing to undo\",\n                )\n\n            elif command_type == CommandType.READ_BACK:\n                content = await session.read_back()\n                return CommandResult(\n                    success=True,\n                    command_type=command_type,\n                    message=content if content else \"This section is empty\",\n                    data={\"content\": content, \"speak\": True},\n                )\n\n            # Control commands\n            elif command_type == CommandType.START_DICTATION:\n                success = await session.start()\n                return CommandResult(\n                    success=success,\n                    command_type=command_type,\n                    message=\"Dictation started\" if success else \"Already dictating\",\n                )\n\n            elif command_type == CommandType.PAUSE_DICTATION:\n                success = await session.pause()\n                return CommandResult(\n                    success=success,\n                    command_type=command_type,\n                    message=(\"Dictation paused\" if success else \"Not currently dictating\"),\n                )\n\n            elif command_type == CommandType.RESUME_DICTATION:\n                success = await session.resume()\n                return CommandResult(\n                    success=success,\n                    command_type=command_type,\n                    message=\"Dictation resumed\" if success else \"Not paused\",\n                )\n\n            elif command_type == CommandType.STOP_DICTATION:\n                await session.stop()\n                return CommandResult(\n                    success=True,\n                    command_type=command_type,\n                    message=\"Dictation stopped\",\n                )\n\n            # Clinical commands (placeholders - to be integrated with patient context)\n            elif command_type in (\n                CommandType.CHECK_INTERACTIONS,\n                CommandType.DOSING_INFO,\n                CommandType.SHOW_LABS,\n                CommandType.SHOW_MEDICATIONS,\n                CommandType.SHOW_VITALS,\n            ):\n                return CommandResult(\n                    success=True,\n                    command_type=command_type,\n                    message=f\"Clinical command: {command_type.value}\",\n                    data={\"requires_patient_context\": True, \"params\": command.params},\n                )\n\n            else:\n                return CommandResult(\n                    success=False,\n                    command_type=command_type,\n                    message=f\"Unknown command: {command_type.value}\",\n                )\n\n        except Exception as e:\n            logger.error(f\"Error executing command {command.command_type}: {e}\")\n            return CommandResult(\n                success=False,\n                command_type=command.command_type,\n                message=f\"Error: {str(e)}\",\n            )\n\n    def get_available_commands(\n        self,\n        category: Optional[CommandCategory] = None,\n    ) -> List[Dict]:\n        \"\"\"\n        Get list of available commands.\n\n        Args:\n            category: Optional filter by category\n\n        Returns:\n            List of command information dicts\n        \"\"\"\n        commands = []\n        seen = set()\n\n        for pattern in self._patterns:\n            if pattern.command_type in seen:\n                continue\n            if category and pattern.category != category:\n                continue\n\n            commands.append(\n                {\n                    \"type\": pattern.command_type.value,\n                    \"category\": pattern.category.value,\n                    \"description\": pattern.description,\n                    \"example\": pattern.example,\n                }\n            )\n            seen.add(pattern.command_type)\n\n        return commands\n\n    def get_section_names(self) -> Dict[str, str]:\n        \"\"\"Get mapping of spoken section names to section IDs.\"\"\"\n        return {name: section.value for name, section in self.SECTION_NAMES.items()}\n\n\n# Global service instance\nvoice_command_service = VoiceCommandService()\n"
}

{
  "path": "services/api-gateway/app/api/user_api_keys.py",
  "language": "python",
  "size": 7348,
  "last_modified": "2025-12-04T11:26:48.629Z",
  "lines": 257,
  "content": "\"\"\"User API Keys API endpoints.\n\nProvides endpoints for users to manage their personal API keys for\nprogrammatic access to the VoiceAssist API.\n\nThese keys can be used as an alternative to JWT tokens for authentication.\n\"\"\"\n\nfrom typing import List, Optional\nfrom uuid import UUID\n\nfrom app.api.admin_panel import log_audit_event\nfrom app.core.api_envelope import success_response\nfrom app.core.database import get_db\nfrom app.core.dependencies import get_current_user\nfrom app.core.logging import get_logger\nfrom app.models.user import User\nfrom app.services.user_api_key_service import user_api_key_service\nfrom fastapi import APIRouter, Depends, HTTPException, status\nfrom pydantic import BaseModel, Field\nfrom sqlalchemy.orm import Session\n\nlogger = get_logger(__name__)\n\nrouter = APIRouter(prefix=\"/api/auth/api-keys\", tags=[\"api-keys\"])\n\n\n# =============================================================================\n# Request/Response Models\n# =============================================================================\n\n\nclass APIKeyCreate(BaseModel):\n    \"\"\"Request to create a new API key.\"\"\"\n\n    name: str = Field(..., min_length=1, max_length=255, description=\"Name for the API key\")\n    expires_in_days: Optional[int] = Field(\n        None,\n        ge=1,\n        le=365,\n        description=\"Days until expiration (null = never expires)\",\n    )\n\n\nclass APIKeyResponse(BaseModel):\n    \"\"\"API key information (without the actual key value).\"\"\"\n\n    id: str\n    name: str\n    key_prefix: str\n    created_at: str\n    last_used_at: Optional[str] = None\n    expires_at: Optional[str] = None\n    is_revoked: bool\n\n\nclass APIKeyCreatedResponse(APIKeyResponse):\n    \"\"\"Response when a new API key is created (includes the full key).\"\"\"\n\n    key: str  # Full key - ONLY shown once at creation\n\n\nclass APIKeyListResponse(BaseModel):\n    \"\"\"List of API keys.\"\"\"\n\n    keys: List[APIKeyResponse]\n    total: int\n\n\n# =============================================================================\n# Helper Functions\n# =============================================================================\n\n\ndef format_api_key(api_key) -> APIKeyResponse:\n    \"\"\"Convert a UserAPIKey model to APIKeyResponse.\"\"\"\n    return APIKeyResponse(\n        id=str(api_key.id),\n        name=api_key.name,\n        key_prefix=api_key.key_prefix,\n        created_at=api_key.created_at.isoformat() if api_key.created_at else None,\n        last_used_at=api_key.last_used_at.isoformat() if api_key.last_used_at else None,\n        expires_at=api_key.expires_at.isoformat() if api_key.expires_at else None,\n        is_revoked=api_key.is_revoked,\n    )\n\n\n# =============================================================================\n# Endpoints\n# =============================================================================\n\n\n@router.get(\"\", response_model=dict)\nasync def list_api_keys(\n    current_user: User = Depends(get_current_user),\n    db: Session = Depends(get_db),\n    include_revoked: bool = False,\n):\n    \"\"\"\n    List all API keys for the current user.\n\n    Returns keys without their actual values (only prefixes).\n    \"\"\"\n    keys = user_api_key_service.list_user_keys(\n        db=db,\n        user_id=current_user.id,\n        include_revoked=include_revoked,\n    )\n\n    return success_response(\n        APIKeyListResponse(\n            keys=[format_api_key(k) for k in keys],\n            total=len(keys),\n        ).model_dump()\n    )\n\n\n@router.post(\"\", response_model=dict, status_code=status.HTTP_201_CREATED)\nasync def create_api_key(\n    request: APIKeyCreate,\n    current_user: User = Depends(get_current_user),\n    db: Session = Depends(get_db),\n):\n    \"\"\"\n    Create a new API key.\n\n    IMPORTANT: The full key value is only returned once in this response.\n    Store it securely - it cannot be retrieved again.\n    \"\"\"\n    try:\n        api_key, full_key = user_api_key_service.create_key(\n            db=db,\n            user_id=current_user.id,\n            name=request.name,\n            expires_in_days=request.expires_in_days,\n        )\n\n        # Log audit event\n        log_audit_event(\n            db,\n            action=\"api_key_created\",\n            user_id=str(current_user.id),\n            user_email=current_user.email,\n            resource_type=\"user_api_key\",\n            resource_id=str(api_key.id),\n            success=True,\n            details=f\"Key name: {request.name}\",\n        )\n\n        response = APIKeyCreatedResponse(\n            id=str(api_key.id),\n            name=api_key.name,\n            key_prefix=api_key.key_prefix,\n            key=full_key,  # Only time the full key is exposed!\n            created_at=api_key.created_at.isoformat() if api_key.created_at else None,\n            last_used_at=None,\n            expires_at=api_key.expires_at.isoformat() if api_key.expires_at else None,\n            is_revoked=False,\n        )\n\n        return success_response(response.model_dump())\n\n    except Exception as e:\n        logger.error(f\"Failed to create API key: {e}\")\n        raise HTTPException(\n            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,\n            detail=\"Failed to create API key\",\n        )\n\n\n@router.delete(\"/{key_id}\", response_model=dict)\nasync def revoke_api_key(\n    key_id: UUID,\n    current_user: User = Depends(get_current_user),\n    db: Session = Depends(get_db),\n):\n    \"\"\"\n    Revoke an API key.\n\n    The key will no longer be usable for authentication.\n    \"\"\"\n    # Check if key exists and belongs to user\n    api_key = user_api_key_service.get_key_by_id(\n        db=db,\n        key_id=key_id,\n        user_id=current_user.id,\n    )\n\n    if not api_key:\n        raise HTTPException(\n            status_code=status.HTTP_404_NOT_FOUND,\n            detail=\"API key not found\",\n        )\n\n    if api_key.is_revoked:\n        raise HTTPException(\n            status_code=status.HTTP_400_BAD_REQUEST,\n            detail=\"API key is already revoked\",\n        )\n\n    success = user_api_key_service.revoke_key(\n        db=db,\n        key_id=key_id,\n        user_id=current_user.id,\n    )\n\n    if success:\n        # Log audit event\n        log_audit_event(\n            db,\n            action=\"api_key_revoked\",\n            user_id=str(current_user.id),\n            user_email=current_user.email,\n            resource_type=\"user_api_key\",\n            resource_id=str(key_id),\n            success=True,\n            details=f\"Key name: {api_key.name}\",\n        )\n\n        return success_response(\n            {\n                \"message\": \"API key revoked successfully\",\n                \"key_id\": str(key_id),\n            }\n        )\n\n    raise HTTPException(\n        status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,\n        detail=\"Failed to revoke API key\",\n    )\n\n\n@router.get(\"/{key_id}\", response_model=dict)\nasync def get_api_key(\n    key_id: UUID,\n    current_user: User = Depends(get_current_user),\n    db: Session = Depends(get_db),\n):\n    \"\"\"\n    Get details of a specific API key.\n\n    Returns key information without the actual key value.\n    \"\"\"\n    api_key = user_api_key_service.get_key_by_id(\n        db=db,\n        key_id=key_id,\n        user_id=current_user.id,\n    )\n\n    if not api_key:\n        raise HTTPException(\n            status_code=status.HTTP_404_NOT_FOUND,\n            detail=\"API key not found\",\n        )\n\n    return success_response(format_api_key(api_key).model_dump())\n"
}

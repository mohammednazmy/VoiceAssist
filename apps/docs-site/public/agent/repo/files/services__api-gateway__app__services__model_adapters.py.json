{
  "path": "services/api-gateway/app/services/model_adapters.py",
  "language": "python",
  "size": 4012,
  "last_modified": "2025-12-04T11:26:57.773Z",
  "lines": 113,
  "content": "\"\"\"Model adapter registry for specialized biomedical models.\n\nThe registry exposes configuration-driven adapters for domain-specific\nmodels (e.g., BioGPT, PubMedBERT) so the orchestrator can surface\nmodel provenance and selection metadata in responses.\n\nNOTE: Local adapters (BioGPT, PubMedBERT) are only enabled when:\n1. The adapter is explicitly enabled in config (ENABLE_*_ADAPTER=True)\n2. A local LLM endpoint is configured (LOCAL_LLM_URL is set)\n\nThis prevents attempts to call OpenAI with local model IDs.\n\"\"\"\n\nfrom __future__ import annotations\n\nfrom dataclasses import dataclass\nfrom typing import Dict, List, Optional\n\nfrom app.core.config import settings\n\n\n@dataclass\nclass ModelAdapter:\n    \"\"\"Adapter metadata for a model option.\"\"\"\n\n    key: str\n    model_id: str\n    provider: str\n    enabled: bool\n    description: str\n    specialization: Optional[str] = None\n    context_window: int = 4096\n    supports_streaming: bool = True\n    confidence: float = 0.8\n\n\nclass ModelAdapterRegistry:\n    \"\"\"Registry for configurable biomedical model adapters.\"\"\"\n\n    def __init__(\n        self,\n        pubmedbert_enabled: Optional[bool] = None,\n        biogpt_enabled: Optional[bool] = None,\n        has_local_model: Optional[bool] = None,\n    ) -> None:\n        self._adapters: Dict[str, ModelAdapter] = {}\n\n        pubmedbert_id = settings.PUBMEDBERT_MODEL_ID or \"microsoft/BiomedNLP-PubMedBERT\"\n        biogpt_id = settings.BIOGPT_MODEL_ID or \"microsoft/biogpt\"\n\n        # Local adapters require both explicit enablement AND a local LLM endpoint\n        local_available = has_local_model if has_local_model is not None else bool(settings.LOCAL_LLM_URL)\n        pubmedbert_effective = (\n            settings.ENABLE_PUBMEDBERT_ADAPTER if pubmedbert_enabled is None else pubmedbert_enabled\n        ) and local_available\n        biogpt_effective = (\n            settings.ENABLE_BIOGPT_ADAPTER if biogpt_enabled is None else biogpt_enabled\n        ) and local_available\n\n        self._adapters[\"pubmedbert\"] = ModelAdapter(\n            key=\"pubmedbert\",\n            model_id=pubmedbert_id,\n            provider=\"hf-local\",\n            enabled=pubmedbert_effective,\n            description=\"PubMedBERT encoder for biomedical literature grounding\",\n            specialization=\"research\",\n            context_window=2048,\n            supports_streaming=False,\n            confidence=0.82,\n        )\n\n        self._adapters[\"biogpt\"] = ModelAdapter(\n            key=\"biogpt\",\n            model_id=biogpt_id,\n            provider=\"hf-local\",\n            enabled=biogpt_effective,\n            description=\"BioGPT generator for clinical summarization and reasoning\",\n            specialization=\"clinical\",\n            context_window=4096,\n            supports_streaming=False,\n            confidence=0.86,\n        )\n\n        # Default cloud model entry to expose in metadata\n        self._adapters[\"default\"] = ModelAdapter(\n            key=\"default\",\n            model_id=settings.MODEL_SELECTION_DEFAULT,\n            provider=\"openai\",\n            enabled=True,\n            description=\"Default cloud model for general-purpose reasoning\",\n            specialization=\"general\",\n            context_window=8192,\n            supports_streaming=True,\n            confidence=0.75,\n        )\n\n    def available(self) -> List[ModelAdapter]:\n        \"\"\"Return all enabled adapters.\"\"\"\n\n        return [adapter for adapter in self._adapters.values() if adapter.enabled]\n\n    def get(self, key: str) -> Optional[ModelAdapter]:\n        return self._adapters.get(key)\n\n    def select_for_intent(self, intent: str) -> ModelAdapter:\n        \"\"\"Select the most appropriate adapter for a given intent.\"\"\"\n\n        if intent in {\"diagnosis\", \"treatment\", \"drug\"} and self._adapters[\"biogpt\"].enabled:\n            return self._adapters[\"biogpt\"]\n        if intent in {\"guideline\", \"summary\", \"research\"} and self._adapters[\"pubmedbert\"].enabled:\n            return self._adapters[\"pubmedbert\"]\n        return self._adapters[\"default\"]\n"
}

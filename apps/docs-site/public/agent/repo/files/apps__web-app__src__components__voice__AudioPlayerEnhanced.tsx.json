{
  "path": "apps/web-app/src/components/voice/AudioPlayerEnhanced.tsx",
  "language": "typescript",
  "size": 10995,
  "last_modified": "2025-11-27T06:53:16.477Z",
  "lines": 373,
  "content": "/**\n * Enhanced Audio Player Component\n * Features:\n * - Barge-in support (interrupt AI speech)\n * - Playback speed control\n * - Volume control\n * - Multiple audio queue management\n * - Visualization during playback\n */\n\nimport { useState, useRef, useCallback, useEffect } from \"react\";\nimport { Button } from \"@voiceassist/ui\";\n\ninterface AudioPlayerEnhancedProps {\n  audioBlob: Blob | null;\n  autoPlay?: boolean;\n  playbackSpeed?: number;\n  volume?: number;\n  onPlaybackStart?: () => void;\n  onPlaybackEnd?: () => void;\n  onBargeIn?: () => void;\n  /** Allow user to interrupt playback */\n  allowBargeIn?: boolean;\n}\n\nexport function AudioPlayerEnhanced({\n  audioBlob,\n  autoPlay = false,\n  playbackSpeed = 1.0,\n  volume = 0.8,\n  onPlaybackStart,\n  onPlaybackEnd,\n  onBargeIn,\n  allowBargeIn = true,\n}: AudioPlayerEnhancedProps) {\n  const [isPlaying, setIsPlaying] = useState(false);\n  const [duration, setDuration] = useState(0);\n  const [currentTime, setCurrentTime] = useState(0);\n  const [currentVolume, setCurrentVolume] = useState(volume);\n  const [currentSpeed, setCurrentSpeed] = useState(playbackSpeed);\n  const [showControls, setShowControls] = useState(false);\n\n  const audioRef = useRef<HTMLAudioElement | null>(null);\n  const audioUrlRef = useRef<string | null>(null);\n\n  // Create audio element when blob changes\n  useEffect(() => {\n    if (!audioBlob) {\n      // Clean up previous audio\n      if (audioRef.current) {\n        audioRef.current.pause();\n        audioRef.current = null;\n      }\n      if (audioUrlRef.current) {\n        URL.revokeObjectURL(audioUrlRef.current);\n        audioUrlRef.current = null;\n      }\n      setIsPlaying(false);\n      setCurrentTime(0);\n      setDuration(0);\n      return;\n    }\n\n    // Revoke previous URL\n    if (audioUrlRef.current) {\n      URL.revokeObjectURL(audioUrlRef.current);\n    }\n\n    // Create new audio URL\n    const url = URL.createObjectURL(audioBlob);\n    audioUrlRef.current = url;\n\n    const audio = new Audio(url);\n    audio.volume = currentVolume;\n    audio.playbackRate = currentSpeed;\n\n    audio.addEventListener(\"loadedmetadata\", () => {\n      setDuration(audio.duration);\n    });\n\n    audio.addEventListener(\"timeupdate\", () => {\n      setCurrentTime(audio.currentTime);\n    });\n\n    audio.addEventListener(\"ended\", () => {\n      setIsPlaying(false);\n      setCurrentTime(0);\n      onPlaybackEnd?.();\n    });\n\n    audio.addEventListener(\"play\", () => {\n      setIsPlaying(true);\n      onPlaybackStart?.();\n    });\n\n    audio.addEventListener(\"pause\", () => {\n      setIsPlaying(false);\n    });\n\n    audioRef.current = audio;\n\n    if (autoPlay) {\n      audio.play().catch((err) => {\n        console.error(\"Autoplay failed:\", err);\n      });\n    }\n\n    // Cleanup\n    return () => {\n      audio.pause();\n      URL.revokeObjectURL(url);\n    };\n  }, [audioBlob]); // Only depend on audioBlob\n\n  // Update audio properties when they change\n  useEffect(() => {\n    if (audioRef.current) {\n      audioRef.current.volume = currentVolume;\n    }\n  }, [currentVolume]);\n\n  useEffect(() => {\n    if (audioRef.current) {\n      audioRef.current.playbackRate = currentSpeed;\n    }\n  }, [currentSpeed]);\n\n  const togglePlayback = useCallback(() => {\n    if (!audioRef.current) return;\n\n    if (isPlaying) {\n      audioRef.current.pause();\n    } else {\n      audioRef.current.play().catch((err) => {\n        console.error(\"Playback failed:\", err);\n      });\n    }\n  }, [isPlaying]);\n\n  const handleBargeIn = useCallback(() => {\n    if (!audioRef.current || !allowBargeIn) return;\n\n    audioRef.current.pause();\n    audioRef.current.currentTime = 0;\n    setIsPlaying(false);\n    onBargeIn?.();\n  }, [allowBargeIn, onBargeIn]);\n\n  const handleSeek = useCallback(\n    (event: React.ChangeEvent<HTMLInputElement>) => {\n      if (!audioRef.current) return;\n\n      const newTime = parseFloat(event.target.value);\n      audioRef.current.currentTime = newTime;\n      setCurrentTime(newTime);\n    },\n    [],\n  );\n\n  const handleVolumeChange = useCallback(\n    (event: React.ChangeEvent<HTMLInputElement>) => {\n      const newVolume = parseFloat(event.target.value);\n      setCurrentVolume(newVolume);\n    },\n    [],\n  );\n\n  const handleSpeedChange = useCallback((newSpeed: number) => {\n    setCurrentSpeed(newSpeed);\n  }, []);\n\n  const formatTime = (seconds: number): string => {\n    const mins = Math.floor(seconds / 60);\n    const secs = Math.floor(seconds % 60);\n    return `${mins}:${secs.toString().padStart(2, \"0\")}`;\n  };\n\n  const getProgress = (): number => {\n    if (duration === 0) return 0;\n    return (currentTime / duration) * 100;\n  };\n\n  if (!audioBlob) {\n    return null;\n  }\n\n  return (\n    <div className=\"flex flex-col space-y-2 p-3 bg-primary-50 rounded-md border border-primary-200\">\n      {/* Main Controls Row */}\n      <div className=\"flex items-center space-x-3\">\n        {/* Play/Pause Button */}\n        <Button\n          type=\"button\"\n          variant=\"ghost\"\n          size=\"sm\"\n          onClick={togglePlayback}\n          aria-label={isPlaying ? \"Pause\" : \"Play\"}\n          className=\"flex-shrink-0\"\n        >\n          {isPlaying ? (\n            <svg\n              xmlns=\"http://www.w3.org/2000/svg\"\n              fill=\"currentColor\"\n              viewBox=\"0 0 24 24\"\n              className=\"w-5 h-5\"\n            >\n              <path d=\"M6 4h4v16H6V4zm8 0h4v16h-4V4z\" />\n            </svg>\n          ) : (\n            <svg\n              xmlns=\"http://www.w3.org/2000/svg\"\n              fill=\"currentColor\"\n              viewBox=\"0 0 24 24\"\n              className=\"w-5 h-5\"\n            >\n              <path d=\"M8 5v14l11-7z\" />\n            </svg>\n          )}\n        </Button>\n\n        {/* Progress Bar */}\n        <div className=\"flex-1 flex flex-col space-y-1\">\n          {/* Progress indicator */}\n          <div className=\"relative h-1 bg-primary-200 rounded-full overflow-hidden\">\n            <div\n              className=\"absolute top-0 left-0 h-full bg-primary-500 transition-all duration-100\"\n              style={{ width: `${getProgress()}%` }}\n            />\n          </div>\n\n          {/* Seekable range input (hidden but functional) */}\n          <input\n            type=\"range\"\n            min=\"0\"\n            max={duration || 0}\n            value={currentTime}\n            onChange={handleSeek}\n            className=\"absolute opacity-0 w-full cursor-pointer\"\n            aria-label=\"Audio progress\"\n            style={{ marginTop: \"-4px\" }}\n          />\n\n          <div className=\"flex justify-between items-center text-xs text-neutral-600\">\n            <span>{formatTime(currentTime)}</span>\n            {isPlaying && (\n              <span className=\"text-primary-600 font-medium animate-pulse\">\n                Playing\n              </span>\n            )}\n            <span>{formatTime(duration)}</span>\n          </div>\n        </div>\n\n        {/* Barge-in Button */}\n        {allowBargeIn && isPlaying && (\n          <Button\n            type=\"button\"\n            variant=\"danger\"\n            size=\"sm\"\n            onClick={handleBargeIn}\n            className=\"flex-shrink-0\"\n            aria-label=\"Stop and interrupt\"\n          >\n            <svg\n              xmlns=\"http://www.w3.org/2000/svg\"\n              fill=\"none\"\n              viewBox=\"0 0 24 24\"\n              strokeWidth={2}\n              stroke=\"currentColor\"\n              className=\"w-4 h-4\"\n            >\n              <path\n                strokeLinecap=\"round\"\n                strokeLinejoin=\"round\"\n                d=\"M6 18L18 6M6 6l12 12\"\n              />\n            </svg>\n          </Button>\n        )}\n\n        {/* Settings Toggle */}\n        <button\n          type=\"button\"\n          onClick={() => setShowControls(!showControls)}\n          className=\"flex-shrink-0 text-primary-600 hover:text-primary-700 focus:outline-none\"\n          aria-label=\"Toggle advanced controls\"\n        >\n          <svg\n            xmlns=\"http://www.w3.org/2000/svg\"\n            fill=\"none\"\n            viewBox=\"0 0 24 24\"\n            strokeWidth={1.5}\n            stroke=\"currentColor\"\n            className=\"w-5 h-5\"\n          >\n            <path\n              strokeLinecap=\"round\"\n              strokeLinejoin=\"round\"\n              d=\"M10.5 6h9.75M10.5 6a1.5 1.5 0 11-3 0m3 0a1.5 1.5 0 10-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-9.75 0h9.75\"\n            />\n          </svg>\n        </button>\n      </div>\n\n      {/* Advanced Controls */}\n      {showControls && (\n        <div className=\"pt-2 border-t border-primary-200 space-y-3\">\n          {/* Volume Control */}\n          <div className=\"flex items-center space-x-3\">\n            <svg\n              xmlns=\"http://www.w3.org/2000/svg\"\n              fill=\"none\"\n              viewBox=\"0 0 24 24\"\n              strokeWidth={1.5}\n              stroke=\"currentColor\"\n              className=\"w-4 h-4 text-primary-600 flex-shrink-0\"\n            >\n              <path\n                strokeLinecap=\"round\"\n                strokeLinejoin=\"round\"\n                d=\"M19.114 5.636a9 9 0 010 12.728M16.463 8.288a5.25 5.25 0 010 7.424M6.75 8.25l4.72-4.72a.75.75 0 011.28.53v15.88a.75.75 0 01-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.01 9.01 0 012.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75z\"\n              />\n            </svg>\n            <input\n              type=\"range\"\n              min=\"0\"\n              max=\"1\"\n              step=\"0.1\"\n              value={currentVolume}\n              onChange={handleVolumeChange}\n              className=\"flex-1 h-2 bg-primary-200 rounded-lg appearance-none cursor-pointer accent-primary-500\"\n              aria-label=\"Volume\"\n            />\n            <span className=\"text-xs text-neutral-600 w-12 text-right\">\n              {Math.round(currentVolume * 100)}%\n            </span>\n          </div>\n\n          {/* Speed Control */}\n          <div className=\"flex items-center space-x-2\">\n            <span className=\"text-xs text-neutral-600 flex-shrink-0\">\n              Speed:\n            </span>\n            <div className=\"flex space-x-1 flex-1\">\n              {[0.5, 0.75, 1.0, 1.25, 1.5, 2.0].map((speed) => (\n                <button\n                  key={speed}\n                  type=\"button\"\n                  onClick={() => handleSpeedChange(speed)}\n                  className={`px-2 py-1 text-xs rounded transition-colors ${\n                    currentSpeed === speed\n                      ? \"bg-primary-500 text-white\"\n                      : \"bg-white text-neutral-600 hover:bg-neutral-100\"\n                  }`}\n                >\n                  {speed}x\n                </button>\n              ))}\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Barge-in Hint */}\n      {allowBargeIn && isPlaying && (\n        <p className=\"text-xs text-neutral-500 text-center italic\">\n          Click the Ã— button to interrupt and speak\n        </p>\n      )}\n    </div>\n  );\n}\n"
}

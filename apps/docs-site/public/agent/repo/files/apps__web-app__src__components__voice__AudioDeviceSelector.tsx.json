{
  "path": "apps/web-app/src/components/voice/AudioDeviceSelector.tsx",
  "language": "typescript",
  "size": 5636,
  "last_modified": "2025-11-27T06:44:49.508Z",
  "lines": 184,
  "content": "/**\n * Audio Device Selector Component\n * Allows users to select their preferred microphone\n *\n * Phase 9.3: Enhanced Voice Features\n */\n\nimport { useState, useEffect, useCallback } from \"react\";\n\nexport interface AudioDevice {\n  deviceId: string;\n  label: string;\n  kind: MediaDeviceKind;\n}\n\ninterface AudioDeviceSelectorProps {\n  /** Currently selected device ID */\n  selectedDeviceId?: string;\n  /** Called when user selects a device */\n  onDeviceSelect: (deviceId: string) => void;\n  /** Whether the selector is disabled */\n  disabled?: boolean;\n  /** Custom class name */\n  className?: string;\n}\n\nexport function AudioDeviceSelector({\n  selectedDeviceId,\n  onDeviceSelect,\n  disabled = false,\n  className = \"\",\n}: AudioDeviceSelectorProps) {\n  const [devices, setDevices] = useState<AudioDevice[]>([]);\n  const [isLoading, setIsLoading] = useState(true);\n  const [error, setError] = useState<string | null>(null);\n  const [hasPermission, setHasPermission] = useState(false);\n\n  const loadDevices = useCallback(async () => {\n    setIsLoading(true);\n    setError(null);\n\n    try {\n      // First, request permission if we don't have it\n      if (!hasPermission) {\n        const stream = await navigator.mediaDevices.getUserMedia({\n          audio: true,\n        });\n        // Stop the stream immediately - we just needed permission\n        stream.getTracks().forEach((track) => track.stop());\n        setHasPermission(true);\n      }\n\n      // Now enumerate devices\n      const allDevices = await navigator.mediaDevices.enumerateDevices();\n      const audioInputs = allDevices\n        .filter((device) => device.kind === \"audioinput\")\n        .map((device, index) => ({\n          deviceId: device.deviceId,\n          label: device.label || `Microphone ${index + 1}`,\n          kind: device.kind,\n        }));\n\n      setDevices(audioInputs);\n\n      // Auto-select first device if none selected\n      if (!selectedDeviceId && audioInputs.length > 0) {\n        onDeviceSelect(audioInputs[0].deviceId);\n      }\n    } catch (err) {\n      console.error(\"[AudioDeviceSelector] Failed to load devices:\", err);\n      setError(\"Unable to access microphone devices\");\n    } finally {\n      setIsLoading(false);\n    }\n  }, [hasPermission, selectedDeviceId, onDeviceSelect]);\n\n  // Load devices on mount\n  useEffect(() => {\n    loadDevices();\n  }, [loadDevices]);\n\n  // Listen for device changes\n  useEffect(() => {\n    const handleDeviceChange = () => {\n      loadDevices();\n    };\n\n    navigator.mediaDevices.addEventListener(\"devicechange\", handleDeviceChange);\n    return () => {\n      navigator.mediaDevices.removeEventListener(\n        \"devicechange\",\n        handleDeviceChange,\n      );\n    };\n  }, [loadDevices]);\n\n  if (isLoading) {\n    return (\n      <div className={`flex items-center space-x-2 ${className}`}>\n        <div className=\"w-4 h-4 border-2 border-neutral-300 border-t-primary-500 rounded-full animate-spin\" />\n        <span className=\"text-sm text-neutral-500\">Loading devices...</span>\n      </div>\n    );\n  }\n\n  if (error) {\n    return (\n      <div className={`flex items-center space-x-2 ${className}`}>\n        <svg\n          xmlns=\"http://www.w3.org/2000/svg\"\n          fill=\"none\"\n          viewBox=\"0 0 24 24\"\n          strokeWidth={1.5}\n          stroke=\"currentColor\"\n          className=\"w-4 h-4 text-red-500\"\n        >\n          <path\n            strokeLinecap=\"round\"\n            strokeLinejoin=\"round\"\n            d=\"M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z\"\n          />\n        </svg>\n        <span className=\"text-sm text-red-600\">{error}</span>\n        <button\n          type=\"button\"\n          onClick={loadDevices}\n          className=\"text-sm text-primary-600 hover:text-primary-700\"\n        >\n          Retry\n        </button>\n      </div>\n    );\n  }\n\n  return (\n    <div className={`space-y-2 ${className}`}>\n      <label\n        htmlFor=\"audio-device-select\"\n        className=\"block text-sm font-medium text-neutral-700\"\n      >\n        Microphone\n      </label>\n      <div className=\"relative\">\n        <select\n          id=\"audio-device-select\"\n          value={selectedDeviceId || \"\"}\n          onChange={(e) => onDeviceSelect(e.target.value)}\n          disabled={disabled || devices.length === 0}\n          className=\"block w-full px-3 py-2 text-sm bg-white border border-neutral-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 disabled:bg-neutral-100 disabled:cursor-not-allowed\"\n        >\n          {devices.length === 0 ? (\n            <option value=\"\">No microphones found</option>\n          ) : (\n            devices.map((device) => (\n              <option key={device.deviceId} value={device.deviceId}>\n                {device.label}\n              </option>\n            ))\n          )}\n        </select>\n        <div className=\"absolute inset-y-0 right-0 flex items-center pr-2 pointer-events-none\">\n          <svg\n            xmlns=\"http://www.w3.org/2000/svg\"\n            fill=\"none\"\n            viewBox=\"0 0 24 24\"\n            strokeWidth={1.5}\n            stroke=\"currentColor\"\n            className=\"w-4 h-4 text-neutral-400\"\n          >\n            <path\n              strokeLinecap=\"round\"\n              strokeLinejoin=\"round\"\n              d=\"M12 18.75a6 6 0 006-6v-1.5m-6 7.5a6 6 0 01-6-6v-1.5m6 7.5v3.75m-3.75 0h7.5M12 15.75a3 3 0 01-3-3V4.5a3 3 0 116 0v8.25a3 3 0 01-3 3z\"\n            />\n          </svg>\n        </div>\n      </div>\n      <p className=\"text-xs text-neutral-500\">\n        {devices.length} microphone{devices.length !== 1 ? \"s\" : \"\"} available\n      </p>\n    </div>\n  );\n}\n"
}

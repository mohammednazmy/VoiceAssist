{
  "path": "apps/web-app/src/components/voice/BargeInFeedback.tsx",
  "language": "typescript",
  "size": 14024,
  "last_modified": "2025-12-05T03:07:13.123Z",
  "lines": 522,
  "content": "/**\n * BargeInFeedback Component\n *\n * Provides configurable visual feedback for barge-in events.\n * Supports multiple feedback styles: pulse, border, icon, and minimal.\n * Integrates with haptic and audio feedback systems.\n *\n * Phase 2: Instant Response & Feedback\n */\n\nimport { useEffect, useState, useMemo, useCallback } from \"react\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport {\n  useHapticFeedback,\n  type HapticType,\n} from \"../../hooks/useHapticFeedback\";\nimport {\n  playAudioFeedback,\n  speakPrompt,\n  type FeedbackType as AudioFeedbackType,\n} from \"../../lib/audioFeedback\";\nimport type {\n  FeedbackPreferences,\n  SupportedLanguage,\n} from \"../../hooks/useIntelligentBargeIn/types\";\n\n// ============================================================================\n// Types\n// ============================================================================\n\n/**\n * Types of barge-in feedback events\n */\nexport type BargeInFeedbackType =\n  | \"detected\"\n  | \"confirmed\"\n  | \"backchannel\"\n  | \"soft\"\n  | \"hard\";\n\ninterface BargeInFeedbackProps {\n  /** Whether feedback should be shown */\n  isActive: boolean;\n\n  /** Type of barge-in event */\n  type: BargeInFeedbackType;\n\n  /** Confidence level (0-1) for detected events */\n  confidence?: number;\n\n  /** User feedback preferences */\n  preferences: FeedbackPreferences;\n\n  /** Language for voice prompts */\n  language?: SupportedLanguage;\n\n  /** Callback when animation completes */\n  onAnimationComplete?: () => void;\n\n  /**\n   * Optional callback to play voice prompts using ElevenLabs TTS.\n   * If provided, this will be used instead of browser speech synthesis\n   * to ensure consistent voice across the app.\n   */\n  onPlayVoicePrompt?: (text?: string) => Promise<void>;\n}\n\n// ============================================================================\n// Color Mappings\n// ============================================================================\n\nconst PULSE_COLORS: Record<BargeInFeedbackType, string> = {\n  detected: \"rgba(59, 130, 246, 0.5)\", // Blue\n  confirmed: \"rgba(34, 197, 94, 0.5)\", // Green\n  backchannel: \"rgba(168, 162, 158, 0.3)\", // Gray\n  soft: \"rgba(251, 191, 36, 0.5)\", // Yellow\n  hard: \"rgba(239, 68, 68, 0.5)\", // Red\n};\n\nconst HAPTIC_MAP: Record<BargeInFeedbackType, HapticType> = {\n  detected: \"bargeInDetected\",\n  confirmed: \"bargeInConfirmed\",\n  backchannel: \"backchannel\",\n  soft: \"softBarge\",\n  hard: \"hardBarge\",\n};\n\nconst AUDIO_MAP: Record<BargeInFeedbackType, AudioFeedbackType> = {\n  detected: \"detected\",\n  confirmed: \"confirmed\",\n  backchannel: \"backchannel\",\n  soft: \"soft\",\n  hard: \"hard\",\n};\n\nconst ICONS: Record<BargeInFeedbackType, string> = {\n  detected: \"ðŸŽ¤\",\n  confirmed: \"âœ“\",\n  backchannel: \"ðŸ‘‚\",\n  soft: \"â¸\",\n  hard: \"âœ‹\",\n};\n\n// ============================================================================\n// Animation Variants\n// ============================================================================\n\nconst pulseVariants = {\n  initial: {\n    width: 20,\n    height: 20,\n    opacity: 0.8,\n  },\n  animate: {\n    width: 200,\n    height: 200,\n    opacity: 0,\n    transition: {\n      duration: 0.3,\n      ease: \"easeOut\",\n    },\n  },\n  exit: {\n    opacity: 0,\n    transition: { duration: 0.05 },\n  },\n};\n\nconst borderVariants = {\n  initial: { opacity: 0 },\n  animate: {\n    opacity: 1,\n    transition: { duration: 0.1 },\n  },\n  exit: {\n    opacity: 0,\n    transition: { duration: 0.2 },\n  },\n};\n\nconst iconVariants = {\n  initial: { scale: 0, opacity: 0 },\n  animate: {\n    scale: [0, 1.2, 1],\n    opacity: [0, 1, 1],\n    transition: {\n      duration: 0.3,\n      times: [0, 0.5, 1],\n    },\n  },\n  exit: {\n    scale: 0,\n    opacity: 0,\n    transition: { duration: 0.15 },\n  },\n};\n\nconst minimalVariants = {\n  initial: { opacity: 0, y: 10 },\n  animate: {\n    opacity: 1,\n    y: 0,\n    transition: { duration: 0.15 },\n  },\n  exit: {\n    opacity: 0,\n    y: -10,\n    transition: { duration: 0.15 },\n  },\n};\n\n// ============================================================================\n// Component\n// ============================================================================\n\nexport function BargeInFeedback({\n  isActive,\n  type,\n  confidence: _confidence = 0,\n  preferences,\n  language = \"en\",\n  onAnimationComplete,\n  onPlayVoicePrompt,\n}: BargeInFeedbackProps) {\n  const [showPulse, setShowPulse] = useState(false);\n  const [animationKey, setAnimationKey] = useState(0);\n  const { triggerHaptic } = useHapticFeedback();\n\n  const pulseColor = useMemo(() => PULSE_COLORS[type], [type]);\n\n  // Handle feedback triggers\n  const triggerFeedback = useCallback(() => {\n    // Visual feedback\n    if (preferences.visualFeedbackEnabled) {\n      setShowPulse(true);\n      setAnimationKey((k) => k + 1);\n\n      // Auto-hide after animation\n      setTimeout(() => {\n        setShowPulse(false);\n        onAnimationComplete?.();\n      }, 300);\n    }\n\n    // Haptic feedback\n    if (preferences.hapticFeedbackEnabled) {\n      triggerHaptic(HAPTIC_MAP[type], preferences.hapticIntensity);\n    }\n\n    // Audio feedback\n    if (preferences.audioFeedbackEnabled) {\n      if (preferences.audioFeedbackType === \"tone\") {\n        playAudioFeedback(AUDIO_MAP[type]);\n      } else if (preferences.audioFeedbackType === \"voice\" && type === \"hard\") {\n        if (preferences.voicePromptAfterHardBarge) {\n          const promptText = preferences.voicePromptText || \"I'm listening\";\n          // Use ElevenLabs TTS if callback provided, otherwise fall back to browser TTS\n          if (onPlayVoicePrompt) {\n            onPlayVoicePrompt(promptText).catch(() => {\n              // Fallback to browser TTS if ElevenLabs fails\n              speakPrompt(promptText, language);\n            });\n          } else {\n            speakPrompt(promptText, language);\n          }\n        }\n      }\n    }\n  }, [\n    preferences,\n    type,\n    language,\n    triggerHaptic,\n    onAnimationComplete,\n    onPlayVoicePrompt,\n  ]);\n\n  // Trigger feedback when activated\n  useEffect(() => {\n    if (isActive) {\n      triggerFeedback();\n    }\n  }, [isActive, triggerFeedback]);\n\n  // Don't render if visual feedback is disabled\n  if (!preferences.visualFeedbackEnabled) {\n    return null;\n  }\n\n  // Render based on feedback style\n  const renderFeedback = () => {\n    switch (preferences.visualFeedbackStyle) {\n      case \"pulse\":\n        return (\n          <motion.div\n            key={animationKey}\n            className=\"fixed inset-0 pointer-events-none z-50 flex items-center justify-center\"\n            initial={{ opacity: 0 }}\n            animate={{ opacity: 1 }}\n            exit={{ opacity: 0 }}\n            transition={{ duration: 0.05 }}\n            aria-hidden=\"true\"\n          >\n            <motion.div\n              className=\"rounded-full\"\n              style={{\n                backgroundColor: pulseColor,\n                boxShadow: `0 0 60px 30px ${pulseColor}`,\n              }}\n              variants={pulseVariants}\n              initial=\"initial\"\n              animate=\"animate\"\n              exit=\"exit\"\n            />\n          </motion.div>\n        );\n\n      case \"border\":\n        return (\n          <motion.div\n            key={animationKey}\n            className=\"fixed inset-0 pointer-events-none z-50\"\n            aria-hidden=\"true\"\n          >\n            <motion.div\n              className=\"absolute inset-2 rounded-lg\"\n              style={{\n                border: `4px solid ${pulseColor}`,\n              }}\n              variants={borderVariants}\n              initial=\"initial\"\n              animate=\"animate\"\n              exit=\"exit\"\n            />\n          </motion.div>\n        );\n\n      case \"icon\":\n        return (\n          <motion.div\n            key={animationKey}\n            className=\"fixed top-4 right-4 pointer-events-none z-50\"\n            variants={iconVariants}\n            initial=\"initial\"\n            animate=\"animate\"\n            exit=\"exit\"\n            aria-hidden=\"true\"\n          >\n            <div\n              className=\"w-12 h-12 rounded-full flex items-center justify-center text-2xl\"\n              style={{ backgroundColor: pulseColor }}\n            >\n              {ICONS[type]}\n            </div>\n          </motion.div>\n        );\n\n      case \"minimal\":\n        return (\n          <motion.div\n            key={animationKey}\n            className=\"fixed bottom-20 left-1/2 -translate-x-1/2 pointer-events-none z-50\"\n            variants={minimalVariants}\n            initial=\"initial\"\n            animate=\"animate\"\n            exit=\"exit\"\n            aria-hidden=\"true\"\n          >\n            <div\n              className=\"w-2 h-2 rounded-full\"\n              style={{ backgroundColor: pulseColor }}\n            />\n          </motion.div>\n        );\n\n      default:\n        return null;\n    }\n  };\n\n  return (\n    <AnimatePresence mode=\"wait\">\n      {showPulse && renderFeedback()}\n    </AnimatePresence>\n  );\n}\n\n// ============================================================================\n// Additional Feedback Components\n// ============================================================================\n\n/**\n * Confidence indicator that shows VAD confidence level\n */\ninterface ConfidenceIndicatorProps {\n  confidence: number;\n  isVisible: boolean;\n}\n\nexport function ConfidenceIndicator({\n  confidence,\n  isVisible,\n}: ConfidenceIndicatorProps) {\n  const barColor = useMemo(() => {\n    if (confidence > 0.8) return \"bg-green-500\";\n    if (confidence > 0.5) return \"bg-yellow-500\";\n    return \"bg-red-500\";\n  }, [confidence]);\n\n  return (\n    <AnimatePresence>\n      {isVisible && (\n        <motion.div\n          className=\"fixed bottom-4 left-4 w-24 pointer-events-none z-50\"\n          initial={{ opacity: 0, x: -20 }}\n          animate={{ opacity: 1, x: 0 }}\n          exit={{ opacity: 0, x: -20 }}\n          transition={{ duration: 0.2 }}\n        >\n          <div className=\"text-xs text-gray-400 mb-1\">Voice</div>\n          <div className=\"h-1 bg-gray-700 rounded-full overflow-hidden\">\n            <motion.div\n              className={`h-full ${barColor}`}\n              initial={{ width: 0 }}\n              animate={{ width: `${confidence * 100}%` }}\n              transition={{ duration: 0.1 }}\n            />\n          </div>\n        </motion.div>\n      )}\n    </AnimatePresence>\n  );\n}\n\n/**\n * Speaking indicator that shows when the AI is speaking\n */\ninterface SpeakingIndicatorProps {\n  isSpeaking: boolean;\n  canInterrupt: boolean;\n}\n\nexport function SpeakingIndicator({\n  isSpeaking,\n  canInterrupt,\n}: SpeakingIndicatorProps) {\n  return (\n    <AnimatePresence>\n      {isSpeaking && (\n        <motion.div\n          className=\"fixed top-4 left-4 pointer-events-none z-50\"\n          initial={{ opacity: 0, scale: 0.8 }}\n          animate={{ opacity: 1, scale: 1 }}\n          exit={{ opacity: 0, scale: 0.8 }}\n          transition={{ duration: 0.2 }}\n        >\n          <div className=\"flex items-center gap-2 bg-gray-800/80 backdrop-blur-sm px-3 py-1.5 rounded-full\">\n            {/* Animated speaking dots */}\n            <div className=\"flex gap-1\">\n              {[0, 1, 2].map((i) => (\n                <motion.div\n                  key={i}\n                  className=\"w-1.5 h-1.5 bg-blue-400 rounded-full\"\n                  animate={{\n                    y: [0, -4, 0],\n                  }}\n                  transition={{\n                    duration: 0.6,\n                    repeat: Infinity,\n                    delay: i * 0.15,\n                  }}\n                />\n              ))}\n            </div>\n            <span className=\"text-xs text-gray-300\">\n              {canInterrupt ? \"Speak to interrupt\" : \"Speaking...\"}\n            </span>\n          </div>\n        </motion.div>\n      )}\n    </AnimatePresence>\n  );\n}\n\n/**\n * Listening indicator that shows when the system is listening for speech\n */\ninterface ListeningIndicatorProps {\n  isListening: boolean;\n  probability: number;\n}\n\nexport function ListeningIndicator({\n  isListening,\n  probability,\n}: ListeningIndicatorProps) {\n  const ringOpacity = useMemo(\n    () => Math.min(1, 0.3 + probability * 0.7),\n    [probability],\n  );\n\n  return (\n    <AnimatePresence>\n      {isListening && (\n        <motion.div\n          className=\"fixed bottom-24 left-1/2 -translate-x-1/2 pointer-events-none z-40\"\n          initial={{ opacity: 0, scale: 0.5 }}\n          animate={{ opacity: 1, scale: 1 }}\n          exit={{ opacity: 0, scale: 0.5 }}\n          transition={{ duration: 0.3 }}\n        >\n          <div className=\"relative\">\n            {/* Outer ring - pulses based on probability */}\n            <motion.div\n              className=\"absolute inset-0 rounded-full border-2 border-blue-400\"\n              animate={{\n                scale: [1, 1.2, 1],\n                opacity: [ringOpacity, ringOpacity * 0.5, ringOpacity],\n              }}\n              transition={{\n                duration: 1.5,\n                repeat: Infinity,\n                ease: \"easeInOut\",\n              }}\n              style={{ width: 48, height: 48 }}\n            />\n            {/* Inner circle */}\n            <motion.div\n              className=\"w-12 h-12 rounded-full bg-blue-500/30 flex items-center justify-center\"\n              animate={{\n                backgroundColor:\n                  probability > 0.5\n                    ? \"rgba(59, 130, 246, 0.5)\"\n                    : \"rgba(59, 130, 246, 0.3)\",\n              }}\n            >\n              <motion.div\n                className=\"w-6 h-6 rounded-full bg-blue-500\"\n                animate={{\n                  scale: 0.8 + probability * 0.4,\n                }}\n                transition={{ duration: 0.1 }}\n              />\n            </motion.div>\n          </div>\n        </motion.div>\n      )}\n    </AnimatePresence>\n  );\n}\n\n// ============================================================================\n// Export Types\n// ============================================================================\n\nexport type {\n  BargeInFeedbackProps,\n  ConfidenceIndicatorProps,\n  SpeakingIndicatorProps,\n  ListeningIndicatorProps,\n};\n"
}

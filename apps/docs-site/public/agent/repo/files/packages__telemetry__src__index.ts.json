{
  "path": "packages/telemetry/src/index.ts",
  "language": "typescript",
  "size": 3258,
  "last_modified": "2025-11-27T09:30:11.358Z",
  "lines": 131,
  "content": "import * as Sentry from \"@sentry/browser\";\nimport type { Metric } from \"web-vitals\";\nimport { onCLS, onFCP, onFID, onINP, onLCP, onTTFB } from \"web-vitals\";\n\nexport interface TelemetryOptions {\n  release?: string;\n  environment?: string;\n  sentryDsn?: string;\n  grafanaUrl?: string;\n  app?: string;\n  /**\n   * Optional auth token for Grafana Loki/OTLP ingestion\n   */\n  grafanaToken?: string;\n  /**\n   * Additional context shared with all events\n   */\n  context?: Record<string, unknown>;\n}\n\nexport interface TelemetryClient {\n  captureError: (error: unknown, context?: Record<string, unknown>) => void;\n  captureMessage: (message: string, level?: Sentry.SeverityLevel) => void;\n  trackWebVitals: () => void;\n  flush: () => Promise<boolean>;\n}\n\ninterface GrafanaPayload {\n  stream: Record<string, string>;\n  values: [string, string][];\n}\n\nfunction sendToGrafana(\n  metric: Metric | { message: string; level: Sentry.SeverityLevel },\n  options: TelemetryOptions,\n) {\n  if (!options.grafanaUrl) return;\n\n  const nowNs = `${BigInt(Date.now()) * 1_000_000n}`;\n  const baseStream: Record<string, string> = {\n    app: options.app || \"voiceassist\",\n    env: options.environment || \"unknown\",\n  };\n\n  const payload: GrafanaPayload = {\n    stream: baseStream,\n    values: [\n      [\n        nowNs,\n        JSON.stringify({\n          type: \"telemetry\",\n          metric,\n          context: options.context,\n        }),\n      ],\n    ],\n  };\n\n  fetch(options.grafanaUrl, {\n    method: \"POST\",\n    headers: {\n      \"Content-Type\": \"application/json\",\n      ...(options.grafanaToken\n        ? { Authorization: `Bearer ${options.grafanaToken}` }\n        : {}),\n    },\n    body: JSON.stringify({ streams: [payload] }),\n  }).catch((error) => {\n    console.warn(\"[telemetry] grafana ingestion failed\", error);\n  });\n}\n\nexport function createTelemetryClient(\n  options: TelemetryOptions,\n): TelemetryClient {\n  if (options.sentryDsn) {\n    Sentry.init({\n      dsn: options.sentryDsn,\n      release: options.release,\n      environment: options.environment,\n      integrations: [Sentry.browserTracingIntegration()],\n      tracesSampleRate: 0.2,\n      replaysSessionSampleRate: 0,\n    });\n  }\n\n  const captureError = (error: unknown, context?: Record<string, unknown>) => {\n    if (options.sentryDsn) {\n      Sentry.captureException(error, { extra: context });\n    }\n    sendToGrafana({ message: String(error), level: \"error\" }, options);\n  };\n\n  const captureMessage = (\n    message: string,\n    level: Sentry.SeverityLevel = \"info\",\n  ) => {\n    if (options.sentryDsn) {\n      Sentry.captureMessage(message, level);\n    }\n    sendToGrafana({ message, level }, options);\n  };\n\n  const trackWebVitals = () => {\n    const handler = (metric: Metric) => {\n      captureMessage(\n        `web-vital:${metric.name}:${metric.value.toFixed(2)}`,\n        \"info\",\n      );\n      sendToGrafana(metric, options);\n    };\n\n    onCLS(handler);\n    onFCP(handler);\n    onFID(handler);\n    onINP(handler);\n    onLCP(handler);\n    onTTFB(handler);\n  };\n\n  const flush = async () => {\n    if (!Sentry.getCurrentHub().getClient()) return true;\n    const result = await Sentry.flush(3000);\n    return result;\n  };\n\n  return { captureError, captureMessage, trackWebVitals, flush };\n}\n\nexport { Sentry };\n"
}

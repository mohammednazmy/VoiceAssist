{
  "path": "services/api-gateway/app/models/citation.py",
  "language": "python",
  "size": 4096,
  "last_modified": "2025-12-05T03:07:13.131Z",
  "lines": 126,
  "content": "\"\"\"\nCitation model for tracking source citations in responses\n\"\"\"\n\nimport uuid\nfrom datetime import datetime\nfrom typing import Optional\n\nfrom app.core.database import Base\nfrom pydantic import BaseModel\nfrom sqlalchemy import Column, DateTime, ForeignKey, Integer, String, Text\nfrom sqlalchemy.dialects.postgresql import JSONB, UUID\n\n\nclass MessageCitation(Base):\n    \"\"\"Citation model linking messages to their sources\"\"\"\n\n    __tablename__ = \"message_citations\"\n\n    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)\n    message_id = Column(\n        UUID(as_uuid=True),\n        ForeignKey(\"messages.id\", ondelete=\"CASCADE\"),\n        nullable=False,\n        index=True,\n    )\n\n    # Source identification\n    source_id = Column(String(255), nullable=False)  # KB document/chunk ID\n    source_type = Column(String(50), nullable=False)  # textbook|journal|guideline|note\n    title = Column(Text, nullable=False)\n    url = Column(Text, nullable=True)\n\n    # Source metadata\n    authors = Column(JSONB, nullable=True)  # Array of author names\n    publication_date = Column(String(50), nullable=True)  # e.g., \"2023\", \"2023-01-15\"\n    journal = Column(String(255), nullable=True)  # Journal name for articles\n    volume = Column(String(50), nullable=True)  # Volume number\n    issue = Column(String(50), nullable=True)  # Issue number\n    pages = Column(String(50), nullable=True)  # Page range (e.g., \"123-145\")\n    doi = Column(String(255), nullable=True)  # Digital Object Identifier\n    pmid = Column(String(50), nullable=True)  # PubMed ID\n\n    # Citation context\n    relevance_score = Column(Integer, nullable=True)  # 0-100 score from semantic search\n    quoted_text = Column(Text, nullable=True)  # Excerpt from source used in response\n    context = Column(JSONB, nullable=True)  # Additional context (section, chapter, etc.)\n\n    # Timestamps\n    created_at = Column(DateTime(timezone=True), default=datetime.utcnow, nullable=False)\n\n    def __repr__(self):\n        return f\"<MessageCitation(id={self.id}, source_type={self.source_type}, title={self.title})>\"\n\n    def to_dict(self):\n        \"\"\"Convert to dictionary\"\"\"\n        return {\n            \"id\": str(self.id),\n            \"message_id\": str(self.message_id),\n            \"source_id\": self.source_id,\n            \"source_type\": self.source_type,\n            \"title\": self.title,\n            \"url\": self.url,\n            \"authors\": self.authors or [],\n            \"publication_date\": self.publication_date,\n            \"journal\": self.journal,\n            \"volume\": self.volume,\n            \"issue\": self.issue,\n            \"pages\": self.pages,\n            \"doi\": self.doi,\n            \"pmid\": self.pmid,\n            \"relevance_score\": self.relevance_score,\n            \"quoted_text\": self.quoted_text,\n            \"context\": self.context or {},\n            \"created_at\": self.created_at.isoformat() if self.created_at else None,\n        }\n\n\n# Pydantic models for API\n\n\nclass CitationCreate(BaseModel):\n    \"\"\"Create citation\"\"\"\n\n    source_id: str\n    source_type: str\n    title: str\n    url: Optional[str] = None\n    authors: Optional[list] = None\n    publication_date: Optional[str] = None\n    journal: Optional[str] = None\n    volume: Optional[str] = None\n    issue: Optional[str] = None\n    pages: Optional[str] = None\n    doi: Optional[str] = None\n    pmid: Optional[str] = None\n    relevance_score: Optional[int] = None\n    quoted_text: Optional[str] = None\n    context: Optional[dict] = None\n\n\nclass CitationResponse(BaseModel):\n    \"\"\"Citation response\"\"\"\n\n    id: str\n    message_id: str\n    source_id: str\n    source_type: str\n    title: str\n    url: Optional[str] = None\n    authors: list = []\n    publication_date: Optional[str] = None\n    journal: Optional[str] = None\n    volume: Optional[str] = None\n    issue: Optional[str] = None\n    pages: Optional[str] = None\n    doi: Optional[str] = None\n    pmid: Optional[str] = None\n    relevance_score: Optional[int] = None\n    quoted_text: Optional[str] = None\n    context: dict = {}\n    created_at: str\n\n    class Config:\n        from_attributes = True\n"
}

{
  "path": "apps/admin-panel/src/components/security/TwoFactorSettings.tsx",
  "language": "typescript",
  "size": 15698,
  "last_modified": "2025-11-29T04:23:35.107Z",
  "lines": 430,
  "content": "/**\n * Two-Factor Authentication Settings Component\n *\n * Allows users to:\n * - View 2FA status\n * - Enable 2FA with QR code\n * - View and regenerate backup codes\n * - Disable 2FA\n */\n\nimport { useState } from \"react\";\nimport { use2FA } from \"../../hooks/use2FA\";\n\nexport function TwoFactorSettings() {\n  const {\n    status,\n    loading,\n    error,\n    setupData,\n    setupLoading,\n    verifyLoading,\n    disableLoading,\n    startSetup,\n    verifyAndEnable,\n    disable,\n    regenerateBackupCodes,\n    clearSetupData,\n  } = use2FA();\n\n  // Local state\n  const [verifyCode, setVerifyCode] = useState(\"\");\n  const [disablePassword, setDisablePassword] = useState(\"\");\n  const [disableCode, setDisableCode] = useState(\"\");\n  const [showDisableForm, setShowDisableForm] = useState(false);\n  const [backupCodes, setBackupCodes] = useState<string[] | null>(null);\n  const [showBackupCodes, setShowBackupCodes] = useState(false);\n  const [regenerateCode, setRegenerateCode] = useState(\"\");\n  const [showRegenerateForm, setShowRegenerateForm] = useState(false);\n\n  const handleStartSetup = async () => {\n    await startSetup();\n  };\n\n  const handleVerify = async (e: React.FormEvent) => {\n    e.preventDefault();\n    const success = await verifyAndEnable(verifyCode);\n    if (success) {\n      setVerifyCode(\"\");\n    }\n  };\n\n  const handleDisable = async (e: React.FormEvent) => {\n    e.preventDefault();\n    const success = await disable(disablePassword, disableCode);\n    if (success) {\n      setDisablePassword(\"\");\n      setDisableCode(\"\");\n      setShowDisableForm(false);\n    }\n  };\n\n  const handleRegenerateBackupCodes = async (e: React.FormEvent) => {\n    e.preventDefault();\n    const codes = await regenerateBackupCodes(regenerateCode);\n    if (codes) {\n      setBackupCodes(codes);\n      setShowBackupCodes(true);\n      setRegenerateCode(\"\");\n      setShowRegenerateForm(false);\n    }\n  };\n\n  const handleCancelSetup = () => {\n    clearSetupData();\n    setVerifyCode(\"\");\n  };\n\n  if (loading) {\n    return (\n      <div className=\"bg-slate-900/50 border border-slate-800 rounded-lg p-6\">\n        <div className=\"animate-pulse\">\n          <div className=\"h-5 w-48 bg-slate-800 rounded mb-4\" />\n          <div className=\"h-4 w-72 bg-slate-800 rounded\" />\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"bg-slate-900/50 border border-slate-800 rounded-lg\">\n      <div className=\"px-4 py-3 border-b border-slate-800\">\n        <h2 className=\"text-sm font-medium text-slate-200\">\n          Two-Factor Authentication\n        </h2>\n        <p className=\"text-xs text-slate-500 mt-1\">\n          Add an extra layer of security to your account\n        </p>\n      </div>\n\n      <div className=\"p-4 space-y-4\">\n        {error && (\n          <div className=\"bg-red-900/20 border border-red-800 text-red-400 px-4 py-3 rounded-lg text-sm\">\n            {error}\n          </div>\n        )}\n\n        {/* Status Display */}\n        <div className=\"flex items-center justify-between\">\n          <div className=\"flex items-center gap-3\">\n            <div\n              className={`w-10 h-10 rounded-full flex items-center justify-center ${\n                status?.enabled\n                  ? \"bg-green-900/50 text-green-400\"\n                  : \"bg-slate-800 text-slate-500\"\n              }`}\n            >\n              {status?.enabled ? (\n                <svg\n                  className=\"w-5 h-5\"\n                  fill=\"none\"\n                  viewBox=\"0 0 24 24\"\n                  stroke=\"currentColor\"\n                >\n                  <path\n                    strokeLinecap=\"round\"\n                    strokeLinejoin=\"round\"\n                    strokeWidth={2}\n                    d=\"M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z\"\n                  />\n                </svg>\n              ) : (\n                <svg\n                  className=\"w-5 h-5\"\n                  fill=\"none\"\n                  viewBox=\"0 0 24 24\"\n                  stroke=\"currentColor\"\n                >\n                  <path\n                    strokeLinecap=\"round\"\n                    strokeLinejoin=\"round\"\n                    strokeWidth={2}\n                    d=\"M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z\"\n                  />\n                </svg>\n              )}\n            </div>\n            <div>\n              <div className=\"text-sm font-medium text-slate-200\">\n                {status?.enabled ? \"2FA Enabled\" : \"2FA Not Enabled\"}\n              </div>\n              {status?.enabled && status.verified_at && (\n                <div className=\"text-xs text-slate-500\">\n                  Enabled on {new Date(status.verified_at).toLocaleDateString()}\n                </div>\n              )}\n              {status?.enabled && (\n                <div className=\"text-xs text-slate-500\">\n                  {status.backup_codes_remaining} backup codes remaining\n                </div>\n              )}\n            </div>\n          </div>\n\n          {!status?.enabled && !setupData && (\n            <button\n              onClick={handleStartSetup}\n              disabled={setupLoading}\n              className=\"px-4 py-2 text-sm bg-blue-600 hover:bg-blue-700 text-white rounded-md transition-colors disabled:opacity-50\"\n            >\n              {setupLoading ? \"Setting up...\" : \"Enable 2FA\"}\n            </button>\n          )}\n\n          {status?.enabled && !showDisableForm && (\n            <div className=\"flex gap-2\">\n              <button\n                onClick={() => setShowRegenerateForm(true)}\n                className=\"px-3 py-1.5 text-xs bg-slate-800 hover:bg-slate-700 text-slate-300 rounded transition-colors\"\n              >\n                Regenerate Codes\n              </button>\n              <button\n                onClick={() => setShowDisableForm(true)}\n                className=\"px-3 py-1.5 text-xs bg-red-900/50 hover:bg-red-800/50 text-red-400 border border-red-800 rounded transition-colors\"\n              >\n                Disable 2FA\n              </button>\n            </div>\n          )}\n        </div>\n\n        {/* Setup Flow */}\n        {setupData && (\n          <div className=\"border border-slate-700 rounded-lg p-4 space-y-4\">\n            <div className=\"text-center\">\n              <h3 className=\"text-lg font-medium text-slate-200 mb-2\">\n                Scan QR Code\n              </h3>\n              <p className=\"text-sm text-slate-400 mb-4\">\n                Scan this QR code with your authenticator app (Google\n                Authenticator, Authy, etc.)\n              </p>\n              <div className=\"inline-block p-4 bg-white rounded-lg\">\n                <img\n                  src={setupData.qr_code}\n                  alt=\"2FA QR Code\"\n                  className=\"w-48 h-48\"\n                />\n              </div>\n            </div>\n\n            <div className=\"text-center\">\n              <p className=\"text-xs text-slate-500 mb-2\">\n                Or enter this code manually:\n              </p>\n              <code className=\"px-3 py-1.5 bg-slate-800 text-slate-300 text-sm rounded font-mono\">\n                {setupData.manual_entry_key}\n              </code>\n            </div>\n\n            {/* Backup Codes */}\n            <div className=\"bg-amber-900/20 border border-amber-800 rounded-lg p-4\">\n              <h4 className=\"text-sm font-medium text-amber-400 mb-2\">\n                Backup Codes\n              </h4>\n              <p className=\"text-xs text-amber-300/80 mb-3\">\n                Save these codes in a safe place. You can use them to access\n                your account if you lose your authenticator.\n              </p>\n              <div className=\"grid grid-cols-2 gap-2\">\n                {setupData.backup_codes.map((code, idx) => (\n                  <code\n                    key={idx}\n                    className=\"px-2 py-1 bg-slate-800 text-slate-300 text-xs rounded font-mono text-center\"\n                  >\n                    {code}\n                  </code>\n                ))}\n              </div>\n            </div>\n\n            {/* Verify Code */}\n            <form onSubmit={handleVerify} className=\"space-y-3\">\n              <div>\n                <label className=\"block text-xs text-slate-500 mb-1\">\n                  Enter the 6-digit code from your authenticator app\n                </label>\n                <input\n                  type=\"text\"\n                  value={verifyCode}\n                  onChange={(e) =>\n                    setVerifyCode(e.target.value.replace(/\\D/g, \"\").slice(0, 6))\n                  }\n                  placeholder=\"000000\"\n                  className=\"w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded text-slate-200 text-center text-lg font-mono tracking-wider focus:outline-none focus:ring-2 focus:ring-blue-500\"\n                  maxLength={6}\n                  pattern=\"\\d{6}\"\n                  required\n                />\n              </div>\n              <div className=\"flex gap-2\">\n                <button\n                  type=\"submit\"\n                  disabled={verifyLoading || verifyCode.length !== 6}\n                  className=\"flex-1 px-4 py-2 text-sm bg-blue-600 hover:bg-blue-700 text-white rounded-md transition-colors disabled:opacity-50\"\n                >\n                  {verifyLoading ? \"Verifying...\" : \"Verify & Enable\"}\n                </button>\n                <button\n                  type=\"button\"\n                  onClick={handleCancelSetup}\n                  className=\"px-4 py-2 text-sm bg-slate-800 hover:bg-slate-700 text-slate-300 rounded-md transition-colors\"\n                >\n                  Cancel\n                </button>\n              </div>\n            </form>\n          </div>\n        )}\n\n        {/* Disable Form */}\n        {showDisableForm && (\n          <form\n            onSubmit={handleDisable}\n            className=\"border border-red-800/50 rounded-lg p-4 space-y-4\"\n          >\n            <h3 className=\"text-sm font-medium text-red-400\">\n              Disable Two-Factor Authentication\n            </h3>\n            <p className=\"text-xs text-slate-400\">\n              Enter your password and a verification code to disable 2FA.\n            </p>\n            <div className=\"space-y-3\">\n              <div>\n                <label className=\"block text-xs text-slate-500 mb-1\">\n                  Password\n                </label>\n                <input\n                  type=\"password\"\n                  value={disablePassword}\n                  onChange={(e) => setDisablePassword(e.target.value)}\n                  className=\"w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded text-slate-200 text-sm focus:outline-none focus:ring-2 focus:ring-red-500\"\n                  required\n                />\n              </div>\n              <div>\n                <label className=\"block text-xs text-slate-500 mb-1\">\n                  Authenticator Code (or Backup Code)\n                </label>\n                <input\n                  type=\"text\"\n                  value={disableCode}\n                  onChange={(e) => setDisableCode(e.target.value)}\n                  placeholder=\"000000 or XXXX-XXXX\"\n                  className=\"w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded text-slate-200 text-sm font-mono focus:outline-none focus:ring-2 focus:ring-red-500\"\n                  required\n                />\n              </div>\n            </div>\n            <div className=\"flex gap-2\">\n              <button\n                type=\"submit\"\n                disabled={disableLoading}\n                className=\"flex-1 px-4 py-2 text-sm bg-red-600 hover:bg-red-700 text-white rounded-md transition-colors disabled:opacity-50\"\n              >\n                {disableLoading ? \"Disabling...\" : \"Disable 2FA\"}\n              </button>\n              <button\n                type=\"button\"\n                onClick={() => {\n                  setShowDisableForm(false);\n                  setDisablePassword(\"\");\n                  setDisableCode(\"\");\n                }}\n                className=\"px-4 py-2 text-sm bg-slate-800 hover:bg-slate-700 text-slate-300 rounded-md transition-colors\"\n              >\n                Cancel\n              </button>\n            </div>\n          </form>\n        )}\n\n        {/* Regenerate Backup Codes Form */}\n        {showRegenerateForm && (\n          <form\n            onSubmit={handleRegenerateBackupCodes}\n            className=\"border border-slate-700 rounded-lg p-4 space-y-4\"\n          >\n            <h3 className=\"text-sm font-medium text-slate-200\">\n              Regenerate Backup Codes\n            </h3>\n            <p className=\"text-xs text-slate-400\">\n              This will invalidate your existing backup codes and generate new\n              ones.\n            </p>\n            <div>\n              <label className=\"block text-xs text-slate-500 mb-1\">\n                Enter your authenticator code to confirm\n              </label>\n              <input\n                type=\"text\"\n                value={regenerateCode}\n                onChange={(e) =>\n                  setRegenerateCode(\n                    e.target.value.replace(/\\D/g, \"\").slice(0, 6),\n                  )\n                }\n                placeholder=\"000000\"\n                className=\"w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded text-slate-200 text-center text-lg font-mono tracking-wider focus:outline-none focus:ring-2 focus:ring-blue-500\"\n                maxLength={6}\n                required\n              />\n            </div>\n            <div className=\"flex gap-2\">\n              <button\n                type=\"submit\"\n                disabled={regenerateCode.length !== 6}\n                className=\"flex-1 px-4 py-2 text-sm bg-blue-600 hover:bg-blue-700 text-white rounded-md transition-colors disabled:opacity-50\"\n              >\n                Regenerate Codes\n              </button>\n              <button\n                type=\"button\"\n                onClick={() => {\n                  setShowRegenerateForm(false);\n                  setRegenerateCode(\"\");\n                }}\n                className=\"px-4 py-2 text-sm bg-slate-800 hover:bg-slate-700 text-slate-300 rounded-md transition-colors\"\n              >\n                Cancel\n              </button>\n            </div>\n          </form>\n        )}\n\n        {/* New Backup Codes Display */}\n        {showBackupCodes && backupCodes && (\n          <div className=\"bg-green-900/20 border border-green-800 rounded-lg p-4\">\n            <h4 className=\"text-sm font-medium text-green-400 mb-2\">\n              New Backup Codes Generated\n            </h4>\n            <p className=\"text-xs text-green-300/80 mb-3\">\n              Save these codes in a safe place. Previous codes are now invalid.\n            </p>\n            <div className=\"grid grid-cols-2 gap-2 mb-3\">\n              {backupCodes.map((code, idx) => (\n                <code\n                  key={idx}\n                  className=\"px-2 py-1 bg-slate-800 text-slate-300 text-xs rounded font-mono text-center\"\n                >\n                  {code}\n                </code>\n              ))}\n            </div>\n            <button\n              onClick={() => {\n                setShowBackupCodes(false);\n                setBackupCodes(null);\n              }}\n              className=\"w-full px-3 py-2 text-sm bg-slate-800 hover:bg-slate-700 text-slate-300 rounded transition-colors\"\n            >\n              Done\n            </button>\n          </div>\n        )}\n      </div>\n    </div>\n  );\n}\n"
}

{
  "path": "apps/web-app/src/components/voice/ThinkerTalkerVoicePanel.tsx",
  "language": "typescript",
  "size": 5804,
  "last_modified": "2025-12-04T07:44:58.970Z",
  "lines": 172,
  "content": "/**\n * ThinkerTalkerVoicePanel\n *\n * Voice mode panel using the Thinker/Talker pipeline instead of OpenAI Realtime API.\n * Features:\n * - Unified conversation context with chat mode\n * - Full tool/RAG support in voice\n * - Real-time tool call visualization\n * - ElevenLabs streaming TTS\n * - Barge-in support\n * - Compact mode (~80px) that doesn't obscure chat\n * - Expandable drawer for detailed metrics and tool calls\n *\n * Phase: Thinker/Talker Voice Pipeline Migration\n * Phase 11: Compact Voice Mode UI\n */\n\nimport { useState, useCallback } from \"react\";\nimport { useThinkerTalkerVoiceMode } from \"../../hooks/useThinkerTalkerVoiceMode\";\nimport type {\n  TTToolCall,\n  TTVoiceMetrics,\n} from \"../../hooks/useThinkerTalkerSession\";\nimport { CompactVoiceBar } from \"./CompactVoiceBar\";\nimport { VoiceExpandedDrawer } from \"./VoiceExpandedDrawer\";\nimport { VoiceModeSettings } from \"./VoiceModeSettings\";\nimport { EmotionIndicator } from \"./EmotionIndicator\";\nimport { useVoiceSettingsStore } from \"../../stores/voiceSettingsStore\";\n\n// ============================================================================\n// Types\n// ============================================================================\n\nexport interface ThinkerTalkerVoicePanelProps {\n  /** Conversation ID for context */\n  conversationId?: string;\n  /** Called when panel should close */\n  onClose?: () => void;\n  /** Called when user transcript is received */\n  onUserMessage?: (content: string) => void;\n  /** Called when AI response is received */\n  onAssistantMessage?: (content: string) => void;\n  /** Called when metrics are updated */\n  onMetricsUpdate?: (metrics: TTVoiceMetrics) => void;\n}\n\n// ============================================================================\n// Main Component\n// ============================================================================\n\nexport function ThinkerTalkerVoicePanel({\n  conversationId,\n  onClose,\n  onUserMessage,\n  onAssistantMessage,\n  onMetricsUpdate,\n}: ThinkerTalkerVoicePanelProps) {\n  const [isExpanded, setIsExpanded] = useState(false);\n  const [showSettings, setShowSettings] = useState(false);\n\n  // Voice settings from store\n  const { elevenlabsVoiceId, language, vadSensitivity } =\n    useVoiceSettingsStore();\n\n  // T/T Voice Mode hook\n  const voiceMode = useThinkerTalkerVoiceMode({\n    conversation_id: conversationId,\n    voiceSettings: {\n      voice_id: elevenlabsVoiceId || \"TxGEqnHWrfWFTfGW9XjX\", // Josh as default\n      language,\n      barge_in_enabled: true,\n      vad_sensitivity: vadSensitivity, // 0-100 from settings\n    },\n    onUserTranscript: (text, isFinal) => {\n      if (isFinal) {\n        onUserMessage?.(text);\n      }\n    },\n    onAIResponse: (text, isFinal) => {\n      if (isFinal) {\n        onAssistantMessage?.(text);\n      }\n    },\n    onToolCall: (toolCall: TTToolCall) => {\n      console.log(\"[ThinkerTalkerVoicePanel] Tool call:\", toolCall.name);\n    },\n    onMetricsUpdate: (metrics: TTVoiceMetrics) => {\n      onMetricsUpdate?.(metrics);\n    },\n  });\n\n  // Map metrics to VoiceMetrics format for the drawer\n  const mappedMetrics = {\n    connectionTimeMs: voiceMode.metrics.connectionTimeMs,\n    timeToFirstTranscriptMs: voiceMode.metrics.sttLatencyMs,\n    lastSttLatencyMs: voiceMode.metrics.sttLatencyMs,\n    lastResponseLatencyMs: voiceMode.metrics.totalLatencyMs,\n    sessionDurationMs: voiceMode.metrics.sessionDurationMs,\n    userTranscriptCount: voiceMode.metrics.userUtteranceCount,\n    aiResponseCount: voiceMode.metrics.aiResponseCount,\n    reconnectCount: voiceMode.metrics.reconnectCount,\n    sessionStartedAt: voiceMode.metrics.sessionStartedAt,\n  };\n\n  // Handle close - disconnect if connected\n  const handleClose = useCallback(() => {\n    if (voiceMode.isConnected) {\n      voiceMode.disconnect();\n    }\n    onClose?.();\n  }, [voiceMode, onClose]);\n\n  return (\n    <div data-testid=\"thinker-talker-voice-panel\">\n      {/* Expanded drawer (slides up above compact bar) */}\n      <VoiceExpandedDrawer\n        isOpen={isExpanded}\n        onCollapse={() => setIsExpanded(false)}\n        metrics={mappedMetrics}\n        isConnected={voiceMode.isConnected}\n        toolCalls={voiceMode.currentToolCalls}\n        error={voiceMode.error}\n        onDismissError={voiceMode.resetError}\n        ttfaMs={voiceMode.ttfaMs}\n      />\n\n      {/* Phase 1: Emotion indicator (floats above compact bar when emotion detected) */}\n      {voiceMode.isConnected && voiceMode.currentEmotion && (\n        <div className=\"absolute bottom-24 right-4 z-10\">\n          <EmotionIndicator\n            emotion={voiceMode.currentEmotion}\n            size=\"sm\"\n            showDetails={false}\n          />\n        </div>\n      )}\n\n      {/* Compact bar (always visible) */}\n      <CompactVoiceBar\n        isConnected={voiceMode.isConnected}\n        isConnecting={voiceMode.isConnecting}\n        isListening={voiceMode.isListening}\n        isPlaying={voiceMode.isPlaying}\n        isMicPermissionDenied={voiceMode.isMicPermissionDenied}\n        pipelineState={voiceMode.pipelineState}\n        partialTranscript={voiceMode.partialTranscript}\n        currentToolCalls={voiceMode.currentToolCalls}\n        latencyMs={voiceMode.metrics.totalLatencyMs}\n        onConnect={voiceMode.connect}\n        onDisconnect={voiceMode.disconnect}\n        onBargeIn={voiceMode.bargeIn}\n        onExpand={() => setIsExpanded(true)}\n        onClose={handleClose}\n        onOpenSettings={() => {\n          console.log(\n            \"[ThinkerTalkerVoicePanel] Settings button clicked, setting showSettings to true\",\n          );\n          setShowSettings(true);\n        }}\n      />\n\n      {/* Settings Modal */}\n      <VoiceModeSettings\n        isOpen={showSettings}\n        onClose={() => setShowSettings(false)}\n      />\n    </div>\n  );\n}\n\nexport default ThinkerTalkerVoicePanel;\n"
}

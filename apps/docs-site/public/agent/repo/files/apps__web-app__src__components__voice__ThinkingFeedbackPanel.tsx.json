{
  "path": "apps/web-app/src/components/voice/ThinkingFeedbackPanel.tsx",
  "language": "typescript",
  "size": 10259,
  "last_modified": "2025-12-04T18:47:50.950Z",
  "lines": 335,
  "content": "/**\n * ThinkingFeedbackPanel Component\n * Unified thinking feedback with audio, visual, and haptic options.\n *\n * Part of Voice Mode Enhancement Plan v4.1\n * Reference: /home/asimo/.claude/plans/noble-bubbling-trinket.md#thinking-tone-ux-improvements\n */\n\nimport React, { useEffect, useCallback } from \"react\";\nimport { useVoiceSettingsStore } from \"@/stores/voiceSettingsStore\";\nimport { useThinkingTone } from \"@/hooks/useThinkingTone\";\nimport { ThinkingVisualIndicator } from \"./ThinkingVisualIndicator\";\n\ninterface ThinkingFeedbackPanelProps {\n  isThinking: boolean;\n  className?: string;\n  showLabel?: boolean;\n  label?: string;\n  isTTSPlaying?: boolean; // Don't clash with TTS audio\n  size?: \"sm\" | \"md\" | \"lg\";\n}\n\n// Haptic patterns for mobile devices\nconst HAPTIC_PATTERNS: Record<\"gentle\" | \"rhythmic\" | \"none\", number[]> = {\n  gentle: [50], // Single gentle pulse\n  rhythmic: [50, 100, 50], // Rhythmic pattern\n  none: [],\n};\n\n/**\n * Check if device supports haptic feedback\n */\nfunction useHapticSupport(): boolean {\n  const [supported, setSupported] = React.useState(false);\n\n  useEffect(() => {\n    setSupported(typeof navigator !== \"undefined\" && \"vibrate\" in navigator);\n  }, []);\n\n  return supported;\n}\n\n/**\n * Check if we're on a mobile device\n */\nfunction useIsMobile(): boolean {\n  const [isMobile, setIsMobile] = React.useState(false);\n\n  useEffect(() => {\n    const checkMobile = () => {\n      setIsMobile(\n        /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(\n          navigator.userAgent,\n        ) || window.matchMedia(\"(max-width: 768px)\").matches,\n      );\n    };\n\n    checkMobile();\n    window.addEventListener(\"resize\", checkMobile);\n    return () => window.removeEventListener(\"resize\", checkMobile);\n  }, []);\n\n  return isMobile;\n}\n\n/**\n * ThinkingFeedbackPanel\n *\n * Provides unified thinking feedback through multiple modalities:\n * - Audio: Configurable tones (gentle beep, soft chime, subtle tick)\n * - Visual: Animated indicators (dots, pulse, spinner, progress)\n * - Haptic: Vibration patterns for mobile devices\n *\n * Respects user preferences and avoids conflicts with TTS playback.\n */\nexport function ThinkingFeedbackPanel({\n  isThinking,\n  className = \"\",\n  showLabel = false,\n  label = \"Thinking...\",\n  isTTSPlaying = false,\n  size = \"md\",\n}: ThinkingFeedbackPanelProps) {\n  const settings = useVoiceSettingsStore();\n  const isMobile = useIsMobile();\n  const hapticSupported = useHapticSupport();\n\n  // Determine if audio should play (enabled and not clashing with TTS)\n  const shouldPlayAudio =\n    settings.thinkingToneEnabled && !isTTSPlaying && isThinking;\n\n  // Audio feedback using the hook\n  useThinkingTone(shouldPlayAudio, {\n    preset: settings.thinkingTonePreset,\n    volume: settings.thinkingToneVolume / 100, // Normalize to 0-1\n  });\n\n  // Haptic feedback for mobile devices\n  const triggerHaptic = useCallback(() => {\n    if (\n      !hapticSupported ||\n      !settings.thinkingHapticEnabled ||\n      settings.thinkingHapticPattern === \"none\"\n    ) {\n      return;\n    }\n\n    const pattern = HAPTIC_PATTERNS[settings.thinkingHapticPattern];\n    if (pattern.length > 0) {\n      try {\n        navigator.vibrate(pattern);\n      } catch (error) {\n        console.warn(\"Haptic feedback failed:\", error);\n      }\n    }\n  }, [\n    hapticSupported,\n    settings.thinkingHapticEnabled,\n    settings.thinkingHapticPattern,\n  ]);\n\n  // Trigger haptic feedback periodically while thinking\n  useEffect(() => {\n    if (!isThinking || !isMobile || !settings.thinkingHapticEnabled) {\n      return;\n    }\n\n    // Initial haptic\n    triggerHaptic();\n\n    // Periodic haptics every 2 seconds\n    const interval = setInterval(triggerHaptic, 2000);\n\n    return () => {\n      clearInterval(interval);\n      // Stop any ongoing vibration\n      if (hapticSupported) {\n        try {\n          navigator.vibrate(0);\n        } catch {\n          // Ignore errors\n        }\n      }\n    };\n  }, [\n    isThinking,\n    isMobile,\n    settings.thinkingHapticEnabled,\n    triggerHaptic,\n    hapticSupported,\n  ]);\n\n  // Don't render visual if disabled or not thinking\n  if (!settings.thinkingVisualEnabled || !isThinking) {\n    return null;\n  }\n\n  return (\n    <div\n      className={`flex items-center gap-2 ${className}`}\n      role=\"status\"\n      aria-live=\"polite\"\n      aria-label={label}\n    >\n      <ThinkingVisualIndicator\n        style={settings.thinkingVisualStyle}\n        size={size}\n        color=\"currentColor\"\n      />\n\n      {showLabel && (\n        <span className=\"text-sm text-neutral-500 dark:text-neutral-400\">\n          {label}\n        </span>\n      )}\n    </div>\n  );\n}\n\n/**\n * ThinkingFeedbackSettings - Settings panel for thinking feedback\n */\ninterface ThinkingFeedbackSettingsProps {\n  className?: string;\n}\n\nexport function ThinkingFeedbackSettings({\n  className = \"\",\n}: ThinkingFeedbackSettingsProps) {\n  const settings = useVoiceSettingsStore();\n  const isMobile = useIsMobile();\n\n  return (\n    <div className={`space-y-4 ${className}`}>\n      <h3 className=\"text-sm font-medium text-neutral-900 dark:text-neutral-100\">\n        Thinking Feedback\n      </h3>\n\n      {/* Audio Settings */}\n      <div className=\"space-y-3\">\n        <label className=\"flex items-center justify-between\">\n          <span className=\"text-sm text-neutral-700 dark:text-neutral-300\">\n            Play sound while thinking\n          </span>\n          <input\n            type=\"checkbox\"\n            checked={settings.thinkingToneEnabled}\n            onChange={(e) => settings.setThinkingToneEnabled(e.target.checked)}\n            className=\"rounded border-neutral-300 text-indigo-600 focus:ring-indigo-500\"\n          />\n        </label>\n\n        {settings.thinkingToneEnabled && (\n          <>\n            <div>\n              <label className=\"block text-sm text-neutral-600 dark:text-neutral-400 mb-1\">\n                Sound style\n              </label>\n              <select\n                value={settings.thinkingTonePreset}\n                onChange={(e) =>\n                  settings.setThinkingTonePreset(\n                    e.target.value as typeof settings.thinkingTonePreset,\n                  )\n                }\n                className=\"w-full rounded-md border-neutral-300 dark:border-neutral-600 bg-white dark:bg-neutral-800 text-sm\"\n              >\n                <option value=\"gentle_beep\">Gentle beep</option>\n                <option value=\"soft_chime\">Soft chime</option>\n                <option value=\"subtle_tick\">Subtle tick</option>\n              </select>\n            </div>\n\n            <div>\n              <label className=\"block text-sm text-neutral-600 dark:text-neutral-400 mb-1\">\n                Volume: {settings.thinkingToneVolume}%\n              </label>\n              <input\n                type=\"range\"\n                min={0}\n                max={100}\n                value={settings.thinkingToneVolume}\n                onChange={(e) =>\n                  settings.setThinkingToneVolume(parseInt(e.target.value, 10))\n                }\n                className=\"w-full\"\n              />\n            </div>\n          </>\n        )}\n      </div>\n\n      {/* Visual Settings */}\n      <div className=\"space-y-3 pt-3 border-t border-neutral-200 dark:border-neutral-700\">\n        <label className=\"flex items-center justify-between\">\n          <span className=\"text-sm text-neutral-700 dark:text-neutral-300\">\n            Show visual indicator\n          </span>\n          <input\n            type=\"checkbox\"\n            checked={settings.thinkingVisualEnabled}\n            onChange={(e) =>\n              settings.setThinkingVisualEnabled(e.target.checked)\n            }\n            className=\"rounded border-neutral-300 text-indigo-600 focus:ring-indigo-500\"\n          />\n        </label>\n\n        {settings.thinkingVisualEnabled && (\n          <div>\n            <label className=\"block text-sm text-neutral-600 dark:text-neutral-400 mb-1\">\n              Visual style\n            </label>\n            <select\n              value={settings.thinkingVisualStyle}\n              onChange={(e) =>\n                settings.setThinkingVisualStyle(\n                  e.target.value as typeof settings.thinkingVisualStyle,\n                )\n              }\n              className=\"w-full rounded-md border-neutral-300 dark:border-neutral-600 bg-white dark:bg-neutral-800 text-sm\"\n            >\n              <option value=\"dots\">Animated dots</option>\n              <option value=\"pulse\">Pulsing circle</option>\n              <option value=\"spinner\">Spinner</option>\n              <option value=\"progress\">Progress bar</option>\n            </select>\n          </div>\n        )}\n      </div>\n\n      {/* Haptic Settings (mobile only) */}\n      {isMobile && (\n        <div className=\"space-y-3 pt-3 border-t border-neutral-200 dark:border-neutral-700\">\n          <label className=\"flex items-center justify-between\">\n            <span className=\"text-sm text-neutral-700 dark:text-neutral-300\">\n              Vibrate while thinking\n            </span>\n            <input\n              type=\"checkbox\"\n              checked={settings.thinkingHapticEnabled}\n              onChange={(e) =>\n                settings.setThinkingHapticEnabled(e.target.checked)\n              }\n              className=\"rounded border-neutral-300 text-indigo-600 focus:ring-indigo-500\"\n            />\n          </label>\n\n          {settings.thinkingHapticEnabled && (\n            <div>\n              <label className=\"block text-sm text-neutral-600 dark:text-neutral-400 mb-1\">\n                Vibration pattern\n              </label>\n              <select\n                value={settings.thinkingHapticPattern}\n                onChange={(e) =>\n                  settings.setThinkingHapticPattern(\n                    e.target.value as typeof settings.thinkingHapticPattern,\n                  )\n                }\n                className=\"w-full rounded-md border-neutral-300 dark:border-neutral-600 bg-white dark:bg-neutral-800 text-sm\"\n              >\n                <option value=\"gentle\">Gentle pulse</option>\n                <option value=\"rhythmic\">Rhythmic</option>\n              </select>\n            </div>\n          )}\n        </div>\n      )}\n    </div>\n  );\n}\n\nexport default ThinkingFeedbackPanel;\n"
}

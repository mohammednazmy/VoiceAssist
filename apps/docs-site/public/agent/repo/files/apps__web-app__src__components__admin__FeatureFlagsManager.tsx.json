{
  "path": "apps/web-app/src/components/admin/FeatureFlagsManager.tsx",
  "language": "typescript",
  "size": 21732,
  "last_modified": "2025-11-27T06:44:49.506Z",
  "lines": 547,
  "content": "/**\n * Feature Flags Manager\n * Admin panel for managing feature flags and rollouts\n *\n * Phase 8.3: Full CRUD operations for feature flags\n */\n\nimport { useState, useEffect, useCallback } from \"react\";\nimport {\n  getDefaultAdminApi,\n  type FeatureFlag,\n  type CreateFeatureFlagRequest,\n} from \"../../lib/api/adminApi\";\n\ninterface CreateFlagFormState {\n  name: string;\n  description: string;\n  enabled: boolean;\n  rollout_percentage: number;\n  user_groups: string;\n}\n\nconst initialFormState: CreateFlagFormState = {\n  name: \"\",\n  description: \"\",\n  enabled: false,\n  rollout_percentage: 100,\n  user_groups: \"\",\n};\n\nexport function FeatureFlagsManager() {\n  const [flags, setFlags] = useState<FeatureFlag[]>([]);\n  const [isLoading, setIsLoading] = useState(true);\n  const [error, setError] = useState<string | null>(null);\n  const [showCreateForm, setShowCreateForm] = useState(false);\n  const [formState, setFormState] =\n    useState<CreateFlagFormState>(initialFormState);\n  const [isSubmitting, setIsSubmitting] = useState(false);\n  const [editingFlag, setEditingFlag] = useState<string | null>(null);\n  const [deleteConfirm, setDeleteConfirm] = useState<string | null>(null);\n\n  const loadFlags = useCallback(async () => {\n    try {\n      setError(null);\n      const adminApi = getDefaultAdminApi();\n      const data = await adminApi.getFeatureFlags();\n      setFlags(data);\n      setIsLoading(false);\n    } catch (err) {\n      console.error(\"Failed to load feature flags:\", err);\n      setError(\n        err instanceof Error ? err.message : \"Failed to load feature flags\",\n      );\n      setIsLoading(false);\n    }\n  }, []);\n\n  useEffect(() => {\n    loadFlags();\n  }, [loadFlags]);\n\n  const handleToggle = async (flagName: string) => {\n    try {\n      const adminApi = getDefaultAdminApi();\n      const updatedFlag = await adminApi.toggleFeatureFlag(flagName);\n      setFlags((prev) =>\n        prev.map((f) => (f.name === flagName ? updatedFlag : f)),\n      );\n    } catch (err) {\n      console.error(\"Failed to toggle flag:\", err);\n      setError(err instanceof Error ? err.message : \"Failed to toggle flag\");\n    }\n  };\n\n  const handleCreate = async (e: React.FormEvent) => {\n    e.preventDefault();\n    setIsSubmitting(true);\n    setError(null);\n\n    try {\n      const adminApi = getDefaultAdminApi();\n      const request: CreateFeatureFlagRequest = {\n        name: formState.name.trim().toLowerCase().replace(/\\s+/g, \"_\"),\n        description: formState.description,\n        enabled: formState.enabled,\n        rollout_percentage: formState.rollout_percentage,\n        user_groups: formState.user_groups\n          ? formState.user_groups.split(\",\").map((g) => g.trim())\n          : undefined,\n      };\n\n      const newFlag = await adminApi.createFeatureFlag(request);\n      setFlags((prev) => [...prev, newFlag]);\n      setFormState(initialFormState);\n      setShowCreateForm(false);\n    } catch (err) {\n      console.error(\"Failed to create flag:\", err);\n      setError(err instanceof Error ? err.message : \"Failed to create flag\");\n    } finally {\n      setIsSubmitting(false);\n    }\n  };\n\n  const handleDelete = async (flagName: string) => {\n    try {\n      const adminApi = getDefaultAdminApi();\n      await adminApi.deleteFeatureFlag(flagName);\n      setFlags((prev) => prev.filter((f) => f.name !== flagName));\n      setDeleteConfirm(null);\n    } catch (err) {\n      console.error(\"Failed to delete flag:\", err);\n      setError(err instanceof Error ? err.message : \"Failed to delete flag\");\n    }\n  };\n\n  const handleUpdateRollout = async (flagName: string, percentage: number) => {\n    try {\n      const adminApi = getDefaultAdminApi();\n      const updatedFlag = await adminApi.updateFeatureFlag(flagName, {\n        rollout_percentage: percentage,\n      });\n      setFlags((prev) =>\n        prev.map((f) => (f.name === flagName ? updatedFlag : f)),\n      );\n      setEditingFlag(null);\n    } catch (err) {\n      console.error(\"Failed to update rollout:\", err);\n      setError(err instanceof Error ? err.message : \"Failed to update rollout\");\n    }\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center justify-center h-full p-6\">\n        <div className=\"text-center\">\n          <div className=\"w-12 h-12 mx-auto mb-4 rounded-full border-4 border-primary-500 border-t-transparent animate-spin\" />\n          <p className=\"text-neutral-600\">Loading feature flags...</p>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      {/* Error Banner */}\n      {error && (\n        <div className=\"bg-red-50 border border-red-200 rounded-lg p-4 flex items-center justify-between\">\n          <div className=\"flex items-center space-x-3\">\n            <svg\n              xmlns=\"http://www.w3.org/2000/svg\"\n              fill=\"none\"\n              viewBox=\"0 0 24 24\"\n              strokeWidth={2}\n              stroke=\"currentColor\"\n              className=\"w-5 h-5 text-red-600\"\n            >\n              <path\n                strokeLinecap=\"round\"\n                strokeLinejoin=\"round\"\n                d=\"M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z\"\n              />\n            </svg>\n            <span className=\"text-sm text-red-700\">{error}</span>\n          </div>\n          <button\n            onClick={() => setError(null)}\n            className=\"text-red-600 hover:text-red-800\"\n          >\n            <svg\n              xmlns=\"http://www.w3.org/2000/svg\"\n              fill=\"none\"\n              viewBox=\"0 0 24 24\"\n              strokeWidth={2}\n              stroke=\"currentColor\"\n              className=\"w-5 h-5\"\n            >\n              <path\n                strokeLinecap=\"round\"\n                strokeLinejoin=\"round\"\n                d=\"M6 18L18 6M6 6l12 12\"\n              />\n            </svg>\n          </button>\n        </div>\n      )}\n\n      {/* Header */}\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-2xl font-bold text-neutral-900\">Feature Flags</h1>\n          <p className=\"text-sm text-neutral-600\">\n            Manage feature rollouts and A/B testing\n          </p>\n        </div>\n        <div className=\"flex items-center space-x-3\">\n          <button\n            onClick={loadFlags}\n            className=\"flex items-center space-x-2 px-4 py-2 text-sm font-medium text-neutral-700 bg-white border border-neutral-300 rounded-md hover:bg-neutral-50 transition-colors\"\n          >\n            <svg\n              xmlns=\"http://www.w3.org/2000/svg\"\n              fill=\"none\"\n              viewBox=\"0 0 24 24\"\n              strokeWidth={2}\n              stroke=\"currentColor\"\n              className=\"w-4 h-4\"\n            >\n              <path\n                strokeLinecap=\"round\"\n                strokeLinejoin=\"round\"\n                d=\"M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99\"\n              />\n            </svg>\n            <span>Refresh</span>\n          </button>\n          <button\n            onClick={() => setShowCreateForm(true)}\n            className=\"flex items-center space-x-2 px-4 py-2 text-sm font-medium text-white bg-primary-600 rounded-md hover:bg-primary-700 transition-colors\"\n          >\n            <svg\n              xmlns=\"http://www.w3.org/2000/svg\"\n              fill=\"none\"\n              viewBox=\"0 0 24 24\"\n              strokeWidth={2}\n              stroke=\"currentColor\"\n              className=\"w-4 h-4\"\n            >\n              <path\n                strokeLinecap=\"round\"\n                strokeLinejoin=\"round\"\n                d=\"M12 4.5v15m7.5-7.5h-15\"\n              />\n            </svg>\n            <span>Create Flag</span>\n          </button>\n        </div>\n      </div>\n\n      {/* Create Form Modal */}\n      {showCreateForm && (\n        <div className=\"fixed inset-0 bg-black/50 flex items-center justify-center z-50\">\n          <div className=\"bg-white rounded-lg shadow-xl max-w-md w-full mx-4\">\n            <div className=\"p-6 border-b border-neutral-200\">\n              <h2 className=\"text-lg font-semibold text-neutral-900\">\n                Create Feature Flag\n              </h2>\n            </div>\n            <form onSubmit={handleCreate} className=\"p-6 space-y-4\">\n              <div>\n                <label className=\"block text-sm font-medium text-neutral-700 mb-1\">\n                  Flag Name\n                </label>\n                <input\n                  type=\"text\"\n                  value={formState.name}\n                  onChange={(e) =>\n                    setFormState((prev) => ({ ...prev, name: e.target.value }))\n                  }\n                  placeholder=\"e.g., new_voice_mode\"\n                  className=\"w-full px-3 py-2 border border-neutral-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500\"\n                  required\n                />\n              </div>\n              <div>\n                <label className=\"block text-sm font-medium text-neutral-700 mb-1\">\n                  Description\n                </label>\n                <textarea\n                  value={formState.description}\n                  onChange={(e) =>\n                    setFormState((prev) => ({\n                      ...prev,\n                      description: e.target.value,\n                    }))\n                  }\n                  placeholder=\"Describe what this flag controls...\"\n                  rows={3}\n                  className=\"w-full px-3 py-2 border border-neutral-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500\"\n                  required\n                />\n              </div>\n              <div className=\"flex items-center space-x-3\">\n                <input\n                  type=\"checkbox\"\n                  id=\"enabled\"\n                  checked={formState.enabled}\n                  onChange={(e) =>\n                    setFormState((prev) => ({\n                      ...prev,\n                      enabled: e.target.checked,\n                    }))\n                  }\n                  className=\"w-4 h-4 text-primary-600 border-neutral-300 rounded focus:ring-primary-500\"\n                />\n                <label htmlFor=\"enabled\" className=\"text-sm text-neutral-700\">\n                  Enable flag on creation\n                </label>\n              </div>\n              <div>\n                <label className=\"block text-sm font-medium text-neutral-700 mb-1\">\n                  Rollout Percentage\n                </label>\n                <input\n                  type=\"number\"\n                  min=\"0\"\n                  max=\"100\"\n                  value={formState.rollout_percentage}\n                  onChange={(e) =>\n                    setFormState((prev) => ({\n                      ...prev,\n                      rollout_percentage: parseInt(e.target.value) || 0,\n                    }))\n                  }\n                  className=\"w-full px-3 py-2 border border-neutral-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500\"\n                />\n              </div>\n              <div>\n                <label className=\"block text-sm font-medium text-neutral-700 mb-1\">\n                  User Groups (comma-separated)\n                </label>\n                <input\n                  type=\"text\"\n                  value={formState.user_groups}\n                  onChange={(e) =>\n                    setFormState((prev) => ({\n                      ...prev,\n                      user_groups: e.target.value,\n                    }))\n                  }\n                  placeholder=\"e.g., beta_testers, admins\"\n                  className=\"w-full px-3 py-2 border border-neutral-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500\"\n                />\n              </div>\n              <div className=\"flex justify-end space-x-3 pt-4\">\n                <button\n                  type=\"button\"\n                  onClick={() => {\n                    setShowCreateForm(false);\n                    setFormState(initialFormState);\n                  }}\n                  className=\"px-4 py-2 text-sm font-medium text-neutral-700 bg-white border border-neutral-300 rounded-md hover:bg-neutral-50\"\n                >\n                  Cancel\n                </button>\n                <button\n                  type=\"submit\"\n                  disabled={isSubmitting}\n                  className=\"px-4 py-2 text-sm font-medium text-white bg-primary-600 rounded-md hover:bg-primary-700 disabled:opacity-50\"\n                >\n                  {isSubmitting ? \"Creating...\" : \"Create Flag\"}\n                </button>\n              </div>\n            </form>\n          </div>\n        </div>\n      )}\n\n      {/* Delete Confirmation Modal */}\n      {deleteConfirm && (\n        <div className=\"fixed inset-0 bg-black/50 flex items-center justify-center z-50\">\n          <div className=\"bg-white rounded-lg shadow-xl max-w-sm w-full mx-4 p-6\">\n            <h3 className=\"text-lg font-semibold text-neutral-900 mb-2\">\n              Delete Feature Flag?\n            </h3>\n            <p className=\"text-sm text-neutral-600 mb-4\">\n              Are you sure you want to delete{\" \"}\n              <span className=\"font-mono font-medium\">{deleteConfirm}</span>?\n              This action cannot be undone.\n            </p>\n            <div className=\"flex justify-end space-x-3\">\n              <button\n                onClick={() => setDeleteConfirm(null)}\n                className=\"px-4 py-2 text-sm font-medium text-neutral-700 bg-white border border-neutral-300 rounded-md hover:bg-neutral-50\"\n              >\n                Cancel\n              </button>\n              <button\n                onClick={() => handleDelete(deleteConfirm)}\n                className=\"px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700\"\n              >\n                Delete\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Flags Table */}\n      <div className=\"bg-white rounded-lg shadow overflow-hidden\">\n        <table className=\"min-w-full divide-y divide-neutral-200\">\n          <thead className=\"bg-neutral-50\">\n            <tr>\n              <th className=\"px-6 py-3 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider\">\n                Flag Name\n              </th>\n              <th className=\"px-6 py-3 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider\">\n                Status\n              </th>\n              <th className=\"px-6 py-3 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider\">\n                Rollout\n              </th>\n              <th className=\"px-6 py-3 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider\">\n                Description\n              </th>\n              <th className=\"px-6 py-3 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider\">\n                Updated\n              </th>\n              <th className=\"px-6 py-3 text-right text-xs font-medium text-neutral-500 uppercase tracking-wider\">\n                Actions\n              </th>\n            </tr>\n          </thead>\n          <tbody className=\"bg-white divide-y divide-neutral-200\">\n            {flags.length === 0 ? (\n              <tr>\n                <td colSpan={6} className=\"px-6 py-12 text-center\">\n                  <svg\n                    xmlns=\"http://www.w3.org/2000/svg\"\n                    fill=\"none\"\n                    viewBox=\"0 0 24 24\"\n                    strokeWidth={1.5}\n                    stroke=\"currentColor\"\n                    className=\"w-12 h-12 mx-auto text-neutral-400 mb-3\"\n                  >\n                    <path\n                      strokeLinecap=\"round\"\n                      strokeLinejoin=\"round\"\n                      d=\"M3 3v1.5M3 21v-6m0 0l2.77-.693a9 9 0 016.208.682l.108.054a9 9 0 006.086.71l3.114-.732a48.524 48.524 0 01-.005-10.499l-3.11.732a9 9 0 01-6.085-.711l-.108-.054a9 9 0 00-6.208-.682L3 4.5M3 15V4.5\"\n                    />\n                  </svg>\n                  <p className=\"text-neutral-500\">\n                    No feature flags configured\n                  </p>\n                  <p className=\"text-sm text-neutral-400 mt-1\">\n                    Create your first flag to get started\n                  </p>\n                </td>\n              </tr>\n            ) : (\n              flags.map((flag) => (\n                <tr key={flag.name} className=\"hover:bg-neutral-50\">\n                  <td className=\"px-6 py-4 whitespace-nowrap\">\n                    <span className=\"font-mono text-sm text-neutral-900\">\n                      {flag.name}\n                    </span>\n                    {flag.user_groups && flag.user_groups.length > 0 && (\n                      <div className=\"flex flex-wrap gap-1 mt-1\">\n                        {flag.user_groups.map((group) => (\n                          <span\n                            key={group}\n                            className=\"inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800\"\n                          >\n                            {group}\n                          </span>\n                        ))}\n                      </div>\n                    )}\n                  </td>\n                  <td className=\"px-6 py-4 whitespace-nowrap\">\n                    <button\n                      onClick={() => handleToggle(flag.name)}\n                      className={`relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 ${\n                        flag.enabled ? \"bg-primary-600\" : \"bg-neutral-200\"\n                      }`}\n                    >\n                      <span\n                        className={`pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out ${\n                          flag.enabled ? \"translate-x-5\" : \"translate-x-0\"\n                        }`}\n                      />\n                    </button>\n                  </td>\n                  <td className=\"px-6 py-4 whitespace-nowrap\">\n                    {editingFlag === flag.name ? (\n                      <div className=\"flex items-center space-x-2\">\n                        <input\n                          type=\"number\"\n                          min=\"0\"\n                          max=\"100\"\n                          defaultValue={flag.rollout_percentage || 100}\n                          className=\"w-20 px-2 py-1 text-sm border border-neutral-300 rounded focus:outline-none focus:ring-1 focus:ring-primary-500\"\n                          onKeyDown={(e) => {\n                            if (e.key === \"Enter\") {\n                              handleUpdateRollout(\n                                flag.name,\n                                parseInt(\n                                  (e.target as HTMLInputElement).value,\n                                ) || 0,\n                              );\n                            }\n                            if (e.key === \"Escape\") {\n                              setEditingFlag(null);\n                            }\n                          }}\n                          autoFocus\n                        />\n                        <span className=\"text-sm text-neutral-500\">%</span>\n                      </div>\n                    ) : (\n                      <button\n                        onClick={() => setEditingFlag(flag.name)}\n                        className=\"text-sm text-neutral-700 hover:text-primary-600\"\n                      >\n                        {flag.rollout_percentage ?? 100}%\n                      </button>\n                    )}\n                  </td>\n                  <td className=\"px-6 py-4\">\n                    <p className=\"text-sm text-neutral-600 max-w-xs truncate\">\n                      {flag.description}\n                    </p>\n                  </td>\n                  <td className=\"px-6 py-4 whitespace-nowrap text-sm text-neutral-500\">\n                    {new Date(flag.updated_at).toLocaleDateString()}\n                  </td>\n                  <td className=\"px-6 py-4 whitespace-nowrap text-right\">\n                    <button\n                      onClick={() => setDeleteConfirm(flag.name)}\n                      className=\"text-red-600 hover:text-red-800\"\n                      title=\"Delete flag\"\n                    >\n                      <svg\n                        xmlns=\"http://www.w3.org/2000/svg\"\n                        fill=\"none\"\n                        viewBox=\"0 0 24 24\"\n                        strokeWidth={2}\n                        stroke=\"currentColor\"\n                        className=\"w-5 h-5\"\n                      >\n                        <path\n                          strokeLinecap=\"round\"\n                          strokeLinejoin=\"round\"\n                          d=\"M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0\"\n                        />\n                      </svg>\n                    </button>\n                  </td>\n                </tr>\n              ))\n            )}\n          </tbody>\n        </table>\n      </div>\n    </div>\n  );\n}\n"
}

{
  "path": "apps/web-app/src/components/layout/AnalyticsOptInLayout.tsx",
  "language": "typescript",
  "size": 2684,
  "last_modified": "2025-11-29T09:47:34.301Z",
  "lines": 111,
  "content": "import {\n  createContext,\n  useContext,\n  useEffect,\n  useMemo,\n  useState,\n  type ReactNode,\n} from \"react\";\nimport { AnalyticsProvider, type AnalyticsConfig } from \"../../lib/analytics\";\n\ntype ConsentState = \"pending\" | \"granted\" | \"denied\";\n\ninterface AnalyticsConsentContextValue {\n  consent: ConsentState;\n  showNotice: boolean;\n  setShowNotice: (show: boolean) => void;\n  handleGrant: () => void;\n  handleDeny: () => void;\n}\n\nconst AnalyticsConsentContext =\n  createContext<AnalyticsConsentContextValue | null>(null);\n\nexport function useAnalyticsConsent() {\n  const context = useContext(AnalyticsConsentContext);\n  if (!context) {\n    throw new Error(\n      \"useAnalyticsConsent must be used within AnalyticsOptInLayout\",\n    );\n  }\n  return context;\n}\n\ninterface AnalyticsOptInLayoutProps {\n  children: ReactNode;\n  config: AnalyticsConfig;\n}\n\nconst STORAGE_KEY = \"voiceassist_analytics_consent\";\n\n/**\n * Privacy-first analytics wrapper that only enables analytics\n * after the user opts in. Consent is stored locally so the\n * choice persists between sessions.\n *\n * UI is rendered separately via AnalyticsConsentUI component\n * which should be placed inside the Router.\n */\nexport function AnalyticsOptInLayout({\n  children,\n  config,\n}: AnalyticsOptInLayoutProps) {\n  const [consent, setConsent] = useState<ConsentState>(\"pending\");\n  const [showNotice, setShowNotice] = useState(true);\n\n  // Hydrate consent state from storage\n  useEffect(() => {\n    if (typeof window === \"undefined\") return;\n\n    const stored = window.localStorage.getItem(\n      STORAGE_KEY,\n    ) as ConsentState | null;\n\n    if (stored === \"granted\" || stored === \"denied\") {\n      setConsent(stored);\n      setShowNotice(false);\n    }\n  }, []);\n\n  // Persist consent decisions\n  useEffect(() => {\n    if (typeof window === \"undefined\") return;\n\n    if (consent !== \"pending\") {\n      window.localStorage.setItem(STORAGE_KEY, consent);\n    }\n  }, [consent]);\n\n  const handleGrant = () => {\n    setConsent(\"granted\");\n    setShowNotice(false);\n  };\n\n  const handleDeny = () => {\n    setConsent(\"denied\");\n    setShowNotice(false);\n  };\n\n  const contextValue = useMemo(\n    () => ({\n      consent,\n      showNotice,\n      setShowNotice,\n      handleGrant,\n      handleDeny,\n    }),\n    [consent, showNotice],\n  );\n\n  const analyticsTree = useMemo(() => {\n    if (consent !== \"granted\") return children;\n    return <AnalyticsProvider config={config}>{children}</AnalyticsProvider>;\n  }, [children, config, consent]);\n\n  return (\n    <AnalyticsConsentContext.Provider value={contextValue}>\n      <div className=\"relative min-h-screen\">{analyticsTree}</div>\n    </AnalyticsConsentContext.Provider>\n  );\n}\n"
}

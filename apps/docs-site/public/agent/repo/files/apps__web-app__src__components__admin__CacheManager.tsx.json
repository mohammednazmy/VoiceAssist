{
  "path": "apps/web-app/src/components/admin/CacheManager.tsx",
  "language": "typescript",
  "size": 17468,
  "last_modified": "2025-11-27T06:44:49.506Z",
  "lines": 479,
  "content": "/**\n * Cache Manager\n * Admin panel for monitoring and managing Redis cache\n *\n * Phase 8.3: Cache statistics, invalidation, and management\n */\n\nimport { useState, useEffect, useCallback } from \"react\";\nimport { getDefaultAdminApi, type CacheStats } from \"../../lib/api/adminApi\";\n\nexport function CacheManager() {\n  const [stats, setStats] = useState<CacheStats | null>(null);\n  const [isLoading, setIsLoading] = useState(true);\n  const [error, setError] = useState<string | null>(null);\n  const [invalidatePattern, setInvalidatePattern] = useState(\"\");\n  const [isClearing, setIsClearing] = useState(false);\n  const [isInvalidating, setIsInvalidating] = useState(false);\n  const [lastAction, setLastAction] = useState<{\n    type: \"clear\" | \"invalidate\";\n    result: string;\n  } | null>(null);\n\n  const loadStats = useCallback(async () => {\n    try {\n      setError(null);\n      const adminApi = getDefaultAdminApi();\n      const data = await adminApi.getCacheStats();\n      setStats(data);\n      setIsLoading(false);\n    } catch (err) {\n      console.error(\"Failed to load cache stats:\", err);\n      setError(\n        err instanceof Error ? err.message : \"Failed to load cache statistics\",\n      );\n      setIsLoading(false);\n    }\n  }, []);\n\n  useEffect(() => {\n    loadStats();\n    // Auto-refresh every 30 seconds\n    const interval = setInterval(loadStats, 30000);\n    return () => clearInterval(interval);\n  }, [loadStats]);\n\n  const handleClearCache = async () => {\n    if (\n      !confirm(\n        \"Are you sure you want to clear the entire cache? This may temporarily impact performance.\",\n      )\n    ) {\n      return;\n    }\n\n    setIsClearing(true);\n    setError(null);\n    setLastAction(null);\n\n    try {\n      const adminApi = getDefaultAdminApi();\n      const result = await adminApi.clearCache();\n      setLastAction({ type: \"clear\", result: result.message });\n      await loadStats();\n    } catch (err) {\n      console.error(\"Failed to clear cache:\", err);\n      setError(err instanceof Error ? err.message : \"Failed to clear cache\");\n    } finally {\n      setIsClearing(false);\n    }\n  };\n\n  const handleInvalidatePattern = async (e: React.FormEvent) => {\n    e.preventDefault();\n\n    if (!invalidatePattern.trim()) {\n      setError(\"Please enter a pattern to invalidate\");\n      return;\n    }\n\n    setIsInvalidating(true);\n    setError(null);\n    setLastAction(null);\n\n    try {\n      const adminApi = getDefaultAdminApi();\n      const result = await adminApi.invalidateCachePattern(invalidatePattern);\n      setLastAction({\n        type: \"invalidate\",\n        result: `Invalidated ${result.keys_invalidated} keys matching \"${invalidatePattern}\"`,\n      });\n      setInvalidatePattern(\"\");\n      await loadStats();\n    } catch (err) {\n      console.error(\"Failed to invalidate pattern:\", err);\n      setError(\n        err instanceof Error ? err.message : \"Failed to invalidate pattern\",\n      );\n    } finally {\n      setIsInvalidating(false);\n    }\n  };\n\n  const formatUptime = (seconds: number): string => {\n    const days = Math.floor(seconds / 86400);\n    const hours = Math.floor((seconds % 86400) / 3600);\n    const minutes = Math.floor((seconds % 3600) / 60);\n\n    const parts = [];\n    if (days > 0) parts.push(`${days}d`);\n    if (hours > 0) parts.push(`${hours}h`);\n    if (minutes > 0) parts.push(`${minutes}m`);\n\n    return parts.length > 0 ? parts.join(\" \") : \"< 1m\";\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center justify-center h-full p-6\">\n        <div className=\"text-center\">\n          <div className=\"w-12 h-12 mx-auto mb-4 rounded-full border-4 border-primary-500 border-t-transparent animate-spin\" />\n          <p className=\"text-neutral-600\">Loading cache statistics...</p>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      {/* Error Banner */}\n      {error && (\n        <div className=\"bg-red-50 border border-red-200 rounded-lg p-4 flex items-center justify-between\">\n          <div className=\"flex items-center space-x-3\">\n            <svg\n              xmlns=\"http://www.w3.org/2000/svg\"\n              fill=\"none\"\n              viewBox=\"0 0 24 24\"\n              strokeWidth={2}\n              stroke=\"currentColor\"\n              className=\"w-5 h-5 text-red-600\"\n            >\n              <path\n                strokeLinecap=\"round\"\n                strokeLinejoin=\"round\"\n                d=\"M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z\"\n              />\n            </svg>\n            <span className=\"text-sm text-red-700\">{error}</span>\n          </div>\n          <button\n            onClick={() => setError(null)}\n            className=\"text-red-600 hover:text-red-800\"\n          >\n            <svg\n              xmlns=\"http://www.w3.org/2000/svg\"\n              fill=\"none\"\n              viewBox=\"0 0 24 24\"\n              strokeWidth={2}\n              stroke=\"currentColor\"\n              className=\"w-5 h-5\"\n            >\n              <path\n                strokeLinecap=\"round\"\n                strokeLinejoin=\"round\"\n                d=\"M6 18L18 6M6 6l12 12\"\n              />\n            </svg>\n          </button>\n        </div>\n      )}\n\n      {/* Success Banner */}\n      {lastAction && (\n        <div className=\"bg-green-50 border border-green-200 rounded-lg p-4 flex items-center justify-between\">\n          <div className=\"flex items-center space-x-3\">\n            <svg\n              xmlns=\"http://www.w3.org/2000/svg\"\n              fill=\"none\"\n              viewBox=\"0 0 24 24\"\n              strokeWidth={2}\n              stroke=\"currentColor\"\n              className=\"w-5 h-5 text-green-600\"\n            >\n              <path\n                strokeLinecap=\"round\"\n                strokeLinejoin=\"round\"\n                d=\"M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z\"\n              />\n            </svg>\n            <span className=\"text-sm text-green-700\">{lastAction.result}</span>\n          </div>\n          <button\n            onClick={() => setLastAction(null)}\n            className=\"text-green-600 hover:text-green-800\"\n          >\n            <svg\n              xmlns=\"http://www.w3.org/2000/svg\"\n              fill=\"none\"\n              viewBox=\"0 0 24 24\"\n              strokeWidth={2}\n              stroke=\"currentColor\"\n              className=\"w-5 h-5\"\n            >\n              <path\n                strokeLinecap=\"round\"\n                strokeLinejoin=\"round\"\n                d=\"M6 18L18 6M6 6l12 12\"\n              />\n            </svg>\n          </button>\n        </div>\n      )}\n\n      {/* Header */}\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-2xl font-bold text-neutral-900\">\n            Cache Management\n          </h1>\n          <p className=\"text-sm text-neutral-600\">\n            Monitor and manage Redis cache\n          </p>\n        </div>\n        <button\n          onClick={loadStats}\n          className=\"flex items-center space-x-2 px-4 py-2 text-sm font-medium text-neutral-700 bg-white border border-neutral-300 rounded-md hover:bg-neutral-50 transition-colors\"\n        >\n          <svg\n            xmlns=\"http://www.w3.org/2000/svg\"\n            fill=\"none\"\n            viewBox=\"0 0 24 24\"\n            strokeWidth={2}\n            stroke=\"currentColor\"\n            className=\"w-4 h-4\"\n          >\n            <path\n              strokeLinecap=\"round\"\n              strokeLinejoin=\"round\"\n              d=\"M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99\"\n            />\n          </svg>\n          <span>Refresh</span>\n        </button>\n      </div>\n\n      {/* Stats Grid */}\n      {stats && (\n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6\">\n          {/* Total Keys */}\n          <div className=\"bg-white rounded-lg shadow p-6\">\n            <div className=\"flex items-center justify-between mb-2\">\n              <p className=\"text-sm font-medium text-neutral-600\">Total Keys</p>\n              <svg\n                xmlns=\"http://www.w3.org/2000/svg\"\n                fill=\"none\"\n                viewBox=\"0 0 24 24\"\n                strokeWidth={1.5}\n                stroke=\"currentColor\"\n                className=\"w-6 h-6 text-primary-500\"\n              >\n                <path\n                  strokeLinecap=\"round\"\n                  strokeLinejoin=\"round\"\n                  d=\"M15.75 5.25a3 3 0 013 3m3 0a6 6 0 01-7.029 5.912c-.563-.097-1.159.026-1.563.43L10.5 17.25H8.25v2.25H6v2.25H2.25v-2.818c0-.597.237-1.17.659-1.591l6.499-6.499c.404-.404.527-1 .43-1.563A6 6 0 1121.75 8.25z\"\n                />\n              </svg>\n            </div>\n            <p className=\"text-3xl font-bold text-neutral-900\">\n              {stats.total_keys.toLocaleString()}\n            </p>\n            <p className=\"text-xs text-neutral-500 mt-1\">\n              {stats.connected_clients} connected clients\n            </p>\n          </div>\n\n          {/* Memory Used */}\n          <div className=\"bg-white rounded-lg shadow p-6\">\n            <div className=\"flex items-center justify-between mb-2\">\n              <p className=\"text-sm font-medium text-neutral-600\">\n                Memory Used\n              </p>\n              <svg\n                xmlns=\"http://www.w3.org/2000/svg\"\n                fill=\"none\"\n                viewBox=\"0 0 24 24\"\n                strokeWidth={1.5}\n                stroke=\"currentColor\"\n                className=\"w-6 h-6 text-blue-500\"\n              >\n                <path\n                  strokeLinecap=\"round\"\n                  strokeLinejoin=\"round\"\n                  d=\"M20.25 6.375c0 2.278-3.694 4.125-8.25 4.125S3.75 8.653 3.75 6.375m16.5 0c0-2.278-3.694-4.125-8.25-4.125S3.75 4.097 3.75 6.375m16.5 0v11.25c0 2.278-3.694 4.125-8.25 4.125s-8.25-1.847-8.25-4.125V6.375m16.5 0v3.75m-16.5-3.75v3.75m16.5 0v3.75C20.25 16.153 16.556 18 12 18s-8.25-1.847-8.25-4.125v-3.75m16.5 0c0 2.278-3.694 4.125-8.25 4.125s-8.25-1.847-8.25-4.125\"\n                />\n              </svg>\n            </div>\n            <p className=\"text-3xl font-bold text-neutral-900\">\n              {stats.memory_used_human}\n            </p>\n            <p className=\"text-xs text-neutral-500 mt-1\">\n              {(stats.memory_used_bytes / 1024 / 1024).toFixed(2)} MB\n            </p>\n          </div>\n\n          {/* Hit Rate */}\n          <div className=\"bg-white rounded-lg shadow p-6\">\n            <div className=\"flex items-center justify-between mb-2\">\n              <p className=\"text-sm font-medium text-neutral-600\">Hit Rate</p>\n              <svg\n                xmlns=\"http://www.w3.org/2000/svg\"\n                fill=\"none\"\n                viewBox=\"0 0 24 24\"\n                strokeWidth={1.5}\n                stroke=\"currentColor\"\n                className=\"w-6 h-6 text-green-500\"\n              >\n                <path\n                  strokeLinecap=\"round\"\n                  strokeLinejoin=\"round\"\n                  d=\"M3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75z\"\n                />\n              </svg>\n            </div>\n            <p className=\"text-3xl font-bold text-neutral-900\">\n              {(stats.hit_rate * 100).toFixed(1)}%\n            </p>\n            <p className=\"text-xs text-neutral-500 mt-1\">\n              Miss rate: {(stats.miss_rate * 100).toFixed(1)}%\n            </p>\n          </div>\n\n          {/* Uptime */}\n          <div className=\"bg-white rounded-lg shadow p-6\">\n            <div className=\"flex items-center justify-between mb-2\">\n              <p className=\"text-sm font-medium text-neutral-600\">Uptime</p>\n              <svg\n                xmlns=\"http://www.w3.org/2000/svg\"\n                fill=\"none\"\n                viewBox=\"0 0 24 24\"\n                strokeWidth={1.5}\n                stroke=\"currentColor\"\n                className=\"w-6 h-6 text-yellow-500\"\n              >\n                <path\n                  strokeLinecap=\"round\"\n                  strokeLinejoin=\"round\"\n                  d=\"M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z\"\n                />\n              </svg>\n            </div>\n            <p className=\"text-3xl font-bold text-neutral-900\">\n              {formatUptime(stats.uptime_seconds)}\n            </p>\n            <p className=\"text-xs text-neutral-500 mt-1\">\n              {Math.floor(stats.uptime_seconds / 86400)} days running\n            </p>\n          </div>\n        </div>\n      )}\n\n      {/* Keys by Prefix */}\n      {stats &&\n        stats.keys_by_prefix &&\n        Object.keys(stats.keys_by_prefix).length > 0 && (\n          <div className=\"bg-white rounded-lg shadow p-6\">\n            <h2 className=\"text-lg font-semibold text-neutral-900 mb-4\">\n              Keys by Prefix\n            </h2>\n            <div className=\"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4\">\n              {Object.entries(stats.keys_by_prefix)\n                .sort((a, b) => b[1] - a[1])\n                .map(([prefix, count]) => (\n                  <div\n                    key={prefix}\n                    className=\"flex items-center justify-between p-3 bg-neutral-50 rounded-lg\"\n                  >\n                    <span className=\"font-mono text-sm text-neutral-700\">\n                      {prefix}\n                    </span>\n                    <span className=\"text-sm font-semibold text-neutral-900\">\n                      {count.toLocaleString()}\n                    </span>\n                  </div>\n                ))}\n            </div>\n          </div>\n        )}\n\n      {/* Cache Actions */}\n      <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n        {/* Invalidate Pattern */}\n        <div className=\"bg-white rounded-lg shadow p-6\">\n          <h2 className=\"text-lg font-semibold text-neutral-900 mb-4\">\n            Invalidate by Pattern\n          </h2>\n          <p className=\"text-sm text-neutral-600 mb-4\">\n            Invalidate cache keys matching a specific pattern. Use * as a\n            wildcard.\n          </p>\n          <form onSubmit={handleInvalidatePattern} className=\"space-y-4\">\n            <div className=\"flex space-x-3\">\n              <input\n                type=\"text\"\n                value={invalidatePattern}\n                onChange={(e) => setInvalidatePattern(e.target.value)}\n                placeholder=\"e.g., user:*, session:abc123\"\n                className=\"flex-1 px-3 py-2 border border-neutral-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500\"\n              />\n              <button\n                type=\"submit\"\n                disabled={isInvalidating || !invalidatePattern.trim()}\n                className=\"px-4 py-2 text-sm font-medium text-white bg-yellow-600 rounded-md hover:bg-yellow-700 disabled:opacity-50 transition-colors\"\n              >\n                {isInvalidating ? \"Invalidating...\" : \"Invalidate\"}\n              </button>\n            </div>\n            <div className=\"text-xs text-neutral-500\">\n              <strong>Common patterns:</strong>\n              <ul className=\"mt-1 ml-4 list-disc space-y-1\">\n                <li>\n                  <code className=\"bg-neutral-100 px-1 rounded\">user:*</code> -\n                  All user cache entries\n                </li>\n                <li>\n                  <code className=\"bg-neutral-100 px-1 rounded\">session:*</code>{\" \"}\n                  - All session data\n                </li>\n                <li>\n                  <code className=\"bg-neutral-100 px-1 rounded\">kb:*</code> -\n                  Knowledge base cache\n                </li>\n              </ul>\n            </div>\n          </form>\n        </div>\n\n        {/* Clear All Cache */}\n        <div className=\"bg-white rounded-lg shadow p-6\">\n          <h2 className=\"text-lg font-semibold text-neutral-900 mb-4\">\n            Clear Entire Cache\n          </h2>\n          <p className=\"text-sm text-neutral-600 mb-4\">\n            Remove all entries from the cache. This will temporarily impact\n            performance as the cache rebuilds.\n          </p>\n          <div className=\"p-4 bg-red-50 border border-red-200 rounded-lg mb-4\">\n            <div className=\"flex items-start space-x-3\">\n              <svg\n                xmlns=\"http://www.w3.org/2000/svg\"\n                fill=\"none\"\n                viewBox=\"0 0 24 24\"\n                strokeWidth={2}\n                stroke=\"currentColor\"\n                className=\"w-5 h-5 text-red-600 mt-0.5\"\n              >\n                <path\n                  strokeLinecap=\"round\"\n                  strokeLinejoin=\"round\"\n                  d=\"M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z\"\n                />\n              </svg>\n              <div className=\"text-sm text-red-700\">\n                <strong>Warning:</strong> This action cannot be undone. All\n                cached data will be lost and will need to be regenerated.\n              </div>\n            </div>\n          </div>\n          <button\n            onClick={handleClearCache}\n            disabled={isClearing}\n            className=\"w-full px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700 disabled:opacity-50 transition-colors\"\n          >\n            {isClearing ? \"Clearing...\" : \"Clear All Cache\"}\n          </button>\n        </div>\n      </div>\n    </div>\n  );\n}\n"
}

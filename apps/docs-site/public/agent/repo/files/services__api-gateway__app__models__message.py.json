{
  "path": "services/api-gateway/app/models/message.py",
  "language": "python",
  "size": 2938,
  "last_modified": "2025-12-05T03:07:13.131Z",
  "lines": 90,
  "content": "\"\"\"\nMessage model for conversation history\n\"\"\"\n\nimport uuid\nfrom datetime import datetime\n\nfrom app.core.database import Base\nfrom sqlalchemy import Boolean, Column, DateTime, ForeignKey, Index, Integer, String, Text, UniqueConstraint\nfrom sqlalchemy.dialects.postgresql import JSONB, UUID\nfrom sqlalchemy.orm import relationship\n\n\nclass Message(Base):\n    \"\"\"Message model for conversation history\"\"\"\n\n    __tablename__ = \"messages\"\n\n    # Table-level constraints for idempotency\n    __table_args__ = (\n        # Unique constraint for idempotent message creation\n        # Only enforced when client_message_id is NOT NULL\n        UniqueConstraint(\n            \"session_id\",\n            \"branch_id\",\n            \"client_message_id\",\n            name=\"uq_message_idempotency\",\n        ),\n        # Partial index for faster idempotency lookups\n        Index(\n            \"ix_message_idempotency_lookup\",\n            \"session_id\",\n            \"branch_id\",\n            \"client_message_id\",\n            postgresql_where=\"client_message_id IS NOT NULL\",\n        ),\n    )\n\n    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)\n    session_id = Column(\n        UUID(as_uuid=True),\n        ForeignKey(\"sessions.id\", ondelete=\"CASCADE\"),\n        nullable=False,\n        index=True,\n    )\n\n    # Message content\n    role = Column(String(50), nullable=False)  # 'user', 'assistant', 'system', 'tool'\n    content = Column(Text, nullable=False)\n\n    # Conversation branching support\n    parent_message_id = Column(\n        UUID(as_uuid=True),\n        ForeignKey(\"messages.id\", ondelete=\"SET NULL\"),\n        nullable=True,\n        index=True,\n    )\n    branch_id = Column(String(100), nullable=True, index=True)  # Identifies which branch this message belongs to\n\n    # Idempotency support - client-provided message ID for deduplication\n    client_message_id = Column(\n        String(100), nullable=True, index=True\n    )  # Client-generated ID for idempotent message creation\n\n    # Tool usage tracking\n    tool_calls = Column(JSONB, nullable=True)  # Tool calls made in this message\n    tool_results = Column(JSONB, nullable=True)  # Results from tool calls\n\n    # Metadata\n    tokens = Column(Integer, nullable=True)  # Token count for this message\n    model = Column(String(100), nullable=True)  # Model used to generate response\n    message_metadata = Column(JSONB, nullable=True)  # Additional metadata\n\n    # PHI detection\n    contains_phi = Column(Boolean, default=False, nullable=False)  # Whether message contains PHI\n\n    # Timestamps\n    created_at = Column(DateTime, default=datetime.utcnow, nullable=False, index=True)\n\n    # Relationships\n    attachments = relationship(\n        \"MessageAttachment\",\n        back_populates=\"message\",\n        cascade=\"all, delete-orphan\",\n        lazy=\"selectin\",\n    )\n\n    def __repr__(self):\n        return f\"<Message(id={self.id}, session_id={self.session_id}, role={self.role})>\"\n"
}

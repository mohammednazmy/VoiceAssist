{
  "path": "services/api-gateway/app/services/feedback_service.py",
  "language": "python",
  "size": 18774,
  "last_modified": "2025-12-04T12:32:40.271Z",
  "lines": 584,
  "content": "\"\"\"\nFeedback Service - User Feedback Collection for Voice Sessions\n\nPhase 10: Frontend Integration - Feedback collection and analysis.\n\nFeatures:\n- Collect user ratings for voice sessions\n- Track specific feedback on naturalness, accuracy, latency\n- Generate feedback summaries for improvement insights\n- Support for in-session thumbs up/down feedback\n\"\"\"\n\nimport uuid\nfrom dataclasses import dataclass, field\nfrom datetime import datetime\nfrom enum import Enum\nfrom typing import Any, Dict, List, Optional\n\nfrom app.core.logging import get_logger\n\nlogger = get_logger(__name__)\n\n\n# ==============================================================================\n# Enums and Types\n# ==============================================================================\n\n\nclass FeedbackType(str, Enum):\n    \"\"\"Type of feedback.\"\"\"\n\n    SESSION_RATING = \"session_rating\"  # Overall session rating\n    RESPONSE_RATING = \"response_rating\"  # Rating for specific response\n    NATURALNESS = \"naturalness\"  # How natural the conversation felt\n    ACCURACY = \"accuracy\"  # STT/response accuracy\n    LATENCY = \"latency\"  # Perceived speed\n    DICTATION_QUALITY = \"dictation_quality\"  # Dictation-specific\n    BUG_REPORT = \"bug_report\"  # Problem report\n    SUGGESTION = \"suggestion\"  # Feature suggestion\n\n\nclass FeedbackRating(str, Enum):\n    \"\"\"Rating values.\"\"\"\n\n    THUMBS_UP = \"thumbs_up\"\n    THUMBS_DOWN = \"thumbs_down\"\n    STAR_1 = \"1\"\n    STAR_2 = \"2\"\n    STAR_3 = \"3\"\n    STAR_4 = \"4\"\n    STAR_5 = \"5\"\n\n\nclass FeedbackCategory(str, Enum):\n    \"\"\"Feedback categories for analysis.\"\"\"\n\n    VOICE_QUALITY = \"voice_quality\"\n    RESPONSE_QUALITY = \"response_quality\"\n    SPEED = \"speed\"\n    UNDERSTANDING = \"understanding\"\n    MEDICAL_ACCURACY = \"medical_accuracy\"\n    UI_UX = \"ui_ux\"\n    OTHER = \"other\"\n\n\n# ==============================================================================\n# Data Classes\n# ==============================================================================\n\n\n@dataclass\nclass FeedbackItem:\n    \"\"\"A single feedback item.\"\"\"\n\n    id: str\n    session_id: str\n    user_id: Optional[str]\n    feedback_type: FeedbackType\n    rating: Optional[FeedbackRating]\n    category: Optional[FeedbackCategory]\n    comment: Optional[str]\n    context: Dict[str, Any] = field(default_factory=dict)\n    created_at: datetime = field(default_factory=datetime.utcnow)\n\n    def to_dict(self) -> Dict[str, Any]:\n        return {\n            \"id\": self.id,\n            \"session_id\": self.session_id,\n            \"user_id\": self.user_id,\n            \"feedback_type\": self.feedback_type.value,\n            \"rating\": self.rating.value if self.rating else None,\n            \"category\": self.category.value if self.category else None,\n            \"comment\": self.comment,\n            \"context\": self.context,\n            \"created_at\": self.created_at.isoformat(),\n        }\n\n\n@dataclass\nclass SessionFeedbackSummary:\n    \"\"\"Summary of feedback for a session.\"\"\"\n\n    session_id: str\n    overall_rating: Optional[float]  # Average star rating\n    thumbs_up_count: int = 0\n    thumbs_down_count: int = 0\n    feedback_items: List[FeedbackItem] = field(default_factory=list)\n    categories: Dict[str, int] = field(default_factory=dict)\n\n    def to_dict(self) -> Dict[str, Any]:\n        return {\n            \"session_id\": self.session_id,\n            \"overall_rating\": self.overall_rating,\n            \"thumbs_up_count\": self.thumbs_up_count,\n            \"thumbs_down_count\": self.thumbs_down_count,\n            \"feedback_count\": len(self.feedback_items),\n            \"categories\": self.categories,\n        }\n\n\n@dataclass\nclass FeedbackPrompt:\n    \"\"\"A prompt to collect feedback from user.\"\"\"\n\n    prompt_type: str  # \"rating\", \"thumbs\", \"comment\"\n    message: str\n    options: Optional[List[str]] = None\n    context: Dict[str, Any] = field(default_factory=dict)\n\n    def to_dict(self) -> Dict[str, Any]:\n        return {\n            \"prompt_type\": self.prompt_type,\n            \"message\": self.message,\n            \"options\": self.options,\n            \"context\": self.context,\n        }\n\n\n# ==============================================================================\n# Feedback Service\n# ==============================================================================\n\n\nclass FeedbackService:\n    \"\"\"\n    Service for collecting and managing user feedback.\n\n    Collects various types of feedback during and after voice sessions,\n    aggregates feedback for analysis, and generates prompts for\n    collecting feedback at appropriate moments.\n\n    Usage:\n        feedback_service = FeedbackService()\n\n        # Record thumbs up/down during session\n        feedback_service.record_quick_feedback(\n            session_id=\"session_123\",\n            user_id=\"user_456\",\n            thumbs_up=True,\n            message_id=\"msg_789\"\n        )\n\n        # Record detailed session feedback\n        feedback_service.record_session_rating(\n            session_id=\"session_123\",\n            user_id=\"user_456\",\n            rating=4,\n            categories={\n                \"naturalness\": 5,\n                \"accuracy\": 4,\n                \"speed\": 3\n            },\n            comment=\"Great conversation, but slightly slow responses\"\n        )\n\n        # Get feedback prompts\n        prompts = feedback_service.get_feedback_prompts(session_id=\"session_123\")\n    \"\"\"\n\n    def __init__(self):\n        self._feedback_items: Dict[str, List[FeedbackItem]] = {}\n        self._session_summaries: Dict[str, SessionFeedbackSummary] = {}\n\n    def record_quick_feedback(\n        self,\n        session_id: str,\n        user_id: Optional[str] = None,\n        thumbs_up: bool = True,\n        message_id: Optional[str] = None,\n        context: Optional[Dict[str, Any]] = None,\n    ) -> FeedbackItem:\n        \"\"\"\n        Record quick thumbs up/down feedback.\n\n        Args:\n            session_id: Session identifier\n            user_id: User ID\n            thumbs_up: True for thumbs up, False for thumbs down\n            message_id: Optional message ID this feedback relates to\n            context: Additional context\n\n        Returns:\n            Created FeedbackItem\n        \"\"\"\n        rating = FeedbackRating.THUMBS_UP if thumbs_up else FeedbackRating.THUMBS_DOWN\n        feedback_type = FeedbackType.RESPONSE_RATING if message_id else FeedbackType.SESSION_RATING\n\n        item = FeedbackItem(\n            id=str(uuid.uuid4()),\n            session_id=session_id,\n            user_id=user_id,\n            feedback_type=feedback_type,\n            rating=rating,\n            category=None,\n            comment=None,\n            context={\n                **(context or {}),\n                \"message_id\": message_id,\n            },\n        )\n\n        self._store_feedback(item)\n\n        # Update summary\n        self._update_summary(session_id, item)\n\n        logger.info(\n            f\"Quick feedback recorded: session={session_id}, \" f\"thumbs_up={thumbs_up}, message_id={message_id}\"\n        )\n\n        return item\n\n    def record_session_rating(\n        self,\n        session_id: str,\n        user_id: Optional[str] = None,\n        rating: int = 5,\n        categories: Optional[Dict[str, int]] = None,\n        comment: Optional[str] = None,\n        context: Optional[Dict[str, Any]] = None,\n    ) -> List[FeedbackItem]:\n        \"\"\"\n        Record detailed session rating.\n\n        Args:\n            session_id: Session identifier\n            user_id: User ID\n            rating: Overall rating (1-5)\n            categories: Category-specific ratings\n            comment: Optional text comment\n            context: Additional context\n\n        Returns:\n            List of created FeedbackItems\n        \"\"\"\n        items = []\n        rating_enum = FeedbackRating(str(rating))\n\n        # Overall rating\n        overall_item = FeedbackItem(\n            id=str(uuid.uuid4()),\n            session_id=session_id,\n            user_id=user_id,\n            feedback_type=FeedbackType.SESSION_RATING,\n            rating=rating_enum,\n            category=None,\n            comment=comment,\n            context=context or {},\n        )\n        self._store_feedback(overall_item)\n        self._update_summary(session_id, overall_item)\n        items.append(overall_item)\n\n        # Category ratings\n        category_map = {\n            \"naturalness\": (FeedbackType.NATURALNESS, FeedbackCategory.VOICE_QUALITY),\n            \"accuracy\": (FeedbackType.ACCURACY, FeedbackCategory.UNDERSTANDING),\n            \"speed\": (FeedbackType.LATENCY, FeedbackCategory.SPEED),\n            \"voice_quality\": (FeedbackType.NATURALNESS, FeedbackCategory.VOICE_QUALITY),\n            \"response_quality\": (\n                FeedbackType.ACCURACY,\n                FeedbackCategory.RESPONSE_QUALITY,\n            ),\n            \"medical_accuracy\": (\n                FeedbackType.DICTATION_QUALITY,\n                FeedbackCategory.MEDICAL_ACCURACY,\n            ),\n        }\n\n        if categories:\n            for cat_name, cat_rating in categories.items():\n                if cat_name in category_map:\n                    feedback_type, feedback_category = category_map[cat_name]\n                    cat_item = FeedbackItem(\n                        id=str(uuid.uuid4()),\n                        session_id=session_id,\n                        user_id=user_id,\n                        feedback_type=feedback_type,\n                        rating=FeedbackRating(str(cat_rating)),\n                        category=feedback_category,\n                        comment=None,\n                        context={\"category_name\": cat_name},\n                    )\n                    self._store_feedback(cat_item)\n                    self._update_summary(session_id, cat_item)\n                    items.append(cat_item)\n\n        logger.info(\n            f\"Session rating recorded: session={session_id}, \" f\"rating={rating}, categories={len(categories or {})}\"\n        )\n\n        return items\n\n    def record_bug_report(\n        self,\n        session_id: str,\n        user_id: Optional[str] = None,\n        description: str = \"\",\n        category: FeedbackCategory = FeedbackCategory.OTHER,\n        context: Optional[Dict[str, Any]] = None,\n    ) -> FeedbackItem:\n        \"\"\"\n        Record a bug report.\n\n        Args:\n            session_id: Session identifier\n            user_id: User ID\n            description: Bug description\n            category: Bug category\n            context: Additional context (error details, etc.)\n\n        Returns:\n            Created FeedbackItem\n        \"\"\"\n        item = FeedbackItem(\n            id=str(uuid.uuid4()),\n            session_id=session_id,\n            user_id=user_id,\n            feedback_type=FeedbackType.BUG_REPORT,\n            rating=None,\n            category=category,\n            comment=description,\n            context=context or {},\n        )\n\n        self._store_feedback(item)\n        self._update_summary(session_id, item)\n\n        logger.info(f\"Bug report recorded: session={session_id}, category={category.value}\")\n\n        return item\n\n    def record_suggestion(\n        self,\n        session_id: str,\n        user_id: Optional[str] = None,\n        suggestion: str = \"\",\n        category: FeedbackCategory = FeedbackCategory.OTHER,\n        context: Optional[Dict[str, Any]] = None,\n    ) -> FeedbackItem:\n        \"\"\"\n        Record a feature suggestion.\n\n        Args:\n            session_id: Session identifier\n            user_id: User ID\n            suggestion: Suggestion text\n            category: Suggestion category\n            context: Additional context\n\n        Returns:\n            Created FeedbackItem\n        \"\"\"\n        item = FeedbackItem(\n            id=str(uuid.uuid4()),\n            session_id=session_id,\n            user_id=user_id,\n            feedback_type=FeedbackType.SUGGESTION,\n            rating=None,\n            category=category,\n            comment=suggestion,\n            context=context or {},\n        )\n\n        self._store_feedback(item)\n        self._update_summary(session_id, item)\n\n        logger.info(f\"Suggestion recorded: session={session_id}, category={category.value}\")\n\n        return item\n\n    def _store_feedback(self, item: FeedbackItem) -> None:\n        \"\"\"Store feedback item.\"\"\"\n        if item.session_id not in self._feedback_items:\n            self._feedback_items[item.session_id] = []\n        self._feedback_items[item.session_id].append(item)\n\n    def _update_summary(self, session_id: str, item: FeedbackItem) -> None:\n        \"\"\"Update session feedback summary.\"\"\"\n        if session_id not in self._session_summaries:\n            self._session_summaries[session_id] = SessionFeedbackSummary(session_id=session_id)\n\n        summary = self._session_summaries[session_id]\n        summary.feedback_items.append(item)\n\n        # Update thumbs count\n        if item.rating == FeedbackRating.THUMBS_UP:\n            summary.thumbs_up_count += 1\n        elif item.rating == FeedbackRating.THUMBS_DOWN:\n            summary.thumbs_down_count += 1\n\n        # Update overall rating\n        star_ratings = []\n        for fb in summary.feedback_items:\n            if fb.rating and fb.rating.value.isdigit():\n                star_ratings.append(int(fb.rating.value))\n        if star_ratings:\n            summary.overall_rating = sum(star_ratings) / len(star_ratings)\n\n        # Update category counts\n        if item.category:\n            cat = item.category.value\n            if cat not in summary.categories:\n                summary.categories[cat] = 0\n            summary.categories[cat] += 1\n\n    def get_session_feedback(\n        self,\n        session_id: str,\n    ) -> List[FeedbackItem]:\n        \"\"\"Get all feedback for a session.\"\"\"\n        return self._feedback_items.get(session_id, [])\n\n    def get_session_summary(\n        self,\n        session_id: str,\n    ) -> Optional[SessionFeedbackSummary]:\n        \"\"\"Get feedback summary for a session.\"\"\"\n        return self._session_summaries.get(session_id)\n\n    def get_feedback_prompts(\n        self,\n        session_id: str,\n        session_duration_ms: float = 0,\n        interaction_count: int = 0,\n        has_errors: bool = False,\n    ) -> List[FeedbackPrompt]:\n        \"\"\"\n        Get appropriate feedback prompts for a session.\n\n        Returns prompts based on session characteristics.\n\n        Args:\n            session_id: Session identifier\n            session_duration_ms: Session duration in ms\n            interaction_count: Number of interactions\n            has_errors: Whether session had errors\n\n        Returns:\n            List of FeedbackPrompt objects\n        \"\"\"\n        prompts = []\n\n        # Short session - quick thumbs\n        if session_duration_ms < 60000 or interaction_count < 3:\n            prompts.append(\n                FeedbackPrompt(\n                    prompt_type=\"thumbs\",\n                    message=\"How was this conversation?\",\n                    options=[\"thumbs_up\", \"thumbs_down\"],\n                )\n            )\n            return prompts\n\n        # Session with errors - bug report option\n        if has_errors:\n            prompts.append(\n                FeedbackPrompt(\n                    prompt_type=\"thumbs\",\n                    message=\"We noticed some issues. Was the conversation still helpful?\",\n                    options=[\"thumbs_up\", \"thumbs_down\"],\n                )\n            )\n            prompts.append(\n                FeedbackPrompt(\n                    prompt_type=\"comment\",\n                    message=\"Would you like to tell us what went wrong?\",\n                    context={\"type\": \"bug_report\"},\n                )\n            )\n            return prompts\n\n        # Normal session - full rating\n        prompts.append(\n            FeedbackPrompt(\n                prompt_type=\"rating\",\n                message=\"How would you rate this conversation?\",\n                options=[\"1\", \"2\", \"3\", \"4\", \"5\"],\n            )\n        )\n\n        # Add category prompts for longer sessions\n        if session_duration_ms > 120000 or interaction_count > 5:\n            prompts.append(\n                FeedbackPrompt(\n                    prompt_type=\"categories\",\n                    message=\"Help us improve with specific feedback:\",\n                    options=[\"naturalness\", \"accuracy\", \"speed\"],\n                )\n            )\n\n        # Always offer comment option\n        prompts.append(\n            FeedbackPrompt(\n                prompt_type=\"comment\",\n                message=\"Any other feedback? (optional)\",\n            )\n        )\n\n        return prompts\n\n    def generate_analytics_report(\n        self,\n        session_ids: Optional[List[str]] = None,\n    ) -> Dict[str, Any]:\n        \"\"\"\n        Generate an analytics report from feedback data.\n\n        Args:\n            session_ids: Optional list of session IDs to include\n\n        Returns:\n            Analytics report dictionary\n        \"\"\"\n        if session_ids:\n            summaries = [self._session_summaries[sid] for sid in session_ids if sid in self._session_summaries]\n        else:\n            summaries = list(self._session_summaries.values())\n\n        if not summaries:\n            return {\n                \"total_sessions\": 0,\n                \"avg_rating\": None,\n                \"satisfaction_rate\": None,\n            }\n\n        # Calculate metrics\n        total_sessions = len(summaries)\n        ratings = [s.overall_rating for s in summaries if s.overall_rating]\n        avg_rating = sum(ratings) / len(ratings) if ratings else None\n\n        total_thumbs_up = sum(s.thumbs_up_count for s in summaries)\n        total_thumbs_down = sum(s.thumbs_down_count for s in summaries)\n        total_thumbs = total_thumbs_up + total_thumbs_down\n        satisfaction_rate = total_thumbs_up / total_thumbs if total_thumbs > 0 else None\n\n        # Aggregate categories\n        all_categories: Dict[str, int] = {}\n        for s in summaries:\n            for cat, count in s.categories.items():\n                if cat not in all_categories:\n                    all_categories[cat] = 0\n                all_categories[cat] += count\n\n        return {\n            \"total_sessions\": total_sessions,\n            \"avg_rating\": round(avg_rating, 2) if avg_rating else None,\n            \"satisfaction_rate\": (round(satisfaction_rate, 3) if satisfaction_rate else None),\n            \"thumbs_up\": total_thumbs_up,\n            \"thumbs_down\": total_thumbs_down,\n            \"categories\": all_categories,\n        }\n\n    def cleanup_session(self, session_id: str) -> None:\n        \"\"\"Remove feedback data for a session.\"\"\"\n        if session_id in self._feedback_items:\n            del self._feedback_items[session_id]\n        if session_id in self._session_summaries:\n            del self._session_summaries[session_id]\n\n\n# Global service instance\nfeedback_service = FeedbackService()\n"
}

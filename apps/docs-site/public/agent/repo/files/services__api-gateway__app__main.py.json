{
  "path": "services/api-gateway/app/main.py",
  "language": "python",
  "size": 12520,
  "last_modified": "2025-12-04T21:30:58.282Z",
  "lines": 337,
  "content": "\"\"\"\nMain FastAPI application\n\"\"\"\n\n# Suppress CryptographyDeprecationWarning from pypdf ARC4 usage\n# pypdf uses ARC4 (RC4) for older encrypted PDFs which triggers deprecation warnings\n# This is a known issue: https://github.com/py-pdf/pypdf/issues/1536\n# The warning is non-actionable for us as users of pypdf until they migrate to modern encryption\nimport warnings\n\ntry:\n    from cryptography.utils import CryptographyDeprecationWarning\n\n    warnings.filterwarnings(\"ignore\", category=CryptographyDeprecationWarning, message=\".*ARC4.*\")  # nosec B608\nexcept ImportError:\n    pass  # cryptography not installed or no CryptographyDeprecationWarning\n\n# Import business metrics to register them with Prometheus (P3.3)\nimport uvicorn\nfrom app.api import (\n    admin_attachments,\n    admin_cache,\n    admin_calendar_connections,\n    admin_clinical,\n    admin_conversations,\n    admin_feature_flags,\n    admin_folders,\n    admin_integrations,\n    admin_kb,\n    admin_medical,\n    admin_panel,\n    admin_phi,\n    admin_prompts,\n    admin_system,\n    admin_tools,\n    admin_troubleshooting,\n    admin_user_flag_overrides,\n    admin_voice,\n    attachments,\n    auth,\n    auth_2fa,\n    auth_oauth,\n    calendar_connections,\n    clinical_context,\n    conversations,\n    experiments,\n    export,\n    external_medical,\n    feature_flags_realtime,\n    folders,\n    health,\n    integrations,\n    medical_ai,\n    metrics,\n    realtime,\n    sharing,\n    user_api_keys,\n    users,\n    voice,\n)\n\n# This import registers business metrics with Prometheus  # noqa: F401\nfrom app.core import business_metrics  # noqa: F401\nfrom app.core.config import settings\nfrom app.core.logging import configure_logging, get_logger\nfrom app.core.middleware import MetricsMiddleware, RequestTracingMiddleware, SecurityHeadersMiddleware\nfrom app.core.sentry import init_sentry\nfrom app.middleware.voice_auth import VoiceAuthMiddleware\nfrom app.services.external_connectors import ExternalSyncScheduler, OpenEvidenceConnector, PubMedConnector\nfrom app.services.session_activity import session_activity_service\nfrom app.services.token_revocation import token_revocation_service\nfrom fastapi import FastAPI\nfrom fastapi.middleware.cors import CORSMiddleware\nfrom slowapi import Limiter, _rate_limit_exceeded_handler\nfrom slowapi.errors import RateLimitExceeded\nfrom slowapi.util import get_remote_address\n\n# Configure structured logging\nconfigure_logging()\nlogger = get_logger(__name__)\n\n\n# Create rate limiter\nlimiter = Limiter(key_func=get_remote_address, default_limits=[\"100/minute\"])\n\n\n# Create FastAPI application with enhanced documentation\napp = FastAPI(\n    title=settings.APP_NAME,\n    version=settings.APP_VERSION,\n    debug=settings.DEBUG,\n    description=\"\"\"\n    VoiceAssist V2 - Enterprise Medical AI Assistant API\n\n    ## Features\n    - Health monitoring endpoints\n    - Database connectivity checks (PostgreSQL, Redis, Qdrant)\n    - Prometheus metrics\n    - Structured logging with correlation IDs\n    - Rate limiting for API protection\n    - Circuit breaker pattern for resilience\n\n    ## Security\n    - Security headers (CSP, HSTS, X-Frame-Options)\n    - Rate limiting on all endpoints\n    - Request tracing with correlation IDs\n\n    ## Authentication\n    - JWT-based authentication with secure token management\n    - User registration and login endpoints\n    - Token refresh mechanism for extended sessions\n    - Integration with Nextcloud for file storage\n    \"\"\",\n    contact={\n        \"name\": \"VoiceAssist Team\",\n        \"email\": \"support@voiceassist.example.com\",\n    },\n    license_info={\n        \"name\": \"Internal Use\",\n    },\n    docs_url=\"/docs\",\n    redoc_url=\"/redoc\",\n    openapi_url=\"/openapi.json\",\n)\n\n\n# Add rate limiter to app state\napp.state.limiter = limiter\napp.add_exception_handler(RateLimitExceeded, _rate_limit_exceeded_handler)\n\n# Add custom middleware (order matters!)\n# 1. Security headers should be added first\napp.add_middleware(SecurityHeadersMiddleware)\n\n# 2. Request tracing for correlation IDs\napp.add_middleware(RequestTracingMiddleware)\n\n# 3. Metrics middleware\napp.add_middleware(MetricsMiddleware)\n\n# 4. CORS middleware\n# Parse ALLOWED_ORIGINS from environment (comma-separated string)\nallowed_origins = [origin.strip() for origin in settings.ALLOWED_ORIGINS.split(\",\")]\n\nif settings.DEBUG:\n    allowed_origins.append(\"*\")  # Allow all in development\n\napp.add_middleware(\n    CORSMiddleware,\n    allow_origins=allowed_origins,\n    allow_credentials=True,\n    allow_methods=[\"GET\", \"POST\", \"PUT\", \"DELETE\", \"PATCH\"],\n    allow_headers=[\"*\"],\n    expose_headers=[\"X-Correlation-ID\"],\n)\n\n# 5. Voice auth middleware to validate voice session headers\napp.add_middleware(VoiceAuthMiddleware)\n\n# Include routers\napp.include_router(health.router, tags=[\"health\"])\napp.include_router(metrics.router)  # Prometheus metrics endpoint (Phase 7 - P2.1)\napp.include_router(auth.router)\napp.include_router(auth_2fa.router)  # Two-factor authentication\napp.include_router(auth_oauth.router)  # OAuth providers (Google, Microsoft)\napp.include_router(calendar_connections.router)  # Calendar connections API (user-facing)\napp.include_router(users.router)\napp.include_router(realtime.router)\napp.include_router(conversations.router, prefix=\"/api\")  # Phase 2 Week 10: Conversations & branching\napp.include_router(voice.router, prefix=\"/api\")  # Milestone 1 Phase 3: Voice features (transcription, TTS)\napp.include_router(admin_kb.router)  # Phase 5: KB Management\napp.include_router(integrations.router)  # Phase 6: Nextcloud integrations\napp.include_router(admin_panel.router)  # Phase 7: Admin Panel API\napp.include_router(admin_conversations.router)  # Admin Conversations API\napp.include_router(admin_cache.router)  # Phase 7: Cache Management API (P2.1)\napp.include_router(admin_feature_flags.router)  # Phase 7: Feature Flags API (P3.1)\napp.include_router(admin_user_flag_overrides.router)  # Phase 4: User Flag Overrides API\napp.include_router(experiments.router)  # Public experiments/feature flags API\napp.include_router(feature_flags_realtime.router)  # Phase 3: Real-time flag updates via SSE\napp.include_router(admin_voice.router)  # Sprint 1: Voice Admin API\napp.include_router(admin_integrations.router)  # Sprint 2: Integrations Admin API\napp.include_router(admin_phi.router)  # Sprint 3: PHI & Security Admin API\napp.include_router(admin_clinical.router)  # Admin Clinical Context API (HIPAA)\napp.include_router(admin_attachments.router)  # Admin Attachments API\napp.include_router(admin_folders.router)  # Admin Folders API\napp.include_router(admin_prompts.router)  # Prompt Management Admin API\napp.include_router(admin_medical.router)  # Sprint 4: Medical AI Admin API\napp.include_router(admin_system.router)  # Sprint 4: System Admin API\napp.include_router(admin_tools.router)  # Sprint 6: Tools Admin API\napp.include_router(admin_calendar_connections.router)  # Calendar connections admin API\napp.include_router(admin_troubleshooting.router)  # Sprint 6: Troubleshooting Admin API\napp.include_router(attachments.router, prefix=\"/api\")  # Phase 8: File attachments in chat\napp.include_router(clinical_context.router, prefix=\"/api\")  # Phase 8: Clinical context\napp.include_router(folders.router, prefix=\"/api\")  # Phase 8: Conversation folders\napp.include_router(export.router, prefix=\"/api\")  # Phase 8: Conversation export\napp.include_router(sharing.router, prefix=\"/api\")  # Phase 8: Conversation sharing\napp.include_router(external_medical.router, prefix=\"/api\")  # Phase 3: External medical integrations\napp.include_router(medical_ai.router)  # Phase 2 Deferred: Medical AI services\napp.include_router(user_api_keys.router)  # User API key management\n\n\n@app.on_event(\"startup\")\nasync def startup_event():\n    \"\"\"Application startup tasks\"\"\"\n    # Initialize Sentry error tracking (if configured)\n    sentry_enabled = init_sentry()\n\n    logger.info(\n        \"application_startup\",\n        app_name=settings.APP_NAME,\n        version=settings.APP_VERSION,\n        environment=settings.ENVIRONMENT,\n        debug=settings.DEBUG,\n        sentry_enabled=sentry_enabled,\n    )\n\n    # Connect to Redis for token revocation and session tracking\n    await token_revocation_service.connect()\n    await session_activity_service.connect()\n    logger.info(\n        \"session_services_initialized\",\n        inactivity_timeout_minutes=settings.SESSION_INACTIVITY_TIMEOUT_MINUTES,\n        absolute_timeout_hours=settings.SESSION_ABSOLUTE_TIMEOUT_HOURS,\n    )\n\n    # Warm prompt cache for fast AI prompt lookups\n    try:\n        from app.services.prompt_service import prompt_service\n\n        prompts_cached = await prompt_service.warm_cache()\n        logger.info(\"prompt_cache_warmed\", prompts_cached=prompts_cached)\n    except Exception as e:\n        logger.warning(\"prompt_cache_warm_failed\", error=str(e))\n\n    # Auto-register feature flags from shared definitions and warm cache (Phase 7 Enhancement)\n    try:\n        from app.core.database import SessionLocal\n        from app.core.flag_definitions import get_all_flags, sync_definitions_to_database\n        from app.services.feature_flags import feature_flag_service\n\n        # Sync flag definitions to database (creates missing flags)\n        db = SessionLocal()\n        try:\n            sync_result = sync_definitions_to_database(db)\n            logger.info(\n                \"feature_flags_synced\",\n                created=sync_result[\"created\"],\n                skipped=sync_result[\"skipped\"],\n            )\n        finally:\n            db.close()\n\n        # Warm the feature flag cache\n        flags_cached = await feature_flag_service.warm_cache()\n        logger.info(\"feature_flag_cache_warmed\", flags_cached=flags_cached)\n\n        # Log flag definitions summary\n        all_flags = get_all_flags()\n        categories = {}\n        for flag in all_flags:\n            cat = flag.category.value\n            categories[cat] = categories.get(cat, 0) + 1\n\n        logger.info(\n            \"feature_flags_loaded\",\n            total_definitions=len(all_flags),\n            categories=categories,\n        )\n    except Exception as e:\n        logger.warning(\"feature_flag_init_failed\", error=str(e), exc_info=True)\n\n    # FastAPI Cache disabled due to redis-py compatibility issues\n    # TODO: Re-enable when fastapi-cache2 supports redis-py 5.x\n    # FastAPICache.init(RedisBackend(redis_client), prefix=\"fastapi-cache\")\n    # logger.info(\"cache_initialized\", backend=\"redis\")\n\n    logger.info(\"database_pool_configured\", pool_size=20, max_overflow=40)\n    logger.info(\"redis_pool_configured\", max_connections=50)\n    logger.info(\n        \"middleware_configured\",\n        middleware=[\"SecurityHeaders\", \"RequestTracing\", \"Metrics\", \"CORS\"],\n    )\n    logger.info(\"rate_limiting_enabled\", default_limit=\"100/minute\")\n    logger.info(\n        \"auth_system_enabled\",\n        jwt_algorithm=settings.JWT_ALGORITHM,\n        token_expiry_minutes=settings.ACCESS_TOKEN_EXPIRE_MINUTES,\n    )\n\n    # Start periodic sync for external evidence sources when enabled\n    if settings.EXTERNAL_SYNC_ENABLED and settings.ENVIRONMENT != \"test\":\n        app.state.external_sync_scheduler = ExternalSyncScheduler(\n            connectors=[\n                OpenEvidenceConnector(\n                    api_key=settings.OPENEVIDENCE_API_KEY,\n                    base_url=settings.OPENEVIDENCE_BASE_URL,\n                ),\n                PubMedConnector(\n                    api_key=settings.PUBMED_API_KEY,\n                    tool_email=settings.PUBMED_TOOL_EMAIL,\n                ),\n            ],\n            default_interval_minutes=settings.EXTERNAL_SYNC_INTERVAL_MINUTES,\n            per_connector_intervals={\n                \"openevidence\": settings.OPENEVIDENCE_SYNC_MINUTES,\n                \"pubmed\": settings.PUBMED_SYNC_MINUTES,\n            },\n        )\n        await app.state.external_sync_scheduler.start()\n\n\n@app.on_event(\"shutdown\")\nasync def shutdown_event():\n    \"\"\"Application shutdown tasks\"\"\"\n    logger.info(\n        \"application_shutdown\",\n        app_name=settings.APP_NAME,\n        version=settings.APP_VERSION,\n    )\n\n    # Disconnect session services\n    await token_revocation_service.disconnect()\n    await session_activity_service.disconnect()\n\n    scheduler = getattr(app.state, \"external_sync_scheduler\", None)\n    if scheduler:\n        await scheduler.stop()\n\n\nif __name__ == \"__main__\":\n    uvicorn.run(\n        \"app.main:app\",\n        host=\"0.0.0.0\",  # nosec B104 - intentional for Docker container\n        port=8000,\n        reload=settings.DEBUG,\n    )\n"
}

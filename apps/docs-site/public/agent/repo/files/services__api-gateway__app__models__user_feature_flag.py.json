{
  "path": "services/api-gateway/app/models/user_feature_flag.py",
  "language": "python",
  "size": 3749,
  "last_modified": "2025-12-05T03:07:13.132Z",
  "lines": 87,
  "content": "\"\"\"User Feature Flag Override Model (Phase 7 - P3.1+ / Phase 4 Enhanced).\n\nProvides per-user feature flag overrides for A/B testing and gradual rollouts.\n\nPhase 4 enhancements:\n- reason: Audit reason for the override\n- created_by: Admin who created the override\n- updated_by: Admin who last modified the override\n\"\"\"\n\nfrom __future__ import annotations\n\nimport uuid\nfrom datetime import datetime, timezone\n\nfrom app.core.database import Base\nfrom sqlalchemy import Boolean, Column, DateTime, ForeignKey, Index, String\nfrom sqlalchemy.dialects.postgresql import JSON, UUID\n\n\nclass UserFeatureFlag(Base):\n    \"\"\"User-specific feature flag override.\n\n    Allows per-user feature flag values to override global settings.\n    Used for A/B testing, gradual rollouts, and user-specific configurations.\n\n    Attributes:\n        id: Unique identifier for this override\n        user_id: User this override applies to\n        flag_name: Feature flag name (references feature_flags table)\n        enabled: Override enabled state (for boolean flags)\n        value: Override value (for non-boolean flags)\n        created_at: When override was created\n        updated_at: When override was last updated\n        expires_at: Optional expiration datetime\n        override_metadata: Additional metadata (A/B test group, ticket, experiment ID, etc.)\n        reason: Audit reason for creating the override (Phase 4)\n        created_by: Admin who created this override (Phase 4)\n        updated_by: Admin who last modified this override (Phase 4)\n    \"\"\"\n\n    __tablename__ = \"user_feature_flags\"\n\n    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)\n    user_id = Column(UUID(as_uuid=True), ForeignKey(\"users.id\"), nullable=False, index=True)\n    flag_name = Column(String(255), ForeignKey(\"feature_flags.name\"), nullable=False, index=True)\n    enabled = Column(Boolean, nullable=True)  # Null means use global default\n    value = Column(JSON, nullable=True)\n    created_at = Column(DateTime, default=datetime.utcnow, nullable=False)\n    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow, nullable=False)\n    expires_at = Column(DateTime, nullable=True)\n    override_metadata = Column(\"metadata\", JSON, nullable=True)\n\n    # Phase 4: Audit and accountability fields\n    reason = Column(String(500), nullable=True)  # Why this override was created\n    created_by = Column(String(255), nullable=True)  # Admin who created it\n    updated_by = Column(String(255), nullable=True)  # Admin who last modified it\n\n    # Composite unique constraint: one override per user per flag\n    __table_args__ = (Index(\"ix_user_feature_flags_user_flag\", \"user_id\", \"flag_name\", unique=True),)\n\n    def __repr__(self):\n        return f\"<UserFeatureFlag(user_id='{self.user_id}', flag='{self.flag_name}', enabled={self.enabled})>\"\n\n    def to_dict(self) -> dict:\n        \"\"\"Convert model to dictionary.\"\"\"\n        return {\n            \"id\": str(self.id),\n            \"user_id\": str(self.user_id),\n            \"flag_name\": self.flag_name,\n            \"enabled\": self.enabled,\n            \"value\": self.value,\n            \"created_at\": self.created_at.isoformat() if self.created_at else None,\n            \"updated_at\": self.updated_at.isoformat() if self.updated_at else None,\n            \"expires_at\": self.expires_at.isoformat() if self.expires_at else None,\n            \"metadata\": self.override_metadata,\n            \"reason\": self.reason,\n            \"created_by\": self.created_by,\n            \"updated_by\": self.updated_by,\n        }\n\n    def is_expired(self) -> bool:\n        \"\"\"Check if override has expired.\"\"\"\n        if self.expires_at is None:\n            return False\n        return datetime.now(timezone.utc) > self.expires_at\n"
}

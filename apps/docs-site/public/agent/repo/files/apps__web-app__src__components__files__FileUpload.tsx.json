{
  "path": "apps/web-app/src/components/files/FileUpload.tsx",
  "language": "typescript",
  "size": 12501,
  "last_modified": "2025-11-29T04:27:41.404Z",
  "lines": 388,
  "content": "/**\n * FileUpload Component\n * Handles file selection, upload progress, and preview\n */\n\nimport { useState, useRef, useCallback } from \"react\";\nimport { useAuth } from \"../../hooks/useAuth\";\n\nexport interface UploadedFile {\n  id: string;\n  name: string;\n  size: number;\n  type: string;\n  url?: string;\n  preview?: string;\n}\n\nexport interface FileUploadProps {\n  onFilesUploaded: (files: UploadedFile[]) => void;\n  onFileRemoved?: (fileId: string) => void;\n  maxFiles?: number;\n  maxSizeMB?: number;\n  accept?: string;\n  disabled?: boolean;\n}\n\nexport function FileUpload({\n  onFilesUploaded,\n  onFileRemoved,\n  maxFiles = 5,\n  maxSizeMB = 10,\n  accept = \".pdf,.png,.jpg,.jpeg,.txt,.md\",\n  disabled = false,\n}: FileUploadProps) {\n  const { apiClient } = useAuth();\n  const fileInputRef = useRef<HTMLInputElement>(null);\n\n  const [uploadingFiles, setUploadingFiles] = useState<\n    Array<{ file: File; progress: number; error?: string }>\n  >([]);\n  const [uploadedFiles, setUploadedFiles] = useState<UploadedFile[]>([]);\n\n  // Generate preview for images\n  const generatePreview = useCallback((file: File): Promise<string> => {\n    return new Promise((resolve, reject) => {\n      if (!file.type.startsWith(\"image/\")) {\n        reject(new Error(\"Not an image\"));\n        return;\n      }\n\n      const reader = new FileReader();\n      reader.onload = (e) => {\n        resolve(e.target?.result as string);\n      };\n      reader.onerror = reject;\n      reader.readAsDataURL(file);\n    });\n  }, []);\n\n  const handleFileSelect = useCallback(\n    async (files: FileList | null) => {\n      if (!files || files.length === 0 || disabled) return;\n\n      const filesToUpload = Array.from(files);\n\n      // Validate file count\n      if (uploadedFiles.length + filesToUpload.length > maxFiles) {\n        alert(`Maximum ${maxFiles} files allowed`);\n        return;\n      }\n\n      // Validate file sizes\n      const maxSizeBytes = maxSizeMB * 1024 * 1024;\n      const oversizedFiles = filesToUpload.filter((f) => f.size > maxSizeBytes);\n      if (oversizedFiles.length > 0) {\n        alert(\n          `Files too large (max ${maxSizeMB}MB): ${oversizedFiles.map((f) => f.name).join(\", \")}`,\n        );\n        return;\n      }\n\n      // Initialize upload tracking\n      const uploadTracking = filesToUpload.map((file) => ({\n        file,\n        progress: 0,\n      }));\n      setUploadingFiles(uploadTracking);\n\n      // Upload files sequentially\n      const uploaded: UploadedFile[] = [];\n      for (let i = 0; i < filesToUpload.length; i++) {\n        const file = filesToUpload[i];\n\n        try {\n          // Update progress\n          setUploadingFiles((prev) =>\n            prev.map((item, idx) =>\n              idx === i ? { ...item, progress: 10 } : item,\n            ),\n          );\n\n          // Upload to backend\n          const document = (await apiClient.uploadDocument(\n            file,\n            \"chat-attachment\",\n          )) as { id: string; url?: string };\n\n          // Update progress\n          setUploadingFiles((prev) =>\n            prev.map((item, idx) =>\n              idx === i ? { ...item, progress: 70 } : item,\n            ),\n          );\n\n          // Generate preview for images\n          let preview: string | undefined;\n          try {\n            preview = await generatePreview(file);\n          } catch {\n            // Not an image, no preview needed\n          }\n\n          // Update progress\n          setUploadingFiles((prev) =>\n            prev.map((item, idx) =>\n              idx === i ? { ...item, progress: 100 } : item,\n            ),\n          );\n\n          // Add to uploaded files\n          const uploadedFile: UploadedFile = {\n            id: document.id,\n            name: file.name,\n            size: file.size,\n            type: file.type,\n            url: document.url,\n            preview,\n          };\n          uploaded.push(uploadedFile);\n        } catch (error) {\n          console.error(\"Upload failed:\", error);\n          setUploadingFiles((prev) =>\n            prev.map((item, idx) =>\n              idx === i\n                ? {\n                    ...item,\n                    progress: 0,\n                    error: \"Upload failed. Please try again.\",\n                  }\n                : item,\n            ),\n          );\n        }\n      }\n\n      // Clear upload tracking after a delay\n      setTimeout(() => setUploadingFiles([]), 2000);\n\n      // Update uploaded files list\n      setUploadedFiles((prev) => [...prev, ...uploaded]);\n      onFilesUploaded(uploaded);\n\n      // Reset input\n      if (fileInputRef.current) {\n        fileInputRef.current.value = \"\";\n      }\n    },\n    [\n      apiClient,\n      disabled,\n      maxFiles,\n      maxSizeMB,\n      uploadedFiles.length,\n      onFilesUploaded,\n      generatePreview,\n    ],\n  );\n\n  const handleRemoveFile = useCallback(\n    (fileId: string) => {\n      setUploadedFiles((prev) => prev.filter((f) => f.id !== fileId));\n      onFileRemoved?.(fileId);\n    },\n    [onFileRemoved],\n  );\n\n  const formatFileSize = (bytes: number): string => {\n    if (bytes === 0) return \"0 Bytes\";\n    const k = 1024;\n    const sizes = [\"Bytes\", \"KB\", \"MB\"];\n    const i = Math.floor(Math.log(bytes) / Math.log(k));\n    return Math.round((bytes / Math.pow(k, i)) * 100) / 100 + \" \" + sizes[i];\n  };\n\n  return (\n    <div className=\"space-y-3\">\n      {/* Upload Button */}\n      <label\n        className={`flex items-center justify-center w-full px-4 py-3 border-2 border-dashed rounded-lg transition-colors cursor-pointer ${\n          disabled\n            ? \"border-neutral-300 bg-neutral-100 cursor-not-allowed\"\n            : \"border-primary-300 hover:border-primary-400 hover:bg-primary-50\"\n        }`}\n      >\n        <div className=\"text-center\">\n          <svg\n            xmlns=\"http://www.w3.org/2000/svg\"\n            fill=\"none\"\n            viewBox=\"0 0 24 24\"\n            strokeWidth={1.5}\n            stroke=\"currentColor\"\n            className=\"w-8 h-8 mx-auto mb-2 text-primary-500\"\n          >\n            <path\n              strokeLinecap=\"round\"\n              strokeLinejoin=\"round\"\n              d=\"M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5\"\n            />\n          </svg>\n          <p className=\"text-sm text-neutral-700 font-medium\">\n            Click to upload or drag and drop\n          </p>\n          <p className=\"text-xs text-neutral-500 mt-1\">\n            PDF, Images, Text (max {maxSizeMB}MB each)\n          </p>\n        </div>\n        <input\n          ref={fileInputRef}\n          type=\"file\"\n          multiple\n          disabled={disabled}\n          accept={accept}\n          onChange={(e) => handleFileSelect(e.target.files)}\n          className=\"hidden\"\n        />\n      </label>\n\n      {/* Uploading Files */}\n      {uploadingFiles.length > 0 && (\n        <div className=\"space-y-2\">\n          {uploadingFiles.map((item, index) => (\n            <div\n              key={index}\n              className=\"flex items-center gap-3 p-3 bg-neutral-50 rounded-lg border border-neutral-200\"\n            >\n              <div className=\"flex-shrink-0\">\n                {item.error ? (\n                  <svg\n                    xmlns=\"http://www.w3.org/2000/svg\"\n                    fill=\"none\"\n                    viewBox=\"0 0 24 24\"\n                    strokeWidth={1.5}\n                    stroke=\"currentColor\"\n                    className=\"w-5 h-5 text-red-500\"\n                  >\n                    <path\n                      strokeLinecap=\"round\"\n                      strokeLinejoin=\"round\"\n                      d=\"M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z\"\n                    />\n                  </svg>\n                ) : item.progress === 100 ? (\n                  <svg\n                    xmlns=\"http://www.w3.org/2000/svg\"\n                    fill=\"none\"\n                    viewBox=\"0 0 24 24\"\n                    strokeWidth={1.5}\n                    stroke=\"currentColor\"\n                    className=\"w-5 h-5 text-green-500\"\n                  >\n                    <path\n                      strokeLinecap=\"round\"\n                      strokeLinejoin=\"round\"\n                      d=\"M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z\"\n                    />\n                  </svg>\n                ) : (\n                  <div className=\"w-5 h-5 rounded-full border-2 border-primary-500 border-t-transparent animate-spin\" />\n                )}\n              </div>\n\n              <div className=\"flex-1 min-w-0\">\n                <p className=\"text-sm font-medium text-neutral-900 truncate\">\n                  {item.file.name}\n                </p>\n                <div className=\"flex items-center gap-2 mt-1\">\n                  <div className=\"flex-1 bg-neutral-200 rounded-full h-1.5\">\n                    <div\n                      className={`h-1.5 rounded-full transition-all ${\n                        item.error\n                          ? \"bg-red-500\"\n                          : item.progress === 100\n                            ? \"bg-green-500\"\n                            : \"bg-primary-500\"\n                      }`}\n                      style={{ width: `${item.progress}%` }}\n                    />\n                  </div>\n                  <span className=\"text-xs text-neutral-500\">\n                    {item.error ? \"Failed\" : `${item.progress}%`}\n                  </span>\n                </div>\n                {item.error && (\n                  <p className=\"text-xs text-red-600 mt-1\">{item.error}</p>\n                )}\n              </div>\n            </div>\n          ))}\n        </div>\n      )}\n\n      {/* Uploaded Files */}\n      {uploadedFiles.length > 0 && (\n        <div className=\"space-y-2\">\n          <p className=\"text-sm font-medium text-neutral-700\">\n            Uploaded Files ({uploadedFiles.length}/{maxFiles})\n          </p>\n          {uploadedFiles.map((file) => (\n            <div\n              key={file.id}\n              className=\"flex items-center gap-3 p-3 bg-white rounded-lg border border-neutral-200 shadow-sm\"\n            >\n              {/* Preview or Icon */}\n              {file.preview ? (\n                <img\n                  src={file.preview}\n                  alt={file.name}\n                  className=\"w-12 h-12 object-cover rounded\"\n                />\n              ) : (\n                <div className=\"flex items-center justify-center w-12 h-12 bg-neutral-100 rounded\">\n                  <svg\n                    xmlns=\"http://www.w3.org/2000/svg\"\n                    fill=\"none\"\n                    viewBox=\"0 0 24 24\"\n                    strokeWidth={1.5}\n                    stroke=\"currentColor\"\n                    className=\"w-6 h-6 text-neutral-500\"\n                  >\n                    <path\n                      strokeLinecap=\"round\"\n                      strokeLinejoin=\"round\"\n                      d=\"M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z\"\n                    />\n                  </svg>\n                </div>\n              )}\n\n              {/* File Info */}\n              <div className=\"flex-1 min-w-0\">\n                <p className=\"text-sm font-medium text-neutral-900 truncate\">\n                  {file.name}\n                </p>\n                <p className=\"text-xs text-neutral-500\">\n                  {formatFileSize(file.size)}\n                </p>\n              </div>\n\n              {/* Remove Button */}\n              <button\n                type=\"button\"\n                onClick={() => handleRemoveFile(file.id)}\n                className=\"flex-shrink-0 p-1 text-neutral-400 hover:text-red-600 hover:bg-red-50 rounded transition-colors\"\n                aria-label=\"Remove file\"\n              >\n                <svg\n                  xmlns=\"http://www.w3.org/2000/svg\"\n                  fill=\"none\"\n                  viewBox=\"0 0 24 24\"\n                  strokeWidth={2}\n                  stroke=\"currentColor\"\n                  className=\"w-5 h-5\"\n                >\n                  <path\n                    strokeLinecap=\"round\"\n                    strokeLinejoin=\"round\"\n                    d=\"M6 18L18 6M6 6l12 12\"\n                  />\n                </svg>\n              </button>\n            </div>\n          ))}\n        </div>\n      )}\n    </div>\n  );\n}\n"
}

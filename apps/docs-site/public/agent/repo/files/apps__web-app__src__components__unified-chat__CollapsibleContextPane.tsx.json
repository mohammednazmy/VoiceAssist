{
  "path": "apps/web-app/src/components/unified-chat/CollapsibleContextPane.tsx",
  "language": "typescript",
  "size": 22736,
  "last_modified": "2025-12-03T23:50:35.642Z",
  "lines": 715,
  "content": "/**\n * Collapsible Context Pane\n *\n * Right-side panel for citations, clinical context, and conversation branches.\n */\n\nimport { useState, useMemo, useEffect } from \"react\";\nimport {\n  PanelRightClose,\n  PanelRightOpen,\n  FileText,\n  Stethoscope,\n  GitBranch,\n  Search,\n  Loader2,\n  AlertCircle,\n  Plus,\n  ChevronRight,\n  ExternalLink,\n  X,\n} from \"lucide-react\";\nimport { useUnifiedConversationStore } from \"../../stores/unifiedConversationStore\";\nimport { useClinicalContext } from \"../../hooks/useClinicalContext\";\nimport { useBranching } from \"../../hooks/useBranching\";\nimport { useIsMobile } from \"../../hooks/useIsMobile\";\nimport type { Citation } from \"../../types\";\n\ninterface CollapsibleContextPaneProps {\n  isOpen: boolean;\n  onToggle: () => void;\n  conversationId: string | null;\n}\n\ntype TabId = \"citations\" | \"clinical\" | \"branches\";\n\nexport function CollapsibleContextPane({\n  isOpen,\n  onToggle,\n  conversationId,\n}: CollapsibleContextPaneProps) {\n  const [activeTab, setActiveTab] = useState<TabId>(\"citations\");\n  const isMobile = useIsMobile();\n\n  // Collapsed state - hidden on mobile when closed\n  if (!isOpen) {\n    // On mobile, don't render anything when closed\n    if (isMobile) {\n      return null;\n    }\n    // On desktop, show collapsed sidebar\n    return (\n      <div className=\"w-12 border-l border-neutral-200 bg-white flex flex-col items-center py-4\">\n        <button\n          onClick={onToggle}\n          className=\"p-2 hover:bg-neutral-100 rounded-lg transition-colors\"\n          aria-label=\"Open context pane\"\n        >\n          <PanelRightOpen className=\"w-5 h-5 text-neutral-600\" />\n        </button>\n      </div>\n    );\n  }\n\n  const tabs = [\n    { id: \"citations\" as const, label: \"Citations\", icon: FileText },\n    { id: \"clinical\" as const, label: \"Clinical\", icon: Stethoscope },\n    { id: \"branches\" as const, label: \"Branches\", icon: GitBranch },\n  ];\n\n  // Pane content component\n  const paneContent = (\n    <aside\n      className={`${isMobile ? \"w-full\" : \"w-80\"} h-full border-l border-neutral-200 bg-white flex flex-col`}\n      aria-label=\"Context and references\"\n    >\n      {/* Header */}\n      <div className=\"flex items-center justify-between px-4 py-3 border-b border-neutral-100\">\n        <h2 className=\"font-semibold text-neutral-900\">Context</h2>\n        <button\n          onClick={onToggle}\n          className=\"p-1.5 hover:bg-neutral-100 rounded-lg transition-colors\"\n          aria-label=\"Close context pane\"\n        >\n          {isMobile ? (\n            <X className=\"w-5 h-5 text-neutral-500\" />\n          ) : (\n            <PanelRightClose className=\"w-5 h-5 text-neutral-500\" />\n          )}\n        </button>\n      </div>\n\n      {/* Tabs */}\n      <div\n        className=\"flex border-b border-neutral-100\"\n        role=\"tablist\"\n        aria-label=\"Context pane sections\"\n      >\n        {tabs.map((tab) => (\n          <button\n            key={tab.id}\n            role=\"tab\"\n            aria-selected={activeTab === tab.id}\n            aria-controls={`${tab.id}-panel`}\n            onClick={() => setActiveTab(tab.id)}\n            className={`flex-1 flex items-center justify-center gap-1.5 px-3 py-2.5 text-sm font-medium transition-colors ${\n              activeTab === tab.id\n                ? \"text-primary-600 border-b-2 border-primary-600\"\n                : \"text-neutral-500 hover:text-neutral-700\"\n            }`}\n          >\n            <tab.icon className=\"w-4 h-4\" />\n            <span>{tab.label}</span>\n          </button>\n        ))}\n      </div>\n\n      {/* Tab Content */}\n      <div\n        id={`${activeTab}-panel`}\n        className=\"flex-1 overflow-y-auto p-4\"\n        role=\"tabpanel\"\n        aria-label={`${activeTab} content`}\n      >\n        {activeTab === \"citations\" && (\n          <CitationsTab conversationId={conversationId} />\n        )}\n        {activeTab === \"clinical\" && (\n          <ClinicalTab conversationId={conversationId} />\n        )}\n        {activeTab === \"branches\" && (\n          <BranchesTab conversationId={conversationId} />\n        )}\n      </div>\n    </aside>\n  );\n\n  // On mobile, wrap with overlay backdrop\n  if (isMobile) {\n    return (\n      <div className=\"fixed inset-0 z-40 flex justify-end\">\n        {/* Backdrop */}\n        <div\n          className=\"absolute inset-0 bg-black/50 transition-opacity duration-200\"\n          onClick={onToggle}\n          aria-hidden=\"true\"\n        />\n        {/* Pane - slide in from right */}\n        <div className=\"relative z-50 h-full w-full max-w-md shadow-xl\">\n          {paneContent}\n        </div>\n      </div>\n    );\n  }\n\n  // Desktop: render inline\n  return paneContent;\n}\n\n// ============================================================================\n// Tab Components\n// ============================================================================\n\nfunction CitationsTab({\n  conversationId: _conversationId,\n}: {\n  conversationId: string | null;\n}) {\n  const messages = useUnifiedConversationStore((state) => state.messages);\n  const [searchQuery, setSearchQuery] = useState(\"\");\n\n  // Aggregate citations from all messages\n  const allCitations = useMemo(() => {\n    const citationsMap = new Map<\n      string,\n      { citation: Citation; messageIndex: number }\n    >();\n\n    messages.forEach((message, index) => {\n      const citations = message.metadata?.citations || message.citations || [];\n\n      citations.forEach((citation: Citation) => {\n        if (!citationsMap.has(citation.id)) {\n          citationsMap.set(citation.id, {\n            citation,\n            messageIndex: index + 1,\n          });\n        }\n      });\n    });\n\n    return Array.from(citationsMap.values());\n  }, [messages]);\n\n  // Filter citations by search query\n  const filteredCitations = useMemo(() => {\n    if (!searchQuery.trim()) return allCitations;\n\n    const query = searchQuery.toLowerCase();\n    return allCitations.filter(({ citation }) => {\n      const searchableText = [\n        citation.title,\n        citation.subtitle,\n        citation.reference,\n        citation.snippet,\n        citation.authors?.join(\" \"),\n      ]\n        .filter(Boolean)\n        .join(\" \")\n        .toLowerCase();\n\n      return searchableText.includes(query);\n    });\n  }, [allCitations, searchQuery]);\n\n  if (allCitations.length === 0) {\n    return (\n      <div className=\"text-center text-neutral-500 py-8\">\n        <FileText className=\"w-12 h-12 mx-auto mb-3 text-neutral-300\" />\n        <p className=\"text-sm\">No citations yet</p>\n        <p className=\"text-xs mt-1\">\n          Citations from AI responses will appear here\n        </p>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-4\">\n      {/* Search */}\n      <div className=\"relative\">\n        <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-neutral-400\" />\n        <input\n          type=\"text\"\n          placeholder=\"Search citations...\"\n          value={searchQuery}\n          onChange={(e) => setSearchQuery(e.target.value)}\n          className=\"w-full pl-9 pr-3 py-2 text-sm border border-neutral-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent\"\n        />\n      </div>\n\n      {/* Citation Count */}\n      <p className=\"text-xs text-neutral-500\">\n        {filteredCitations.length} of {allCitations.length} citations\n      </p>\n\n      {/* Citations List */}\n      {filteredCitations.length === 0 ? (\n        <div className=\"text-center text-neutral-500 py-4\">\n          <p className=\"text-sm\">No citations match your search</p>\n        </div>\n      ) : (\n        <div className=\"space-y-3\">\n          {filteredCitations.map(({ citation, messageIndex }) => (\n            <div\n              key={citation.id}\n              className=\"p-3 bg-neutral-50 rounded-lg border border-neutral-200\"\n            >\n              <h4 className=\"text-sm font-medium text-neutral-900 line-clamp-2\">\n                {citation.title}\n              </h4>\n              {citation.subtitle && (\n                <p className=\"text-xs text-neutral-600 mt-1\">\n                  {citation.subtitle}\n                </p>\n              )}\n              {citation.reference && (\n                <p className=\"text-xs text-neutral-500 mt-1 italic\">\n                  {citation.reference}\n                </p>\n              )}\n              <div className=\"flex items-center justify-between mt-2\">\n                <span className=\"text-xs text-neutral-400\">\n                  Message #{messageIndex}\n                </span>\n                {citation.url && (\n                  <a\n                    href={citation.url}\n                    target=\"_blank\"\n                    rel=\"noopener noreferrer\"\n                    className=\"text-xs text-primary-600 hover:text-primary-700 flex items-center gap-1\"\n                  >\n                    View <ExternalLink className=\"w-3 h-3\" />\n                  </a>\n                )}\n              </div>\n            </div>\n          ))}\n        </div>\n      )}\n    </div>\n  );\n}\n\nfunction ClinicalTab({ conversationId }: { conversationId: string | null }) {\n  const { context, isLoading, error, saveContext, deleteContext, hasContext } =\n    useClinicalContext(conversationId || undefined);\n\n  const [isEditing, setIsEditing] = useState(false);\n  const [formData, setFormData] = useState({\n    age: \"\",\n    gender: \"\",\n    chiefComplaint: \"\",\n    problems: \"\",\n    medications: \"\",\n    allergies: \"\",\n  });\n\n  // Initialize form when context loads\n  useEffect(() => {\n    if (context) {\n      setFormData({\n        age: context.age?.toString() || \"\",\n        gender: context.gender || \"\",\n        chiefComplaint: context.chiefComplaint || \"\",\n        problems: context.problems?.join(\", \") || \"\",\n        medications: context.medications?.join(\", \") || \"\",\n        allergies: context.allergies?.join(\", \") || \"\",\n      });\n    }\n  }, [context]);\n\n  const handleSave = async () => {\n    try {\n      await saveContext({\n        age: formData.age ? parseInt(formData.age) : undefined,\n        gender: formData.gender || undefined,\n        chiefComplaint: formData.chiefComplaint || undefined,\n        problems: formData.problems\n          ? formData.problems\n              .split(\",\")\n              .map((s) => s.trim())\n              .filter(Boolean)\n          : undefined,\n        medications: formData.medications\n          ? formData.medications\n              .split(\",\")\n              .map((s) => s.trim())\n              .filter(Boolean)\n          : undefined,\n        allergies: formData.allergies\n          ? formData.allergies\n              .split(\",\")\n              .map((s) => s.trim())\n              .filter(Boolean)\n          : undefined,\n      });\n      setIsEditing(false);\n    } catch {\n      // Error handled by hook\n    }\n  };\n\n  const handleDelete = async () => {\n    if (\n      window.confirm(\"Are you sure you want to remove the clinical context?\")\n    ) {\n      try {\n        await deleteContext();\n      } catch {\n        // Error handled by hook\n      }\n    }\n  };\n\n  if (isLoading && !context) {\n    return (\n      <div className=\"flex items-center justify-center py-8\">\n        <Loader2 className=\"w-6 h-6 text-primary-500 animate-spin\" />\n      </div>\n    );\n  }\n\n  if (error) {\n    return (\n      <div className=\"text-center text-neutral-500 py-8\">\n        <AlertCircle className=\"w-12 h-12 mx-auto mb-3 text-error-400\" />\n        <p className=\"text-sm text-error-600\">{error}</p>\n      </div>\n    );\n  }\n\n  if (!hasContext && !isEditing) {\n    return (\n      <div className=\"text-center text-neutral-500 py-8\">\n        <Stethoscope className=\"w-12 h-12 mx-auto mb-3 text-neutral-300\" />\n        <p className=\"text-sm\">No clinical context</p>\n        <p className=\"text-xs mt-1\">Add patient context to enhance responses</p>\n        <button\n          onClick={() => setIsEditing(true)}\n          className=\"mt-4 px-4 py-2 bg-primary-600 text-white text-sm rounded-lg hover:bg-primary-700 transition-colors flex items-center gap-2 mx-auto\"\n        >\n          <Plus className=\"w-4 h-4\" />\n          Add Context\n        </button>\n      </div>\n    );\n  }\n\n  if (isEditing) {\n    return (\n      <div className=\"space-y-4\">\n        <div>\n          <label className=\"block text-xs font-medium text-neutral-700 mb-1\">\n            Age\n          </label>\n          <input\n            type=\"number\"\n            value={formData.age}\n            onChange={(e) => setFormData({ ...formData, age: e.target.value })}\n            className=\"w-full px-3 py-2 text-sm border border-neutral-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500\"\n            placeholder=\"e.g., 45\"\n          />\n        </div>\n\n        <div>\n          <label className=\"block text-xs font-medium text-neutral-700 mb-1\">\n            Gender\n          </label>\n          <select\n            value={formData.gender}\n            onChange={(e) =>\n              setFormData({ ...formData, gender: e.target.value })\n            }\n            className=\"w-full px-3 py-2 text-sm border border-neutral-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500\"\n          >\n            <option value=\"\">Select...</option>\n            <option value=\"male\">Male</option>\n            <option value=\"female\">Female</option>\n            <option value=\"other\">Other</option>\n          </select>\n        </div>\n\n        <div>\n          <label className=\"block text-xs font-medium text-neutral-700 mb-1\">\n            Chief Complaint\n          </label>\n          <textarea\n            value={formData.chiefComplaint}\n            onChange={(e) =>\n              setFormData({ ...formData, chiefComplaint: e.target.value })\n            }\n            className=\"w-full px-3 py-2 text-sm border border-neutral-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500\"\n            rows={2}\n            placeholder=\"Primary reason for consultation\"\n          />\n        </div>\n\n        <div>\n          <label className=\"block text-xs font-medium text-neutral-700 mb-1\">\n            Problems / Diagnoses\n          </label>\n          <textarea\n            value={formData.problems}\n            onChange={(e) =>\n              setFormData({ ...formData, problems: e.target.value })\n            }\n            className=\"w-full px-3 py-2 text-sm border border-neutral-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500\"\n            rows={2}\n            placeholder=\"Comma-separated list of problems\"\n          />\n        </div>\n\n        <div>\n          <label className=\"block text-xs font-medium text-neutral-700 mb-1\">\n            Medications\n          </label>\n          <input\n            type=\"text\"\n            value={formData.medications}\n            onChange={(e) =>\n              setFormData({ ...formData, medications: e.target.value })\n            }\n            className=\"w-full px-3 py-2 text-sm border border-neutral-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500\"\n            placeholder=\"Comma-separated list\"\n          />\n        </div>\n\n        <div>\n          <label className=\"block text-xs font-medium text-neutral-700 mb-1\">\n            Allergies\n          </label>\n          <input\n            type=\"text\"\n            value={formData.allergies}\n            onChange={(e) =>\n              setFormData({ ...formData, allergies: e.target.value })\n            }\n            className=\"w-full px-3 py-2 text-sm border border-neutral-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500\"\n            placeholder=\"Comma-separated list\"\n          />\n        </div>\n\n        <div className=\"flex gap-2\">\n          <button\n            onClick={handleSave}\n            disabled={isLoading}\n            className=\"flex-1 px-4 py-2 bg-primary-600 text-white text-sm rounded-lg hover:bg-primary-700 transition-colors disabled:opacity-50\"\n          >\n            {isLoading ? \"Saving...\" : \"Save\"}\n          </button>\n          <button\n            onClick={() => setIsEditing(false)}\n            className=\"px-4 py-2 bg-neutral-100 text-neutral-700 text-sm rounded-lg hover:bg-neutral-200 transition-colors\"\n          >\n            Cancel\n          </button>\n        </div>\n      </div>\n    );\n  }\n\n  // Display existing context\n  return (\n    <div className=\"space-y-4\">\n      <div className=\"flex items-center justify-between\">\n        <h4 className=\"text-sm font-medium text-neutral-900\">\n          Patient Context\n        </h4>\n        <div className=\"flex gap-2\">\n          <button\n            onClick={() => setIsEditing(true)}\n            className=\"text-xs text-primary-600 hover:text-primary-700\"\n          >\n            Edit\n          </button>\n          <button\n            onClick={handleDelete}\n            className=\"text-xs text-error-600 hover:text-error-700\"\n          >\n            Remove\n          </button>\n        </div>\n      </div>\n\n      <div className=\"space-y-3 text-sm\">\n        {context?.age && (\n          <div>\n            <span className=\"text-neutral-500\">Age:</span>{\" \"}\n            <span className=\"text-neutral-900\">{context.age}</span>\n          </div>\n        )}\n        {context?.gender && (\n          <div>\n            <span className=\"text-neutral-500\">Gender:</span>{\" \"}\n            <span className=\"text-neutral-900 capitalize\">\n              {context.gender}\n            </span>\n          </div>\n        )}\n        {context?.chiefComplaint && (\n          <div>\n            <span className=\"text-neutral-500\">Chief Complaint:</span>\n            <p className=\"text-neutral-900 mt-1\">{context.chiefComplaint}</p>\n          </div>\n        )}\n        {context?.problems && context.problems.length > 0 && (\n          <div>\n            <span className=\"text-neutral-500\">Problems / Diagnoses:</span>\n            <p className=\"text-neutral-900 mt-1\">\n              {context.problems.join(\", \")}\n            </p>\n          </div>\n        )}\n        {context?.medications && context.medications.length > 0 && (\n          <div>\n            <span className=\"text-neutral-500\">Medications:</span>\n            <p className=\"text-neutral-900 mt-1\">\n              {context.medications.join(\", \")}\n            </p>\n          </div>\n        )}\n        {context?.allergies && context.allergies.length > 0 && (\n          <div>\n            <span className=\"text-neutral-500\">Allergies:</span>\n            <p className=\"text-neutral-900 mt-1\">\n              {context.allergies.join(\", \")}\n            </p>\n          </div>\n        )}\n      </div>\n    </div>\n  );\n}\n\nfunction BranchesTab({ conversationId }: { conversationId: string | null }) {\n  const { branches, currentBranchId, isLoading, error, switchBranch } =\n    useBranching(conversationId);\n\n  if (isLoading && branches.length === 0) {\n    return (\n      <div className=\"flex items-center justify-center py-8\">\n        <Loader2 className=\"w-6 h-6 text-primary-500 animate-spin\" />\n      </div>\n    );\n  }\n\n  if (error) {\n    return (\n      <div className=\"text-center text-neutral-500 py-8\">\n        <AlertCircle className=\"w-12 h-12 mx-auto mb-3 text-error-400\" />\n        <p className=\"text-sm text-error-600\">{error}</p>\n      </div>\n    );\n  }\n\n  if (branches.length === 0) {\n    return (\n      <div className=\"text-center text-neutral-500 py-8\">\n        <GitBranch className=\"w-12 h-12 mx-auto mb-3 text-neutral-300\" />\n        <p className=\"text-sm\">No branches</p>\n        <p className=\"text-xs mt-1\">\n          Create branches to explore alternative responses\n        </p>\n        <p className=\"text-xs mt-3 text-neutral-400\">\n          Click the branch icon on any message to create a branch from that\n          point\n        </p>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-4\">\n      <p className=\"text-xs text-neutral-500\">\n        {branches.length} branch{branches.length === 1 ? \"\" : \"es\"}\n      </p>\n\n      <div className=\"space-y-2\">\n        {/* Main branch */}\n        <button\n          onClick={() => switchBranch(\"main\")}\n          className={`w-full flex items-center gap-3 p-3 rounded-lg border transition-colors ${\n            currentBranchId === \"main\"\n              ? \"bg-primary-50 border-primary-200\"\n              : \"bg-neutral-50 border-neutral-200 hover:bg-neutral-100\"\n          }`}\n        >\n          <GitBranch\n            className={`w-4 h-4 ${\n              currentBranchId === \"main\"\n                ? \"text-primary-600\"\n                : \"text-neutral-400\"\n            }`}\n          />\n          <div className=\"flex-1 text-left\">\n            <p\n              className={`text-sm font-medium ${\n                currentBranchId === \"main\"\n                  ? \"text-primary-900\"\n                  : \"text-neutral-900\"\n              }`}\n            >\n              Main\n            </p>\n            <p className=\"text-xs text-neutral-500\">Original conversation</p>\n          </div>\n          {currentBranchId === \"main\" && (\n            <span className=\"text-xs text-primary-600 font-medium\">Active</span>\n          )}\n        </button>\n\n        {/* Other branches */}\n        {branches.map((branch) => (\n          <button\n            key={branch.branchId}\n            onClick={() => switchBranch(branch.branchId)}\n            className={`w-full flex items-center gap-3 p-3 rounded-lg border transition-colors ${\n              currentBranchId === branch.branchId\n                ? \"bg-primary-50 border-primary-200\"\n                : \"bg-neutral-50 border-neutral-200 hover:bg-neutral-100\"\n            }`}\n          >\n            <GitBranch\n              className={`w-4 h-4 ${\n                currentBranchId === branch.branchId\n                  ? \"text-primary-600\"\n                  : \"text-neutral-400\"\n              }`}\n            />\n            <div className=\"flex-1 text-left\">\n              <p\n                className={`text-sm font-medium ${\n                  currentBranchId === branch.branchId\n                    ? \"text-primary-900\"\n                    : \"text-neutral-900\"\n                }`}\n              >\n                Branch {branch.branchId.slice(0, 8)}\n              </p>\n              <p className=\"text-xs text-neutral-500\">\n                {branch.messageCount} message\n                {branch.messageCount === 1 ? \"\" : \"s\"} Â· Created{\" \"}\n                {new Date(branch.createdAt).toLocaleDateString()}\n              </p>\n            </div>\n            <ChevronRight\n              className={`w-4 h-4 ${\n                currentBranchId === branch.branchId\n                  ? \"text-primary-600\"\n                  : \"text-neutral-300\"\n              }`}\n            />\n          </button>\n        ))}\n      </div>\n\n      <p className=\"text-xs text-neutral-400 mt-4\">\n        Switch between branches to explore different conversation paths\n      </p>\n    </div>\n  );\n}\n\nexport default CollapsibleContextPane;\n"
}

{
  "path": "services/api-gateway/app/models/voice_session_metrics.py",
  "language": "python",
  "size": 6337,
  "last_modified": "2025-12-05T03:07:13.132Z",
  "lines": 146,
  "content": "\"\"\"Voice Session Metrics Model (Phase 11.1).\n\nStores analytics data for voice sessions including latency metrics,\nprovider usage, costs, and quality indicators.\n\"\"\"\n\nfrom __future__ import annotations\n\nfrom datetime import datetime\nfrom typing import Any, Dict\nfrom uuid import UUID\n\nfrom app.core.database import Base\nfrom sqlalchemy import JSON, Column, DateTime, ForeignKey, Integer, Numeric, String\nfrom sqlalchemy.dialects.postgresql import UUID as PGUUID\n\n\nclass VoiceSessionMetrics(Base):\n    \"\"\"Voice session metrics model for analytics.\n\n    Attributes:\n        id: Unique identifier\n        session_id: Voice session identifier\n        user_id: User who initiated the session\n        started_at: When the session started\n        ended_at: When the session ended\n        duration_seconds: Total session duration\n        stt_latency_avg_ms: Average STT latency\n        tts_latency_avg_ms: Average TTS latency\n        response_latency_avg_ms: Average response latency\n        tts_provider: TTS provider used (openai, elevenlabs)\n        voice_id: Voice ID used\n        estimated_cost_usd: Total estimated cost\n        error_count: Number of errors during session\n    \"\"\"\n\n    __tablename__ = \"voice_session_metrics\"\n\n    id = Column(PGUUID(as_uuid=True), primary_key=True)\n    session_id = Column(String(255), nullable=False, index=True)\n    user_id = Column(\n        PGUUID(as_uuid=True),\n        ForeignKey(\"users.id\", ondelete=\"CASCADE\"),\n        nullable=False,\n        index=True,\n    )\n\n    # Timing\n    started_at = Column(DateTime(timezone=True), nullable=False)\n    ended_at = Column(DateTime(timezone=True), nullable=True)\n    duration_seconds = Column(Numeric(10, 2), nullable=True)\n\n    # Latency metrics (milliseconds)\n    stt_latency_avg_ms = Column(Numeric(10, 2), nullable=True)\n    stt_latency_p95_ms = Column(Numeric(10, 2), nullable=True)\n    tts_latency_avg_ms = Column(Numeric(10, 2), nullable=True)\n    tts_latency_p95_ms = Column(Numeric(10, 2), nullable=True)\n    response_latency_avg_ms = Column(Numeric(10, 2), nullable=True)\n    response_latency_p95_ms = Column(Numeric(10, 2), nullable=True)\n\n    # Provider info\n    stt_provider = Column(String(50), nullable=True)\n    tts_provider = Column(String(50), nullable=True)\n    voice_id = Column(String(100), nullable=True)\n    language = Column(String(10), nullable=True)\n\n    # Usage metrics\n    message_count = Column(Integer, nullable=True, default=0)\n    audio_seconds_processed = Column(Numeric(10, 2), nullable=True)\n    characters_synthesized = Column(Integer, nullable=True, default=0)\n\n    # Cost tracking\n    estimated_cost_usd = Column(Numeric(10, 6), nullable=True)\n    stt_cost_usd = Column(Numeric(10, 6), nullable=True)\n    tts_cost_usd = Column(Numeric(10, 6), nullable=True)\n    llm_cost_usd = Column(Numeric(10, 6), nullable=True)\n\n    # Quality metrics\n    error_count = Column(Integer, nullable=True, default=0)\n    echo_detection_count = Column(Integer, nullable=True, default=0)\n    vad_trigger_count = Column(Integer, nullable=True, default=0)\n\n    # Session metadata\n    session_type = Column(String(50), nullable=True)\n    client_info = Column(JSON, nullable=True)\n    session_metadata = Column(JSON, nullable=True)  # Named to avoid SQLAlchemy reserved 'metadata'\n\n    # Timestamps\n    created_at = Column(DateTime(timezone=True), nullable=False, default=datetime.utcnow)\n\n    def __repr__(self):\n        return f\"<VoiceSessionMetrics(session_id='{self.session_id}', user_id='{self.user_id}')>\"\n\n    def to_dict(self) -> Dict[str, Any]:\n        \"\"\"Convert model to dictionary.\"\"\"\n        return {\n            \"id\": str(self.id) if self.id else None,\n            \"session_id\": self.session_id,\n            \"user_id\": str(self.user_id) if self.user_id else None,\n            \"started_at\": self.started_at.isoformat() if self.started_at else None,\n            \"ended_at\": self.ended_at.isoformat() if self.ended_at else None,\n            \"duration_seconds\": (float(self.duration_seconds) if self.duration_seconds else None),\n            \"stt_latency_avg_ms\": (float(self.stt_latency_avg_ms) if self.stt_latency_avg_ms else None),\n            \"stt_latency_p95_ms\": (float(self.stt_latency_p95_ms) if self.stt_latency_p95_ms else None),\n            \"tts_latency_avg_ms\": (float(self.tts_latency_avg_ms) if self.tts_latency_avg_ms else None),\n            \"tts_latency_p95_ms\": (float(self.tts_latency_p95_ms) if self.tts_latency_p95_ms else None),\n            \"response_latency_avg_ms\": (float(self.response_latency_avg_ms) if self.response_latency_avg_ms else None),\n            \"response_latency_p95_ms\": (float(self.response_latency_p95_ms) if self.response_latency_p95_ms else None),\n            \"stt_provider\": self.stt_provider,\n            \"tts_provider\": self.tts_provider,\n            \"voice_id\": self.voice_id,\n            \"language\": self.language,\n            \"message_count\": self.message_count,\n            \"audio_seconds_processed\": (float(self.audio_seconds_processed) if self.audio_seconds_processed else None),\n            \"characters_synthesized\": self.characters_synthesized,\n            \"estimated_cost_usd\": (float(self.estimated_cost_usd) if self.estimated_cost_usd else None),\n            \"stt_cost_usd\": float(self.stt_cost_usd) if self.stt_cost_usd else None,\n            \"tts_cost_usd\": float(self.tts_cost_usd) if self.tts_cost_usd else None,\n            \"llm_cost_usd\": float(self.llm_cost_usd) if self.llm_cost_usd else None,\n            \"error_count\": self.error_count,\n            \"echo_detection_count\": self.echo_detection_count,\n            \"vad_trigger_count\": self.vad_trigger_count,\n            \"session_type\": self.session_type,\n            \"client_info\": self.client_info,\n            \"session_metadata\": self.session_metadata,\n            \"created_at\": self.created_at.isoformat() if self.created_at else None,\n        }\n\n    @classmethod\n    def from_session_data(\n        cls,\n        session_id: str,\n        user_id: UUID,\n        started_at: datetime,\n        session_type: str = \"voice\",\n        **kwargs,\n    ) -> \"VoiceSessionMetrics\":\n        \"\"\"Create a new metrics record from session data.\"\"\"\n        return cls(\n            session_id=session_id,\n            user_id=user_id,\n            started_at=started_at,\n            session_type=session_type,\n            **kwargs,\n        )\n"
}

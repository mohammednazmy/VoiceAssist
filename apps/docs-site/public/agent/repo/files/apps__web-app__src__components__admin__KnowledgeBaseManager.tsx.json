{
  "path": "apps/web-app/src/components/admin/KnowledgeBaseManager.tsx",
  "language": "typescript",
  "size": 23908,
  "last_modified": "2025-12-03T23:50:35.642Z",
  "lines": 650,
  "content": "/**\n * Knowledge Base Manager\n * Upload, manage, and index documents for RAG\n *\n * Phase 8.3: Added document preview modal\n */\n\nimport { useState, useEffect, useCallback } from \"react\";\nimport { useAuth } from \"../../hooks/useAuth\";\nimport type {\n  AdminKBDocument,\n  AdminKBDocumentDetail,\n} from \"@voiceassist/api-client\";\n\ninterface Document {\n  id: string;\n  title: string;\n  filename: string;\n  fileType: string;\n  size: number;\n  uploadedAt: string;\n  status: \"indexed\" | \"processing\" | \"failed\";\n  chunks?: number;\n}\n\ninterface DocumentPreview {\n  detail: AdminKBDocumentDetail;\n  isLoading: boolean;\n}\n\n/** Convert API document to local Document type */\nfunction apiDocToLocal(doc: AdminKBDocument): Document {\n  return {\n    id: doc.document_id,\n    title: doc.title,\n    filename: doc.title, // API doesn't return filename in list, use title\n    fileType: doc.source_type,\n    size: 0, // Not available in list response\n    uploadedAt: doc.upload_date,\n    status: \"indexed\",\n    chunks: doc.chunks_indexed,\n  };\n}\n\n/** Convert detailed API document to local Document type */\nfunction _apiDetailToLocal(doc: AdminKBDocumentDetail): Document {\n  const metadata = doc.metadata as { file_size?: number } | undefined;\n  return {\n    id: doc.document_id,\n    title: doc.title,\n    filename: doc.filename,\n    fileType: doc.file_type,\n    size: metadata?.file_size ?? 0,\n    uploadedAt: doc.created_at,\n    status:\n      doc.indexing_status === \"indexed\"\n        ? \"indexed\"\n        : doc.indexing_status === \"processing\"\n          ? \"processing\"\n          : \"failed\",\n    chunks: doc.chunks_indexed,\n  };\n}\n\nexport function KnowledgeBaseManager() {\n  const { apiClient } = useAuth();\n  const [documents, setDocuments] = useState<Document[]>([]);\n  const [isLoading, setIsLoading] = useState(true);\n  const [isUploading, setIsUploading] = useState(false);\n  const [uploadProgress, setUploadProgress] = useState(0);\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [error, setError] = useState<string | null>(null);\n  // Phase 8.3: Preview state\n  const [preview, setPreview] = useState<DocumentPreview | null>(null);\n  const [isLoadingPreview, setIsLoadingPreview] = useState(false);\n\n  const loadDocuments = useCallback(async () => {\n    try {\n      setError(null);\n      const response = await apiClient.getAdminKBDocuments(0, 100);\n      const localDocs = response.documents.map(apiDocToLocal);\n      setDocuments(localDocs);\n      setIsLoading(false);\n    } catch (err) {\n      console.error(\"Failed to load documents:\", err);\n      setError(err instanceof Error ? err.message : \"Failed to load documents\");\n      setIsLoading(false);\n    }\n  }, [apiClient]);\n\n  useEffect(() => {\n    loadDocuments();\n  }, [loadDocuments]);\n\n  const handleFileUpload = async (\n    event: React.ChangeEvent<HTMLInputElement>,\n  ) => {\n    const files = event.target.files;\n    if (!files || files.length === 0) return;\n\n    setIsUploading(true);\n    setUploadProgress(0);\n    setError(null);\n\n    try {\n      for (const file of Array.from(files)) {\n        await apiClient.uploadAdminKBDocument(\n          file,\n          undefined, // Use filename as title\n          \"uploaded\",\n          (progress) => setUploadProgress(progress),\n        );\n      }\n\n      await loadDocuments();\n    } catch (err) {\n      console.error(\"Upload failed:\", err);\n      setError(err instanceof Error ? err.message : \"Upload failed\");\n    } finally {\n      setIsUploading(false);\n      setUploadProgress(0);\n      event.target.value = \"\";\n    }\n  };\n\n  const handleDelete = async (id: string) => {\n    if (!confirm(\"Are you sure you want to delete this document?\")) return;\n\n    try {\n      setError(null);\n      await apiClient.deleteAdminKBDocument(id);\n      // Remove from local state immediately for better UX\n      setDocuments((docs) => docs.filter((d) => d.id !== id));\n    } catch (err) {\n      console.error(\"Delete failed:\", err);\n      setError(err instanceof Error ? err.message : \"Delete failed\");\n    }\n  };\n\n  const handleReindex = async (id: string) => {\n    // TODO: Backend doesn't have reindex endpoint yet\n    // When implemented, call: await apiClient.reindexAdminKBDocument(id);\n    setError(\n      `Reindex for document ${id} is not yet implemented. Delete and re-upload the document to reindex.`,\n    );\n  };\n\n  // Phase 8.3: Preview document\n  const handlePreview = async (docId: string) => {\n    setIsLoadingPreview(true);\n    setError(null);\n    try {\n      const detail = await apiClient.getAdminKBDocument(docId);\n      setPreview({ detail, isLoading: false });\n    } catch (err) {\n      console.error(\"Failed to load document preview:\", err);\n      setError(err instanceof Error ? err.message : \"Failed to load preview\");\n    } finally {\n      setIsLoadingPreview(false);\n    }\n  };\n\n  const closePreview = () => {\n    setPreview(null);\n  };\n\n  const formatFileSize = (bytes: number) => {\n    if (bytes < 1024) return bytes + \" B\";\n    if (bytes < 1048576) return (bytes / 1024).toFixed(1) + \" KB\";\n    return (bytes / 1048576).toFixed(1) + \" MB\";\n  };\n\n  const getStatusBadge = (status: Document[\"status\"]) => {\n    switch (status) {\n      case \"indexed\":\n        return (\n          <span className=\"px-2 py-1 text-xs font-medium text-green-700 bg-green-100 rounded-full\">\n            Indexed\n          </span>\n        );\n      case \"processing\":\n        return (\n          <span className=\"px-2 py-1 text-xs font-medium text-yellow-700 bg-yellow-100 rounded-full\">\n            Processing...\n          </span>\n        );\n      case \"failed\":\n        return (\n          <span className=\"px-2 py-1 text-xs font-medium text-red-700 bg-red-100 rounded-full\">\n            Failed\n          </span>\n        );\n    }\n  };\n\n  const filteredDocuments = documents.filter(\n    (doc) =>\n      doc.title.toLowerCase().includes(searchQuery.toLowerCase()) ||\n      doc.filename.toLowerCase().includes(searchQuery.toLowerCase()),\n  );\n\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center justify-center h-full\">\n        <div className=\"text-center\">\n          <div className=\"w-12 h-12 mx-auto mb-4 rounded-full border-4 border-primary-500 border-t-transparent animate-spin\" />\n          <p className=\"text-neutral-600\">Loading knowledge base...</p>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-2xl font-bold text-neutral-900\">\n            Knowledge Base\n          </h1>\n          <p className=\"text-sm text-neutral-600\">\n            Manage medical documents for RAG system\n          </p>\n        </div>\n        <div className=\"flex items-center space-x-3\">\n          <input\n            type=\"file\"\n            id=\"file-upload\"\n            className=\"hidden\"\n            accept=\".pdf,.txt,.md,.docx\"\n            multiple\n            onChange={handleFileUpload}\n            disabled={isUploading}\n          />\n          <label htmlFor=\"file-upload\" className=\"cursor-pointer\">\n            <span\n              className={`inline-flex items-center justify-center gap-2 rounded-md font-medium transition-all h-10 px-4 py-2 text-base bg-primary-600 text-white hover:bg-primary-700 ${isUploading ? \"opacity-50 pointer-events-none\" : \"\"}`}\n            >\n              {isUploading ? (\n                <>\n                  <div className=\"w-4 h-4 mr-2 border-2 border-white border-t-transparent rounded-full animate-spin\" />\n                  {uploadProgress > 0 ? `${uploadProgress}%` : \"Uploading...\"}\n                </>\n              ) : (\n                <>\n                  <svg\n                    xmlns=\"http://www.w3.org/2000/svg\"\n                    fill=\"none\"\n                    viewBox=\"0 0 24 24\"\n                    strokeWidth={2}\n                    stroke=\"currentColor\"\n                    className=\"w-4 h-4 mr-2\"\n                  >\n                    <path\n                      strokeLinecap=\"round\"\n                      strokeLinejoin=\"round\"\n                      d=\"M12 4.5v15m7.5-7.5h-15\"\n                    />\n                  </svg>\n                  Upload Documents\n                </>\n              )}\n            </span>\n          </label>\n        </div>\n      </div>\n\n      {/* Error Banner */}\n      {error && (\n        <div className=\"bg-red-50 border border-red-200 rounded-lg p-4 flex items-start gap-3\">\n          <svg\n            xmlns=\"http://www.w3.org/2000/svg\"\n            fill=\"none\"\n            viewBox=\"0 0 24 24\"\n            strokeWidth={1.5}\n            stroke=\"currentColor\"\n            className=\"w-5 h-5 text-red-500 flex-shrink-0 mt-0.5\"\n          >\n            <path\n              strokeLinecap=\"round\"\n              strokeLinejoin=\"round\"\n              d=\"M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z\"\n            />\n          </svg>\n          <div className=\"flex-1\">\n            <p className=\"text-sm text-red-700\">{error}</p>\n          </div>\n          <button\n            onClick={() => setError(null)}\n            className=\"text-red-500 hover:text-red-700\"\n          >\n            <svg\n              xmlns=\"http://www.w3.org/2000/svg\"\n              fill=\"none\"\n              viewBox=\"0 0 24 24\"\n              strokeWidth={1.5}\n              stroke=\"currentColor\"\n              className=\"w-5 h-5\"\n            >\n              <path\n                strokeLinecap=\"round\"\n                strokeLinejoin=\"round\"\n                d=\"M6 18L18 6M6 6l12 12\"\n              />\n            </svg>\n          </button>\n        </div>\n      )}\n\n      {/* Search */}\n      <div className=\"relative\">\n        <svg\n          xmlns=\"http://www.w3.org/2000/svg\"\n          fill=\"none\"\n          viewBox=\"0 0 24 24\"\n          strokeWidth={1.5}\n          stroke=\"currentColor\"\n          className=\"w-5 h-5 absolute left-3 top-1/2 -translate-y-1/2 text-neutral-400\"\n        >\n          <path\n            strokeLinecap=\"round\"\n            strokeLinejoin=\"round\"\n            d=\"M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z\"\n          />\n        </svg>\n        <input\n          type=\"text\"\n          placeholder=\"Search documents...\"\n          value={searchQuery}\n          onChange={(e) => setSearchQuery(e.target.value)}\n          className=\"w-full pl-10 pr-4 py-2 border border-neutral-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500\"\n        />\n      </div>\n\n      {/* Statistics */}\n      <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n        <div className=\"bg-white rounded-lg shadow p-4\">\n          <p className=\"text-sm text-neutral-600\">Total Documents</p>\n          <p className=\"text-2xl font-bold text-neutral-900\">\n            {documents.length}\n          </p>\n        </div>\n        <div className=\"bg-white rounded-lg shadow p-4\">\n          <p className=\"text-sm text-neutral-600\">Indexed Chunks</p>\n          <p className=\"text-2xl font-bold text-neutral-900\">\n            {documents\n              .reduce((sum, doc) => sum + (doc.chunks || 0), 0)\n              .toLocaleString()}\n          </p>\n        </div>\n        <div className=\"bg-white rounded-lg shadow p-4\">\n          <p className=\"text-sm text-neutral-600\">Total Storage</p>\n          <p className=\"text-2xl font-bold text-neutral-900\">\n            {formatFileSize(documents.reduce((sum, doc) => sum + doc.size, 0))}\n          </p>\n        </div>\n      </div>\n\n      {/* Documents List */}\n      <div className=\"bg-white rounded-lg shadow overflow-hidden\">\n        <div className=\"overflow-x-auto\">\n          <table className=\"w-full\">\n            <thead className=\"bg-neutral-50 border-b border-neutral-200\">\n              <tr>\n                <th className=\"px-6 py-3 text-left text-xs font-medium text-neutral-600 uppercase tracking-wider\">\n                  Document\n                </th>\n                <th className=\"px-6 py-3 text-left text-xs font-medium text-neutral-600 uppercase tracking-wider\">\n                  Status\n                </th>\n                <th className=\"px-6 py-3 text-left text-xs font-medium text-neutral-600 uppercase tracking-wider\">\n                  Size\n                </th>\n                <th className=\"px-6 py-3 text-left text-xs font-medium text-neutral-600 uppercase tracking-wider\">\n                  Chunks\n                </th>\n                <th className=\"px-6 py-3 text-left text-xs font-medium text-neutral-600 uppercase tracking-wider\">\n                  Uploaded\n                </th>\n                <th className=\"px-6 py-3 text-right text-xs font-medium text-neutral-600 uppercase tracking-wider\">\n                  Actions\n                </th>\n              </tr>\n            </thead>\n            <tbody className=\"divide-y divide-neutral-200\">\n              {filteredDocuments.length === 0 ? (\n                <tr>\n                  <td\n                    colSpan={6}\n                    className=\"px-6 py-12 text-center text-neutral-500\"\n                  >\n                    {searchQuery\n                      ? \"No documents found\"\n                      : \"No documents uploaded yet\"}\n                  </td>\n                </tr>\n              ) : (\n                filteredDocuments.map((doc) => (\n                  <tr key={doc.id} className=\"hover:bg-neutral-50\">\n                    <td className=\"px-6 py-4\">\n                      <div className=\"flex items-center\">\n                        <svg\n                          xmlns=\"http://www.w3.org/2000/svg\"\n                          fill=\"none\"\n                          viewBox=\"0 0 24 24\"\n                          strokeWidth={1.5}\n                          stroke=\"currentColor\"\n                          className=\"w-8 h-8 text-red-500 mr-3\"\n                        >\n                          <path\n                            strokeLinecap=\"round\"\n                            strokeLinejoin=\"round\"\n                            d=\"M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z\"\n                          />\n                        </svg>\n                        <div>\n                          <p className=\"text-sm font-medium text-neutral-900\">\n                            {doc.title}\n                          </p>\n                          <p className=\"text-xs text-neutral-500\">\n                            {doc.filename}\n                          </p>\n                        </div>\n                      </div>\n                    </td>\n                    <td className=\"px-6 py-4\">{getStatusBadge(doc.status)}</td>\n                    <td className=\"px-6 py-4 text-sm text-neutral-900\">\n                      {formatFileSize(doc.size)}\n                    </td>\n                    <td className=\"px-6 py-4 text-sm text-neutral-900\">\n                      {doc.chunks?.toLocaleString() || \"-\"}\n                    </td>\n                    <td className=\"px-6 py-4 text-sm text-neutral-600\">\n                      {new Date(doc.uploadedAt).toLocaleDateString()}\n                    </td>\n                    <td className=\"px-6 py-4 text-right space-x-2\">\n                      <button\n                        onClick={() => handlePreview(doc.id)}\n                        className=\"text-sm text-blue-600 hover:text-blue-700 font-medium\"\n                        disabled={isLoadingPreview}\n                      >\n                        Preview\n                      </button>\n                      <button\n                        onClick={() => handleReindex(doc.id)}\n                        className=\"text-sm text-primary-600 hover:text-primary-700 font-medium\"\n                      >\n                        Reindex\n                      </button>\n                      <button\n                        onClick={() => handleDelete(doc.id)}\n                        className=\"text-sm text-red-600 hover:text-red-700 font-medium\"\n                      >\n                        Delete\n                      </button>\n                    </td>\n                  </tr>\n                ))\n              )}\n            </tbody>\n          </table>\n        </div>\n      </div>\n\n      {/* Phase 8.3: Preview Modal */}\n      {preview && (\n        <div className=\"fixed inset-0 bg-black/50 flex items-center justify-center z-50\">\n          <div className=\"bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-hidden flex flex-col\">\n            {/* Header */}\n            <div className=\"px-6 py-4 border-b border-neutral-200 flex items-center justify-between\">\n              <h3 className=\"text-lg font-semibold text-neutral-900\">\n                Document Preview\n              </h3>\n              <button\n                onClick={closePreview}\n                className=\"text-neutral-400 hover:text-neutral-600\"\n              >\n                <svg\n                  xmlns=\"http://www.w3.org/2000/svg\"\n                  fill=\"none\"\n                  viewBox=\"0 0 24 24\"\n                  strokeWidth={1.5}\n                  stroke=\"currentColor\"\n                  className=\"w-6 h-6\"\n                >\n                  <path\n                    strokeLinecap=\"round\"\n                    strokeLinejoin=\"round\"\n                    d=\"M6 18L18 6M6 6l12 12\"\n                  />\n                </svg>\n              </button>\n            </div>\n\n            {/* Content */}\n            <div className=\"flex-1 overflow-y-auto p-6 space-y-6\">\n              {/* Document Info */}\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div>\n                  <label className=\"text-xs font-medium text-neutral-500 uppercase tracking-wide\">\n                    Title\n                  </label>\n                  <p className=\"text-sm text-neutral-900 mt-1\">\n                    {preview.detail.title}\n                  </p>\n                </div>\n                <div>\n                  <label className=\"text-xs font-medium text-neutral-500 uppercase tracking-wide\">\n                    Filename\n                  </label>\n                  <p className=\"text-sm text-neutral-900 mt-1\">\n                    {preview.detail.filename}\n                  </p>\n                </div>\n                <div>\n                  <label className=\"text-xs font-medium text-neutral-500 uppercase tracking-wide\">\n                    File Type\n                  </label>\n                  <p className=\"text-sm text-neutral-900 mt-1\">\n                    {preview.detail.file_type}\n                  </p>\n                </div>\n                <div>\n                  <label className=\"text-xs font-medium text-neutral-500 uppercase tracking-wide\">\n                    Source Type\n                  </label>\n                  <p className=\"text-sm text-neutral-900 mt-1\">\n                    {preview.detail.source_type}\n                  </p>\n                </div>\n              </div>\n\n              {/* Indexing Status */}\n              <div className=\"bg-neutral-50 rounded-lg p-4\">\n                <h4 className=\"text-sm font-medium text-neutral-700 mb-3\">\n                  Indexing Information\n                </h4>\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <div>\n                    <p className=\"text-xs text-neutral-500\">Status</p>\n                    <p\n                      className={`text-sm font-medium ${\n                        preview.detail.indexing_status === \"indexed\"\n                          ? \"text-green-600\"\n                          : preview.detail.indexing_status === \"processing\"\n                            ? \"text-yellow-600\"\n                            : \"text-red-600\"\n                      }`}\n                    >\n                      {preview.detail.indexing_status}\n                    </p>\n                  </div>\n                  <div>\n                    <p className=\"text-xs text-neutral-500\">Chunks Indexed</p>\n                    <p className=\"text-sm font-medium text-neutral-900\">\n                      {preview.detail.chunks_indexed?.toLocaleString() || 0}\n                    </p>\n                  </div>\n                  <div>\n                    <p className=\"text-xs text-neutral-500\">Total Tokens</p>\n                    <p className=\"text-sm font-medium text-neutral-900\">\n                      {preview.detail.total_tokens?.toLocaleString() || \"N/A\"}\n                    </p>\n                  </div>\n                  <div>\n                    <p className=\"text-xs text-neutral-500\">Document ID</p>\n                    <p className=\"text-sm font-mono text-neutral-600\">\n                      {preview.detail.document_id.substring(0, 16)}...\n                    </p>\n                  </div>\n                </div>\n\n                {preview.detail.indexing_error && (\n                  <div className=\"mt-4 p-3 bg-red-50 rounded border border-red-200\">\n                    <p className=\"text-xs font-medium text-red-700 mb-1\">\n                      Indexing Error\n                    </p>\n                    <p className=\"text-sm text-red-600\">\n                      {preview.detail.indexing_error}\n                    </p>\n                  </div>\n                )}\n              </div>\n\n              {/* Metadata */}\n              {preview.detail.metadata &&\n                Object.keys(preview.detail.metadata).length > 0 && (\n                  <div>\n                    <h4 className=\"text-sm font-medium text-neutral-700 mb-2\">\n                      Metadata\n                    </h4>\n                    <div className=\"bg-neutral-50 rounded-lg p-4 overflow-x-auto\">\n                      <pre className=\"text-xs text-neutral-700 whitespace-pre-wrap\">\n                        {JSON.stringify(preview.detail.metadata, null, 2)}\n                      </pre>\n                    </div>\n                  </div>\n                )}\n\n              {/* Timestamps */}\n              <div className=\"grid grid-cols-2 gap-4 pt-4 border-t border-neutral-200\">\n                <div>\n                  <label className=\"text-xs font-medium text-neutral-500 uppercase tracking-wide\">\n                    Created\n                  </label>\n                  <p className=\"text-sm text-neutral-900 mt-1\">\n                    {new Date(preview.detail.created_at).toLocaleString()}\n                  </p>\n                </div>\n                <div>\n                  <label className=\"text-xs font-medium text-neutral-500 uppercase tracking-wide\">\n                    Updated\n                  </label>\n                  <p className=\"text-sm text-neutral-900 mt-1\">\n                    {new Date(preview.detail.updated_at).toLocaleString()}\n                  </p>\n                </div>\n              </div>\n            </div>\n\n            {/* Footer */}\n            <div className=\"px-6 py-4 border-t border-neutral-200 flex justify-end space-x-3\">\n              <button\n                onClick={closePreview}\n                className=\"px-4 py-2 text-sm font-medium text-neutral-700 hover:bg-neutral-100 rounded-lg transition-colors\"\n              >\n                Close\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Loading Preview Overlay */}\n      {isLoadingPreview && (\n        <div className=\"fixed inset-0 bg-black/25 flex items-center justify-center z-50\">\n          <div className=\"bg-white rounded-lg shadow-lg p-6\">\n            <div className=\"flex items-center space-x-3\">\n              <div className=\"w-6 h-6 border-2 border-primary-500 border-t-transparent rounded-full animate-spin\" />\n              <span className=\"text-sm text-neutral-700\">\n                Loading preview...\n              </span>\n            </div>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n"
}

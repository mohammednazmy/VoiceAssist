{
  "path": "apps/web-app/src/components/chat/MessageBubble.tsx",
  "language": "typescript",
  "size": 35994,
  "last_modified": "2025-12-03T23:50:35.642Z",
  "lines": 952,
  "content": "/**\n * MessageBubble Component\n * Renders a chat message with markdown support, code blocks, and citations\n */\n\nimport { memo, useState, useEffect, useCallback } from \"react\";\nimport ReactMarkdown from \"react-markdown\";\nimport remarkGfm from \"remark-gfm\";\nimport remarkMath from \"remark-math\";\nimport rehypeKatex from \"rehype-katex\";\nimport { Highlight, themes } from \"prism-react-renderer\";\nimport type { Message, Attachment } from \"@voiceassist/types\";\nimport { CitationDisplay } from \"./CitationDisplay\";\nimport { MessageActionMenu } from \"./MessageActionMenu\";\nimport { DeleteConfirmationDialog } from \"./DeleteConfirmationDialog\";\nimport {\n  RegenerationOptionsDialog,\n  type RegenerationOptions,\n} from \"./RegenerationOptionsDialog\";\nimport { AudioPlayer } from \"../voice/AudioPlayer\";\nimport { useAuth } from \"../../hooks/useAuth\";\nimport { useToastContext } from \"../../contexts/ToastContext\";\nimport { createAttachmentsApi } from \"../../lib/api/attachmentsApi\";\nimport { useAuthStore } from \"../../stores/authStore\";\nimport \"katex/dist/katex.min.css\";\n\nexport interface MessageBubbleProps {\n  message: Message;\n  isStreaming?: boolean;\n  onEditSave?: (messageId: string, newContent: string) => Promise<void>;\n  onRegenerate?: (\n    messageId: string,\n    options?: RegenerationOptions,\n  ) => Promise<void>;\n  onDelete?: (messageId: string) => Promise<void>;\n  onBranch?: (messageId: string) => Promise<void>;\n  /** Whether this message has branches created from it */\n  hasBranch?: boolean;\n  /** Source of the message (text input, voice input, or system) */\n  source?: \"text\" | \"voice\" | \"system\";\n  /** Whether audio controls should be shown in compact mode */\n  compactAudio?: boolean;\n  /** Callback when audio playback is requested */\n  onPlayAudio?: (messageId: string) => void;\n}\n\n// Memoize to prevent unnecessary re-renders when other messages update\nexport const MessageBubble = memo(function MessageBubble({\n  message,\n  isStreaming,\n  onEditSave,\n  onRegenerate,\n  onDelete,\n  onBranch,\n  hasBranch,\n  source,\n  compactAudio: _compactAudio,\n  onPlayAudio: _onPlayAudio,\n}: MessageBubbleProps) {\n  const isUser = message.role === \"user\";\n  const isSystem = message.role === \"system\";\n  const { apiClient } = useAuth();\n  const { tokens } = useAuthStore();\n  const toast = useToastContext();\n\n  // Editing state\n  const [isEditing, setIsEditing] = useState(false);\n  const [editedContent, setEditedContent] = useState(message.content);\n  const [isSaving, setIsSaving] = useState(false);\n  const [editError, setEditError] = useState<string | null>(null);\n\n  // Audio state\n  const [audioBlob, setAudioBlob] = useState<Blob | null>(null);\n  const [isSynthesizing, setIsSynthesizing] = useState(false);\n  const [synthesisError, setSynthesisError] = useState<string | null>(null);\n\n  // Attachment state\n  const [attachments, setAttachments] = useState<Attachment[]>([]);\n  const [isLoadingAttachments, setIsLoadingAttachments] = useState(false);\n  const [downloadingAttachments, setDownloadingAttachments] = useState<\n    Set<string>\n  >(new Set());\n\n  // Delete confirmation state\n  const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);\n  const [isDeleting, setIsDeleting] = useState(false);\n\n  // Regeneration dialog state\n  const [showRegenerationDialog, setShowRegenerationDialog] = useState(false);\n\n  // Action loading states\n  const [isRegenerating, setIsRegenerating] = useState(false);\n  const [isBranching, setIsBranching] = useState(false);\n\n  // Save handler\n  const handleSave = async () => {\n    if (editedContent === message.content) {\n      setIsEditing(false);\n      return;\n    }\n\n    setIsSaving(true);\n    setEditError(null);\n    try {\n      await onEditSave?.(message.id, editedContent);\n      setIsEditing(false);\n    } catch (error) {\n      console.error(\"Failed to save edit:\", error);\n      setEditError(\n        error instanceof Error ? error.message : \"Failed to save changes\",\n      );\n    } finally {\n      setIsSaving(false);\n    }\n  };\n\n  // Cancel handler\n  const handleCancel = () => {\n    setEditedContent(message.content);\n    setEditError(null);\n    setIsEditing(false);\n  };\n\n  // Copy handler\n  const handleCopy = useCallback(async () => {\n    try {\n      await navigator.clipboard.writeText(message.content);\n      toast.success(\n        \"Copied to clipboard\",\n        \"Message content copied successfully.\",\n      );\n    } catch (err) {\n      console.error(\"Failed to copy:\", err);\n      toast.error(\"Copy failed\", \"Unable to copy to clipboard.\");\n    }\n  }, [message.content, toast]);\n\n  // Delete handler - opens confirmation dialog\n  const handleDeleteClick = useCallback(() => {\n    setShowDeleteConfirm(true);\n  }, []);\n\n  // Confirm delete handler\n  const handleDeleteConfirm = useCallback(async () => {\n    setIsDeleting(true);\n    try {\n      await onDelete?.(message.id);\n      setShowDeleteConfirm(false);\n      toast.success(\"Message deleted\", \"The message has been removed.\");\n    } catch (error) {\n      console.error(\"Failed to delete message:\", error);\n      toast.error(\n        \"Delete failed\",\n        error instanceof Error ? error.message : \"Unable to delete message.\",\n      );\n    } finally {\n      setIsDeleting(false);\n    }\n  }, [message.id, onDelete, toast]);\n\n  // Cancel delete handler\n  const handleDeleteCancel = useCallback(() => {\n    if (!isDeleting) {\n      setShowDeleteConfirm(false);\n    }\n  }, [isDeleting]);\n\n  // Regenerate click handler - opens the options dialog\n  const handleRegenerateClick = useCallback(() => {\n    setShowRegenerationDialog(true);\n  }, []);\n\n  // Regenerate confirm handler - called when user confirms options\n  const handleRegenerateConfirm = useCallback(\n    async (options: RegenerationOptions) => {\n      setShowRegenerationDialog(false);\n      setIsRegenerating(true);\n      try {\n        await onRegenerate?.(message.id, options);\n      } catch (error) {\n        console.error(\"Failed to regenerate message:\", error);\n        toast.error(\n          \"Regeneration failed\",\n          error instanceof Error\n            ? error.message\n            : \"Unable to regenerate message.\",\n        );\n      } finally {\n        setIsRegenerating(false);\n      }\n    },\n    [message.id, onRegenerate, toast],\n  );\n\n  // Regenerate cancel handler\n  const handleRegenerateCancel = useCallback(() => {\n    if (!isRegenerating) {\n      setShowRegenerationDialog(false);\n    }\n  }, [isRegenerating]);\n\n  // Branch handler\n  const handleBranch = useCallback(async () => {\n    setIsBranching(true);\n    try {\n      await onBranch?.(message.id);\n      toast.success(\n        \"Branch created\",\n        \"A new conversation branch has been created.\",\n      );\n    } catch (error) {\n      console.error(\"Failed to branch conversation:\", error);\n      toast.error(\n        \"Branch failed\",\n        error instanceof Error ? error.message : \"Unable to create branch.\",\n      );\n    } finally {\n      setIsBranching(false);\n    }\n  }, [message.id, onBranch, toast]);\n\n  // Audio synthesis handler\n  const handlePlayAudio = async () => {\n    if (audioBlob) {\n      // If audio already exists, just play it (AudioPlayer will handle this)\n      return;\n    }\n\n    setIsSynthesizing(true);\n    setSynthesisError(null);\n    try {\n      const blob = await apiClient.synthesizeSpeech(message.content);\n      setAudioBlob(blob);\n    } catch (error) {\n      console.error(\"Speech synthesis failed:\", error);\n      setSynthesisError(\"Failed to generate audio. Please try again.\");\n    } finally {\n      setIsSynthesizing(false);\n    }\n  };\n\n  // Fetch attachments when message has attachment IDs\n  useEffect(() => {\n    if (!message.attachments || message.attachments.length === 0) {\n      return;\n    }\n\n    const fetchAttachments = async () => {\n      setIsLoadingAttachments(true);\n      try {\n        const attachmentsApi = createAttachmentsApi(\n          import.meta.env.VITE_API_URL || \"http://localhost:8000\",\n          () => tokens?.accessToken || null,\n        );\n        const fetchedAttachments = await attachmentsApi.listMessageAttachments(\n          message.id,\n        );\n        setAttachments(fetchedAttachments);\n      } catch (error) {\n        console.error(\"Failed to fetch attachments:\", error);\n      } finally {\n        setIsLoadingAttachments(false);\n      }\n    };\n\n    fetchAttachments();\n  }, [message.id, message.attachments, tokens?.accessToken]);\n\n  // Attachment download handler\n  const handleDownloadAttachment = async (attachment: Attachment) => {\n    setDownloadingAttachments((prev) => new Set(prev).add(attachment.id));\n    try {\n      const attachmentsApi = createAttachmentsApi(\n        import.meta.env.VITE_API_URL || \"http://localhost:8000\",\n        () => tokens?.accessToken || null,\n      );\n      const blob = await attachmentsApi.downloadAttachment(attachment.id);\n\n      // Create download link\n      const url = URL.createObjectURL(blob);\n      const link = document.createElement(\"a\");\n      link.href = url;\n      link.download = attachment.fileName;\n      document.body.appendChild(link);\n      link.click();\n      document.body.removeChild(link);\n      URL.revokeObjectURL(url);\n    } catch (error) {\n      console.error(\"Failed to download attachment:\", error);\n      // Could show a toast/notification here\n    } finally {\n      setDownloadingAttachments((prev) => {\n        const next = new Set(prev);\n        next.delete(attachment.id);\n        return next;\n      });\n    }\n  };\n\n  // Get file icon based on file type\n  const getFileIcon = (fileType: string) => {\n    switch (fileType) {\n      case \"pdf\":\n        return (\n          <svg\n            xmlns=\"http://www.w3.org/2000/svg\"\n            fill=\"none\"\n            viewBox=\"0 0 24 24\"\n            strokeWidth={1.5}\n            stroke=\"currentColor\"\n            className=\"w-5 h-5 text-red-600\"\n          >\n            <path\n              strokeLinecap=\"round\"\n              strokeLinejoin=\"round\"\n              d=\"M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z\"\n            />\n          </svg>\n        );\n      case \"image\":\n        return (\n          <svg\n            xmlns=\"http://www.w3.org/2000/svg\"\n            fill=\"none\"\n            viewBox=\"0 0 24 24\"\n            strokeWidth={1.5}\n            stroke=\"currentColor\"\n            className=\"w-5 h-5 text-blue-600\"\n          >\n            <path\n              strokeLinecap=\"round\"\n              strokeLinejoin=\"round\"\n              d=\"M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z\"\n            />\n          </svg>\n        );\n      case \"document\":\n      case \"text\":\n      case \"markdown\":\n        return (\n          <svg\n            xmlns=\"http://www.w3.org/2000/svg\"\n            fill=\"none\"\n            viewBox=\"0 0 24 24\"\n            strokeWidth={1.5}\n            stroke=\"currentColor\"\n            className=\"w-5 h-5 text-neutral-600\"\n          >\n            <path\n              strokeLinecap=\"round\"\n              strokeLinejoin=\"round\"\n              d=\"M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z\"\n            />\n          </svg>\n        );\n      default:\n        return (\n          <svg\n            xmlns=\"http://www.w3.org/2000/svg\"\n            fill=\"none\"\n            viewBox=\"0 0 24 24\"\n            strokeWidth={1.5}\n            stroke=\"currentColor\"\n            className=\"w-5 h-5 text-neutral-600\"\n          >\n            <path\n              strokeLinecap=\"round\"\n              strokeLinejoin=\"round\"\n              d=\"M18.375 12.739l-7.693 7.693a4.5 4.5 0 01-6.364-6.364l10.94-10.94A3 3 0 1119.5 7.372L8.552 18.32m.009-.01l-.01.01m5.699-9.941l-7.81 7.81a1.5 1.5 0 002.112 2.13\"\n            />\n          </svg>\n        );\n    }\n  };\n\n  // Format file size\n  const formatFileSize = (bytes: number): string => {\n    if (bytes === 0) return \"0 Bytes\";\n    const k = 1024;\n    const sizes = [\"Bytes\", \"KB\", \"MB\"];\n    const i = Math.floor(Math.log(bytes) / Math.log(k));\n    return Math.round((bytes / Math.pow(k, i)) * 100) / 100 + \" \" + sizes[i];\n  };\n\n  return (\n    <div\n      className={`flex ${isUser ? \"justify-end\" : \"justify-start\"} mb-4 group`}\n      data-message-id={message.id}\n      role=\"article\"\n      aria-label={`${message.role === \"user\" ? \"Your\" : message.role === \"assistant\" ? \"Assistant\" : \"System\"} message`}\n    >\n      <div\n        className={`relative max-w-[80%] rounded-lg px-4 py-3 ${\n          isUser\n            ? \"bg-primary-500 text-white\"\n            : isSystem\n              ? \"bg-neutral-100 text-neutral-700 border border-neutral-300\"\n              : \"bg-white text-neutral-900 border border-neutral-200 shadow-sm\"\n        }`}\n      >\n        {/* Action Menu */}\n        <div className=\"absolute top-2 right-2\">\n          <MessageActionMenu\n            messageId={message.id}\n            role={message.role as \"user\" | \"assistant\" | \"system\"}\n            onEdit={isUser ? () => setIsEditing(true) : undefined}\n            onRegenerate={\n              !isUser && !isSystem ? handleRegenerateClick : undefined\n            }\n            onDelete={onDelete ? handleDeleteClick : undefined}\n            onCopy={handleCopy}\n            onBranch={!isSystem && onBranch ? handleBranch : undefined}\n            isDeleting={isDeleting}\n            isRegenerating={isRegenerating}\n            isBranching={isBranching}\n          />\n        </div>\n\n        {/* Delete Confirmation Dialog */}\n        <DeleteConfirmationDialog\n          isOpen={showDeleteConfirm}\n          messageContent={message.content}\n          messageRole={message.role as \"user\" | \"assistant\"}\n          onConfirm={handleDeleteConfirm}\n          onCancel={handleDeleteCancel}\n          isDeleting={isDeleting}\n        />\n\n        {/* Regeneration Options Dialog */}\n        <RegenerationOptionsDialog\n          isOpen={showRegenerationDialog}\n          onClose={handleRegenerateCancel}\n          onRegenerate={handleRegenerateConfirm}\n          originalContent={message.content}\n          isRegenerating={isRegenerating}\n          hasClinicalContext={false}\n        />\n\n        {/* Message Content - Editing Mode or Display Mode */}\n        {isEditing ? (\n          <div className=\"space-y-2\">\n            <textarea\n              value={editedContent}\n              onChange={(e) => setEditedContent(e.target.value)}\n              className=\"w-full min-h-[100px] p-2 border border-neutral-300 rounded bg-white text-neutral-900 focus:outline-none focus:ring-2 focus:ring-primary-500\"\n              autoFocus\n              onKeyDown={(e) => {\n                if (e.key === \"Enter\" && (e.ctrlKey || e.metaKey)) {\n                  e.preventDefault();\n                  handleSave();\n                } else if (e.key === \"Escape\") {\n                  e.preventDefault();\n                  handleCancel();\n                }\n              }}\n              aria-label=\"Edit message\"\n              aria-invalid={editError ? \"true\" : \"false\"}\n              aria-describedby={editError ? \"edit-error\" : undefined}\n            />\n            {editError && (\n              <div\n                id=\"edit-error\"\n                role=\"alert\"\n                className=\"text-sm text-red-600 bg-red-50 px-3 py-2 rounded border border-red-200\"\n              >\n                {editError}\n              </div>\n            )}\n            <div className=\"flex justify-end space-x-2\">\n              <button\n                onClick={handleCancel}\n                disabled={isSaving}\n                className=\"px-3 py-1.5 text-sm border border-neutral-300 rounded hover:bg-neutral-50 disabled:opacity-50 disabled:cursor-not-allowed text-neutral-700\"\n                aria-label=\"Cancel editing\"\n              >\n                Cancel\n              </button>\n              <button\n                onClick={handleSave}\n                disabled={isSaving || editedContent.trim() === \"\"}\n                className=\"px-3 py-1.5 text-sm bg-primary-500 text-white rounded hover:bg-primary-600 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2\"\n                aria-label={isSaving ? \"Saving changes\" : \"Save changes\"}\n              >\n                {isSaving && (\n                  <svg\n                    className=\"animate-spin h-4 w-4\"\n                    xmlns=\"http://www.w3.org/2000/svg\"\n                    fill=\"none\"\n                    viewBox=\"0 0 24 24\"\n                    aria-hidden=\"true\"\n                  >\n                    <circle\n                      className=\"opacity-25\"\n                      cx=\"12\"\n                      cy=\"12\"\n                      r=\"10\"\n                      stroke=\"currentColor\"\n                      strokeWidth=\"4\"\n                    ></circle>\n                    <path\n                      className=\"opacity-75\"\n                      fill=\"currentColor\"\n                      d=\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z\"\n                    ></path>\n                  </svg>\n                )}\n                {isSaving ? \"Saving...\" : \"Save\"}\n              </button>\n            </div>\n          </div>\n        ) : (\n          <div className=\"prose prose-sm max-w-none\">\n            <ReactMarkdown\n              remarkPlugins={[remarkGfm, remarkMath]}\n              rehypePlugins={[rehypeKatex]}\n              components={{\n                // Code blocks with syntax highlighting\n                // In react-markdown v10+, we detect code blocks by checking if className exists\n                // (fenced code blocks have language-xxx class) or if content has newlines\n                code({ className, children, ...props }) {\n                  const match = /language-(\\w+)/.exec(className || \"\");\n                  const language = match ? match[1] : \"\";\n                  const codeString = String(children).replace(/\\n$/, \"\");\n\n                  // Detect if this is a code block (fenced with ```) vs inline code\n                  // Code blocks have a language class OR contain newlines OR are inside pre\n                  const isCodeBlock =\n                    match ||\n                    codeString.includes(\"\\n\") ||\n                    (props.node?.tagName === \"code\" &&\n                      props.node?.position?.start?.line !==\n                        props.node?.position?.end?.line);\n\n                  if (!isCodeBlock) {\n                    // Inline code\n                    return (\n                      <code\n                        className={`px-1.5 py-0.5 rounded text-sm font-mono ${\n                          isUser\n                            ? \"bg-primary-600 text-white\"\n                            : \"bg-neutral-100 text-neutral-800\"\n                        }`}\n                        {...props}\n                      >\n                        {children}\n                      </code>\n                    );\n                  }\n\n                  // Code block with syntax highlighting\n                  return (\n                    <div className=\"my-2 rounded-md overflow-hidden\">\n                      <Highlight\n                        theme={themes.vsDark}\n                        code={codeString}\n                        language={(language || \"text\") as any}\n                      >\n                        {({\n                          className: highlightClassName,\n                          style,\n                          tokens,\n                          getLineProps,\n                          getTokenProps,\n                        }) => (\n                          <pre\n                            className={highlightClassName}\n                            style={{\n                              ...style,\n                              margin: 0,\n                              borderRadius: \"0.375rem\",\n                              fontSize: \"0.875rem\",\n                              padding: \"1rem\",\n                            }}\n                          >\n                            <code>\n                              {tokens.map((line, i) => (\n                                <div key={i} {...getLineProps({ line })}>\n                                  {line.map((token, key) => (\n                                    <span\n                                      key={key}\n                                      {...getTokenProps({ token })}\n                                    />\n                                  ))}\n                                </div>\n                              ))}\n                            </code>\n                          </pre>\n                        )}\n                      </Highlight>\n                    </div>\n                  );\n                },\n\n                // Links\n                a({ children, href, ...props }) {\n                  return (\n                    <a\n                      href={href}\n                      target=\"_blank\"\n                      rel=\"noopener noreferrer\"\n                      className={`underline ${\n                        isUser\n                          ? \"text-primary-100 hover:text-white\"\n                          : \"text-primary-600 hover:text-primary-700\"\n                      }`}\n                      {...props}\n                    >\n                      {children}\n                    </a>\n                  );\n                },\n\n                // Blockquotes\n                blockquote({ children, ...props }) {\n                  return (\n                    <blockquote\n                      className={`border-l-4 pl-4 my-2 ${\n                        isUser\n                          ? \"border-primary-300 text-primary-100\"\n                          : \"border-neutral-300 text-neutral-600\"\n                      }`}\n                      {...props}\n                    >\n                      {children}\n                    </blockquote>\n                  );\n                },\n\n                // Tables\n                table({ children, ...props }) {\n                  return (\n                    <div className=\"overflow-x-auto my-2\">\n                      <table\n                        className=\"min-w-full divide-y divide-neutral-200 border border-neutral-200 rounded\"\n                        {...props}\n                      >\n                        {children}\n                      </table>\n                    </div>\n                  );\n                },\n\n                // Paragraphs\n                p({ children, ...props }) {\n                  return (\n                    <p\n                      className={`mb-2 ${isUser ? \"text-white\" : \"text-neutral-900\"}`}\n                      {...props}\n                    >\n                      {children}\n                    </p>\n                  );\n                },\n\n                // Lists\n                ul({ children, ...props }) {\n                  return (\n                    <ul\n                      className={`list-disc list-inside mb-2 ${\n                        isUser ? \"text-white\" : \"text-neutral-900\"\n                      }`}\n                      {...props}\n                    >\n                      {children}\n                    </ul>\n                  );\n                },\n                ol({ children, ...props }) {\n                  return (\n                    <ol\n                      className={`list-decimal list-inside mb-2 ${\n                        isUser ? \"text-white\" : \"text-neutral-900\"\n                      }`}\n                      {...props}\n                    >\n                      {children}\n                    </ol>\n                  );\n                },\n              }}\n            >\n              {message.content}\n            </ReactMarkdown>\n\n            {/* Streaming Indicator */}\n            {isStreaming && (\n              <div\n                className=\"mt-2 flex items-center space-x-1\"\n                role=\"status\"\n                aria-live=\"polite\"\n                aria-label=\"Message is being generated\"\n              >\n                <div className=\"w-2 h-2 bg-neutral-400 rounded-full animate-bounce\" />\n                <div\n                  className=\"w-2 h-2 bg-neutral-400 rounded-full animate-bounce\"\n                  style={{ animationDelay: \"0.1s\" }}\n                />\n                <div\n                  className=\"w-2 h-2 bg-neutral-400 rounded-full animate-bounce\"\n                  style={{ animationDelay: \"0.2s\" }}\n                />\n              </div>\n            )}\n\n            {/* Citations */}\n            {message.citations && message.citations.length > 0 && (\n              <div className=\"mt-3 pt-3 border-t border-neutral-200\">\n                <CitationDisplay citations={message.citations} />\n              </div>\n            )}\n\n            {/* Attachments */}\n            {message.attachments && message.attachments.length > 0 && (\n              <div className=\"mt-3 pt-3 border-t border-neutral-200\">\n                <div className=\"text-xs font-semibold text-neutral-700 mb-2\">\n                  Attachments ({attachments.length})\n                </div>\n                {isLoadingAttachments && (\n                  <div className=\"flex items-center space-x-2 text-sm text-neutral-600\">\n                    <div className=\"w-4 h-4 rounded-full border-2 border-primary-500 border-t-transparent animate-spin\" />\n                    <span>Loading attachments...</span>\n                  </div>\n                )}\n                {!isLoadingAttachments && attachments.length > 0 && (\n                  <div className=\"space-y-2\">\n                    {attachments.map((attachment) => (\n                      <button\n                        key={attachment.id}\n                        type=\"button\"\n                        onClick={() => handleDownloadAttachment(attachment)}\n                        disabled={downloadingAttachments.has(attachment.id)}\n                        className=\"flex items-center space-x-3 w-full p-2 rounded bg-neutral-50 hover:bg-neutral-100 transition-colors disabled:opacity-50 disabled:cursor-not-allowed text-left border border-neutral-200\"\n                        aria-label={`Download ${attachment.fileName}`}\n                      >\n                        {/* File Icon */}\n                        <div className=\"flex-shrink-0\">\n                          {getFileIcon(attachment.fileType)}\n                        </div>\n\n                        {/* File Info */}\n                        <div className=\"flex-1 min-w-0\">\n                          <div className=\"text-sm font-medium text-neutral-900 truncate\">\n                            {attachment.fileName}\n                          </div>\n                          <div className=\"text-xs text-neutral-500\">\n                            {formatFileSize(attachment.fileSize)}\n                          </div>\n                        </div>\n\n                        {/* Download Icon */}\n                        <div className=\"flex-shrink-0\">\n                          {downloadingAttachments.has(attachment.id) ? (\n                            <div className=\"w-5 h-5 rounded-full border-2 border-primary-500 border-t-transparent animate-spin\" />\n                          ) : (\n                            <svg\n                              xmlns=\"http://www.w3.org/2000/svg\"\n                              fill=\"none\"\n                              viewBox=\"0 0 24 24\"\n                              strokeWidth={1.5}\n                              stroke=\"currentColor\"\n                              className=\"w-5 h-5 text-primary-600\"\n                            >\n                              <path\n                                strokeLinecap=\"round\"\n                                strokeLinejoin=\"round\"\n                                d=\"M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3\"\n                              />\n                            </svg>\n                          )}\n                        </div>\n                      </button>\n                    ))}\n                  </div>\n                )}\n                {!isLoadingAttachments &&\n                  attachments.length === 0 &&\n                  message.attachments.length > 0 && (\n                    <div className=\"text-sm text-neutral-500\">\n                      Failed to load attachments\n                    </div>\n                  )}\n              </div>\n            )}\n\n            {/* Audio Playback (Assistant messages only) */}\n            {!isUser && !isSystem && !isStreaming && (\n              <div className=\"mt-3 space-y-2\">\n                {/* Audio Player */}\n                {audioBlob && (\n                  <AudioPlayer\n                    audioBlob={audioBlob}\n                    autoPlay={false}\n                    onPlaybackEnd={() => {\n                      // Optional: track playback completion\n                    }}\n                  />\n                )}\n\n                {/* Play Audio Button */}\n                {!audioBlob && !isSynthesizing && (\n                  <button\n                    type=\"button\"\n                    onClick={handlePlayAudio}\n                    className=\"flex items-center space-x-2 text-sm text-primary-600 hover:text-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-500 rounded px-2 py-1 hover:bg-primary-50 transition-colors\"\n                    aria-label=\"Play audio\"\n                  >\n                    <svg\n                      xmlns=\"http://www.w3.org/2000/svg\"\n                      fill=\"none\"\n                      viewBox=\"0 0 24 24\"\n                      strokeWidth={1.5}\n                      stroke=\"currentColor\"\n                      className=\"w-4 h-4\"\n                    >\n                      <path\n                        strokeLinecap=\"round\"\n                        strokeLinejoin=\"round\"\n                        d=\"M19.114 5.636a9 9 0 010 12.728M16.463 8.288a5.25 5.25 0 010 7.424M6.75 8.25l4.72-4.72a.75.75 0 011.28.53v15.88a.75.75 0 01-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.01 9.01 0 012.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75z\"\n                      />\n                    </svg>\n                    <span>Play Audio</span>\n                  </button>\n                )}\n\n                {/* Synthesizing Indicator */}\n                {isSynthesizing && (\n                  <div className=\"flex items-center space-x-2 text-sm text-neutral-600\">\n                    <div className=\"w-4 h-4 rounded-full border-2 border-primary-500 border-t-transparent animate-spin\" />\n                    <span>Generating audio...</span>\n                  </div>\n                )}\n\n                {/* Synthesis Error */}\n                {synthesisError && (\n                  <div className=\"flex items-start space-x-2 text-sm text-red-600 bg-red-50 p-2 rounded border border-red-200\">\n                    <svg\n                      xmlns=\"http://www.w3.org/2000/svg\"\n                      fill=\"none\"\n                      viewBox=\"0 0 24 24\"\n                      strokeWidth={1.5}\n                      stroke=\"currentColor\"\n                      className=\"w-4 h-4 flex-shrink-0 mt-0.5\"\n                    >\n                      <path\n                        strokeLinecap=\"round\"\n                        strokeLinejoin=\"round\"\n                        d=\"M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z\"\n                      />\n                    </svg>\n                    <div className=\"flex-1\">\n                      <p>{synthesisError}</p>\n                    </div>\n                    <button\n                      type=\"button\"\n                      onClick={() => setSynthesisError(null)}\n                      className=\"text-red-600 hover:text-red-700 focus:outline-none\"\n                      aria-label=\"Dismiss error\"\n                    >\n                      <svg\n                        xmlns=\"http://www.w3.org/2000/svg\"\n                        fill=\"none\"\n                        viewBox=\"0 0 24 24\"\n                        strokeWidth={2}\n                        stroke=\"currentColor\"\n                        className=\"w-4 h-4\"\n                      >\n                        <path\n                          strokeLinecap=\"round\"\n                          strokeLinejoin=\"round\"\n                          d=\"M6 18L18 6M6 6l12 12\"\n                        />\n                      </svg>\n                    </button>\n                  </div>\n                )}\n              </div>\n            )}\n\n            {/* Timestamp, Source Indicator, and Branch Indicator */}\n            <div\n              className={`flex items-center gap-2 text-xs mt-2 ${\n                isUser ? \"text-primary-100\" : \"text-neutral-500\"\n              }`}\n            >\n              {/* Voice Source Indicator */}\n              {source === \"voice\" && (\n                <span\n                  className={`inline-flex items-center gap-0.5 ${\n                    isUser ? \"text-primary-100\" : \"text-neutral-500\"\n                  }`}\n                  aria-label=\"Voice message\"\n                  title=\"Sent via voice\"\n                >\n                  <svg\n                    xmlns=\"http://www.w3.org/2000/svg\"\n                    fill=\"none\"\n                    viewBox=\"0 0 24 24\"\n                    strokeWidth={1.5}\n                    stroke=\"currentColor\"\n                    className=\"w-3.5 h-3.5\"\n                    aria-hidden=\"true\"\n                  >\n                    <path\n                      strokeLinecap=\"round\"\n                      strokeLinejoin=\"round\"\n                      d=\"M12 18.75a6 6 0 006-6v-1.5m-6 7.5a6 6 0 01-6-6v-1.5m6 7.5v3.75m-3.75 0h7.5M12 15.75a3 3 0 01-3-3V4.5a3 3 0 116 0v8.25a3 3 0 01-3 3z\"\n                    />\n                  </svg>\n                </span>\n              )}\n              <span>\n                {new Date(message.timestamp).toLocaleTimeString(\"en-US\", {\n                  hour: \"2-digit\",\n                  minute: \"2-digit\",\n                })}\n              </span>\n              {hasBranch && (\n                <span\n                  className={`inline-flex items-center gap-1 px-1.5 py-0.5 rounded text-xs font-medium ${\n                    isUser\n                      ? \"bg-primary-400/30 text-primary-100\"\n                      : \"bg-amber-100 text-amber-700\"\n                  }`}\n                  aria-label=\"This message has branches\"\n                  data-testid=\"branch-indicator\"\n                >\n                  <svg\n                    xmlns=\"http://www.w3.org/2000/svg\"\n                    fill=\"none\"\n                    viewBox=\"0 0 24 24\"\n                    strokeWidth={1.5}\n                    stroke=\"currentColor\"\n                    className=\"w-3 h-3\"\n                    aria-hidden=\"true\"\n                  >\n                    <path\n                      strokeLinecap=\"round\"\n                      strokeLinejoin=\"round\"\n                      d=\"M9 6.75V15m6-6v8.25m.503 3.498l4.875-2.437c.381-.19.622-.58.622-1.006V4.82c0-.836-.88-1.38-1.628-1.006l-3.869 1.934c-.317.159-.69.159-1.006 0L9.503 3.252a1.125 1.125 0 00-1.006 0L3.622 5.689C3.24 5.88 3 6.27 3 6.695V19.18c0 .836.88 1.38 1.628 1.006l3.869-1.934c.317-.159.69-.159 1.006 0l4.994 2.497c.317.158.69.158 1.006 0z\"\n                    />\n                  </svg>\n                  Branched\n                </span>\n              )}\n            </div>\n          </div>\n        )}\n      </div>\n    </div>\n  );\n});\n"
}

{
  "path": "services/api-gateway/app/services/tts/quality_presets.py",
  "language": "python",
  "size": 5536,
  "last_modified": "2025-12-01T22:16:42.350Z",
  "lines": 183,
  "content": "\"\"\"\nQuality Presets for TTS Voice Mode\n\nProvides user-selectable quality presets that trade off between:\n- SPEED: Fastest response, may sound slightly choppy\n- BALANCED: Good balance of speed and naturalness (default)\n- NATURAL: Most natural sounding, slightly higher latency\n\nEach preset configures:\n- Adaptive chunking limits (for TTFA optimization)\n- SSML processing (enabled/disabled)\n- TTS stability parameter (affects consistency vs expressiveness)\n- Voice style (affects pause durations)\n\nPhase: Voice Mode Latency Optimization\n\"\"\"\n\nfrom dataclasses import dataclass\nfrom enum import Enum\nfrom typing import Dict, Optional\n\nfrom app.services.sentence_chunker import AdaptiveChunkerConfig\nfrom app.services.ssml_processor import VoiceStyle\n\n\nclass QualityPreset(str, Enum):\n    \"\"\"\n    User-selectable quality presets for voice mode.\n\n    These presets let users choose their preferred balance between\n    response speed and audio naturalness.\n    \"\"\"\n\n    SPEED = \"speed\"  # ~100-150ms TTFA, may sound slightly choppy\n    BALANCED = \"balanced\"  # ~200-250ms TTFA, natural after first chunk (DEFAULT)\n    NATURAL = \"natural\"  # ~300-400ms TTFA, full sentences always\n\n\n@dataclass\nclass PresetConfig:\n    \"\"\"\n    Complete configuration for a quality preset.\n\n    Contains all settings needed to configure the TTS pipeline\n    for a particular quality/speed trade-off.\n    \"\"\"\n\n    # Adaptive chunking configuration\n    adaptive_chunking: AdaptiveChunkerConfig\n\n    # SSML processing\n    enable_ssml: bool\n    voice_style: VoiceStyle\n\n    # TTS voice parameters\n    stability: float  # 0.0-1.0, higher = more consistent voice\n    similarity_boost: float  # 0.0-1.0, higher = clearer voice\n    style_exaggeration: float  # 0.0-1.0, lower = more natural\n\n    # Audio chunk size for streaming (bytes)\n    audio_chunk_size: int\n\n    # Description for UI\n    label: str\n    description: str\n\n\n# Preset configurations\nPRESET_CONFIGS: Dict[QualityPreset, PresetConfig] = {\n    QualityPreset.SPEED: PresetConfig(\n        adaptive_chunking=AdaptiveChunkerConfig(\n            # Very small first chunk for fastest TTFA\n            first_chunk_min=15,\n            first_chunk_optimal=25,\n            first_chunk_max=40,\n            # Smaller subsequent chunks too\n            subsequent_min=30,\n            subsequent_optimal=60,\n            subsequent_max=100,\n            chunks_before_natural=1,\n            enabled=True,\n        ),\n        enable_ssml=False,  # Disable SSML to reduce processing overhead\n        voice_style=VoiceStyle.QUICK,\n        stability=0.5,  # Lower stability = faster processing\n        similarity_boost=0.8,\n        style_exaggeration=0.05,\n        audio_chunk_size=4096,  # Smaller chunks for faster streaming\n        label=\"Speed\",\n        description=\"Fastest response time. Best for quick interactions.\",\n    ),\n    QualityPreset.BALANCED: PresetConfig(\n        adaptive_chunking=AdaptiveChunkerConfig(\n            # Small first chunk for fast TTFA\n            first_chunk_min=20,\n            first_chunk_optimal=30,\n            first_chunk_max=50,\n            # Larger subsequent chunks for naturalness\n            subsequent_min=40,\n            subsequent_optimal=120,\n            subsequent_max=200,\n            chunks_before_natural=1,\n            enabled=True,\n        ),\n        enable_ssml=True,\n        voice_style=VoiceStyle.CONVERSATIONAL,\n        stability=0.65,\n        similarity_boost=0.85,\n        style_exaggeration=0.08,\n        audio_chunk_size=8192,  # Standard chunk size\n        label=\"Balanced\",\n        description=\"Good balance of speed and natural speech. Recommended.\",\n    ),\n    QualityPreset.NATURAL: PresetConfig(\n        adaptive_chunking=AdaptiveChunkerConfig(\n            # Larger first chunk for more natural opening\n            first_chunk_min=40,\n            first_chunk_optimal=80,\n            first_chunk_max=120,\n            # Full sentences for natural prosody\n            subsequent_min=60,\n            subsequent_optimal=150,\n            subsequent_max=250,\n            chunks_before_natural=1,\n            enabled=True,\n        ),\n        enable_ssml=True,\n        voice_style=VoiceStyle.CONVERSATIONAL,\n        stability=0.78,  # Higher stability for consistent voice\n        similarity_boost=0.85,\n        style_exaggeration=0.08,\n        audio_chunk_size=8192,\n        label=\"Natural\",\n        description=\"Most natural sounding speech. Slightly slower response.\",\n    ),\n}\n\n\ndef get_preset_config(preset: QualityPreset) -> PresetConfig:\n    \"\"\"\n    Get the configuration for a quality preset.\n\n    Args:\n        preset: The quality preset to get config for\n\n    Returns:\n        PresetConfig with all settings for the preset\n    \"\"\"\n    return PRESET_CONFIGS.get(preset, PRESET_CONFIGS[QualityPreset.BALANCED])\n\n\ndef get_preset_by_name(name: str) -> Optional[QualityPreset]:\n    \"\"\"\n    Get a QualityPreset by its string name.\n\n    Args:\n        name: Preset name (e.g., \"speed\", \"balanced\", \"natural\")\n\n    Returns:\n        QualityPreset enum value, or None if not found\n    \"\"\"\n    try:\n        return QualityPreset(name.lower())\n    except ValueError:\n        return None\n\n\ndef list_presets() -> list:\n    \"\"\"\n    List all available presets with their labels and descriptions.\n\n    Returns:\n        List of dicts with preset info for UI display\n    \"\"\"\n    return [\n        {\n            \"id\": preset.value,\n            \"label\": config.label,\n            \"description\": config.description,\n        }\n        for preset, config in PRESET_CONFIGS.items()\n    ]\n"
}

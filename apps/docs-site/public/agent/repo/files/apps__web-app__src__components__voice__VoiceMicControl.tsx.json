{
  "path": "apps/web-app/src/components/voice/VoiceMicControl.tsx",
  "language": "typescript",
  "size": 8329,
  "last_modified": "2025-11-29T22:50:05.169Z",
  "lines": 281,
  "content": "/**\n * Voice Mic Control Component\n *\n * Extracted from VoiceModePanel.tsx to improve modularity.\n * Renders the main microphone button with:\n * - Connection state visualization (rings, animations)\n * - Status text\n * - Action buttons (barge-in, end session, cancel recording)\n */\n\nimport { useCallback } from \"react\";\n\nexport type VoiceStatus =\n  | \"idle\"\n  | \"connecting\"\n  | \"connected\"\n  | \"reconnecting\"\n  | \"disconnected\"\n  | \"error\";\n\nexport interface VoiceMicControlProps {\n  // Connection state\n  status: VoiceStatus;\n  isConnected: boolean;\n  isSpeaking: boolean;\n  isMicPermissionDenied: boolean;\n\n  // Offline mode\n  isOfflineMode: boolean;\n  isOfflineRecording: boolean;\n  recordingDuration: number;\n\n  // Synthesis state\n  isSynthesizing: boolean;\n\n  // Actions\n  onConnect: () => void;\n  onDisconnect: () => void;\n  onBargeIn: () => void;\n  onStartOfflineRecording: () => void;\n  onStopOfflineRecording: () => void;\n  onCancelOfflineRecording: () => void;\n}\n\n/**\n * Format duration in seconds to MM:SS display\n */\nfunction formatDuration(seconds: number): string {\n  const mins = Math.floor(seconds / 60);\n  const secs = seconds % 60;\n  return `${mins}:${secs.toString().padStart(2, \"0\")}`;\n}\n\nexport function VoiceMicControl({\n  status,\n  isConnected,\n  isSpeaking,\n  isMicPermissionDenied,\n  isOfflineMode,\n  isOfflineRecording,\n  recordingDuration,\n  isSynthesizing,\n  onConnect,\n  onDisconnect,\n  onBargeIn,\n  onStartOfflineRecording,\n  onStopOfflineRecording,\n  onCancelOfflineRecording,\n}: VoiceMicControlProps) {\n  /**\n   * Handle main button click\n   */\n  const handleMainButtonClick = useCallback(() => {\n    if (isConnected || status === \"connecting\" || status === \"reconnecting\") {\n      onDisconnect();\n    } else if (isOfflineMode) {\n      if (isOfflineRecording) {\n        onStopOfflineRecording();\n      } else {\n        onStartOfflineRecording();\n      }\n    } else if (!isMicPermissionDenied) {\n      onConnect();\n    }\n  }, [\n    isConnected,\n    status,\n    isOfflineMode,\n    isOfflineRecording,\n    isMicPermissionDenied,\n    onConnect,\n    onDisconnect,\n    onStartOfflineRecording,\n    onStopOfflineRecording,\n  ]);\n\n  /**\n   * Get button class based on state\n   */\n  const getButtonClass = () => {\n    if (isConnected) {\n      return \"bg-green-500 hover:bg-green-600 text-white\";\n    }\n    if (isOfflineRecording) {\n      return \"bg-red-500 hover:bg-red-600 text-white animate-pulse\";\n    }\n    if (status === \"connecting\" || status === \"reconnecting\") {\n      return \"bg-yellow-500 text-white cursor-wait\";\n    }\n    if (isMicPermissionDenied) {\n      return \"bg-red-100 text-red-400 cursor-not-allowed\";\n    }\n    if (isOfflineMode) {\n      return \"bg-orange-500 hover:bg-orange-600 text-white\";\n    }\n    return \"bg-primary-500 hover:bg-primary-600 text-white\";\n  };\n\n  /**\n   * Get button aria-label\n   */\n  const getAriaLabel = () => {\n    if (isConnected) return \"End voice session\";\n    if (isOfflineRecording) return \"Stop recording\";\n    if (status === \"connecting\") return \"Connecting...\";\n    if (isOfflineMode) return \"Start offline recording\";\n    return \"Start voice session\";\n  };\n\n  /**\n   * Get status text\n   */\n  const getStatusText = () => {\n    if (isConnected) {\n      return isSpeaking ? \"Listening...\" : \"Speak now\";\n    }\n    if (isOfflineRecording) {\n      return `Recording ${formatDuration(recordingDuration)}`;\n    }\n    if (status === \"connecting\") return \"Connecting...\";\n    if (status === \"reconnecting\") return \"Reconnecting...\";\n    if (isOfflineMode) return \"Tap to record offline\";\n    return \"Tap to start\";\n  };\n\n  return (\n    <div className=\"flex flex-col items-center py-4\">\n      {/* Main Mic Button with Ring Animation */}\n      <div className=\"relative\">\n        {/* Outer ring animation when speaking */}\n        {isConnected && isSpeaking && (\n          <div className=\"absolute inset-0 -m-3\">\n            <div className=\"absolute inset-0 rounded-full border-4 border-green-400 animate-ping opacity-50\" />\n            <div className=\"absolute inset-0 rounded-full border-2 border-green-300 animate-pulse\" />\n          </div>\n        )}\n\n        {/* Connected ring */}\n        {isConnected && !isSpeaking && (\n          <div className=\"absolute inset-0 -m-2 rounded-full border-2 border-green-400 opacity-60\" />\n        )}\n\n        {/* Main button */}\n        <button\n          type=\"button\"\n          onClick={handleMainButtonClick}\n          disabled={isMicPermissionDenied}\n          className={`relative w-16 h-16 sm:w-20 sm:h-20 rounded-full flex items-center justify-center transition-all duration-200 shadow-lg ${getButtonClass()}`}\n          aria-label={getAriaLabel()}\n          data-testid=\"main-mic-button\"\n        >\n          {/* Mic icon */}\n          <svg\n            className={`w-8 h-8 sm:w-10 sm:h-10 ${status === \"connecting\" || status === \"reconnecting\" ? \"animate-pulse\" : \"\"}`}\n            fill=\"none\"\n            viewBox=\"0 0 24 24\"\n            stroke=\"currentColor\"\n            strokeWidth={1.5}\n          >\n            <path\n              strokeLinecap=\"round\"\n              strokeLinejoin=\"round\"\n              d=\"M12 18.75a6 6 0 006-6v-1.5m-6 7.5a6 6 0 01-6-6v-1.5m6 7.5v3.75m-3.75 0h7.5M12 15.75a3 3 0 01-3-3V4.5a3 3 0 116 0v8.25a3 3 0 01-3 3z\"\n            />\n          </svg>\n        </button>\n      </div>\n\n      {/* Status text below button */}\n      <p\n        className=\"mt-3 text-sm font-medium text-neutral-600\"\n        data-testid=\"mic-status-text\"\n      >\n        {getStatusText()}\n      </p>\n\n      {/* Action buttons row */}\n      <div className=\"flex items-center gap-3 mt-3\">\n        {/* Barge-in button (only when connected and synthesizing) */}\n        {isConnected && isSynthesizing && (\n          <button\n            type=\"button\"\n            onClick={onBargeIn}\n            className=\"flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium text-primary-700 bg-primary-50 hover:bg-primary-100 rounded-full transition-colors\"\n            aria-label=\"Interrupt AI response\"\n          >\n            <svg\n              className=\"w-3.5 h-3.5\"\n              fill=\"none\"\n              viewBox=\"0 0 24 24\"\n              stroke=\"currentColor\"\n              strokeWidth={2}\n            >\n              <path\n                strokeLinecap=\"round\"\n                strokeLinejoin=\"round\"\n                d=\"M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636\"\n              />\n            </svg>\n            Interrupt\n          </button>\n        )}\n\n        {/* End session button (only when connected) */}\n        {isConnected && (\n          <button\n            type=\"button\"\n            onClick={onDisconnect}\n            className=\"flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium text-red-700 bg-red-50 hover:bg-red-100 rounded-full transition-colors\"\n            aria-label=\"End voice session\"\n            data-testid=\"end-session-small\"\n          >\n            <svg\n              className=\"w-3.5 h-3.5\"\n              fill=\"none\"\n              viewBox=\"0 0 24 24\"\n              stroke=\"currentColor\"\n              strokeWidth={2}\n            >\n              <path\n                strokeLinecap=\"round\"\n                strokeLinejoin=\"round\"\n                d=\"M5.636 5.636a9 9 0 1012.728 12.728M5.636 5.636L18.364 18.364M5.636 5.636L18.364 18.364\"\n              />\n            </svg>\n            End\n          </button>\n        )}\n\n        {/* Cancel offline recording */}\n        {isOfflineRecording && (\n          <button\n            type=\"button\"\n            onClick={onCancelOfflineRecording}\n            className=\"flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium text-neutral-700 bg-neutral-100 hover:bg-neutral-200 rounded-full transition-colors\"\n            aria-label=\"Cancel recording\"\n            data-testid=\"cancel-offline-recording\"\n          >\n            <svg\n              className=\"w-3.5 h-3.5\"\n              fill=\"none\"\n              viewBox=\"0 0 24 24\"\n              stroke=\"currentColor\"\n              strokeWidth={2}\n            >\n              <path\n                strokeLinecap=\"round\"\n                strokeLinejoin=\"round\"\n                d=\"M6 18L18 6M6 6l12 12\"\n              />\n            </svg>\n            Cancel\n          </button>\n        )}\n      </div>\n    </div>\n  );\n}\n\nexport default VoiceMicControl;\n"
}

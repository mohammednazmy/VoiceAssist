{
  "path": "services/api-gateway/app/services/ssml_processor.py",
  "language": "python",
  "size": 9319,
  "last_modified": "2025-12-02T03:07:30.693Z",
  "lines": 326,
  "content": "\"\"\"\nSSML Processor for Natural Speech Rhythm\n\nInjects SSML tags into text to improve TTS naturalness through:\n- Sentence-ending pauses\n- Clause/punctuation pauses\n- List item pauses\n- Paragraph breaks\n\nDesigned for ElevenLabs TTS which supports a subset of SSML tags.\n\nPhase: Voice Mode Latency Optimization\n\"\"\"\n\nimport re\nfrom dataclasses import dataclass\nfrom enum import Enum\nfrom typing import Optional\n\nfrom app.core.logging import get_logger\n\nlogger = get_logger(__name__)\n\n\nclass VoiceStyle(str, Enum):\n    \"\"\"Voice styles that affect SSML processing.\"\"\"\n\n    CONVERSATIONAL = \"conversational\"  # Default - natural speech\n    NARRATION = \"narration\"  # Longer pauses, more dramatic\n    QUICK = \"quick\"  # Shorter pauses for fast responses\n\n\n@dataclass\nclass SSMLConfig:\n    \"\"\"\n    Configuration for SSML tag injection.\n\n    Default pause durations are tuned for natural conversational speech.\n    Adjust based on voice style and user preference.\n    \"\"\"\n\n    # Pause after sentence-ending punctuation (. ! ?)\n    sentence_pause_ms: int = 300\n\n    # Pause after clause punctuation (, ; :)\n    clause_pause_ms: int = 200\n\n    # Pause before list items (when detected)\n    list_item_pause_ms: int = 400\n\n    # Pause for paragraph breaks (double newlines)\n    paragraph_pause_ms: int = 600\n\n    # Pause after question marks (slightly longer for effect)\n    question_pause_ms: int = 350\n\n    # Pause after exclamation marks\n    exclamation_pause_ms: int = 280\n\n    # Enable/disable SSML processing\n    enabled: bool = True\n\n\n# Preset configurations for different voice styles\nSTYLE_PRESETS = {\n    VoiceStyle.CONVERSATIONAL: SSMLConfig(\n        sentence_pause_ms=300,\n        clause_pause_ms=200,\n        list_item_pause_ms=400,\n        paragraph_pause_ms=600,\n        question_pause_ms=350,\n        exclamation_pause_ms=280,\n    ),\n    VoiceStyle.NARRATION: SSMLConfig(\n        sentence_pause_ms=450,\n        clause_pause_ms=300,\n        list_item_pause_ms=500,\n        paragraph_pause_ms=800,\n        question_pause_ms=500,\n        exclamation_pause_ms=400,\n    ),\n    VoiceStyle.QUICK: SSMLConfig(\n        sentence_pause_ms=150,\n        clause_pause_ms=100,\n        list_item_pause_ms=200,\n        paragraph_pause_ms=300,\n        question_pause_ms=180,\n        exclamation_pause_ms=140,\n    ),\n}\n\n\nclass SSMLProcessor:\n    \"\"\"\n    Injects SSML tags for natural speech rhythm.\n\n    Processes text to add <break> tags at appropriate points:\n    - After sentences for natural pausing\n    - After clauses for breath points\n    - Before list items for clarity\n    - At paragraph breaks for topic transitions\n\n    ElevenLabs SSML Support:\n    - <break time=\"Xs\"/> or <break time=\"Xms\"/> - pauses\n    - <emphasis> - not fully supported, use sparingly\n    - Most other SSML tags are ignored\n\n    Usage:\n        processor = SSMLProcessor()\n\n        # Process text before sending to TTS\n        ssml_text = processor.process(\"Hello! How are you?\")\n        # Result: \"Hello!<break time=\\\"280ms\\\"/> How are you?<break time=\\\"350ms\\\"/>\"\n\n        # Use a specific style\n        ssml_text = processor.process(text, style=VoiceStyle.NARRATION)\n    \"\"\"\n\n    def __init__(self, config: Optional[SSMLConfig] = None):\n        \"\"\"\n        Initialize the SSML processor.\n\n        Args:\n            config: Optional custom configuration. Uses CONVERSATIONAL preset if not provided.\n        \"\"\"\n        self._config = config or STYLE_PRESETS[VoiceStyle.CONVERSATIONAL]\n\n    def process(\n        self,\n        text: str,\n        style: Optional[VoiceStyle] = None,\n    ) -> str:\n        \"\"\"\n        Process text and inject SSML break tags.\n\n        Args:\n            text: Plain text to process\n            style: Optional voice style override (uses config style if not specified)\n\n        Returns:\n            Text with SSML <break> tags injected\n        \"\"\"\n        if not text or not self._config.enabled:\n            return text\n\n        # Use style preset if specified\n        config = STYLE_PRESETS.get(style, self._config) if style else self._config\n\n        result = text\n\n        # Process in order of precedence (most specific first)\n        result = self._add_paragraph_breaks(result, config)\n        result = self._add_list_pauses(result, config)\n        result = self._add_sentence_pauses(result, config)\n        result = self._add_clause_pauses(result, config)\n\n        # Clean up any duplicate breaks\n        result = self._clean_duplicate_breaks(result)\n\n        return result\n\n    def _add_sentence_pauses(self, text: str, config: SSMLConfig) -> str:\n        \"\"\"\n        Add pauses after sentence-ending punctuation.\n\n        Handles:\n        - Period (.)\n        - Question mark (?) - slightly longer pause\n        - Exclamation mark (!)\n\n        Preserves existing breaks and handles quoted text.\n        \"\"\"\n        # Question marks - longer pause for effect\n        text = re.sub(\n            r\"\\?(?!\\s*<break)(\\s*)\",\n            f'?<break time=\"{config.question_pause_ms}ms\"/>\\\\1',\n            text,\n        )\n\n        # Exclamation marks\n        text = re.sub(\n            r\"!(?!\\s*<break)(\\s*)\",\n            f'!<break time=\"{config.exclamation_pause_ms}ms\"/>\\\\1',\n            text,\n        )\n\n        # Periods - but not in abbreviations (e.g., \"Dr.\", \"etc.\")\n        # Look for period followed by space and capital letter or end of string\n        text = re.sub(\n            r\"\\.(?!\\s*<break)(\\s+)(?=[A-Z]|$)\",\n            f'.<break time=\"{config.sentence_pause_ms}ms\"/>\\\\1',\n            text,\n        )\n\n        return text\n\n    def _add_clause_pauses(self, text: str, config: SSMLConfig) -> str:\n        \"\"\"\n        Add pauses after clause punctuation.\n\n        Handles:\n        - Comma (,)\n        - Semicolon (;)\n        - Colon (:)\n        - Em-dash (—)\n\n        Only adds pause if followed by space (natural pause point).\n        \"\"\"\n        # Comma followed by space\n        text = re.sub(\n            r\",(?!\\s*<break)(\\s+)\",\n            f',<break time=\"{config.clause_pause_ms}ms\"/>\\\\1',\n            text,\n        )\n\n        # Semicolon followed by space\n        text = re.sub(\n            r\";(?!\\s*<break)(\\s+)\",\n            f';<break time=\"{config.clause_pause_ms}ms\"/>\\\\1',\n            text,\n        )\n\n        # Colon followed by space (but not in URLs or times)\n        text = re.sub(\n            r\":(?!\\d)(?!\\s*<break)(\\s+)\",\n            f':<break time=\"{config.clause_pause_ms}ms\"/>\\\\1',\n            text,\n        )\n\n        # Em-dash\n        text = re.sub(\n            r\"—(?!\\s*<break)(\\s*)\",\n            f'—<break time=\"{config.clause_pause_ms}ms\"/>\\\\1',\n            text,\n        )\n\n        return text\n\n    def _add_list_pauses(self, text: str, config: SSMLConfig) -> str:\n        \"\"\"\n        Add pauses before list items.\n\n        Detects patterns like:\n        - \"First, ... Second, ...\"\n        - \"1. ... 2. ...\"\n        - Bullet points\n\n        Adds pause before each item for clarity.\n        \"\"\"\n        # Ordinal words (First, Second, Third, etc.)\n        ordinals = (\n            r\"\\b(First|Second|Third|Fourth|Fifth|Sixth|Seventh|Eighth|\"\n            r\"Ninth|Tenth|Next|Finally|Lastly|Also|Additionally)\\b\"\n        )\n        text = re.sub(\n            rf\"(\\s)({ordinals})\",\n            f'\\\\1<break time=\"{config.list_item_pause_ms}ms\"/>\\\\2',\n            text,\n            flags=re.IGNORECASE,\n        )\n\n        # Numbered lists (1. 2. etc.) at start of content\n        text = re.sub(\n            r\"(\\n\\s*)(\\d+\\.)\",\n            f'\\\\1<break time=\"{config.list_item_pause_ms}ms\"/>\\\\2',\n            text,\n        )\n\n        return text\n\n    def _add_paragraph_breaks(self, text: str, config: SSMLConfig) -> str:\n        \"\"\"\n        Add longer pauses at paragraph breaks.\n\n        Detects double newlines as paragraph breaks and adds\n        a longer pause for topic transition effect.\n        \"\"\"\n        # Double newline = paragraph break\n        text = re.sub(\n            r\"\\n\\n+\",\n            f'\\n<break time=\"{config.paragraph_pause_ms}ms\"/>\\n',\n            text,\n        )\n\n        return text\n\n    def _clean_duplicate_breaks(self, text: str) -> str:\n        \"\"\"\n        Remove duplicate or adjacent break tags.\n\n        When multiple rules match the same position, this consolidates\n        to a single break with the longest duration.\n        \"\"\"\n        # Find sequences of adjacent breaks and keep the longest\n        pattern = r'(<break time=\"(\\d+)ms\"/>)(\\s*)(<break time=\"(\\d+)ms\"/>)'\n\n        def keep_longest(match):\n            time1 = int(match.group(2))\n            time2 = int(match.group(5))\n            longest = max(time1, time2)\n            return f'<break time=\"{longest}ms\"/>{match.group(3)}'\n\n        # Apply repeatedly until no more duplicates\n        prev_text = \"\"\n        while prev_text != text:\n            prev_text = text\n            text = re.sub(pattern, keep_longest, text)\n\n        return text\n\n    def set_config(self, config: SSMLConfig) -> None:\n        \"\"\"Update the processor configuration.\"\"\"\n        self._config = config\n\n    def enable(self) -> None:\n        \"\"\"Enable SSML processing.\"\"\"\n        self._config.enabled = True\n\n    def disable(self) -> None:\n        \"\"\"Disable SSML processing (pass-through mode).\"\"\"\n        self._config.enabled = False\n\n\n# Global processor instance with default config\nssml_processor = SSMLProcessor()\n"
}

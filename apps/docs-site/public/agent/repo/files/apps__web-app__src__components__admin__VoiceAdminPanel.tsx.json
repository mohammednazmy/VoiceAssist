{
  "path": "apps/web-app/src/components/admin/VoiceAdminPanel.tsx",
  "language": "typescript",
  "size": 23051,
  "last_modified": "2025-12-03T23:50:35.642Z",
  "lines": 669,
  "content": "/**\n * Voice Admin Panel - Phase 11.1: Comprehensive Voice Configuration\n *\n * Admin panel for managing voice mode settings:\n * - TTS Provider configuration (OpenAI/ElevenLabs)\n * - Voice selection and defaults\n * - Feature flags (echo cancellation, adaptive VAD, etc.)\n * - Voice metrics dashboard\n */\n\nimport { useState, useEffect, useCallback } from \"react\";\nimport { useAuth } from \"../../hooks/useAuth\";\n\n// Types\ninterface VoiceInfo {\n  voice_id: string;\n  name: string;\n  provider: string; // \"openai\" | \"elevenlabs\" or other providers\n  category?: string;\n  preview_url?: string;\n  description?: string;\n  labels?: Record<string, string>;\n}\n\ninterface _VoiceListResponse {\n  voices: VoiceInfo[];\n  default_voice_id?: string | null;\n  default_provider: string;\n}\n\ninterface ElevenLabsUsage {\n  character_count: number;\n  character_limit: number;\n  voice_limit: number;\n  professional_voice_limit: number;\n  next_reset_at?: string;\n}\n\ninterface VoiceFeatureFlags {\n  echoDetectionEnabled: boolean;\n  adaptiveVadEnabled: boolean;\n  elevenlabsEnabled: boolean;\n  streamingTtsEnabled: boolean;\n  bargeInEnabled: boolean;\n}\n\n// Tab type\ntype TabId = \"config\" | \"analytics\" | \"features\";\n\n// ============================================================================\n// Sub-components\n// ============================================================================\n\n// Provider Badge\nfunction ProviderBadge({ provider }: { provider: string }) {\n  const colors =\n    provider === \"elevenlabs\"\n      ? \"bg-purple-100 text-purple-700\"\n      : \"bg-blue-100 text-blue-700\";\n\n  return (\n    <span className={`text-xs px-2 py-0.5 rounded-full font-medium ${colors}`}>\n      {provider === \"elevenlabs\" ? \"ElevenLabs\" : \"OpenAI\"}\n    </span>\n  );\n}\n\n// Voice Card\nfunction VoiceCard({\n  voice,\n  isDefault,\n  onSetDefault,\n}: {\n  voice: VoiceInfo;\n  isDefault: boolean;\n  onSetDefault: () => void;\n}) {\n  return (\n    <div\n      className={`p-4 rounded-lg border ${isDefault ? \"border-primary-500 bg-primary-50\" : \"border-neutral-200 bg-white\"}`}\n    >\n      <div className=\"flex items-start justify-between\">\n        <div>\n          <h4 className=\"font-medium text-neutral-900\">{voice.name}</h4>\n          <div className=\"flex items-center space-x-2 mt-1\">\n            <ProviderBadge provider={voice.provider} />\n            {voice.category && (\n              <span className=\"text-xs text-neutral-500\">{voice.category}</span>\n            )}\n          </div>\n          {voice.description && (\n            <p className=\"text-sm text-neutral-600 mt-2\">{voice.description}</p>\n          )}\n          {voice.labels && Object.keys(voice.labels).length > 0 && (\n            <div className=\"flex flex-wrap gap-1 mt-2\">\n              {Object.entries(voice.labels).map(([key, value]) => (\n                <span\n                  key={key}\n                  className=\"text-xs px-1.5 py-0.5 bg-neutral-100 text-neutral-600 rounded\"\n                >\n                  {key}: {value}\n                </span>\n              ))}\n            </div>\n          )}\n        </div>\n        <div className=\"flex items-center space-x-2\">\n          {voice.preview_url && (\n            <button\n              onClick={() => {\n                const audio = new Audio(voice.preview_url);\n                audio.play();\n              }}\n              className=\"p-2 text-neutral-500 hover:text-neutral-700 hover:bg-neutral-100 rounded-full\"\n              title=\"Preview voice\"\n            >\n              <svg\n                xmlns=\"http://www.w3.org/2000/svg\"\n                fill=\"none\"\n                viewBox=\"0 0 24 24\"\n                strokeWidth={1.5}\n                stroke=\"currentColor\"\n                className=\"w-5 h-5\"\n              >\n                <path\n                  strokeLinecap=\"round\"\n                  strokeLinejoin=\"round\"\n                  d=\"M5.25 5.653c0-.856.917-1.398 1.667-.986l11.54 6.348a1.125 1.125 0 010 1.971l-11.54 6.347a1.125 1.125 0 01-1.667-.985V5.653z\"\n                />\n              </svg>\n            </button>\n          )}\n          <button\n            onClick={onSetDefault}\n            disabled={isDefault}\n            className={`px-3 py-1.5 text-sm rounded-md transition-colors ${\n              isDefault\n                ? \"bg-primary-600 text-white cursor-default\"\n                : \"bg-neutral-100 text-neutral-700 hover:bg-neutral-200\"\n            }`}\n          >\n            {isDefault ? \"Default\" : \"Set Default\"}\n          </button>\n        </div>\n      </div>\n    </div>\n  );\n}\n\n// Usage Gauge\nfunction UsageGauge({\n  used,\n  limit,\n  label,\n}: {\n  used: number;\n  limit: number;\n  label: string;\n}) {\n  const percentage = Math.min((used / limit) * 100, 100);\n  const status =\n    percentage < 50 ? \"good\" : percentage < 80 ? \"warning\" : \"critical\";\n  const colors = {\n    good: \"bg-green-500\",\n    warning: \"bg-yellow-500\",\n    critical: \"bg-red-500\",\n  };\n\n  return (\n    <div className=\"space-y-2\">\n      <div className=\"flex justify-between text-sm\">\n        <span className=\"text-neutral-600\">{label}</span>\n        <span className=\"font-medium text-neutral-900\">\n          {used.toLocaleString()} / {limit.toLocaleString()}\n        </span>\n      </div>\n      <div className=\"h-2 bg-neutral-200 rounded-full overflow-hidden\">\n        <div\n          className={`h-full ${colors[status]} transition-all duration-300`}\n          style={{ width: `${percentage}%` }}\n        />\n      </div>\n      <p className=\"text-xs text-neutral-500\">{percentage.toFixed(1)}% used</p>\n    </div>\n  );\n}\n\n// Feature Flag Toggle\nfunction FeatureFlagToggle({\n  label,\n  description,\n  enabled,\n  onChange,\n  loading,\n}: {\n  label: string;\n  description: string;\n  enabled: boolean;\n  onChange: (enabled: boolean) => void;\n  loading?: boolean;\n}) {\n  return (\n    <div className=\"flex items-center justify-between py-4 border-b border-neutral-100 last:border-0\">\n      <div>\n        <h4 className=\"font-medium text-neutral-900\">{label}</h4>\n        <p className=\"text-sm text-neutral-600\">{description}</p>\n      </div>\n      <button\n        onClick={() => onChange(!enabled)}\n        disabled={loading}\n        className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors ${\n          enabled ? \"bg-primary-600\" : \"bg-neutral-300\"\n        } ${loading ? \"opacity-50 cursor-not-allowed\" : \"\"}`}\n      >\n        <span\n          className={`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${\n            enabled ? \"translate-x-6\" : \"translate-x-1\"\n          }`}\n        />\n      </button>\n    </div>\n  );\n}\n\n// ============================================================================\n// Main Component\n// ============================================================================\n\nexport function VoiceAdminPanel() {\n  const { apiClient } = useAuth();\n\n  // State\n  const [activeTab, setActiveTab] = useState<TabId>(\"config\");\n  const [voices, setVoices] = useState<VoiceInfo[]>([]);\n  const [defaultVoiceId, setDefaultVoiceId] = useState<string | null>(null);\n  const [defaultProvider, setDefaultProvider] = useState<string>(\"openai\");\n  const [providerFilter, setProviderFilter] = useState<string>(\"all\");\n  const [elevenlabsUsage, _setElevenlabsUsage] =\n    useState<ElevenLabsUsage | null>(null);\n  const [loading, setLoading] = useState(true);\n  const [error, setError] = useState<string | null>(null);\n  const [savingFlags, setSavingFlags] = useState(false);\n\n  // Feature flags state\n  const [featureFlags, setFeatureFlags] = useState<VoiceFeatureFlags>({\n    echoDetectionEnabled: true,\n    adaptiveVadEnabled: true,\n    elevenlabsEnabled: true,\n    streamingTtsEnabled: true,\n    bargeInEnabled: true,\n  });\n\n  // Load voices\n  const loadVoices = useCallback(async () => {\n    setLoading(true);\n    setError(null);\n\n    try {\n      const response = await apiClient.getAvailableVoices();\n      setVoices(response.voices);\n      setDefaultVoiceId(response.default_voice_id || null);\n      setDefaultProvider(response.default_provider);\n    } catch (err) {\n      setError(err instanceof Error ? err.message : \"Failed to load voices\");\n    } finally {\n      setLoading(false);\n    }\n  }, [apiClient]);\n\n  // Load ElevenLabs usage (if available)\n  const loadElevenlabsUsage = useCallback(async () => {\n    try {\n      // This would call a new API endpoint for ElevenLabs usage\n      // For now, we'll simulate it\n      // const usage = await apiClient.getElevenlabsUsage();\n      // setElevenlabsUsage(usage);\n    } catch {\n      // ElevenLabs might not be configured - ignore\n    }\n  }, []);\n\n  // Load feature flags\n  const loadFeatureFlags = useCallback(async () => {\n    try {\n      // Load from API or localStorage\n      const stored = localStorage.getItem(\"voiceassist-voice-feature-flags\");\n      if (stored) {\n        setFeatureFlags(JSON.parse(stored));\n      }\n    } catch {\n      // Use defaults\n    }\n  }, []);\n\n  // Initial load\n  useEffect(() => {\n    loadVoices();\n    loadElevenlabsUsage();\n    loadFeatureFlags();\n  }, [loadVoices, loadElevenlabsUsage, loadFeatureFlags]);\n\n  // Set default voice\n  const handleSetDefaultVoice = async (voice: VoiceInfo) => {\n    try {\n      // In a real implementation, this would call an API to persist the setting\n      setDefaultVoiceId(voice.voice_id);\n      setDefaultProvider(voice.provider);\n\n      // Store in localStorage for now\n      localStorage.setItem(\n        \"voiceassist-default-voice\",\n        JSON.stringify({\n          voice_id: voice.voice_id,\n          provider: voice.provider,\n        }),\n      );\n    } catch {\n      setError(\"Failed to set default voice\");\n    }\n  };\n\n  // Update feature flag\n  const handleFeatureFlagChange = async (\n    flag: keyof VoiceFeatureFlags,\n    enabled: boolean,\n  ) => {\n    setSavingFlags(true);\n    try {\n      const newFlags = { ...featureFlags, [flag]: enabled };\n      setFeatureFlags(newFlags);\n\n      // Persist to localStorage (in production, this would be an API call)\n      localStorage.setItem(\n        \"voiceassist-voice-feature-flags\",\n        JSON.stringify(newFlags),\n      );\n    } catch {\n      setError(\"Failed to update feature flag\");\n    } finally {\n      setSavingFlags(false);\n    }\n  };\n\n  // Filter voices\n  const filteredVoices =\n    providerFilter === \"all\"\n      ? voices\n      : voices.filter((v) => v.provider === providerFilter);\n\n  // Group voices by provider\n  const openaiVoices = voices.filter((v) => v.provider === \"openai\");\n  const elevenlabsVoices = voices.filter((v) => v.provider === \"elevenlabs\");\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-2xl font-bold text-neutral-900\">\n            Voice Configuration\n          </h1>\n          <p className=\"text-sm text-neutral-600\">\n            Manage TTS providers, voices, and voice mode features\n          </p>\n        </div>\n        <button\n          onClick={loadVoices}\n          disabled={loading}\n          className=\"px-4 py-2 text-sm font-medium text-primary-700 bg-primary-50 rounded-md hover:bg-primary-100 disabled:opacity-50\"\n        >\n          {loading ? \"Refreshing...\" : \"Refresh\"}\n        </button>\n      </div>\n\n      {/* Error Banner */}\n      {error && (\n        <div className=\"p-4 bg-red-50 border border-red-200 rounded-lg text-red-700\">\n          {error}\n          <button\n            onClick={() => setError(null)}\n            className=\"ml-2 text-red-500 hover:text-red-700\"\n          >\n            Dismiss\n          </button>\n        </div>\n      )}\n\n      {/* Tabs */}\n      <div className=\"border-b border-neutral-200\">\n        <nav className=\"flex space-x-8\">\n          {[\n            { id: \"config\", label: \"TTS Configuration\", icon: \"cog\" },\n            { id: \"analytics\", label: \"Usage & Analytics\", icon: \"chart\" },\n            { id: \"features\", label: \"Feature Flags\", icon: \"flag\" },\n          ].map((tab) => (\n            <button\n              key={tab.id}\n              onClick={() => setActiveTab(tab.id as TabId)}\n              className={`py-4 px-1 border-b-2 font-medium text-sm transition-colors ${\n                activeTab === tab.id\n                  ? \"border-primary-500 text-primary-600\"\n                  : \"border-transparent text-neutral-500 hover:text-neutral-700\"\n              }`}\n            >\n              {tab.label}\n            </button>\n          ))}\n        </nav>\n      </div>\n\n      {/* Tab Content */}\n      {activeTab === \"config\" && (\n        <div className=\"space-y-6\">\n          {/* Provider Selection */}\n          <div className=\"bg-white rounded-lg shadow p-6\">\n            <h2 className=\"text-lg font-semibold text-neutral-900 mb-4\">\n              TTS Provider\n            </h2>\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n              <button\n                onClick={() => setDefaultProvider(\"openai\")}\n                className={`p-4 rounded-lg border-2 text-left transition-colors ${\n                  defaultProvider === \"openai\"\n                    ? \"border-primary-500 bg-primary-50\"\n                    : \"border-neutral-200 hover:border-neutral-300\"\n                }`}\n              >\n                <h3 className=\"font-medium text-neutral-900\">OpenAI TTS</h3>\n                <p className=\"text-sm text-neutral-600 mt-1\">\n                  Built-in TTS with 6 natural voices. Fast and reliable.\n                </p>\n                <div className=\"flex items-center space-x-2 mt-2\">\n                  <span className=\"text-xs px-2 py-0.5 bg-blue-100 text-blue-700 rounded\">\n                    {openaiVoices.length} voices\n                  </span>\n                  <span className=\"text-xs text-neutral-500\">Included</span>\n                </div>\n              </button>\n\n              <button\n                onClick={() => setDefaultProvider(\"elevenlabs\")}\n                className={`p-4 rounded-lg border-2 text-left transition-colors ${\n                  defaultProvider === \"elevenlabs\"\n                    ? \"border-primary-500 bg-primary-50\"\n                    : \"border-neutral-200 hover:border-neutral-300\"\n                }`}\n              >\n                <h3 className=\"font-medium text-neutral-900\">ElevenLabs</h3>\n                <p className=\"text-sm text-neutral-600 mt-1\">\n                  Premium neural voices with emotion control. Higher quality.\n                </p>\n                <div className=\"flex items-center space-x-2 mt-2\">\n                  <span className=\"text-xs px-2 py-0.5 bg-purple-100 text-purple-700 rounded\">\n                    {elevenlabsVoices.length} voices\n                  </span>\n                  <span className=\"text-xs text-neutral-500\">Premium</span>\n                </div>\n              </button>\n            </div>\n          </div>\n\n          {/* Voice Selection */}\n          <div className=\"bg-white rounded-lg shadow p-6\">\n            <div className=\"flex items-center justify-between mb-4\">\n              <h2 className=\"text-lg font-semibold text-neutral-900\">\n                Available Voices\n              </h2>\n              <select\n                value={providerFilter}\n                onChange={(e) => setProviderFilter(e.target.value)}\n                className=\"px-3 py-1.5 text-sm border border-neutral-300 rounded-md focus:ring-primary-500 focus:border-primary-500\"\n              >\n                <option value=\"all\">All Providers</option>\n                <option value=\"openai\">OpenAI</option>\n                <option value=\"elevenlabs\">ElevenLabs</option>\n              </select>\n            </div>\n\n            {loading ? (\n              <div className=\"text-center py-8 text-neutral-500\">\n                Loading voices...\n              </div>\n            ) : filteredVoices.length === 0 ? (\n              <div className=\"text-center py-8 text-neutral-500\">\n                No voices available\n              </div>\n            ) : (\n              <div className=\"space-y-3\">\n                {filteredVoices.map((voice) => (\n                  <VoiceCard\n                    key={voice.voice_id}\n                    voice={voice}\n                    isDefault={voice.voice_id === defaultVoiceId}\n                    onSetDefault={() => handleSetDefaultVoice(voice)}\n                  />\n                ))}\n              </div>\n            )}\n          </div>\n        </div>\n      )}\n\n      {activeTab === \"analytics\" && (\n        <div className=\"space-y-6\">\n          {/* ElevenLabs Usage */}\n          {elevenlabsUsage && (\n            <div className=\"bg-white rounded-lg shadow p-6\">\n              <h2 className=\"text-lg font-semibold text-neutral-900 mb-4\">\n                ElevenLabs Usage\n              </h2>\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n                <UsageGauge\n                  used={elevenlabsUsage.character_count}\n                  limit={elevenlabsUsage.character_limit}\n                  label=\"Characters Used\"\n                />\n                <div className=\"space-y-4\">\n                  <div className=\"flex justify-between\">\n                    <span className=\"text-neutral-600\">Voice Limit</span>\n                    <span className=\"font-medium\">\n                      {elevenlabsUsage.voice_limit}\n                    </span>\n                  </div>\n                  <div className=\"flex justify-between\">\n                    <span className=\"text-neutral-600\">Pro Voices</span>\n                    <span className=\"font-medium\">\n                      {elevenlabsUsage.professional_voice_limit}\n                    </span>\n                  </div>\n                  {elevenlabsUsage.next_reset_at && (\n                    <div className=\"flex justify-between\">\n                      <span className=\"text-neutral-600\">Resets</span>\n                      <span className=\"font-medium\">\n                        {new Date(\n                          elevenlabsUsage.next_reset_at,\n                        ).toLocaleDateString()}\n                      </span>\n                    </div>\n                  )}\n                </div>\n              </div>\n            </div>\n          )}\n\n          {/* Provider Stats */}\n          <div className=\"bg-white rounded-lg shadow p-6\">\n            <h2 className=\"text-lg font-semibold text-neutral-900 mb-4\">\n              Provider Statistics\n            </h2>\n            <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n              <div className=\"text-center p-4 bg-blue-50 rounded-lg\">\n                <p className=\"text-3xl font-bold text-blue-600\">\n                  {openaiVoices.length}\n                </p>\n                <p className=\"text-sm text-neutral-600\">OpenAI Voices</p>\n              </div>\n              <div className=\"text-center p-4 bg-purple-50 rounded-lg\">\n                <p className=\"text-3xl font-bold text-purple-600\">\n                  {elevenlabsVoices.length}\n                </p>\n                <p className=\"text-sm text-neutral-600\">ElevenLabs Voices</p>\n              </div>\n              <div className=\"text-center p-4 bg-green-50 rounded-lg\">\n                <p className=\"text-3xl font-bold text-green-600\">\n                  {voices.length}\n                </p>\n                <p className=\"text-sm text-neutral-600\">Total Available</p>\n              </div>\n            </div>\n          </div>\n\n          {/* Note about voice metrics */}\n          <div className=\"bg-neutral-50 rounded-lg p-6 border border-neutral-200\">\n            <p className=\"text-sm text-neutral-600\">\n              For detailed voice session metrics and latency analytics, visit\n              the{\" \"}\n              <a\n                href=\"/admin/voice-metrics\"\n                className=\"text-primary-600 hover:underline\"\n              >\n                Voice Health Dashboard\n              </a>\n              .\n            </p>\n          </div>\n        </div>\n      )}\n\n      {activeTab === \"features\" && (\n        <div className=\"space-y-6\">\n          {/* Voice Mode Features */}\n          <div className=\"bg-white rounded-lg shadow p-6\">\n            <h2 className=\"text-lg font-semibold text-neutral-900 mb-4\">\n              Voice Mode Features\n            </h2>\n            <div className=\"divide-y divide-neutral-100\">\n              <FeatureFlagToggle\n                label=\"Echo Detection\"\n                description=\"Enable local echo detection in AudioWorklet to suppress speaker feedback\"\n                enabled={featureFlags.echoDetectionEnabled}\n                onChange={(enabled) =>\n                  handleFeatureFlagChange(\"echoDetectionEnabled\", enabled)\n                }\n                loading={savingFlags}\n              />\n              <FeatureFlagToggle\n                label=\"Adaptive VAD\"\n                description=\"Automatically adjust silence detection based on user speech patterns\"\n                enabled={featureFlags.adaptiveVadEnabled}\n                onChange={(enabled) =>\n                  handleFeatureFlagChange(\"adaptiveVadEnabled\", enabled)\n                }\n                loading={savingFlags}\n              />\n              <FeatureFlagToggle\n                label=\"Barge-In Support\"\n                description=\"Allow users to interrupt AI responses by speaking\"\n                enabled={featureFlags.bargeInEnabled}\n                onChange={(enabled) =>\n                  handleFeatureFlagChange(\"bargeInEnabled\", enabled)\n                }\n                loading={savingFlags}\n              />\n            </div>\n          </div>\n\n          {/* TTS Features */}\n          <div className=\"bg-white rounded-lg shadow p-6\">\n            <h2 className=\"text-lg font-semibold text-neutral-900 mb-4\">\n              TTS Features\n            </h2>\n            <div className=\"divide-y divide-neutral-100\">\n              <FeatureFlagToggle\n                label=\"ElevenLabs Integration\"\n                description=\"Enable ElevenLabs as an alternative TTS provider\"\n                enabled={featureFlags.elevenlabsEnabled}\n                onChange={(enabled) =>\n                  handleFeatureFlagChange(\"elevenlabsEnabled\", enabled)\n                }\n                loading={savingFlags}\n              />\n              <FeatureFlagToggle\n                label=\"Streaming TTS\"\n                description=\"Stream audio chunks for lower latency playback\"\n                enabled={featureFlags.streamingTtsEnabled}\n                onChange={(enabled) =>\n                  handleFeatureFlagChange(\"streamingTtsEnabled\", enabled)\n                }\n                loading={savingFlags}\n              />\n            </div>\n          </div>\n\n          {/* Save Notice */}\n          <div className=\"bg-neutral-50 rounded-lg p-4 border border-neutral-200\">\n            <p className=\"text-sm text-neutral-600\">\n              Feature flag changes are saved automatically and take effect\n              immediately for new voice sessions. Existing sessions may need to\n              be restarted.\n            </p>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n\nexport default VoiceAdminPanel;\n"
}

{
  "path": "services/api-gateway/app/services/note_formatter_service.py",
  "language": "python",
  "size": 13986,
  "last_modified": "2025-12-04T12:32:40.271Z",
  "lines": 430,
  "content": "\"\"\"\nNote Formatter Service - LLM-Assisted Note Formatting\n\nPhase 8: Intelligent formatting of dictated medical notes.\n\nFeatures:\n- Grammar correction while preserving medical terminology\n- Auto-punctuation and capitalization\n- Medical abbreviation handling (expand or preserve)\n- Section-specific formatting (lists, headers)\n- Smart text cleanup (filler words, repetitions)\n\"\"\"\n\nimport re\nfrom dataclasses import dataclass\nfrom enum import Enum\nfrom typing import Dict, List, Optional, Tuple\n\nfrom app.core.logging import get_logger\n\nlogger = get_logger(__name__)\n\n\n# ==============================================================================\n# Enums and Configuration\n# ==============================================================================\n\n\nclass FormattingLevel(str, Enum):\n    \"\"\"Level of formatting to apply.\"\"\"\n\n    MINIMAL = \"minimal\"  # Just punctuation and capitalization\n    STANDARD = \"standard\"  # + Grammar correction\n    FULL = \"full\"  # + Medical abbreviation expansion, restructuring\n\n\n@dataclass\nclass FormattingConfig:\n    \"\"\"Configuration for note formatting.\"\"\"\n\n    level: FormattingLevel = FormattingLevel.STANDARD\n    expand_abbreviations: bool = True\n    preserve_medical_terms: bool = True\n    remove_filler_words: bool = True\n    auto_capitalize: bool = True\n    auto_punctuate: bool = True\n    format_numbers: bool = True\n    format_vitals: bool = True\n\n\n@dataclass\nclass FormattingResult:\n    \"\"\"Result of formatting operation.\"\"\"\n\n    original: str\n    formatted: str\n    changes_made: List[str]\n    abbreviations_expanded: Dict[str, str]\n    confidence: float\n\n\n# ==============================================================================\n# Medical Abbreviation Maps\n# ==============================================================================\n\n\n# Common medical abbreviations to expand\nMEDICAL_ABBREVIATIONS = {\n    # Vitals and measurements\n    \"bp\": \"blood pressure\",\n    \"hr\": \"heart rate\",\n    \"rr\": \"respiratory rate\",\n    \"temp\": \"temperature\",\n    \"spo2\": \"oxygen saturation\",\n    \"o2 sat\": \"oxygen saturation\",\n    \"bmi\": \"body mass index\",\n    # Diagnoses\n    \"dm\": \"diabetes mellitus\",\n    \"dm2\": \"type 2 diabetes mellitus\",\n    \"htn\": \"hypertension\",\n    \"chf\": \"congestive heart failure\",\n    \"cad\": \"coronary artery disease\",\n    \"copd\": \"chronic obstructive pulmonary disease\",\n    \"gerd\": \"gastroesophageal reflux disease\",\n    \"uti\": \"urinary tract infection\",\n    \"dvt\": \"deep vein thrombosis\",\n    \"pe\": \"pulmonary embolism\",\n    \"ckd\": \"chronic kidney disease\",\n    \"aki\": \"acute kidney injury\",\n    \"mi\": \"myocardial infarction\",\n    \"cva\": \"cerebrovascular accident\",\n    \"tia\": \"transient ischemic attack\",\n    # Anatomy\n    \"abd\": \"abdomen\",\n    \"cv\": \"cardiovascular\",\n    \"gi\": \"gastrointestinal\",\n    \"gu\": \"genitourinary\",\n    \"neuro\": \"neurological\",\n    \"msk\": \"musculoskeletal\",\n    \"heent\": \"head, eyes, ears, nose, and throat\",\n    \"ext\": \"extremities\",\n    \"resp\": \"respiratory\",\n    # Examinations\n    \"wnl\": \"within normal limits\",\n    \"nad\": \"no acute distress\",\n    \"aox3\": \"alert and oriented x3\",\n    \"aox4\": \"alert and oriented x4\",\n    \"rrr\": \"regular rate and rhythm\",\n    \"ctab\": \"clear to auscultation bilaterally\",\n    \"ntnd\": \"non-tender, non-distended\",\n    \"nka\": \"no known allergies\",\n    \"nkda\": \"no known drug allergies\",\n    # Timing\n    \"bid\": \"twice daily\",\n    \"tid\": \"three times daily\",\n    \"qid\": \"four times daily\",\n    \"qd\": \"once daily\",\n    \"prn\": \"as needed\",\n    \"po\": \"by mouth\",\n    \"iv\": \"intravenous\",\n    \"im\": \"intramuscular\",\n    \"subq\": \"subcutaneous\",\n    \"ac\": \"before meals\",\n    \"pc\": \"after meals\",\n    \"hs\": \"at bedtime\",\n    # Tests\n    \"cbc\": \"complete blood count\",\n    \"bmp\": \"basic metabolic panel\",\n    \"cmp\": \"comprehensive metabolic panel\",\n    \"lfts\": \"liver function tests\",\n    \"ua\": \"urinalysis\",\n    \"ekg\": \"electrocardiogram\",\n    \"ecg\": \"electrocardiogram\",\n    \"cxr\": \"chest x-ray\",\n    \"ct\": \"computed tomography\",\n    \"mri\": \"magnetic resonance imaging\",\n}\n\n# Abbreviations to preserve (don't expand)\nPRESERVE_ABBREVIATIONS = {\n    \"mg\",\n    \"mcg\",\n    \"g\",\n    \"kg\",\n    \"ml\",\n    \"l\",\n    \"dl\",  # Units\n    \"mmhg\",\n    \"bpm\",\n    \"rpm\",  # Measurement units\n    \"am\",\n    \"pm\",  # Time\n    \"dr\",\n    \"mr\",\n    \"ms\",\n    \"mrs\",  # Titles\n}\n\n# Common filler words to remove in medical dictation\nFILLER_WORDS = [\n    r\"\\buh+\\b\",\n    r\"\\bum+\\b\",\n    r\"\\ber+\\b\",\n    r\"\\bah+\\b\",\n    r\"\\bhmm+\\b\",\n    r\"\\blike,?\\s+you know\\b\",\n    r\"\\byou know\\b\",\n    r\"\\bbasically\\b\",\n    r\"\\bso+\\s+(?=,|\\.|$)\",  # trailing \"so\"\n    r\"\\band\\s+and\\b\",  # repeated \"and\"\n    r\"\\bthe\\s+the\\b\",  # repeated \"the\"\n]\n\n# Vital sign patterns for formatting\nVITAL_PATTERNS = [\n    # Blood pressure: \"120/80\" or \"blood pressure 120 over 80\"\n    (r\"\\b(\\d{2,3})\\s*(?:over|\\/)\\s*(\\d{2,3})\\b\", r\"BP \\1/\\2 mmHg\"),\n    # Heart rate: \"80 beats per minute\" or \"heart rate 80\"\n    (r\"\\bheart rate\\s*(?:of\\s*)?(\\d{2,3})\\b\", r\"HR \\1 bpm\"),\n    (r\"\\bpulse\\s*(?:of\\s*)?(\\d{2,3})\\b\", r\"Pulse \\1 bpm\"),\n    # Temperature: \"98.6 degrees\" or \"temp 98.6\"\n    (r\"\\btemperature?\\s*(?:of\\s*)?(\\d{2,3}(?:\\.\\d)?)\\s*(?:degrees?)?\\b\", r\"Temp \\1Â°F\"),\n    # O2 sat: \"98 percent\" or \"o2 sat 98\"\n    (\n        r\"\\b(?:o2|oxygen)\\s*(?:sat(?:uration)?)\\s*(?:of\\s*)?(\\d{2,3})\\s*(?:percent|%)?\\b\",\n        r\"SpO2 \\1%\",\n    ),\n    # Respiratory rate\n    (r\"\\brespiratory rate\\s*(?:of\\s*)?(\\d{1,2})\\b\", r\"RR \\1 rpm\"),\n]\n\n\n# ==============================================================================\n# Note Formatter Service\n# ==============================================================================\n\n\nclass NoteFormatterService:\n    \"\"\"\n    Service for formatting dictated medical notes.\n\n    Usage:\n        formatter = NoteFormatterService()\n\n        # Format text\n        result = formatter.format_text(\n            \"patient has htn and dm2 bp 140 over 90\",\n            config=FormattingConfig(level=FormattingLevel.FULL),\n        )\n        # Result: \"Patient has hypertension and type 2 diabetes mellitus. BP 140/90 mmHg.\"\n\n        # Quick format\n        formatted = formatter.quick_format(\"wnl for cv and resp exam\")\n        # Result: \"Within normal limits for cardiovascular and respiratory exam.\"\n    \"\"\"\n\n    def __init__(self):\n        self._abbreviation_map = MEDICAL_ABBREVIATIONS.copy()\n        self._preserve_abbrevs = PRESERVE_ABBREVIATIONS.copy()\n        self._filler_patterns = [re.compile(p, re.IGNORECASE) for p in FILLER_WORDS]\n        self._vital_patterns = [(re.compile(p, re.IGNORECASE), r) for p, r in VITAL_PATTERNS]\n\n    def format_text(\n        self,\n        text: str,\n        config: Optional[FormattingConfig] = None,\n    ) -> FormattingResult:\n        \"\"\"\n        Format dictated text with the specified configuration.\n\n        Args:\n            text: Raw dictated text\n            config: Formatting configuration\n\n        Returns:\n            FormattingResult with formatted text and metadata\n        \"\"\"\n        config = config or FormattingConfig()\n        original = text\n        changes_made = []\n        abbreviations_expanded = {}\n\n        # Step 1: Remove filler words\n        if config.remove_filler_words:\n            text, filler_count = self._remove_filler_words(text)\n            if filler_count > 0:\n                changes_made.append(f\"Removed {filler_count} filler words\")\n\n        # Step 2: Clean up spacing and repetitions\n        text = self._clean_whitespace(text)\n\n        # Step 3: Format vitals\n        if config.format_vitals:\n            text, vital_changes = self._format_vitals(text)\n            if vital_changes:\n                changes_made.extend(vital_changes)\n\n        # Step 4: Expand abbreviations\n        if config.expand_abbreviations:\n            text, expanded = self._expand_abbreviations(text)\n            abbreviations_expanded = expanded\n            if expanded:\n                changes_made.append(f\"Expanded {len(expanded)} abbreviations\")\n\n        # Step 5: Auto-punctuate\n        if config.auto_punctuate:\n            text, punct_added = self._auto_punctuate(text)\n            if punct_added:\n                changes_made.append(\"Added punctuation\")\n\n        # Step 6: Auto-capitalize\n        if config.auto_capitalize:\n            text = self._auto_capitalize(text)\n            changes_made.append(\"Applied capitalization\")\n\n        # Step 7: Format numbers\n        if config.format_numbers:\n            text = self._format_numbers(text)\n\n        # Calculate confidence based on changes\n        # More changes = lower confidence in original transcription\n        change_count = len(changes_made)\n        confidence = max(0.5, 1.0 - (change_count * 0.1))\n\n        return FormattingResult(\n            original=original,\n            formatted=text.strip(),\n            changes_made=changes_made,\n            abbreviations_expanded=abbreviations_expanded,\n            confidence=confidence,\n        )\n\n    def quick_format(self, text: str) -> str:\n        \"\"\"Quick formatting with default settings.\"\"\"\n        result = self.format_text(text)\n        return result.formatted\n\n    def _remove_filler_words(self, text: str) -> Tuple[str, int]:\n        \"\"\"Remove filler words from text.\"\"\"\n        count = 0\n        for pattern in self._filler_patterns:\n            text, n = pattern.subn(\"\", text)\n            count += n\n        return text, count\n\n    def _clean_whitespace(self, text: str) -> str:\n        \"\"\"Clean up whitespace and repetitions.\"\"\"\n        # Multiple spaces to single\n        text = re.sub(r\"\\s+\", \" \", text)\n        # Remove spaces before punctuation\n        text = re.sub(r\"\\s+([.,;:!?])\", r\"\\1\", text)\n        # Add space after punctuation if missing\n        text = re.sub(r\"([.,;:!?])([A-Za-z])\", r\"\\1 \\2\", text)\n        return text.strip()\n\n    def _format_vitals(self, text: str) -> Tuple[str, List[str]]:\n        \"\"\"Format vital sign patterns.\"\"\"\n        changes = []\n        for pattern, replacement in self._vital_patterns:\n            if pattern.search(text):\n                text = pattern.sub(replacement, text)\n                changes.append(f\"Formatted vital sign\")\n        return text, changes\n\n    def _expand_abbreviations(self, text: str) -> Tuple[str, Dict[str, str]]:\n        \"\"\"Expand medical abbreviations.\"\"\"\n        expanded = {}\n        words = text.split()\n        result_words = []\n\n        for word in words:\n            # Strip punctuation for matching\n            stripped = re.sub(r\"[.,;:!?]$\", \"\", word.lower())\n\n            if stripped in self._preserve_abbrevs:\n                result_words.append(word)\n            elif stripped in self._abbreviation_map:\n                expansion = self._abbreviation_map[stripped]\n                # Preserve any trailing punctuation\n                punctuation = word[len(stripped) :] if len(word) > len(stripped) else \"\"\n                result_words.append(expansion + punctuation)\n                expanded[stripped.upper()] = expansion\n            else:\n                result_words.append(word)\n\n        return \" \".join(result_words), expanded\n\n    def _auto_punctuate(self, text: str) -> Tuple[str, bool]:\n        \"\"\"Add punctuation to text.\"\"\"\n        added = False\n\n        # End sentence with period if missing\n        if text and not text.rstrip().endswith((\".\", \"!\", \"?\", \":\", \";\")):\n            text = text.rstrip() + \".\"\n            added = True\n\n        # Add periods after common sentence-ending patterns\n        sentence_enders = [\n            r\"(patient denies \\w+(?:\\s+\\w+)?)\\s+(?=[A-Z])\",\n            r\"(no (?:acute|significant) \\w+(?:\\s+\\w+)?)\\s+(?=[A-Z])\",\n            r\"(within normal limits)\\s+(?=[A-Z])\",\n        ]\n        for pattern in sentence_enders:\n            text, n = re.subn(pattern, r\"\\1. \", text, flags=re.IGNORECASE)\n            if n > 0:\n                added = True\n\n        return text, added\n\n    def _auto_capitalize(self, text: str) -> str:\n        \"\"\"Apply proper capitalization.\"\"\"\n        if not text:\n            return text\n\n        # Capitalize first letter\n        text = text[0].upper() + text[1:] if len(text) > 1 else text.upper()\n\n        # Capitalize after sentence-ending punctuation\n        text = re.sub(\n            r\"([.!?]\\s+)([a-z])\",\n            lambda m: m.group(1) + m.group(2).upper(),\n            text,\n        )\n\n        # Capitalize medical section headers\n        section_patterns = [\n            r\"\\b(subjective|objective|assessment|plan):\",\n            r\"\\b(chief complaint|history of present illness|past medical history):\",\n            r\"\\b(medications|allergies|social history|family history):\",\n            r\"\\b(review of systems|physical exam|labs):\",\n        ]\n        for pattern in section_patterns:\n            text = re.sub(\n                pattern,\n                lambda m: m.group(0).title(),\n                text,\n                flags=re.IGNORECASE,\n            )\n\n        return text\n\n    def _format_numbers(self, text: str) -> str:\n        \"\"\"Format numbers consistently.\"\"\"\n        # Format decimal numbers (e.g., \"98.6\")\n        text = re.sub(r\"\\b(\\d+)\\s*\\.\\s*(\\d+)\\b\", r\"\\1.\\2\", text)\n\n        # Format fractions written as words\n        text = re.sub(r\"\\b(\\d+)\\s+and\\s+a\\s+half\\b\", r\"\\1.5\", text, flags=re.IGNORECASE)\n        text = re.sub(r\"\\b(\\d+)\\s+and\\s+a\\s+quarter\\b\", r\"\\1.25\", text, flags=re.IGNORECASE)\n\n        return text\n\n    def add_abbreviation(self, abbrev: str, expansion: str) -> None:\n        \"\"\"Add a custom abbreviation mapping.\"\"\"\n        self._abbreviation_map[abbrev.lower()] = expansion\n        logger.info(f\"Added abbreviation: {abbrev} -> {expansion}\")\n\n    def add_preserve_abbreviation(self, abbrev: str) -> None:\n        \"\"\"Add an abbreviation to preserve (don't expand).\"\"\"\n        self._preserve_abbrevs.add(abbrev.lower())\n        logger.info(f\"Added preserve abbreviation: {abbrev}\")\n\n    def get_abbreviations(self) -> Dict[str, str]:\n        \"\"\"Get the current abbreviation map.\"\"\"\n        return self._abbreviation_map.copy()\n\n\n# Global service instance\nnote_formatter_service = NoteFormatterService()\n"
}

{
  "path": "services/api-gateway/app/services/tools/medical_tools.py",
  "language": "python",
  "size": 11565,
  "last_modified": "2025-12-04T11:27:01.008Z",
  "lines": 331,
  "content": "\"\"\"\nMedical Tools for VoiceAssist\n\nProvides access to medical calculators and risk assessment tools.\n\"\"\"\n\nimport logging\nfrom typing import Any, Dict\n\nfrom app.services.tools.tool_service import ToolExecutionContext, ToolResult\n\nlogger = logging.getLogger(__name__)\n\n\nasync def handle_medical_calculator(arguments: Dict[str, Any], context: ToolExecutionContext) -> ToolResult:\n    \"\"\"\n    Execute a medical calculator.\n\n    Available calculators:\n    - wells_dvt: Wells DVT Score\n    - wells_pe: Wells PE Score\n    - cha2ds2_vasc: CHA2DS2-VASc Score\n    - hasbled: HAS-BLED Score\n    - meld: MELD Score\n    - meld_na: MELD-Na Score\n    - child_pugh: Child-Pugh Score\n    - bmi: BMI Calculator\n    - bsa: Body Surface Area\n    - egfr: eGFR (CKD-EPI)\n    - creatinine_clearance: Creatinine Clearance (Cockcroft-Gault)\n    - corrected_calcium: Corrected Calcium\n    - anion_gap: Anion Gap\n    - map: Mean Arterial Pressure\n    - sofa: SOFA Score\n    - apache2: APACHE II Score\n    - curb65: CURB-65 Score\n\n    Args:\n        arguments: Contains 'calculator' name and 'inputs' dict\n        context: Execution context\n    \"\"\"\n    calculator_name = arguments.get(\"calculator\", \"\").lower()\n    inputs = arguments.get(\"inputs\", {})\n\n    if not calculator_name:\n        return ToolResult(\n            success=False,\n            data=None,\n            error=\"Calculator name is required\",\n            error_type=\"ValidationError\",\n        )\n\n    try:\n        from app.services.medical_calculators import MedicalCalculators\n\n        calc = MedicalCalculators()\n\n        # Map calculator names to functions\n        calculator_map = {\n            \"wells_dvt\": (\"wells_dvt_score\", _convert_wells_dvt_inputs),\n            \"wells_pe\": (\"wells_pe_score\", _convert_wells_pe_inputs),\n            \"cha2ds2_vasc\": (\"cha2ds2_vasc\", _convert_cha2ds2_inputs),\n            \"hasbled\": (\"hasbled_score\", _convert_hasbled_inputs),\n            \"meld\": (\"meld_score\", _convert_meld_inputs),\n            \"meld_na\": (\"meld_na_score\", _convert_meld_na_inputs),\n            \"child_pugh\": (\"child_pugh_score\", _convert_child_pugh_inputs),\n            \"bmi\": (\"bmi\", _convert_bmi_inputs),\n            \"bsa\": (\"bsa\", _convert_bsa_inputs),\n            \"egfr\": (\"egfr_ckd_epi\", _convert_egfr_inputs),\n            \"creatinine_clearance\": (\"creatinine_clearance\", _convert_crcl_inputs),\n            \"corrected_calcium\": (\"corrected_calcium\", _convert_calcium_inputs),\n            \"anion_gap\": (\"anion_gap\", _convert_anion_gap_inputs),\n            \"map\": (\"mean_arterial_pressure\", _convert_map_inputs),\n            \"sofa\": (\"sofa_score\", _convert_sofa_inputs),\n            \"curb65\": (\"curb65_score\", _convert_curb65_inputs),\n        }\n\n        if calculator_name not in calculator_map:\n            available = list(calculator_map.keys())\n            return ToolResult(\n                success=False,\n                data={\"available_calculators\": available},\n                error=f\"Unknown calculator: {calculator_name}. Available: {', '.join(available)}\",\n                error_type=\"ValidationError\",\n            )\n\n        method_name, input_converter = calculator_map[calculator_name]\n\n        # Convert inputs\n        try:\n            converted_inputs = input_converter(inputs)\n        except Exception as e:\n            return ToolResult(\n                success=False,\n                data=None,\n                error=f\"Invalid inputs: {str(e)}\",\n                error_type=\"ValidationError\",\n            )\n\n        # Get calculator method\n        calculator_method = getattr(calc, method_name, None)\n        if not calculator_method:\n            return ToolResult(\n                success=False,\n                data=None,\n                error=f\"Calculator method not found: {method_name}\",\n                error_type=\"InternalError\",\n            )\n\n        # Execute calculator\n        result = calculator_method(**converted_inputs)\n\n        return ToolResult(\n            success=True,\n            data={\n                \"calculator\": calculator_name,\n                \"inputs\": inputs,\n                \"score\": result.score,\n                \"interpretation\": result.interpretation,\n                \"risk_level\": result.risk_level.value if result.risk_level else None,\n                \"details\": result.details,\n                \"recommendations\": result.recommendations,\n                \"references\": result.references,\n            },\n            message=f\"{calculator_name.upper()}: {result.score} - {result.interpretation}\",\n        )\n\n    except Exception as e:\n        logger.exception(f\"Error in medical calculator: {e}\")\n        return ToolResult(\n            success=False,\n            data=None,\n            error=str(e),\n            error_type=type(e).__name__,\n        )\n\n\n# Input conversion functions for each calculator\n\n\ndef _convert_wells_dvt_inputs(inputs: Dict[str, Any]) -> Dict[str, Any]:\n    \"\"\"Convert Wells DVT inputs.\"\"\"\n    return {\n        \"active_cancer\": inputs.get(\"active_cancer\", False),\n        \"paralysis_paresis\": inputs.get(\"paralysis_paresis\", False),\n        \"bedridden_recent\": inputs.get(\"bedridden_recent\", False),\n        \"tenderness_dvt\": inputs.get(\"tenderness_dvt\", False),\n        \"entire_leg_swollen\": inputs.get(\"entire_leg_swollen\", False),\n        \"calf_swelling\": inputs.get(\"calf_swelling\", False),\n        \"pitting_edema\": inputs.get(\"pitting_edema\", False),\n        \"collateral_veins\": inputs.get(\"collateral_veins\", False),\n        \"previous_dvt\": inputs.get(\"previous_dvt\", False),\n        \"alternative_diagnosis\": inputs.get(\"alternative_diagnosis\", False),\n    }\n\n\ndef _convert_wells_pe_inputs(inputs: Dict[str, Any]) -> Dict[str, Any]:\n    \"\"\"Convert Wells PE inputs.\"\"\"\n    return {\n        \"clinical_dvt\": inputs.get(\"clinical_dvt\", False),\n        \"alternative_diagnosis\": inputs.get(\"alternative_diagnosis\", False),\n        \"heart_rate_gt_100\": inputs.get(\"heart_rate_gt_100\", False),\n        \"immobilization_surgery\": inputs.get(\"immobilization_surgery\", False),\n        \"previous_pe_dvt\": inputs.get(\"previous_pe_dvt\", False),\n        \"hemoptysis\": inputs.get(\"hemoptysis\", False),\n        \"malignancy\": inputs.get(\"malignancy\", False),\n    }\n\n\ndef _convert_cha2ds2_inputs(inputs: Dict[str, Any]) -> Dict[str, Any]:\n    \"\"\"Convert CHA2DS2-VASc inputs.\"\"\"\n    from app.services.medical_calculators import Sex\n\n    sex_str = inputs.get(\"sex\", \"male\").lower()\n    sex = Sex.FEMALE if sex_str in [\"female\", \"f\"] else Sex.MALE\n\n    return {\n        \"age\": inputs.get(\"age\", 65),\n        \"sex\": sex,\n        \"chf\": inputs.get(\"chf\", False),\n        \"hypertension\": inputs.get(\"hypertension\", False),\n        \"stroke_tia\": inputs.get(\"stroke_tia\", False),\n        \"vascular_disease\": inputs.get(\"vascular_disease\", False),\n        \"diabetes\": inputs.get(\"diabetes\", False),\n    }\n\n\ndef _convert_hasbled_inputs(inputs: Dict[str, Any]) -> Dict[str, Any]:\n    \"\"\"Convert HAS-BLED inputs.\"\"\"\n    return {\n        \"hypertension\": inputs.get(\"hypertension\", False),\n        \"renal_disease\": inputs.get(\"renal_disease\", False),\n        \"liver_disease\": inputs.get(\"liver_disease\", False),\n        \"stroke_history\": inputs.get(\"stroke_history\", False),\n        \"bleeding_history\": inputs.get(\"bleeding_history\", False),\n        \"labile_inr\": inputs.get(\"labile_inr\", False),\n        \"elderly\": inputs.get(\"elderly\", False),\n        \"drugs\": inputs.get(\"drugs\", False),\n        \"alcohol\": inputs.get(\"alcohol\", False),\n    }\n\n\ndef _convert_meld_inputs(inputs: Dict[str, Any]) -> Dict[str, Any]:\n    \"\"\"Convert MELD inputs.\"\"\"\n    return {\n        \"bilirubin\": inputs.get(\"bilirubin\", 1.0),\n        \"inr\": inputs.get(\"inr\", 1.0),\n        \"creatinine\": inputs.get(\"creatinine\", 1.0),\n        \"dialysis\": inputs.get(\"dialysis\", False),\n    }\n\n\ndef _convert_meld_na_inputs(inputs: Dict[str, Any]) -> Dict[str, Any]:\n    \"\"\"Convert MELD-Na inputs.\"\"\"\n    return {\n        \"bilirubin\": inputs.get(\"bilirubin\", 1.0),\n        \"inr\": inputs.get(\"inr\", 1.0),\n        \"creatinine\": inputs.get(\"creatinine\", 1.0),\n        \"sodium\": inputs.get(\"sodium\", 140),\n        \"dialysis\": inputs.get(\"dialysis\", False),\n    }\n\n\ndef _convert_child_pugh_inputs(inputs: Dict[str, Any]) -> Dict[str, Any]:\n    \"\"\"Convert Child-Pugh inputs.\"\"\"\n    return {\n        \"bilirubin\": inputs.get(\"bilirubin\", 1.0),\n        \"albumin\": inputs.get(\"albumin\", 3.5),\n        \"inr\": inputs.get(\"inr\", 1.0),\n        \"ascites\": inputs.get(\"ascites\", \"none\"),\n        \"encephalopathy\": inputs.get(\"encephalopathy\", \"none\"),\n    }\n\n\ndef _convert_bmi_inputs(inputs: Dict[str, Any]) -> Dict[str, Any]:\n    \"\"\"Convert BMI inputs.\"\"\"\n    return {\n        \"weight_kg\": inputs.get(\"weight_kg\") or inputs.get(\"weight\"),\n        \"height_cm\": inputs.get(\"height_cm\") or inputs.get(\"height\"),\n    }\n\n\ndef _convert_bsa_inputs(inputs: Dict[str, Any]) -> Dict[str, Any]:\n    \"\"\"Convert BSA inputs.\"\"\"\n    return {\n        \"weight_kg\": inputs.get(\"weight_kg\") or inputs.get(\"weight\"),\n        \"height_cm\": inputs.get(\"height_cm\") or inputs.get(\"height\"),\n    }\n\n\ndef _convert_egfr_inputs(inputs: Dict[str, Any]) -> Dict[str, Any]:\n    \"\"\"Convert eGFR inputs.\"\"\"\n    from app.services.medical_calculators import Sex\n\n    sex_str = inputs.get(\"sex\", \"male\").lower()\n    sex = Sex.FEMALE if sex_str in [\"female\", \"f\"] else Sex.MALE\n\n    return {\n        \"creatinine\": inputs.get(\"creatinine\"),\n        \"age\": inputs.get(\"age\"),\n        \"sex\": sex,\n        \"race_black\": inputs.get(\"race_black\", False),\n    }\n\n\ndef _convert_crcl_inputs(inputs: Dict[str, Any]) -> Dict[str, Any]:\n    \"\"\"Convert Creatinine Clearance inputs.\"\"\"\n    from app.services.medical_calculators import Sex\n\n    sex_str = inputs.get(\"sex\", \"male\").lower()\n    sex = Sex.FEMALE if sex_str in [\"female\", \"f\"] else Sex.MALE\n\n    return {\n        \"creatinine\": inputs.get(\"creatinine\"),\n        \"age\": inputs.get(\"age\"),\n        \"weight_kg\": inputs.get(\"weight_kg\") or inputs.get(\"weight\"),\n        \"sex\": sex,\n    }\n\n\ndef _convert_calcium_inputs(inputs: Dict[str, Any]) -> Dict[str, Any]:\n    \"\"\"Convert Corrected Calcium inputs.\"\"\"\n    return {\n        \"calcium\": inputs.get(\"calcium\"),\n        \"albumin\": inputs.get(\"albumin\"),\n    }\n\n\ndef _convert_anion_gap_inputs(inputs: Dict[str, Any]) -> Dict[str, Any]:\n    \"\"\"Convert Anion Gap inputs.\"\"\"\n    return {\n        \"sodium\": inputs.get(\"sodium\"),\n        \"chloride\": inputs.get(\"chloride\"),\n        \"bicarbonate\": inputs.get(\"bicarbonate\"),\n        \"albumin\": inputs.get(\"albumin\"),\n    }\n\n\ndef _convert_map_inputs(inputs: Dict[str, Any]) -> Dict[str, Any]:\n    \"\"\"Convert MAP inputs.\"\"\"\n    return {\n        \"systolic\": inputs.get(\"systolic\"),\n        \"diastolic\": inputs.get(\"diastolic\"),\n    }\n\n\ndef _convert_sofa_inputs(inputs: Dict[str, Any]) -> Dict[str, Any]:\n    \"\"\"Convert SOFA inputs.\"\"\"\n    return {\n        \"pao2_fio2\": inputs.get(\"pao2_fio2\"),\n        \"platelets\": inputs.get(\"platelets\"),\n        \"bilirubin\": inputs.get(\"bilirubin\"),\n        \"map\": inputs.get(\"map\"),\n        \"vasopressor\": inputs.get(\"vasopressor\", \"none\"),\n        \"gcs\": inputs.get(\"gcs\"),\n        \"creatinine\": inputs.get(\"creatinine\"),\n        \"urine_output\": inputs.get(\"urine_output\"),\n    }\n\n\ndef _convert_curb65_inputs(inputs: Dict[str, Any]) -> Dict[str, Any]:\n    \"\"\"Convert CURB-65 inputs.\"\"\"\n    return {\n        \"confusion\": inputs.get(\"confusion\", False),\n        \"bun\": inputs.get(\"bun\"),\n        \"respiratory_rate\": inputs.get(\"respiratory_rate\"),\n        \"bp_systolic\": inputs.get(\"bp_systolic\"),\n        \"bp_diastolic\": inputs.get(\"bp_diastolic\"),\n        \"age\": inputs.get(\"age\"),\n    }\n"
}

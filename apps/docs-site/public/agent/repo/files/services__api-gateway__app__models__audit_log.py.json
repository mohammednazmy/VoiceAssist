{
  "path": "services/api-gateway/app/models/audit_log.py",
  "language": "python",
  "size": 3018,
  "last_modified": "2025-12-04T11:26:53.999Z",
  "lines": 86,
  "content": "\"\"\"\nAudit log model for tracking user actions and system events.\n\nRequired for HIPAA compliance - all access to PHI must be logged.\n\"\"\"\n\nimport hashlib\nimport uuid\n\nfrom app.core.database import Base\nfrom sqlalchemy import JSON, UUID, Boolean, Column, DateTime, String\nfrom sqlalchemy.sql import func\n\n\nclass AuditLog(Base):\n    \"\"\"\n    Audit log entry for tracking user actions and system events.\n\n    Includes integrity verification via hash to detect tampering.\n    Immutable - should never be updated or deleted.\n    \"\"\"\n\n    __tablename__ = \"audit_logs\"\n\n    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)\n    timestamp = Column(DateTime(timezone=True), nullable=False, default=func.now(), index=True)\n\n    # Who performed the action\n    user_id = Column(UUID(as_uuid=True), nullable=True, index=True)  # Null for system actions\n    user_email = Column(String(255), nullable=True)\n    user_role = Column(String(50), nullable=True)\n\n    # What action was performed\n    action = Column(String(100), nullable=False, index=True)  # login, logout, create_user, etc.\n    resource_type = Column(String(100), nullable=True)  # user, session, message, document, etc.\n    resource_id = Column(String(255), nullable=True)\n\n    # Request context\n    request_id = Column(String(100), nullable=True, index=True)  # Correlation ID\n    ip_address = Column(String(45), nullable=True)  # IPv4 or IPv6\n    user_agent = Column(String(500), nullable=True)\n\n    # Service context\n    service_name = Column(String(100), nullable=False, default=\"api-gateway\")\n    endpoint = Column(String(255), nullable=True)  # API endpoint called\n\n    # Result\n    success = Column(Boolean, nullable=False)\n    status_code = Column(String(10), nullable=True)  # HTTP status code\n    error_message = Column(String(1000), nullable=True)\n\n    # Additional context (JSON)\n    additional_data = Column(JSON, nullable=True)\n\n    # Integrity verification\n    hash = Column(String(64), nullable=False)  # SHA-256 hash for tamper detection\n\n    def calculate_hash(self) -> str:\n        \"\"\"\n        Calculate SHA-256 hash of critical fields for integrity verification.\n\n        This allows detection of unauthorized modifications to audit logs.\n        \"\"\"\n        # Use only immutable fields that won't change\n        data = f\"{self.timestamp}{self.user_id}{self.action}{self.resource_type}{self.resource_id}{self.success}\"\n        return hashlib.sha256(data.encode()).hexdigest()\n\n    def verify_integrity(self) -> bool:\n        \"\"\"\n        Verify that the audit log has not been tampered with.\n\n        Returns:\n            True if hash matches, False if log has been modified.\n        \"\"\"\n        expected_hash = self.calculate_hash()\n        return self.hash == expected_hash\n\n    def __repr__(self):\n        return (\n            f\"<AuditLog(id={self.id}, \"\n            f\"user={self.user_email}, \"\n            f\"action={self.action}, \"\n            f\"resource={self.resource_type}, \"\n            f\"success={self.success})>\"\n        )\n"
}

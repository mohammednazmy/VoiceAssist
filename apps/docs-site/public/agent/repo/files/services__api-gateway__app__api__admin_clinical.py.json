{
  "path": "services/api-gateway/app/api/admin_clinical.py",
  "language": "python",
  "size": 23264,
  "last_modified": "2025-12-04T11:26:45.217Z",
  "lines": 703,
  "content": "\"\"\"Admin Clinical Context API endpoints.\n\nProvides comprehensive clinical context management for the Admin Panel:\n- List all clinical contexts with PHI masking options\n- View individual context details with audit trail\n- PHI access audit log for HIPAA compliance\n- Clinical context statistics and analytics\n\nHIPAA Compliance: All access to clinical contexts is audit logged.\nPHI data is masked by default unless explicitly unmasked with audit trail.\n\"\"\"\n\nfrom __future__ import annotations\n\nimport logging\nfrom datetime import datetime, timedelta, timezone\nfrom typing import Any, Dict, List, Optional\nfrom uuid import UUID\n\nfrom app.core.api_envelope import error_response, success_response\nfrom app.core.database import get_db\nfrom app.core.dependencies import get_current_admin_user\nfrom app.models.audit_log import AuditLog\nfrom app.models.clinical_context import ClinicalContext\nfrom app.models.user import User\nfrom app.services.audit_service import AuditService\nfrom fastapi import APIRouter, Depends, Query, Request\nfrom pydantic import BaseModel\nfrom sqlalchemy import desc, func\nfrom sqlalchemy.orm import Session\n\nlogger = logging.getLogger(__name__)\n\nrouter = APIRouter(prefix=\"/api/admin/clinical\", tags=[\"admin\", \"clinical\"])\n\n\n# ============================================================================\n# Pydantic Models\n# ============================================================================\n\n\nclass ClinicalContextSummary(BaseModel):\n    \"\"\"Summary of a clinical context for list view (PHI masked by default).\"\"\"\n\n    id: str\n    user_id: str\n    user_email: Optional[str] = None\n    session_id: Optional[str] = None\n    has_demographics: bool = False\n    has_chief_complaint: bool = False\n    has_problems: bool = False\n    has_medications: bool = False\n    has_allergies: bool = False\n    has_vitals: bool = False\n    last_updated: str\n    created_at: str\n\n\nclass ClinicalContextDetail(BaseModel):\n    \"\"\"Detailed clinical context (PHI included when authorized).\"\"\"\n\n    id: str\n    user_id: str\n    user_email: Optional[str] = None\n    session_id: Optional[str] = None\n\n    # Demographics (masked or actual)\n    age: Optional[int] = None\n    gender: Optional[str] = None\n    weight_kg: Optional[float] = None\n    height_cm: Optional[float] = None\n\n    # Clinical data (masked or actual)\n    chief_complaint: Optional[str] = None\n    problems: List[str] = []\n    medications: List[str] = []\n    allergies: List[str] = []\n    vitals: dict = {}\n\n    # Metadata\n    last_updated: str\n    created_at: str\n\n    # Audit info\n    access_logged: bool = True\n    phi_masked: bool = True\n\n\nclass ClinicalContextStats(BaseModel):\n    \"\"\"Clinical context statistics.\"\"\"\n\n    total_contexts: int = 0\n    contexts_with_demographics: int = 0\n    contexts_with_chief_complaint: int = 0\n    contexts_with_problems: int = 0\n    contexts_with_medications: int = 0\n    contexts_with_allergies: int = 0\n    contexts_with_vitals: int = 0\n    active_today: int = 0\n    active_this_week: int = 0\n    by_day: List[Dict[str, Any]] = []\n\n\nclass ClinicalAuditEntry(BaseModel):\n    \"\"\"PHI access audit log entry.\"\"\"\n\n    id: str\n    timestamp: str\n    admin_email: Optional[str] = None\n    action: str\n    resource_id: Optional[str] = None\n    phi_accessed: bool = False\n    ip_address: Optional[str] = None\n    details: Dict[str, Any] = {}\n\n\n# ============================================================================\n# Helper Functions\n# ============================================================================\n\n\ndef mask_phi_value(value: Any, phi_type: str = \"text\") -> Any:\n    \"\"\"Mask PHI value for display.\"\"\"\n    if value is None:\n        return None\n\n    if phi_type == \"text\" and isinstance(value, str):\n        if len(value) <= 4:\n            return \"***\"\n        return value[:2] + \"***\" + value[-2:]\n\n    if phi_type == \"number\":\n        return \"***\"\n\n    if phi_type == \"list\" and isinstance(value, list):\n        return [f\"[{i + 1}] ***\" for i in range(len(value))]\n\n    if phi_type == \"dict\" and isinstance(value, dict):\n        return {k: \"***\" for k in value.keys()}\n\n    return \"***\"\n\n\ndef context_to_summary(context: ClinicalContext, user: Optional[User] = None) -> ClinicalContextSummary:\n    \"\"\"Convert clinical context to summary (no PHI exposed).\"\"\"\n    return ClinicalContextSummary(\n        id=str(context.id),\n        user_id=str(context.user_id),\n        user_email=user.email if user else None,\n        session_id=str(context.session_id) if context.session_id else None,\n        has_demographics=bool(context.age or context.gender or context.weight_kg or context.height_cm),\n        has_chief_complaint=bool(context.chief_complaint),\n        has_problems=bool(context.problems and len(context.problems) > 0),\n        has_medications=bool(context.medications and len(context.medications) > 0),\n        has_allergies=bool(context.allergies and len(context.allergies) > 0),\n        has_vitals=bool(context.vitals and len(context.vitals) > 0),\n        last_updated=context.last_updated.isoformat() if context.last_updated else \"\",\n        created_at=context.created_at.isoformat() if context.created_at else \"\",\n    )\n\n\ndef context_to_detail(\n    context: ClinicalContext,\n    user: Optional[User] = None,\n    mask_phi: bool = True,\n) -> ClinicalContextDetail:\n    \"\"\"Convert clinical context to detail view with optional PHI masking.\"\"\"\n    if mask_phi:\n        return ClinicalContextDetail(\n            id=str(context.id),\n            user_id=str(context.user_id),\n            user_email=user.email if user else None,\n            session_id=str(context.session_id) if context.session_id else None,\n            age=mask_phi_value(context.age, \"number\") if context.age else None,\n            gender=mask_phi_value(context.gender) if context.gender else None,\n            weight_kg=(mask_phi_value(context.weight_kg, \"number\") if context.weight_kg else None),\n            height_cm=(mask_phi_value(context.height_cm, \"number\") if context.height_cm else None),\n            chief_complaint=(mask_phi_value(context.chief_complaint) if context.chief_complaint else None),\n            problems=mask_phi_value(context.problems or [], \"list\"),\n            medications=mask_phi_value(context.medications or [], \"list\"),\n            allergies=mask_phi_value(context.allergies or [], \"list\"),\n            vitals=mask_phi_value(context.vitals or {}, \"dict\"),\n            last_updated=(context.last_updated.isoformat() if context.last_updated else \"\"),\n            created_at=context.created_at.isoformat() if context.created_at else \"\",\n            phi_masked=True,\n        )\n    else:\n        return ClinicalContextDetail(\n            id=str(context.id),\n            user_id=str(context.user_id),\n            user_email=user.email if user else None,\n            session_id=str(context.session_id) if context.session_id else None,\n            age=context.age,\n            gender=context.gender,\n            weight_kg=float(context.weight_kg) if context.weight_kg else None,\n            height_cm=float(context.height_cm) if context.height_cm else None,\n            chief_complaint=context.chief_complaint,\n            problems=context.problems or [],\n            medications=context.medications or [],\n            allergies=context.allergies or [],\n            vitals=context.vitals or {},\n            last_updated=(context.last_updated.isoformat() if context.last_updated else \"\"),\n            created_at=context.created_at.isoformat() if context.created_at else \"\",\n            phi_masked=False,\n        )\n\n\nasync def log_clinical_access(\n    db: Session,\n    admin_user: User,\n    action: str,\n    resource_id: Optional[str] = None,\n    phi_accessed: bool = False,\n    request: Optional[Request] = None,\n    details: Optional[Dict] = None,\n) -> None:\n    \"\"\"Log clinical context access for HIPAA compliance.\"\"\"\n    try:\n        await AuditService.log_event(\n            db=db,\n            action=f\"clinical_{action}\",\n            success=True,\n            user=admin_user,\n            resource_type=\"clinical_context\",\n            resource_id=resource_id,\n            request=request,\n            metadata={\n                \"phi_accessed\": phi_accessed,\n                **(details or {}),\n            },\n        )\n    except Exception as e:\n        logger.error(f\"Failed to log clinical access: {e}\")\n\n\n# ============================================================================\n# Endpoints\n# ============================================================================\n\n\n@router.get(\"/contexts\")\nasync def list_clinical_contexts(\n    limit: int = Query(50, ge=1, le=200),\n    offset: int = Query(0, ge=0),\n    user_id: Optional[str] = Query(None, description=\"Filter by user ID\"),\n    has_chief_complaint: Optional[bool] = Query(None, description=\"Filter by chief complaint presence\"),\n    updated_since: Optional[str] = Query(None, description=\"Filter by last updated date (ISO format)\"),\n    admin_user: User = Depends(get_current_admin_user),\n    db: Session = Depends(get_db),\n    request: Request = None,\n) -> Dict[str, Any]:\n    \"\"\"List all clinical contexts with PHI masked.\n\n    Returns summary information about clinical contexts without exposing PHI.\n    Use the detail endpoint with explicit PHI access to view full data.\n    \"\"\"\n    try:\n        query = db.query(ClinicalContext)\n\n        # Apply filters\n        if user_id:\n            try:\n                query = query.filter(ClinicalContext.user_id == UUID(user_id))\n            except ValueError:\n                return error_response(\n                    code=\"INVALID_USER_ID\",\n                    message=\"Invalid user ID format\",\n                    status_code=400,\n                )\n\n        if has_chief_complaint is not None:\n            if has_chief_complaint:\n                query = query.filter(ClinicalContext.chief_complaint.isnot(None))\n            else:\n                query = query.filter(ClinicalContext.chief_complaint.is_(None))\n\n        if updated_since:\n            try:\n                since_date = datetime.fromisoformat(updated_since.replace(\"Z\", \"+00:00\"))\n                query = query.filter(ClinicalContext.last_updated >= since_date)\n            except ValueError:\n                return error_response(\n                    code=\"INVALID_DATE\",\n                    message=\"Invalid date format. Use ISO format.\",\n                    status_code=400,\n                )\n\n        # Get total count\n        total = query.count()\n\n        # Get paginated results with user info\n        contexts = query.order_by(desc(ClinicalContext.last_updated)).offset(offset).limit(limit).all()\n\n        # Get user info for each context\n        user_ids = [c.user_id for c in contexts]\n        users = {str(u.id): u for u in db.query(User).filter(User.id.in_(user_ids)).all()}\n\n        # Convert to summaries\n        summaries = [context_to_summary(c, users.get(str(c.user_id))).model_dump() for c in contexts]\n\n        # Log access\n        await log_clinical_access(\n            db=db,\n            admin_user=admin_user,\n            action=\"list\",\n            request=request,\n            details={\"count\": len(summaries), \"filters\": {\"user_id\": user_id}},\n        )\n\n        return success_response(\n            data={\n                \"contexts\": summaries,\n                \"total\": total,\n                \"limit\": limit,\n                \"offset\": offset,\n            }\n        )\n\n    except Exception as e:\n        logger.error(f\"Failed to list clinical contexts: {e}\")\n        return error_response(\n            code=\"LIST_ERROR\",\n            message=\"Failed to list clinical contexts\",\n            status_code=500,\n        )\n\n\n@router.get(\"/contexts/{context_id}\")\nasync def get_clinical_context(\n    context_id: str,\n    include_phi: bool = Query(False, description=\"Include PHI data (logged for audit)\"),\n    admin_user: User = Depends(get_current_admin_user),\n    db: Session = Depends(get_db),\n    request: Request = None,\n) -> Dict[str, Any]:\n    \"\"\"Get details of a specific clinical context.\n\n    By default, PHI is masked. Set include_phi=true to view actual PHI values.\n    All PHI access is logged for HIPAA compliance.\n    \"\"\"\n    try:\n        context_uuid = UUID(context_id)\n    except ValueError:\n        return error_response(\n            code=\"INVALID_ID\",\n            message=\"Invalid context ID format\",\n            status_code=400,\n        )\n\n    context = db.query(ClinicalContext).filter(ClinicalContext.id == context_uuid).first()\n\n    if not context:\n        return error_response(\n            code=\"NOT_FOUND\",\n            message=\"Clinical context not found\",\n            status_code=404,\n        )\n\n    # Get user info\n    user = db.query(User).filter(User.id == context.user_id).first()\n\n    # Convert to detail view\n    detail = context_to_detail(context, user, mask_phi=not include_phi)\n\n    # Log access (PHI access is specifically noted)\n    await log_clinical_access(\n        db=db,\n        admin_user=admin_user,\n        action=\"view\",\n        resource_id=context_id,\n        phi_accessed=include_phi,\n        request=request,\n        details={\"phi_requested\": include_phi},\n    )\n\n    # Get access history for this context\n    access_history = (\n        db.query(AuditLog)\n        .filter(\n            AuditLog.action.like(\"clinical_%\"),\n            AuditLog.resource_id == context_id,\n        )\n        .order_by(desc(AuditLog.timestamp))\n        .limit(10)\n        .all()\n    )\n\n    history_entries = [\n        {\n            \"timestamp\": log.timestamp.isoformat() if log.timestamp else \"\",\n            \"admin_email\": log.user_email,\n            \"action\": log.action,\n            \"phi_accessed\": (log.additional_data or {}).get(\"phi_accessed\", False),\n        }\n        for log in access_history\n    ]\n\n    return success_response(\n        data={\n            \"context\": detail.model_dump(),\n            \"access_history\": history_entries,\n        }\n    )\n\n\n@router.get(\"/audit\")\nasync def get_clinical_audit_log(\n    limit: int = Query(100, ge=1, le=500),\n    offset: int = Query(0, ge=0),\n    phi_only: bool = Query(False, description=\"Only show PHI access events\"),\n    admin_id: Optional[str] = Query(None, description=\"Filter by admin user ID\"),\n    since: Optional[str] = Query(None, description=\"Filter by date (ISO format)\"),\n    admin_user: User = Depends(get_current_admin_user),\n    db: Session = Depends(get_db),\n) -> Dict[str, Any]:\n    \"\"\"Get clinical context PHI access audit log.\n\n    Returns all admin access to clinical contexts for HIPAA compliance reporting.\n    \"\"\"\n    try:\n        query = db.query(AuditLog).filter(AuditLog.action.like(\"clinical_%\"))\n\n        # Apply filters\n        if phi_only:\n            # Filter for PHI access using JSON query\n            query = query.filter(func.json_extract(AuditLog.additional_data, \"$.phi_accessed\") == True)  # noqa: E712\n\n        if admin_id:\n            try:\n                query = query.filter(AuditLog.user_id == admin_id)\n            except ValueError:\n                pass\n\n        if since:\n            try:\n                since_date = datetime.fromisoformat(since.replace(\"Z\", \"+00:00\"))\n                query = query.filter(AuditLog.timestamp >= since_date)\n            except ValueError:\n                return error_response(\n                    code=\"INVALID_DATE\",\n                    message=\"Invalid date format. Use ISO format.\",\n                    status_code=400,\n                )\n\n        total = query.count()\n\n        logs = query.order_by(desc(AuditLog.timestamp)).offset(offset).limit(limit).all()\n\n        entries = [\n            ClinicalAuditEntry(\n                id=str(log.id),\n                timestamp=log.timestamp.isoformat() if log.timestamp else \"\",\n                admin_email=log.user_email,\n                action=log.action,\n                resource_id=log.resource_id,\n                phi_accessed=(log.additional_data or {}).get(\"phi_accessed\", False),\n                ip_address=log.ip_address,\n                details=log.additional_data or {},\n            ).model_dump()\n            for log in logs\n        ]\n\n        return success_response(\n            data={\n                \"audit_entries\": entries,\n                \"total\": total,\n                \"limit\": limit,\n                \"offset\": offset,\n            }\n        )\n\n    except Exception as e:\n        logger.error(f\"Failed to get clinical audit log: {e}\")\n        return error_response(\n            code=\"AUDIT_ERROR\",\n            message=\"Failed to retrieve audit log\",\n            status_code=500,\n        )\n\n\n@router.get(\"/stats\")\nasync def get_clinical_stats(\n    days: int = Query(7, ge=1, le=90),\n    admin_user: User = Depends(get_current_admin_user),\n    db: Session = Depends(get_db),\n) -> Dict[str, Any]:\n    \"\"\"Get clinical context statistics and analytics.\n\n    Returns aggregate statistics without exposing any PHI.\n    \"\"\"\n    try:\n        stats = ClinicalContextStats()\n\n        # Total counts\n        stats.total_contexts = db.query(ClinicalContext).count()\n\n        stats.contexts_with_demographics = (\n            db.query(ClinicalContext)\n            .filter(\n                (ClinicalContext.age.isnot(None))\n                | (ClinicalContext.gender.isnot(None))\n                | (ClinicalContext.weight_kg.isnot(None))\n                | (ClinicalContext.height_cm.isnot(None))\n            )\n            .count()\n        )\n\n        stats.contexts_with_chief_complaint = (\n            db.query(ClinicalContext).filter(ClinicalContext.chief_complaint.isnot(None)).count()\n        )\n\n        # For JSONB fields, check for non-empty arrays\n        stats.contexts_with_problems = (\n            db.query(ClinicalContext)\n            .filter(\n                ClinicalContext.problems.isnot(None),\n                func.jsonb_array_length(ClinicalContext.problems) > 0,\n            )\n            .count()\n        )\n\n        stats.contexts_with_medications = (\n            db.query(ClinicalContext)\n            .filter(\n                ClinicalContext.medications.isnot(None),\n                func.jsonb_array_length(ClinicalContext.medications) > 0,\n            )\n            .count()\n        )\n\n        stats.contexts_with_allergies = (\n            db.query(ClinicalContext)\n            .filter(\n                ClinicalContext.allergies.isnot(None),\n                func.jsonb_array_length(ClinicalContext.allergies) > 0,\n            )\n            .count()\n        )\n\n        stats.contexts_with_vitals = db.query(ClinicalContext).filter(ClinicalContext.vitals.isnot(None)).count()\n\n        # Activity stats\n        today = datetime.now(timezone.utc).replace(hour=0, minute=0, second=0, microsecond=0)\n        week_ago = today - timedelta(days=7)\n\n        stats.active_today = db.query(ClinicalContext).filter(ClinicalContext.last_updated >= today).count()\n\n        stats.active_this_week = db.query(ClinicalContext).filter(ClinicalContext.last_updated >= week_ago).count()\n\n        # Daily breakdown\n        for i in range(days):\n            day_start = today - timedelta(days=i)\n            day_end = day_start + timedelta(days=1)\n\n            count = (\n                db.query(ClinicalContext)\n                .filter(\n                    ClinicalContext.last_updated >= day_start,\n                    ClinicalContext.last_updated < day_end,\n                )\n                .count()\n            )\n\n            stats.by_day.append(\n                {\n                    \"date\": day_start.strftime(\"%Y-%m-%d\"),\n                    \"count\": count,\n                }\n            )\n\n        # Sort chronologically\n        stats.by_day.sort(key=lambda x: x[\"date\"])\n\n        return success_response(data=stats.model_dump())\n\n    except Exception as e:\n        logger.error(f\"Failed to get clinical stats: {e}\")\n        return error_response(\n            code=\"STATS_ERROR\",\n            message=\"Failed to retrieve statistics\",\n            status_code=500,\n        )\n\n\n@router.delete(\"/contexts/{context_id}\")\nasync def delete_clinical_context(\n    context_id: str,\n    admin_user: User = Depends(get_current_admin_user),\n    db: Session = Depends(get_db),\n    request: Request = None,\n) -> Dict[str, Any]:\n    \"\"\"Delete a clinical context.\n\n    This action is logged and should only be used for data cleanup or user requests.\n    \"\"\"\n    try:\n        context_uuid = UUID(context_id)\n    except ValueError:\n        return error_response(\n            code=\"INVALID_ID\",\n            message=\"Invalid context ID format\",\n            status_code=400,\n        )\n\n    context = db.query(ClinicalContext).filter(ClinicalContext.id == context_uuid).first()\n\n    if not context:\n        return error_response(\n            code=\"NOT_FOUND\",\n            message=\"Clinical context not found\",\n            status_code=404,\n        )\n\n    user_id = str(context.user_id)\n\n    # Delete the context\n    db.delete(context)\n    db.commit()\n\n    # Log the deletion\n    await log_clinical_access(\n        db=db,\n        admin_user=admin_user,\n        action=\"delete\",\n        resource_id=context_id,\n        phi_accessed=False,  # Deletion doesn't access PHI content\n        request=request,\n        details={\"user_id\": user_id},\n    )\n\n    logger.info(f\"Clinical context {context_id} deleted by admin {admin_user.email}\")\n\n    return success_response(\n        data={\"deleted\": True, \"context_id\": context_id},\n        message=\"Clinical context deleted successfully\",\n    )\n\n\n@router.get(\"/users/{user_id}/contexts\")\nasync def get_user_clinical_contexts(\n    user_id: str,\n    include_phi: bool = Query(False, description=\"Include PHI data (logged for audit)\"),\n    admin_user: User = Depends(get_current_admin_user),\n    db: Session = Depends(get_db),\n    request: Request = None,\n) -> Dict[str, Any]:\n    \"\"\"Get all clinical contexts for a specific user.\n\n    Useful for user data export or account management.\n    \"\"\"\n    try:\n        user_uuid = UUID(user_id)\n    except ValueError:\n        return error_response(\n            code=\"INVALID_ID\",\n            message=\"Invalid user ID format\",\n            status_code=400,\n        )\n\n    # Verify user exists\n    user = db.query(User).filter(User.id == user_uuid).first()\n    if not user:\n        return error_response(\n            code=\"USER_NOT_FOUND\",\n            message=\"User not found\",\n            status_code=404,\n        )\n\n    # Get all contexts for user\n    contexts = (\n        db.query(ClinicalContext)\n        .filter(ClinicalContext.user_id == user_uuid)\n        .order_by(desc(ClinicalContext.last_updated))\n        .all()\n    )\n\n    # Convert to appropriate format\n    if include_phi:\n        results = [context_to_detail(c, user, mask_phi=False).model_dump() for c in contexts]\n    else:\n        results = [context_to_summary(c, user).model_dump() for c in contexts]\n\n    # Log access\n    await log_clinical_access(\n        db=db,\n        admin_user=admin_user,\n        action=\"list_user_contexts\",\n        resource_id=user_id,\n        phi_accessed=include_phi,\n        request=request,\n        details={\"context_count\": len(results)},\n    )\n\n    return success_response(\n        data={\n            \"user_id\": user_id,\n            \"user_email\": user.email,\n            \"contexts\": results,\n            \"total\": len(results),\n            \"phi_included\": include_phi,\n        }\n    )\n"
}

{
  "path": "apps/web-app/src/components/unified-chat/UnifiedInputArea.tsx",
  "language": "typescript",
  "size": 18358,
  "last_modified": "2025-12-03T23:50:35.643Z",
  "lines": 592,
  "content": "/**\n * Unified Input Area\n *\n * Merged text/voice input component with mode toggle.\n * Supports automatic input detection, push-to-talk, and always-on voice modes.\n */\n\nimport { useState, useRef, useCallback } from \"react\";\nimport {\n  Mic,\n  MicOff,\n  Send,\n  Paperclip,\n  Loader2,\n  Volume2,\n  Square,\n  AlertCircle,\n} from \"lucide-react\";\nimport {\n  useUnifiedConversationStore,\n  type MessageSource,\n} from \"../../stores/unifiedConversationStore\";\nimport {\n  useVoiceSettingsStore,\n  type VoiceModeType,\n} from \"../../stores/voiceSettingsStore\";\nimport { useVoiceModeStateMachine } from \"../../hooks/useVoiceModeStateMachine\";\n\n// ============================================================================\n// Types\n// ============================================================================\n\ninterface UnifiedInputAreaProps {\n  conversationId: string | null;\n  onSendMessage: (content: string, source: MessageSource) => void;\n  disabled?: boolean;\n  /** Disable only the send button (e.g., when disconnected but still allow typing) */\n  sendDisabled?: boolean;\n  /** Callback to toggle voice panel visibility */\n  onToggleVoicePanel?: () => void;\n  /** Whether the voice panel is currently open */\n  isVoicePanelOpen?: boolean;\n}\n\ntype _InputMode = \"text\" | \"voice\";\n\n// ============================================================================\n// Component\n// ============================================================================\n\nexport function UnifiedInputArea({\n  conversationId,\n  onSendMessage,\n  disabled = false,\n  sendDisabled = false,\n  onToggleVoicePanel,\n  isVoicePanelOpen = false,\n}: UnifiedInputAreaProps) {\n  const textareaRef = useRef<HTMLTextAreaElement>(null);\n  const [textContent, setTextContent] = useState(\"\");\n\n  // Unified store state\n  const {\n    inputMode: _inputMode,\n    voiceModeActive,\n    voiceModeType: _voiceModeType,\n    voiceState,\n    isListening,\n    isSpeaking,\n    partialTranscript,\n    setInputMode,\n    activateVoiceMode,\n    deactivateVoiceMode,\n    startListening,\n    stopListening,\n  } = useUnifiedConversationStore();\n\n  // Voice settings\n  const {\n    voiceModeType: settingsVoiceModeType,\n    setVoiceModeType: setSettingsVoiceModeType,\n  } = useVoiceSettingsStore();\n\n  // Voice mode state machine\n  const {\n    voiceState: machineVoiceState,\n    isActive: _machineIsActive,\n    isListening: machineIsListening,\n    isProcessing: _isProcessing,\n    isResponding: _isResponding,\n    hasError: voiceHasError,\n    error: voiceError,\n    partialTranscript: machinePartialTranscript,\n    finalTranscript: _finalTranscript,\n    activate: activateVoice,\n    deactivate: deactivateVoice,\n    retryConnection,\n  } = useVoiceModeStateMachine({\n    conversationId,\n    onTranscriptComplete: (transcript) => {\n      if (transcript.trim()) {\n        onSendMessage(transcript, \"voice\");\n      }\n    },\n    onError: (error) => {\n      console.error(\"[UnifiedInputArea] Voice error:\", error);\n    },\n  });\n\n  // -------------------------------------------------------------------------\n  // Text Input Handlers\n  // -------------------------------------------------------------------------\n\n  const handleTextChange = useCallback(\n    (e: React.ChangeEvent<HTMLTextAreaElement>) => {\n      setTextContent(e.target.value);\n      // Auto-resize textarea\n      if (textareaRef.current) {\n        textareaRef.current.style.height = \"auto\";\n        textareaRef.current.style.height = `${Math.min(textareaRef.current.scrollHeight, 200)}px`;\n      }\n    },\n    [],\n  );\n\n  const handleTextSubmit = useCallback(() => {\n    if (!textContent.trim() || disabled || sendDisabled) return;\n\n    onSendMessage(textContent.trim(), \"text\");\n    setTextContent(\"\");\n\n    // Reset textarea height\n    if (textareaRef.current) {\n      textareaRef.current.style.height = \"auto\";\n    }\n  }, [textContent, disabled, sendDisabled, onSendMessage]);\n\n  const handleKeyDown = useCallback(\n    (e: React.KeyboardEvent) => {\n      // Submit on Enter (without Shift)\n      if (e.key === \"Enter\" && !e.shiftKey) {\n        e.preventDefault();\n        handleTextSubmit();\n      }\n\n      // Space to toggle voice in push-to-talk mode (when text is empty)\n      if (\n        e.key === \" \" &&\n        !textContent &&\n        voiceModeActive &&\n        settingsVoiceModeType === \"push-to-talk\"\n      ) {\n        e.preventDefault();\n        if (!isListening) {\n          startListening();\n        }\n      }\n    },\n    [\n      handleTextSubmit,\n      textContent,\n      voiceModeActive,\n      settingsVoiceModeType,\n      isListening,\n      startListening,\n    ],\n  );\n\n  const _handleKeyUp = useCallback(\n    (e: React.KeyboardEvent) => {\n      // Release space in push-to-talk mode\n      if (\n        e.key === \" \" &&\n        voiceModeActive &&\n        settingsVoiceModeType === \"push-to-talk\" &&\n        isListening\n      ) {\n        stopListening();\n      }\n    },\n    [voiceModeActive, settingsVoiceModeType, isListening, stopListening],\n  );\n\n  // -------------------------------------------------------------------------\n  // Voice Mode Handlers\n  // -------------------------------------------------------------------------\n\n  const handleModeToggle = useCallback(async () => {\n    // If external voice panel control is provided, use it\n    if (onToggleVoicePanel) {\n      onToggleVoicePanel();\n      return;\n    }\n\n    // Otherwise use internal voice mode\n    if (voiceModeActive) {\n      deactivateVoice();\n      deactivateVoiceMode();\n      setInputMode(\"text\");\n    } else {\n      activateVoiceMode();\n      setInputMode(\"voice\");\n      // Activate voice state machine\n      await activateVoice();\n    }\n  }, [\n    voiceModeActive,\n    activateVoice,\n    deactivateVoice,\n    activateVoiceMode,\n    deactivateVoiceMode,\n    setInputMode,\n    onToggleVoicePanel,\n  ]);\n\n  const handleVoiceModeTypeToggle = useCallback(() => {\n    const newType: VoiceModeType =\n      settingsVoiceModeType === \"always-on\" ? \"push-to-talk\" : \"always-on\";\n    setSettingsVoiceModeType(newType);\n  }, [settingsVoiceModeType, setSettingsVoiceModeType]);\n\n  const handlePushToTalkStart = useCallback(() => {\n    if (voiceModeActive && settingsVoiceModeType === \"push-to-talk\") {\n      startListening();\n    }\n  }, [voiceModeActive, settingsVoiceModeType, startListening]);\n\n  const handlePushToTalkEnd = useCallback(() => {\n    if (\n      voiceModeActive &&\n      settingsVoiceModeType === \"push-to-talk\" &&\n      isListening\n    ) {\n      stopListening();\n    }\n  }, [voiceModeActive, settingsVoiceModeType, isListening, stopListening]);\n\n  // -------------------------------------------------------------------------\n  // Render Helpers\n  // -------------------------------------------------------------------------\n\n  // Check if voice is active (either external panel or internal mode)\n  const isVoiceActive = isVoicePanelOpen || voiceModeActive;\n\n  const getModeToggleIcon = () => {\n    if (isVoiceActive) {\n      // When using external voice panel, just show mic icon\n      if (isVoicePanelOpen) {\n        return <Mic className=\"w-5 h-5\" />;\n      }\n      // Internal voice mode - show state-based icon\n      switch (voiceState) {\n        case \"listening\":\n          return <Mic className=\"w-5 h-5 animate-pulse\" />;\n        case \"processing\":\n          return <Loader2 className=\"w-5 h-5 animate-spin\" />;\n        case \"responding\":\n          return <Volume2 className=\"w-5 h-5\" />;\n        case \"error\":\n          return <MicOff className=\"w-5 h-5\" />;\n        default:\n          return <Mic className=\"w-5 h-5\" />;\n      }\n    }\n    return <Mic className=\"w-5 h-5\" />;\n  };\n\n  const getModeToggleLabel = () => {\n    if (isVoiceActive) {\n      // When using external voice panel, just show \"Voice\"\n      if (isVoicePanelOpen) {\n        return \"Voice\";\n      }\n      // Internal voice mode - show state-based label\n      switch (voiceState) {\n        case \"connecting\":\n          return \"Connecting...\";\n        case \"listening\":\n          return \"Listening...\";\n        case \"processing\":\n          return \"Processing...\";\n        case \"responding\":\n          return \"Speaking...\";\n        case \"error\":\n          return \"Error\";\n        default:\n          return \"Voice\";\n      }\n    }\n    return \"Voice\";\n  };\n\n  const getModeToggleColor = () => {\n    if (!isVoiceActive)\n      return \"bg-neutral-100 text-neutral-600 hover:bg-neutral-200\";\n\n    // When using external voice panel, show active color\n    if (isVoicePanelOpen) {\n      return \"bg-primary-100 text-primary-700 hover:bg-primary-200\";\n    }\n\n    // Internal voice mode - show state-based color\n    switch (voiceState) {\n      case \"listening\":\n        return \"bg-primary-500 text-white\";\n      case \"processing\":\n        return \"bg-primary-400 text-white\";\n      case \"responding\":\n        return \"bg-secondary-500 text-white\";\n      case \"error\":\n        return \"bg-error-500 text-white\";\n      default:\n        return \"bg-primary-100 text-primary-700 hover:bg-primary-200\";\n    }\n  };\n\n  // -------------------------------------------------------------------------\n  // Render\n  // -------------------------------------------------------------------------\n\n  return (\n    <div\n      className=\"border-t border-neutral-200 bg-white\"\n      data-testid=\"unified-input-area\"\n    >\n      {/* Main Input Row */}\n      <div className=\"flex items-end gap-2 px-4 py-3\">\n        {/* Mode Toggle Button */}\n        <button\n          onClick={handleModeToggle}\n          disabled={disabled}\n          className={`flex items-center gap-2 px-3 py-2.5 rounded-lg font-medium transition-colors ${getModeToggleColor()}`}\n          aria-label={isVoiceActive ? \"Close voice mode\" : \"Open voice mode\"}\n          title={\n            isVoiceActive\n              ? \"Click to close voice mode\"\n              : \"Click to open voice mode\"\n          }\n          data-testid=\"voice-mode-toggle\"\n        >\n          {getModeToggleIcon()}\n          <span className=\"text-sm hidden sm:inline\">\n            {getModeToggleLabel()}\n          </span>\n        </button>\n\n        {/* Dynamic Input Area */}\n        <div className=\"flex-1 min-w-0\">\n          {/* When using external voice panel, show text input. Otherwise show internal voice UI */}\n          {voiceModeActive && !isVoicePanelOpen ? (\n            <VoiceInputArea\n              voiceState={machineVoiceState || voiceState}\n              voiceModeType={settingsVoiceModeType}\n              isListening={machineIsListening || isListening}\n              isSpeaking={isSpeaking}\n              partialTranscript={machinePartialTranscript || partialTranscript}\n              hasError={voiceHasError}\n              errorMessage={voiceError?.message}\n              onPushToTalkStart={handlePushToTalkStart}\n              onPushToTalkEnd={handlePushToTalkEnd}\n              onRetry={retryConnection}\n              disabled={disabled}\n            />\n          ) : (\n            <textarea\n              ref={textareaRef}\n              value={textContent}\n              onChange={handleTextChange}\n              onKeyDown={handleKeyDown}\n              placeholder=\"Type a message...\"\n              disabled={disabled}\n              className=\"w-full px-4 py-2.5 border border-neutral-200 rounded-lg resize-none focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent disabled:bg-neutral-50 disabled:text-neutral-400\"\n              rows={1}\n              style={{ maxHeight: \"200px\" }}\n              data-testid=\"message-input\"\n            />\n          )}\n        </div>\n\n        {/* Send / Action Button */}\n        {voiceModeActive ? (\n          <button\n            onClick={deactivateVoiceMode}\n            className=\"p-2.5 bg-neutral-100 text-neutral-600 rounded-lg hover:bg-neutral-200 transition-colors\"\n            aria-label=\"End voice mode\"\n            title=\"End voice mode\"\n          >\n            <Square className=\"w-5 h-5\" />\n          </button>\n        ) : (\n          <button\n            onClick={handleTextSubmit}\n            disabled={disabled || sendDisabled || !textContent.trim()}\n            className=\"p-2.5 bg-primary-600 text-white rounded-lg hover:bg-primary-700 disabled:bg-neutral-200 disabled:text-neutral-400 transition-colors\"\n            aria-label=\"Send message\"\n            title=\"Send message\"\n            data-testid=\"send-button\"\n          >\n            <Send className=\"w-5 h-5\" />\n          </button>\n        )}\n      </div>\n\n      {/* Secondary Actions Row */}\n      <div className=\"flex items-center justify-between px-4 pb-3\">\n        <div className=\"flex items-center gap-2\">\n          {/* Voice Mode Type Toggle (only when voice mode active) */}\n          {voiceModeActive && (\n            <button\n              onClick={handleVoiceModeTypeToggle}\n              className=\"flex items-center gap-2 px-2 py-1 text-xs font-medium text-neutral-500 hover:text-neutral-700 hover:bg-neutral-100 rounded transition-colors\"\n            >\n              <span\n                className={`w-2 h-2 rounded-full ${\n                  settingsVoiceModeType === \"always-on\"\n                    ? \"bg-green-500\"\n                    : \"bg-neutral-400\"\n                }`}\n              />\n              <span>\n                {settingsVoiceModeType === \"always-on\"\n                  ? \"Always-on\"\n                  : \"Push-to-talk\"}\n              </span>\n            </button>\n          )}\n        </div>\n\n        <div className=\"flex items-center gap-2\">\n          {/* Attachment Button */}\n          <button\n            className=\"p-1.5 text-neutral-400 hover:text-neutral-600 hover:bg-neutral-100 rounded transition-colors\"\n            aria-label=\"Attach file\"\n            title=\"Attach file\"\n          >\n            <Paperclip className=\"w-4 h-4\" />\n          </button>\n\n          {/* Character count (text mode only) */}\n          {!voiceModeActive && textContent.length > 0 && (\n            <span className=\"text-xs text-neutral-400\">\n              {textContent.length}\n            </span>\n          )}\n        </div>\n      </div>\n    </div>\n  );\n}\n\n// ============================================================================\n// Voice Input Area Sub-component\n// ============================================================================\n\ninterface VoiceInputAreaProps {\n  voiceState: string;\n  voiceModeType: VoiceModeType;\n  isListening: boolean;\n  isSpeaking: boolean;\n  partialTranscript: string;\n  hasError?: boolean;\n  errorMessage?: string;\n  onPushToTalkStart: () => void;\n  onPushToTalkEnd: () => void;\n  onRetry?: () => void;\n  disabled: boolean;\n}\n\nfunction VoiceInputArea({\n  voiceState,\n  voiceModeType,\n  isListening,\n  isSpeaking,\n  partialTranscript,\n  hasError,\n  errorMessage,\n  onPushToTalkStart,\n  onPushToTalkEnd,\n  onRetry,\n  disabled,\n}: VoiceInputAreaProps) {\n  const getStatusText = () => {\n    if (hasError) {\n      return errorMessage || \"Connection error. Click to retry.\";\n    }\n\n    switch (voiceState) {\n      case \"connecting\":\n        return \"Connecting to voice service...\";\n      case \"listening\":\n        return voiceModeType === \"push-to-talk\"\n          ? \"Recording...\"\n          : \"Listening... Speak now\";\n      case \"processing\":\n        return \"Processing your speech...\";\n      case \"responding\":\n        return \"AI is responding...\";\n      case \"error\":\n        return errorMessage || \"Connection error. Click to retry.\";\n      default:\n        return voiceModeType === \"push-to-talk\"\n          ? \"Hold Space or click the mic to record\"\n          : \"Ready to listen\";\n    }\n  };\n\n  return (\n    <div className=\"relative\">\n      {/* Waveform / Status Area */}\n      <div\n        className={`flex items-center justify-center px-4 py-4 rounded-lg border transition-colors ${\n          isListening\n            ? \"bg-primary-50 border-primary-200\"\n            : isSpeaking\n              ? \"bg-secondary-50 border-secondary-200\"\n              : \"bg-neutral-50 border-neutral-200\"\n        }`}\n      >\n        {/* Waveform Visualization (placeholder) */}\n        {(isListening || isSpeaking) && (\n          <div className=\"flex items-center gap-1 mr-4\">\n            {Array.from({ length: 5 }).map((_, i) => (\n              <div\n                key={i}\n                className={`w-1 rounded-full transition-all ${\n                  isListening ? \"bg-primary-500\" : \"bg-secondary-500\"\n                }`}\n                style={{\n                  height: `${12 + Math.random() * 20}px`,\n                  animationDelay: `${i * 0.1}s`,\n                }}\n              />\n            ))}\n          </div>\n        )}\n\n        {/* Status Text */}\n        <div className=\"flex-1 text-center\">\n          <p className=\"text-sm text-neutral-600\">{getStatusText()}</p>\n\n          {/* Partial Transcript */}\n          {partialTranscript && (\n            <p className=\"mt-1 text-sm font-medium text-neutral-900 italic\">\n              \"{partialTranscript}\"\n            </p>\n          )}\n        </div>\n\n        {/* Error Retry Button */}\n        {hasError && onRetry && (\n          <button\n            onClick={onRetry}\n            className=\"ml-4 px-4 py-2 bg-error-100 text-error-700 rounded-lg hover:bg-error-200 transition-colors flex items-center gap-2\"\n            aria-label=\"Retry connection\"\n          >\n            <AlertCircle className=\"w-4 h-4\" />\n            <span className=\"text-sm font-medium\">Retry</span>\n          </button>\n        )}\n\n        {/* Push-to-Talk Button (PTT mode only) */}\n        {!hasError &&\n          voiceModeType === \"push-to-talk\" &&\n          voiceState !== \"connecting\" && (\n            <button\n              onMouseDown={onPushToTalkStart}\n              onMouseUp={onPushToTalkEnd}\n              onMouseLeave={onPushToTalkEnd}\n              onTouchStart={onPushToTalkStart}\n              onTouchEnd={onPushToTalkEnd}\n              disabled={disabled}\n              className={`ml-4 p-3 rounded-full transition-colors ${\n                isListening\n                  ? \"bg-error-500 text-white\"\n                  : \"bg-primary-500 text-white hover:bg-primary-600\"\n              }`}\n              aria-label={\n                isListening ? \"Recording... Release to stop\" : \"Hold to record\"\n              }\n            >\n              <Mic\n                className={`w-6 h-6 ${isListening ? \"animate-pulse\" : \"\"}`}\n              />\n            </button>\n          )}\n      </div>\n    </div>\n  );\n}\n\nexport default UnifiedInputArea;\n"
}

{
  "path": "apps/admin-panel/src/components/users/CreateUserDialog.tsx",
  "language": "typescript",
  "size": 20741,
  "last_modified": "2025-11-29T09:47:36.818Z",
  "lines": 597,
  "content": "import { useState, useEffect, useCallback, FormEvent } from \"react\";\nimport {\n  useCreateUser,\n  CreateUserPayload,\n  InviteUserPayload,\n} from \"../../hooks/useCreateUser\";\nimport { RoleSelector } from \"./RoleSelector\";\n\ninterface CreateUserDialogProps {\n  isOpen: boolean;\n  onClose: () => void;\n  onSuccess: () => void;\n}\n\ninterface PasswordStrength {\n  score: number; // 0-4\n  label: string;\n  color: string;\n  checks: {\n    length: boolean;\n    uppercase: boolean;\n    lowercase: boolean;\n    number: boolean;\n    special: boolean;\n  };\n}\n\nfunction calculatePasswordStrength(password: string): PasswordStrength {\n  const checks = {\n    length: password.length >= 12,\n    uppercase: /[A-Z]/.test(password),\n    lowercase: /[a-z]/.test(password),\n    number: /[0-9]/.test(password),\n    special: /[!@#$%^&*()_+\\-=\\[\\]{};':\"\\\\|,.<>\\/?]/.test(password),\n  };\n\n  const passedChecks = Object.values(checks).filter(Boolean).length;\n\n  if (password.length === 0) {\n    return { score: 0, label: \"\", color: \"\", checks };\n  }\n  if (password.length < 8) {\n    return { score: 1, label: \"Too short\", color: \"bg-red-500\", checks };\n  }\n  if (passedChecks <= 2) {\n    return { score: 1, label: \"Weak\", color: \"bg-red-500\", checks };\n  }\n  if (passedChecks === 3) {\n    return { score: 2, label: \"Fair\", color: \"bg-yellow-500\", checks };\n  }\n  if (passedChecks === 4) {\n    return { score: 3, label: \"Good\", color: \"bg-blue-500\", checks };\n  }\n  return { score: 4, label: \"Strong\", color: \"bg-green-500\", checks };\n}\n\nexport function CreateUserDialog({\n  isOpen,\n  onClose,\n  onSuccess,\n}: CreateUserDialogProps) {\n  const {\n    createUser,\n    inviteUser,\n    isLoading,\n    error: hookError,\n    checkEmailExists,\n  } = useCreateUser();\n\n  // Form state\n  const [email, setEmail] = useState(\"\");\n  const [fullName, setFullName] = useState(\"\");\n  const [password, setPassword] = useState(\"\");\n  const [showPassword, setShowPassword] = useState(false);\n  const [adminRole, setAdminRole] = useState<\"user\" | \"admin\" | \"viewer\">(\n    \"user\",\n  );\n  const [isActive, setIsActive] = useState(true);\n  const [passwordMethod, setPasswordMethod] = useState<\"manual\" | \"invitation\">(\n    \"manual\",\n  );\n\n  // Validation state\n  const [emailError, setEmailError] = useState<string | null>(null);\n  const [isCheckingEmail, setIsCheckingEmail] = useState(false);\n  const [formError, setFormError] = useState<string | null>(null);\n  const [successMessage, setSuccessMessage] = useState<string | null>(null);\n\n  // Password strength\n  const passwordStrength = calculatePasswordStrength(password);\n\n  // Reset form when dialog opens/closes\n  useEffect(() => {\n    if (isOpen) {\n      setEmail(\"\");\n      setFullName(\"\");\n      setPassword(\"\");\n      setShowPassword(false);\n      setAdminRole(\"user\");\n      setIsActive(true);\n      setPasswordMethod(\"manual\");\n      setEmailError(null);\n      setFormError(null);\n      setSuccessMessage(null);\n    }\n  }, [isOpen]);\n\n  // Debounced email validation\n  useEffect(() => {\n    if (!email) {\n      setEmailError(null);\n      return;\n    }\n\n    // Basic email format validation\n    const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\n    if (!emailRegex.test(email)) {\n      setEmailError(\"Please enter a valid email address\");\n      return;\n    }\n\n    // Check uniqueness after debounce\n    const timeoutId = setTimeout(async () => {\n      setIsCheckingEmail(true);\n      try {\n        const exists = await checkEmailExists(email);\n        if (exists) {\n          setEmailError(\"This email is already registered\");\n        } else {\n          setEmailError(null);\n        }\n      } finally {\n        setIsCheckingEmail(false);\n      }\n    }, 300);\n\n    return () => clearTimeout(timeoutId);\n  }, [email, checkEmailExists]);\n\n  // Check if form is valid\n  const isFormValid = useCallback(() => {\n    if (!email || emailError || isCheckingEmail) return false;\n    if (passwordMethod === \"manual\") {\n      if (!password || passwordStrength.score < 3) return false;\n    }\n    // Invitation method just needs valid email\n    return true;\n  }, [\n    email,\n    emailError,\n    isCheckingEmail,\n    passwordMethod,\n    password,\n    passwordStrength.score,\n  ]);\n\n  const handleSubmit = async (e: FormEvent) => {\n    e.preventDefault();\n    setFormError(null);\n    setSuccessMessage(null);\n\n    if (!isFormValid()) {\n      setFormError(\"Please fix the errors above\");\n      return;\n    }\n\n    try {\n      if (passwordMethod === \"invitation\") {\n        // Use invitation flow\n        const payload: InviteUserPayload = {\n          email,\n          full_name: fullName || undefined,\n          admin_role: adminRole,\n        };\n\n        const result = await inviteUser(payload);\n        if (result.invitation_sent) {\n          setSuccessMessage(`Invitation sent to ${email}!`);\n        } else {\n          setSuccessMessage(\n            `User ${email} created. Invitation email could not be sent.`,\n          );\n        }\n      } else {\n        // Use manual password flow\n        const payload: CreateUserPayload = {\n          email,\n          full_name: fullName,\n          password,\n          admin_role: adminRole,\n          is_active: isActive,\n        };\n\n        await createUser(payload);\n        setSuccessMessage(`User ${email} created successfully!`);\n      }\n\n      // Close after brief delay to show success\n      setTimeout(() => {\n        onSuccess();\n        onClose();\n      }, 1000);\n    } catch (err) {\n      // Error is already set in the hook\n      setFormError(\n        hookError ||\n          (err instanceof Error ? err.message : \"Failed to create user\"),\n      );\n    }\n  };\n\n  if (!isOpen) return null;\n\n  return (\n    <div className=\"fixed inset-0 bg-black/50 flex items-center justify-center z-50\">\n      <div className=\"bg-slate-900 border border-slate-800 rounded-lg w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto\">\n        {/* Header */}\n        <div className=\"flex items-center justify-between p-4 border-b border-slate-800\">\n          <h2 className=\"text-lg font-bold text-slate-100\">Create New User</h2>\n          <button\n            onClick={onClose}\n            className=\"text-slate-400 hover:text-slate-200 transition-colors\"\n            aria-label=\"Close\"\n          >\n            <svg\n              className=\"w-5 h-5\"\n              fill=\"none\"\n              viewBox=\"0 0 24 24\"\n              stroke=\"currentColor\"\n            >\n              <path\n                strokeLinecap=\"round\"\n                strokeLinejoin=\"round\"\n                strokeWidth={2}\n                d=\"M6 18L18 6M6 6l12 12\"\n              />\n            </svg>\n          </button>\n        </div>\n\n        {/* Form */}\n        <form onSubmit={handleSubmit} className=\"p-4 space-y-5\">\n          {/* Success Message */}\n          {successMessage && (\n            <div className=\"p-3 bg-green-900/50 border border-green-800 rounded-md text-green-300 text-sm\">\n              {successMessage}\n            </div>\n          )}\n\n          {/* Form Error */}\n          {(formError || hookError) && !successMessage && (\n            <div className=\"p-3 bg-red-950/50 border border-red-900 rounded-md text-red-400 text-sm\">\n              {formError || hookError}\n            </div>\n          )}\n\n          {/* Email Field */}\n          <div>\n            <label\n              htmlFor=\"email\"\n              className=\"block text-sm font-medium text-slate-300 mb-1.5\"\n            >\n              Email Address <span className=\"text-red-400\">*</span>\n            </label>\n            <div className=\"relative\">\n              <input\n                id=\"email\"\n                type=\"email\"\n                value={email}\n                onChange={(e) => setEmail(e.target.value)}\n                placeholder=\"user@example.com\"\n                className={`w-full px-3 py-2 bg-slate-800 border rounded-md text-slate-100 placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500 ${\n                  emailError ? \"border-red-500\" : \"border-slate-700\"\n                }`}\n                disabled={isLoading}\n              />\n              {isCheckingEmail && (\n                <div className=\"absolute right-3 top-1/2 -translate-y-1/2\">\n                  <div className=\"w-4 h-4 border-2 border-blue-500 border-t-transparent rounded-full animate-spin\" />\n                </div>\n              )}\n              {!isCheckingEmail && email && !emailError && (\n                <div className=\"absolute right-3 top-1/2 -translate-y-1/2 text-green-400\">\n                  <svg\n                    className=\"w-4 h-4\"\n                    fill=\"none\"\n                    viewBox=\"0 0 24 24\"\n                    stroke=\"currentColor\"\n                  >\n                    <path\n                      strokeLinecap=\"round\"\n                      strokeLinejoin=\"round\"\n                      strokeWidth={2}\n                      d=\"M5 13l4 4L19 7\"\n                    />\n                  </svg>\n                </div>\n              )}\n            </div>\n            {emailError && (\n              <p className=\"mt-1 text-xs text-red-400\">{emailError}</p>\n            )}\n          </div>\n\n          {/* Full Name Field */}\n          <div>\n            <label\n              htmlFor=\"fullName\"\n              className=\"block text-sm font-medium text-slate-300 mb-1.5\"\n            >\n              Full Name\n            </label>\n            <input\n              id=\"fullName\"\n              type=\"text\"\n              value={fullName}\n              onChange={(e) => setFullName(e.target.value)}\n              placeholder=\"John Smith\"\n              maxLength={100}\n              className=\"w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded-md text-slate-100 placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500\"\n              disabled={isLoading}\n            />\n          </div>\n\n          {/* Role Selection */}\n          <div>\n            <label className=\"block text-sm font-medium text-slate-300 mb-2\">\n              Role\n            </label>\n            <RoleSelector\n              value={adminRole}\n              onChange={setAdminRole}\n              disabled={isLoading}\n            />\n          </div>\n\n          {/* Active Status - only show for manual password method */}\n          {passwordMethod === \"manual\" && (\n            <div>\n              <label className=\"flex items-center gap-3 cursor-pointer\">\n                <div className=\"relative\">\n                  <input\n                    type=\"checkbox\"\n                    checked={isActive}\n                    onChange={(e) => setIsActive(e.target.checked)}\n                    className=\"sr-only\"\n                    disabled={isLoading}\n                  />\n                  <div\n                    className={`w-10 h-6 rounded-full transition-colors ${\n                      isActive ? \"bg-blue-600\" : \"bg-slate-700\"\n                    }`}\n                  >\n                    <div\n                      className={`w-4 h-4 bg-white rounded-full absolute top-1 transition-transform ${\n                        isActive ? \"translate-x-5\" : \"translate-x-1\"\n                      }`}\n                    />\n                  </div>\n                </div>\n                <span className=\"text-sm font-medium text-slate-300\">\n                  Account Active\n                </span>\n              </label>\n            </div>\n          )}\n\n          {/* Password Method */}\n          <div>\n            <label className=\"block text-sm font-medium text-slate-300 mb-2\">\n              Password Setup\n            </label>\n            <div className=\"space-y-2\">\n              <label\n                className={`flex items-start gap-3 p-3 bg-slate-800/50 border rounded-md cursor-pointer hover:bg-slate-800 transition-colors ${\n                  passwordMethod === \"invitation\"\n                    ? \"border-blue-500 bg-blue-950/30\"\n                    : \"border-slate-700\"\n                }`}\n              >\n                <input\n                  type=\"radio\"\n                  name=\"passwordMethod\"\n                  checked={passwordMethod === \"invitation\"}\n                  onChange={() => setPasswordMethod(\"invitation\")}\n                  className=\"mt-0.5\"\n                  disabled={isLoading}\n                />\n                <div>\n                  <div className=\"text-sm font-medium text-slate-200\">\n                    Send invitation email\n                  </div>\n                  <div className=\"text-xs text-slate-400\">\n                    User will receive an email to set their own password\n                  </div>\n                </div>\n              </label>\n              <label\n                className={`flex items-start gap-3 p-3 bg-slate-800/50 border rounded-md cursor-pointer hover:bg-slate-800 transition-colors ${\n                  passwordMethod === \"manual\"\n                    ? \"border-blue-500 bg-blue-950/30\"\n                    : \"border-slate-700\"\n                }`}\n              >\n                <input\n                  type=\"radio\"\n                  name=\"passwordMethod\"\n                  checked={passwordMethod === \"manual\"}\n                  onChange={() => setPasswordMethod(\"manual\")}\n                  className=\"mt-0.5\"\n                  disabled={isLoading}\n                />\n                <div>\n                  <div className=\"text-sm font-medium text-slate-200\">\n                    Set temporary password\n                  </div>\n                  <div className=\"text-xs text-slate-400\">\n                    Share the password securely with the user\n                  </div>\n                </div>\n              </label>\n            </div>\n          </div>\n\n          {/* Password Field (only if manual) */}\n          {passwordMethod === \"manual\" && (\n            <div>\n              <label\n                htmlFor=\"password\"\n                className=\"block text-sm font-medium text-slate-300 mb-1.5\"\n              >\n                Temporary Password <span className=\"text-red-400\">*</span>\n              </label>\n              <div className=\"relative\">\n                <input\n                  id=\"password\"\n                  type={showPassword ? \"text\" : \"password\"}\n                  value={password}\n                  onChange={(e) => setPassword(e.target.value)}\n                  placeholder=\"Minimum 12 characters\"\n                  className=\"w-full px-3 py-2 pr-10 bg-slate-800 border border-slate-700 rounded-md text-slate-100 placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500\"\n                  disabled={isLoading}\n                />\n                <button\n                  type=\"button\"\n                  onClick={() => setShowPassword(!showPassword)}\n                  className=\"absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-200\"\n                >\n                  {showPassword ? (\n                    <svg\n                      className=\"w-4 h-4\"\n                      fill=\"none\"\n                      viewBox=\"0 0 24 24\"\n                      stroke=\"currentColor\"\n                    >\n                      <path\n                        strokeLinecap=\"round\"\n                        strokeLinejoin=\"round\"\n                        strokeWidth={2}\n                        d=\"M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21\"\n                      />\n                    </svg>\n                  ) : (\n                    <svg\n                      className=\"w-4 h-4\"\n                      fill=\"none\"\n                      viewBox=\"0 0 24 24\"\n                      stroke=\"currentColor\"\n                    >\n                      <path\n                        strokeLinecap=\"round\"\n                        strokeLinejoin=\"round\"\n                        strokeWidth={2}\n                        d=\"M15 12a3 3 0 11-6 0 3 3 0 016 0z\"\n                      />\n                      <path\n                        strokeLinecap=\"round\"\n                        strokeLinejoin=\"round\"\n                        strokeWidth={2}\n                        d=\"M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z\"\n                      />\n                    </svg>\n                  )}\n                </button>\n              </div>\n\n              {/* Password Strength Meter */}\n              {password && (\n                <div className=\"mt-2 space-y-2\">\n                  <div className=\"flex items-center gap-2\">\n                    <div className=\"flex-1 h-1.5 bg-slate-700 rounded-full overflow-hidden\">\n                      <div\n                        className={`h-full transition-all ${passwordStrength.color}`}\n                        style={{\n                          width: `${(passwordStrength.score / 4) * 100}%`,\n                        }}\n                      />\n                    </div>\n                    <span\n                      className={`text-xs font-medium ${\n                        passwordStrength.score >= 3\n                          ? \"text-green-400\"\n                          : passwordStrength.score >= 2\n                            ? \"text-yellow-400\"\n                            : \"text-red-400\"\n                      }`}\n                    >\n                      {passwordStrength.label}\n                    </span>\n                  </div>\n\n                  {/* Requirements Checklist */}\n                  <div className=\"grid grid-cols-2 gap-1 text-xs\">\n                    <div\n                      className={\n                        passwordStrength.checks.length\n                          ? \"text-green-400\"\n                          : \"text-slate-500\"\n                      }\n                    >\n                      {passwordStrength.checks.length ? \"✓\" : \"○\"} 12+\n                      characters\n                    </div>\n                    <div\n                      className={\n                        passwordStrength.checks.uppercase\n                          ? \"text-green-400\"\n                          : \"text-slate-500\"\n                      }\n                    >\n                      {passwordStrength.checks.uppercase ? \"✓\" : \"○\"} Uppercase\n                      letter\n                    </div>\n                    <div\n                      className={\n                        passwordStrength.checks.lowercase\n                          ? \"text-green-400\"\n                          : \"text-slate-500\"\n                      }\n                    >\n                      {passwordStrength.checks.lowercase ? \"✓\" : \"○\"} Lowercase\n                      letter\n                    </div>\n                    <div\n                      className={\n                        passwordStrength.checks.number\n                          ? \"text-green-400\"\n                          : \"text-slate-500\"\n                      }\n                    >\n                      {passwordStrength.checks.number ? \"✓\" : \"○\"} Number\n                    </div>\n                    <div\n                      className={\n                        passwordStrength.checks.special\n                          ? \"text-green-400\"\n                          : \"text-slate-500\"\n                      }\n                    >\n                      {passwordStrength.checks.special ? \"✓\" : \"○\"} Special\n                      character\n                    </div>\n                  </div>\n                </div>\n              )}\n            </div>\n          )}\n\n          {/* Actions */}\n          <div className=\"flex justify-end gap-3 pt-4 border-t border-slate-800\">\n            <button\n              type=\"button\"\n              onClick={onClose}\n              className=\"px-4 py-2 bg-slate-800 hover:bg-slate-700 text-slate-200 rounded-md text-sm transition-colors\"\n              disabled={isLoading}\n            >\n              Cancel\n            </button>\n            <button\n              type=\"submit\"\n              disabled={!isFormValid() || isLoading}\n              className=\"px-4 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-blue-950 disabled:text-slate-400 text-white rounded-md text-sm font-medium transition-colors flex items-center gap-2\"\n            >\n              {isLoading && (\n                <div className=\"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin\" />\n              )}\n              {passwordMethod === \"invitation\"\n                ? \"Send Invitation\"\n                : \"Create User\"}\n            </button>\n          </div>\n        </form>\n      </div>\n    </div>\n  );\n}\n"
}

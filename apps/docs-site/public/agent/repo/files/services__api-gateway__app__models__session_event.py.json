{
  "path": "services/api-gateway/app/models/session_event.py",
  "language": "python",
  "size": 5192,
  "last_modified": "2025-12-05T03:07:13.131Z",
  "lines": 162,
  "content": "\"\"\"\nSession Event model for structured event logging.\n\nThis model captures key events during conversation/voice sessions for:\n- Debugging voice + chat behavior\n- Performance analysis\n- Audit trails\n- Session replay/inspection\n\"\"\"\n\nimport uuid\nfrom datetime import datetime\nfrom enum import Enum\nfrom typing import Optional\n\nfrom app.core.database import Base\nfrom sqlalchemy import Column, DateTime, ForeignKey, Index, String\nfrom sqlalchemy.dialects.postgresql import JSONB, UUID\n\n\nclass EventType(str, Enum):\n    \"\"\"Types of session events that can be logged.\"\"\"\n\n    # Connection events\n    WEBSOCKET_CONNECT = \"websocket.connect\"\n    WEBSOCKET_DISCONNECT = \"websocket.disconnect\"\n    VOICE_CONNECT = \"voice.connect\"\n    VOICE_DISCONNECT = \"voice.disconnect\"\n    VOICE_RECONNECT = \"voice.reconnect\"\n\n    # Transcript events\n    TRANSCRIPT_PARTIAL = \"transcript.partial\"\n    TRANSCRIPT_FINAL = \"transcript.final\"\n\n    # Message events\n    MESSAGE_CREATED = \"message.created\"\n    MESSAGE_UPDATED = \"message.updated\"\n    MESSAGE_DELETED = \"message.deleted\"\n    MESSAGE_STREAMING_START = \"message.streaming.start\"\n    MESSAGE_STREAMING_CHUNK = \"message.streaming.chunk\"\n    MESSAGE_STREAMING_DONE = \"message.streaming.done\"\n\n    # Branch events\n    BRANCH_CREATED = \"branch.created\"\n    BRANCH_SWITCHED = \"branch.switched\"\n\n    # Voice events\n    VOICE_SPEAKING_START = \"voice.speaking.start\"\n    VOICE_SPEAKING_END = \"voice.speaking.end\"\n    VOICE_VAD_START = \"voice.vad.start\"\n    VOICE_VAD_END = \"voice.vad.end\"\n\n    # Error events\n    ERROR_WEBSOCKET = \"error.websocket\"\n    ERROR_VOICE = \"error.voice\"\n    ERROR_API = \"error.api\"\n    ERROR_BACKEND = \"error.backend\"\n\n    # Session events\n    SESSION_CREATED = \"session.created\"\n    SESSION_RESUMED = \"session.resumed\"\n    SESSION_EXPIRED = \"session.expired\"\n\n    # Custom events\n    CUSTOM = \"custom\"\n\n\nclass SessionEvent(Base):\n    \"\"\"\n    Model for storing structured session events.\n\n    Events are keyed by:\n    - conversation_id: The conversation these events belong to\n    - session_id: The specific session (e.g., WebSocket session, voice session)\n    - branch_id: Optional branch context\n\n    Events include:\n    - event_type: Categorized event type from EventType enum\n    - payload: JSON payload with event-specific data\n    - timestamp: When the event occurred\n    \"\"\"\n\n    __tablename__ = \"session_events\"\n\n    # Table indexes for efficient querying\n    __table_args__ = (\n        Index(\"ix_session_events_conversation_time\", \"conversation_id\", \"created_at\"),\n        Index(\"ix_session_events_session_time\", \"session_id\", \"created_at\"),\n        Index(\"ix_session_events_type_time\", \"event_type\", \"created_at\"),\n    )\n\n    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)\n\n    # Foreign keys / context\n    conversation_id = Column(\n        UUID(as_uuid=True),\n        ForeignKey(\"sessions.id\", ondelete=\"CASCADE\"),\n        nullable=False,\n        index=True,\n    )\n    session_id = Column(String(100), nullable=True, index=True)  # WS session ID, voice session ID, etc.\n    branch_id = Column(String(100), nullable=True, index=True)\n    user_id = Column(\n        UUID(as_uuid=True),\n        ForeignKey(\"users.id\", ondelete=\"CASCADE\"),\n        nullable=True,\n        index=True,\n    )\n\n    # Event data\n    event_type = Column(String(100), nullable=False, index=True)\n    payload = Column(JSONB, nullable=True)  # Event-specific data\n\n    # Metadata\n    source = Column(String(50), nullable=True)  # 'frontend', 'backend', 'voice-service'\n    trace_id = Column(String(100), nullable=True, index=True)  # For request tracing\n\n    # Timestamps\n    created_at = Column(DateTime, default=datetime.utcnow, nullable=False, index=True)\n\n    def __repr__(self):\n        return f\"<SessionEvent(id={self.id}, type={self.event_type}, \" f\"conversation={self.conversation_id})>\"\n\n    @classmethod\n    def create(\n        cls,\n        conversation_id: uuid.UUID,\n        event_type: str | EventType,\n        payload: Optional[dict] = None,\n        session_id: Optional[str] = None,\n        branch_id: Optional[str] = None,\n        user_id: Optional[uuid.UUID] = None,\n        source: Optional[str] = None,\n        trace_id: Optional[str] = None,\n    ) -> \"SessionEvent\":\n        \"\"\"\n        Factory method to create a new session event.\n\n        Args:\n            conversation_id: ID of the conversation\n            event_type: Type of event (from EventType enum or string)\n            payload: JSON-serializable event data\n            session_id: Optional session identifier\n            branch_id: Optional branch identifier\n            user_id: Optional user identifier\n            source: Source of the event (frontend, backend, etc.)\n            trace_id: Optional trace ID for request correlation\n\n        Returns:\n            SessionEvent instance\n        \"\"\"\n        return cls(\n            conversation_id=conversation_id,\n            event_type=(event_type.value if isinstance(event_type, EventType) else event_type),\n            payload=payload,\n            session_id=session_id,\n            branch_id=branch_id,\n            user_id=user_id,\n            source=source,\n            trace_id=trace_id,\n        )\n"
}

{
  "path": "apps/admin-panel/src/components/security/AuditLogViewer.tsx",
  "language": "typescript",
  "size": 8757,
  "last_modified": "2025-11-29T04:23:35.077Z",
  "lines": 262,
  "content": "/**\n * Audit Log Viewer Component\n *\n * Displays a paginated list of audit log entries with filtering and export capabilities.\n */\n\nimport { useState } from \"react\";\nimport { useAuditLogs, AuditLogEntry } from \"../../hooks/useAuditLogs\";\n\nconst ACTION_FILTERS = [\n  { value: null, label: \"All Actions\" },\n  { value: \"auth.login\", label: \"Logins\" },\n  { value: \"auth.logout\", label: \"Logouts\" },\n  { value: \"auth.2fa\", label: \"2FA Changes\" },\n  { value: \"user.update\", label: \"User Updates\" },\n  { value: \"user.deactivate\", label: \"User Deactivations\" },\n  { value: \"kb.\", label: \"Knowledge Base\" },\n];\n\nfunction getActionIcon(action: string): string {\n  if (action.startsWith(\"auth.login\")) return \"ðŸ”‘\";\n  if (action.startsWith(\"auth.logout\")) return \"ðŸšª\";\n  if (action.startsWith(\"auth.2fa\")) return \"ðŸ”\";\n  if (action.startsWith(\"user.\")) return \"ðŸ‘¤\";\n  if (action.startsWith(\"kb.\")) return \"ðŸ“š\";\n  if (action.startsWith(\"admin.\")) return \"âš™ï¸\";\n  return \"ðŸ“\";\n}\n\nfunction getActionColor(action: string, success: boolean): string {\n  if (!success) return \"text-red-400 bg-red-900/30\";\n  if (action.includes(\"login_success\")) return \"text-green-400 bg-green-900/30\";\n  if (action.includes(\"login_failed\")) return \"text-red-400 bg-red-900/30\";\n  if (action.includes(\"2fa_enabled\")) return \"text-blue-400 bg-blue-900/30\";\n  if (action.includes(\"2fa_disabled\")) return \"text-amber-400 bg-amber-900/30\";\n  if (action.includes(\"deactivate\")) return \"text-red-400 bg-red-900/30\";\n  return \"text-slate-400 bg-slate-800\";\n}\n\nfunction formatAction(action: string): string {\n  return action\n    .replace(/^(auth|user|kb|admin)\\./, \"\")\n    .replace(/_/g, \" \")\n    .replace(/\\b\\w/g, (c) => c.toUpperCase());\n}\n\nfunction formatTimestamp(timestamp: string): string {\n  const date = new Date(timestamp);\n  return date.toLocaleString();\n}\n\nfunction LogEntryRow({ entry }: { entry: AuditLogEntry }) {\n  const [expanded, setExpanded] = useState(false);\n\n  return (\n    <tr\n      className=\"border-b border-slate-800 hover:bg-slate-800/50 cursor-pointer\"\n      onClick={() => setExpanded(!expanded)}\n    >\n      <td className=\"px-4 py-3\">\n        <div className=\"text-xs text-slate-400\">\n          {formatTimestamp(entry.timestamp)}\n        </div>\n      </td>\n      <td className=\"px-4 py-3\">\n        <div className=\"flex items-center gap-2\">\n          <span className=\"text-lg\">{getActionIcon(entry.action)}</span>\n          <span\n            className={`px-2 py-0.5 rounded text-xs font-medium ${getActionColor(entry.action, entry.success)}`}\n          >\n            {formatAction(entry.action)}\n          </span>\n        </div>\n        {expanded && entry.details && (\n          <div className=\"mt-2 text-xs text-slate-500 font-mono bg-slate-900/50 p-2 rounded max-w-md truncate\">\n            {entry.details}\n          </div>\n        )}\n      </td>\n      <td className=\"px-4 py-3\">\n        <div className=\"text-sm text-slate-300\">\n          {entry.user_email || \"System\"}\n        </div>\n        {entry.user_id && (\n          <div className=\"text-xs text-slate-500 truncate max-w-32\">\n            {entry.user_id}\n          </div>\n        )}\n      </td>\n      <td className=\"px-4 py-3\">\n        {entry.resource_type && (\n          <div className=\"text-sm text-slate-400\">\n            {entry.resource_type}\n            {entry.resource_id && (\n              <span className=\"text-slate-500 ml-1 text-xs\">\n                #{entry.resource_id.slice(0, 8)}\n              </span>\n            )}\n          </div>\n        )}\n      </td>\n      <td className=\"px-4 py-3\">\n        <span\n          className={`inline-flex items-center px-2 py-0.5 rounded text-[10px] font-medium ${\n            entry.success\n              ? \"bg-green-900/30 text-green-400\"\n              : \"bg-red-900/30 text-red-400\"\n          }`}\n        >\n          {entry.success ? \"Success\" : \"Failed\"}\n        </span>\n      </td>\n      <td className=\"px-4 py-3 text-xs text-slate-500\">\n        {entry.ip_address || \"-\"}\n      </td>\n    </tr>\n  );\n}\n\nexport function AuditLogViewer() {\n  const {\n    logs,\n    total,\n    loading,\n    error,\n    offset,\n    limit,\n    refresh,\n    setOffset,\n    setActionFilter,\n    actionFilter,\n    exportLogs,\n  } = useAuditLogs({ autoRefresh: true, refreshIntervalMs: 30000 });\n\n  const totalPages = Math.ceil(total / limit);\n  const currentPage = Math.floor(offset / limit) + 1;\n\n  const handlePreviousPage = () => {\n    if (offset >= limit) {\n      setOffset(offset - limit);\n    }\n  };\n\n  const handleNextPage = () => {\n    if (offset + limit < total) {\n      setOffset(offset + limit);\n    }\n  };\n\n  return (\n    <div className=\"bg-slate-900/50 border border-slate-800 rounded-lg\">\n      <div className=\"px-4 py-3 border-b border-slate-800 flex items-center justify-between\">\n        <div>\n          <h2 className=\"text-sm font-medium text-slate-200\">\n            Security Audit Log\n          </h2>\n          <p className=\"text-xs text-slate-500 mt-0.5\">\n            {total.toLocaleString()} events\n          </p>\n        </div>\n        <div className=\"flex items-center gap-2\">\n          {/* Action Filter */}\n          <select\n            value={actionFilter || \"\"}\n            onChange={(e) => {\n              setActionFilter(e.target.value || null);\n              setOffset(0);\n            }}\n            className=\"px-2 py-1 text-xs bg-slate-800 border border-slate-700 rounded text-slate-300 focus:outline-none focus:ring-1 focus:ring-blue-500\"\n          >\n            {ACTION_FILTERS.map((filter) => (\n              <option key={filter.value || \"all\"} value={filter.value || \"\"}>\n                {filter.label}\n              </option>\n            ))}\n          </select>\n\n          {/* Export Button */}\n          <button\n            onClick={exportLogs}\n            className=\"px-3 py-1 text-xs bg-slate-800 hover:bg-slate-700 text-slate-300 rounded transition-colors\"\n          >\n            Export CSV\n          </button>\n\n          {/* Refresh Button */}\n          <button\n            onClick={refresh}\n            disabled={loading}\n            className=\"px-3 py-1 text-xs bg-slate-800 hover:bg-slate-700 text-slate-300 rounded transition-colors disabled:opacity-50\"\n          >\n            {loading ? \"Loading...\" : \"Refresh\"}\n          </button>\n        </div>\n      </div>\n\n      {error && (\n        <div className=\"p-4 text-sm text-red-400 bg-red-900/20\">{error}</div>\n      )}\n\n      {loading && logs.length === 0 ? (\n        <div className=\"p-8 text-center text-slate-500\">\n          Loading audit logs...\n        </div>\n      ) : logs.length === 0 ? (\n        <div className=\"p-8 text-center text-slate-500\">\n          No audit log entries found\n        </div>\n      ) : (\n        <>\n          <div className=\"overflow-x-auto\">\n            <table className=\"w-full text-sm\">\n              <thead>\n                <tr className=\"text-left text-xs text-slate-500 uppercase tracking-wide border-b border-slate-800\">\n                  <th className=\"px-4 py-2\">Timestamp</th>\n                  <th className=\"px-4 py-2\">Action</th>\n                  <th className=\"px-4 py-2\">User</th>\n                  <th className=\"px-4 py-2\">Resource</th>\n                  <th className=\"px-4 py-2\">Status</th>\n                  <th className=\"px-4 py-2\">IP</th>\n                </tr>\n              </thead>\n              <tbody>\n                {logs.map((entry) => (\n                  <LogEntryRow key={entry.id} entry={entry} />\n                ))}\n              </tbody>\n            </table>\n          </div>\n\n          {/* Pagination */}\n          <div className=\"px-4 py-3 border-t border-slate-800 flex items-center justify-between\">\n            <div className=\"text-xs text-slate-500\">\n              Showing {offset + 1} - {Math.min(offset + limit, total)} of{\" \"}\n              {total}\n            </div>\n            <div className=\"flex items-center gap-2\">\n              <button\n                onClick={handlePreviousPage}\n                disabled={offset === 0}\n                className=\"px-3 py-1 text-xs bg-slate-800 hover:bg-slate-700 text-slate-300 rounded transition-colors disabled:opacity-50 disabled:cursor-not-allowed\"\n              >\n                Previous\n              </button>\n              <span className=\"text-xs text-slate-400\">\n                Page {currentPage} of {totalPages}\n              </span>\n              <button\n                onClick={handleNextPage}\n                disabled={offset + limit >= total}\n                className=\"px-3 py-1 text-xs bg-slate-800 hover:bg-slate-700 text-slate-300 rounded transition-colors disabled:opacity-50 disabled:cursor-not-allowed\"\n              >\n                Next\n              </button>\n            </div>\n          </div>\n        </>\n      )}\n    </div>\n  );\n}\n"
}

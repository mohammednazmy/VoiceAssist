{
  "path": "apps/admin-panel/src/components/users/PermanentDeleteDialog.tsx",
  "language": "typescript",
  "size": 10784,
  "last_modified": "2025-11-29T09:47:36.898Z",
  "lines": 303,
  "content": "/**\n * PermanentDeleteDialog Component\n *\n * Modal dialog for permanently deleting a user and all their data.\n * This is an irreversible action that requires email confirmation.\n */\n\nimport { useState, FormEvent } from \"react\";\nimport { fetchAPI } from \"../../lib/api\";\n\ninterface PermanentDeleteDialogProps {\n  isOpen: boolean;\n  onClose: () => void;\n  onSuccess: () => void;\n  user: {\n    id: string;\n    email: string;\n    full_name?: string;\n  } | null;\n}\n\ninterface DeleteResponse {\n  message: string;\n  user_id: string;\n  deleted_data: {\n    sessions: number;\n    messages: number;\n  };\n}\n\nexport function PermanentDeleteDialog({\n  isOpen,\n  onClose,\n  onSuccess,\n  user,\n}: PermanentDeleteDialogProps) {\n  const [confirmEmail, setConfirmEmail] = useState(\"\");\n  const [reason, setReason] = useState(\"\");\n  const [isLoading, setIsLoading] = useState(false);\n  const [error, setError] = useState<string | null>(null);\n  const [result, setResult] = useState<DeleteResponse | null>(null);\n\n  const handleClose = () => {\n    if (!isLoading) {\n      setConfirmEmail(\"\");\n      setReason(\"\");\n      setError(null);\n      setResult(null);\n      onClose();\n    }\n  };\n\n  const isEmailMatch =\n    user && confirmEmail.toLowerCase() === user.email.toLowerCase();\n\n  const handleSubmit = async (e: FormEvent) => {\n    e.preventDefault();\n    if (!user || !isEmailMatch) return;\n\n    setIsLoading(true);\n    setError(null);\n\n    try {\n      const response = await fetchAPI<DeleteResponse>(\n        `/api/admin/panel/users/${user.id}/permanent`,\n        {\n          method: \"DELETE\",\n          body: JSON.stringify({\n            confirm_email: confirmEmail,\n            reason: reason || undefined,\n          }),\n        },\n      );\n\n      setResult(response);\n      setTimeout(() => {\n        onSuccess();\n        handleClose();\n      }, 2000);\n    } catch (err) {\n      setError(err instanceof Error ? err.message : \"Failed to delete user\");\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  if (!isOpen || !user) return null;\n\n  return (\n    <div className=\"fixed inset-0 z-50 flex items-center justify-center\">\n      {/* Backdrop */}\n      <div className=\"absolute inset-0 bg-black/60\" onClick={handleClose} />\n\n      {/* Dialog */}\n      <div className=\"relative bg-slate-900 border border-red-900/50 rounded-lg shadow-xl w-full max-w-md mx-4\">\n        {/* Header */}\n        <div className=\"flex items-center justify-between px-6 py-4 border-b border-red-900/50 bg-red-950/30\">\n          <div className=\"flex items-center gap-3\">\n            <div className=\"w-10 h-10 rounded-full bg-red-900/50 flex items-center justify-center\">\n              <svg\n                className=\"w-5 h-5 text-red-400\"\n                fill=\"none\"\n                viewBox=\"0 0 24 24\"\n                stroke=\"currentColor\"\n              >\n                <path\n                  strokeLinecap=\"round\"\n                  strokeLinejoin=\"round\"\n                  strokeWidth={2}\n                  d=\"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z\"\n                />\n              </svg>\n            </div>\n            <h2 className=\"text-lg font-semibold text-red-400\">\n              Permanently Delete User\n            </h2>\n          </div>\n          <button\n            onClick={handleClose}\n            disabled={isLoading}\n            className=\"text-slate-400 hover:text-slate-200 disabled:opacity-50\"\n          >\n            <svg\n              className=\"w-5 h-5\"\n              fill=\"none\"\n              viewBox=\"0 0 24 24\"\n              stroke=\"currentColor\"\n            >\n              <path\n                strokeLinecap=\"round\"\n                strokeLinejoin=\"round\"\n                strokeWidth={2}\n                d=\"M6 18L18 6M6 6l12 12\"\n              />\n            </svg>\n          </button>\n        </div>\n\n        {/* Content */}\n        <div className=\"p-6\">\n          {result ? (\n            /* Success state */\n            <div className=\"text-center space-y-4\">\n              <div className=\"inline-flex items-center justify-center w-16 h-16 rounded-full bg-green-900/50 text-green-400\">\n                <svg\n                  className=\"w-8 h-8\"\n                  fill=\"none\"\n                  viewBox=\"0 0 24 24\"\n                  stroke=\"currentColor\"\n                >\n                  <path\n                    strokeLinecap=\"round\"\n                    strokeLinejoin=\"round\"\n                    strokeWidth={2}\n                    d=\"M5 13l4 4L19 7\"\n                  />\n                </svg>\n              </div>\n              <div>\n                <h3 className=\"text-lg font-medium text-slate-100\">\n                  User Deleted\n                </h3>\n                <p className=\"text-sm text-slate-400 mt-1\">\n                  The user and all associated data have been permanently\n                  removed.\n                </p>\n              </div>\n              <div className=\"p-3 bg-slate-800/50 border border-slate-700 rounded-md text-sm text-slate-300\">\n                <div>Sessions deleted: {result.deleted_data.sessions}</div>\n                <div>Messages deleted: {result.deleted_data.messages}</div>\n              </div>\n            </div>\n          ) : (\n            <form onSubmit={handleSubmit} className=\"space-y-5\">\n              {/* Warning */}\n              <div className=\"p-4 bg-red-950/50 border border-red-900 rounded-md space-y-2\">\n                <div className=\"text-red-400 font-medium flex items-center gap-2\">\n                  <svg\n                    className=\"w-5 h-5\"\n                    fill=\"none\"\n                    viewBox=\"0 0 24 24\"\n                    stroke=\"currentColor\"\n                  >\n                    <path\n                      strokeLinecap=\"round\"\n                      strokeLinejoin=\"round\"\n                      strokeWidth={2}\n                      d=\"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z\"\n                    />\n                  </svg>\n                  This action cannot be undone\n                </div>\n                <p className=\"text-sm text-red-300/80\">\n                  This will permanently delete the user account and all\n                  associated data including:\n                </p>\n                <ul className=\"text-sm text-red-300/80 list-disc list-inside ml-2\">\n                  <li>All conversation sessions</li>\n                  <li>All messages and history</li>\n                  <li>User preferences and settings</li>\n                </ul>\n              </div>\n\n              {/* User info */}\n              <div className=\"p-3 bg-slate-800/50 border border-slate-700 rounded-md\">\n                <div className=\"text-sm text-slate-400\">Deleting user:</div>\n                <div className=\"text-slate-100 font-medium\">{user.email}</div>\n                {user.full_name && (\n                  <div className=\"text-sm text-slate-400\">{user.full_name}</div>\n                )}\n              </div>\n\n              {/* Email confirmation */}\n              <div>\n                <label\n                  htmlFor=\"confirmEmail\"\n                  className=\"block text-sm font-medium text-slate-300 mb-1\"\n                >\n                  Type{\" \"}\n                  <span className=\"text-red-400 font-mono\">{user.email}</span>{\" \"}\n                  to confirm\n                </label>\n                <input\n                  id=\"confirmEmail\"\n                  type=\"email\"\n                  value={confirmEmail}\n                  onChange={(e) => setConfirmEmail(e.target.value)}\n                  disabled={isLoading}\n                  placeholder=\"Enter email to confirm\"\n                  className={`w-full px-3 py-2 bg-slate-800 border rounded-md text-slate-100\n                    focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-transparent\n                    disabled:opacity-50 disabled:cursor-not-allowed\n                    ${isEmailMatch ? \"border-green-500\" : \"border-slate-700\"}`}\n                  autoComplete=\"off\"\n                />\n                {confirmEmail && !isEmailMatch && (\n                  <p className=\"mt-1 text-xs text-amber-400\">\n                    Email does not match\n                  </p>\n                )}\n              </div>\n\n              {/* Reason (optional) */}\n              <div>\n                <label\n                  htmlFor=\"reason\"\n                  className=\"block text-sm font-medium text-slate-300 mb-1\"\n                >\n                  Reason for deletion{\" \"}\n                  <span className=\"text-slate-500 font-normal\">(optional)</span>\n                </label>\n                <textarea\n                  id=\"reason\"\n                  value={reason}\n                  onChange={(e) => setReason(e.target.value)}\n                  disabled={isLoading}\n                  rows={2}\n                  className=\"w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded-md text-slate-100\n                    focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-transparent\n                    disabled:opacity-50 disabled:cursor-not-allowed resize-none\"\n                  placeholder=\"e.g., GDPR request, duplicate account...\"\n                />\n              </div>\n\n              {/* Error message */}\n              {error && (\n                <div className=\"p-3 bg-red-950/50 border border-red-900 rounded-md text-red-400 text-sm\">\n                  {error}\n                </div>\n              )}\n\n              {/* Actions */}\n              <div className=\"flex items-center justify-end gap-3 pt-2\">\n                <button\n                  type=\"button\"\n                  onClick={handleClose}\n                  disabled={isLoading}\n                  className=\"px-4 py-2 text-sm text-slate-300 hover:text-slate-100 transition-colors disabled:opacity-50\"\n                >\n                  Cancel\n                </button>\n                <button\n                  type=\"submit\"\n                  disabled={!isEmailMatch || isLoading}\n                  className=\"px-4 py-2 bg-red-600 hover:bg-red-700 text-white text-sm font-medium rounded-md\n                    transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2\"\n                >\n                  {isLoading && (\n                    <span className=\"inline-block w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin\" />\n                  )}\n                  {isLoading ? \"Deleting...\" : \"Permanently Delete\"}\n                </button>\n              </div>\n            </form>\n          )}\n        </div>\n      </div>\n    </div>\n  );\n}\n\nexport default PermanentDeleteDialog;\n"
}

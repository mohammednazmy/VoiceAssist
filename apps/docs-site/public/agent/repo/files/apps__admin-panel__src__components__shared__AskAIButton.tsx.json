{
  "path": "apps/admin-panel/src/components/shared/AskAIButton.tsx",
  "language": "typescript",
  "size": 17432,
  "last_modified": "2025-12-03T03:40:02.339Z",
  "lines": 477,
  "content": "/**\n * AskAIButton - Ask AI about documentation\n *\n * A button that opens a dialog for asking the AI assistant questions about\n * the VoiceAssist platform. Pre-fills context from the current page and\n * renders AI responses with markdown formatting and doc citations.\n */\nimport { useState, useRef, useEffect, useCallback } from \"react\";\nimport { fetchAPI } from \"../../lib/api\";\n\nexport interface AskAIButtonProps {\n  /**\n   * Current page context to pre-fill the AI with\n   * e.g., \"Knowledge Base management page\"\n   */\n  pageContext?: string;\n\n  /**\n   * Optional doc path for additional context\n   * e.g., \"admin/knowledge-base\"\n   */\n  docPath?: string;\n\n  /**\n   * Button variant\n   * @default \"icon\"\n   */\n  variant?: \"icon\" | \"text\" | \"full\";\n\n  /**\n   * Custom button label (for text and full variants)\n   * @default \"Ask AI\"\n   */\n  label?: string;\n\n  /**\n   * Additional className for the button\n   */\n  className?: string;\n}\n\ninterface AIResponse {\n  answer: string;\n  citations?: Array<{\n    title: string;\n    path: string;\n    section?: string;\n    relevance?: number;\n  }>;\n  confidence?: number;\n}\n\ninterface Message {\n  role: \"user\" | \"assistant\";\n  content: string;\n  citations?: AIResponse[\"citations\"];\n  timestamp: Date;\n}\n\nexport function AskAIButton({\n  pageContext,\n  docPath,\n  variant = \"icon\",\n  label = \"Ask AI\",\n  className,\n}: AskAIButtonProps) {\n  const [isOpen, setIsOpen] = useState(false);\n  const [input, setInput] = useState(\"\");\n  const [messages, setMessages] = useState<Message[]>([]);\n  const [isLoading, setIsLoading] = useState(false);\n  const [error, setError] = useState<string | null>(null);\n\n  const dialogRef = useRef<HTMLDivElement>(null);\n  const inputRef = useRef<HTMLTextAreaElement>(null);\n  const messagesEndRef = useRef<HTMLDivElement>(null);\n\n  // Focus input when dialog opens\n  useEffect(() => {\n    if (isOpen && inputRef.current) {\n      inputRef.current.focus();\n    }\n  }, [isOpen]);\n\n  // Scroll to bottom when new messages arrive\n  useEffect(() => {\n    messagesEndRef.current?.scrollIntoView({ behavior: \"smooth\" });\n  }, [messages]);\n\n  // Handle escape key\n  useEffect(() => {\n    if (!isOpen) return;\n\n    const handleEscape = (e: KeyboardEvent) => {\n      if (e.key === \"Escape\" && !isLoading) {\n        setIsOpen(false);\n      }\n    };\n\n    document.addEventListener(\"keydown\", handleEscape);\n    return () => document.removeEventListener(\"keydown\", handleEscape);\n  }, [isOpen, isLoading]);\n\n  const handleSubmit = useCallback(async () => {\n    if (!input.trim() || isLoading) return;\n\n    const userMessage = input.trim();\n    setInput(\"\");\n    setError(null);\n\n    // Add user message\n    setMessages((prev) => [\n      ...prev,\n      { role: \"user\", content: userMessage, timestamp: new Date() },\n    ]);\n\n    setIsLoading(true);\n\n    try {\n      // Build context-enriched query\n      const contextParts: string[] = [];\n      if (pageContext) {\n        contextParts.push(`Current page: ${pageContext}`);\n      }\n      if (docPath) {\n        contextParts.push(`Related docs: ${docPath}`);\n      }\n\n      const response = await fetchAPI<AIResponse>(\"/api/ai/docs/ask\", {\n        method: \"POST\",\n        body: JSON.stringify({\n          question: userMessage,\n          context:\n            contextParts.length > 0 ? contextParts.join(\"\\n\") : undefined,\n          include_citations: true,\n        }),\n      });\n\n      // Add assistant response\n      setMessages((prev) => [\n        ...prev,\n        {\n          role: \"assistant\",\n          content: response.answer,\n          citations: response.citations,\n          timestamp: new Date(),\n        },\n      ]);\n    } catch (err) {\n      const errorMessage =\n        err instanceof Error ? err.message : \"Failed to get AI response\";\n      setError(errorMessage);\n      // Remove the last user message on error so they can retry\n      setMessages((prev) => prev.slice(0, -1));\n      setInput(userMessage);\n    } finally {\n      setIsLoading(false);\n    }\n  }, [input, isLoading, pageContext, docPath]);\n\n  const handleKeyDown = (e: React.KeyboardEvent<HTMLTextAreaElement>) => {\n    if (e.key === \"Enter\" && !e.shiftKey) {\n      e.preventDefault();\n      handleSubmit();\n    }\n  };\n\n  const clearConversation = () => {\n    setMessages([]);\n    setError(null);\n  };\n\n  const docsBaseUrl =\n    import.meta.env.VITE_DOCS_URL || \"http://localhost:3001/\";\n\n  const buttonContent = () => {\n    const iconSvg = (\n      <svg\n        xmlns=\"http://www.w3.org/2000/svg\"\n        viewBox=\"0 0 24 24\"\n        fill=\"none\"\n        stroke=\"currentColor\"\n        strokeWidth={1.5}\n        strokeLinecap=\"round\"\n        strokeLinejoin=\"round\"\n        className=\"w-4 h-4\"\n      >\n        <path d=\"M9.813 15.904 9 18.75l-.813-2.846a4.5 4.5 0 0 0-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 0 0 3.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 0 0 3.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 0 0-3.09 3.09Z\" />\n        <path d=\"M18.259 8.715 18 9.75l-.259-1.035a3.375 3.375 0 0 0-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 0 0 2.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 0 0 2.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 0 0-2.456 2.456Z\" />\n      </svg>\n    );\n\n    switch (variant) {\n      case \"icon\":\n        return iconSvg;\n      case \"text\":\n        return label;\n      case \"full\":\n        return (\n          <>\n            {iconSvg}\n            <span className=\"ml-2\">{label}</span>\n          </>\n        );\n    }\n  };\n\n  const baseButtonStyles =\n    \"inline-flex items-center justify-center transition-colors focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-1 focus:ring-offset-slate-900\";\n\n  const variantStyles = {\n    icon: \"w-8 h-8 rounded-full border border-slate-600 bg-slate-800 hover:bg-slate-700 hover:border-slate-500 text-slate-400 hover:text-slate-200\",\n    text: \"text-sm text-slate-400 hover:text-slate-200\",\n    full: \"px-3 py-1.5 text-sm rounded-md border border-slate-600 bg-slate-800 hover:bg-slate-700 hover:border-slate-500 text-slate-300 hover:text-slate-100\",\n  };\n\n  return (\n    <>\n      <button\n        type=\"button\"\n        onClick={() => setIsOpen(true)}\n        className={`${baseButtonStyles} ${variantStyles[variant]} ${className || \"\"}`}\n        aria-label=\"Ask AI about documentation\"\n        title=\"Ask AI\"\n      >\n        {buttonContent()}\n      </button>\n\n      {isOpen && (\n        <div\n          className=\"fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4\"\n          onClick={(e) => {\n            if (e.target === e.currentTarget && !isLoading) {\n              setIsOpen(false);\n            }\n          }}\n          role=\"dialog\"\n          aria-modal=\"true\"\n          aria-labelledby=\"ask-ai-dialog-title\"\n        >\n          <div\n            ref={dialogRef}\n            className=\"bg-slate-900 border border-slate-700 rounded-lg shadow-xl w-full max-w-2xl max-h-[80vh] flex flex-col\"\n          >\n            {/* Header */}\n            <div className=\"flex items-center justify-between px-4 py-3 border-b border-slate-800\">\n              <div className=\"flex items-center gap-2\">\n                <div className=\"w-8 h-8 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center\">\n                  <svg\n                    xmlns=\"http://www.w3.org/2000/svg\"\n                    viewBox=\"0 0 24 24\"\n                    fill=\"none\"\n                    stroke=\"white\"\n                    strokeWidth={2}\n                    strokeLinecap=\"round\"\n                    strokeLinejoin=\"round\"\n                    className=\"w-4 h-4\"\n                  >\n                    <path d=\"M9.813 15.904 9 18.75l-.813-2.846a4.5 4.5 0 0 0-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 0 0 3.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 0 0 3.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 0 0-3.09 3.09Z\" />\n                  </svg>\n                </div>\n                <div>\n                  <h2\n                    id=\"ask-ai-dialog-title\"\n                    className=\"text-sm font-semibold text-slate-100\"\n                  >\n                    Ask AI Assistant\n                  </h2>\n                  <p className=\"text-xs text-slate-500\">\n                    {pageContext\n                      ? `Context: ${pageContext}`\n                      : \"Ask about VoiceAssist documentation\"}\n                  </p>\n                </div>\n              </div>\n              <div className=\"flex items-center gap-2\">\n                {messages.length > 0 && (\n                  <button\n                    type=\"button\"\n                    onClick={clearConversation}\n                    className=\"text-xs text-slate-500 hover:text-slate-300 px-2 py-1\"\n                    disabled={isLoading}\n                  >\n                    Clear\n                  </button>\n                )}\n                <button\n                  type=\"button\"\n                  onClick={() => setIsOpen(false)}\n                  className=\"text-slate-400 hover:text-slate-200 p-1\"\n                  disabled={isLoading}\n                  aria-label=\"Close dialog\"\n                >\n                  <svg\n                    xmlns=\"http://www.w3.org/2000/svg\"\n                    viewBox=\"0 0 24 24\"\n                    fill=\"none\"\n                    stroke=\"currentColor\"\n                    strokeWidth={2}\n                    className=\"w-5 h-5\"\n                  >\n                    <path d=\"M18 6 6 18M6 6l12 12\" />\n                  </svg>\n                </button>\n              </div>\n            </div>\n\n            {/* Messages */}\n            <div className=\"flex-1 overflow-y-auto p-4 space-y-4 min-h-[200px]\">\n              {messages.length === 0 ? (\n                <div className=\"text-center text-slate-500 py-8\">\n                  <p className=\"text-sm\">\n                    Ask any question about VoiceAssist platform\n                  </p>\n                  <div className=\"mt-4 flex flex-wrap justify-center gap-2\">\n                    {[\n                      \"How do I upload documents?\",\n                      \"What are the security features?\",\n                      \"How does RAG search work?\",\n                    ].map((suggestion) => (\n                      <button\n                        key={suggestion}\n                        type=\"button\"\n                        onClick={() => setInput(suggestion)}\n                        className=\"text-xs px-3 py-1.5 rounded-full bg-slate-800 text-slate-400 hover:bg-slate-700 hover:text-slate-300 transition-colors\"\n                      >\n                        {suggestion}\n                      </button>\n                    ))}\n                  </div>\n                </div>\n              ) : (\n                messages.map((message, idx) => (\n                  <div\n                    key={idx}\n                    className={`flex ${message.role === \"user\" ? \"justify-end\" : \"justify-start\"}`}\n                  >\n                    <div\n                      className={`max-w-[85%] rounded-lg px-4 py-2.5 ${\n                        message.role === \"user\"\n                          ? \"bg-blue-600 text-white\"\n                          : \"bg-slate-800 text-slate-200\"\n                      }`}\n                    >\n                      <div className=\"text-sm whitespace-pre-wrap\">\n                        {message.content}\n                      </div>\n\n                      {/* Citations */}\n                      {message.citations && message.citations.length > 0 && (\n                        <div className=\"mt-3 pt-2 border-t border-slate-700\">\n                          <p className=\"text-xs text-slate-400 mb-1.5\">\n                            Sources:\n                          </p>\n                          <div className=\"flex flex-wrap gap-1.5\">\n                            {message.citations.map((citation, cidx) => (\n                              <a\n                                key={cidx}\n                                href={`${docsBaseUrl}${citation.path}${citation.section ? `#${citation.section}` : \"\"}`}\n                                target=\"_blank\"\n                                rel=\"noopener noreferrer\"\n                                className=\"inline-flex items-center gap-1 text-xs px-2 py-1 rounded bg-slate-700/50 text-blue-400 hover:text-blue-300 hover:bg-slate-700 transition-colors\"\n                              >\n                                <svg\n                                  xmlns=\"http://www.w3.org/2000/svg\"\n                                  viewBox=\"0 0 20 20\"\n                                  fill=\"currentColor\"\n                                  className=\"w-3 h-3\"\n                                >\n                                  <path d=\"M10.75 2.75a.75.75 0 0 0-1.5 0v8.614L6.295 8.235a.75.75 0 1 0-1.09 1.03l4.25 4.5a.75.75 0 0 0 1.09 0l4.25-4.5a.75.75 0 0 0-1.09-1.03l-2.955 3.129V2.75Z\" />\n                                  <path d=\"M3.5 12.75a.75.75 0 0 0-1.5 0v2.5A2.75 2.75 0 0 0 4.75 18h10.5A2.75 2.75 0 0 0 18 15.25v-2.5a.75.75 0 0 0-1.5 0v2.5c0 .69-.56 1.25-1.25 1.25H4.75c-.69 0-1.25-.56-1.25-1.25v-2.5Z\" />\n                                </svg>\n                                {citation.title}\n                              </a>\n                            ))}\n                          </div>\n                        </div>\n                      )}\n\n                      <div className=\"mt-1 text-[10px] opacity-50\">\n                        {message.timestamp.toLocaleTimeString([], {\n                          hour: \"2-digit\",\n                          minute: \"2-digit\",\n                        })}\n                      </div>\n                    </div>\n                  </div>\n                ))\n              )}\n\n              {/* Loading indicator */}\n              {isLoading && (\n                <div className=\"flex justify-start\">\n                  <div className=\"bg-slate-800 rounded-lg px-4 py-3\">\n                    <div className=\"flex items-center gap-2\">\n                      <div className=\"flex gap-1\">\n                        <span\n                          className=\"w-2 h-2 bg-slate-500 rounded-full animate-bounce\"\n                          style={{ animationDelay: \"0ms\" }}\n                        />\n                        <span\n                          className=\"w-2 h-2 bg-slate-500 rounded-full animate-bounce\"\n                          style={{ animationDelay: \"150ms\" }}\n                        />\n                        <span\n                          className=\"w-2 h-2 bg-slate-500 rounded-full animate-bounce\"\n                          style={{ animationDelay: \"300ms\" }}\n                        />\n                      </div>\n                      <span className=\"text-xs text-slate-500\">\n                        Searching docs...\n                      </span>\n                    </div>\n                  </div>\n                </div>\n              )}\n\n              <div ref={messagesEndRef} />\n            </div>\n\n            {/* Error */}\n            {error && (\n              <div className=\"mx-4 mb-2 p-2 bg-red-900/30 border border-red-800 rounded text-xs text-red-300\">\n                {error}\n              </div>\n            )}\n\n            {/* Input */}\n            <div className=\"p-4 border-t border-slate-800\">\n              <div className=\"flex items-end gap-2\">\n                <textarea\n                  ref={inputRef}\n                  value={input}\n                  onChange={(e) => setInput(e.target.value)}\n                  onKeyDown={handleKeyDown}\n                  placeholder=\"Type your question...\"\n                  rows={1}\n                  className=\"flex-1 px-3 py-2 bg-slate-800 border border-slate-700 rounded-lg text-sm text-slate-200 placeholder-slate-500 resize-none focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\n                  style={{\n                    minHeight: \"40px\",\n                    maxHeight: \"120px\",\n                    height: \"auto\",\n                  }}\n                  disabled={isLoading}\n                />\n                <button\n                  type=\"button\"\n                  onClick={handleSubmit}\n                  disabled={!input.trim() || isLoading}\n                  className=\"px-4 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-slate-700 disabled:text-slate-500 text-white text-sm font-medium rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500\"\n                >\n                  {isLoading ? (\n                    <span className=\"w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin inline-block\" />\n                  ) : (\n                    <svg\n                      xmlns=\"http://www.w3.org/2000/svg\"\n                      viewBox=\"0 0 20 20\"\n                      fill=\"currentColor\"\n                      className=\"w-5 h-5\"\n                    >\n                      <path d=\"M3.105 2.288a.75.75 0 0 0-.826.95l1.414 4.926A1.5 1.5 0 0 0 5.135 9.25h6.115a.75.75 0 0 1 0 1.5H5.135a1.5 1.5 0 0 0-1.442 1.086l-1.414 4.926a.75.75 0 0 0 .826.95 28.897 28.897 0 0 0 15.293-7.155.75.75 0 0 0 0-1.114A28.897 28.897 0 0 0 3.105 2.288Z\" />\n                    </svg>\n                  )}\n                </button>\n              </div>\n              <p className=\"mt-2 text-[10px] text-slate-600 text-center\">\n                Press Enter to send, Shift+Enter for new line\n              </p>\n            </div>\n          </div>\n        </div>\n      )}\n    </>\n  );\n}\n\nAskAIButton.displayName = \"AskAIButton\";\n"
}

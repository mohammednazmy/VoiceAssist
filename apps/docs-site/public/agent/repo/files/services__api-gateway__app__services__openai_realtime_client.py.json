{
  "path": "services/api-gateway/app/services/openai_realtime_client.py",
  "language": "python",
  "size": 3013,
  "last_modified": "2025-12-04T11:26:58.267Z",
  "lines": 90,
  "content": "\"\"\"\nOpenAI Realtime API client\n\nDEPRECATED: This module is LEGACY and maintained for backwards compatibility only.\nThe Thinker/Talker pipeline (Deepgram STT + GPT-4o + ElevenLabs TTS) is now the\nprimary voice implementation. See voice_pipeline_service.py for the current approach.\n\nThis client was a lightweight helper for creating realtime sessions and exchanging\nsignaling metadata without exposing the primary API key to callers.\n\nThe client intentionally mirrors the semantics used by\n`RealtimeVoiceService` so higher level services can request\nsession configuration from a single place.\n\"\"\"\n\nfrom __future__ import annotations\n\nfrom typing import Any, Dict, Optional\n\nimport httpx\nfrom app.core.config import settings\nfrom app.core.logging import get_logger\n\nlogger = get_logger(__name__)\n\n\nclass OpenAIRealtimeClient:\n    \"\"\"Minimal async client for the OpenAI Realtime API.\"\"\"\n\n    def __init__(\n        self,\n        *,\n        api_key: Optional[str] = None,\n        base_url: Optional[str] = None,\n        model: Optional[str] = None,\n    ) -> None:\n        self.api_key = api_key or settings.OPENAI_API_KEY\n        self.base_url = base_url or settings.REALTIME_BASE_URL\n        self.model = model or settings.REALTIME_MODEL\n\n    def is_enabled(self) -> bool:\n        \"\"\"Return True when realtime access is configured.\"\"\"\n\n        return bool(self.api_key) and bool(self.base_url) and bool(self.model)\n\n    async def create_session(self, *, voice: str = \"alloy\", modalities: Optional[list[str]] = None) -> Dict[str, Any]:\n        \"\"\"Create an ephemeral realtime session.\n\n        Args:\n            voice: Preferred TTS voice id\n            modalities: Optional list of enabled modalities\n\n        Returns:\n            Parsed JSON payload from the OpenAI Realtime session endpoint\n        \"\"\"\n\n        if not self.is_enabled():\n            raise ValueError(\"Realtime API not configured\")\n\n        payload: Dict[str, Any] = {\"model\": self.model, \"voice\": voice}\n        if modalities:\n            payload[\"modalities\"] = modalities\n\n        async with httpx.AsyncClient(timeout=settings.OPENAI_TIMEOUT_SEC) as client:\n            response = await client.post(\n                \"https://api.openai.com/v1/realtime/sessions\",\n                headers={\n                    \"Authorization\": f\"Bearer {self.api_key}\",\n                    \"Content-Type\": \"application/json\",\n                },\n                json=payload,\n            )\n\n        if response.status_code != 200:\n            logger.error(\n                \"realtime_session_create_failed\",\n                extra={\n                    \"status_code\": response.status_code,\n                    \"response\": response.text,\n                },\n            )\n            raise ValueError(f\"Failed to create realtime session: {response.status_code}\")\n\n        data = response.json()\n        logger.info(\n            \"realtime_session_created\",\n            extra={\"voice\": voice, \"modalities\": modalities or [\"text\", \"audio\"]},\n        )\n        return data\n"
}

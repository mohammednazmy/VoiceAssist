{
  "path": "services/api-gateway/app/models/user_emotion_profile.py",
  "language": "python",
  "size": 7515,
  "last_modified": "2025-12-04T12:32:40.270Z",
  "lines": 234,
  "content": "\"\"\"\nUser Emotion Profile model for emotion personalization.\n\nStores user-specific emotional baselines for:\n- Valence/arousal baseline learning\n- Per-emotion baseline tracking\n- Cultural sensitivity profiles\n- Confidence level based on sample count\n\"\"\"\n\nimport uuid\nfrom datetime import datetime, timezone\n\nfrom app.core.database import Base\nfrom sqlalchemy import Boolean, Column, DateTime, Float, ForeignKey, Integer, String\nfrom sqlalchemy.dialects.postgresql import JSONB, UUID\nfrom sqlalchemy.orm import relationship\n\n\nclass UserEmotionProfile(Base):\n    \"\"\"\n    User emotion baseline for personalization.\n\n    Stores learned emotional baselines using exponential moving average.\n    Used to detect significant deviations from user's normal emotional state.\n    \"\"\"\n\n    __tablename__ = \"user_emotion_profiles\"\n\n    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)\n    user_id = Column(\n        UUID(as_uuid=True),\n        ForeignKey(\"users.id\", ondelete=\"CASCADE\"),\n        unique=True,\n        nullable=False,\n        index=True,\n    )\n\n    # Valence baseline (-1 to 1: negative to positive)\n    baseline_valence = Column(Float, default=0.0, nullable=False)\n    baseline_valence_variance = Column(Float, default=0.3, nullable=False)\n\n    # Arousal baseline (0 to 1: calm to excited)\n    baseline_arousal = Column(Float, default=0.5, nullable=False)\n    baseline_arousal_variance = Column(Float, default=0.2, nullable=False)\n\n    # Per-emotion baselines (JSON: {emotion_name: baseline_score})\n    emotion_baselines = Column(JSONB, default={}, nullable=False)\n\n    # Cultural sensitivity profile for emotion interpretation\n    # Options: western_individualist, eastern_collectivist, mediterranean, nordic, etc.\n    cultural_profile = Column(String(50), default=\"western_individualist\", nullable=False)\n\n    # Sample count for confidence calculation\n    total_samples = Column(Integer, default=0, nullable=False)\n\n    # Confidence level (0 to 1, based on sample count)\n    # Asymptotically approaches 1.0 as samples increase\n    confidence_level = Column(Float, default=0.0, nullable=False)\n\n    # Privacy settings\n    tracking_enabled = Column(Boolean, default=True, nullable=False)\n\n    # Timestamps\n    created_at = Column(\n        DateTime(timezone=True),\n        default=lambda: datetime.now(timezone.utc),\n        nullable=False,\n    )\n    updated_at = Column(\n        DateTime(timezone=True),\n        default=lambda: datetime.now(timezone.utc),\n        onupdate=lambda: datetime.now(timezone.utc),\n        nullable=False,\n    )\n    last_sample_at = Column(DateTime(timezone=True), nullable=True)\n\n    # Relationships\n    user = relationship(\"User\", backref=\"emotion_profile\")\n\n    def __repr__(self):\n        return f\"<UserEmotionProfile(user_id={self.user_id}, confidence={self.confidence_level:.2f})>\"\n\n    def to_dict(self):\n        \"\"\"Convert to dictionary for API responses\"\"\"\n        return {\n            \"user_id\": str(self.user_id),\n            \"baseline_valence\": self.baseline_valence,\n            \"baseline_arousal\": self.baseline_arousal,\n            \"emotion_baselines\": self.emotion_baselines,\n            \"cultural_profile\": self.cultural_profile,\n            \"total_samples\": self.total_samples,\n            \"confidence_level\": self.confidence_level,\n            \"tracking_enabled\": self.tracking_enabled,\n            \"last_sample_at\": (self.last_sample_at.isoformat() if self.last_sample_at else None),\n        }\n\n\nclass UserProgressRecord(Base):\n    \"\"\"\n    User progress tracking for resume functionality.\n\n    Tracks reading/learning progress across resources.\n    \"\"\"\n\n    __tablename__ = \"user_progress\"\n\n    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)\n    user_id = Column(\n        UUID(as_uuid=True),\n        ForeignKey(\"users.id\", ondelete=\"CASCADE\"),\n        nullable=False,\n        index=True,\n    )\n\n    # Resource identification\n    resource_type = Column(String(50), nullable=False, index=True)  # book, article, module\n    resource_id = Column(String(255), nullable=False, index=True)\n\n    # Progress location (JSON: {page, section, chapter, timestamp, etc.})\n    location = Column(JSONB, default={}, nullable=False)\n\n    # Progress percentage (0-100)\n    progress_percent = Column(Float, default=0.0, nullable=False)\n\n    # Timestamps\n    created_at = Column(\n        DateTime(timezone=True),\n        default=lambda: datetime.now(timezone.utc),\n        nullable=False,\n    )\n    last_accessed = Column(\n        DateTime(timezone=True),\n        default=lambda: datetime.now(timezone.utc),\n        onupdate=lambda: datetime.now(timezone.utc),\n        nullable=False,\n    )\n\n    # Relationships\n    user = relationship(\"User\", backref=\"progress_records\")\n\n    # Unique constraint on user + resource\n    __table_args__ = ({\"sqlite_autoincrement\": True},)\n\n    def __repr__(self):\n        return f\"<UserProgressRecord(user_id={self.user_id}, resource={self.resource_type}:{self.resource_id})>\"\n\n\nclass UserNote(Base):\n    \"\"\"\n    User notes and highlights on resources.\n    \"\"\"\n\n    __tablename__ = \"user_notes\"\n\n    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)\n    user_id = Column(\n        UUID(as_uuid=True),\n        ForeignKey(\"users.id\", ondelete=\"CASCADE\"),\n        nullable=False,\n        index=True,\n    )\n\n    # Resource identification\n    resource_type = Column(String(50), nullable=False, index=True)\n    resource_id = Column(String(255), nullable=False, index=True)\n\n    # Location in resource (JSON: {page, paragraph, etc.})\n    location = Column(JSONB, default={}, nullable=False)\n\n    # Note content\n    note_text = Column(String(4000), nullable=False)\n    highlight_text = Column(String(1000), nullable=True)\n\n    # Timestamps\n    created_at = Column(\n        DateTime(timezone=True),\n        default=lambda: datetime.now(timezone.utc),\n        nullable=False,\n    )\n    updated_at = Column(\n        DateTime(timezone=True),\n        default=lambda: datetime.now(timezone.utc),\n        onupdate=lambda: datetime.now(timezone.utc),\n        nullable=False,\n    )\n\n    # Relationships\n    user = relationship(\"User\", backref=\"notes\")\n\n    def __repr__(self):\n        return f\"<UserNote(user_id={self.user_id}, resource={self.resource_type}:{self.resource_id})>\"\n\n\nclass RepairSessionHistory(Base):\n    \"\"\"\n    Repair attempt history for analytics.\n    \"\"\"\n\n    __tablename__ = \"repair_session_history\"\n\n    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)\n    session_id = Column(UUID(as_uuid=True), nullable=False, index=True)\n    user_id = Column(\n        UUID(as_uuid=True),\n        ForeignKey(\"users.id\", ondelete=\"SET NULL\"),\n        nullable=True,\n        index=True,\n    )\n\n    # Repair details\n    strategy = Column(String(50), nullable=False)\n    transcript_before = Column(String(2000), nullable=True)\n    transcript_after = Column(String(2000), nullable=True)\n    resolved = Column(Boolean, default=False, nullable=False)\n\n    # Context\n    error_type = Column(String(50), nullable=True)\n    emotion_state = Column(JSONB, nullable=True)\n    escalation_level = Column(Integer, default=0, nullable=False)\n\n    # Timestamps\n    created_at = Column(\n        DateTime(timezone=True),\n        default=lambda: datetime.now(timezone.utc),\n        nullable=False,\n    )\n\n    # Relationships\n    user = relationship(\"User\", backref=\"repair_history\")\n\n    def __repr__(self):\n        return f\"<RepairSessionHistory(session_id={self.session_id}, strategy={self.strategy})>\"\n"
}

{
  "path": "services/api-gateway/app/api/sharing.py",
  "language": "python",
  "size": 8352,
  "last_modified": "2025-12-05T03:07:13.126Z",
  "lines": 285,
  "content": "\"\"\"\nAPI endpoints for conversation sharing\n\"\"\"\n\nimport secrets\nfrom datetime import datetime, timedelta\nfrom typing import Optional\nfrom uuid import UUID\n\nfrom app.core.config import settings\nfrom app.core.database import get_db\nfrom app.core.dependencies import get_current_user\nfrom app.models.session import Session\nfrom app.models.user import User\nfrom fastapi import APIRouter, Depends, HTTPException, status\nfrom pydantic import BaseModel\nfrom sqlalchemy.orm import Session as DBSession\n\nrouter = APIRouter()\n\n\nclass ShareRequest(BaseModel):\n    \"\"\"Request to share a conversation\"\"\"\n\n    expires_in_hours: Optional[int] = 24  # Default 24 hours\n    password: Optional[str] = None\n    allow_anonymous: bool = True\n\n\nclass ShareResponse(BaseModel):\n    \"\"\"Response with share link\"\"\"\n\n    share_id: str\n    share_url: str\n    expires_at: str\n    password_protected: bool\n\n\nclass ConversationShare(BaseModel):\n    \"\"\"Shared conversation details\"\"\"\n\n    id: str\n    session_id: str\n    share_token: str\n    created_by: str\n    created_at: datetime\n    expires_at: datetime\n    password_hash: Optional[str] = None\n    allow_anonymous: bool\n    access_count: int\n\n\n# In-memory storage for shares (should be moved to database in production)\n# Format: {share_token: ConversationShare}\n_shares = {}\n\n\n@router.post(\"/sessions/{session_id}/share\", status_code=status.HTTP_201_CREATED)\nasync def create_share_link(\n    session_id: UUID,\n    share_request: ShareRequest,\n    db: DBSession = Depends(get_db),\n    current_user: User = Depends(get_current_user),\n):\n    \"\"\"\n    Create a shareable link for a conversation.\n\n    Args:\n        session_id: Session UUID\n        share_request: Share configuration\n        db: Database session\n        current_user: Authenticated user\n\n    Returns:\n        Share link details\n    \"\"\"\n    # Verify session exists and belongs to user\n    session = db.query(Session).filter(Session.id == session_id, Session.user_id == current_user.id).first()\n    if not session:\n        raise HTTPException(status_code=status.HTTP_404_NOT_FOUND, detail=\"Session not found\")\n\n    # Generate secure share token\n    share_token = secrets.token_urlsafe(32)\n\n    # Calculate expiration\n    expires_at = datetime.utcnow() + timedelta(hours=share_request.expires_in_hours)\n\n    # Hash password if provided\n    password_hash = None\n    if share_request.password:\n        from app.core.security import hash_password\n\n        password_hash = hash_password(share_request.password)\n\n    # Create share record\n    share = ConversationShare(\n        id=share_token,\n        session_id=str(session_id),\n        share_token=share_token,\n        created_by=str(current_user.id),\n        created_at=datetime.utcnow(),\n        expires_at=expires_at,\n        password_hash=password_hash,\n        allow_anonymous=share_request.allow_anonymous,\n        access_count=0,\n    )\n\n    # Store share (in production, save to database)\n    _shares[share_token] = share\n\n    # Generate share URL using configured frontend URL\n    base_url = settings.FRONTEND_URL.rstrip(\"/\")\n    share_url = f\"{base_url}/shared/{share_token}\"\n\n    return ShareResponse(\n        share_id=share_token,\n        share_url=share_url,\n        expires_at=expires_at.isoformat(),\n        password_protected=bool(share_request.password),\n    )\n\n\n@router.get(\"/shared/{share_token}\")\nasync def get_shared_conversation(\n    share_token: str,\n    password: Optional[str] = None,\n    db: DBSession = Depends(get_db),\n):\n    \"\"\"\n    Access a shared conversation.\n\n    Args:\n        share_token: Share token from URL\n        password: Optional password for protected shares\n        db: Database session\n\n    Returns:\n        Shared conversation details\n    \"\"\"\n    # Get share record\n    share = _shares.get(share_token)\n    if not share:\n        raise HTTPException(status_code=status.HTTP_404_NOT_FOUND, detail=\"Share link not found\")\n\n    # Check expiration\n    if datetime.utcnow() > share.expires_at:\n        raise HTTPException(status_code=status.HTTP_410_GONE, detail=\"Share link has expired\")\n\n    # Check password if required\n    if share.password_hash:\n        if not password:\n            raise HTTPException(\n                status_code=status.HTTP_401_UNAUTHORIZED,\n                detail=\"Password required\",\n            )\n\n        from app.core.security import verify_password\n\n        if not verify_password(password, share.password_hash):\n            raise HTTPException(\n                status_code=status.HTTP_401_UNAUTHORIZED,\n                detail=\"Incorrect password\",\n            )\n\n    # Increment access count\n    share.access_count += 1\n\n    # Get session and messages\n    session = db.query(Session).filter(Session.id == UUID(share.session_id)).first()\n    if not session:\n        raise HTTPException(status_code=status.HTTP_404_NOT_FOUND, detail=\"Conversation not found\")\n\n    # Get messages\n    from app.models.message import Message\n\n    messages = db.query(Message).filter(Message.session_id == UUID(share.session_id)).order_by(Message.created_at).all()\n\n    return {\n        \"session\": {\n            \"id\": str(session.id),\n            \"title\": session.title,\n            \"created_at\": session.created_at.isoformat(),\n            \"message_count\": len(messages),\n        },\n        \"messages\": [\n            {\n                \"id\": str(msg.id),\n                \"role\": msg.role,\n                \"content\": msg.content,\n                \"created_at\": msg.created_at.isoformat(),\n            }\n            for msg in messages\n        ],\n        \"share_info\": {\n            \"created_at\": share.created_at.isoformat(),\n            \"expires_at\": share.expires_at.isoformat(),\n            \"access_count\": share.access_count,\n        },\n    }\n\n\n@router.delete(\"/sessions/{session_id}/share/{share_token}\", status_code=status.HTTP_204_NO_CONTENT)\nasync def revoke_share_link(\n    session_id: UUID,\n    share_token: str,\n    db: DBSession = Depends(get_db),\n    current_user: User = Depends(get_current_user),\n):\n    \"\"\"\n    Revoke a share link.\n\n    Args:\n        session_id: Session UUID\n        share_token: Share token to revoke\n        db: Database session\n        current_user: Authenticated user\n    \"\"\"\n    # Verify session belongs to user\n    session = db.query(Session).filter(Session.id == session_id, Session.user_id == current_user.id).first()\n    if not session:\n        raise HTTPException(status_code=status.HTTP_404_NOT_FOUND, detail=\"Session not found\")\n\n    # Get share and verify ownership\n    share = _shares.get(share_token)\n    if not share:\n        raise HTTPException(status_code=status.HTTP_404_NOT_FOUND, detail=\"Share link not found\")\n\n    if share.created_by != str(current_user.id):\n        raise HTTPException(\n            status_code=status.HTTP_403_FORBIDDEN,\n            detail=\"Not authorized to revoke this share link\",\n        )\n\n    # Delete share\n    del _shares[share_token]\n\n    return None\n\n\n@router.get(\"/sessions/{session_id}/shares\")\nasync def list_share_links(\n    session_id: UUID,\n    db: DBSession = Depends(get_db),\n    current_user: User = Depends(get_current_user),\n):\n    \"\"\"\n    List all active share links for a conversation.\n\n    Args:\n        session_id: Session UUID\n        db: Database session\n        current_user: Authenticated user\n\n    Returns:\n        List of share links\n    \"\"\"\n    # Verify session belongs to user\n    session = db.query(Session).filter(Session.id == session_id, Session.user_id == current_user.id).first()\n    if not session:\n        raise HTTPException(status_code=status.HTTP_404_NOT_FOUND, detail=\"Session not found\")\n\n    # Find all shares for this session\n    shares = [\n        share\n        for share in _shares.values()\n        if share.session_id == str(session_id)\n        and share.created_by == str(current_user.id)\n        and datetime.utcnow() <= share.expires_at\n    ]\n\n    # Generate share URLs using configured frontend URL\n    base_url = settings.FRONTEND_URL.rstrip(\"/\")\n\n    return [\n        {\n            \"share_token\": share.share_token,\n            \"share_url\": f\"{base_url}/shared/{share.share_token}\",\n            \"created_at\": share.created_at.isoformat(),\n            \"expires_at\": share.expires_at.isoformat(),\n            \"password_protected\": bool(share.password_hash),\n            \"access_count\": share.access_count,\n        }\n        for share in shares\n    ]\n"
}
